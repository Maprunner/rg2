const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=[window.assetUrl("assets/manager-BFTRVDTy.js"),window.assetUrl("assets/node-modules-CBZj5KRR.js"),window.assetUrl("assets/manager-utils-IOxTzkk2.js"),window.assetUrl("assets/manager-utils-CIGW-MKW.css")])))=>i.map(i=>d[i]);
import{a as li,T as ai,M as ri,d as rt,O as bt,i as ot}from"./node-modules-CBZj5KRR.js";import"./main-Cw0jfsJD.js";const oi="modulepreload",di=function(t,e){return new URL(t,e).href},cs={},st=function(e,s,n){let i=Promise.resolve();if(s&&s.length>0){let a=function(h){return Promise.all(h.map(p=>Promise.resolve(p).then(v=>({status:"fulfilled",value:v}),v=>({status:"rejected",reason:v}))))};const o=document.getElementsByTagName("link"),m=document.querySelector("meta[property=csp-nonce]"),y=(m==null?void 0:m.nonce)||(m==null?void 0:m.getAttribute("nonce"));i=a(s.map(h=>{if(h=di(h,n),h in cs)return;cs[h]=!0;const p=h.endsWith(".css"),v=p?'[rel="stylesheet"]':"";if(!!n)for(let k=o.length-1;k>=0;k--){const b=o[k];if(b.href===h&&(!p||b.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${h}"]${v}`))return;const E=document.createElement("link");if(E.rel=p?"stylesheet":oi,p||(E.as="script"),E.crossOrigin="",E.href=h,y&&E.setAttribute("nonce",y),document.head.appendChild(E),p)return new Promise((k,b)=>{E.addEventListener("load",k),E.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${h}`)))})}))}function l(a){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=a,window.dispatchEvent(o),!o.defaultPrevented)throw a}return i.then(a=>{for(const o of a||[])o.status==="rejected"&&l(o.reason);return e().catch(l)})},qs=li.create({baseURL:rg2Config.api_url});function Xt(t,e,s){t.t=new Date().getTime(),document.getElementById("rg2-container").style.cursor="wait",qs({method:"get",url:"",params:t}).then(n=>{e(n.data.data,t.id)}).catch(function(n){zs(s+": "+n)}).finally(function(){document.getElementById("rg2-container").style.cursor="auto"})}function js(t,e,s,n){let i={method:"post"};i.data=t,e.headers&&(i.headers=e.headers,delete e.headers),e.t=new Date().getTime(),i.params=e,document.getElementById("rg2-container").style.cursor="wait",qs(i).then(l=>{s(l.data)}).catch(function(l){zs(n+": "+l)}).finally(function(){document.getElementById("rg2-container").style.cursor="auto"})}function zs(t){document.getElementById("rg2-load-progress").classList.add("d-none"),document.getElementById("rg2-map-load-progress").classList.add("d-none"),V("Configuration error",t)}let le={};le.code="en";let nt=[];function ci(t){let e=document.getElementById("rg2-select-language");e.innerHTML="";let s=le.code==="en";e.options.add(xe("en","en: English",s));for(let n=0;n<t.length;n=n+1)s=le.code===t[n].code,e.options.add(xe(t[n].code,t[n].code+": "+t[n].language,s));e.addEventListener("change",n=>{const i=n.target.value;i!==le.code&&(i==="en"?Zs("en"):Ks(i))})}function Ks(t){Xt({type:"lang",lang:t},hi,"Language request failed")}function ui(t){const e=nt.indexOf(t);return e>-1?e:(nt.push(t),nt.length-1)}function hi(t){Zs(t.lang)}function fi(){rg2Config.start_language!=="en"&&Ks(rg2Config.start_language)}function Zs(t){t==="en"?le={code:"en"}:le=t,gi()}function g(t,e="span"){const s=ui(t);return le.hasOwnProperty(t)&&(t=le[t]),e===""?t:`<${e} data-rg2t='${s}'>${t}</${e}>`}function gi(){const t=document.querySelectorAll("[data-rg2t]");for(let e of t){const s=parseInt(e.dataset.rg2t,10);e.innerText=g(nt[s],"")}}function ao(t,e,s){return t.length>0?t[0].getAttribute(e).trim():s}function P(t){const e=Math.floor(t/60);let s=e;const n=t-e*60;return n<10?s+=":0"+n:s+=":"+n,s}function mi(t){let e;const s=Math.floor(t/3600);s<10?e="0"+s+":":e=s+":",t=t-s*3600;const n=Math.floor(t/60);return n<10?e+="0"+n:e+=n,t=t-n*60,t<10?e+=":0"+t:e+=":"+t,e}function xe(t,e,s=!1){let n=document.createElement("option");return n.value=t,n.text=e,s&&(n.selected=!0),n}function pi(t,e,s=!1){return`<option value="${t}"${s?" selected":""}>${e}</option>`}function ue(t,e,s,n){let i=Math.atan2(n-e,s-t);return i<0&&(i=i+2*Math.PI),i}function Y(t,e,s,n){return Math.sqrt(Math.pow(t-s,2)+Math.pow(e-n,2))}function Ot(t,e,s,n){const i=(s-t).toRad(),l=(n-e).toRad(),a=Math.sin(i/2)*Math.sin(i/2)+Math.cos(t.toRad())*Math.cos(s.toRad())*Math.sin(l/2)*Math.sin(l/2);return 6371009*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))}function ro(t){if(!t)return 0;let e=0;const s=t.split(":");return e=parseInt(s[0],10)*3600+parseInt(s[1],10)*60,isNaN(e)?0:e}function us(t){if(!t)return 0;let e=0,s=t.replace(/\./g,":").split(":");return s.length===2?e=parseInt(s[0],10)*60+parseInt(s[1],10):s.length===3&&(e=parseInt(s[0],10)*3600+parseInt(s[1],10)*60+parseInt(s[2],10)),isNaN(e)?0:e}const V=(t,e)=>{vi(t,e)},yi=document.getElementById("rg2-toast-container"),vi=(t,e)=>{const s=document.createElement("div");s.classList.add("toast"),s.setAttribute("data-bs-autohide","false"),s.innerHTML=`<div class="toast-header">
      <strong class="me-auto">${t}</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">
      ${e}
    </div>`,yi.appendChild(s),[...document.querySelectorAll(".toast")].map(i=>{const l=new ai(i,{});i.addEventListener("hidden.bs.toast",()=>{i.parentNode&&i.parentNode.removeChild(i)}),l.show()})};function oo(t,e){return t.length>0?t[0].textContent.trim():e}let De;function qt(t,e=!0){De&&De.dispose();const s=document.getElementById("rg2-modal-container");s.innerHTML="";const n=e?`<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${g("Cancel")}</button>`:"",i=`<div class="modal fade" id="rg2-modal-dialog" data-bs-backdrop="static" data-bs-keyboard="false"
    tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="staticBackdropLabel">${t.title}</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          ${t.body}
        </div>
        <div class="modal-footer">
          <button id="rg2-do-modal-action" type="button" class="btn btn-primary">${g(t.doText)}</button>
          ${n}
        </div>
      </div>
    </div>
    </div > `;s.innerHTML=i,typeof t.onCancel!="function"&&(t.onCancel=()=>{});let l=!1;const a=document.getElementById("rg2-modal-dialog");document.getElementById("rg2-do-modal-action").addEventListener("click",()=>{l=!0,De.hide()});const o={keyboard:!0};De=new ri(a,o),a.addEventListener("hidden.bs.modal",()=>{l?t.onDo():t.onCancel()}),De.show()}function co(t,e){const s=document.getElementById(t),n=e(s.value);return n?(s.classList.add("is-valid"),s.classList.remove("is-invalid")):(s.classList.add("is-invalid"),s.classList.remove("is-valid")),n}Number.prototype.toRad=function(){return this*Math.PI/180};const hs=["#ff0000","#00ff00","#0000ff","#800000","#008000","#000080","#ffff00","#ff00ff","#00ffff","#808000","#800080","#008080"];let Dt=0;function Js(){return Dt=(Dt+1)%hs.length,hs[Dt]}const u={RG2VERSION:"2.2.0",DEFAULT_SCALE_FACTOR:1.1,TAB_EVENTS:"event-tab",TAB_COURSES:"course-tab",TAB_RESULTS:"result-tab",TAB_DRAW:"draw-tab",TAB_LOGIN:"manage-login-tab",TAB_CREATE:"manage-create-tab",TAB_EDIT:"manage-edit-tab",TAB_MAP:"manage-map-tab",TAB_DELETE_MAP:"manage-delete-map-tab",INVALID_MAP_ID:9999,DEFAULT_NEW_COMMENT:"Type your comment",GPS_RESULT_OFFSET:5e4,MASS_START_REPLAY:1,REAL_TIME_REPLAY:2,MASS_START_BY_CONTROL:99999,VERY_HIGH_TIME_IN_SECS:99999,BIG_SCREEN_BREAK_POINT:800,SMALL_SCREEN_BREAK_POINT:500,MAX_ZOOM:50,MIN_ZOOM:.05,PURPLE:"#b300ff",RED:"#ff0000",GREEN:"#00ff00",BLUE:"#0000ff",DARK_GREEN:"rgb(34, 139, 34)",DARK_GREEN_30:"rgba(34, 139, 34, 0.3)",GREY:"#e0e0e0",RED_30:"rgba(255,0,0,0.3)",GREEN_30:"rgba(0,255,0,0.3)",BLUE_30:"rgba(0,0,255,0.3)",PURPLE_30:"rgba(180,0,255,0.3)",WHITE:"#ffffff",BLACK:"#000000",RUNNER_DOT_RADIUS:6,HANDLE_DOT_RADIUS:7,HANDLE_COLOUR:"#ff0000",DIM:.75,FULL_INTENSITY:1,TIME_NOT_FOUND:9999,RIGHT_CLICK:3,DO_NOT_SAVE_COURSE:9999,FORMAT_NORMAL:1,FORMAT_NORMAL_NO_RESULTS:2,FORMAT_SCORE_EVENT:3,FORMAT_SCORE_EVENT_NO_RESULTS:4,DISPLAY_ALL_COURSES:99999,EXCLUDED_NONE:0,EXCLUDED_ZERO_SPLITS:1,EXCLUDED_REAL_SPLITS:2,MAX_DRAWN_ROUTES:10,languages:[{language:"Čeština",code:"cz"},{language:"Deutsch",code:"de"},{language:"Suomi",code:"fi"},{language:"Français",code:"fr"},{language:"Italiano",code:"it"},{language:"日本語",code:"ja"},{language:"Norsk",code:"no"},{language:"Português - Brasil",code:"pt"},{language:"Русский",code:"ru"}],FILE_SIZE_WARNING:2,PIXEL_SIZE_WARNING:4e3,CLASS_NOW_ON:1,CLASS_NOW_OFF:0,managing:()=>rg2Config.managing!==void 0},C={perCentMapIntensity:100,perCentRouteIntensity:100,replayFontSize:12,courseWidth:3,routeWidth:4,circleSize:20,snap:!0,showThreeSeconds:!1,showGPSSpeed:!1,alignMap:!1,maxSpeed:5,minSpeed:15,drawnRoutes:[]};function Fe(){let t={};const e=Xe();let s=Math.pow(Math.min(e.height,e.width)/1500,.5);s=Math.min(s,5),s=Math.max(s,.5);const n=Math.round(C.circleSize*s);return t.controlRadius=n,t.finishInnerRadius=n*(5/6),t.finishOuterRadius=n*(7/6),t.startTriangleLength=n*(7/6),t.overprintWidth=C.courseWidth,t.font=n+"pt Arial",t}function bi(){try{if(window.hasOwnProperty("localStorage")&&window.localStorage!==null&&localStorage.getItem("rg2-options")!==null){const t=JSON.parse(localStorage.getItem("rg2-options"));for(let e in t)t.hasOwnProperty(e)&&(C[e]=t[e]);C.circleSize=20,C.perCentMapIntensity===0&&V("Warning","Your saved settings have 0% map intensity so the map is invisible. You can adjust this on the configuration menu")}}catch{}}function xi(t){let e=[];for(let s=0;s<C.drawnRoutes.length;s+=1)(C.drawnRoutes[s].id!==t.id||C.drawnRoutes[s].eventid!==t.eventid)&&e.push(C.drawnRoutes[s]);C.drawnRoutes=e,xt()}function xt(){try{window.hasOwnProperty("localStorage")&&window.localStorage!==null&&localStorage.setItem("rg2-options",JSON.stringify(C))}catch{return}}function Ei(t){let e=C.drawnRoutes;e.length>=u.MAX_DRAWN_ROUTES&&e.shift(),e.push(t),C.drawnRoutes=e,xt()}function Si(t,e){C[t]=e,xt()}class Ti{constructor(){this.controls=[],this.displayControls=!1}addControl(e,s,n){let i=!0;for(let l=0;l<this.controls.length;l+=1)if(this.controls[l].code===e){i=!1;break}i&&this.controls.push({code:e,x:s,y:n})}deleteAllControls(){this.controls.length=0}displayAllControls(){this.displayControls=!0}drawControls(e){if(this.displayControls){const s=Fe();for(let n=0;n<this.controls.length;n+=1)this.controls[n].code.indexOf("F")===0||this.controls[n].code.indexOf("M")===0?this.drawFinish(this.controls[n].x,this.controls[n].y,this.controls[n].code,s):this.controls[n].code.indexOf("S")===0?this.drawStart(this.controls[n].x,this.controls[n].y,this.controls[n].code,1.5*Math.PI,s):(this.drawSingleControl(this.controls[n].x,this.controls[n].y,this.controls[n].code,Math.PI*.25,s),e&&r.fillRect(this.controls[n].x-1,this.controls[n].y-1,3,3))}}drawFinish(e,s,n,i){r.strokeStyle="white",r.lineWidth=i.overprintWidth+2,r.beginPath(),r.arc(e,s,i.finishInnerRadius,0,2*Math.PI,!1),r.stroke(),r.beginPath(),r.arc(e,s,i.finishOuterRadius,0,2*Math.PI,!1),r.stroke(),r.beginPath(),r.font=i.font,r.textAlign="left",r.strokeStyle="white",r.miterLimit=2,r.lineJoin="circle",r.lineWidth=1.5,r.strokeText(n,e+i.controlRadius*1.5,s+i.controlRadius),r.stroke(),r.beginPath(),r.fillStyle=u.PURPLE,r.strokeStyle=u.PURPLE,r.lineWidth=i.overprintWidth,r.arc(e,s,i.finishInnerRadius,0,2*Math.PI,!1),r.stroke(),r.beginPath(),r.arc(e,s,i.finishOuterRadius,0,2*Math.PI,!1),r.fillText(n,e+i.controlRadius*1.5,s+i.controlRadius),r.stroke()}drawSingleControl(e,s,n,i,l){r.beginPath(),r.strokeStyle="white",r.lineWidth=l.overprintWidth+2,r.arc(e,s,l.controlRadius,0,2*Math.PI,!1),r.stroke(),r.beginPath(),r.textAlign="center",r.font=l.font,r.strokeStyle="white",r.miterLimit=2,r.lineJoin="circle",r.lineWidth=1.5,r.textBaseline="middle";const a=r.measureText(n);let o;i<Math.PI?o=a.width/2:o=-1*a.width/2;let m;i>=Math.PI/2&&i<=Math.PI*1.5?m=-1*l.controlRadius/2:m=l.controlRadius/2;const y=1.3;r.strokeText(n,e+l.controlRadius*y*Math.sin(i)+o,s+l.controlRadius*y*Math.cos(i)+m),r.beginPath(),r.font=l.font,r.fillStyle=u.PURPLE,r.strokeStyle=u.PURPLE,r.lineWidth=l.overprintWidth,r.arc(e,s,l.controlRadius,0,2*Math.PI,!1),r.fillText(n,e+l.controlRadius*y*Math.sin(i)+o,s+l.controlRadius*y*Math.cos(i)+m),r.stroke()}drawStart(e,s,n,i,l){let a=[],o=[];const m=2*Math.PI/3;i=i+Math.PI/2,r.lineCap="round",r.strokeStyle="white",r.lineWidth=l.overprintWidth+2,r.beginPath(),a[0]=e+l.startTriangleLength*Math.sin(i),o[0]=s-l.startTriangleLength*Math.cos(i),r.moveTo(a[0],o[0]),a[1]=e+l.startTriangleLength*Math.sin(i+m),o[1]=s-l.startTriangleLength*Math.cos(i+m),r.lineTo(a[1],o[1]),r.stroke(),r.beginPath(),r.moveTo(a[1],o[1]),a[2]=e+l.startTriangleLength*Math.sin(i-m),o[2]=s-l.startTriangleLength*Math.cos(i-m),r.lineTo(a[2],o[2]),r.stroke(),r.beginPath(),r.moveTo(a[2],o[2]),r.lineTo(a[0],o[0]),r.stroke(),r.beginPath(),r.font=l.font,r.textAlign="left",r.strokeStyle="white",r.miterLimit=2,r.lineJoin="circle",r.lineWidth=1.5,r.strokeText(n,a[0]+l.controlRadius*1.25,o[0]+l.controlRadius*1.25),r.stroke(),r.strokeStyle=u.PURPLE,r.lineWidth=l.overprintWidth,r.font=l.font,r.fillStyle=u.PURPLE,r.beginPath(),r.moveTo(a[0],o[0]),r.lineTo(a[1],o[1]),r.stroke(),r.beginPath(),r.moveTo(a[1],o[1]),r.lineTo(a[2],o[2]),r.stroke(),r.beginPath(),r.moveTo(a[2],o[2]),r.lineTo(a[0],o[0]),r.fillText(n,a[0]+l.controlRadius*1.25,o[0]+l.controlRadius*1.25),r.stroke()}generateControlList(){this.controls.length=0;const e=_n();for(let s=0;s<e.length;s+=1)if(e[s]!==void 0){const n=e[s].codes,i=e[s].x,l=e[s].y;if(n!==void 0)for(let a=0;a<n.length;a+=1)this.addControl(n[a],i[a],l[a])}}getControlCount(){return this.controls.length}toggleControlDisplay(){this.displayControls=!this.displayControls}}class ki{constructor(e,s,n,i){this.x=e,this.y=s,this.basex=e,this.basey=s,this.undox=e,this.undoy=s,this.locked=!1,this.time=n,this.index=i}}class Ii{constructor(){this.handles=[]}addHandle(e,s,n){this.handles.push(new ki(e,s,n,this.handles.length)),this.handles.sort(function(i,l){return i.time-l.time}),this.renumberHandles()}deleteHandle(e){e===0||e===this.handles.length-1||(this.handles.splice(e,1),this.renumberHandles())}renumberHandles(){for(let e=0;e<this.handles.length;e+=1)this.handles[e].index=e}lockHandle(e){this.handles[e].locked=!0}lockHandleByTime(e){for(let s=0;s<this.handles.length;s+=1)this.handles[s].time===e&&(this.handles[s].locked=!0)}unlockHandle(e){this.handles[e].locked=!1}handlesLocked(){let e=0;for(let s=0;s<this.handles.length;s+=1)this.handles[s].locked&&(e+=1);return e}deleteAllHandles(){this.handles.length=0}rebaselineXY(){this.copyHandleFields("","base")}saveForUndo(){this.copyHandleFields("base","undo")}undo(){this.copyHandleFields("undo","base"),this.copyHandleFields("undo","")}copyHandleFields(e,s){for(let n=0;n<this.handles.length;n+=1)this.handles[n][s+"x"]=this.handles[n][e+"x"],this.handles[n][s+"y"]=this.handles[n][e+"y"]}getStartHandle(){return this.handles[0]}getFinishHandle(){return this.handles[this.handles.length-1]}getHandleClicked(e){for(let s=0;s<this.handles.length;s+=1)if(Y(e.x,e.y,this.handles[s].basex,this.handles[s].basey)<=u.HANDLE_DOT_RADIUS)return this.handles[s]}getEarliestLockedHandle(){for(let e=0;e<this.handles.length;e+=1)if(this.handles[e].locked)return this.handles[e]}getLatestLockedHandle(){for(let e=this.handles.length-1;e>0;e-=1)if(this.handles[e].locked)return this.handles[e]}getPreviousLockedHandle(e){for(let s=e.index-1;s>=0;s-=1)if(this.handles[s].locked)return this.handles[s]}getNextLockedHandle(e){for(let s=e.index+1;s<this.handles.length;s+=1)if(this.handles[s].locked)return this.handles[s]}getSingleLockedHandle(){return this.getEarliestLockedHandle()}dragHandles(e,s){for(let n=0;n<this.handles.length;n+=1)this.handles[n].x=this.handles[n].basex+e,this.handles[n].y=this.handles[n].basey+s}drawHandles(){for(let e=0;e<this.handles.length;e+=1)r.lineWidth=1,this.handles[e].locked===!0?(r.fillStyle=u.RED_30,r.strokeStyle=u.RED):(r.fillStyle=u.GREEN_30,r.strokeStyle=u.GREEN),r.beginPath(),r.arc(this.handles[e].x,this.handles[e].y,u.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),r.fill(),r.stroke()}alignHandles(e){for(let s=0;s<this.handles.length;s+=1)this.handles[s].x=e.x[this.handles[s].time],this.handles[s].y=e.y[this.handles[s].time]}}class Et{constructor(){this.courseid=null,this.coursename=null,this.controlsToAdjust=0,this.resultid=null,this.isScoreCourse=!1,this.eventid=null,this.name=null,this.comments=null,this.x=[],this.y=[],this.controlx=[],this.controly=[],this.time=[],this.startsecs=0,this.totaltime=0,this.splits=[],this.xml=null}}class Qs{constructor(){this.lat=[],this.lon=[],this.startOffset=0,this.baseX=[],this.baseY=[],this.handles=new Ii,this.savedBaseX=[],this.savedBaseY=[],this.fileLoaded=!1,this.fileName="",this.fileType="",this.routeData=new Et,this.autofitOffset=null}adjustOffset(e){this.autofitOffset=e,this.processGPSFile(),this.autofitTrack()}addStartAndFinishHandles(){this.handles.addHandle(this.baseX[0],this.baseY[0],0),this.handles.addHandle(this.baseX[this.baseX.length-1],this.baseY[this.baseY.length-1],this.baseY.length-1)}applyWorldFile(){const e=An();for(let s=0;s<this.lat.length;s+=1)this.routeData.x[s]=Math.round((e.E*this.lon[s]-e.B*this.lat[s]+e.xCorrection)/e.AEDB),this.routeData.y[s]=Math.round((-1*e.D*this.lon[s]+e.A*this.lat[s]+e.yCorrection)/e.AEDB)}autofitTrack(){document.getElementById("chk-move-all").checked=!1,this.handles.deleteAllHandles(),this.addStartAndFinishHandles(),this.autofitOffset===null&&(this.autofitOffset=this.getOffset());for(let e=1;e<this.routeData.controlsToAdjust;e+=1)if(this.routeData.splits[e]!==this.routeData.splits[e-1]){const s=this.routeData.splits[e]+this.autofitOffset;s<this.baseX.length&&s>=0&&(this.handles.addHandle(this.routeData.x[s],this.routeData.y[s],s),xn({x:this.routeData.x[s],y:this.routeData.y[s]},{x:this.routeData.controlx[e],y:this.routeData.controly[e]}),this.handles.lockHandleByTime(s),this.baseX=this.routeData.x.slice(0),this.baseY=this.routeData.y.slice(0),this.handles.rebaselineXY())}document.getElementById("btn-autofit-gps").setAttribute("disabled",""),document.getElementById("btn-undo-gps-adjust").setAttribute("disabled",""),D()}expandToOneSecondInterval(){let e=[],s=[],n=[];const i=this.routeData;let l=i.time[0],a=i.x[0],o=i.y[0];e[0]=a,s[0]=o,n[0]=i.time[0];let m=n[0]+1;for(let y=1;y<i.x.length;y+=1){const h=i.time[y]-l;if(h>0){const p=(i.x[y]-a)/h,v=(i.y[y]-o)/h;let w=1;for(;w<=h;)e.push(a+p*w),s.push(o+v*w),n.push(m),m+=1,w+=1;a=i.x[y],o=i.y[y],l=m-1}}this.routeData.x=e.slice(0),this.routeData.y=s.slice(0),this.routeData.time=n.slice(0)}fitTrackInsideCourse(){const e=this.getLatLonInfo(),s=this.getControlInfo();let n=(s.maxX-s.minX)/(e.maxLon-e.minLon),i=(s.maxY-s.minY)/(e.maxLat-e.minLat);n>i?i=n*e.latCorrection/e.lonCorrection:n=i*e.lonCorrection/e.latCorrection,this.routeData.x[0]=(this.lon[0]-e.minLon)*n+s.minX,this.routeData.y[0]=-1*(this.lat[0]-e.maxLat)*i+s.minY;const l=s.minX-(this.routeData.x[0]-s.x[0]),a=s.minY-(this.routeData.y[0]-s.y[0]);for(let o=0;o<this.lat.length;o+=1)this.routeData.x[o]=(this.lon[o]-e.minLon)*n+l,this.routeData.y[o]=-1*(this.lat[o]-e.maxLat)*i+a}getControlInfo(){let e=ya();if(e.minX=Math.min.apply(Math,e.x),e.maxX=Math.max.apply(Math,e.x),e.minY=Math.min.apply(Math,e.y),e.maxY=Math.max.apply(Math,e.y),e.maxY-e.minY<100||e.maxX-e.minX<100){e.minX=0,e.minY=0;const s=Xe();e.maxX=s.width,e.maxY=s.height}return e}getLatLonInfo(){let e={};return e.maxLat=Math.max.apply(Math,this.lat),e.maxLon=Math.max.apply(Math,this.lon),e.minLat=Math.min.apply(Math,this.lat),e.minLon=Math.min.apply(Math,this.lon),e.lonCorrection=Ot(e.minLat,e.maxLon,e.minLat,e.minLon)/(e.maxLon-e.minLon),e.latCorrection=Ot(e.minLat,e.minLon,e.maxLat,e.minLon)/(e.maxLat-e.minLat),e}getOffset(){const e=this.getSpeedAverage();let s=[];const n=10;for(let o=0;o<=2*n;o+=1)s[o]=0;let i=0;for(let o=1;o<this.routeData.controlsToAdjust;o+=1){const m=this.routeData.splits[o];if(m!==this.routeData.splits[o-1]){m>=n&&m+n<e.length&&(i=e.slice(m-n,m+n+1));for(let y=0;y<=2*n;y+=1)s[y]+=i[y]}}let l=0;for(let o=1;o<s.length;o+=1)s[o]<s[l]&&(l=o);return l-n}getSecsFromTrackpoint(e){const s=parseInt(Date.parse(e)/1e3,10);return isNaN(s)?0:s-this.startOffset}getSpeedAverage(){let e=[],s=[];e[0]=0;for(let n=1;n<this.routeData.x.length;n+=1)e[n]=Y(this.routeData.x[n],this.routeData.y[n],this.routeData.x[n-1],this.routeData.y[n-1]);for(let n=1;n<this.routeData.x.length-1;n+=1)s[n]=(e[n-1]+e[n]+e[n+1])/3;return s[0]=e[0],s[this.routeData.x.length-1]=e[this.routeData.x.length-1],s}getStartOffset(e){const s=parseInt(Date.parse(e.substr(0,11)+"00:00:00Z")/1e3,10);return isNaN(s)?0:s}initialiseGPS(){this.lat.length=0,this.lon.length=0,this.startOffset=0,this.baseX.length=0,this.baseY.length=0,this.handles.deleteAllHandles(),this.savedBaseX.length=0,this.savedBaseY.length=0,this.fileLoaded=!1,this.routeData.x.length=0,this.routeData.y.length=0,this.routeData.time.length=0}processGPSFile(){this.initialiseGPS(),this.fileType==="gpx"?this.processGPX():this.processTCX(),this.processGPSTrack()}processGPSTrack(){It()?(this.applyWorldFile(),this.trackMatchesMapCoordinates()?document.getElementById("chk-move-all").checked=!0:(V("GPS file problem","Your GPS file does not match the map co-ordinates. Please check you have selected the correct file."),this.fitTrackInsideCourse())):this.fitTrackInsideCourse(),this.lat.length=0,this.lon.length=0,this.expandToOneSecondInterval(),this.baseX=this.routeData.x.slice(0),this.baseY=this.routeData.y.slice(0),this.addStartAndFinishHandles(),this.fileLoaded=!0,this.routeData.splits.length>2&&document.getElementById("btn-autofit-gps").removeAttribute("disabled"),document.getElementById("btn-save-gps-route").removeAttribute("disabled"),D()}processGPX(){const e=this.xml.getElementsByTagName("trkseg");for(let s=0;s<e.length;s+=1){const n=e[s].getElementsByTagName("trkpt");this.startOffset=this.getStartOffset(n[0].getElementsByTagName("time")[0].textContent);for(let i=0;i<n.length;i+=1){const l=n[i].getAttribute("lat"),a=n[i].getAttribute("lon");l!=="0"&&a!=="0"&&(this.lat.push(l),this.lon.push(a),this.routeData.time.push(this.getSecsFromTrackpoint(n[i].getElementsByTagName("time")[0].textContent)))}}}processTCX(){const e=this.xml.getElementsByTagName("Track");for(let s=0;s<e.length;s+=1){const n=e[s].getElementsByTagName("Trackpoint");this.startOffset=this.getStartOffset(n[0].getElementsByTagName("Time")[0].textContent);for(let i=0;i<n.length;i+=1)if(n[i].getElementsByTagName("Position").length>0){const l=n[i].getElementsByTagName("Position"),a=l[0].getElementsByTagName("LatitudeDegrees")[0].textContent,o=l[0].getElementsByTagName("LongitudeDegrees")[0].textContent;a!=="0"&&o!=="0"&&(this.lat.push(a),this.lon.push(o),this.routeData.time.push(this.getSecsFromTrackpoint(n[i].getElementsByTagName("Time")[0].textContent)))}}}readGPS(e){let s=new FileReader;this.fileName=e.target.files[0].name,s.onerror=function(n){V("GPS file problem","Unable to open GPS file. "+n)},s.onload=n=>{try{if(this.fileType=this.fileName.slice(-3).toLowerCase(),this.fileType!=="gpx"&&this.fileType!=="tcx"){V("GPS file problem","File type not recognised. Please check you have selected the correct file.");return}document.getElementById("rg2-load-gps-file").setAttribute("disabled",""),this.xml=new DOMParser().parseFromString(n.target.result,"text/xml"),this.processGPSFile()}catch(i){V("GPS file problem","File is not valid XML. Please check you have selected the correct file. "+i);return}},s.readAsText(e.target.files[0])}trackMatchesMapCoordinates(){const e=Math.min.apply(Math,this.routeData.x),s=Math.max.apply(Math,this.routeData.x),n=Math.min.apply(Math,this.routeData.y),i=Math.max.apply(Math,this.routeData.y),l=Xe();return s>0&&e<l.width&&n<l.height&&i>0}}let K=0,te=[],Z=[];function fs(t,e){return t.length>0?e+t.join(","):""}function gs(t,e,s){let n="#";return K!==0&&(n+=t+fs(s,"&course=")+fs(e,"&route=")),n}function wi(){return te}function Li(){return K}function Di(){return Z}function Ci(){return Z.length>0?u.TAB_RESULTS:u.TAB_COURSES}function Ai(t){let e=0;return/#([0-9]+)($|&)/.test(t)&&(e=t.replace(/#([0-9]+)($|&).*/,"$1"),e.length>0)?parseInt(e,10):e}function en(t){K=0,te.length=0,Z.length=0;let e=t.split("&");for(let s=0;s<e.length;s+=1)e[s]=e[s].toLowerCase(),e[s].search("#")!==-1&&(K=parseInt(e[s].replace(/\D/g,""),10)),e[s].search("course=")!==-1&&(te=e[s].replace("course=","").split(",")),e[s].search("route=")!==-1&&(Z=e[s].replace("route=","").split(","));return te=te.map(Number),Z=Z.map(Number),isNaN(K)&&(K=0,te.length=0,Z.length=0),St(),K}function Mi(t){K=t,St()}function ms(t){te=t,St()}function Ct(t){Z=t,St()}function St(){let t="";Ai(window.location.hash)===K?(t=gs(K,Z,te),window.history.replaceState({hash:t},"",t)):(te.length=0,Z.length=0,t=gs(K,Z,te),window.history.pushState({hash:t},"",t))}class ps{constructor(e,s,n,i,l){this.resultid=e.resultid,this.rawid=this.resultid%u.GPS_RESULT_OFFSET,this.isScoreEvent=s,this.name=rt(e.name).trim(),this.initials=this.getInitials(this.name),this.starttime=e.starttime,this.time=e.time,(this.time==="00"||this.time==="0")&&(this.time=""),this.timeInSecs=e.secs,this.position=e.position,this.status=e.status,this.canDelete=!1,this.showResult=!0,this.token=0,e.comments?this.comments=rt(e.comments):this.comments="",this.coursename=e.coursename,this.coursename===""&&(this.coursename=e.courseid.toString()),this.courseid=e.courseid,this.variant=e.variant,this.splits=this.adjustRawSplits(e.splits),this.isScoreEvent&&(this.scorex=i,this.scorey=l,this.scorecodes=n),this.trackColour=null,this.userColour=null,this.firstExcluded=J(this.courseid).firstExcluded,this.initialiseTrack(e)}addInterpolatedTimes(e,s,n){const i=this.xysecs[e],l=this.xysecs[s]-i,a=n[e],o=n[s]-a;for(let m=e;m<=s;m+=1)this.xysecs[m]=i+Math.round((n[m]-a)*l/o)}addTrack(e){this.trackx=e.x.split(",").map(function(n){return parseInt(n,10)}),this.tracky=e.y.split(",").map(function(n){return parseInt(n,10)});for(let n=1;n<this.trackx.length;n+=1)this.trackx[n]=this.trackx[n-1]+this.trackx[n],this.tracky[n]=this.tracky[n-1]+this.tracky[n];let s;this.isGPSTrack?s=this.expandGPSTrack():this.splits.length===2?s=this.expandTrackWithNoSplits():s=this.expandNormalTrack(),s&&fr(this.courseid)}adjustRawSplits(e){e.splice(0,0,0);for(let s=1;s<e.length;s+=1)e[s]<=0&&(e[s]=e[s-1]);return e[e.length-1]=Math.max(this.timeInSecs,e[e.length-2]),e}calculateTotalTrackLength(){let e=[];e[0]=0;let s=this.trackx[0],n=this.tracky[0];for(let i=1;i<this.trackx.length;i+=1)e[i]=e[i-1]+Math.round(Y(this.trackx[i],this.tracky[i],s,n)),s=this.trackx[i],n=this.tracky[i];return e}calculateTrackTimes(e){let s=[];s[0]=0;let n=this.getNextValidControl(0),i=e.x[n],l=e.y[n],a=0,o=this.trackx[0],m=this.tracky[0],y=0,h=0,p=0;for(let v=1;v<this.trackx.length;v+=1)if(y=this.trackx[v],h=this.tracky[v],a+=Y(y,h,o,m),s[v]=Math.round(a),o=y,m=h,i===y&&l===h){if(this.xysecs[v]=this.splits[n],this.addInterpolatedTimes(p,v,s),p=v,n=this.getNextValidControl(n),n===e.x.length){this.hasValidTrack=!0;break}i=e.x[n],l=e.y[n]}}drawScoreCourse(){if(this.displayScoreCourse&&this.scorex.length>1){const e=Fe();r.globalAlpha=u.FULL_INTENSITY;let s=ue(this.scorex[0],this.scorey[0],this.scorex[1],this.scorey[1]);W.drawStart(this.scorex[0],this.scorey[0],"",s,e),s=[];for(let i=0;i<this.scorex.length-1;i+=1)s[i]=ue(this.scorex[i],this.scorey[i],this.scorex[i+1],this.scorey[i+1]);const n={from:0,to:this.scorex.length};sr({x:this.scorex,y:this.scorey},s,this.courseid,e,n);for(let i=1;i<this.scorex.length-1;i+=1)W.drawSingleControl(this.scorex[i],this.scorey[i],i,Math.PI*.25,e);W.drawFinish(this.scorex[this.scorex.length-1],this.scorey[this.scorey.length-1],"",e)}}drawTrack(e){try{let s,n,i;if(this.displayTrack){if(this.isGPSTrack&&C.showGPSSpeed&&this.speedColour.length===0&&this.setSpeedColours(),this.isGPSTrack){const y=Fe();r.lineWidth=1,r.strokeStyle=u.PURPLE,r.fillStyle=u.PURPLE_30;let h=1,p=this.splits[h];for(let v=1;v<this.xysecs.length-1&&!(this.firstExcluded>0&&h>=this.firstExcluded);v+=1)if(this.xysecs[v]>=p){if(r.beginPath(),r.arc(this.trackx[v],this.tracky[v],y.controlRadius*.3,0,2*Math.PI,!1),r.fill(),r.stroke(),h=h+1,h>=this.splits.length)break;p=this.splits[h]}}let l=0,a=this.xysecs.length;const o=this.splits[e.filterFrom],m=this.splits[e.filterTo];for(let y=0;y<this.xysecs.length;y+=1)if(this.xysecs[y]>=o){l=y;break}for(let y=this.xysecs.length-1;y>=0;y-=1)if(this.xysecs[y]<=m){a=y;break}r.lineWidth=C.routeWidth,r.strokeStyle=this.trackColour,r.globalAlpha=C.perCentRouteIntensity/100,r.fillStyle=this.trackColour,r.font="10pt Arial",r.textAlign="left",r.beginPath(),r.moveTo(this.trackx[l],this.tracky[l]),s=this.trackx[l],n=this.tracky[l],i=0;for(let y=l+1;y<=a;y+=1)r.lineTo(this.trackx[y],this.tracky[y]),this.trackx[y]===s&&this.tracky[y]===n?i+=1:i>0&&((!this.isGPSTrack||this.isGPSTrack&&C.showThreeSeconds)&&r.fillText("+"+3*i,s+5,n+5),i=0),s=this.trackx[y],n=this.tracky[y],this.isGPSTrack&&C.showGPSSpeed&&(r.strokeStyle=this.speedColour[y],r.stroke(),r.beginPath(),r.moveTo(s,n));r.stroke()}}catch{return}}expandGPSTrack(){for(let e=0;e<this.trackx.length;e+=1)this.xysecs[e]=3*e;return this.speedColour.length=0,this.hasValidTrack=!0,this.hasValidTrack}expandNormalTrack(){this.xysecs.length=0,this.xysecs[0]=0;let e={};return this.isScoreEvent?(e.x=this.scorex,e.y=this.scorey):e=J(this.courseid),this.calculateTrackTimes(e),this.isScoreEvent&&(this.hasValidTrack=!0),this.hasValidTrack}expandTrackWithNoSplits(){this.xysecs.length=0;const e=this.splits[1];let s=0;this.xysecs[0]=0;const n={};n.x=J(this.courseid).x,n.y=J(this.courseid).y;let i=1,l=n.x[i],a=n.y[i],o=n.x[n.x.length-1],m=n.y[n.y.length-1];this.trackx.push(o),this.tracky.push(m);let y=0;const h=this.calculateTotalTrackLength(),p=h[h.length-1];let v=0,w=0,E=!1;for(let k=1;k<this.trackx.length;k+=1)if(v=this.trackx[k],w=this.tracky[k],(v!==this.trackx[0]||w!==this.tracky[0])&&(E=!0),l===v&&a===w&&E){if(s=parseInt(h[k]/p*e,10),this.xysecs[k]=s,this.splits[i]=s,this.addInterpolatedTimes(y,k,h),y=k,i+=1,i===n.x.length){this.hasValidTrack=!0;break}l=n.x[i],a=n.y[i]}return this.hasValidTrack}getColour(e){let s="#";if(e===0)return"#0080ff";if(e<.5)s+="ff";else{const n=parseInt((1-e)*255*2,10);n<16&&(s+="0"),s+=n.toString(16)}if(e>=.5)s+="ff";else{const n=255-parseInt((.5-e)*255*2,10);n<16&&(s+="0"),s+=n.toString(16)}return s+="00",s}getInitials(e){if(e===null)return"??";e=e.replace(/GPS/g,"*");let s="",n=!0;for(let i=0;i<e.length;i+=1)n&&(s+=e.substr(i,1),n=!1),e.charAt(i)===" "&&(n=!0);return s}getNextValidControl(e){for(let s=e+1;s<this.splits.length;s+=1)if(this.splits[s]!==this.splits[s-1])return s;return this.splits.length}initialiseTrack(e){if(this.legpos=[],this.racepos=[],this.hasValidTrack=!1,this.displayTrack=!1,this.displayScoreCourse=!1,this.trackx=[],this.tracky=[],this.speedColour=[],this.xysecs=[],this.resultid>=u.GPS_RESULT_OFFSET){this.isGPSTrack=!0;const s=Qi(this.rawid);this.time=s.time,this.splits=s.splits,this.time===u.TIME_NOT_FOUND&&(this.time=e.time)}else this.isGPSTrack=!1}mapSpeedColours(){const e=16.667/C.maxSpeed,s=16.667/C.minSpeed,n=3,i=this.speedColour.slice().sort(function(y,h){return y-h}),l=je();let a=0,o=0;l!==void 0?(a=n*e/l,o=n*s/l):(a=i[i.length-1],o=i[Math.floor(i.length/95)]);const m=a-o;for(let y=0;y<this.speedColour.length;y+=1){let h=Math.max(this.speedColour[y],o);h=Math.min(h,a),this.speedColour[y]=this.getColour((h-o)/m)}}setSpeedColours(){this.speedColour[0]=0;let e=0;for(let s=1;s<this.trackx.length;s+=1){const n=Y(this.trackx[s],this.tracky[s],this.trackx[s-1],this.tracky[s-1]);this.speedColour[s]=(n+e)/2,e=n}this.mapSpeedColours()}setTrackDisplay(e){this.hasValidTrack&&(e?this.userColour!==null?this.trackColour=this.userColour:this.trackColour=Js():this.trackColour=null,this.displayTrack=e)}}let d=[];function Ri(t,e){d.length=0;let s=[],n=[],i=[];if(e)for(let l=0;l<t.length;l+=1){let a=t[l].variant;s[a]===void 0&&(s[a]=t[l].scorecodes,n[a]=t[l].scorex,i[a]=t[l].scorey)}for(let l=0;l<t.length;l+=1)if(mr(t[l].courseid)){t[l].resultid>u.GPS_RESULT_OFFSET&&t[l].coursename===""&&(t[l].coursename=J(t[l].courseid).name);let a;if(e){let o=t[l].variant;a=new ps(t[l],e,s[o],n[o],i[o])}else a=new ps(t[l],e);d.push(a)}dl(),ol(),hl(),tl(),ll(e)}function Bi(t){for(let e=0;e<t.length;e+=1){let s=t[e].id,n=0;for(;n<d.length;){if(s===d[n].resultid){d[n].addTrack(t[e]);break}n+=1}}}function ys(t){for(let e=0;e<d.length;e+=1)if(d[e].courseid===t&&!jn(e))return!1;return!0}function vs(){for(let t=0;t<d.length;t+=1)if(d[t].hasValidTrack&&!d[t].displayTrack)return!1;return!0}function Pi(t){for(let e=0;e<d.length;e+=1)if(d[e].courseid===t&&d[e].hasValidTrack&&!d[e].displayTrack)return!1;return!0}function bs(t){for(let e=0;e<d.length;e+=1)if(d[e].courseid===t&&d[e].hasValidTrack&&!jn(e))return!1;return!0}function _i(t){for(let e=0;e<d.length;e+=1)if(d[e].courseid===t&&d[e].hasValidTrack&&d[e].displayTrack)return!0;return!1}function Ni(t){const e=Cn();let s=0;for(let n=0;n<d.length;n+=1)d[n].courseid===t&&(d[n].resultid<u.GPS_RESULT_OFFSET||e.format===u.FORMAT_NO_RESULTS||e.format===u.FORMAT_SCORE_EVENT_NO_RESULTS)&&(s+=1);return s}function tn(t){let e=document.getElementById("rg2-select-name");if(e.innerHTML="",e.options.add(xe(null,g("Select name",""))),t!==void 0){for(let s=0;s<d.length;s+=1)d[s].courseid===t&&d[s].resultid<u.GPS_RESULT_OFFSET&&e.options.add(xe(d[s].resultid,d[s].time+" "+d[s].name));e.addEventListener("change",s=>{Ra(parseInt(s.target.value,10))}),e.removeAttribute("disabled")}}function Oi(){let t=Hi();t=t.replace(/&amp;/g,"&");const e=document.getElementById("rg2-result-table");e.innerHTML=t,ul(),rn(),ta();const s=document.querySelectorAll(".resultrow");for(let n of s)n.addEventListener("dblclick",i=>{const l=parseInt(i.currentTarget.dataset.id,10);l&&Ht(l)}),n.addEventListener("contextmenu",i=>{const l=parseInt(i.currentTarget.dataset.id,10);l&&Ht(l)})}function $i(){d.length=0}function Fi(t,e){d[t].displayScoreCourse=e}function xs(){for(let t=0;t<d.length;t+=1){let e;d[t].isScoreEvent?e={from:0,to:d[t].scorex.length}:e=ur(d[t].courseid),d[t].drawTrack(e),d[t].drawScoreCourse()}}function Hi(){let t=[],e=[];if(d.length===0)return`<p>${g("No results available")}</p>`;let s="",n=0,i=0;sl();for(let l=0;l<d.length;l+=1){const a=d[l];if(!a.showResult)continue;a.courseid!==n&&(t.length>0&&(s+=Es(i,n)+"</table>",e.push(s)),i=0,t.push(qi(a)),s=`<table class='resulttable' id='table-${a.courseid}'><thead><tr><th>#</th>`,s+=`<th>${g("Name")}</th><th>${g("Time")}</th>`,s+=`<th><i class='bi-pencil'></i></th><th><i class='bi-play-fill'></i></th></tr></thead><tbody class="table-group-divider">`,n=a.courseid),s+=`<tr class="resultrow" data-id="${a.rawid}"><td>${a.position}</td>`,a.comments!==""&&a.comments!==g("Type your comment")?(a.comments=a.comments.replace(/"/g,"&quot;"),s+=`<td title="${a.comments}"><u>${Ss(a,l)}</u>`):s+=`<td>${Ss(a,l)}`,a.canDelete&&(s+=` <i class='deleteroute bi-trash-fill' data-resultidx=${l}></i>`),s+=`</td><td>${a.time}</td>`;let o="",m="showreplay";a.hasValidTrack&&(i+=1,o=`<input class='showtrack' data-courseid='${n}' data-id='${a.resultid}' type=checkbox name=result></input>`,m+=" showtrackreplay"),s+=`<td>${o}</td>`,s+=`<td><input class="${m}" data-courseid=${n} data-id=${a.resultid} type=checkbox name=replay></input></td></tr>`}s+=`</tbody>${Es(i,n)}</table>`,e.push(s),s='<div class="accordion" id="results-accordion">';for(let l=0;l<e.length;l+=1)s+='<div class="accordion-item">',s+=`<h2 class="accordion-header d-flex" id="header-${l}">`,s+=`<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${l}" aria-expanded="true" aria-controls="collapse-${l}">`,s+=`${t[l].title}</button>${t[l].check}</h2>`,s+=`<div id="collapse-${l}" class="accordion-collapse collapse" aria-labelledby="header-${l}" data-bs-parent="#rg2-result-tab-body">`,s+=`<div class="accordion-body px-0">${e[l]}</div></div></div>`;return s+="</div>",s}function Gi(t){let e=Math.floor(t/86400)+" days ";return t=t-86400*Math.floor(t/86400),e+=Math.floor(t/3600)+" hours ",t=t-3600*Math.floor(t/3600),e+=Math.floor(t/60)+" minutes ",e+=t-60*Math.floor(t/60)+" seconds",e}function Ui(){let t=[],e=[],s=[],n=[];for(let i=0;i<d.length;i+=1){const l=d[i];if(l.resultid<u.GPS_RESULT_OFFSET){const a=l.courseid;t.indexOf(a)===-1&&(t.push(a),e[a]=[],s[a]=[],n[a]=[]);for(let o=0;o<l.scorecodes.length;o+=1)e[a].indexOf(l.scorecodes[o])===-1&&(e[a].push(l.scorecodes[o]),s[a].push(l.scorex[o]),n[a].push(l.scorey[o]))}}for(let i=0;i<t.length;i+=1){const l=t[i];vr(l,e[l],s[l],n[l])}}function sn(t){let e=[];for(let s=0;s<d.length;s+=1)d[s].courseid===t&&d[s].resultid===d[s].rawid&&e.push(d[s]);return e}function nn(t){let e=[];for(let s=0;s<d.length;s+=1)d[s].variant===t&&d[s].resultid===d[s].rawid&&e.push(d[s]);return e}function Vi(t){let e=[];for(let s=0;s<d.length;s+=1)d[s].courseid===t&&e.push(d[s].resultid);return e}function Yi(t){let e=[];for(let s=0;s<d.length;s+=1)d[s].courseid===t&&d[s].hasValidTrack&&e.push(d[s].resultid);return e}function Es(t,e){let s=`<tfoot class="table-group-divider"><tr class='allitemsrow'><td></td><td>${g("Routes")}</td><td></td>`;return t>0?(s+=`<td><input class='allcoursetracks' data-courseid=${e} type=checkbox name=track></input></td>`,s+=`<td><input class='allcoursetracksreplay' data-courseid=${e} type=checkbox name=replay></input></td>`):s+="<td></td><td></td>",s+=`</tr><tr class='allitemsrow'><td></td><td>${g("All")}</td><td></td><td></td>`,s+=`<td><input class='allcoursereplay' data-courseid=${e} type=checkbox name=replay></input></td></tr></tfoot>`,s}function Wi(){let t=!1,e=["<table id='rg2-comments-table' class='table table-sm table-striped table-bordered'>",`<thead><tr><th>${g("Name")}</th><th>${g("Course")}</th>`,`<th>${g("Comments")}</th></tr></thead><tbody class="table-group-divider">`].join("");for(let s=0;s<d.length;s+=1)d[s].comments!==""&&(t=!0,e+=[`<tr><td>${d[s].name}</td><td>${d[s].coursename}</td>`,`<td>${d[s].comments}</td></tr>`].join(""));return t?e+="</tbody></table>":e="",e}function Xi(t){for(let e=0;e<d.length;e+=1)if(d[e].resultid===t)return d[e].courseid}function qi(t){let e=t.coursename;const s=J(t.courseid);s&&!s.isScoreCourse&&s.codes.length>2&&(e+=s.lengthValid?": "+s.length+" km":"");let n=`<div class="d-flex w-100"><div class="flex-grow-1 runners-table-course-header" data-runners="" data-courseid="${t.courseid}">${e}</div>`,i=`<div class="px-2"><input class='showcourse' data-courseid="${t.courseid}"`;return i+=` type=checkbox name ="course" title='Show course' ></input ></div >`,{title:n,check:i}}function ji(t){return{id:d[t].resultid,token:d[t].token}}function zi(){let t=[];for(let e=0;e<d.length;e+=1)if(d[e].displayTrack){let s={};s.trackColour=d[e].trackColour,s.course=or(d[e].courseid),s.name=d[e].name,s.resultid=d[e].resultid,s.rawid=d[e].rawid,t.push(s)}return t}function ln(t){for(let e=0;e<d.length;e+=1)if(d[e].resultid===t)return d[e]}function an(t){let e,s=d.find(n=>n.rawid===t);return s!==void 0&&(e=d.find(n=>(n.resultid-t)%u.GPS_RESULT_OFFSET===0&&n.resultid!==t),e===void 0?s.routeresultid=t:(s.routeresultid=e.resultid,s.hasValidTrack=e.hasValidTrack)),s}function Ss(t,e){let s;return t.rawid===t.resultid?s=t.name:s="<i>"+t.name+"</i>",t.isScoreEvent&&(s=`<input class='showscorecourse' data-courseid=${e} type=checkbox></input> ${s}`),`<div>${s}</div>`}function Ki(t){let e=d.findIndex(s=>s.resultid===t);return e>-1?d[e].displayOrder:t}function Zi(){let t={results:0,drawnroutes:0,gpsroutes:0,secs:0};for(let e=0;e<d.length;e+=1){const s=d[e];s.resultid<u.GPS_RESULT_OFFSET&&(t.results+=1,s.time&&(t.secs+=s.splits[s.splits.length-1])),s.hasValidTrack&&(s.resultid<u.GPS_RESULT_OFFSET?t.drawnroutes+=1:t.gpsroutes+=1)}return t.totalroutes=t.drawnroutes+t.gpsroutes,t.results>0?t.percent=(100*t.totalroutes/t.results).toFixed(1):t.percent=0,t.time=Gi(t.secs),t}function Ji(t){const e=Zi(),s=dr(),n=Xe();let i="";if(t.worldfile.valid){const o=An(),m=1e6,y=parseInt(o.F*m)/m,h=parseInt(o.C*m)/m;i=`${g("Map is georeferenced")}: <a href="https://www.openstreetmap.org/#map=15/${y}/${h}" target="_blank" rel="noopener noreferrer">${y}, ${h}</a>.`}function l(o,m){return`<div class="card m-2 text-center" style="width: auto; min-width: 15%">
    <div class="card-header">${o}</div>
    <div class="card-body">
      <p class="card-text">${m}</p>
    </div>
  </div>`}let a=l(g("Courses"),s.length)+l(g("Controls"),t.controls)+l(g("Results"),e.results)+l(g("Routes"),e.totalroutes+" ("+e.percent+"%)")+l(g("Drawn routes"),e.drawnroutes)+l(g("GPS routes"),e.gpsroutes)+l(g("Total time"),e.time)+l(g("Map")+" ID "+Ya(),n.width+"x"+n.height+" pixels<br>"+i);return t.comment&&(a+=l(g("Comments"),t.comment)),a}function uo(){let t=[];for(let e=0;e<d.length;e+=1)if(d[e].hasValidTrack){let s={};s.id=e,s.resultid=d[e].resultid,s.name=d[e].name,s.time=d[e].time,s.coursename=d[e].coursename,t.push(s)}return t}function Qi(t){for(let e=0;e<d.length;e+=1)if(t===d[e].resultid)return{time:d[e].time,splits:d[e].splits};return{time:u.TIME_NOT_FOUND,splits:[]}}function At(){let t=[];for(let e=0;e<d.length;e+=1){const s=d[e];s.displayTrack&&t.push(s.resultid)}return t}function el(){const t=[];return d.forEach(e=>{!t.includes(e.variant)&&e.variant!==void 0&&t.push(e.variant)}),t}function tl(){let t,e,s=[];for(let n=0;n<d.length;n+=1)if(d[n].courseid!==t&&(t=d[n].courseid,e=J(t)),e.excludeType===u.EXCLUDED_REAL_SPLITS){s.indexOf(t)===-1&&s.push(t);let i=0;for(let l=1;l<e.exclude.length;l+=1)e.exclude[l]&&(i=i+Math.min(d[n].splits[l]-d[n].splits[l-1],e.allowed[l]));d[n].timeInSecs=Math.max(d[n].splits[d[n].splits.length-1]-i,0),d[n].time=P(d[n].timeInSecs)}for(let n=0;n<s.length;n+=1){let i=d.filter(o=>o.courseid===s[n]);for(let o=0;o<i.length;o+=1)if(i[o].rawid!==i[o].resultid){let m=i.findIndex(y=>y.resultid===i[o].rawid);m>-1&&(i[o].status=i[m].status)}i.sort(function(o,m){return o.status!=="ok"||o.timeInSecs===0?m.status!=="ok"||m.timeInSecs===0?0:1:m.status!=="ok"||m.timeInSecs===0?-1:o.timeInSecs-m.timeInSecs});let l=0,a=0;for(let o=0;o<i.length;o+=1){if(i[o].status!=="ok"||i[o].timeInSecs===0){i[o].position="";continue}a!==i[o].timeInSecs?(l=l+1,a=i[o].timeInSecs):o>0&&i[o].rawid!==i[o-1].rawid&&(l=l+1),i[o].position=l}for(let o=0;o<i.length;o+=1){let m=d.findIndex(y=>y.resultid===i[o].resultid);m>-1&&(d[m].position=i[o].position,d[m].displayOrder=o)}}}function sl(){d.sort(gl);let t,e=!1;for(let s=0;s<d.length;s+=1)d[s].rawid===t?e&&d[s].hasValidTrack&&(d[s-1].showResult=!1,d[s].position=d[s-1].position,e=!1):(e=!d[s].hasValidTrack,t=d[s].rawid)}function nl(){for(let t=0;t<d.length;t+=1)d[t].speedColour.length=0}function il(t){for(let e=0;e<d.length;e+=1)if(t===d[e].resultid)return!0;return!1}function ll(t){let e,s;for(let n=0;n<d.length;n+=1){d[n].courseid!==e&&(e=d[n].courseid,s=J(e)),d[n].legSplits=[],d[n].legSplits[0]=0;let i=0,l=!1;for(let a=1;a<d[n].splits.length;a+=1)d[n].splits[a]-i===0?s.exclude[a]?(d[n].legSplits[a]=d[n].splits[a]-i,i=d[n].splits[a]):(d[n].legSplits[a]=0,l=!0,d[n].lastValidSplit===void 0&&(d[n].lastValidSplit=a-1)):l?(d[n].legSplits[a]=0,i=d[n].splits[a],l=!1):(d[n].legSplits[a]=d[n].splits[a]-i,i=d[n].splits[a]);if(d[n].lastValidSplit===void 0&&(d[n].lastValidSplit=d[n].splits.length-1),!t){const a=hr(d[n].courseid)+2;for(;d[n].splits.length<a;)d[n].splits.push(d[n].splits[d[n].splits.length-1]),d[n].legSplits.push(0)}}}function al(t){Nn()>0&&Ri(t,gt()),yr(),gt()&&(Ui(),W.generateControlList())}function rl(t){Nn()>0&&Bi(t)}function ol(){const t=fe();let e=[];const s=C.drawnRoutes;for(let n=0;n<s.length;n+=1)s[n].eventid===t&&e.push(s[n]);for(let n=0;n<e.length;n+=1)for(let i=0;i<d.length;i+=1)d[i].resultid===e[n].id&&(d[i].canDelete=!0,d[i].token=e[n].token)}function rn(){document.getElementById("rg2-result-table").querySelectorAll("#results-accordion .accordion-item").forEach(s=>{const n=s.querySelectorAll(".resulttable tbody tr:not(.d-none)");s.querySelector(".runners-table-course-header").setAttribute("data-runners",n.length)})}function dl(){for(let t=0;t<d.length;t+=1)d[t].resultid<u.GPS_RESULT_OFFSET?d[t].displayOrder=t:d[t].displayOrder=Ki(d[t].rawid)}function cl(t,e){for(let s=0;s<d.length;s+=1)d[s].rawid===t&&(d[s].userColour=e,d[s].trackColour=e)}function ul(){let t=document.getElementById("rg2-result-search");if(d.length===0){t.classList.add("d-none");return}t.innerHTML=`<form class="d-flex pb-2" role="search">
  <input class="form-control mx-2" type="search" aria-label="${g("Search")}">
  <i class="bi-search mx-2"></i>
  </form>`;let e=document.getElementById("rg2-result-table");t.addEventListener("keyup",s=>{const n=s.target.value.toUpperCase(),i=e.querySelectorAll("tbody tr");for(let l=0;l<i.length;l+=1)i[l].innerText.toUpperCase().indexOf(n)>-1?i[l].classList.remove("d-none"):i[l].classList.add("d-none");rn()})}function He(t,e){for(let s=0;s<d.length;s+=1)d[s].resultid===t&&(d[s].displayScoreCourse=e)}function hl(){for(let t=0;t<d.length;t+=1)if(d[t].resultid>=u.GPS_RESULT_OFFSET){const e=an(d[t].rawid);e!==void 0&&e.scorex!==void 0&&(d[t].scorex=e.scorex,d[t].scorey=e.scorey,d[t].scorecodes=e.scorecodes)}}function Ts(t,e){for(let s=0;s<d.length;s+=1)(d[s].courseid===t||u.DISPLAY_ALL_COURSES===t)&&d[s].setTrackDisplay(e);os()}function fl(t,e){for(let s=0;s<d.length;s+=1)d[s].resultid===parseInt(t,10)&&d[s].setTrackDisplay(e);os()}function gl(t,e){return t.courseid>e.courseid?1:e.courseid>t.courseid?-1:t.rawid===e.rawid?t.resultid-e.resultid:t.displayOrder-e.displayOrder}class jt{constructor(e){const s=ln(e);this.name=s.name,this.initials=s.initials,this.resultid=e,this.rawid=s.rawid,this.starttime=s.starttime,this.splits=s.splits,this.trackColour=s.trackColour,this.userColour=s.userColour;let n;s.isScoreEvent?(n={},n.name=s.coursename,n.x=s.scorex,n.y=s.scorey,n.codes=s.scorecodes):n=J(s.courseid),this.coursename=n.name,this.nextStopTime=u.VERY_HIGH_TIME_IN_SECS,this.x=[],this.y=[],this.cumulativeDistance=[],this.cumulativeDistance[0]=0,this.legTrackDistance=[],this.legTrackDistance[0]=0,this.cumulativeTrackDistance=[],this.cumulativeTrackDistance[0]=0,s.hasValidTrack?this.expandTrack(s.trackx,s.tracky,s.xysecs):this.expandTrack(n.x,n.y,s.splits),this.addTrackDistances(n,s)}addTrackDistances(e,s){const n=this.cumulativeDistance.length-1;if(e.codes!==void 0)if(s.splits.length>1)for(let i=1;i<e.codes.length;i+=1){let l;s.splits[i]<=n?l=s.splits[i]:l=n,this.cumulativeTrackDistance[i]=this.cumulativeDistance[l],this.legTrackDistance[i]=this.cumulativeTrackDistance[i]-this.cumulativeTrackDistance[i-1]}else this.legTrackDistance[1]=this.cumulativeDistance[n],this.cumulativeTrackDistance[1]=this.cumulativeDistance[n]}expandTrack(e,s,n){let i=0,l=0,a=e[0],o=s[0],m=0,y=0;this.x[0]=e[0],this.y[0]=s[0];let h=je();h===void 0&&(h=1);for(let p=1;p<n.length;p+=1){let v=e[p],w=s[p],E=v-a,k=w-o;y=y+Y(v,w,a,o)*h;let b=y-m;l=n[p],l===0&&(l=i+1);let R=l-i;for(let z=i+1;z<l;z+=1)this.x[z]=Math.round(a+(z-i)*E/R),this.y[z]=Math.round(o+(z-i)*k/R),this.cumulativeDistance[z]=Math.round(m+(z-i)*b/R);this.x[l]=v,this.y[l]=w,this.cumulativeDistance[l]=Math.round(y),a=v,o=w,m=y,i=l}}}const it=[{id:"rg2-stats-summary",title:"Summary",active:"true"},{id:"rg2-legs",title:"Leg times"},{id:"rg2-cumulative",title:"Cumulative times"},{id:"rg2-split-times",title:"Split times"},{id:"rg2-time-loss",title:"Time loss"},{id:"rg2-speed-stats",title:"Speed"}],ml=['<div id="rg2-stats-summary" class="container"></div><div style="height: 400px;"><canvas id="rg2-splits-chart"></canvas></div>','<div id="rg2-leg-table" style="width: 950px; height: 100%" class="ag-theme-balham"></div>','<div id="rg2-race-table" style="width: 950px; height: 100%;" class="ag-theme-balham"></div>',`<div id="rg2-results-table" class="rg2-results-table-container">
     <div id="rg2-results-grid-wrapper">
       <div id="rg2-results-grid" style="height: 100%" class="ag-theme-balham"></div>
     </div>
   </div>`,`<div id="rg2-time-loss" class="container">
     <div class="d-flex align-items-center justify-content-between">
       <div class="d-flex align-items-center">
         <div id="rg2-control-change" class="pe-4">
           <button id="rg2-stats-control-back" class="btn btn-outline-primary btn-sm p-2">&lt;</button>
           <button id="rg2-stats-control-forward" class="btn btn-outline-primary btn-sm p-2">&gt;</button>
         </div>
         <div id="rg2-control-number" class="fw-bold pe-2"></div>
       </div>
       <div id="rg2-loss-details" class="d-flex justify-content-center"></div>
     </div>
     <canvas id="rg2-loss-chart"></canvas>
   </div>`,'<div id="rg2-speed-stats" style="width: 950px; height: 100%" class="ag-theme-balham"></div>'],pl=`<div class="rg2-stats-runner-change pe-4">
      <button class="rg2-stats-name-back btn btn-outline-primary btn-sm p-2">
        &lt;
      </button>
      <button class="rg2-stats-name-forward btn btn-outline-primary btn-sm p-2">
        &gt;
      </button>
    </div >`,yl=`<div class="rg2-stats-course-change pe-4">
      <button class="rg2-stats-course-back btn btn-outline-primary btn-sm p-2">
        &lt;
      </button>
      <button class="rg2-stats-course-forward btn btn-outline-primary btn-sm p-2">
        &gt;
      </button>
    </div >`;let T=null,pe=null,f=[],Me=[],Ge=!1,I=null,U=0,Ue="",dt="m",Q=[],ee=[],M=null,Je,Qe,F=1,vl=9,X=2;const on="#rg2-stats-summary-tab-label";let zt=on,Kt=null;function bl(){if(I.excludeType===u.EXCLUDED_REAL_SPLITS)for(let t=0;t<f.length;t+=1){let e=0;for(let s=1;s<I.exclude.length;s+=1){if(I.exclude[s]){const n=Math.min(f[t].splits[s]-f[t].splits[s-1]-e,I.allowed[s]);e=e+n}f[t].splits[s]=f[t].splits[s]-e,f[t].legSplits[s]=f[t].splits[s]-f[t].splits[s-1]}}}function xl(t){for(let e=0;e<f.length;e+=1){t===0&&(f[e].predictedSplits=[],f[e].loss=[],f[e].totalLoss=[]),f[e].predictedSplits[t]=[],f[e].predictedSplits[t][0]=0,f[e].loss[t]=[],f[e].loss[t][0]=0;let s=0;for(let n=0;n<U;n+=1)f[e].performanceIndex[t]>0?f[e].predictedSplits[t][n]=parseInt(I.refLegTime[t][n]/f[e].normalPerformanceIndex[t],10):f[e].predictedSplits[t][n]=f[e].legSplits[n],f[e].loss[t][n]=f[e].legSplits[n]-f[e].predictedSplits[t][n],f[e].loss[t][n]<0&&(f[e].loss[t][n]=0),s=s+f[e].loss[t][n];f[e].totalLoss[t]=s}}function El(t){t===0&&(I.refLegTime=[],I.refTime=[]);let e=[],s=[];for(let n=0;n<U;n+=1){if(e.length=0,!I.exclude[n])for(let l=0;l<f.length;l+=1)f[l].iterSplits[t][n]!==0&&e.push(f[l].iterSplits[t][n]);const i=$t(e,25);s.push(i.median)}I.refLegTime[t]=s.slice(0),I.refTime[t]=s.reduce((n,i)=>n+i);for(let n=0;n<f.length;n+=1){t===0&&(f[n].refRatio=[],f[n].performanceIndex=[],f[n].normalPerformanceIndex=[],f[n].totalSecs=[]),f[n].refRatio[t]=[];const i=[];for(let y=0;y<U;y+=1)f[n].iterSplits[t][y]===0?f[n].refRatio[t][y]=0:f[n].refRatio[t][y]=I.refLegTime[t][y]/f[n].iterSplits[t][y],i.push(f[n].refRatio[t][y]);const l=i.filter(y=>y>0),a=$t(l,100);f[n].performanceIndex[t]=a.median,f[n].totalSecs[t]=f[n].iterSplits[t].reduce((y,h)=>y+h);let o=0,m=0;for(let y=0;y<U;y+=1)f[n].iterSplits[t][y]!==0&&(o=o+f[n].refRatio[t][y]*I.refLegTime[t][y],m=m+I.refLegTime[t][y]);o===0?f[n].normalPerformanceIndex[t]=0:f[n].normalPerformanceIndex[t]=o/m}}function Sl(t){for(let e=0;e<f.length;e+=1){t===0&&(f[e].iterSplits=[]);let s=[];for(let n=0;n<U;n+=1)t===0?s.push(f[e].legSplits[n]):s.push(f[e].predictedSplits[t-1][n]);f[e].iterSplits[t]=s.slice(0)}}function dn(){F=F===T.splits.length-1?1:F+1,Zt()}function cn(){F=F>1?F-1:T.splits.length-1,Zt()}function ks(t){let e=T.rawid;try{let s=[];if(Ge){let n=Me.findIndex(i=>T.variant===i);t<0?n=n===Me.length-1?0:n+1:n=n>1?n-1:Me.length-1,s=nn(Me[n])}else{const n=_n();let i=n.findIndex(a=>a?a.courseid===I.courseid:!1);t<0?i=i===n.length-1?1:i+1:i=i>1?i-1:n.length-1;const l=n[i].courseid;s=sn(l)}s.length>0&&(e=s[0].rawid)}catch(s){console.log("Error switching to new course: "+s)}ut(e)}function ct(t){t<0?M=M===f.length-1?0:M+1:M=M>0?M-1:f.length-1,ut(f[M].rawid)}function Tl(t){let e="",s="";T.splits.length-1===F?e=g("Finish"):(e=g("Control"),s=": "+F);let n=`<div>${e}${s}</div>`;if(document.getElementById("rg2-control-number").innerHTML=n,n="",I.exclude[F])n=g("Control excluded","");else{const i=t.filter(a=>a.loss>0).map(a=>a.loss),l=$t(i,100);n=`<div class="px-2 fw-bold">${g("Runners with loss")}: ${l.count}</div >`,n+=`<div class="px-2 fw-bold">${g("Average")}: ${parseInt(l.mean,10)}s (${parseInt(l.mean*1e3/I.refLegTime[X][F],10)/10}%)</div>`,n+=`<div class="px-2 fw-bold">${g("Median")}: ${l.median}s (${parseInt(l.median*1e3/I.refLegTime[X][F],10)/10}%)</div>`}document.getElementById("rg2-loss-details").innerHTML=n}function kl(){document.getElementById("rg2-stats-panel-tab-headers").addEventListener("show.bs.tab",i=>{Nl(i.target)});const t=document.getElementsByClassName("rg2-stats-name-back");for(let i of t)i.addEventListener("click",()=>{ct(1)});const e=document.getElementsByClassName("rg2-stats-name-forward");for(let i of e)i.addEventListener("click",()=>{ct(-1)});const s=document.getElementsByClassName("rg2-stats-course-back");for(let i of s)i.addEventListener("click",()=>{ks(1)});const n=document.getElementsByClassName("rg2-stats-course-forward");for(let i of n)i.addEventListener("click",()=>{ks(-1)});document.getElementById("rg2-stats-control-back").addEventListener("click",cn),document.getElementById("rg2-stats-control-forward").addEventListener("click",dn),document.getElementById(zt.replace("#","")).click()}function Zt(){Qe!==void 0&&(Qe.destroy(),Qe=void 0);const t=document.getElementById("rg2-loss-chart"),e=b=>l.length===0?u.DARK_GREEN_30:l[b.dataIndex].activeRunner?u.DARK_GREEN:u.DARK_GREEN_30,s=b=>l.length===0?u.RED_30:l[b.dataIndex].activeRunner?u.RED:u.RED_30,n=b=>l.length===0?u.BLUE_30:l[b.dataIndex].activeRunner?u.BLUE:u.BLUE_30,i=b=>l.length===0?u.PURPLE_30:l[b.dataIndex].activeRunner?u.PURPLE:u.PURPLE_30,l=[];I.exclude[F]||f.map(b=>{if(parseInt(b.legSplits[F],10)>0){let R={};const z=parseInt(b.loss[X][F],10),we=parseInt(b.predictedSplits[X][F],10),Le=parseInt(b.legSplits[F],10);R.loss=z,R.predicted=z===0?0:we,R.rawPredicted=we,R.actual=Le<=we?Le:0,R.gain=Le<=we?we-Le:0,R.realSplit=Le,R.pos=b.legpos[F],R.name=b.name,b.rawid===pe&&(R.activeRunner=!0),l.push(R)}}),l.sort((b,R)=>b.realSplit-R.realSplit);const a=l.map(b=>b.predicted),o=l.map(b=>b.actual),m=l.map(b=>b.loss),y=l.map(b=>b.gain),h=l.map(b=>b.pos),p=l.map(()=>I.refLegTime[X][F]),v=f.reduce((b,R)=>Math.max(b,R.legSplits[F]),0),w=120,E=parseInt((v+w-1)/w,10)*w;Tl(l),Qe=new Kt(t,{data:{labels:h,datasets:[{label:"Actual",type:"bar",data:o,backgroundColor:e},{label:"Gain",type:"bar",data:y,yAxisID:"yLoss",backgroundColor:n},{label:"Predicted",type:"bar",data:a,yAxisID:"yLoss",backgroundColor:i},{label:"Loss",type:"bar",data:m,yAxisID:"yLoss",backgroundColor:s},{label:"Reference time",type:"line",data:p,borderColor:u.RED,backgroundColor:u.WHITE,borderDash:[5,5],yAxisID:"yLoss",pointStyle:"circle",pointRadius:0,pointHoverRadius:0}]},options:{scales:{x:{stacked:!0,title:{display:!0,text:"Position"}},yLoss:{stacked:!0,min:0,max:E,title:{display:!0,text:"Time (s)"}}},plugins:{tooltip:{callbacks:{label(b){let R=b.dataset.label+": ";return b.dataset.label==="Loss"?R+=P(l[b.dataIndex].loss):b.dataset.label==="Gain"?R+=P(l[b.dataIndex].gain):b.dataset.label==="Actual"?R+=P(l[b.dataIndex].actual):R+=P(l[b.dataIndex].predicted),R},title(b){return l[b[0].dataIndex].name+": "+P(l[b[0].dataIndex].realSplit)}}}}}});const k=document.querySelector("#rg2-loss-chart");k.onwheel=b=>{b.preventDefault(),b.deltaY<0?dn():cn()}}function Il(){F=1,Zt()}function wl(){let t=[];for(let e=1;e<I.codes.length;e+=1){t.length=0;for(let i=0;i<f.length;i+=1)f[i].resultid===f[i].rawid&&(f[i].isScoreEvent?f[i].variant===I.courseid&&t.push({time:f[i].legSplits[e],id:i}):f[i].courseid===I.courseid&&t.push({time:f[i].legSplits[e],id:i}));t.sort(Ds);let s=0,n=0;for(let i=0;i<t.length;i+=1){if(I.exclude[e]){f[t[i].id].legpos[e]=0;continue}t[i].time!==n?t[i].time===0?(f[t[i].id].legpos[e]=0,n=0,s=0):(f[t[i].id].legpos[e]=i+1,n=t[i].time,s=i+1):f[t[i].id].legpos[e]=s}}t.length=0;for(let e=1;e<I.codes.length;e+=1){t.length=0;let s=0;for(let l=0;l<f.length;l+=1)f[l].resultid===f[l].rawid&&(f[l].isScoreEvent?f[l].variant===I.courseid&&(e>f[l].lastValidSplit?s=0:s=f[l].splits[e],t.push({time:s,id:l})):f[l].courseid===I.courseid&&(e>f[l].lastValidSplit?s=0:s=f[l].splits[e],t.push({time:s,id:l})));t.sort(Ds);let n=0,i=0;for(let l=0;l<t.length;l+=1)t[l].time!==i?t[l].time===0?(f[t[l].id].racepos[e]=0,n=0,i=0):(f[t[l].id].racepos[e]=l+1,i=t[l].time,n=l+1):f[t[l].id].racepos[e]=n}}function et(t,e){if(e<=0||t<=0)return"-";const s=t/60/(e/1e3),n=parseInt(s,10),i=parseInt((s-n)*60,10),l=n+":"+(i<10?"0"+i:i);return Ue===""?"("+l+")":l}function Ll(){const t=[],e=new jt(T.routeresultid);for(let l=0;l<T.splits.length;l+=1){let a={};a.name=T.name,l===0?a.control="S":l==T.splits.length-1?a.control="F":a.control=l+" ("+I.codes[l]+")",l===0?a.time="0:00":a.time=P(T.legSplits[l]),l===0||I.exclude[l]?a.length="-":a.length=I.legLengths[l],l===0||I.exclude[l]?a.speed="-":a.speed=et(T.legSplits[l],I.legLengths[l]),l===0||I.exclude[l]||!T.hasValidTrack||T.firstExcluded>0&&T.firstExcluded<=l?a.route="-":a.route=e.legTrackDistance[l],l===0||I.exclude[l]||!T.hasValidTrack||T.firstExcluded>0&&T.firstExcluded<=l?a.routespeed="-":a.routespeed=et(T.legSplits[l],e.legTrackDistance[l]),l===0||I.exclude[l]||!T.hasValidTrack||T.firstExcluded>0&&T.firstExcluded<=l?a.percent="-":a.percent=(100*e.legTrackDistance[l]/I.legLengths[l]).toFixed(1)+"%",t.push(a)}let s={};s.name="Total",s.control=g("Total",""),s.time=P(T.timeInSecs),s.length=I.length*1e3,s.speed=et(T.timeInSecs,I.length*1e3),T.hasValidTrack?(s.route=e.cumulativeTrackDistance[e.cumulativeTrackDistance.length-1],s.routespeed=et(T.timeInSecs,e.cumulativeTrackDistance[e.cumulativeTrackDistance.length-1]),s.percent=(100*e.cumulativeTrackDistance[e.cumulativeTrackDistance.length-1]/I.cumulativeLegLengths[I.cumulativeLegLengths.length-1]).toFixed(1)+"%"):(s.route="-",s.routespeed="-",s.percent="-"),t.push(s);const n={columnDefs:[{headerName:g("Control",""),field:"control",width:80},{headerName:g("Time",""),field:"time",width:80,comparator:Re.bind(this)},{headerName:g("Length","")+" "+dt,field:"length",width:90},{headerName:g("Speed","")+" "+Ue,field:"speed",width:125},{headerName:g("Route","")+" "+dt,field:"route",width:90},{headerName:g("Speed","")+" "+Ue,field:"routespeed",width:125},{headerName:g("%",""),field:"percent",width:90}],rowData:t,domLayout:"autoHeight",rowClassRules:{"fw-bold":l=>l.data.name==="Total"},defaultColDef:{headerClass:"align-center",cellClass:"align-center",sortable:!0}},i=document.getElementById("rg2-speed-stats");i.innerHTML="",rg2Config.createGrid(i,n)}function Dl(){Je!==void 0&&(Je.destroy(),Je=void 0);const t=(E,k)=>E.p0.skip||E.p1.skip?k:void 0,e=document.getElementById("rg2-splits-chart"),s=f[M],n=s.legpos.map((E,k,b)=>k===b.length-1?"F":k),i=un(),l=s.legpos.map(E=>E===0?NaN:E),a=s.loss[X].map((E,k)=>s.legpos[k]===0?NaN:E),o=s.predictedSplits[X].map((E,k)=>s.legpos[k]===0?NaN:E>s.legSplits[k]?E-s.legSplits[k]:0),m=s.legpos.map(()=>i.average),y=a.reduce((E,k)=>Math.max(E,isNaN(k)?0:k),0),h=o.reduce((E,k)=>Math.max(E,isNaN(k)?0:k),0),p=120,v=parseInt((Math.max(y,h)+p-1)/p,10)*p;Je=new Kt(e,{data:{labels:n,datasets:[{label:"Leg position",type:"line",data:l,borderColor:u.PURPLE,backgroundColor:u.PURPLE_30,yAxisID:"yPosition",segment:{borderColor:E=>t(E,"rgb(0,0,0,0.2)"),borderDash:E=>t(E,[6,6])},spanGaps:!0},{label:"Average leg position",type:"line",data:m,borderColor:u.RED,backgroundColor:u.WHITE,borderDash:[5,5],yAxisID:"yPosition",pointStyle:"circle",pointRadius:0,pointHoverRadius:0},{label:"Time loss",type:"bar",data:a,borderColor:u.RED,backgroundColor:u.RED_30,yAxisID:"yLoss",segment:{borderColor:E=>t(E,"rgb(0,0,0,0.2)"),borderDash:E=>t(E,[6,6])}},{label:"Time gain",type:"bar",data:o,borderColor:u.BLUE,backgroundColor:u.BLUE_30,yAxisID:"yLoss",segment:{borderColor:E=>t(E,"rgb(0,0,0,0.2)"),borderDash:E=>t(E,[6,6])}}]},options:{maintainAspectRatio:!1,responsive:!0,scales:{x:{min:1,title:{display:!0,text:g("Control","")},stacked:!0},yPosition:{type:"linear",display:!0,position:"left",min:0,max:parseInt((f.length+9)/10,10)*10,title:{display:!0,text:"Leg position"}},yLoss:{type:"linear",display:!0,position:"right",min:0,max:v,grid:{drawOnChartArea:!1},title:{display:!0,text:"Time gain/loss (s)"}}},plugins:{tooltip:{callbacks:{label:function(E){return E.dataset.label==="Time loss"?"Loss: "+P(a[E.dataIndex]):E.dataset.label==="Time gain"?"Gain: "+P(o[E.dataIndex]):E.dataset.label==="Leg position"?"Position: "+l[E.dataIndex]:""},title:function(E){return E[0].label==="F"?g("Finish",""):g("Control","")+" "+E[0].label}}}}}});const w=document.querySelector("#rg2-splits-chart");w.onwheel=E=>{E.preventDefault(),E.deltaY<0?ct(-1):ct(1)}}function Cl(){const t=[{headerName:g("Pos",""),field:"position",cellDataType:"text",width:60,pinned:"left",sortable:!0},{headerName:g("Name",""),field:"name",cellDataType:"text",headerClass:"align-left",cellClass:"align-left",width:150,pinned:"left"},{headerName:"rawid",field:"rawid",cellDataType:"number",hide:!0},{headerName:g("Time",""),field:"time",cellDataType:"text",width:85}];for(let a=1;a<U-1;a+=1)t.push({headerName:a+" ("+I.codes[a]+")",field:"C"+a,cellDataType:"text",cellRenderer:Ls,width:110});t.push({headerName:g("F",""),field:"finish",cellDataType:"text",cellRenderer:Ls,width:110}),t.push({headerName:g("Loss",""),field:"loss",cellDataType:"text",width:100}),t.push({headerName:g("Performance",""),field:"performance",cellDataType:"text",width:100}),t.push({headerName:g("Consistency",""),field:"consistency",cellDataType:"text",width:100});let e=[];f.sort(function(a,o){return a.racepos[a.splits.length-1]<=0?1:o.racepos[o.splits.length-1]<=0?-1:a.racepos[a.splits.length-1]-o.racepos[o.splits.length-1]}),M=gn(pe);for(let a=0;a<f.length;a+=1){let o={};const m=f[a];m.racepos[U-1]==0?o.position="":o.position=m.racepos[U-1],o.name=m.name,o.rawid=m.rawid,o.time=m.time;for(let h=1;h<U-1;h+=1)m.splits[h]===m.splits[h-1]?o["C"+h]={split:"0:00",pos:m.racepos[h],loss:!1}:o["C"+h]={split:P(m.splits[h]),pos:m.racepos[h],loss:!1};o.finish={split:P(m.splits[U-1]),pos:m.racepos[U-1]},o.loss=P(m.timeInSecs-m.totalLoss[X]),o.performance=(m.performanceIndex[0]*100).toFixed(1);const y=m.refRatio[0].filter(h=>h>0);o.consistency=(100*hn(y)).toFixed(1),e.push(o),o={},o.rawid=m.rawid;for(let h=1;h<U-1;h+=1)o["C"+h]={split:P(m.legSplits[h]),pos:m.legpos[h],loss:m.loss[X][h]>19};o.finish={split:P(m.legSplits[U-1]),pos:m.legpos[U-1],loss:m.loss[X][U-1]>19},o.loss=P(m.totalLoss[X]),e.push(o)}const s={columnDefs:t,rowData:e,defaultColDef:{headerClass:"align-center",cellClass:"align-center"},rowClassRules:{"rg2-active-runner":a=>a.data.rawid===pe}},n=document.getElementById("rg2-map-canvas").height*.98-120,i=document.getElementById("rg2-results-grid-wrapper");i.removeAttribute("style"),i.setAttribute("style","height: "+n+"px;");const l=document.getElementById("rg2-results-grid");l.innerHTML="",rg2Config.createGrid(l,s)}function Al(){const t=un(),e=o=>`${o}`;let s=e('<div class="d-flex align-items-center justify-content-between pb-4">');s+=e('<div class="d-flex align-items-center">'),s+=e(`${pl}`),s+=e(`<div class="fw-bold pe-4">${T.name}</div>`),s+=e(`<div class="fw-bold pe-4">${T.time}</div>`),s+=e(`<div class="fw-bold pe-4">(${f[M].racepos[U-1]}/${f.length})</div>`);let n="";Hl(T.timeInSecs)&&(n=` (${(100*f[M].totalLoss[X]/T.timeInSecs).toFixed(1)}%)`),s+=e(`<div class="fw-bold pe-4">${g("Estimated loss")}: ${P(f[M].totalLoss[X])}${n}</div>`),s+=e("</div>"),s+=e('<div class="d-flex align-items-center">');const i=Ge?"V"+T.variant+"&nbsp;":"";s+=e(`<div class="fw-bold pe-4">${i}${T.coursename}</div><div>${yl}</div>`),s+=e("</div></div>");const l=document.getElementsByClassName("rg2-stats-title-row");for(let o of l)o.innerHTML=s;s='<div class="d-flex align-items-center">',s+=e(`<div class="fw-bold pe-4">${g("Average leg position")}: ${t.average} (${g("Best","")}: ${t.best}, ${g("Worst")}: ${t.worst})</div >`),s+=e(`<div  class="fw-bold pe-4">${g("Performance")} ${(T.performanceIndex[0]*100).toFixed(1)}%</div>`);const a=f[M].refRatio[0].filter(o=>o>0);s+=e(`<div  class="fw-bold">${g("Consistency")} ${(100*hn(a)).toFixed(1)}%</div>`),s+=e("</div>"),document.getElementById("rg2-stats-summary").innerHTML=s}function Ml(){const t=[];for(let n=0;n<f[M].splits.length;n+=1){let i={};if(i.name=T.name,n===0?i.control="S":n==f[M].splits.length-1?i.control="F":i.control=n+" ("+I.codes[n]+")",n===0?i.time="0:00":i.time=P(f[M].legSplits[n]),n===0||f[M].legpos[n]===0||I.exclude[n]?i.position="-":i.position=f[M].legpos[n],n===0||I.exclude[n]?i.performance="-":i.performance=(100*f[M].refRatio[0][n]).toFixed(1),I.exclude[n]?i.best="-":i.best=P(Q[n][0].t),n===0||I.exclude[n])i.who="-";else{let a=Q[n][0].name;for(let o=1;o<Q[n].length&&Q[n][0].t===Q[n][o].t;o+=1)a+=", "+Q[n][o].name;i.who=a}const l=f[M].legSplits[n]-Q[n][0].t;if(n===0||f[M].legSplits[n]<=0?i.behind="-":i.behind=P(l),n===0||f[M].legSplits[n]<=0?i.percent=0:i.percent=parseInt(l*100/Q[n][0].t,10),I.exclude[n]?i.predicted="-":i.predicted=P(f[M].predictedSplits[X][n]),f[M].legSplits[n]<=0)i.loss="";else{const a=f[M].predictedSplits[X][n]-f[M].legSplits[n];i.loss=a>=0?P(a):"-"+P(a*-1)}t.push(i)}const e={columnDefs:[{headerName:g("Control",""),field:"control",width:80},{headerName:g("Time",""),field:"time",width:80,comparator:Re.bind(this)},{headerName:g("Position",""),field:"position",width:75},{headerName:g("Performance",""),field:"performance",width:95,comparator:Ul.bind(this)},{headerName:g("Best",""),field:"best",width:80},{headerName:g("Who",""),field:"who",headerClass:"align-left",cellClass:n=>n.data.who.indexOf(n.data.name)>-1?"rg2-green-text align-left":"align-left",flex:1,tooltipField:"who"},{headerName:g("Behind",""),field:"behind",width:80,comparator:Re.bind(this)},{headerName:"%",field:"percent",width:60},{headerName:g("Predicted",""),field:"predicted",width:100,comparator:Re.bind(this)},{headerName:g("+/-",""),field:"loss",width:75,cellClass:n=>n.data.loss.substring(0,1)==="-"?"rg2-red-text align-center":"align-center",comparator:Re.bind(this)}],rowData:t,domLayout:"autoHeight",defaultColDef:{headerClass:"align-center",cellClass:"align-center",sortable:!0}},s=document.getElementById("rg2-leg-table");s.innerHTML="",rg2Config.createGrid(s,e)}function Rl(){const t=[];let e=0;for(let i=0;i<f[M].splits.length;i+=1){let l={};if(l.name=T.name,i==0?l.control="S":i==f[M].splits.length-1?l.control="F":l.control=i+" ("+I.codes[i]+")",i==0?l.time="0:00":f[M].splits[i]===f[M].splits[i-1]?l.time="":l.time=P(f[M].splits[i]),i===0||f[M].racepos[i]===0?l.position="-":l.position=f[M].racepos[i],l.best=P(ee[i][0].t),i===0)l.who="-";else{let o=ee[i][0].name;for(let m=1;m<ee[i].length&&ee[i][0].t===ee[i][m].t;m+=1)o+=", "+ee[i][m].name;l.who=o}const a=f[M].splits[i]-ee[i][0].t;i===0||f[M].racepos[i]===0?l.behind="-":l.behind=P(a),i===0||f[M].racepos[i]===0?l.percent="-":l.percent=parseInt(a*100/ee[i][0].t,10),e=e+f[M].loss[X][i],l.loss=P(e),t.push(l)}const s={columnDefs:[{headerName:g("Control",""),field:"control",width:88},{headerName:g("Time",""),field:"time",width:85},{headerName:g("Position",""),field:"position",width:100},{headerName:g("Best",""),field:"best",width:85},{headerName:g("Who",""),field:"who",headerClass:"align-left",cellClass:i=>i.data.who.indexOf(i.data.name)>-1?"rg2-green-text align-left":"align-left",flex:1,tooltipField:"who"},{headerName:g("Behind",""),field:"behind",width:85},{headerName:"%",field:"percent",width:85},{headerName:"Loss",field:"loss",width:100}],rowData:t,domLayout:"autoHeight",defaultColDef:{headerClass:"align-center",cellClass:"align-center"}},n=document.getElementById("rg2-race-table");n.innerHTML="",rg2Config.createGrid(n,s)}function $t(t,e){let s=t.slice();if(s.length===0)return{mean:0,median:0,count:0};s.sort(function(o,m){return o-m});let n=0,i=s.length;if(e<100){const a=Math.max(parseInt(i*e/100,10),3);s.splice(a),i=s.length}for(let a=0;a<i;a+=1)n=n+s[a];let l;return i===1?l=s[0]:i%2===0?l=(s[i/2-1]+s[i/2])/2:l=s[Math.floor(i/2)],{mean:n/i,median:l,count:i}}function un(){let t=0,e=0,s=0,n=9999;for(let l=1;l<T.legpos.length;l+=1)T.legpos[l]!==0&&(t+=T.legpos[l],e+=1,n>T.legpos[l]&&(n=T.legpos[l]),s<T.legpos[l]&&(s=T.legpos[l]));let i;return e>0?i=(t/e).toFixed(1):(i=0,n=0,s=0),{best:n,worst:s,average:i}}function Bl(t){return t.reduce((e,s)=>e+s,0)/t.length}function Is(t){return t==="-"?0:parseFloat(t)}function hn(t){if(t.length===0)return 0;const e=Bl(t);return Math.sqrt(t.reduce((s,n)=>s+Math.pow(n-e,2),0)/t.length)}function Pl(){let t='<ul class="nav nav-pills" id="rg2-stats-panel-tab-headers" role="tablist">';for(let e of it){const s=g(e.title),n=e.active?" active":"",i=e.active?"":"tabindex='-1'";t+=`<li class="nav-item${n}" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#${e.id}-tab"
      type="button" role="tab" ${i}>
      <div id="${e.id}-tab-label">${s}</div>
    </button>
    </li>`}return t+="</ul>",t}function _l(){const t='<div class="rg2-stats-title-row container"></div>';let e='<div id="rg2-stats-table"><div class="tab-content" id="rg2-stats-panel-tab-body">';for(let s=0;s<it.length;s+=1){const n=it[s].active?" active":"";e+=`<div class="tab-pane fade ${n} pt-2" id="${it[s].id}-tab" role="tabpanel" tabindex="${s}">
      ${t}${ml[s]}</div>`}return e+="</div></div></div>",e}function ws(t){return t==="-"?0:parseFloat(t.replace(":","."))}function Nl(t){var e;zt=(e=t==null?void 0:t.dataset)==null?void 0:e.bsTarget}async function Ol(){const{createGrid:t,ModuleRegistry:e}=await st(async()=>{const{createGrid:i,ModuleRegistry:l}=await import("./grid-CJy_EU0E.js").then(a=>a.m);return{createGrid:i,ModuleRegistry:l}},[],import.meta.url);rg2Config.createGrid=t;const{ClientSideRowModelModule:s}=await st(async()=>{const{ClientSideRowModelModule:i}=await import("./grid-CJy_EU0E.js").then(l=>l.a);return{ClientSideRowModelModule:i}},[],import.meta.url);Kt=(await st(()=>import("./node-modules-CBZj5KRR.js").then(i=>i.b),[],import.meta.url)).default,e.registerModules([s])}function $l(t){pe=t,Ge=gt(),je()===void 0?(Ue="",dt="px"):(Ue="min/km",dt="m"),T=an(pe),Ge?(Me=el(),f=nn(T.variant)):f=sn(T.courseid),Fl(T.courseid),bl(),wl(),M=gn(pe)}function Fl(t){if(Ge?I=new Bn({courseid:T.variant,name:"V"+T.variant,codes:T.scorecodes,xpos:T.scorex,ypos:T.scorey,exclude:[],allowed:[],excludeType:0},!0):I=J(t),U=I.codes.length,U<=2)throw new fn(g("No splits available."));Q.length=0,ee.length=0;let e=[],s=[];for(let n=0;n<U;n+=1){e.length=0,s.length=0;for(let i=0;i<f.length;i+=1)n===0?(e.push({t:0,name:"",pos:0}),s.push({t:0,name:"",pos:0})):(e.push({t:f[i].legSplits[n],name:f[i].name,pos:f[i].legpos[n]}),n<=f[i].lastValidSplit&&s.push({t:f[i].splits[n],name:f[i].name,pos:f[i].racepos[n]}));e.sort(function(i,l){return i.t===0?1:l.t===0?-1:i.t-l.t}),s.sort(function(i,l){return i.t-l.t}),Q.push(e.slice()),ee.push(s.slice())}}function Hl(t){return!isNaN(parseFloat(t))&&isFinite(t)?t>0:!1}function Gl(){for(let t=0;t<=vl;t+=1)Sl(t),El(t),xl(t)}function Ul(t,e){return Is(t)-Is(e)}function ut(t){try{return $l(t),Gl(),Al(),Dl(),Il(),Ml(),Rl(),Cl(),Ll(),kl(),!0}catch(e){e instanceof fn?V(g("Statistics"),e.message):V(g("Statistics",""),g("Data inconsistency.","")),bt.getInstance(document.getElementById("rg2-right-info-panel")).hide()}return!1}function Ls(t){if(t.value.split==="0:00")return"";let e=t.value.split,s="";return t.value.pos!==0&&(e+=" ("+t.value.pos+")",t.value.pos===1&&(s="rg2-first"),t.value.pos===2&&(s="rg2-second"),t.value.pos===3&&(s="rg2-third")),t.value.loss&&(s+=" rg2-lost-time"),'<span class="'+s+'">'+e+"</span>"}function fn(t){this.message=t}function gn(t){for(let e=0;e<f.length;e+=1)if(f[e].rawid===t)return T=f[e],e;return null}function Vl(t,e){if(!ns())return V(g("Statistics",""),g("No statistics available for this event format.","")),!1;zt=on,rg2Config.createGrid?ut(t)&&e():Ol().then(()=>{ut(t)&&e()}).catch(()=>{console.log("Error loading Grid and Chart"),V("Error loading Grid and Chart","Statistics functionality failed to load.")})}function Ds(t,e){return t.time===0?1:e.time===0?-1:t.time-e.time}function Re(t,e){return ws(t)-ws(e)}const Ft=document.getElementById("rg2-show-info-panel-control"),oe=document.getElementById("rg2-right-info-panel"),Jt=document.getElementById("rg2-right-info-panel-title"),Qt=new bt(oe,{backdrop:!1}),ye=document.getElementById("rg2-left-info-panel"),Cs=document.getElementById("rg2-left-info-panel-title");let As=document.getElementById("rg2-left-info-panel-body");const mn=new bt(ye,{backdrop:!1});ye.style.width="420px";ye.addEventListener("hidden.bs.offcanvas",()=>{Ft.classList.remove("d-none")});es();const Mt=10,Rt=-10;function Yl(){return!document.getElementById("rg2-animation-controls").classList.contains("d-none")}function Wl(){document.querySelector("label[for=rg2-select-course]").innerHTML=`${g("Select course")}`,document.querySelector("label[for=rg2-select-name]").innerHTML=`${g("Select name")}`,document.querySelector("label[for=rg2-name-entry]").innerHTML=g("Name"),document.querySelector("#rg2-name-entry").addEventListener("input",()=>{_s()}),document.querySelector("label[for=rg2-time-entry]").innerHTML=g("Time"),document.querySelector("#rg2-time-entry").addEventListener("input",()=>{_s()});const t=document.getElementById("rg2-new-comments");t.setAttribute("placeholder",g(u.DEFAULT_NEW_COMMENT,"")),t.addEventListener("focus",()=>{document.getElementById("rg2-new-comments").setAttribute("placeholder","")});const e=document.getElementById("btn-three-seconds");e.innerHTML=g("+3 secs"),e.addEventListener("click",h=>{h.preventDefault(),Na()});const s=document.getElementById("btn-undo");s.innerHTML=g("Undo"),s.addEventListener("click",h=>{h.preventDefault(),_a()});const n=document.getElementById("btn-save-route");n.innerHTML=g("Save"),n.addEventListener("click",h=>{h.preventDefault(),Ca()});const i=document.getElementById("btn-reset-drawing");i.innerHTML=g("Reset"),i.addEventListener("click",h=>{h.preventDefault(),Ia()}),document.getElementById("rg2-load-gps-title").innerHTML=g("Load GPS file (GPX or TCX)"),document.getElementById("btn-offset-plus").addEventListener("click",()=>{const h=document.getElementById("rg2-offset-value");let p=parseInt(h.value,10);p<Mt&&(p=p+1,h.value=p,Bt(p))}),document.getElementById("btn-offset-minus").addEventListener("click",()=>{const h=document.getElementById("rg2-offset-value");let p=parseInt(h.value,10);p>Rt&&(p=p-1,h.value=p,Bt(p))}),document.getElementById("rg2-offset-value").addEventListener("input",()=>{const h=document.getElementById("rg2-offset-value");let p=parseInt(h.value,10);isNaN(p)&&(p=0),p<Rt&&(p=Rt),p>Mt&&(p=Mt),h.value=p,Bt(p)});const l=document.getElementById("btn-undo-gps-adjust");l.innerHTML=g("Undo"),l.addEventListener("click",h=>{h.preventDefault(),Pa()});const a=document.getElementById("btn-autofit-gps");a.innerHTML=g("Autofit"),a.addEventListener("click",h=>{h.preventDefault(),aa()}),document.querySelector("label[for=chk-move-all]").innerHTML=g("Move track and map together (or right click-drag)");const o=document.getElementById("btn-save-gps-route");o.innerHTML=g("Save GPS route"),o.addEventListener("click",h=>{h.preventDefault(),Da()}),["Left click to add/lock/unlock a handle","Green - draggable","Red - locked","Right click to delete a handle","Drag a handle to adjust track around locked point(s)"].forEach((h,p)=>{const v=document.getElementById(`draw-text-${p+1}`);v.innerHTML=`${g(h)}.`}),document.getElementById("rg2-load-gps-file").addEventListener("input",h=>{ka(h)})}function Xl(){document.querySelector("label[for=rg2-select-language]").innerHTML=`${g("Language")}`,ci(u.languages),lt("chk-show-GPS-speed","showGPSSpeed","Show GPS speed colours"),lt("chk-snap-toggle","snap","Snap to control when drawing"),lt("chk-show-three-seconds","showThreeSeconds","Show +3 time loss for GPS routes"),me("map-intensity","perCentMapIntensity","Map intensity","%"),me("route-intensity","perCentRouteIntensity","Route intensity","%"),me("control-circle","circleSize","Control circle size"),me("course-width","courseWidth","Course overprint width"),me("route-width","routeWidth","Route width"),me("name-font-size","replayFontSize","Replay label font size");const t=document.getElementById("rg2-gps-speed-slider");t.setAttribute("value1",C.maxSpeed),t.setAttribute("value2",C.minSpeed),t.addEventListener("change",Zl),document.getElementById("rg2-min-gps-speed-label").innerHTML=yn(),document.getElementById("rg2-max-gps-speed-label").innerHTML=pn()}function lt(t,e,s){document.querySelector(`label[for=${t}]`).innerHTML=`${g(s)}`;const n=document.getElementById(t);n.addEventListener("click",i=>{C[e]=i.target.checked,xt(),D()}),n.checked=C[e]}function me(t,e,s,n=""){let i=document.querySelector(`label[for=spn-${t}]`);i.innerHTML=`${g(s)} ${C[e]}${n}`;let l=document.getElementById(`spn-${t}`);l.setAttribute("value",C[e]),l.addEventListener("change",a=>{Si(e,parseInt(a.target.value,10)),i=document.querySelector(`label[for=spn-${t}`),i.innerHTML=`${g(s)} ${C[e]}${n}`,D()})}function ql(){document.body.addEventListener("contextmenu",n=>{n.preventDefault()}),window.addEventListener("resize",()=>{es(),si()}),document.getElementById("rg2-left-info-panel-body").addEventListener("scroll",n=>{document.getElementById("rg2-info-panel").setAttribute(vn(),n.target.scrollTop)}),Ql(),u.managing()||Wl(),Ms(),document.getElementById("rg2-logo").addEventListener("click",()=>{mn.toggle()}),document.querySelector("#rg2-info-panel-tab-headers").querySelectorAll('button[data-bs-toggle="tab"]').forEach(n=>{n.addEventListener("shown.bs.tab",i=>{sa(i)})}),Ft.addEventListener("click",()=>{Ms(),Ft.classList.add("d-none")}),Jl()}function jl(){if(u.managing())return;let t=document.getElementById("rg2-event-list");t.innerHTML=Ha();let e=document.getElementById("rg2-event-table"),s=document.getElementById("rg2-event-search");s.innerHTML=`<form class="d-flex pb-2" role="search">
  <input class="form-control mr-2" type="search" aria-label="${g("Search")}">
  <i class="bi-search ms-2 mt-2"></i>
  </form>`,s.addEventListener("keyup",n=>{let i=n.target.value.toUpperCase(),l=e.getElementsByTagName("tr");for(let a=0;a<l.length;a+=1)l[a].innerText.toUpperCase().indexOf(i)>-1?l[a].classList.remove("d-none"):l[a].classList.add("d-none")}),e.addEventListener("click",n=>{const i=n.target.closest("tr"),l=parseInt(i.dataset.kartatid,10);isNaN(l)||kt(l)})}function zl(){oe.style.width="800px",Jt.innerHTML="RG2 Version "+u.RG2VERSION,document.getElementById("rg2-about-dialog").classList.remove("d-none"),document.getElementById("rg2-option-controls").classList.add("d-none"),document.getElementById("rg2-stats-dialog").classList.add("d-none");let t=document.getElementById("rg2-event-stats");t.innerHTML=Xa(),document.getElementById("rg2-manager-link").innerHTML=`<a href="${rg2Config.api_url.replace("rg2api.php","?manage")}">Manager Login</a>`,Qt.show()}function Ms(){mn.show()}function Kl(){oe.style.width="420px",Jt.innerHTML=g("Configuration options"),document.getElementById("rg2-about-dialog").classList.add("d-none"),document.getElementById("rg2-option-controls").classList.remove("d-none"),document.getElementById("rg2-stats-dialog").classList.add("d-none"),Xl(),Qt.show()}function Ht(t){oe.style.width="1000px",Jt.innerHTML=Pl(),document.getElementById("rg2-stats-dialog").innerHTML=_l(),document.getElementById("rg2-about-dialog").classList.add("d-none"),document.getElementById("rg2-option-controls").classList.add("d-none"),document.getElementById("rg2-stats-dialog").classList.remove("d-none"),Vl(t,function(){Qt.show()})}function ke(){return document.querySelector("#rg2-info-panel-tab-headers button.active").id}function Rs(t){let e='<div id="rg2-info-panel">';e+='<div class="tab-content" id="rg2-info-panel-tab-body">';for(let s=0;s<t.length;s=s+1){const n=document.getElementById(t[s].body),i=t[s].active?" active show":"";e+=`<div class="tab-pane fade ${i}" id="rg2-${t[s].name}-body" role="tabpanel" 
    aria-labelledby="${t[s].name}" tabindex="${s}">${n.innerHTML}</div>`,n.remove()}return e+="</div></div>",e}function Bs(t){let e='<ul class="nav nav-pills" id="rg2-info-panel-tab-headers" role="tablist">';for(let s=0;s<t.length;s=s+1){const n=t[s].hidden?" d-none":"",i=t[s].active?" active":"",l=t[s].disabled?" disabled ":"";e+=`
    <li class="nav-item" role="presentation">
      <button class="nav-link${i}${n}"${l}id="${t[s].name}" data-bs-toggle="tab"
      data-bs-target="#rg2-${t[s].name}-body"
        type="button" role="tab"><div id="${t[s].name}-label">${g(t[s].title)}</div>
      </button>
    </li>`}return e+="</ul>",e}function pn(){return`<i class="bi-emoji-smile rg2-run-green"></i> ${C.maxSpeed.toFixed(1)} min/km`}function yn(){return`<i class="bi-emoji-smile rg2-run-red"></i> ${C.minSpeed.toFixed(1)} min/km`}function vn(){return`scroll-${ke()}`}function Zl(t){C.maxSpeed=t.detail.value1,C.minSpeed=t.detail.value2;const e=document.getElementById("rg2-min-gps-speed-label");e.innerHTML=yn();const s=document.getElementById("rg2-max-gps-speed-label");s.innerHTML=pn(),nl(),D()}function Jl(){document.getElementById("btn-about").addEventListener("click",t=>{zl()}),document.getElementById("btn-settings").addEventListener("click",t=>{Kl()}),document.getElementById("btn-toggle-controls").addEventListener("click",()=>{W.toggleControlDisplay(),D()}),document.getElementById("btn-stats").addEventListener("click",()=>{Ht(1)}),document.getElementById("btn-splitsbrowser").addEventListener("click",()=>{window.open(rg2Config.api_url+"?type=splitsbrowser&id="+fe()+"&_="+Date.now())}),document.getElementById("btn-measure").setAttribute("disabled",""),document.getElementById("btn-runners").setAttribute("disabled",""),document.getElementById("btn-toggle-controls").setAttribute("disabled",""),document.getElementById("btn-stats").setAttribute("disabled",""),document.getElementById("btn-splitsbrowser").setAttribute("disabled","")}function Ql(){const t=[{name:u.TAB_EVENTS,title:"Events",body:"rg2-event-body",active:!0},{name:u.TAB_COURSES,title:"Courses",body:"rg2-course-body",disabled:!0},{name:u.TAB_RESULTS,title:"Results",body:"rg2-result-body",disabled:!0},{name:u.TAB_DRAW,title:"Draw",body:"rg2-draw-body",disabled:!0}],e=[{name:u.TAB_LOGIN,title:"Login",body:"rg2-login-body",active:!0},{name:u.TAB_CREATE,title:"Add event",body:"rg2-add-event-body",hidden:!0},{name:u.TAB_EDIT,title:"Edit event",body:"rg2-edit-event-body",hidden:!0},{name:u.TAB_MAP,title:"Add map",body:"rg2-add-map-body",hidden:!0},{name:u.TAB_DELETE_MAP,title:"Delete maps",body:"rg2-delete-maps-body",hidden:!0}];u.managing()?(Cs.innerHTML=Bs(e),As.innerHTML=Rs(e)):(Cs.innerHTML=Bs(t),As.innerHTML=Rs(t))}function ea(){er(),tn(void 0),document.getElementById("rg2-select-name").setAttribute("disabled",""),ns()?(document.getElementById("rg2-name-select").classList.remove("d-none"),document.getElementById("rg2-enter-name-and-time").classList.add("d-none")):(document.getElementById("rg2-name-select").classList.add("d-none"),document.getElementById("rg2-enter-name-and-time").classList.remove("d-none")),lt("chk-align-map","alignMap","Align map to next control"),document.getElementById("btn-three-seconds").setAttribute("disabled",""),document.getElementById("btn-undo").setAttribute("disabled",""),document.getElementById("btn-save-route").setAttribute("disabled",""),document.getElementById("btn-reset-drawing").setAttribute("disabled",""),document.getElementById("rg2-load-gps-file").setAttribute("disabled",""),document.getElementById("btn-autofit-gps").setAttribute("disabled",""),document.getElementById("btn-undo-gps-adjust").setAttribute("disabled",""),document.getElementById("btn-save-gps-route").setAttribute("disabled",""),document.getElementById("chk-move-all").checked=!1}function es(){const t=document.getElementById("rg2-header-container").offsetHeight,e=Yl()?document.getElementById("rg2-animation-controls").offsetHeight:0;ye.style.top=`${t}px`,oe.style.top=`${t}px`,ye.style.bottom=`${e}px`,oe.style.bottom=`${e}px`,ye.style.maxWidth=`${window.innerWidth}px`,oe.style.maxWidth=`${window.innerWidth}px`,document.getElementById("rg2-track-names").style.maxHeight=`${window.innerHeight-t-10}px`}function ta(){document.querySelectorAll(".showcourse").forEach(h=>{h.addEventListener("click",p=>{const v=parseInt(p.target.dataset.courseid,10);ze(v,p.target.checked);const w=document.querySelectorAll(".showcourse");for(let k of w)parseInt(k.dataset.courseid,10)===v&&(k.checked=p.target.checked);const E=document.querySelector(".showallcourses");E.checked=Qa(),_e(v),ms(Os()),D()})}),document.querySelector(".showallcourses").addEventListener("click",h=>{On(h.target.checked);const p=document.querySelectorAll(".showcourse");for(let v of p)v.checked=h.target.checked;$s(),ms(Os()),D()}),document.querySelectorAll(".showscorecourse").forEach(h=>{h.addEventListener("click",p=>{Fi(parseInt(p.target.dataset.courseid,10),p.target.checked),D()})}),document.querySelectorAll(".showtrack").forEach(h=>{h.addEventListener("click",p=>{const v=parseInt(p.target.dataset.id,10);fl(v,p.target.checked);const w=parseInt(p.target.dataset.courseid,10);document.querySelectorAll(".allcoursetracks").forEach(b=>{parseInt(b.dataset.courseid,10)===w&&(b.checked=Pi(w))}),document.querySelectorAll(".alltracks").forEach(b=>{b.checked=vs()}),_e(w),Ct(At()),D()})});const i=document.querySelectorAll(".deleteroute");for(let h of i)h.addEventListener("click",p=>{da(parseInt(p.target.dataset.resultidx,10))});const l=document.querySelectorAll(".allcoursetracks");for(let h of l)h.addEventListener("click",p=>{let v=parseInt(p.target.dataset.courseid,10);Ts(v,p.target.checked);const w=document.querySelectorAll(".allcoursetracks");for(let b of w)parseInt(b.dataset.courseid,10)===v&&(b.checked=p.target.checked);const E=document.querySelectorAll(".showtrack");for(let b of E)parseInt(b.dataset.courseid,10)===v&&(b.checked=p.target.checked);const k=document.querySelectorAll(".alltracks");for(let b of k)b.checked=vs();_e(v),Ct(At()),D()});const a=document.querySelectorAll(".alltracks");for(let h of a)h.addEventListener("click",p=>{Ts(u.DISPLAY_ALL_COURSES,p.target.checked);const v=document.querySelectorAll(".allcoursetracks");for(let E of v)E.checked=p.target.checked;const w=document.querySelectorAll(".showtrack");for(let E of w)E.checked=p.target.checked;$s(p.target.checked),Ct(At()),D()});const o=document.querySelectorAll(".showreplay");for(let h of o)h.addEventListener("click",p=>{let v=parseInt(p.target.dataset.id,10);p.target.checked?Gn(new jt(v)):Xn(v);const w=Xi(v),E=document.querySelectorAll(".allcoursetracksreplay");for(let b of E)parseInt(b.dataset.courseid,10)===w&&(b.checked=bs(w));const k=document.querySelectorAll(".allcoursereplay");for(let b of k)b.checked=ys(w);D()});const m=document.querySelectorAll(".allcoursetracksreplay");for(let h of m)h.addEventListener("click",p=>{let v=parseInt(p.target.dataset.courseid,10);const w=Yi(v);Hs(w,p.target.checked);const E=document.querySelectorAll(".showreplay.showtrackreplay");for(let R of E)parseInt(R.dataset.courseid,10)===v&&(R.checked=p.target.checked);const k=document.querySelectorAll(".allcoursetracksreplay");for(let R of k)parseInt(R.dataset.courseid,10)===v&&(R.checked=p.target.checked);let b=document.querySelectorAll(".allcoursereplay");for(let R of b)parseInt(R.dataset.courseid,10)===v&&(R.checked=ys(v));D()});const y=document.querySelectorAll(".allcoursereplay");for(let h of y)h.addEventListener("click",p=>{const v=parseInt(p.target.dataset.courseid,10),w=Vi(v);Hs(w,p.target.checked);const E=document.querySelectorAll(".showreplay");for(let b of E)parseInt(b.dataset.courseid,10)===v&&(b.checked=p.target.checked);const k=document.querySelectorAll(".allcoursetracksreplay");for(let b of k)parseInt(b.dataset.courseid,10)===v&&(b.checked=bs(v));D()})}function sa(t){switch(t.target.id){case u.TAB_DRAW:On(!1),Ba();break}const e=document.getElementById("rg2-info-panel").getAttribute(vn());document.getElementById("rg2-left-info-panel-body").scrollTop=e,D()}const na=50,Ce=20;let ht=null,ft=[],Ve=!1,Ps="#ff0000",bn=null,c=new Qs;c.routeData=new Et;let Tt=null,O=[],G=[],ts=[],N=0,ie=0,Ee=!1;function ia(t,e){Ve&&(ra(t,e)?(Gt(O[N],G[N]),En(N),ie=N,N=Tn(N),N===O.length&&(document.getElementById("btn-save-route").removeAttribute("disabled"),Ze())):Gt(Math.round(t),Math.round(e)),document.getElementById("btn-undo").removeAttribute("disabled"),D())}function Gt(t,e){c.routeData.x.push(t),c.routeData.y.push(e)}function la(t,e,s){const n=c.handles.getPreviousLockedHandle(s),i=c.handles.getNextLockedHandle(s);Pe(t,e,n,n.time,s.time),Pe(t,e,i,s.time,i.time)}function Bt(t){c.adjustOffset(t)}function xn(t,e,s=void 0){if(document.getElementById("chk-move-all").checked||s===u.RIGHT_CLICK)r.translate(e.x-t.x,e.y-t.y);else if(c.handles.handlesLocked()>0)if(c.handles.handlesLocked()===1)Pe(t,e,c.handles.getSingleLockedHandle(),c.handles.getStartHandle().time,c.handles.getFinishHandle().time);else{let l=c.handles.getHandleClicked(t);if(l===void 0||l.locked)return;const a=c.handles.getEarliestLockedHandle(),o=c.handles.getLatestLockedHandle();a.time>=l.time?Pe(t,e,a,c.handles.getStartHandle().time,a.time):o.time<l.time?Pe(t,e,o,o.time,c.handles.getFinishHandle().time):la(t,e,l)}else ga(e.x-t.x,e.y-t.y)}function En(t){if(C.alignMap&&t<O.length-1){Ve=!1,ft=[];const e=O[t],s=G[t],n=O[t+1],i=G[t+1],l=ds(),a=Jn(),o=Y(e,s,n,i),m=Y(l.x,l.y,a.x,a.y);let y=Math.min(m/o,u.MAX_ZOOM);y=Math.max(y,u.MIN_ZOOM);let h;Ee?h=ue(O[t],G[t],O[t+1],G[t+1]):h=ts[t];let p=(r.displayAngle-h-Math.PI/2)%(Math.PI*2);p<-1*Math.PI&&(p=p+2*Math.PI);for(let v=1;v<=Ce;v=v+1){let w={};w.x=l.x-(l.x-e)*v/Ce,w.y=l.y-(l.y-s)*v/Ce,w.angle=(r.displayAngle-p*v/Ce)%(Math.PI*2),w.scale=Math.pow(y,1/Ce),ft.push(w)}ht=setInterval(()=>{Sa()},na)}else Lt(0,O[t],G[t],!1,1),Ve=!0,ht=null}function aa(){c.autofitTrack()}function ra(t,e){let s=C.snap?8:2;return console.log(t,e,O[N],G[N]),Math.abs(t-O[N])<s&&Math.abs(e-G[N])<s}function oa(){let t={};t.body="The route you have started to draw will be discarded. Are you sure you want to change the course?",t.title="Confirm course change",t.doText="Change course",t.onDo=ua,t.onCancel=ca,qt(t)}function da(t){bn=t;let e={};e.body="This route will be permanently deleted. Are you sure?",e.title="Confirm route delete",e.doText="Delete route",e.onDo=ha,qt(e)}function ca(){document.getElementById("rg2-select-course").value=c.routeData.courseid,document.getElementById("rg2-select-name").value=c.routeData.resultid,Tt=null}function ua(){ss(),Ut(Tt)}function ha(){const t=ji(bn),e={type:"deletemyroute",id:fe(),routeid:t.id};js(JSON.stringify({token:t.token}),e,xa,"Route save failed")}function ss(){c.routeData.courseid!==null&&ze(c.routeData.courseid,!1),c.routeData.resultid!==null&&He(c.routeData.resultid,!1),kn()}function Sn(){Aa();const t={type:"addroute",id:c.routeData.eventid};js(JSON.stringify(c.routeData),t,Ea(c.routeData.name),"Route save failed"),ss()}function fa(){c.fileLoaded&&(c.savedBaseX=c.baseX.slice(0),c.savedBaseY=c.baseY.slice(0),c.baseX=c.routeData.x.slice(0),c.baseY=c.routeData.y.slice(0),c.handles.saveForUndo(),c.handles.rebaselineXY(),document.getElementById("btn-undo-gps-adjust").removeAttribute("disabled"))}function ga(t,e){for(let s=0;s<c.baseX.length;s+=1)c.routeData.x[s]=c.baseX[s]+t,c.routeData.y[s]=c.baseY[s]+e;c.handles.dragHandles(t,e)}function Pt(t){r.arc(O[N],G[N],t,0,2*Math.PI,!1),r.fill()}function ma(){const t=Fe();r.lineWidth=t.overprintWidth,r.strokeStyle=u.RED,r.fillStyle=u.RED_30,N>0&&!c.fileLoaded&&(r.beginPath(),N<O.length-1?Pt(t.controlRadius):(Pt(t.finishInnerRadius),r.stroke(),r.beginPath(),Pt(t.finishOuterRadius)),r.fillRect(O[N]-1,G[N]-1,3,3),r.stroke()),r.strokeStyle=Ps,r.fillStyle=Ps,r.font="10pt Arial",r.textAlign="left",r.globalAlpha=.6,pa(),c.handles.drawHandles()}function pa(){if(c.routeData.x.length>1){r.beginPath(),r.moveTo(c.routeData.x[0],c.routeData.y[0]);for(let t=1;t<c.routeData.x.length;t+=1)r.lineTo(c.routeData.x[t],c.routeData.y[t]);r.stroke()}}function ya(){return{x:O,y:G}}function Tn(t){const e=c.routeData.splits;if(e.length===2)return t+1;for(let s=t+1;s<e.length;s+=1)if(e[s]!==e[s-1])return s;return e.length}function va(t){const e=c.routeData.splits;if(e.length===2)return t-1;for(let s=t-1;s>0;s-=1)if(e[s]!==e[s-1])return s;return 0}function ba(){return c.fileLoaded}function xa(t){t.ok?(V(g("Route deleted"),g("Route has been deleted")),xi({eventid:parseInt(t.eventid,10),id:parseInt(t.routeid,10)}),wn()):V(g("Delete failed"),g("Delete failed"))}const Ea=t=>e=>{e.ok?La(e,t):V(t,g("Your route was not saved. Please try again"))};function Sa(){if(ft.length===0)clearInterval(ht),ht=null,Ve=!0;else{const t=ft.shift();Lt(t.angle,t.x,t.y,!0,t.scale)}D()}function Ut(t){Tt=null,c.routeData=new Et,c.routeData.eventid=fe(),c.routeData.courseid=t;const e=J(t);Ee=e.isScoreCourse,Ee||(ze(t,!0),c.routeData.coursename=e.name,e.excludeType===u.EXCLUDED_ZERO_SPLITS?c.routeData.controlsToAdjust=e.exclude.indexOf(!0):c.routeData.controlsToAdjust=e.x.length-1,O=e.x.slice(),G=e.y.slice(),c.routeData.x.length=0,c.routeData.y.length=0,c.routeData.x[0]=O[0],c.routeData.y[0]=G[0],c.routeData.controlx=O.slice(),c.routeData.controly=G.slice(),c.routeData.cumulativeLegLengths=e.cumulativeLegLengths.slice(),ts=e.angle.slice()),document.getElementById("rg2-select-course").value=c.routeData.courseid,tn(t),D()}function kn(){c=new Qs,c.routeData=new Et,O.length=0,G.length=0,ts.length=0,N=0,ie=0,Ee=!1,c.initialiseGPS(),ea(),D()}function Ta(t,e,s){if(ke()===u.TAB_DRAW)if(c.fileLoaded){const i=c.handles.getHandleClicked({x:t,y:e});if(i!==void 0)s===u.RIGHT_CLICK&&i.index!==0&&i.index!==c.handles.length?i.locked?c.handles.unlockHandle(i.index):c.handles.deleteHandle(i.index):i.locked?c.handles.unlockHandle(i.index):c.handles.lockHandle(i.index);else for(let l=0;l<c.baseX.length;l+=1)if(c.baseX[l]+3>=t&&c.baseX[l]-3<=t&&c.baseY[l]+3>=e&&c.baseY[l]-3<=e){c.handles.addHandle(t,e,l);break}}else c.routeData.resultid!==null&&c.routeData.courseid!==null?ia(t,e):V("No course/name","Please select course, name and time before you start drawing a route or upload a file.")}function ka(t){Ze(),c.readGPS(t)}function Ia(){let t={};t.body="All information you have entered will be removed. Are you sure you want to reset?",t.title="Confirm reset",t.doText="Reset",t.onDo=ss,qt(t)}function wa(t,e,s){let n={};return n.x=Math.cos(s)*t-Math.sin(s)*e,n.y=Math.sin(s)*t+Math.cos(s)*e,n}function La(t,e){V(e,g("Your route has been saved")),Ei({eventid:parseInt(t.eventid,10),id:t.newid,token:t.token}),kt(fe())}function Da(){const t=c.routeData.time[c.routeData.time.length-1]-c.routeData.time[0];c.routeData.totaltime=P(t);const s=new Date().getTimezoneOffset()*60;c.routeData.startsecs=c.routeData.time[0]-s;for(let n=0;n<c.routeData.x.length;n+=1)c.routeData.x[n]=Math.round(c.routeData.x[n]),c.routeData.y[n]=Math.round(c.routeData.y[n]),c.routeData.time[n]-=c.routeData.startsecs;for(c.routeData.resultid+=u.GPS_RESULT_OFFSET;il(c.routeData.resultid);)c.routeData.resultid+=u.GPS_RESULT_OFFSET,c.routeData.name+="*";c.routeData.comments=document.getElementById("rg2-new-comments").value,document.getElementById("btn-undo-gps-adjust").setAttribute("disabled",""),Sn()}function Ca(){c.routeData.comments=document.getElementById("rg2-new-comments").value,c.routeData.controlx=O,c.routeData.controly=G,c.routeData.controlx.splice(0,1),c.routeData.controly.splice(0,1),Sn()}function Pe(t,e,s,n,i){const l=Y(e.x,e.y,s.x,s.y)/Y(t.x,t.y,s.x,s.y),a=ue(e.x,e.y,s.x,s.y)-ue(t.x,t.y,s.x,s.y);for(let o=n;o<=i;o+=1){const m=wa(c.baseX[o]-s.x,c.baseY[o]-s.y,a);c.routeData.x[o]=m.x*l+s.x,c.routeData.y[o]=m.y*l+s.y}c.handles.alignHandles(c.routeData)}function Aa(){for(let t=c.routeData.x.length-1;t>0;t-=1)c.routeData.x[t]=c.routeData.x[t]-c.routeData.x[t-1],c.routeData.y[t]=c.routeData.y[t]-c.routeData.y[t-1];for(let t=c.routeData.time.length-1;t>0;t-=1)c.routeData.time[t]=c.routeData.time[t]-c.routeData.time[t-1]}function Ma(t){isNaN(t)||(c.routeData.courseid!==null?c.routeData.x.length>1?(Tt=t,oa()):(c.routeData.resultid!==null&&He(c.routeData.resultid,!1),ze(c.routeData.courseid,!1),Ut(t)):Ut(t))}function Ra(t){if(!isNaN(t)){const e=ln(t);if(e.hasValidTrack){const s=g("If you draw a new route it will overwrite the old route for this runner.")+" "+g("GPS routes are saved separately and will not be overwritten.");V(g("Route already drawn"),s)}c.routeData.resultid!==null&&He(c.routeData.resultid,!1),c.routeData.resultid=e.resultid,c.routeData.name=e.name,c.routeData.splits=e.splits,Ee?(He(e.resultid,!0),O=e.scorex,G=e.scorey,c.routeData.x.length=0,c.routeData.y.length=0,c.routeData.x[0]=O[0],c.routeData.y[0]=G[0],c.routeData.controlx=O,c.routeData.controly=G,N=1,D()):(N=Tn(0),ie=0),In()}}function _s(){const t=document.getElementById("rg2-name-entry"),e=t.value.trim();e?t.classList.add("is-valid"):t.classList.remove("is-valid");const s=document.getElementById("rg2-time-entry");let n=s.value.trim();if(n.match(/\d+[:.][0-5]\d$/)?s.classList.add("is-valid"):(s.classList.remove("is-valid"),n=null),e&&n&&c.routeData.courseid!==null){n=n.replace(".",":"),c.routeData.name=e,c.routeData.resultid=0,c.routeData.totaltime=n,c.routeData.startsecs=0,c.routeData.time[0]=us(n),c.routeData.totalsecs=us(n),N=1;const i=c.routeData.cumulativeLegLengths[c.routeData.cumulativeLegLengths.length-1];let l=[];for(let a=0;a<c.routeData.cumulativeLegLengths.length;a=a+1)l[a]=parseInt(c.routeData.cumulativeLegLengths[a]/i*c.routeData.totalsecs,10);c.routeData.splits=l,ie=0,In()}}function Ba(){c.routeData.courseid!==null&&(Ee?He(c.routeData.resultid,!0):ze(c.routeData.courseid,!0))}function In(){document.getElementById("btn-three-seconds").removeAttribute("disabled"),document.getElementById("btn-reset-drawing").removeAttribute("disabled",""),document.getElementById("rg2-load-gps-file").removeAttribute("disabled"),En(0),D()}function Pa(){c.baseX=c.savedBaseX.slice(0),c.baseY=c.savedBaseY.slice(0),c.routeData.x=c.savedBaseX.slice(0),c.routeData.y=c.savedBaseY.slice(0),c.handles.undo(),document.getElementById("btn-undo-gps-adjust").setAttribute("disabled",""),D()}function _a(){if(Ve){const t=c.routeData.x.length;t>1&&(O[ie]===c.routeData.x[t-1]&&G[ie]===c.routeData.y[t-1]&&(N===O.length&&document.getElementById("btn-save-route").setAttribute("disabled",""),N=ie,ie=va(N)),c.routeData.x.pop(),c.routeData.y.pop()),c.routeData.x.length>1?document.getElementById("btn-undo").removeAttribute("disabled"):document.getElementById("btn-undo").setAttribute("disabled",""),D()}}function Na(){Gt(c.routeData.x[c.routeData.x.length-1],c.routeData.y[c.routeData.y.length-1]),D()}class Be{constructor(e){e.A===void 0?(this.valid=!1,this.A=0,this.B=0,this.C=0,this.D=0,this.E=0,this.F=0):(this.A=parseFloat(e.A),this.B=parseFloat(e.B),this.C=parseFloat(e.C),this.D=parseFloat(e.D),this.E=parseFloat(e.E),this.F=parseFloat(e.F),this.valid=!0,this.AEDB=e.A*e.E-e.D*e.B,this.xCorrection=e.B*e.F-e.E*e.C,this.yCorrection=e.D*e.C-e.A*e.F)}getLat(e,s){return this.D*e+this.E*s+this.F}getLon(e,s){return this.A*e+this.B*s+this.C}getX(e,s){return Math.round((this.E*e-this.B*s+this.xCorrection)/this.AEDB)}getY(e,s){return Math.round((-1*this.D*e+this.A*s+this.yCorrection)/this.AEDB)}}class Oa{constructor(e){switch(this.kartatid=e.id,this.mapid=e.mapid,this.format=e.format,this.name=e.name,this.date=e.date,this.club=e.club,this.rawtype=e.type,e.type){case"I":this.type="International event";break;case"N":this.type="National event";break;case"R":this.type="Regional event";break;case"L":this.type="Local event";break;case"T":this.type="Training event";break;default:this.type="Unknown";break}this.comment=e.comment,this.locked=e.locked,this.courses=0,e.suffix===void 0?this.mapfilename=this.mapid+".jpg":this.mapfilename=this.mapid+"."+e.suffix,this.worldfile=new Be(e)}}let A=[],B=null,Vt=!1;function $a(t){const e=document.querySelectorAll("#rg2-event-table tr");for(let n of e)parseInt(n.dataset.kartatid,10)===t?n.classList.add("table-success"):n.classList.remove("table-success");const s=document.getElementById("btn-splitsbrowser");rg2Config.enable_splitsbrowser&&ns()?s.removeAttribute("disabled"):s.setAttribute("disabled",""),document.getElementById("btn-toggle-controls").removeAttribute("disabled"),document.getElementById("btn-runners").removeAttribute("disabled"),document.getElementById("btn-measure").removeAttribute("disabled"),document.getElementById("btn-stats").removeAttribute("disabled")}function Fa(t){Rn(null),Xt({type:"event",id:t},za,"Event request failed")}function wn(){Xt({type:"events"},Ka,"Events request failed")}function Ln(){return B===null?!1:A[B].locked}function Ha(){let t="<table class='table table-striped table-hover table-sm'><tbody id='rg2-event-table'>";for(let e=A.length-1;e>=0;e-=1){let s=g(A[e].type,"")+": "+A[e].date;A[e].comment!==""&&(s+=": "+A[e].comment);let n="";A[e].comment!==""&&(n=`<i class='bi-info-circle' id='info-${e}'></i>`);let i="";A[e].worldfile.valid&&(i=`<i class='bi-globe' id='info-${e}'></i>`);let l="";A[e].locked&&(l=`<i class='bi-lock-fill' id='info-${e}'></i>`),t+=`<tr data-kartatid="${A[e].kartatid}"><td class="event-date">${A[e].date}</td><td title='${s}'>`,t+=`${A[e].name} ${l} ${i} ${n}</td ></tr >`}return t+="</tbody></table>",t}function Ga(){return B!==null?A[B].date:""}function Dn(){return B}function Ua(){if(B!==null)return A[B].kartatid}function Va(){return B!==null?A[B].name:"Routegadget 2"}function Ya(){return B!==null?A[B].mapid:null}function Wa(t){for(let e=0;e<A.length;e+=1)if(A[e].kartatid===t)return e}function ns(){return B!==null?A[B].format===u.FORMAT_NORMAL||A[B].format===u.FORMAT_SCORE_EVENT:!0}function Cn(t){t=t||fe();const e=Wa(t);let s=A[e];return s.id=e,s.controls=W.getControlCount(),s.exclude=cr(),s}function Xa(){if(B===null)return"";const t=fe(),e=Cn(parseInt(t,10));let s=`<div class='fs-4 fw-bolder pb-3'>${g("Event statistics")+": "+e.name+"&nbsp"+e.date}</div>
  <div class="d-flex flex-wrap justify-content-evenly pb-2">
  ${Ji(e)}
  </div>`;return e.comment&&(s+="<table class='table table-sm table-striped-columns table-bordered'><tbody>",s+=`<tr><td>${g("Comments")}</td><td>${e.comment}</td></tr>`,s+="</tbody></table>"),s+='<hr class="border border-primary opacity-75" />',s+=Wi(),s=s.replace(/&amp;/g,"&"),s}function fe(){return B===null?null:A[B].kartatid}function qa(){return B===null||!It()?"px":"m"}function ja(t){for(let e=0;e<A.length;e+=1)if(A[e].kartatid===t)return A[e].mapfilename;return""}function je(){if(B===null||!It())return;const t=Xe(),e=Y(0,0,t.width,t.height),s=A[B].worldfile,n=s.C,i=s.F,l=s.A*t.width+s.B*t.height+s.C,a=s.D*t.width+s.E*t.height+s.F;return Ot(i,n,a,l)/e}function An(){return B===null?null:A[B].worldfile}function za(t,e){if(Vt=!1,bt.getInstance(document.getElementById("rg2-right-info-panel")).hide(),Mi(e),Rn(e),Za(),document.getElementById("rg2-load-progress-label").innerHTML=g("Saving courses"),pr(t.courses),document.getElementById("rg2-load-progress-label").textContent=g("Saving results",""),al(t.results),document.getElementById("rg2-load-progress-label").textContent=g("Saving routes",""),rl(t.routes),tr(),Oi(),u.managing())rg2Config.manager.eventFinishedLoading(e);else{if(document.getElementById(u.TAB_COURSES).removeAttribute("disabled"),document.getElementById(u.TAB_RESULTS).removeAttribute("disabled"),Ln()?document.getElementById(u.TAB_DRAW).setAttribute("disabled",""):document.getElementById(u.TAB_DRAW).removeAttribute("disabled"),ke()!==u.TAB_DRAW){const l=Ci();document.getElementById(l).click()}const n=Di();for(let l=0;l<n.length;l+=1){let a=new Event("click",{bubbles:!0});const o=document.querySelector(`.showtrack[data-id='${n[l]}']`);o&&(o.checked=!0,o.dispatchEvent(a))}const i=wi();for(let l=0;l<i.length;l+=1){let a=new Event("click",{bubbles:!0});const o=document.querySelector(`.showcourse[data-courseid='${i[l]}']`);o&&(o.checked=!0,o.dispatchEvent(a))}}document.getElementById("rg2-load-progress").classList.add("d-none"),kn(),$a(e)}function Ka(t){A.length=0,B=null;for(const s of t.events)A.push(new Oa(s));jl();const e=Li();e&&kt(e),u.managing()&&rg2Config.manager.eventListLoaded(A)}function gt(){return B!==null?A[B].format===u.FORMAT_SCORE_EVENT||A[B].format===u.FORMAT_SCORE_EVENT_NO_RESULTS:!1}function Mn(t){for(let e=0;e<A.length;e+=1)if(A[e].kartatid===t)return!0;return!1}function kt(t){Vt||!Mn(t)||(Vt=!0,Br(),$i(),Pn(),Qr(rg2Config.maps_url+ja(t)),document.getElementById("rg2-load-progress-label").textContent=g("Loading event",""),document.getElementById("rg2-load-progress").classList.remove("d-none"),Fa(t),D())}function ho(t){for(let e=0;e<A.length;e+=1)if(A[e].mapid===t)return!0;return!1}function It(){return B===null?!1:A[B].worldfile.valid}function Rn(t){B=null;for(let e=0;e<A.length;e+=1)if(A[e].kartatid===t){B=e;break}}function Za(){let t="";t=Ga()+" "+rt(Va()),document.title=t,It()&&(t="<i class='bi-globe'>&nbsp;</i>"+t),Ln()&&(t="<i class='bi-lock-fill'>&nbsp;</i>"+t),document.getElementById("rg2-event-title").innerHTML=t}class Bn{constructor(e,s){this.name=e.name,this.trackcount=0,this.display=!1,this.courseid=e.courseid,this.codes=e.codes,this.setExcluded(e),this.filterTo=this.codes.length,this.filterFrom=0,this.x=e.xpos,this.y=e.ypos,this.isScoreCourse=s,this.resultcount=0,this.angle=[],this.textAngle=[],this.setAngles(),this.setLengths()}drawCourse(e){if(this.display){const s=Fe();if(r.globalAlpha=e,W.drawStart(this.x[0],this.y[0],"",this.angle[0],s),!this.isScoreCourse){const n={from:this.filterFrom,to:this.filterTo};this.drawLinesBetweenControls({x:this.x,y:this.y},this.angle,s,n)}if(this.isScoreCourse)for(let n=1;n<this.x.length;n+=1)this.codes[n].indexOf("F")===0||this.codes[n].indexOf("M")===0?W.drawFinish(this.x[n],this.y[n],"",s):W.drawSingleControl(this.x[n],this.y[n],this.codes[n],this.textAngle[n],s);else{const n=Math.max(this.filterFrom,1),i=Math.min(this.filterTo+1,this.x.length-1);for(let l=n;l<i;l+=1)W.drawSingleControl(this.x[l],this.y[l],l,this.textAngle[l],s);W.drawFinish(this.x[this.x.length-1],this.y[this.y.length-1],"",s)}}}drawLinesBetweenControls(e,s,n,i){let l;for(let a=i.from;a<i.to;a+=1){a===0?l=n.startTriangleLength:l=n.controlRadius;const o=e.x[a]+l*Math.cos(s[a]),m=e.y[a]+l*Math.sin(s[a]);a===this.x.length-2?l=n.finishOuterRadius:l=n.controlRadius;const y=e.x[a+1]-l*Math.cos(s[a]),h=e.y[a+1]-l*Math.sin(s[a]);r.beginPath(),r.moveTo(o,m),r.lineTo(y,h),r.stroke()}}incrementTracksCount(){this.trackcount+=1}setAngles(){for(let e=0;e<this.x.length-1;e+=1)if(this.isScoreCourse)this.angle[e]=Math.PI*1.5,this.textAngle[e]=Math.PI*.25;else if(this.angle[e]=ue(this.x[e],this.y[e],this.x[e+1],this.y[e+1]),e>0){const s=Math.sin(this.angle[e-1]),n=Math.cos(this.angle[e-1]),i=Math.sin(this.angle[e])+s,l=Math.cos(this.angle[e])+n,a=i/2,o=l/2;this.textAngle[e]=ue(a,o,s,n)}else this.textAngle[0]=0;this.angle[this.x.length-1]=Math.PI*1.5,this.textAngle[this.x.length-1]=Math.PI*1.5}setDisplay(e){this.display=e}setExcluded(e){this.excludeType=e.excludeType,this.exclude=e.codes.map((n,i)=>e.exclude.findIndex(l=>l===i)>-1);const s=this.exclude.findIndex(n=>n===!0);this.firstExcluded=s===-1?0:s,this.allowed=e.codes.map((n,i)=>e.exclude.findIndex(l=>l===i)>-1?e.allowed[e.exclude.findIndex(l=>l===i)]:0)}setLengths(){let e=0;this.lengthValid=!0,this.legLengths=[],this.cumulativeLegLengths=[],this.legLengths[0]=0,this.cumulativeLegLengths[0]=0;let s=je();s===void 0&&(this.lengthValid=!1,s=1);for(let n=1;n<this.x.length;n+=1){const i=parseInt((Y(this.x[n],this.y[n],this.x[n-1],this.y[n-1])*s).toFixed(0));this.legLengths[n]=i,this.cumulativeLegLengths[n]=this.cumulativeLegLengths[n-1]+i,e+=i}this.length=(e/1e3).toFixed(1)}}let x=[],W,mt=0,is=0,Yt=0;function Ja(t){x[t.courseid]=new Bn(t,gt()),is+=1,x[t.courseid].codes!==void 0&&x[t.courseid].codes.length>Yt&&(Yt=x[t.courseid].codes.length-1)}function Qa(){for(let t=0;t<x.length;t+=1)if(x[t]!==void 0&&!x[t].display)return!1;return!0}function er(){let t=document.getElementById("rg2-select-course");t.innerHTML="",t.options.add(xe(null,g("Select course","")));for(let e=0;e<x.length;e=e+1)x[e]!==void 0&&t.options.add(xe(e,rt(x[e].name)));t.addEventListener("change",e=>{Ma(parseInt(e.target.value,10))})}function tr(){const t=document.getElementById("rg2-course-table");t.innerHTML=ar();const e=document.getElementById("rg2-course-filter-table");e.innerHTML=lr(),document.querySelectorAll("[data-course-filter]").forEach(n=>{n.addEventListener("change",nr)})}function Pn(){x.length=0,mt=0,is=0,Yt=0}function Ns(t){for(let e=0;e<x.length;e+=1)x[e]!==void 0&&x[e].drawCourse(t)}function sr(t,e,s,n,i){x[s].drawLinesBetweenControls(t,e,n,i)}function nr(t){const e=parseInt(t.target.dataset.courseFilter,10);x[e].filterFrom=t.detail.value1,x[e].filterTo=t.detail.value2,D()}function ir(){let t={html:"",res:0,coursecount:0};for(let e=0;e<x.length;e+=1)x[e]!==void 0&&(t.coursecount=t.coursecount+1,t.html+=[`<tr><td>${x[e].name}</td >`,`<td><input class='showcourse' data-courseid=${e} type='checkbox' name='course'></input></td>`,`<td class='text-center'>${x[e].resultcount}</td><td class='text-center'>${x[e].trackcount}</td><td>`].join(""),t.res+=x[e].resultcount,x[e].trackcount>0?(t.html+=`<input data-courseid=${x[e].courseid} class='allcoursetracks' type=checkbox name=track></input></td>`,t.html+=`<td><input data-courseid=${x[e].courseid} class='allcoursetracksreplay' type=checkbox name=replay></input>`):t.html+="</td><td>",t.html+="</td></tr>");return t}function lr(){let t="";for(let e=0;e<x.length;e+=1)x[e]!==void 0&&!x[e].isScoreCourse&&x[e].codes.length>2&&(t+=[`<div id='course-filter-${x[e].courseid}' data-display="false" data-course="${x[e].courseid}" class="row">`,`<div class="col-3">${x[e].name}</div>`,'<div class="col-9 pt-2">',`  <tc-range-slider step="1" min="0" max="${x[e].codes.length}" value1="0"`,`value2="${x[e].codes.length}" round="0" data-course-filter="${x[e].courseid}>"`,"</tc-range-slider></div></div>"].join(""));return t}function ar(){let t=["<table class='table table-striped table-hover table-sm'><thead>",`<tr><th>${g("Course")}</th><th><i class='bi-eye-fill'></i></th><th>${g("Runners")}</th>`,`<th>${g("Routes")}</th><th><i class='bi-pencil'></i></th><th><i class='bi-play-fill'></i></th></tr>`,'</thead><tbody class="table-group-divider">'].join("");const e=ir();return t+=e.html+`</tbody><tfoot class="table-group-divider"><tr class='allitemsrow'><td>${g("All")}</td>
    <td><input class='showallcourses' data-id="all" type=checkbox name=course></input></td>
    <td class='text-center'>${e.res}</td><td class='text-center'>${mt}</td><td>`,mt>0&&(t+=`<input data-id="all" class='alltracks' type=checkbox name=track></input>`),t+="</td><td></td></tr></tfoot></table>",t}function _n(){return x}function J(t){return x[t]}function rr(t){return x.find(e=>e?e.name===t:!1)}function or(t){return x[t].name}function dr(){let t=[];for(let e=0;e<x.length;e+=1)if(x[e]!==void 0){let s={};s.id=x[e].courseid,s.name=x[e].name,s.results=x[e].resultcount,t.push(s)}return t}function Os(){let t=[];for(let e=0;e<x.length;e+=1)x[e]!==void 0&&x[e].display&&t.push(e);return t}function cr(){let t="";for(let e=0;e<x.length;e+=1)x[e]!==void 0&&x[e].excludeType!==u.EXCLUDED_NONE&&(t=t+x[e].courseid+"|"+x[e].excludeType,t=t+x[e].exclude.reduce((s,n,i)=>n?s+"|"+i+","+x[e].allowed[i]:s,""),t=t+`
`);return t}function ur(t){let e={};return e.filterFrom=x[t].filterFrom,e.filterTo=x[t].filterTo,e}function hr(t){return x[t].codes.length-2}function Nn(){return is}function fr(t){x[t].incrementTracksCount(),mt+=1}function gr(){W=new Ti}function mr(t){return t in x}function pr(t){Pn(),W.deleteAllControls();for(const e of t)Ja(e);W.generateControlList()}function On(t){for(let e=0;e<x.length;e+=1)x[e]!==void 0&&x[e].setDisplay(t)}function $s(){for(let t=0;t<x.length;t+=1)x[t]!==void 0&&_e(t)}function ze(t,e){x[t]!==void 0&&(x[t].setDisplay(e),_e(t))}function _e(t){t=parseInt(t,10);const e=x[t].display||_i(t);document.querySelectorAll("[data-display]").forEach(s=>{parseInt(s.dataset.course,10)===t&&(s.dataset.display=e)})}function yr(){for(let t=0;t<x.length;t+=1)x[t]!==void 0&&(x[t].resultcount=Ni(t))}function vr(t,e,s,n){for(let i=0;i<x.length;i+=1)if(x[i]!==void 0&&x[i].courseid===t){x[i].codes=e,x[i].x=s,x[i].y=n,x[i].setAngles();break}}function fo(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}let L=[],ne={};const _t=[100,200,500,1e3,2e3,3e3,5e3,7500,1e4,15e3,2e4,5e4,1e5],br=100,xr=50,Ae=20;let se=!1,$n="px",Ye=3e3,he=null,Se=null,pt=[],H=0,re=0,ae=!1,ve=0,de=0,We=60,Ne=0,_=0,Ie=!1,Oe=!1,be=!0,$e=0,ce=0,yt=null,j;const ls=`<i title=${g("Run","")} class="bi-play-circle-fill"></i>`,Fn=`<i title=${g("Start","")} class="bi-triangle"></i>`,Er=`<i title=${g("Pause","")} class="bi-pause-btn"></i>`,Hn=`<i title=${g("Wait","")} class="bi-hourglass-split"></i>`,Te=document.getElementById("rg2-track-names"),Fs=document.querySelector("#rg2-track-names .card-body"),Wt=document.getElementById("btn-runners"),ge=document.getElementById("btn-start-stop");document.querySelector("#rg2-track-names .card-title").innerHTML=g("Runners");document.getElementById("btn-close-track-names").addEventListener("click",()=>{Te.classList.add("d-none")});Wt.addEventListener("click",()=>{Te.classList.toggle("d-none")});const at=document.getElementById("rg2-replay-by-control");at.classList.add("d-none");let tt={x:0,y:0};ot(Te).draggable({inertia:!0,listeners:{move(t){tt.x+=t.dx,tt.y+=t.dy,t.target.style.transform=`translate(${tt.x}px, ${tt.y}px)`}},modifiers:[ot.modifiers.restrictRect({restriction:"#rg2-container"})]});function Gn(t,e=!0){for(let s=0;s<L.length;s+=1)if(L[s].resultid===t.resultid)return;L.length===0&&(ne=rr(t.coursename)),t.userColour!==null?t.trackColour=t.userColour:t.trackColour=Js(),L.push(t),e&&wt()}function Un(t){se=!1,pt=[];const e=ne.x[t],s=ne.y[t],n=ne.x[t+1],i=ne.y[t+1];if(ne.angle.length>=t){const l=ds(),a=Jn(),o=Y(e,s,n,i),m=Y(l.x,l.y,a.x,a.y);let y=Math.min(m/o,u.MAX_ZOOM);y=Math.max(y,u.MIN_ZOOM);let h=(r.displayAngle-ne.angle[t]-Math.PI/2)%(Math.PI*2);h<-1*Math.PI&&(h=h+2*Math.PI);for(let p=1;p<=Ae;p=p+1){let v={};v.x=l.x-(l.x-e)*p/Ae,v.y=l.y-(l.y-s)*p/Ae,v.angle=(r.displayAngle-h*p/Ae)%(Math.PI*2),v.scale=Math.pow(y,1/Ae),pt.push(v)}Se=setInterval(()=>{Ar()},xr)}else Lt(0,e,s,!0,1),Se=null,se=!0}function Hs(t,e){for(let s=0;s<t.length;s+=1)e?Gn(new jt(t[s]),!1):Xn(t[s]);wt()}function Vn(){ve=86400,de=0,ce=0;for(let t=0;t<L.length;t+=1)L[t].starttime<ve&&(ve=L[t].starttime),L[t].starttime+L[t].x.length>de&&(de=L[t].starttime+L[t].x.length),L[t].x.length>ce&&(ce=L[t].x.length)}function Sr(t){if(L.length===0)return;let e=!0;for(let s=0;s<L.length;s+=1)if(L[s].splits[_+1]-L[s].splits[_]>t){e=!1;break}e&&(_+=1,se=!1,as(_),rs())}function Tr(t){t!==H&&Ke(t)}function kr(){let t=document.getElementById("rg2-replay-speed-list"),e="";for(let s=0;s<_t.length;s=s+1)e+=`<li class="dropdown-item" data-speed="${_t[s]}">${"x"+_t[s]/100}</li>`;t.innerHTML=e,document.getElementById("rg2-replay-speed-select").addEventListener("hidden.bs.dropdown",s=>{s.clickEvent&&zn(parseInt(s.clickEvent.target.dataset.speed,10))})}function Ir(){let t=document.getElementById("rg2-replay-start-control-list");t.removeEventListener("hidden.bs.dropdown",Us);let e="";const n=L.reduce((i,l)=>Math.min(l.splits.length,i),9999);for(let i=0;i<n-1;i=i+1){const l=i===0?`<div>${Fn}</div>`:i;e+=`<li class="dropdown-item" data-control="${i}">${l}</li>`}t.innerHTML=e,document.getElementById("rg2-replay-start-control-select").addEventListener("hidden.bs.dropdown",Us)}function wr(){let t=document.getElementById("rg2-tails-length-list"),e="";const s=["0:00","0:30","1:00","1:30","2:00","3:00",g("Full tails","")],n=[0,30,60,90,120,180,"Full"];for(let i=0;i<s.length;i=i+1)e+=`<li class="dropdown-item" data-length="${n[i]}">${s[i]}</li>`;t.innerHTML=e,document.getElementById("rg2-tails-length-select").addEventListener("hidden.bs.dropdown",i=>{i.clickEvent&&$r(i.clickEvent.target.dataset.length)})}function Lr(){if(L.length===0)return;if(j){j.value!==H&&(j.value=H);const e=document.getElementById("rg2-clock");e.innerText=mi(H)}let t=0;for(let e=0;e<L.length;e+=1){const s=L[e];let n=0;if(ae?n=s.starttime:_===0||s.splits.length<_?n=0:n=-1*s.splits[_],r.strokeStyle=s.trackColour,r.globalAlpha=C.perCentRouteIntensity/100,r.lineWidth=C.routeWidth/Math.pow(r.displayScale,.5),r.lineJoin="round",r.beginPath(),!se&&!Se&&_>0){const i=s.splits[_];let l=Math.max(i-We,s.splits[_-1]);r.moveTo(s.x[l],s.y[l]);for(let a=l+1;a<=i;a+=1)r.lineTo(s.x[a],s.y[a])}else{r.moveTo(s.x[Ne-n],s.y[Ne-n]);for(let i=Ne;i<H;i+=1)i>n&&i-n<s.nextStopTime&&r.lineTo(s.x[i-n],s.y[i-n])}r.stroke(),r.beginPath(),t=H,t-n<s.nextStopTime?t=t-n:t=s.nextStopTime,r.arc(s.x[t],s.y[t],u.RUNNER_DOT_RADIUS/Math.pow(r.displayScale,.5),0,2*Math.PI,!1),r.globalAlpha=u.FULL_INTENSITY,r.strokeStyle=u.BLACK,r.fillStyle=s.trackColour,r.fill(),r.lineWidth=u.RUNNER_DOT_RADIUS/Math.pow(r.displayScale,.5)/4,r.stroke(),Dr(s,t)}Fr(t),Ie&&Sr(H)}function Dr(t,e){let s="";if((Oe||be)&&e<t.x.length&&e>=0){r.fillStyle=t.trackColour,r.strokeStyle="darkslategray",r.font=C.replayFontSize/Math.pow(r.displayScale,.8)+"pt Arial",r.globalAlpha=u.FULL_INTENSITY,r.textAlign="left",be?s=t.initials:s=t.name,r.save(),r.translate(t.x[e],t.y[e]),r.rotate(r.displayAngle),r.lineWidth=C.replayFontSize/Math.pow(r.displayScale,.8)/8;const n=2+8/Math.pow(r.displayScale,1),i=2+4/Math.pow(r.displayScale,1);r.strokeText(s,n,i),r.fillText(s,n,i),r.restore()}}function Gs(t,e){const s=L[t].cumulativeDistance;let n=e>s.length-1?s[s.length-1]:s[e];return n===void 0&&(n=0),n}function Yn(t){let e=[];for(let n=0;n<L.length;n+=1){let i={};i.trackColour=L[n].trackColour,i.course=L[n].coursename,i.name=L[n].name,i.resultid=L[n].resultid,i.rawid=L[n].rawid,ae?i.distance=Gs(n,H-L[n].starttime):i.distance=Gs(n,t),i.distance+=$n,e.push(i)}let s=zi();for(let n=0;n<s.length;n+=1)if(e.findIndex(i=>i.resultid===s[n].resultid)===-1){let i={};i.trackColour=s[n].trackColour,i.course=s[n].course,i.name=s[n].name,i.resultid=s[n].resultid,i.rawid=s[n].rawid,i.distance="",e.push(i)}return e}function Cr(t){if(t.length===0)return"";let e="",s="";for(let n=0;n<t.length;n+=1)s!==t[n].course&&(e+=`<div></div><div><strong>${t[n].course}</strong></div><div></div>`,s=t[n].course),e+=`<input type="color" class="form-control form-control-color" data-rawid="${t[n].rawid}"`,e+=` value = "${t[n].trackColour}" ><div>${t[n].name}</div><div class="runner-distance text-end"`,e+=` data-resultid="${t[n].resultid}">${t[n].distance}</div>`;return e}function Us(t){t.clickEvent&&(_=parseInt(t.clickEvent.target.dataset.control),isNaN(_)&&(_=0),se=!1,as(_),rs(),Un(_),ge.innerHTML=Hn)}function Ar(){if(pt.length===0)clearInterval(Se),Se=null,se=!0,ge.innerHTML=ls;else{const t=pt.shift();Lt(t.angle,t.x,t.y,!0,t.scale)}D()}function Mr(){ae?H<de&&(re=Math.min(re+Ye,de*1e3)):H<ce&&(re=Math.min(re+Ye,ce*1e3)),H=parseInt(re/1e3,10),Ne=Math.max(H-We,$e+1),D()}function Rr(){if(yt)return;yt=document.getElementById("rg2-animation-controls");const t=document.getElementById("rg2-clock");t.innerText="00:00:00",Wn(0,0,0),kr(),zn(Ye),ge.addEventListener("click",()=>{Gr()}),document.getElementById("btn-mass-start").addEventListener("click",()=>{at.classList.add("d-none"),_r()});const s=document.getElementById("btn-real-time");s.setAttribute("title",g("Real time","")),s.addEventListener("click",()=>{at.classList.add("d-none"),Nr()}),document.getElementById("btn-by-control").addEventListener("click",()=>{Pr(),Ir(),at.classList.remove("d-none")}),wr();let i=document.querySelectorAll("[data-toggle-names]");for(let l of i)l.innerHTML=g(l.dataset.toggleNames),l.addEventListener("click",a=>{Ur(a.currentTarget.dataset.toggleNames)});document.getElementById("rg2-toggle-names-value").setAttribute("title",g("Show names",""))}function Wn(t,e,s){if(j&&j.min===t&&j.max===e&&j.value===s)return;j&&j.remove();const n=document.getElementById("rg2-clock-slider-container"),i=document.createElement("tc-range-slider");i.setAttribute("id","rg2-clock-slider"),i.setAttribute("min",t),i.setAttribute("max",e),i.setAttribute("value",s),i.setAttribute("step",1),n.append(i),j=document.getElementById("rg2-clock-slider"),j.addEventListener("change",l=>{Tr(l.target.value)})}function Xn(t){for(let e=0;e<L.length;e+=1)L[e].resultid===t&&L.splice(e,1),L.length===0&&(ne={});wt()}function Br(){L.length=0,ne={},Ye=3e3,H=0,re=0,ae=!1,ve=0,de=0,We=60,Ne=0,_=0,Ie=!1,Oe=!1,be=!0,$e=0,ce=0,clearInterval(he),he=null,wt(),ge.innerHTML=ls,Te.classList.add("d-none")}function qn(){L.forEach(t=>t.nextStopTime=u.VERY_HIGH_TIME_IN_SECS)}function jn(t){return L.findIndex(e=>e.resultid===t)>-1}function Ke(t){$n=qa();let e=0;ae?(t>0?H=t:H=ve,e=de,$e=ve):(t>0?H=t:H=0,e=ce,$e=0),re=H*1e3,t===0&&Wn($e,e,H),D()}function as(t){document.getElementById("rg2-replay-start-control").innerHTML=t===0?Fn:t}function rs(){let t=9999;t=L.reduce((e,s)=>Math.min(s.splits.length,e),t),_>t&&(_=0);for(let e=0;e<L.length;e+=1)_+1<L[e].splits.length?L[e].nextStopTime=L[e].splits[_+1]:L[e].nextStopTime=u.VERY_HIGH_TIME_IN_SECS;Ke(0),Kn(),D()}function Pr(){document.getElementById("rg2-clock-slider").setAttribute("disabled",""),ae=!1,_=0,Ie=!0,se=!1,as(_),rs()}function _r(){ae=!1,Ie=!1,_=0,qn(),Ke(0),j.removeAttribute("disabled")}function Nr(){ae=!0,Ie=!1,_=0,qn(),Ke(0),j.removeAttribute("disabled")}function zn(t){isNaN(t)&&(t=1e3),Ye=t,document.getElementById("rg2-replay-speed").innerText="x"+t/100}function Or(t,e){for(let s=0;s<L.length;s+=1)L[s].rawid===t&&(L[s].userColour=e,L[s].trackColour=e);cl(t,e)}function $r(t){t==="Full"?We=u.VERY_HIGH_TIME_IN_SECS:We=parseInt(t,10),Vn(),D()}function Fr(t){const e=Yn(t);if(e.length===0)return;const s=document.querySelectorAll(".track-names .runner-distance");s&&s.forEach(n=>{const i=parseInt(n.dataset.resultid),l=e.findIndex(a=>a.resultid===i);l>-1&&(n.innerText=e[l].distance)})}function Hr(){he===null&&(he=setInterval(()=>{Mr()},br)),ge.innerHTML=Er}function Kn(){clearInterval(he),he=null,ge.innerHTML=ls}function Gr(){he===null?(Ie?!se&&Se===null&&(Un(_),ge.innerHTML=Hn):se=!0,se&&Hr()):Kn()}function Ur(t){switch(document.getElementById("rg2-toggle-names-value").setAttribute("title",g(t,"")),t){case"Show names":Oe=!0,be=!1;break;case"Show initials":Oe=!1,be=!0;break;default:Oe=!1,be=!1;break}D()}function wt(){Rr(),os(),L.length>0?(yt.classList.remove("d-none"),Wt.classList.remove("d-none")):(yt.classList.add("d-none"),Wt.classList.add("d-none")),es(),Vn(),Ke(0)}function os(){const t=Yn(H);return t.length>0?(Fs.innerHTML=Cr(t),document.querySelectorAll(".track-names input").forEach(s=>{s.addEventListener("input",n=>{Or(parseInt(n.target.dataset.rawid,10),n.target.value),D()})}),Te.classList.remove("d-none")):(Fs.innerHTML="",Te.classList.add("d-none")),t.length}class Vr{constructor(e){this.ctx=e,this.measuring=!1,this.dragging=!1,this.colours=["#ff00ff","#0000ff","#00ff00","#ff0000","#00ffff"],this.colourIndex=0,this.overlays=[],this.currentOverlay=this.initialiseOverlay(),this.units="px",this.metresPerPixel=1,this.dotSize=5,this.lineWidth=3,this.measureDialog=document.getElementById("rg2-measure-dialog"),document.getElementById("btn-measure").addEventListener("click",()=>{Dn()!==null&&(document.getElementById("rg2-map-canvas").style.cursor="crosshair",this.measureDialog.classList.remove("d-none"),this.measuring=!0,this.createMeasureDialog(),D())}),document.getElementById("btn-close-measure-dialog").addEventListener("click",()=>{this.measuring=!1,this.measureDialog.classList.add("d-none"),document.getElementById("rg2-map-canvas").style.cursor="auto",D()}),document.getElementById("btn-measure").addEventListener("click",()=>{document.getElementById("rg2-map-canvas").style.cursor="crosshair",this.measureDialog.classList.remove("d-none"),this.measuring=!0,this.createMeasureDialog(),D()});let s={x:0,y:0};ot(this.measureDialog).draggable({inertia:!0,listeners:{move(n){s.x+=n.dx,s.y+=n.dy,n.target.style.transform=`translate(${s.x}px, ${s.y}px)`}},modifiers:[ot.modifiers.restrictRect({restriction:"#rg2-container"})]}),this.createMeasureDialog()}calculateLength(e,s){if(e.length<2)return 0;let n=0;for(let i=1;i<e.length;i+=1)n=n+Y(e[i-1],s[i-1],e[i],s[i]);return n}closeEnough(e,s,n,i){return Math.abs(e-n)<10&&Math.abs(s-i)<10}createMeasureDialog(){this.metresPerPixel=je(),this.metresPerPixel===void 0?(this.metresPerPixel=1,this.units="px"):this.units="m";let e="";for(let l=0;l<this.overlays.length;l+=1)e=e+this.formatOverlay(this.overlays[l],!0);e=e+this.formatOverlay(this.currentOverlay,!1),this.overlays.length>1&&(e+=`<div>${g("All")}</div><div></div><div></div>`,e+="<div><i class='delete-all-overlays bi-trash'></i></div>"),document.querySelector(".rg2-overlay-table").innerHTML=e;let s=document.getElementsByClassName("delete-overlay");for(let l of s)l.addEventListener("click",a=>{this.deleteOverlay(parseInt(a.target.id,10))});let n=document.getElementsByClassName("delete-all-overlays");for(let l of n)l.addEventListener("click",a=>{this.deleteAllOverlays(parseInt(a.target.id,10))});let i=document.getElementsByClassName("end-overlay");for(let l of i)l.addEventListener("click",a=>{this.endOverlay(parseInt(a.target.id,10))})}deleteAllOverlays(){this.overlays.length=0,this.currentOverlay=this.initialiseOverlay(),this.updateOverlays(),this.createMeasureDialog(),D()}deleteOverlay(e){this.overlays.splice(e,1),this.updateOverlays(),this.createMeasureDialog(),D()}dragEnded(){this.dragging=!1}drawSingleOverlay(e,s){this.ctx.strokeStyle=e.colour,this.ctx.fillStyle=e.colour,this.ctx.beginPath(),this.ctx.moveTo(e.x[0],e.y[0]);for(let n=1;n<e.x.length;n+=1)this.ctx.lineTo(e.x[n],e.y[n]);this.ctx.stroke();for(let n=0;n<e.x.length;n+=1)this.ctx.beginPath(),this.ctx.arc(e.x[n],e.y[n],this.dotSize,0,2*Math.PI,!1),s?this.ctx.fill():this.ctx.stroke()}drawOverlays(){if(this.measuring){if(this.ctx.lineWidth=this.lineWidth,this.ctx.globalAlpha=.6,this.overlays.length>0)for(let e=0;e<this.overlays.length;e+=1)this.drawSingleOverlay(this.overlays[e],!0);this.currentOverlay.started&&(this.currentOverlay.x.length===1?(this.ctx.strokeStyle=this.currentOverlay.colour,this.ctx.fillStyle=this.currentOverlay.colour,this.ctx.beginPath(),this.ctx.arc(this.currentOverlay.x[0],this.currentOverlay.y[0],this.dotSize,0,2*Math.PI,!1),this.ctx.stroke()):this.drawSingleOverlay(this.currentOverlay,!1))}}endOverlay(){this.currentOverlay.idx=this.overlays.length,this.overlays.push(this.currentOverlay),this.currentOverlay=this.initialiseOverlay(),this.createMeasureDialog()}formatOverlay(e,s){let n="",i="",l="";return e.started?l=`<div>${parseInt(e.length,10)}${this.units}</div>`:l="<div></div>",s?i=`<div><i class='delete-overlay bi-trash' id="${e.idx}"></i></div>`:e.started?i=`<div><i class='end-overlay bi-save' id="${e.idx}"></i></div>`:i="<div></div>",n+=`<div>${e.id}</div><div class='overlay-bar' style='--overlay-colour:${e.colour};'></div>`,n+=`${l}${i}`,n}getNextColour(){return this.colourIndex=(this.colourIndex+1)%this.colours.length,this.colours[this.colourIndex]}initialiseOverlay(){const e={};return e.id=String.fromCharCode(this.overlays.length+65),e.colour=this.getNextColour(),e.x=[],e.y=[],e.length=0,e.started=!1,e.idx=void 0,e}mouseDrag(e,s){if(!this.measuring)return!1;if(!this.dragging)for(let n=0;n<this.overlays.length;n+=1)for(let i=0;i<this.overlays[n].x.length;i+=1)this.closeEnough(e.x,e.y,this.overlays[n].x[i],this.overlays[n].y[i])&&(this.dragging=!0,this.dragOverlay=n,this.dragPoint=i);return this.dragging?(this.overlays[this.dragOverlay].x[this.dragPoint]=parseInt(s.x,10),this.overlays[this.dragOverlay].y[this.dragPoint]=parseInt(s.y,10),this.overlays[this.dragOverlay].length=this.calculateLength(this.overlays[this.dragOverlay].x,this.overlays[this.dragOverlay].y)*this.metresPerPixel,this.createMeasureDialog(),!0):!1}mouseUp(e,s){this.measuring&&(this.dragging=!1,this.currentOverlay.started||this.startOverlay(),e===this.currentOverlay.x[this.currentOverlay.x.length-1]&&s===this.currentOverlay.y[this.currentOverlay.x.length-1]?this.endOverlay():(this.currentOverlay.x.push(e),this.currentOverlay.y.push(s),this.currentOverlay.length=this.calculateLength(this.currentOverlay.x,this.currentOverlay.y)*this.metresPerPixel,this.createMeasureDialog(),D()))}startOverlay(){this.currentOverlay.started=!0,this.createMeasureDialog()}updateOverlays(){this.colourIndex=0;for(let e=0;e<this.overlays.length;e+=1)this.overlays[e].id=String.fromCharCode(e+65),this.overlays[e].idx=e,this.overlays[e].colour=this.getNextColour();this.currentOverlay.id=String.fromCharCode(this.overlays.length+65),this.currentOverlay.idx=this.overlays.length,this.currentOverlay.colour=this.getNextColour()}}let $=document.getElementById("rg2-map-canvas"),r=$.getContext("2d");r.displayAngle=0;r.displayScale=1;let q=new Image,vt=new Vr(r),S={dragStart:null,dragged:!0,scaleFactor:1.1,pinched:!1},Nt;document.getElementById("rg2-load-progress").classList.add("d-none");document.getElementById("rg2-map-load-progress").classList.add("d-none");function Yr(){$.addEventListener("touchstart",Zr,!1),$.addEventListener("touchmove",Kr,!1),$.addEventListener("touchend",zr,!1),$.addEventListener("DOMMouseScroll",Vs,!1),$.addEventListener("wheel",Vs,!1),$.addEventListener("mousedown",Xr,!1),$.addEventListener("mousemove",qr,!1),$.addEventListener("mouseup",jr,!1),q.addEventListener("load",()=>eo());let t=document.getElementById("btn-zoom-in");t.addEventListener("click",()=>qe(1)),t=document.getElementById("btn-zoom-out"),t.addEventListener("click",()=>qe(-1)),t=document.getElementById("btn-rotate-left"),t.addEventListener("click",()=>Ys(-1)),t=document.getElementById("btn-rotate-right"),t.addEventListener("click",()=>Ys(1)),t=document.getElementById("btn-reset"),t.addEventListener("click",()=>Ze())}function Lt(t,e,s,n=!0,i=1){Zn((r.displayAngle-t)%(Math.PI*2),e,s,n,i)}function Zn(t,e,s,n,i){if(r.displayAngle=(r.displayAngle-t)%(Math.PI*2),r.translate(e,s),r.rotate(t),i!==1&&(r.scale(i,i),r.displayScale=r.displayScale*i),n){const l=ds();r.translate(l.x-e,l.y-s)}else r.translate(-1*e,-1*s);D()}function Wr(){if(!u.managing()&&window.innerWidth>=u.BIG_SCREEN_BREAK_POINT){r.font="16pt Arial",r.textAlign="center",r.fillStyle=u.BLACK;const t=r.transformedPoint($.width/2,$.height/2);r.fillText("Routegadget 2 Version "+u.RG2VERSION,t.x,t.y)}}function ds(){const t=document.getElementById("rg2-animation-controls").offsetHeight;return r.transformedPoint($.width/2,($.height-t)*.85)}function Jn(){const t=document.getElementById("rg2-animation-controls").offsetHeight;return r.transformedPoint($.width/2,($.height-t)*.15)}function Xe(){return{height:q.height,width:q.width}}function Qn(t){S.dragStart=r.transformedPoint(S.lastX,S.lastY),S.dragged=!1,S.whichButton=t.which}function ei(){if(S.dragStart){const t=r.transformedPoint(S.lastX,S.lastY);t.x=Math.round(t.x),t.y=Math.round(t.y);const e={x:Math.round(S.dragStart.x),y:Math.round(S.dragStart.y)},s=S.whichButton;Math.abs(t.x-e.x)+Math.abs(t.y-e.y)>5&&(ba()?xn(e,t,s):ke()===u.TAB_CREATE?rg2Config.manager.adjustManagerControls(e,t,s):vt.mouseDrag(e,t)||r.translate(t.x-S.dragStart.x,t.y-S.dragStart.y),S.dragged=!0,D())}}function ti(t){const e=ke();if(S.dragged)e===u.TAB_CREATE?rg2Config.manager.managerDragEnded():e===u.TAB_DRAW?fa():vt.dragEnded();else if(e===u.TAB_CREATE){const s=Math.round(S.dragStart.x),n=Math.round(S.dragStart.y);rg2Config.manager.managerMouseUp(s,n)}else e===u.TAB_DRAW?Ta(Math.round(S.dragStart.x),Math.round(S.dragStart.y),t.which):vt.mouseUp(Math.round(S.dragStart.x),Math.round(S.dragStart.y));S.dragStart=null,D()}function Xr(t){return ni(t),Qn(t),t.stopPropagation(),t.preventDefault()}function qr(t){return ni(t),ei(),t.stopPropagation(),t.preventDefault()}function jr(t){return ti(t),t.stopPropagation(),t.preventDefault()}function Vs(t){const e=t.wheelDelta?t.wheelDelta/40:t.detail?-t.detail:0;return e&&qe(e),t.stopPropagation(),t.preventDefault()}function zr(t){ti(t),S.pinched=!1}function Kr(t){if(t.touches.length>1?S.pinched||ii(t):S.pinched=!1,S.pinched&&t.touches.length>1){S.pinchEnd0=r.transformedPoint(t.touches[0].pageX,t.touches[0].pageY),S.pinchEnd1=r.transformedPoint(t.touches[1].pageX,t.touches[1].pageY);const e=Y(S.pinchStart0.x,S.pinchStart0.y,S.pinchStart1.x,S.pinchStart1.y),s=Y(S.pinchEnd0.x,S.pinchEnd0.y,S.pinchEnd1.x,S.pinchEnd1.y);e/s>1.1?(qe(-1),S.pinchStart0=S.pinchEnd0,S.pinchStart1=S.pinchEnd1):e/s<.9&&(qe(1),S.pinchStart0=S.pinchEnd0,S.pinchStart1=S.pinchEnd1)}else S.lastX=t.touches[0].pageX,S.lastY=t.touches[0].pageY,ei()}function Zr(t){t.preventDefault(),t.touches.length>1&&ii(t),S.lastX=t.touches[0].pageX,S.lastY=t.touches[0].pageY,Qn(t)}function Jr(){Yr(),so(r),si()}function Qr(t,e=!1){document.getElementById("rg2-map-load-progress-label").textContent=g("Loading map",""),document.getElementById("rg2-map-load-progress").classList.remove("d-none"),q.onerror=()=>{document.getElementById("rg2-map-load-progress").classList.add("d-none"),V("Map load error","The map for this event could not be loaded.")},q.src=e?t:t+"?"+Date.now()}function eo(){document.getElementById("rg2-map-load-progress").classList.add("d-none"),Ze(),u.managing()&&rg2Config.manager.managerMapLoadCallback()}function D(){Nt===void 0&&(Nt=setTimeout(()=>{Nt=void 0,to()},50))}function to(){if(r.save(),r.setTransform(1,0,0,1,0,0),r.globalAlpha=u.FULL_INTENSITY,r.fillStyle=u.GREY,r.fillRect(0,0,r.canvas.width,r.canvas.height),r.restore(),q.height>0){r.fillStyle=u.WHITE,r.globalAlpha=u.FULL_INTENSITY,r.fillRect(0,0,q.width,q.height),r.globalAlpha=C.perCentMapIntensity/100,r.drawImage(q,0,0);const t=ke();t===u.TAB_DRAW?(Ns(u.DIM),W.drawControls(!1),xs(),ma()):t===u.TAB_CREATE?rg2Config.manager.drawManagerControls():(Ns(u.DIM),xs(),vt.drawOverlays(),W.drawControls(!1),Lr())}else Wr()}function Ze(){let t=1;const e=$.height/q.height;S.lastX=$.width/2,S.lastY=$.height/2,S.zoomSize=1,S.dragStart=null,S.dragged=!0,e<1&&(t=e),window.innerWidth>=u.BIG_SCREEN_BREAK_POINT?r.setTransform(t,0,0,t,document.getElementById("rg2-left-info-panel").offsetWidth+80,0):r.setTransform(t,0,0,t,0,0),r.displayAngle=0,r.displayScale=t,D()}function si(){S.scaleFactor=u.DEFAULT_SCALE_FACTOR;const t=document.getElementById("rg2-header-container").offsetHeight;document.getElementById("rg2-container").style.height=window.innerHeight-t+"px",$.width=window.innerWidth,$.height=window.innerHeight-t,Ze()}function Ys(t){const e=t*(Math.PI/36);r.translate(q.width/2,q.height/2),Zn(e,0,0,!1,1),r.translate(-q.width/2,-q.height/2)}function ni(t){S.lastX=t.pageX-$.offsetParent.offsetLeft,S.lastY=t.pageY-$.offsetParent.offsetTop}function ii(t){S.pinchStart0=r.transformedPoint(t.touches[0].pageX,t.touches[0].pageY),S.pinchStart1=r.transformedPoint(t.touches[1].pageX,t.touches[1].pageY),S.pinched=!0}function so(t){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");let s=e.createSVGMatrix(),n=[],i=t.save;t.save=function(){return n.push(s.translate(0,0)),i.call(t)};let l=t.restore;t.restore=function(){return s=n.pop(),l.call(t)};let a=t.scale;t.scale=function(p,v){return s=s.scale(p,v),a.call(t,p,v)};let o=t.translate;t.translate=function(p,v){return s=s.translate(p,v),o.call(t,p,v)};let m=t.setTransform;t.setTransform=function(p,v,w,E,k,b){return s.a=p,s.b=v,s.c=w,s.d=E,s.e=k,s.f=b,m.call(t,p,v,w,E,k,b)};let y=e.createSVGPoint();t.transformedPoint=function(p,v){return y.x=p,y.y=v,y.matrixTransform(s.inverse())};let h=t.rotate;t.rotate=function(p){return s=s.rotate(p*180/Math.PI),h.call(t,p)}}function qe(t){if(!u.managing()&&Dn()===null)return;const e=Math.pow(S.scaleFactor,t),s=S.zoomSize*e;if(s<u.MAX_ZOOM&&s>u.MIN_ZOOM){S.zoomSize=s;const n=r.transformedPoint(S.lastX,S.lastY);r.translate(n.x,n.y),r.scale(e,e),r.displayScale=r.displayScale*e,r.translate(-n.x,-n.y),D()}}window.assetUrl=function(t){return rg2Config.asset_url+t};document.readyState!=="loading"?Ws():document.addEventListener("DOMContentLoaded",Ws);function Ws(){const t=document.querySelector(".rg2-startup");t.style.opacity=0,t.style.backgroundColor=u.GREY,document.querySelector(".rg2-startup-content").classList.add("startup-transform"),t.addEventListener("transitionend",()=>{document.getElementById("rg2-header-container").classList.remove("d-none"),t.remove(),gr(),bi(),ql(),fi(),u.managing()?st(()=>import("./manager-BFTRVDTy.js"),__vite__mapDeps([0,1,2,3]),import.meta.url).then(e=>{rg2Config.manager=e,rg2Config.manager.initialiseManager(),Xs()}).catch(()=>{console.log("Error loading manager"),V("Error loading manager","Manager functionality failed to  load.")}):Xs()},{once:!0})}function Xs(){Jr(),window.onpopstate=no,window.location.hash&&!u.managing()&&en(window.location.hash),document.getElementById("rg2-event-title").innerHTML="Routegadget 2",wn()}function no(){if(window.location.hash!==""&&!u.managing()){const t=en(window.location.hash);Mn(t)&&Ua()!==t&&kt(t)}}class go{constructor(){if(this.georefsystems=[],this.georefsystems.push({name:"Not georeferenced",description:"none",params:"",value:0}),this.georefsystems.push({name:"GB National Grid",description:"EPSG:27700",params:"+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs",value:1}),this.georefsystems.push({name:"Google EPSG:900913",description:"EPSG:900913",params:"+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs",value:2}),rg2Config.epsg_code!==void 0){const e=rg2Config.epsg_code.split("|"),s=rg2Config.epsg_params.split("|");for(let n=0;n<e.length;n=n+1)this.georefsystems.push({name:e[n].replace(" ",""),description:e[n].replace(" ",""),params:s[n],value:n+3});this.defaultGeorefVal=3}else this.defaultGeorefVal=1}getDefaultValue(){return this.georefsystems[this.defaultGeorefVal].value}getGeorefDropdown(){let e="";for(let s=0;s<this.georefsystems.length;s+=1)e+=pi(s,this.georefsystems[s].name,s===0);return e}getGeorefSystem(e){return this.georefsystems[e]}}class mo{constructor(e){e!==void 0?(this.mapid=e.mapid,this.name=e.name,this.worldfile=new Be(e),this.localworldfile=new Be({A:e.localA,B:e.localB,C:e.localC,D:e.localD,E:e.localE,F:e.localF}),e.mapfilename===void 0?this.mapfilename=this.mapid+".jpg":this.mapfilename=e.mapfilename):(this.mapid=0,this.name="",this.worldfile=new Be(0),this.localworldfile=new Be(0)),this.xpx=[],this.ypx=[],this.lat=[],this.lon=[]}}class po{constructor(){this.x="",this.name=null,this.password=null}setDetails(e,s){const n=/...../;this.name=document.getElementById(e).value;const i=n.test(this.name);this.password=document.getElementById(s).value;const l=n.test(this.password);return i&&l}alterString(e){const s="abcdefghijklmnopqrstuvwxyz0123456789";let n="";for(let i=0;i<e.length;i+=1){const l=Math.floor(Math.random()*s.length);n+=e.charAt(i)+s.charAt(l)}return n}encodeUser(){return{x:this.alterString(this.name+this.password),user:this.name}}}export{fo as A,Ti as C,go as G,mo as M,po as U,Be as W,us as a,oo as b,u as c,r as d,ao as e,P as f,ro as g,Xt as h,Cn as i,gt as j,Xe as k,Qr as l,kt as m,uo as n,pi as o,ho as p,js as q,D as r,V as s,qt as t,g as u,co as v,Fe as w,wn as x,Rn as y,Za as z};
//# sourceMappingURL=main-Cw0jfsJD.js.map
