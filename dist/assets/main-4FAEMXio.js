const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=[window.assetUrl("assets/manager-BMrk1T3L.js"),window.assetUrl("assets/node-modules-DcNSr3-7.js"),window.assetUrl("assets/manager-utils-LTpwnKd6.js"),window.assetUrl("assets/manager-utils-CIGW-MKW.css")])))=>i.map(i=>d[i]);
import{a as oi,T as di,M as ci,d as at,O as bt,i as ot}from"./node-modules-DcNSr3-7.js";import"./main-4FAEMXio.js";const ui="modulepreload",hi=function(t,e){return new URL(t,e).href},us={},st=function(e,s,n){let i=Promise.resolve();if(s&&s.length>0){let r=function(u){return Promise.all(u.map(p=>Promise.resolve(p).then(v=>({status:"fulfilled",value:v}),v=>({status:"rejected",reason:v}))))};const o=document.getElementsByTagName("link"),m=document.querySelector("meta[property=csp-nonce]"),y=(m==null?void 0:m.nonce)||(m==null?void 0:m.getAttribute("nonce"));i=r(s.map(u=>{if(u=hi(u,n),u in us)return;us[u]=!0;const p=u.endsWith(".css"),v=p?'[rel="stylesheet"]':"";if(!!n)for(let T=o.length-1;T>=0;T--){const x=o[T];if(x.href===u&&(!p||x.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${u}"]${v}`))return;const E=document.createElement("link");if(E.rel=p?"stylesheet":ui,p||(E.as="script"),E.crossOrigin="",E.href=u,y&&E.setAttribute("nonce",y),document.head.appendChild(E),p)return new Promise((T,x)=>{E.addEventListener("load",T),E.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${u}`)))})}))}function l(r){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=r,window.dispatchEvent(o),!o.defaultPrevented)throw r}return i.then(r=>{for(const o of r||[])o.status==="rejected"&&l(o.reason);return e().catch(l)})},Ks=oi.create({baseURL:rg2Config.api_url});function qt(t,e,s){t.t=new Date().getTime(),document.getElementById("rg2-container").style.cursor="wait",Ks({method:"get",url:"",params:t}).then(n=>{e(n.data.data,t.id)}).catch(function(n){Js(s+": "+n)}).finally(function(){document.getElementById("rg2-container").style.cursor="auto"})}function Zs(t,e,s,n){let i={method:"post"};i.data=t,e.headers&&(i.headers=e.headers,delete e.headers),e.t=new Date().getTime(),i.params=e,document.getElementById("rg2-container").style.cursor="wait",Ks(i).then(l=>{s(l.data)}).catch(function(l){Js(n+": "+l)}).finally(function(){document.getElementById("rg2-container").style.cursor="auto"})}function Js(t){document.getElementById("rg2-load-progress").classList.add("d-none"),document.getElementById("rg2-map-load-progress").classList.add("d-none"),V("Configuration error",t)}let le={};le.code="en";let nt=[];function fi(t){let e=document.getElementById("rg2-select-language");e.innerHTML="";let s=le.code==="en";e.options.add(xe("en","en: English",s));for(let n=0;n<t.length;n=n+1)s=le.code===t[n].code,e.options.add(xe(t[n].code,t[n].code+": "+t[n].language,s));e.addEventListener("change",n=>{const i=n.target.value;i!==le.code&&(i==="en"?en("en"):Qs(i))})}function Qs(t){qt({type:"lang",lang:t},mi,"Language request failed")}function gi(t){const e=nt.indexOf(t);return e>-1?e:(nt.push(t),nt.length-1)}function mi(t){en(t.lang)}function pi(){rg2Config.start_language!=="en"&&Qs(rg2Config.start_language)}function en(t){t==="en"?le={code:"en"}:le=t,yi()}function h(t,e="span"){const s=gi(t);return le.hasOwnProperty(t)&&(t=le[t]),e===""?t:`<${e} data-rg2t='${s}'>${t}</${e}>`}function yi(){const t=document.querySelectorAll("[data-rg2t]");for(let e of t){const s=parseInt(e.dataset.rg2t,10);e.innerText=h(nt[s],"")}}function co(t,e,s){return t.length>0?t[0].getAttribute(e).trim():s}function P(t){const e=Math.floor(t/60);let s=e;const n=t-e*60;return n<10?s+=":0"+n:s+=":"+n,s}function vi(t){let e;const s=Math.floor(t/3600);s<10?e="0"+s+":":e=s+":",t=t-s*3600;const n=Math.floor(t/60);return n<10?e+="0"+n:e+=n,t=t-n*60,t<10?e+=":0"+t:e+=":"+t,e}function xe(t,e,s=!1){let n=document.createElement("option");return n.value=t,n.text=e,s&&(n.selected=!0),n}function bi(t,e,s=!1){return`<option value="${t}"${s?" selected":""}>${e}</option>`}function ue(t,e,s,n){let i=Math.atan2(n-e,s-t);return i<0&&(i=i+2*Math.PI),i}function Y(t,e,s,n){return Math.sqrt(Math.pow(t-s,2)+Math.pow(e-n,2))}function $t(t,e,s,n){const i=(s-t).toRad(),l=(n-e).toRad(),r=Math.sin(i/2)*Math.sin(i/2)+Math.cos(t.toRad())*Math.cos(s.toRad())*Math.sin(l/2)*Math.sin(l/2);return 6371009*2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r))}function uo(t){if(!t)return 0;let e=0;const s=t.split(":");return e=parseInt(s[0],10)*3600+parseInt(s[1],10)*60,isNaN(e)?0:e}function hs(t){if(!t)return 0;let e=0,s=t.replace(/\./g,":").split(":");return s.length===2?e=parseInt(s[0],10)*60+parseInt(s[1],10):s.length===3&&(e=parseInt(s[0],10)*3600+parseInt(s[1],10)*60+parseInt(s[2],10)),isNaN(e)?0:e}const V=(t,e)=>{Ei(t,e)},xi=document.getElementById("rg2-toast-container"),Ei=(t,e)=>{const s=document.createElement("div");s.classList.add("toast"),s.setAttribute("data-bs-autohide","false"),s.innerHTML=`<div class="toast-header">
      <strong class="me-auto">${t}</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">
      ${e}
    </div>`,xi.appendChild(s),[...document.querySelectorAll(".toast")].map(i=>{const l=new di(i,{});i.addEventListener("hidden.bs.toast",()=>{i.parentNode&&i.parentNode.removeChild(i)}),l.show()})};function ho(t,e){return t.length>0?t[0].textContent.trim():e}let De;function jt(t,e=!0){De&&De.dispose();const s=document.getElementById("rg2-modal-container");s.innerHTML="";const n=e?`<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${h("Cancel")}</button>`:"",i=`<div class="modal fade" id="rg2-modal-dialog" data-bs-backdrop="static" data-bs-keyboard="false"
    tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="staticBackdropLabel">${t.title}</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          ${t.body}
        </div>
        <div class="modal-footer">
          <button id="rg2-do-modal-action" type="button" class="btn btn-primary">${h(t.doText)}</button>
          ${n}
        </div>
      </div>
    </div>
    </div > `;s.innerHTML=i,typeof t.onCancel!="function"&&(t.onCancel=()=>{});let l=!1;const r=document.getElementById("rg2-modal-dialog");document.getElementById("rg2-do-modal-action").addEventListener("click",()=>{l=!0,De.hide()});const o={keyboard:!0};De=new ci(r,o),r.addEventListener("hidden.bs.modal",()=>{l?t.onDo():t.onCancel()}),De.show()}function fo(t,e){const s=document.getElementById(t),n=e(s.value);return n?(s.classList.add("is-valid"),s.classList.remove("is-invalid")):(s.classList.add("is-invalid"),s.classList.remove("is-valid")),n}Number.prototype.toRad=function(){return this*Math.PI/180};const fs=["#ff0000","#00ff00","#0000ff","#800000","#008000","#000080","#ffff00","#ff00ff","#00ffff","#808000","#800080","#008080"];let Dt=0;function tn(){return Dt=(Dt+1)%fs.length,fs[Dt]}const f={RG2VERSION:"2.2.1",DEFAULT_SCALE_FACTOR:1.1,TAB_EVENTS:"event-tab",TAB_COURSES:"course-tab",TAB_RESULTS:"result-tab",TAB_DRAW:"draw-tab",TAB_LOGIN:"manage-login-tab",TAB_CREATE:"manage-create-tab",TAB_EDIT:"manage-edit-tab",TAB_MAP:"manage-map-tab",TAB_DELETE_MAP:"manage-delete-map-tab",INVALID_MAP_ID:9999,DEFAULT_NEW_COMMENT:"Type your comment",GPS_RESULT_OFFSET:5e4,MASS_START_REPLAY:1,REAL_TIME_REPLAY:2,MASS_START_BY_CONTROL:99999,VERY_HIGH_TIME_IN_SECS:99999,BIG_SCREEN_BREAK_POINT:800,SMALL_SCREEN_BREAK_POINT:500,MAX_ZOOM:50,MIN_ZOOM:.05,PURPLE:"#b300ff",RED:"#ff0000",GREEN:"#00ff00",BLUE:"#0000ff",DARK_GREEN:"rgb(34, 139, 34)",DARK_GREEN_30:"rgba(34, 139, 34, 0.3)",GREY:"#e0e0e0",RED_30:"rgba(255,0,0,0.3)",GREEN_30:"rgba(0,255,0,0.3)",BLUE_30:"rgba(0,0,255,0.3)",PURPLE_30:"rgba(180,0,255,0.3)",WHITE:"#ffffff",BLACK:"#000000",RUNNER_DOT_RADIUS:6,HANDLE_DOT_RADIUS:7,HANDLE_COLOUR:"#ff0000",DIM:.75,FULL_INTENSITY:1,TIME_NOT_FOUND:9999,RIGHT_CLICK:3,DO_NOT_SAVE_COURSE:9999,FORMAT_NORMAL:1,FORMAT_NORMAL_NO_RESULTS:2,FORMAT_SCORE_EVENT:3,FORMAT_SCORE_EVENT_NO_RESULTS:4,DISPLAY_ALL_COURSES:99999,EXCLUDED_NONE:0,EXCLUDED_ZERO_SPLITS:1,EXCLUDED_REAL_SPLITS:2,MAX_DRAWN_ROUTES:10,languages:[{language:"Čeština",code:"cz"},{language:"Deutsch",code:"de"},{language:"Suomi",code:"fi"},{language:"Français",code:"fr"},{language:"Italiano",code:"it"},{language:"日本語",code:"ja"},{language:"Norsk",code:"no"},{language:"Português - Brasil",code:"pt"},{language:"Русский",code:"ru"}],FILE_SIZE_WARNING:2,PIXEL_SIZE_WARNING:4e3,CLASS_NOW_ON:1,CLASS_NOW_OFF:0,managing:()=>rg2Config.managing!==void 0},C={perCentMapIntensity:100,perCentRouteIntensity:100,replayFontSize:12,courseWidth:3,routeWidth:4,circleSize:20,snap:!0,showThreeSeconds:!1,showGPSSpeed:!1,alignMap:!1,maxSpeed:5,minSpeed:15,drawnRoutes:[]};function Fe(){let t={};const e=Xe();let s=Math.pow(Math.min(e.height,e.width)/1500,.5);s=Math.min(s,5),s=Math.max(s,.5);const n=Math.round(C.circleSize*s);return t.controlRadius=n,t.finishInnerRadius=n*(5/6),t.finishOuterRadius=n*(7/6),t.startTriangleLength=n*(7/6),t.overprintWidth=C.courseWidth,t.font=n+"pt Arial",t}function Si(){try{if(window.hasOwnProperty("localStorage")&&window.localStorage!==null&&localStorage.getItem("rg2-options")!==null){const t=JSON.parse(localStorage.getItem("rg2-options"));for(let e in t)t.hasOwnProperty(e)&&(C[e]=t[e]);C.circleSize=20,C.perCentMapIntensity===0&&V("Warning","Your saved settings have 0% map intensity so the map is invisible. You can adjust this on the configuration menu")}}catch{}}function Ti(t){let e=[];for(let s=0;s<C.drawnRoutes.length;s+=1)(C.drawnRoutes[s].id!==t.id||C.drawnRoutes[s].eventid!==t.eventid)&&e.push(C.drawnRoutes[s]);C.drawnRoutes=e,xt()}function xt(){try{window.hasOwnProperty("localStorage")&&window.localStorage!==null&&localStorage.setItem("rg2-options",JSON.stringify(C))}catch{return}}function ki(t){let e=C.drawnRoutes;e.length>=f.MAX_DRAWN_ROUTES&&e.shift(),e.push(t),C.drawnRoutes=e,xt()}function Ii(t,e){C[t]=e,xt()}class Li{constructor(){this.controls=[],this.displayControls=!1}addControl(e,s,n){let i=!0;for(let l=0;l<this.controls.length;l+=1)if(this.controls[l].code===e){i=!1;break}i&&this.controls.push({code:e,x:s,y:n})}deleteAllControls(){this.controls.length=0}displayAllControls(){this.displayControls=!0}drawControls(e){if(this.displayControls){const s=Fe();for(let n=0;n<this.controls.length;n+=1)this.controls[n].code.indexOf("F")===0||this.controls[n].code.indexOf("M")===0?this.drawFinish(this.controls[n].x,this.controls[n].y,this.controls[n].code,s):this.controls[n].code.indexOf("S")===0?this.drawStart(this.controls[n].x,this.controls[n].y,this.controls[n].code,1.5*Math.PI,s):(this.drawSingleControl(this.controls[n].x,this.controls[n].y,this.controls[n].code,Math.PI*.25,s),e&&a.fillRect(this.controls[n].x-1,this.controls[n].y-1,3,3))}}drawFinish(e,s,n,i){a.strokeStyle="white",a.lineWidth=i.overprintWidth+2,a.beginPath(),a.arc(e,s,i.finishInnerRadius,0,2*Math.PI,!1),a.stroke(),a.beginPath(),a.arc(e,s,i.finishOuterRadius,0,2*Math.PI,!1),a.stroke(),a.beginPath(),a.font=i.font,a.textAlign="left",a.strokeStyle="white",a.miterLimit=2,a.lineJoin="circle",a.lineWidth=1.5,a.strokeText(n,e+i.controlRadius*1.5,s+i.controlRadius),a.stroke(),a.beginPath(),a.fillStyle=f.PURPLE,a.strokeStyle=f.PURPLE,a.lineWidth=i.overprintWidth,a.arc(e,s,i.finishInnerRadius,0,2*Math.PI,!1),a.stroke(),a.beginPath(),a.arc(e,s,i.finishOuterRadius,0,2*Math.PI,!1),a.fillText(n,e+i.controlRadius*1.5,s+i.controlRadius),a.stroke()}drawSingleControl(e,s,n,i,l){a.beginPath(),a.strokeStyle="white",a.lineWidth=l.overprintWidth+2,a.arc(e,s,l.controlRadius,0,2*Math.PI,!1),a.stroke(),a.beginPath(),a.textAlign="center",a.font=l.font,a.strokeStyle="white",a.miterLimit=2,a.lineJoin="circle",a.lineWidth=1.5,a.textBaseline="middle";const r=a.measureText(n);let o;i<Math.PI?o=r.width/2:o=-1*r.width/2;let m;i>=Math.PI/2&&i<=Math.PI*1.5?m=-1*l.controlRadius/2:m=l.controlRadius/2;const y=1.3;a.strokeText(n,e+l.controlRadius*y*Math.sin(i)+o,s+l.controlRadius*y*Math.cos(i)+m),a.beginPath(),a.font=l.font,a.fillStyle=f.PURPLE,a.strokeStyle=f.PURPLE,a.lineWidth=l.overprintWidth,a.arc(e,s,l.controlRadius,0,2*Math.PI,!1),a.fillText(n,e+l.controlRadius*y*Math.sin(i)+o,s+l.controlRadius*y*Math.cos(i)+m),a.stroke()}drawStart(e,s,n,i,l){let r=[],o=[];const m=2*Math.PI/3;i=i+Math.PI/2,a.lineCap="round",a.strokeStyle="white",a.lineWidth=l.overprintWidth+2,a.beginPath(),r[0]=e+l.startTriangleLength*Math.sin(i),o[0]=s-l.startTriangleLength*Math.cos(i),a.moveTo(r[0],o[0]),r[1]=e+l.startTriangleLength*Math.sin(i+m),o[1]=s-l.startTriangleLength*Math.cos(i+m),a.lineTo(r[1],o[1]),a.stroke(),a.beginPath(),a.moveTo(r[1],o[1]),r[2]=e+l.startTriangleLength*Math.sin(i-m),o[2]=s-l.startTriangleLength*Math.cos(i-m),a.lineTo(r[2],o[2]),a.stroke(),a.beginPath(),a.moveTo(r[2],o[2]),a.lineTo(r[0],o[0]),a.stroke(),a.beginPath(),a.font=l.font,a.textAlign="left",a.strokeStyle="white",a.miterLimit=2,a.lineJoin="circle",a.lineWidth=1.5,a.strokeText(n,r[0]+l.controlRadius*1.25,o[0]+l.controlRadius*1.25),a.stroke(),a.strokeStyle=f.PURPLE,a.lineWidth=l.overprintWidth,a.font=l.font,a.fillStyle=f.PURPLE,a.beginPath(),a.moveTo(r[0],o[0]),a.lineTo(r[1],o[1]),a.stroke(),a.beginPath(),a.moveTo(r[1],o[1]),a.lineTo(r[2],o[2]),a.stroke(),a.beginPath(),a.moveTo(r[2],o[2]),a.lineTo(r[0],o[0]),a.fillText(n,r[0]+l.controlRadius*1.25,o[0]+l.controlRadius*1.25),a.stroke()}generateControlList(){this.controls.length=0;const e=$n();for(let s=0;s<e.length;s+=1)if(e[s]!==void 0){const n=e[s].codes,i=e[s].x,l=e[s].y;if(n!==void 0)for(let r=0;r<n.length;r+=1)this.addControl(n[r],i[r],l[r])}}getControlCount(){return this.controls.length}toggleControlDisplay(){this.displayControls=!this.displayControls}}class wi{constructor(e,s,n,i){this.x=e,this.y=s,this.basex=e,this.basey=s,this.undox=e,this.undoy=s,this.locked=!1,this.time=n,this.index=i}}class Di{constructor(){this.handles=[]}addHandle(e,s,n){this.handles.push(new wi(e,s,n,this.handles.length)),this.handles.sort(function(i,l){return i.time-l.time}),this.renumberHandles()}deleteHandle(e){e===0||e===this.handles.length-1?this.toggleLock(e):this.handles.splice(e,1),this.renumberHandles()}renumberHandles(){for(let e=0;e<this.handles.length;e+=1)this.handles[e].index=e}lockHandleByTime(e){for(let s=0;s<this.handles.length;s+=1)this.handles[s].time===e&&(this.handles[s].locked=!0)}handlesLocked(){let e=0;for(let s=0;s<this.handles.length;s+=1)this.handles[s].locked&&(e+=1);return e}deleteAllHandles(){this.handles.length=0}rebaselineXY(){this.copyHandleFields("","base")}saveForUndo(){this.copyHandleFields("base","undo")}toggleLock(e){this.handles[e].locked=!this.handles[e].locked}undo(){this.copyHandleFields("undo","base"),this.copyHandleFields("undo","")}copyHandleFields(e,s){for(let n=0;n<this.handles.length;n+=1)this.handles[n][s+"x"]=this.handles[n][e+"x"],this.handles[n][s+"y"]=this.handles[n][e+"y"]}getStartHandle(){return this.handles[0]}getFinishHandle(){return this.handles[this.handles.length-1]}getHandleClicked(e){for(let s=0;s<this.handles.length;s+=1)if(Y(e.x,e.y,this.handles[s].basex,this.handles[s].basey)<=f.HANDLE_DOT_RADIUS)return this.handles[s]}getEarliestLockedHandle(){for(let e=0;e<this.handles.length;e+=1)if(this.handles[e].locked)return this.handles[e]}getLatestLockedHandle(){for(let e=this.handles.length-1;e>0;e-=1)if(this.handles[e].locked)return this.handles[e]}getPreviousLockedHandle(e){for(let s=e.index-1;s>=0;s-=1)if(this.handles[s].locked)return this.handles[s]}getNextLockedHandle(e){for(let s=e.index+1;s<this.handles.length;s+=1)if(this.handles[s].locked)return this.handles[s]}getSingleLockedHandle(){return this.getEarliestLockedHandle()}dragHandles(e,s){for(let n=0;n<this.handles.length;n+=1)this.handles[n].x=this.handles[n].basex+e,this.handles[n].y=this.handles[n].basey+s}drawHandles(){for(let e=0;e<this.handles.length;e+=1)a.lineWidth=1,this.handles[e].locked===!0?(a.fillStyle=f.RED_30,a.strokeStyle=f.RED):(a.fillStyle=f.GREEN_30,a.strokeStyle=f.GREEN),a.beginPath(),a.arc(this.handles[e].x,this.handles[e].y,f.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),a.fill(),a.stroke()}alignHandles(e){for(let s=0;s<this.handles.length;s+=1)this.handles[s].x=e.x[this.handles[s].time],this.handles[s].y=e.y[this.handles[s].time]}}class Et{constructor(){this.courseid=null,this.coursename=null,this.controlsToAdjust=0,this.resultid=null,this.isScoreCourse=!1,this.eventid=null,this.name=null,this.comments=null,this.x=[],this.y=[],this.controlx=[],this.controly=[],this.time=[],this.startsecs=0,this.totaltime=0,this.splits=[],this.xml=null}}class sn{constructor(){this.lat=[],this.lon=[],this.startOffset=0,this.baseX=[],this.baseY=[],this.handles=new Di,this.savedBaseX=[],this.savedBaseY=[],this.fileLoaded=!1,this.fileName="",this.fileType="",this.routeData=new Et,this.autofitOffset=null}adjustOffset(e){this.autofitOffset=e,this.processGPSFile(),this.autofitTrack()}addStartAndFinishHandles(){this.handles.addHandle(this.baseX[0],this.baseY[0],0),this.handles.addHandle(this.baseX[this.baseX.length-1],this.baseY[this.baseY.length-1],this.baseY.length-1)}applyWorldFile(){const e=Bn();for(let s=0;s<this.lat.length;s+=1)this.routeData.x[s]=Math.round((e.E*this.lon[s]-e.B*this.lat[s]+e.xCorrection)/e.AEDB),this.routeData.y[s]=Math.round((-1*e.D*this.lon[s]+e.A*this.lat[s]+e.yCorrection)/e.AEDB)}autofitTrack(){document.getElementById("chk-move-all").checked=!1,this.handles.deleteAllHandles(),this.addStartAndFinishHandles(),this.autofitOffset===null&&(this.autofitOffset=this.getOffset());for(let e=1;e<this.routeData.controlsToAdjust;e+=1)if(this.routeData.splits[e]!==this.routeData.splits[e-1]){const s=this.routeData.splits[e]+this.autofitOffset;s<this.baseX.length&&s>=0&&(this.handles.addHandle(this.routeData.x[s],this.routeData.y[s],s),Tn({x:this.routeData.x[s],y:this.routeData.y[s]},{x:this.routeData.controlx[e],y:this.routeData.controly[e]}),this.handles.lockHandleByTime(s),this.baseX=this.routeData.x.slice(0),this.baseY=this.routeData.y.slice(0),this.handles.rebaselineXY())}document.getElementById("btn-autofit-gps").setAttribute("disabled",""),document.getElementById("btn-undo-gps-adjust").setAttribute("disabled",""),D()}expandToOneSecondInterval(){let e=[],s=[],n=[];const i=this.routeData;let l=i.time[0],r=i.x[0],o=i.y[0];e[0]=r,s[0]=o,n[0]=i.time[0];let m=n[0]+1;for(let y=1;y<i.x.length;y+=1){const u=i.time[y]-l;if(u>0){const p=(i.x[y]-r)/u,v=(i.y[y]-o)/u;let I=1;for(;I<=u;)e.push(r+p*I),s.push(o+v*I),n.push(m),m+=1,I+=1;r=i.x[y],o=i.y[y],l=m-1}}this.routeData.x=e.slice(0),this.routeData.y=s.slice(0),this.routeData.time=n.slice(0)}fitTrackInsideCourse(){const e=this.getLatLonInfo(),s=this.getControlInfo();let n=(s.maxX-s.minX)/(e.maxLon-e.minLon),i=(s.maxY-s.minY)/(e.maxLat-e.minLat);n>i?i=n*e.latCorrection/e.lonCorrection:n=i*e.lonCorrection/e.latCorrection,this.routeData.x[0]=(this.lon[0]-e.minLon)*n+s.minX,this.routeData.y[0]=-1*(this.lat[0]-e.maxLat)*i+s.minY;const l=s.minX-(this.routeData.x[0]-s.x[0]),r=s.minY-(this.routeData.y[0]-s.y[0]);for(let o=0;o<this.lat.length;o+=1)this.routeData.x[o]=(this.lon[o]-e.minLon)*n+l,this.routeData.y[o]=-1*(this.lat[o]-e.maxLat)*i+r}getControlInfo(){let e=xr();if(e.minX=Math.min.apply(Math,e.x),e.maxX=Math.max.apply(Math,e.x),e.minY=Math.min.apply(Math,e.y),e.maxY=Math.max.apply(Math,e.y),e.maxY-e.minY<100||e.maxX-e.minX<100){e.minX=0,e.minY=0;const s=Xe();e.maxX=s.width,e.maxY=s.height}return e}getLatLonInfo(){let e={};return e.maxLat=Math.max.apply(Math,this.lat),e.maxLon=Math.max.apply(Math,this.lon),e.minLat=Math.min.apply(Math,this.lat),e.minLon=Math.min.apply(Math,this.lon),e.lonCorrection=$t(e.minLat,e.maxLon,e.minLat,e.minLon)/(e.maxLon-e.minLon),e.latCorrection=$t(e.minLat,e.minLon,e.maxLat,e.minLon)/(e.maxLat-e.minLat),e}getOffset(){const e=this.getSpeedAverage();let s=[];const n=10;for(let o=0;o<=2*n;o+=1)s[o]=0;let i=0;for(let o=1;o<this.routeData.controlsToAdjust;o+=1){const m=this.routeData.splits[o];if(m!==this.routeData.splits[o-1]){m>=n&&m+n<e.length&&(i=e.slice(m-n,m+n+1));for(let y=0;y<=2*n;y+=1)s[y]+=i[y]}}let l=0;for(let o=1;o<s.length;o+=1)s[o]<s[l]&&(l=o);return l-n}getSecsFromTrackpoint(e){const s=parseInt(Date.parse(e)/1e3,10);return isNaN(s)?0:s-this.startOffset}getSpeedAverage(){let e=[],s=[];e[0]=0;for(let n=1;n<this.routeData.x.length;n+=1)e[n]=Y(this.routeData.x[n],this.routeData.y[n],this.routeData.x[n-1],this.routeData.y[n-1]);for(let n=1;n<this.routeData.x.length-1;n+=1)s[n]=(e[n-1]+e[n]+e[n+1])/3;return s[0]=e[0],s[this.routeData.x.length-1]=e[this.routeData.x.length-1],s}getStartOffset(e){const s=parseInt(Date.parse(e.substr(0,11)+"00:00:00Z")/1e3,10);return isNaN(s)?0:s}initialiseGPS(){this.lat.length=0,this.lon.length=0,this.startOffset=0,this.baseX.length=0,this.baseY.length=0,this.handles.deleteAllHandles(),this.savedBaseX.length=0,this.savedBaseY.length=0,this.fileLoaded=!1,this.routeData.x.length=0,this.routeData.y.length=0,this.routeData.time.length=0}processGPSFile(){this.initialiseGPS(),this.fileType==="gpx"?this.processGPX():this.processTCX(),this.processGPSTrack()}processGPSTrack(){It()?(this.applyWorldFile(),this.trackMatchesMapCoordinates()?document.getElementById("chk-move-all").checked=!0:(V("GPS file problem","Your GPS file does not match the map co-ordinates. Please check you have selected the correct file."),this.fitTrackInsideCourse())):this.fitTrackInsideCourse(),this.lat.length=0,this.lon.length=0,this.expandToOneSecondInterval(),this.baseX=this.routeData.x.slice(0),this.baseY=this.routeData.y.slice(0),this.addStartAndFinishHandles(),this.fileLoaded=!0,this.routeData.splits.length>2&&document.getElementById("btn-autofit-gps").removeAttribute("disabled"),document.getElementById("btn-save-gps-route").removeAttribute("disabled"),D()}processGPX(){const e=this.xml.getElementsByTagName("trkseg");for(let s=0;s<e.length;s+=1){const n=e[s].getElementsByTagName("trkpt");this.startOffset=this.getStartOffset(n[0].getElementsByTagName("time")[0].textContent);for(let i=0;i<n.length;i+=1){const l=n[i].getAttribute("lat"),r=n[i].getAttribute("lon");l!=="0"&&r!=="0"&&(this.lat.push(l),this.lon.push(r),this.routeData.time.push(this.getSecsFromTrackpoint(n[i].getElementsByTagName("time")[0].textContent)))}}}processTCX(){const e=this.xml.getElementsByTagName("Track");for(let s=0;s<e.length;s+=1){const n=e[s].getElementsByTagName("Trackpoint");this.startOffset=this.getStartOffset(n[0].getElementsByTagName("Time")[0].textContent);for(let i=0;i<n.length;i+=1)if(n[i].getElementsByTagName("Position").length>0){const l=n[i].getElementsByTagName("Position"),r=l[0].getElementsByTagName("LatitudeDegrees")[0].textContent,o=l[0].getElementsByTagName("LongitudeDegrees")[0].textContent;r!=="0"&&o!=="0"&&(this.lat.push(r),this.lon.push(o),this.routeData.time.push(this.getSecsFromTrackpoint(n[i].getElementsByTagName("Time")[0].textContent)))}}}readGPS(e){let s=new FileReader;this.fileName=e.target.files[0].name,s.onerror=function(n){V("GPS file problem","Unable to open GPS file. "+n)},s.onload=n=>{try{if(this.fileType=this.fileName.slice(-3).toLowerCase(),this.fileType!=="gpx"&&this.fileType!=="tcx"){V("GPS file problem","File type not recognised. Please check you have selected the correct file.");return}document.getElementById("rg2-load-gps-file").setAttribute("disabled",""),this.xml=new DOMParser().parseFromString(n.target.result,"text/xml"),this.processGPSFile()}catch(i){V("GPS file problem","File is not valid XML. Please check you have selected the correct file. "+i);return}},s.readAsText(e.target.files[0])}trackMatchesMapCoordinates(){const e=Math.min.apply(Math,this.routeData.x),s=Math.max.apply(Math,this.routeData.x),n=Math.min.apply(Math,this.routeData.y),i=Math.max.apply(Math,this.routeData.y),l=Xe();return s>0&&e<l.width&&n<l.height&&i>0}}let K=0,te=[],Z=[];function gs(t,e){return t.length>0?e+t.join(","):""}function ms(t,e,s){let n="#";return K!==0&&(n+=t+gs(s,"&course=")+gs(e,"&route=")),n}function Ci(){return te}function Ai(){return K}function Mi(){return Z}function Ri(){return Z.length>0?f.TAB_RESULTS:f.TAB_COURSES}function Bi(t){let e=0;return/#([0-9]+)($|&)/.test(t)&&(e=t.replace(/#([0-9]+)($|&).*/,"$1"),e.length>0)?parseInt(e,10):e}function nn(t){K=0,te.length=0,Z.length=0;let e=t.split("&");for(let s=0;s<e.length;s+=1)e[s]=e[s].toLowerCase(),e[s].search("#")!==-1&&(K=parseInt(e[s].replace(/\D/g,""),10)),e[s].search("course=")!==-1&&(te=e[s].replace("course=","").split(",")),e[s].search("route=")!==-1&&(Z=e[s].replace("route=","").split(","));return te=te.map(Number),Z=Z.map(Number),isNaN(K)&&(K=0,te.length=0,Z.length=0),St(),K}function Pi(t){K=t,St()}function ps(t){te=t,St()}function Ct(t){Z=t,St()}function St(){let t="";Bi(window.location.hash)===K?(t=ms(K,Z,te),window.history.replaceState({hash:t},"",t)):(te.length=0,Z.length=0,t=ms(K,Z,te),window.history.pushState({hash:t},"",t))}class ys{constructor(e,s,n,i,l){this.resultid=e.resultid,this.rawid=this.resultid%f.GPS_RESULT_OFFSET,this.isScoreEvent=s,this.name=at(e.name).trim(),this.initials=this.getInitials(this.name),this.starttime=e.starttime,this.time=e.time,(this.time==="00"||this.time==="0")&&(this.time=""),this.timeInSecs=e.secs,this.position=e.position,this.status=e.status,this.canDelete=!1,this.showResult=!0,this.token=0,e.comments?this.comments=at(e.comments):this.comments="",this.coursename=e.coursename,this.coursename===""&&(this.coursename=e.courseid.toString()),this.courseid=e.courseid,this.variant=e.variant,this.splits=this.adjustRawSplits(e.splits),this.isScoreEvent&&(this.scorex=i,this.scorey=l,this.scorecodes=n),this.trackColour=null,this.userColour=null,this.firstExcluded=J(this.courseid).firstExcluded,this.initialiseTrack(e)}addInterpolatedTimes(e,s,n){const i=this.xysecs[e],l=this.xysecs[s]-i,r=n[e],o=n[s]-r;for(let m=e;m<=s;m+=1)this.xysecs[m]=i+Math.round((n[m]-r)*l/o)}addTrack(e){this.trackx=e.x.split(",").map(function(n){return parseInt(n,10)}),this.tracky=e.y.split(",").map(function(n){return parseInt(n,10)});for(let n=1;n<this.trackx.length;n+=1)this.trackx[n]=this.trackx[n-1]+this.trackx[n],this.tracky[n]=this.tracky[n-1]+this.tracky[n];let s;this.isGPSTrack?s=this.expandGPSTrack():this.splits.length===2?s=this.expandTrackWithNoSplits():s=this.expandNormalTrack(),s&&pa(this.courseid)}adjustRawSplits(e){e.splice(0,0,0);for(let s=1;s<e.length;s+=1)e[s]<=0&&(e[s]=e[s-1]);return e[e.length-1]=Math.max(this.timeInSecs,e[e.length-2]),e}calculateTotalTrackLength(){let e=[];e[0]=0;let s=this.trackx[0],n=this.tracky[0];for(let i=1;i<this.trackx.length;i+=1)e[i]=e[i-1]+Math.round(Y(this.trackx[i],this.tracky[i],s,n)),s=this.trackx[i],n=this.tracky[i];return e}calculateTrackTimes(e){let s=[];s[0]=0;let n=this.getNextValidControl(0),i=e.x[n],l=e.y[n],r=0,o=this.trackx[0],m=this.tracky[0],y=0,u=0,p=0;for(let v=1;v<this.trackx.length;v+=1)if(y=this.trackx[v],u=this.tracky[v],r+=Y(y,u,o,m),s[v]=Math.round(r),o=y,m=u,i===y&&l===u){if(this.xysecs[v]=this.splits[n],this.addInterpolatedTimes(p,v,s),p=v,n=this.getNextValidControl(n),n===e.x.length){this.hasValidTrack=!0;break}i=e.x[n],l=e.y[n]}}drawScoreCourse(){if(this.displayScoreCourse&&this.scorex.length>1){const e=Fe();a.globalAlpha=f.FULL_INTENSITY;let s=ue(this.scorex[0],this.scorey[0],this.scorex[1],this.scorey[1]);W.drawStart(this.scorex[0],this.scorey[0],"",s,e),s=[];for(let i=0;i<this.scorex.length-1;i+=1)s[i]=ue(this.scorex[i],this.scorey[i],this.scorex[i+1],this.scorey[i+1]);const n={from:0,to:this.scorex.length};la({x:this.scorex,y:this.scorey},s,this.courseid,e,n);for(let i=1;i<this.scorex.length-1;i+=1)W.drawSingleControl(this.scorex[i],this.scorey[i],i,Math.PI*.25,e);W.drawFinish(this.scorex[this.scorex.length-1],this.scorey[this.scorey.length-1],"",e)}}drawTrack(e){try{let s,n,i;if(this.displayTrack){if(this.isGPSTrack&&C.showGPSSpeed&&this.speedColour.length===0&&this.setSpeedColours(),this.isGPSTrack){const y=Fe();a.lineWidth=1,a.strokeStyle=f.PURPLE,a.fillStyle=f.PURPLE_30;let u=1,p=this.splits[u];for(let v=1;v<this.xysecs.length-1&&!(this.firstExcluded>0&&u>=this.firstExcluded);v+=1)if(this.xysecs[v]>=p){if(u>=e.filterFrom&&u<=e.filterTo&&(a.beginPath(),a.arc(this.trackx[v],this.tracky[v],y.controlRadius*.3,0,2*Math.PI,!1),a.fill(),a.stroke()),u=u+1,u>=this.splits.length)break;p=this.splits[u]}}let l=0,r=this.xysecs.length;const o=this.splits[e.filterFrom],m=this.splits[e.filterTo];for(let y=0;y<this.xysecs.length;y+=1)if(this.xysecs[y]>=o){l=y;break}for(let y=this.xysecs.length-1;y>=0;y-=1)if(this.xysecs[y]<=m){r=y;break}a.lineWidth=C.routeWidth,a.strokeStyle=this.trackColour,a.globalAlpha=C.perCentRouteIntensity/100,a.fillStyle=this.trackColour,a.font="10pt Arial",a.textAlign="left",a.beginPath(),a.moveTo(this.trackx[l],this.tracky[l]),s=this.trackx[l],n=this.tracky[l],i=0;for(let y=l+1;y<=r;y+=1)a.lineTo(this.trackx[y],this.tracky[y]),this.trackx[y]===s&&this.tracky[y]===n?i+=1:i>0&&((!this.isGPSTrack||this.isGPSTrack&&C.showThreeSeconds)&&a.fillText("+"+3*i,s+5,n+5),i=0),s=this.trackx[y],n=this.tracky[y],this.isGPSTrack&&C.showGPSSpeed&&(a.strokeStyle=this.speedColour[y],a.stroke(),a.beginPath(),a.moveTo(s,n));a.stroke()}}catch{return}}expandGPSTrack(){for(let e=0;e<this.trackx.length;e+=1)this.xysecs[e]=3*e;return this.speedColour.length=0,this.hasValidTrack=!0,this.hasValidTrack}expandNormalTrack(){this.xysecs.length=0,this.xysecs[0]=0;let e={};return this.isScoreEvent?(e.x=this.scorex,e.y=this.scorey):e=J(this.courseid),this.calculateTrackTimes(e),this.isScoreEvent&&(this.hasValidTrack=!0),this.hasValidTrack}expandTrackWithNoSplits(){this.xysecs.length=0;const e=this.splits[1];let s=0;this.xysecs[0]=0;const n={};n.x=J(this.courseid).x,n.y=J(this.courseid).y;let i=1,l=n.x[i],r=n.y[i],o=n.x[n.x.length-1],m=n.y[n.y.length-1];this.trackx.push(o),this.tracky.push(m);let y=0;const u=this.calculateTotalTrackLength(),p=u[u.length-1];let v=0,I=0,E=!1;for(let T=1;T<this.trackx.length;T+=1)if(v=this.trackx[T],I=this.tracky[T],(v!==this.trackx[0]||I!==this.tracky[0])&&(E=!0),l===v&&r===I&&E){if(s=parseInt(u[T]/p*e,10),this.xysecs[T]=s,this.splits[i]=s,this.addInterpolatedTimes(y,T,u),y=T,i+=1,i===n.x.length){this.hasValidTrack=!0;break}l=n.x[i],r=n.y[i]}return this.hasValidTrack}getColour(e){let s="#";if(e===0)return"#0080ff";if(e<.5)s+="ff";else{const n=parseInt((1-e)*255*2,10);n<16&&(s+="0"),s+=n.toString(16)}if(e>=.5)s+="ff";else{const n=255-parseInt((.5-e)*255*2,10);n<16&&(s+="0"),s+=n.toString(16)}return s+="00",s}getInitials(e){if(e===null)return"??";e=e.replace(/GPS/g,"*");let s="",n=!0;for(let i=0;i<e.length;i+=1)n&&(s+=e.substr(i,1),n=!1),e.charAt(i)===" "&&(n=!0);return s}getNextValidControl(e){for(let s=e+1;s<this.splits.length;s+=1)if(this.splits[s]!==this.splits[s-1])return s;return this.splits.length}initialiseTrack(e){if(this.legpos=[],this.racepos=[],this.hasValidTrack=!1,this.displayTrack=!1,this.displayScoreCourse=!1,this.trackx=[],this.tracky=[],this.speedColour=[],this.xysecs=[],this.resultid>=f.GPS_RESULT_OFFSET){this.isGPSTrack=!0;const s=sl(this.rawid);this.time=s.time,this.splits=s.splits,this.time===f.TIME_NOT_FOUND&&(this.time=e.time)}else this.isGPSTrack=!1}mapSpeedColours(){const e=16.667/C.maxSpeed,s=16.667/C.minSpeed,n=3,i=this.speedColour.slice().sort(function(y,u){return y-u}),l=je();let r=0,o=0;l!==void 0?(r=n*e/l,o=n*s/l):(r=i[i.length-1],o=i[Math.floor(i.length/95)]);const m=r-o;for(let y=0;y<this.speedColour.length;y+=1){let u=Math.max(this.speedColour[y],o);u=Math.min(u,r),this.speedColour[y]=this.getColour((u-o)/m)}}setSpeedColours(){this.speedColour[0]=0;let e=0;for(let s=1;s<this.trackx.length;s+=1){const n=Y(this.trackx[s],this.tracky[s],this.trackx[s-1],this.tracky[s-1]);this.speedColour[s]=(n+e)/2,e=n}this.mapSpeedColours()}setTrackDisplay(e){this.hasValidTrack&&(e?this.userColour!==null?this.trackColour=this.userColour:this.trackColour=tn():this.trackColour=null,this.displayTrack=e)}}let d=[];function _i(t,e){d.length=0;let s=[],n=[],i=[];if(e)for(let l=0;l<t.length;l+=1){let r=t[l].variant;s[r]===void 0&&(s[r]=t[l].scorecodes,n[r]=t[l].scorex,i[r]=t[l].scorey)}for(let l=0;l<t.length;l+=1)if(va(t[l].courseid)){t[l].resultid>f.GPS_RESULT_OFFSET&&t[l].coursename===""&&(t[l].coursename=J(t[l].courseid).name);let r;if(e){let o=t[l].variant;r=new ys(t[l],e,s[o],n[o],i[o])}else r=new ys(t[l],e);d.push(r)}hl(),ul(),ml(),il(),ol(e)}function Ni(t){for(let e=0;e<t.length;e+=1){let s=t[e].id,n=0;for(;n<d.length;){if(s===d[n].resultid){d[n].addTrack(t[e]);break}n+=1}}}function vs(t){for(let e=0;e<d.length;e+=1)if(d[e].courseid===t&&!Zn(e))return!1;return!0}function bs(){for(let t=0;t<d.length;t+=1)if(d[t].hasValidTrack&&!d[t].displayTrack)return!1;return!0}function Oi(t){for(let e=0;e<d.length;e+=1)if(d[e].courseid===t&&d[e].hasValidTrack&&!d[e].displayTrack)return!1;return!0}function xs(t){for(let e=0;e<d.length;e+=1)if(d[e].courseid===t&&d[e].hasValidTrack&&!Zn(e))return!1;return!0}function $i(t){for(let e=0;e<d.length;e+=1)if(d[e].courseid===t&&d[e].hasValidTrack&&d[e].displayTrack)return!0;return!1}function Fi(t){const e=Rn();let s=0;for(let n=0;n<d.length;n+=1)d[n].courseid===t&&(d[n].resultid<f.GPS_RESULT_OFFSET||e.format===f.FORMAT_NO_RESULTS||e.format===f.FORMAT_SCORE_EVENT_NO_RESULTS)&&(s+=1);return s}function ln(t){let e=document.getElementById("rg2-select-name");if(e.innerHTML="",e.options.add(xe(null,h("Select name",""))),t!==void 0){for(let s=0;s<d.length;s+=1)d[s].courseid===t&&d[s].resultid<f.GPS_RESULT_OFFSET&&e.options.add(xe(d[s].resultid,d[s].time+" "+d[s].name));e.addEventListener("change",s=>{_r(parseInt(s.target.value,10))}),e.removeAttribute("disabled")}}function Hi(){let t=Vi();t=t.replace(/&amp;/g,"&");const e=document.getElementById("rg2-result-table");e.innerHTML=t,gl(),cn(),ir();const s=document.querySelectorAll(".resultrow");for(let n of s)n.addEventListener("dblclick",i=>{const l=parseInt(i.currentTarget.dataset.id,10);l&&Gt(l)}),n.addEventListener("contextmenu",i=>{const l=parseInt(i.currentTarget.dataset.id,10);l&&Gt(l)})}function Gi(){d.length=0}function Ui(t,e){d[t].displayScoreCourse=e}function Es(){for(let t=0;t<d.length;t+=1){let e;d[t].isScoreEvent?e={from:0,to:d[t].scorex.length}:e=ma(d[t].courseid),d[t].drawTrack(e),d[t].drawScoreCourse()}}function Vi(){let t=[],e=[];if(d.length===0)return`<p>${h("No results available")}</p>`;let s="",n=0,i=0;ll();for(let l=0;l<d.length;l+=1){const r=d[l];if(!r.showResult)continue;r.courseid!==n&&(t.length>0&&(s+=Ss(i,n)+"</table>",e.push(s)),i=0,t.push(Ki(r)),s=`<table class='resulttable' id='table-${r.courseid}'><thead><tr><th>#</th>`,s+=`<th>${h("Name")}</th><th>${h("Time")}</th>`,s+=`<th><i class='bi-pencil'></i></th><th><i class='bi-play-fill'></i></th></tr></thead><tbody class="table-group-divider">`,n=r.courseid),s+=`<tr class="resultrow" data-id="${r.rawid}"><td>${r.position}</td>`,r.comments!==""&&r.comments!==h("Type your comment")?(r.comments=r.comments.replace(/"/g,"&quot;"),s+=`<td title="${r.comments}"><u>${Ts(r,l)}</u>`):s+=`<td>${Ts(r,l)}`,r.canDelete&&(s+=` <i class='deleteroute bi-trash-fill' data-resultidx=${l}></i>`),s+=`</td><td>${r.time}</td>`;let o="",m="showreplay";r.hasValidTrack&&(i+=1,o=`<input class='showtrack' data-courseid='${n}' data-id='${r.resultid}' type=checkbox name=result></input>`,m+=" showtrackreplay"),s+=`<td>${o}</td>`,s+=`<td><input class="${m}" data-courseid=${n} data-id=${r.resultid} type=checkbox name=replay></input></td></tr>`}s+=`</tbody>${Ss(i,n)}</table>`,e.push(s),s='<div class="accordion" id="results-accordion">';for(let l=0;l<e.length;l+=1)s+='<div class="accordion-item">',s+=`<h2 class="accordion-header d-flex" id="header-${l}">`,s+=`<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${l}" aria-expanded="true" aria-controls="collapse-${l}">`,s+=`${t[l].title}</button>${t[l].check}</h2>`,s+=`<div id="collapse-${l}" class="accordion-collapse collapse" aria-labelledby="header-${l}" data-bs-parent="#rg2-result-tab-body">`,s+=`<div class="accordion-body px-0">${e[l]}</div></div></div>`;return s+="</div>",s}function Yi(t){let e=Math.floor(t/86400)+" days ";return t=t-86400*Math.floor(t/86400),e+=Math.floor(t/3600)+" hours ",t=t-3600*Math.floor(t/3600),e+=Math.floor(t/60)+" minutes ",e+=t-60*Math.floor(t/60)+" seconds",e}function Wi(){let t=[],e=[],s=[],n=[];for(let i=0;i<d.length;i+=1){const l=d[i];if(l.resultid<f.GPS_RESULT_OFFSET){const r=l.courseid;t.indexOf(r)===-1&&(t.push(r),e[r]=[],s[r]=[],n[r]=[]);for(let o=0;o<l.scorecodes.length;o+=1)e[r].indexOf(l.scorecodes[o])===-1&&(e[r].push(l.scorecodes[o]),s[r].push(l.scorex[o]),n[r].push(l.scorey[o]))}}for(let i=0;i<t.length;i+=1){const l=t[i];Ea(l,e[l],s[l],n[l])}}function rn(t){let e=[];for(let s=0;s<d.length;s+=1)d[s].courseid===t&&d[s].resultid===d[s].rawid&&e.push(d[s]);return e}function an(t){let e=[];for(let s=0;s<d.length;s+=1)d[s].variant===t&&d[s].resultid===d[s].rawid&&e.push(d[s]);return e}function Xi(t){let e=[];for(let s=0;s<d.length;s+=1)d[s].courseid===t&&e.push(d[s].resultid);return e}function qi(t){let e=[];for(let s=0;s<d.length;s+=1)d[s].courseid===t&&d[s].hasValidTrack&&e.push(d[s].resultid);return e}function Ss(t,e){let s=`<tfoot class="table-group-divider"><tr class='allitemsrow'><td></td><td>${h("Routes")}</td><td></td>`;return t>0?(s+=`<td><input class='allcoursetracks' data-courseid=${e} type=checkbox name=track></input></td>`,s+=`<td><input class='allcoursetracksreplay' data-courseid=${e} type=checkbox name=replay></input></td>`):s+="<td></td><td></td>",s+=`</tr><tr class='allitemsrow'><td></td><td>${h("All")}</td><td></td><td></td>`,s+=`<td><input class='allcoursereplay' data-courseid=${e} type=checkbox name=replay></input></td></tr></tfoot>`,s}function ji(){let t=!1,e=[`<h5>${h("Comments")}</h5><table id='rg2-comments-table' class='table table-sm table-striped table-bordered'>`,`<thead><tr><th>${h("Name")}</th><th>${h("Course")}</th>`,`<th>${h("Comments")}</th></tr></thead><tbody class="table-group-divider">`].join("");for(let s=0;s<d.length;s+=1)d[s].comments!==""&&(t=!0,e+=[`<tr><td>${d[s].name}</td><td>${d[s].coursename}</td>`,`<td>${d[s].comments}</td></tr>`].join(""));return t?e='<hr class="border border-primary opacity-75 my-5" />'+e+"</tbody></table>":e="",e}function zi(t){for(let e=0;e<d.length;e+=1)if(d[e].resultid===t)return d[e].courseid}function Ki(t){let e=t.coursename;const s=J(t.courseid);s&&!s.isScoreCourse&&s.codes.length>2&&(e+=s.lengthValid?": "+s.length+" km":"");let n=`<div class="d-flex w-100"><div class="flex-grow-1 runners-table-course-header" data-runners="" data-courseid="${t.courseid}">${e}</div>`,i=`<div class="px-2"><input class='showcourse' data-courseid="${t.courseid}"`;return i+=` type=checkbox name ="course" title='Show course' ></input ></div >`,{title:n,check:i}}function Zi(t){return{id:d[t].resultid,token:d[t].token}}function Ji(){let t=[];for(let e=0;e<d.length;e+=1)if(d[e].displayTrack){let s={};s.trackColour=d[e].trackColour,s.course=ua(d[e].courseid),s.name=d[e].name,s.resultid=d[e].resultid,s.rawid=d[e].rawid,t.push(s)}return t}function on(t){for(let e=0;e<d.length;e+=1)if(d[e].resultid===t)return d[e]}function dn(t){let e,s=d.find(n=>n.rawid===t);return s!==void 0&&(e=d.find(n=>(n.resultid-t)%f.GPS_RESULT_OFFSET===0&&n.resultid!==t),e===void 0?s.routeresultid=t:(s.routeresultid=e.resultid,s.hasValidTrack=e.hasValidTrack)),s}function Ts(t,e){let s;return t.rawid===t.resultid?s=t.name:s="<i>"+t.name+"</i>",t.isScoreEvent&&(s=`<input class='showscorecourse' data-courseid=${e} type=checkbox></input> ${s}`),`<div>${s}</div>`}function Qi(t){let e=d.findIndex(s=>s.resultid===t);return e>-1?d[e].displayOrder:t}function el(){let t={results:0,drawnroutes:0,gpsroutes:0,secs:0};for(let e=0;e<d.length;e+=1){const s=d[e];s.resultid<f.GPS_RESULT_OFFSET&&(t.results+=1,s.time&&(t.secs+=s.splits[s.splits.length-1])),s.hasValidTrack&&(s.resultid<f.GPS_RESULT_OFFSET?t.drawnroutes+=1:t.gpsroutes+=1)}return t.totalroutes=t.drawnroutes+t.gpsroutes,t.results>0?t.percent=(100*t.totalroutes/t.results).toFixed(1):t.percent=0,t.time=Yi(t.secs),t}function tl(t){const e=el(),s=ha(),n=Xe();let i="";if(t.worldfile.valid){const o=Bn(),m=1e6,y=parseInt(o.F*m)/m,u=parseInt(o.C*m)/m;i=`${h("Map is georeferenced")}: <a href="https://www.openstreetmap.org/#map=15/${y}/${u}" target="_blank" rel="noopener noreferrer">${y}, ${u}</a>.`}function l(o,m){return`<div class="card m-2 text-center" style="width: auto; min-width: 15%">
    <div class="card-header">${o}</div>
    <div class="card-body">
      <p class="card-text">${m}</p>
    </div>
  </div>`}let r=l(h("Courses"),s.length)+l(h("Controls"),t.controls)+l(h("Results"),e.results)+l(h("Routes"),e.totalroutes+" ("+e.percent+"%)")+l(h("Drawn routes"),e.drawnroutes)+l(h("GPS routes"),e.gpsroutes)+l(h("Total time"),e.time)+l(h("Map")+" ID "+qr(),n.width+"x"+n.height+" pixels<br>"+i);return t.comment&&(r+=l(h("Comments"),t.comment)),r}function go(){let t=[];for(let e=0;e<d.length;e+=1)if(d[e].hasValidTrack){let s={};s.id=e,s.resultid=d[e].resultid,s.name=d[e].name,s.time=d[e].time,s.coursename=d[e].coursename,t.push(s)}return t}function sl(t){for(let e=0;e<d.length;e+=1)if(t===d[e].resultid)return{time:d[e].time,splits:d[e].splits};return{time:f.TIME_NOT_FOUND,splits:[]}}function At(){let t=[];for(let e=0;e<d.length;e+=1){const s=d[e];s.displayTrack&&t.push(s.resultid)}return t}function nl(){const t=[];return d.forEach(e=>{!t.includes(e.variant)&&e.variant!==void 0&&t.push(e.variant)}),t}function il(){let t,e,s=[];for(let n=0;n<d.length;n+=1)if(d[n].courseid!==t&&(t=d[n].courseid,e=J(t)),e.excludeType===f.EXCLUDED_REAL_SPLITS){s.indexOf(t)===-1&&s.push(t);let i=0;for(let l=1;l<e.exclude.length;l+=1)e.exclude[l]&&(i=i+Math.min(d[n].splits[l]-d[n].splits[l-1],e.allowed[l]));d[n].timeInSecs=Math.max(d[n].splits[d[n].splits.length-1]-i,0),d[n].time=P(d[n].timeInSecs)}for(let n=0;n<s.length;n+=1){let i=d.filter(o=>o.courseid===s[n]);for(let o=0;o<i.length;o+=1)if(i[o].rawid!==i[o].resultid){let m=i.findIndex(y=>y.resultid===i[o].rawid);m>-1&&(i[o].status=i[m].status)}i.sort(function(o,m){return o.status!=="ok"||o.timeInSecs===0?m.status!=="ok"||m.timeInSecs===0?0:1:m.status!=="ok"||m.timeInSecs===0?-1:o.timeInSecs-m.timeInSecs});let l=0,r=0;for(let o=0;o<i.length;o+=1){if(i[o].status!=="ok"||i[o].timeInSecs===0){i[o].position="";continue}r!==i[o].timeInSecs?(l=l+1,r=i[o].timeInSecs):o>0&&i[o].rawid!==i[o-1].rawid&&(l=l+1),i[o].position=l}for(let o=0;o<i.length;o+=1){let m=d.findIndex(y=>y.resultid===i[o].resultid);m>-1&&(d[m].position=i[o].position,d[m].displayOrder=o)}}}function ll(){d.sort(yl);let t,e=!1;for(let s=0;s<d.length;s+=1)d[s].rawid===t?e&&d[s].hasValidTrack&&(d[s-1].showResult=!1,d[s].position=d[s-1].position,e=!1):(e=!d[s].hasValidTrack,t=d[s].rawid)}function rl(){for(let t=0;t<d.length;t+=1)d[t].speedColour.length=0}function al(t){for(let e=0;e<d.length;e+=1)if(t===d[e].resultid)return!0;return!1}function ol(t){let e,s;for(let n=0;n<d.length;n+=1){d[n].courseid!==e&&(e=d[n].courseid,s=J(e)),d[n].legSplits=[],d[n].legSplits[0]=0;let i=0,l=!1;for(let r=1;r<d[n].splits.length;r+=1)d[n].splits[r]-i===0?s.exclude[r]?(d[n].legSplits[r]=d[n].splits[r]-i,i=d[n].splits[r]):(d[n].legSplits[r]=0,l=!0,d[n].lastValidSplit===void 0&&(d[n].lastValidSplit=r-1)):l?(d[n].legSplits[r]=0,i=d[n].splits[r],l=!1):(d[n].legSplits[r]=d[n].splits[r]-i,i=d[n].splits[r]);if(d[n].lastValidSplit===void 0&&(d[n].lastValidSplit=d[n].splits.length-1),!t){const r=s.codes.length;if(r>2&&d[n].splits.length===2){const o=s.cumulativeLegLengths[s.cumulativeLegLengths.length-1];d[n].splits[0],d[n].legSplits[0];for(let m=1;m<r;m=m+1)d[n].legSplits[m]=parseInt(s.legLengths[m]/o*d[n].timeInSecs,10),d[n].splits[m]=parseInt(s.cumulativeLegLengths[m]/o*d[n].timeInSecs,10);d[n].lastValidSplit=d[n].splits.length-1}else for(;d[n].splits.length<r;)d[n].splits.push(d[n].splits[d[n].splits.length-1]),d[n].legSplits.push(0)}}}function dl(t){Fn()>0&&_i(t,gt()),xa(),gt()&&(Wi(),W.generateControlList())}function cl(t){Fn()>0&&Ni(t)}function ul(){const t=fe();let e=[];const s=C.drawnRoutes;for(let n=0;n<s.length;n+=1)s[n].eventid===t&&e.push(s[n]);for(let n=0;n<e.length;n+=1)for(let i=0;i<d.length;i+=1)d[i].resultid===e[n].id&&(d[i].canDelete=!0,d[i].token=e[n].token)}function cn(){document.getElementById("rg2-result-table").querySelectorAll("#results-accordion .accordion-item").forEach(s=>{const n=s.querySelectorAll(".resulttable tbody tr:not(.d-none)");s.querySelector(".runners-table-course-header").setAttribute("data-runners",n.length)})}function hl(){for(let t=0;t<d.length;t+=1)d[t].resultid<f.GPS_RESULT_OFFSET?d[t].displayOrder=t:d[t].displayOrder=Qi(d[t].rawid)}function fl(t,e){for(let s=0;s<d.length;s+=1)d[s].rawid===t&&(d[s].userColour=e,d[s].trackColour=e)}function gl(){let t=document.getElementById("rg2-result-search");if(d.length===0){t.classList.add("d-none");return}t.innerHTML=`<form class="d-flex pb-2" role="search">
  <input class="form-control mx-2" type="search" aria-label="${h("Search")}">
  <i class="bi-search mx-2"></i>
  </form>`;let e=document.getElementById("rg2-result-table");t.addEventListener("keyup",s=>{const n=s.target.value.toUpperCase(),i=e.querySelectorAll("tbody tr");for(let l=0;l<i.length;l+=1)i[l].innerText.toUpperCase().indexOf(n)>-1?i[l].classList.remove("d-none"):i[l].classList.add("d-none");cn()})}function He(t,e){for(let s=0;s<d.length;s+=1)d[s].resultid===t&&(d[s].displayScoreCourse=e)}function ml(){for(let t=0;t<d.length;t+=1)if(d[t].resultid>=f.GPS_RESULT_OFFSET){const e=dn(d[t].rawid);e!==void 0&&e.scorex!==void 0&&(d[t].scorex=e.scorex,d[t].scorey=e.scorey,d[t].scorecodes=e.scorecodes)}}function ks(t,e){for(let s=0;s<d.length;s+=1)(d[s].courseid===t||f.DISPLAY_ALL_COURSES===t)&&d[s].setTrackDisplay(e);ds()}function pl(t,e){for(let s=0;s<d.length;s+=1)d[s].resultid===parseInt(t,10)&&d[s].setTrackDisplay(e);ds()}function yl(t,e){return t.courseid>e.courseid?1:e.courseid>t.courseid?-1:t.rawid===e.rawid?t.resultid-e.resultid:t.displayOrder-e.displayOrder}class zt{constructor(e){const s=on(e);this.name=s.name,this.initials=s.initials,this.resultid=e,this.rawid=s.rawid,this.starttime=s.starttime,this.splits=s.splits,this.trackColour=s.trackColour,this.userColour=s.userColour;let n;s.isScoreEvent?(n={},n.name=s.coursename,n.x=s.scorex,n.y=s.scorey,n.codes=s.scorecodes):n=J(s.courseid),this.coursename=n.name,this.nextStopTime=f.VERY_HIGH_TIME_IN_SECS,this.x=[],this.y=[],this.cumulativeDistance=[],this.cumulativeDistance[0]=0,this.legTrackDistance=[],this.legTrackDistance[0]=0,this.cumulativeTrackDistance=[],this.cumulativeTrackDistance[0]=0,s.hasValidTrack?this.expandTrack(s.trackx,s.tracky,s.xysecs):this.expandTrack(n.x,n.y,s.splits),this.addTrackDistances(n,s)}addTrackDistances(e,s){const n=this.cumulativeDistance.length-1;if(e.codes!==void 0)if(s.splits.length>1)for(let i=1;i<e.codes.length;i+=1){let l;s.splits[i]<=n?l=s.splits[i]:l=n,this.cumulativeTrackDistance[i]=this.cumulativeDistance[l],this.legTrackDistance[i]=this.cumulativeTrackDistance[i]-this.cumulativeTrackDistance[i-1]}else this.legTrackDistance[1]=this.cumulativeDistance[n],this.cumulativeTrackDistance[1]=this.cumulativeDistance[n]}expandTrack(e,s,n){let i=0,l=0,r=e[0],o=s[0],m=0,y=0;this.x[0]=e[0],this.y[0]=s[0];let u=je();u===void 0&&(u=1);for(let p=1;p<n.length;p+=1){let v=e[p],I=s[p],E=v-r,T=I-o;y=y+Y(v,I,r,o)*u;let x=y-m;l=n[p],l===0&&(l=i+1);let R=l-i;for(let z=i+1;z<l;z+=1)this.x[z]=Math.round(r+(z-i)*E/R),this.y[z]=Math.round(o+(z-i)*T/R),this.cumulativeDistance[z]=Math.round(m+(z-i)*x/R);this.x[l]=v,this.y[l]=I,this.cumulativeDistance[l]=Math.round(y),r=v,o=I,m=y,i=l}}}const it=[{id:"rg2-stats-summary",title:"Summary",active:"true"},{id:"rg2-legs",title:"Leg times"},{id:"rg2-cumulative",title:"Cumulative times"},{id:"rg2-split-times",title:"Split times"},{id:"rg2-time-loss",title:"Time loss"},{id:"rg2-speed-stats",title:"Speed"}],vl=['<div id="rg2-stats-summary" class="container"></div><div style="height: 400px;"><canvas id="rg2-splits-chart"></canvas></div>','<div id="rg2-leg-table" style="width: 950px; height: 100%" class="ag-theme-balham"></div>','<div id="rg2-race-table" style="width: 950px; height: 100%;" class="ag-theme-balham"></div>',`<div id="rg2-results-table" class="rg2-results-table-container">
     <div id="rg2-results-grid-wrapper">
       <div id="rg2-results-grid" style="height: 100%" class="ag-theme-balham"></div>
     </div>
   </div>`,`<div id="rg2-time-loss" class="container">
     <div class="d-flex align-items-center justify-content-between">
       <div class="d-flex align-items-center">
         <div id="rg2-control-change" class="pe-4">
           <button id="rg2-stats-control-back" class="btn btn-outline-primary btn-sm p-2">&lt;</button>
           <button id="rg2-stats-control-forward" class="btn btn-outline-primary btn-sm p-2">&gt;</button>
         </div>
         <div id="rg2-control-number" class="fw-bold pe-2"></div>
       </div>
       <div id="rg2-loss-details" class="d-flex justify-content-center"></div>
     </div>
     <canvas id="rg2-loss-chart"></canvas>
   </div>`,'<div id="rg2-speed-stats" style="width: 950px; height: 100%" class="ag-theme-balham"></div>'],bl=`<div class="rg2-stats-runner-change pe-4">
      <button class="rg2-stats-name-back btn btn-outline-primary btn-sm p-2">
        &lt;
      </button>
      <button class="rg2-stats-name-forward btn btn-outline-primary btn-sm p-2">
        &gt;
      </button>
    </div >`,xl=`<div class="rg2-stats-course-change pe-4">
      <button class="rg2-stats-course-back btn btn-outline-primary btn-sm p-2">
        &lt;
      </button>
      <button class="rg2-stats-course-forward btn btn-outline-primary btn-sm p-2">
        &gt;
      </button>
    </div >`,Is={columnDefs:[{headerName:h("Control",""),field:"control",width:80},{headerName:h("Time",""),field:"time",width:80,comparator:Me.bind(void 0)},{headerName:h("Position",""),field:"position",width:75},{headerName:h("Performance",""),field:"performance",width:95,comparator:Tl.bind(void 0)},{headerName:h("Best",""),field:"best",width:80},{headerName:h("Who",""),field:"who",headerClass:"align-left",cellClass:t=>t.data.who.indexOf(t.data.name)>-1?"rg2-green-text align-left":"align-left",flex:1,tooltipField:"who"},{headerName:h("Behind",""),field:"behind",width:80,comparator:Me.bind(void 0)},{headerName:"%",field:"percent",width:60},{headerName:h("Predicted",""),field:"predicted",width:100,comparator:Me.bind(void 0)},{headerName:h("+/-",""),field:"loss",width:75,cellClass:t=>t.data.loss.substring(0,1)==="-"?"rg2-red-text align-center":"align-center",comparator:Me.bind(void 0)}],domLayout:"autoHeight",defaultColDef:{headerClass:"align-center",cellClass:"align-center",sortable:!0}},Ls={columnDefs:[{headerName:h("Control",""),field:"control",width:88},{headerName:h("Time",""),field:"time",width:85},{headerName:h("Position",""),field:"position",width:100},{headerName:h("Best",""),field:"best",width:85},{headerName:h("Who",""),field:"who",headerClass:"align-left",cellClass:t=>t.data.who.indexOf(t.data.name)>-1?"rg2-green-text align-left":"align-left",flex:1,tooltipField:"who"},{headerName:h("Behind",""),field:"behind",width:85},{headerName:"%",field:"percent",width:85},{headerName:"Loss",field:"loss",width:100}],domLayout:"autoHeight",defaultColDef:{headerClass:"align-center",cellClass:"align-center"}},Mt={domLayout:"autoHeight",rowClassRules:{"fw-bold":t=>t.data.name==="Total"},defaultColDef:{headerClass:"align-center",cellClass:"align-center",sortable:!0}};function Ft(t,e){let s=t.slice();if(s.length===0)return{mean:0,median:0,count:0};s.sort(function(o,m){return o-m});let n=0,i=s.length;if(e<100){const r=Math.max(parseInt(i*e/100,10),3);s.splice(r),i=s.length}for(let r=0;r<i;r+=1)n=n+s[r];let l;return i===1?l=s[0]:i%2===0?l=(s[i/2-1]+s[i/2])/2:l=s[Math.floor(i/2)],{mean:n/i,median:l,count:i}}function un(t){let e=0,s=0,n=0,i=9999;for(let r=1;r<t.legpos.length;r+=1)t.legpos[r]!==0&&(e+=t.legpos[r],s+=1,i>t.legpos[r]&&(i=t.legpos[r]),n<t.legpos[r]&&(n=t.legpos[r]));let l;return s>0?l=(e/s).toFixed(1):(l=0,i=0,n=0),{best:i,worst:n,average:l}}function El(t){return t.reduce((e,s)=>e+s,0)/t.length}function ws(t){return t==="-"?0:parseFloat(t)}function hn(t){if(t.length===0)return 0;const e=El(t);return Math.sqrt(t.reduce((s,n)=>s+Math.pow(n-e,2),0)/t.length)}function Ds(t){return t==="-"?0:parseFloat(t.replace(":","."))}function Sl(t){return!isNaN(parseFloat(t))&&isFinite(t)?t>0:!1}function Tl(t,e){return ws(t)-ws(e)}function Cs(t){if(t.value.split==="0:00")return"";let e=t.value.split,s="";return t.value.pos!==0&&(e+=" ("+t.value.pos+")",t.value.pos===1&&(s="rg2-first"),t.value.pos===2&&(s="rg2-second"),t.value.pos===3&&(s="rg2-third")),t.value.loss&&(s+=" rg2-lost-time"),'<span class="'+s+'">'+e+"</span>"}function As(t,e){return t.time===0?1:e.time===0?-1:t.time-e.time}function Me(t,e){return Ds(t)-Ds(e)}let w=null,pe=null,g=[],Re=[],Ge=!1,k=null,G=0,Ue="",dt="m",Q=[],ee=[],M=null,Je,Qe,F=1,kl=9,X=2;const fn="#rg2-stats-summary-tab-label";let Kt=fn,Zt=null;function Il(){if(k.excludeType===f.EXCLUDED_REAL_SPLITS)for(let t=0;t<g.length;t+=1){let e=0;for(let s=1;s<k.exclude.length;s+=1){if(k.exclude[s]){const n=Math.min(g[t].splits[s]-g[t].splits[s-1]-e,k.allowed[s]);e=e+n}g[t].splits[s]=g[t].splits[s]-e,g[t].legSplits[s]=g[t].splits[s]-g[t].splits[s-1]}}}function Ll(t){for(let e=0;e<g.length;e+=1){t===0&&(g[e].predictedSplits=[],g[e].loss=[],g[e].totalLoss=[]),g[e].predictedSplits[t]=[],g[e].predictedSplits[t][0]=0,g[e].loss[t]=[],g[e].loss[t][0]=0;let s=0;for(let n=0;n<G;n+=1)g[e].performanceIndex[t]>0?g[e].predictedSplits[t][n]=parseInt(k.refLegTime[t][n]/g[e].normalPerformanceIndex[t],10):g[e].predictedSplits[t][n]=g[e].legSplits[n],g[e].loss[t][n]=g[e].legSplits[n]-g[e].predictedSplits[t][n],g[e].loss[t][n]<0&&(g[e].loss[t][n]=0),s=s+g[e].loss[t][n];g[e].totalLoss[t]=s}}function wl(t){t===0&&(k.refLegTime=[],k.refTime=[]);let e=[],s=[];for(let n=0;n<G;n+=1){if(e.length=0,!k.exclude[n])for(let l=0;l<g.length;l+=1)g[l].iterSplits[t][n]!==0&&e.push(g[l].iterSplits[t][n]);const i=Ft(e,25);s.push(i.median)}k.refLegTime[t]=s.slice(0),k.refTime[t]=s.reduce((n,i)=>n+i);for(let n=0;n<g.length;n+=1){t===0&&(g[n].refRatio=[],g[n].performanceIndex=[],g[n].normalPerformanceIndex=[],g[n].totalSecs=[]),g[n].refRatio[t]=[];const i=[];for(let y=0;y<G;y+=1)g[n].iterSplits[t][y]===0?g[n].refRatio[t][y]=0:g[n].refRatio[t][y]=k.refLegTime[t][y]/g[n].iterSplits[t][y],i.push(g[n].refRatio[t][y]);const l=i.filter(y=>y>0),r=Ft(l,100);g[n].performanceIndex[t]=r.median,g[n].totalSecs[t]=g[n].iterSplits[t].reduce((y,u)=>y+u);let o=0,m=0;for(let y=0;y<G;y+=1)g[n].iterSplits[t][y]!==0&&(o=o+g[n].refRatio[t][y]*k.refLegTime[t][y],m=m+k.refLegTime[t][y]);g[n].normalPerformanceIndex[t]=o/m}}function Dl(t){for(let e=0;e<g.length;e+=1){t===0&&(g[e].iterSplits=[]);let s=[];for(let n=0;n<G;n+=1)t===0?s.push(g[e].legSplits[n]):s.push(g[e].predictedSplits[t-1][n]);g[e].iterSplits[t]=s.slice(0)}}function gn(){F=F===w.splits.length-1?1:F+1,Jt()}function mn(){F=F>1?F-1:w.splits.length-1,Jt()}function Ms(t){let e=w.rawid;try{let s=[];if(Ge){let n=Re.findIndex(i=>w.variant===i);t<0?n=n===Re.length-1?0:n+1:n=n>1?n-1:Re.length-1,s=an(Re[n])}else{const n=$n();let i=n.findIndex(r=>r?r.courseid===k.courseid:!1);t<0?i=i===n.length-1?1:i+1:i=i>1?i-1:n.length-1;const l=n[i].courseid;s=rn(l)}s.length>0&&(e=s[0].rawid)}catch(s){console.log("Error switching to new course: "+s)}ut(e)}function ct(t){t<0?M=M===g.length-1?0:M+1:M=M>0?M-1:g.length-1,ut(g[M].rawid)}function Cl(t){let e="",s="";w.splits.length-1===F?e=h("Finish"):(e=h("Control"),s=": "+F);let n=`<div>${e}${s}</div>`;if(document.getElementById("rg2-control-number").innerHTML=n,n="",k.exclude[F])n=h("Control excluded","");else{const i=t.filter(r=>r.loss>0).map(r=>r.loss),l=Ft(i,100);n=`<div class="px-2 fw-bold">${h("Runners with loss")}: ${l.count}</div >`,n+=`<div class="px-2 fw-bold">${h("Average")}: ${parseInt(l.mean,10)}s (${parseInt(l.mean*1e3/k.refLegTime[X][F],10)/10}%)</div>`,n+=`<div class="px-2 fw-bold">${h("Median")}: ${l.median}s (${parseInt(l.median*1e3/k.refLegTime[X][F],10)/10}%)</div>`}document.getElementById("rg2-loss-details").innerHTML=n}function Al(){document.getElementById("rg2-stats-panel-tab-headers").addEventListener("show.bs.tab",i=>{Gl(i.target)});const t=document.getElementsByClassName("rg2-stats-name-back");for(let i of t)i.addEventListener("click",()=>{ct(1)});const e=document.getElementsByClassName("rg2-stats-name-forward");for(let i of e)i.addEventListener("click",()=>{ct(-1)});const s=document.getElementsByClassName("rg2-stats-course-back");for(let i of s)i.addEventListener("click",()=>{Ms(1)});const n=document.getElementsByClassName("rg2-stats-course-forward");for(let i of n)i.addEventListener("click",()=>{Ms(-1)});document.getElementById("rg2-stats-control-back").addEventListener("click",mn),document.getElementById("rg2-stats-control-forward").addEventListener("click",gn),document.getElementById(Kt.replace("#","")).click()}function Jt(){Qe!==void 0&&(Qe.destroy(),Qe=void 0);const t=document.getElementById("rg2-loss-chart"),e=x=>l.length===0?f.DARK_GREEN_30:l[x.dataIndex].activeRunner?f.DARK_GREEN:f.DARK_GREEN_30,s=x=>l.length===0?f.RED_30:l[x.dataIndex].activeRunner?f.RED:f.RED_30,n=x=>l.length===0?f.BLUE_30:l[x.dataIndex].activeRunner?f.BLUE:f.BLUE_30,i=x=>l.length===0?f.PURPLE_30:l[x.dataIndex].activeRunner?f.PURPLE:f.PURPLE_30,l=[];k.exclude[F]||g.map(x=>{if(parseInt(x.legSplits[F],10)>0){let R={};const z=parseInt(x.loss[X][F],10),Le=parseInt(x.predictedSplits[X][F],10),we=parseInt(x.legSplits[F],10);R.loss=z,R.predicted=z===0?0:Le,R.rawPredicted=Le,R.actual=we<=Le?we:0,R.gain=we<=Le?Le-we:0,R.realSplit=we,R.pos=x.legpos[F],R.name=x.name,x.rawid===pe&&(R.activeRunner=!0),l.push(R)}}),l.sort((x,R)=>x.realSplit-R.realSplit);const r=l.map(x=>x.predicted),o=l.map(x=>x.actual),m=l.map(x=>x.loss),y=l.map(x=>x.gain),u=l.map(x=>x.pos),p=l.map(()=>k.refLegTime[X][F]),v=g.reduce((x,R)=>Math.max(x,R.legSplits[F]),0),I=120,E=parseInt((v+I-1)/I,10)*I;Cl(l),Qe=new Zt(t,{data:{labels:u,datasets:[{label:"Actual",type:"bar",data:o,backgroundColor:e},{label:"Gain",type:"bar",data:y,yAxisID:"yLoss",backgroundColor:n},{label:"Predicted",type:"bar",data:r,yAxisID:"yLoss",backgroundColor:i},{label:"Loss",type:"bar",data:m,yAxisID:"yLoss",backgroundColor:s},{label:"Reference time",type:"line",data:p,borderColor:f.RED,backgroundColor:f.WHITE,borderDash:[5,5],yAxisID:"yLoss",pointStyle:"circle",pointRadius:0,pointHoverRadius:0}]},options:{scales:{x:{stacked:!0,title:{display:!0,text:"Position"}},yLoss:{stacked:!0,min:0,max:E,title:{display:!0,text:"Time (s)"}}},plugins:{tooltip:{callbacks:{label(x){let R=x.dataset.label+": ";return x.dataset.label==="Loss"?R+=P(l[x.dataIndex].loss):x.dataset.label==="Gain"?R+=P(l[x.dataIndex].gain):x.dataset.label==="Actual"?R+=P(l[x.dataIndex].actual):R+=P(l[x.dataIndex].predicted),R},title(x){return l[x[0].dataIndex].name+": "+P(l[x[0].dataIndex].realSplit)}}}}}});const T=document.querySelector("#rg2-loss-chart");T.onwheel=x=>{x.preventDefault(),x.deltaY<0?gn():mn()}}function Ml(){F=1,Jt()}function Rl(){let t=[];for(let e=1;e<k.codes.length;e+=1){t.length=0;for(let i=0;i<g.length;i+=1)g[i].resultid===g[i].rawid&&(g[i].isScoreEvent?g[i].variant===k.courseid&&t.push({time:g[i].legSplits[e],id:i}):g[i].courseid===k.courseid&&t.push({time:g[i].legSplits[e],id:i}));t.sort(As);let s=0,n=0;for(let i=0;i<t.length;i+=1){if(k.exclude[e]){g[t[i].id].legpos[e]=0;continue}t[i].time!==n?t[i].time===0?(g[t[i].id].legpos[e]=0,n=0,s=0):(g[t[i].id].legpos[e]=i+1,n=t[i].time,s=i+1):g[t[i].id].legpos[e]=s}}t.length=0;for(let e=1;e<k.codes.length;e+=1){t.length=0;let s=0;for(let l=0;l<g.length;l+=1)g[l].resultid===g[l].rawid&&(g[l].isScoreEvent?g[l].variant===k.courseid&&(e>g[l].lastValidSplit?s=0:s=g[l].splits[e],t.push({time:s,id:l})):g[l].courseid===k.courseid&&(e>g[l].lastValidSplit?s=0:s=g[l].splits[e],t.push({time:s,id:l})));t.sort(As);let n=0,i=0;for(let l=0;l<t.length;l+=1)t[l].time!==i?t[l].time===0?(g[t[l].id].racepos[e]=0,n=0,i=0):(g[t[l].id].racepos[e]=l+1,i=t[l].time,n=l+1):g[t[l].id].racepos[e]=n}}function et(t,e){if(e<=0||t<=0)return"-";const s=t/60/(e/1e3),n=parseInt(s,10),i=parseInt((s-n)*60,10),l=n+":"+(i<10?"0"+i:i);return Ue===""?"("+l+")":l}function Bl(){const t=[],e=new zt(w.routeresultid);for(let l=0;l<w.splits.length;l+=1){let r={};r.name=w.name,l===0?r.control="S":l==w.splits.length-1?r.control="F":r.control=l+" ("+k.codes[l]+")",l===0?r.time="0:00":r.time=P(w.legSplits[l]),l===0||k.exclude[l]?r.length="-":r.length=k.legLengths[l],l===0||k.exclude[l]?r.speed="-":r.speed=et(w.legSplits[l],k.legLengths[l]),l===0||k.exclude[l]||!w.hasValidTrack||w.firstExcluded>0&&w.firstExcluded<=l?r.route="-":r.route=e.legTrackDistance[l],l===0||k.exclude[l]||!w.hasValidTrack||w.firstExcluded>0&&w.firstExcluded<=l?r.routespeed="-":r.routespeed=et(w.legSplits[l],e.legTrackDistance[l]),l===0||k.exclude[l]||!w.hasValidTrack||w.firstExcluded>0&&w.firstExcluded<=l?r.percent="-":r.percent=(100*e.legTrackDistance[l]/k.legLengths[l]).toFixed(1)+"%",t.push(r)}let s={};s.name="Total",s.control=h("Total",""),s.time=P(w.timeInSecs),s.length=k.length*1e3,s.speed=et(w.timeInSecs,k.length*1e3),w.hasValidTrack?(s.route=e.cumulativeTrackDistance[e.cumulativeTrackDistance.length-1],s.routespeed=et(w.timeInSecs,e.cumulativeTrackDistance[e.cumulativeTrackDistance.length-1]),s.percent=(100*e.cumulativeTrackDistance[e.cumulativeTrackDistance.length-1]/k.cumulativeLegLengths[k.cumulativeLegLengths.length-1]).toFixed(1)+"%"):(s.route="-",s.routespeed="-",s.percent="-"),t.push(s),Mt.rowData=t,Mt.columnDefs=[{headerName:h("Control",""),field:"control",width:80},{headerName:h("Time",""),field:"time",width:80,comparator:Me.bind(this)},{headerName:h("Length","")+" "+dt,field:"length",width:90},{headerName:h("Speed","")+" "+Ue,field:"speed",width:125},{headerName:h("Route","")+" "+dt,field:"route",width:90},{headerName:h("Speed","")+" "+Ue,field:"routespeed",width:125},{headerName:h("%",""),field:"percent",width:90}];const n=Mt,i=document.getElementById("rg2-speed-stats");i.innerHTML="",rg2Config.createGrid(i,n)}function Pl(){Je!==void 0&&(Je.destroy(),Je=void 0);const t=(E,T)=>E.p0.skip||E.p1.skip?T:void 0,e=document.getElementById("rg2-splits-chart"),s=g[M],n=s.legpos.map((E,T,x)=>T===x.length-1?"F":T),i=un(s),l=s.legpos.map(E=>E===0?NaN:E),r=s.loss[X].map((E,T)=>s.legpos[T]===0?NaN:E),o=s.predictedSplits[X].map((E,T)=>s.legpos[T]===0?NaN:E>s.legSplits[T]?E-s.legSplits[T]:0),m=s.legpos.map(()=>i.average),y=r.reduce((E,T)=>Math.max(E,isNaN(T)?0:T),0),u=o.reduce((E,T)=>Math.max(E,isNaN(T)?0:T),0),p=120,v=parseInt((Math.max(y,u)+p-1)/p,10)*p;Je=new Zt(e,{data:{labels:n,datasets:[{label:"Leg position",type:"line",data:l,borderColor:f.PURPLE,backgroundColor:f.PURPLE_30,yAxisID:"yPosition",segment:{borderColor:E=>t(E,"rgb(0,0,0,0.2)"),borderDash:E=>t(E,[6,6])},spanGaps:!0},{label:"Average leg position",type:"line",data:m,borderColor:f.RED,backgroundColor:f.WHITE,borderDash:[5,5],yAxisID:"yPosition",pointStyle:"circle",pointRadius:0,pointHoverRadius:0},{label:"Time loss",type:"bar",data:r,borderColor:f.RED,backgroundColor:f.RED_30,yAxisID:"yLoss",segment:{borderColor:E=>t(E,"rgb(0,0,0,0.2)"),borderDash:E=>t(E,[6,6])}},{label:"Time gain",type:"bar",data:o,borderColor:f.BLUE,backgroundColor:f.BLUE_30,yAxisID:"yLoss",segment:{borderColor:E=>t(E,"rgb(0,0,0,0.2)"),borderDash:E=>t(E,[6,6])}}]},options:{maintainAspectRatio:!1,responsive:!0,scales:{x:{min:1,title:{display:!0,text:h("Control","")},stacked:!0},yPosition:{type:"linear",display:!0,position:"left",min:0,max:parseInt((g.length+9)/10,10)*10,title:{display:!0,text:"Leg position"}},yLoss:{type:"linear",display:!0,position:"right",min:0,max:v,grid:{drawOnChartArea:!1},title:{display:!0,text:"Time gain/loss (s)"}}},plugins:{tooltip:{callbacks:{label:function(E){return E.dataset.label==="Time loss"?"Loss: "+P(r[E.dataIndex]):E.dataset.label==="Time gain"?"Gain: "+P(o[E.dataIndex]):E.dataset.label==="Leg position"?"Position: "+l[E.dataIndex]:""},title:function(E){return E[0].label==="F"?h("Finish",""):h("Control","")+" "+E[0].label}}}}}});const I=document.querySelector("#rg2-splits-chart");I.onwheel=E=>{E.preventDefault(),E.deltaY<0?ct(-1):ct(1)}}function _l(){const t=[{headerName:h("Pos",""),field:"position",cellDataType:"text",width:60,pinned:"left",sortable:!0},{headerName:h("Name",""),field:"name",cellDataType:"text",headerClass:"align-left",cellClass:"align-left",width:150,pinned:"left"},{headerName:"rawid",field:"rawid",cellDataType:"number",hide:!0},{headerName:h("Time",""),field:"time",cellDataType:"text",width:85}];for(let r=1;r<G-1;r+=1)t.push({headerName:r+" ("+k.codes[r]+")",field:"C"+r,cellDataType:"text",cellRenderer:Cs,width:110});t.push({headerName:h("F",""),field:"finish",cellDataType:"text",cellRenderer:Cs,width:110}),t.push({headerName:h("Loss",""),field:"loss",cellDataType:"text",width:100}),t.push({headerName:h("Performance",""),field:"performance",cellDataType:"text",width:100}),t.push({headerName:h("Consistency",""),field:"consistency",cellDataType:"text",width:100});let e=[];g.sort(function(r,o){return r.racepos[r.splits.length-1]<=0?1:o.racepos[o.splits.length-1]<=0?-1:r.racepos[r.splits.length-1]-o.racepos[o.splits.length-1]}),M=yn(pe);for(let r=0;r<g.length;r+=1){let o={};const m=g[r];m.racepos[G-1]==0?o.position="":o.position=m.racepos[G-1],o.name=m.name,o.rawid=m.rawid,o.time=m.time;for(let u=1;u<G-1;u+=1)m.splits[u]===m.splits[u-1]?o["C"+u]={split:"0:00",pos:m.racepos[u],loss:!1}:o["C"+u]={split:P(m.splits[u]),pos:m.racepos[u],loss:!1};o.finish={split:P(m.splits[G-1]),pos:m.racepos[G-1]},o.loss=P(m.timeInSecs-m.totalLoss[X]),o.performance=(m.performanceIndex[0]*100).toFixed(1);const y=m.refRatio[0].filter(u=>u>0);o.consistency=(100*hn(y)).toFixed(1),e.push(o),o={},o.rawid=m.rawid;for(let u=1;u<G-1;u+=1)o["C"+u]={split:P(m.legSplits[u]),pos:m.legpos[u],loss:m.loss[X][u]>19};o.finish={split:P(m.legSplits[G-1]),pos:m.legpos[G-1],loss:m.loss[X][G-1]>19},o.loss=P(m.totalLoss[X]),e.push(o)}const s={columnDefs:t,rowData:e,defaultColDef:{headerClass:"align-center",cellClass:"align-center"},rowClassRules:{"rg2-active-runner":r=>r.data.rawid===pe}},n=document.getElementById("rg2-map-canvas").height*.98-120,i=document.getElementById("rg2-results-grid-wrapper");i.removeAttribute("style"),i.setAttribute("style","height: "+n+"px;");const l=document.getElementById("rg2-results-grid");l.innerHTML="",rg2Config.createGrid(l,s)}function Nl(){const t=un(w),e=o=>`${o}`;let s=e('<div class="d-flex align-items-center justify-content-between pb-4">');s+=e('<div class="d-flex align-items-center">'),s+=e(`${bl}`),s+=e(`<div class="fw-bold pe-4">${w.name}</div>`),s+=e(`<div class="fw-bold pe-4">${w.time}</div>`),s+=e(`<div class="fw-bold pe-4">(${g[M].racepos[G-1]}/${g.length})</div>`);let n="";Sl(w.timeInSecs)&&(n=` (${(100*g[M].totalLoss[X]/w.timeInSecs).toFixed(1)}%)`),s+=e(`<div class="fw-bold pe-4">${h("Estimated loss")}: ${P(g[M].totalLoss[X])}${n}</div>`),s+=e("</div>"),s+=e('<div class="d-flex align-items-center">');const i=Ge?"V"+w.variant+"&nbsp;":"";s+=e(`<div class="fw-bold pe-4">${i}${w.coursename}</div><div>${xl}</div>`),s+=e("</div></div>");const l=document.getElementsByClassName("rg2-stats-title-row");for(let o of l)o.innerHTML=s;s='<div class="d-flex align-items-center">',s+=e(`<div class="fw-bold pe-4">${h("Average leg position")}: ${t.average} (${h("Best","")}: ${t.best}, ${h("Worst")}: ${t.worst})</div >`),s+=e(`<div  class="fw-bold pe-4">${h("Performance")} ${(w.performanceIndex[0]*100).toFixed(1)}%</div>`);const r=g[M].refRatio[0].filter(o=>o>0);s+=e(`<div  class="fw-bold">${h("Consistency")} ${(100*hn(r)).toFixed(1)}%</div>`),s+=e("</div>"),document.getElementById("rg2-stats-summary").innerHTML=s}function Ol(){const t=[];for(let n=0;n<g[M].splits.length;n+=1){let i={};if(i.name=w.name,n===0?i.control="S":n==g[M].splits.length-1?i.control="F":i.control=n+" ("+k.codes[n]+")",n===0?i.time="0:00":i.time=P(g[M].legSplits[n]),n===0||g[M].legpos[n]===0||k.exclude[n]?i.position="-":i.position=g[M].legpos[n],n===0||k.exclude[n]?i.performance="-":i.performance=(100*g[M].refRatio[0][n]).toFixed(1),k.exclude[n]?i.best="-":i.best=P(Q[n][0].t),n===0||k.exclude[n])i.who="-";else{let r=Q[n][0].name;for(let o=1;o<Q[n].length&&Q[n][0].t===Q[n][o].t;o+=1)r+=", "+Q[n][o].name;i.who=r}const l=g[M].legSplits[n]-Q[n][0].t;if(n===0||g[M].legSplits[n]<=0?i.behind="-":i.behind=P(l),n===0||g[M].legSplits[n]<=0?i.percent=0:i.percent=parseInt(l*100/Q[n][0].t,10),k.exclude[n]?i.predicted="-":i.predicted=P(g[M].predictedSplits[X][n]),g[M].legSplits[n]<=0)i.loss="";else{const r=g[M].predictedSplits[X][n]-g[M].legSplits[n];i.loss=r>=0?P(r):"-"+P(r*-1)}t.push(i)}Is.rowData=t;const e=Is,s=document.getElementById("rg2-leg-table");s.innerHTML="",rg2Config.createGrid(s,e)}function $l(){const t=[];let e=0;for(let i=0;i<g[M].splits.length;i+=1){let l={};if(l.name=w.name,i==0?l.control="S":i==g[M].splits.length-1?l.control="F":l.control=i+" ("+k.codes[i]+")",i==0?l.time="0:00":g[M].splits[i]===g[M].splits[i-1]?l.time="":l.time=P(g[M].splits[i]),i===0||g[M].racepos[i]===0?l.position="-":l.position=g[M].racepos[i],l.best=P(ee[i][0].t),i===0)l.who="-";else{let o=ee[i][0].name;for(let m=1;m<ee[i].length&&ee[i][0].t===ee[i][m].t;m+=1)o+=", "+ee[i][m].name;l.who=o}const r=g[M].splits[i]-ee[i][0].t;i===0||g[M].racepos[i]===0?l.behind="-":l.behind=P(r),i===0||g[M].racepos[i]===0?l.percent="-":l.percent=parseInt(r*100/ee[i][0].t,10),e=e+g[M].loss[X][i],l.loss=P(e),t.push(l)}Ls.rowData=t;const s=Ls,n=document.getElementById("rg2-race-table");n.innerHTML="",rg2Config.createGrid(n,s)}function Fl(){let t='<ul class="nav nav-pills" id="rg2-stats-panel-tab-headers" role="tablist">';for(let e of it){const s=h(e.title),n=e.active?" active":"",i=e.active?"":"tabindex='-1'";t+=`<li class="nav-item${n}" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#${e.id}-tab"
      type="button" role="tab" ${i}>
      <div id="${e.id}-tab-label">${s}</div>
    </button>
    </li>`}return t+="</ul>",t}function Hl(){const t='<div class="rg2-stats-title-row container"></div>';let e='<div id="rg2-stats-table"><div class="tab-content" id="rg2-stats-panel-tab-body">';for(let s=0;s<it.length;s+=1){const n=it[s].active?" active":"";e+=`<div class="tab-pane fade ${n} pt-2" id="${it[s].id}-tab" role="tabpanel" tabindex="${s}">
      ${t}${vl[s]}</div>`}return e+="</div></div></div>",e}function Gl(t){var e;Kt=(e=t==null?void 0:t.dataset)==null?void 0:e.bsTarget}async function Ul(){const{createGrid:t,ModuleRegistry:e}=await st(async()=>{const{createGrid:i,ModuleRegistry:l}=await import("./grid-CJy_EU0E.js").then(r=>r.m);return{createGrid:i,ModuleRegistry:l}},[],import.meta.url);rg2Config.createGrid=t;const{ClientSideRowModelModule:s}=await st(async()=>{const{ClientSideRowModelModule:i}=await import("./grid-CJy_EU0E.js").then(l=>l.a);return{ClientSideRowModelModule:i}},[],import.meta.url);Zt=(await st(()=>import("./node-modules-DcNSr3-7.js").then(i=>i.b),[],import.meta.url)).default,e.registerModules([s])}function Vl(t){pe=t,Ge=gt(),je()===void 0?(Ue="",dt="px"):(Ue="min/km",dt="m"),w=dn(pe),Ge?(Re=nl(),g=an(w.variant)):g=rn(w.courseid),Yl(w.courseid),Il(),Rl(),M=yn(pe)}function Yl(t){if(Ge?k=new Nn({courseid:w.variant,name:"V"+w.variant,codes:w.scorecodes,xpos:w.scorex,ypos:w.scorey,exclude:[],allowed:[],excludeType:0},!0):k=J(t),G=k.codes.length,G<=2)throw new pn(h("No splits available."));Q.length=0,ee.length=0;let e=[],s=[];for(let n=0;n<G;n+=1){e.length=0,s.length=0;for(let i=0;i<g.length;i+=1)n===0?(e.push({t:0,name:"",pos:0}),s.push({t:0,name:"",pos:0})):(e.push({t:g[i].legSplits[n],name:g[i].name,pos:g[i].legpos[n]}),n<=g[i].lastValidSplit&&s.push({t:g[i].splits[n],name:g[i].name,pos:g[i].racepos[n]}));e.sort(function(i,l){return i.t===0?1:l.t===0?-1:i.t-l.t}),s.sort(function(i,l){return i.t-l.t}),Q.push(e.slice()),ee.push(s.slice())}}function Wl(){for(let t=0;t<=kl;t+=1)Dl(t),wl(t),Ll(t)}function ut(t){try{return Vl(t),Wl(),Nl(),Pl(),Ml(),Ol(),$l(),_l(),Bl(),Al(),!0}catch(e){e instanceof pn?V(h("Statistics"),e.message):V(h("Statistics",""),h("Data inconsistency.","")),bt.getInstance(document.getElementById("rg2-right-info-panel")).hide()}return!1}function pn(t){this.message=t}function yn(t){for(let e=0;e<g.length;e+=1)if(g[e].rawid===t)return w=g[e],e;return null}function Xl(t,e){if(!is())return V(h("Statistics",""),h("No statistics available for this event format.","")),!1;Kt=fn,rg2Config.createGrid?ut(t)&&e():Ul().then(()=>{ut(t)&&e()}).catch(()=>{console.log("Error loading Grid and Chart"),V("Error loading Grid and Chart","Statistics functionality failed to load.")})}const Ht=document.getElementById("rg2-show-info-panel-control"),oe=document.getElementById("rg2-right-info-panel"),Qt=document.getElementById("rg2-right-info-panel-title"),es=new bt(oe,{backdrop:!1}),ye=document.getElementById("rg2-left-info-panel"),Rs=document.getElementById("rg2-left-info-panel-title");let Bs=document.getElementById("rg2-left-info-panel-body");const vn=new bt(ye,{backdrop:!1});ye.style.width="420px";ye.addEventListener("hidden.bs.offcanvas",()=>{Ht.classList.remove("d-none")});ts();const Rt=10,Bt=-10;function ql(){return!document.getElementById("rg2-animation-controls").classList.contains("d-none")}function jl(){document.querySelector("label[for=rg2-select-course]").innerHTML=`${h("Select course")}`,document.querySelector("label[for=rg2-select-name]").innerHTML=`${h("Select name")}`,document.querySelector("label[for=rg2-name-entry]").innerHTML=h("Name"),document.querySelector("#rg2-name-entry").addEventListener("input",()=>{$s()}),document.querySelector("label[for=rg2-time-entry]").innerHTML=h("Time"),document.querySelector("#rg2-time-entry").addEventListener("input",()=>{$s()});const t=document.getElementById("rg2-new-comments");t.setAttribute("placeholder",h(f.DEFAULT_NEW_COMMENT,"")),t.addEventListener("focus",()=>{document.getElementById("rg2-new-comments").setAttribute("placeholder","")});const e=document.getElementById("btn-three-seconds");e.innerHTML=h("+3 secs"),e.addEventListener("click",u=>{u.preventDefault(),Fr()});const s=document.getElementById("btn-undo");s.innerHTML=h("Undo"),s.addEventListener("click",u=>{u.preventDefault(),$r()});const n=document.getElementById("btn-save-route");n.innerHTML=h("Save"),n.addEventListener("click",u=>{u.preventDefault(),Rr()});const i=document.getElementById("btn-reset-drawing");i.innerHTML=h("Reset"),i.addEventListener("click",u=>{u.preventDefault(),Dr()}),document.getElementById("rg2-load-gps-title").innerHTML=h("Load GPS file (GPX or TCX)"),document.getElementById("btn-offset-plus").addEventListener("click",()=>{const u=document.getElementById("rg2-offset-value");let p=parseInt(u.value,10);p<Rt&&(p=p+1,u.value=p,Pt(p))}),document.getElementById("btn-offset-minus").addEventListener("click",()=>{const u=document.getElementById("rg2-offset-value");let p=parseInt(u.value,10);p>Bt&&(p=p-1,u.value=p,Pt(p))}),document.getElementById("rg2-offset-value").addEventListener("input",()=>{const u=document.getElementById("rg2-offset-value");let p=parseInt(u.value,10);isNaN(p)&&(p=0),p<Bt&&(p=Bt),p>Rt&&(p=Rt),u.value=p,Pt(p)});const l=document.getElementById("btn-undo-gps-adjust");l.innerHTML=h("Undo"),l.addEventListener("click",u=>{u.preventDefault(),Or()});const r=document.getElementById("btn-autofit-gps");r.innerHTML=h("Autofit"),r.addEventListener("click",u=>{u.preventDefault(),dr()}),document.querySelector("label[for=chk-move-all]").innerHTML=h("Move track and map together (or right click-drag)");const o=document.getElementById("btn-save-gps-route");o.innerHTML=h("Save GPS route"),o.addEventListener("click",u=>{u.preventDefault(),Mr()}),["Left click to add/lock/unlock a handle","Green - draggable","Red - locked","Right click to delete a handle","Drag a handle to adjust track around locked point(s)"].forEach((u,p)=>{const v=document.getElementById(`draw-text-${p+1}`);v.innerHTML=`${h(u)}.`}),document.getElementById("rg2-load-gps-file").addEventListener("input",u=>{wr(u)})}function zl(){document.querySelector("label[for=rg2-select-language]").innerHTML=`${h("Language")}`,fi(f.languages),lt("chk-show-GPS-speed","showGPSSpeed","Show GPS speed colours"),lt("chk-snap-toggle","snap","Snap to control when drawing"),lt("chk-show-three-seconds","showThreeSeconds","Show +3 time loss for GPS routes"),me("map-intensity","perCentMapIntensity","Map intensity","%"),me("route-intensity","perCentRouteIntensity","Route intensity","%"),me("control-circle","circleSize","Control circle size"),me("course-width","courseWidth","Course overprint width"),me("route-width","routeWidth","Route width"),me("name-font-size","replayFontSize","Replay label font size");const t=document.getElementById("rg2-gps-speed-slider");t.setAttribute("value1",C.maxSpeed),t.setAttribute("value2",C.minSpeed),t.addEventListener("change",er),document.getElementById("rg2-min-gps-speed-label").innerHTML=xn(),document.getElementById("rg2-max-gps-speed-label").innerHTML=bn()}function lt(t,e,s){document.querySelector(`label[for=${t}]`).innerHTML=`${h(s)}`;const n=document.getElementById(t);n.addEventListener("click",i=>{C[e]=i.target.checked,xt(),D()}),n.checked=C[e]}function me(t,e,s,n=""){let i=document.querySelector(`label[for=spn-${t}]`);i.innerHTML=`${h(s)} ${C[e]}${n}`;let l=document.getElementById(`spn-${t}`);l.setAttribute("value",C[e]),l.addEventListener("change",r=>{Ii(e,parseInt(r.target.value,10)),i=document.querySelector(`label[for=spn-${t}`),i.innerHTML=`${h(s)} ${C[e]}${n}`,D()})}function Kl(){document.body.addEventListener("contextmenu",n=>{n.preventDefault()}),window.addEventListener("resize",()=>{ts(),li()}),document.getElementById("rg2-left-info-panel-body").addEventListener("scroll",n=>{document.getElementById("rg2-info-panel").setAttribute(En(),n.target.scrollTop)}),sr(),f.managing()||jl(),Ps(),document.getElementById("rg2-logo").addEventListener("click",()=>{vn.toggle()}),document.querySelector("#rg2-info-panel-tab-headers").querySelectorAll('button[data-bs-toggle="tab"]').forEach(n=>{n.addEventListener("shown.bs.tab",i=>{lr(i)})}),Ht.addEventListener("click",()=>{Ps(),Ht.classList.add("d-none")}),tr()}function Zl(){if(f.managing())return;let t=document.getElementById("rg2-event-list");t.innerHTML=Vr();let e=document.getElementById("rg2-event-table"),s=document.getElementById("rg2-event-search");s.innerHTML=`<form class="d-flex pb-2" role="search">
  <input class="form-control mr-2" type="search" aria-label="${h("Search")}">
  <i class="bi-search ms-2 mt-2"></i>
  </form>`,s.addEventListener("keyup",n=>{let i=n.target.value.toUpperCase(),l=e.getElementsByTagName("tr");for(let r=0;r<l.length;r+=1)l[r].innerText.toUpperCase().indexOf(i)>-1?l[r].classList.remove("d-none"):l[r].classList.add("d-none")}),e.addEventListener("click",n=>{const i=n.target.closest("tr"),l=parseInt(i.dataset.kartatid,10);isNaN(l)||kt(l)})}function Jl(){oe.style.width="800px",Qt.innerHTML="RG2 Version "+f.RG2VERSION,document.getElementById("rg2-about-dialog").classList.remove("d-none"),document.getElementById("rg2-option-controls").classList.add("d-none"),document.getElementById("rg2-stats-dialog").classList.add("d-none");let t=document.getElementById("rg2-event-stats");t.innerHTML=zr(),document.getElementById("rg2-manager-link").innerHTML=`<a href="${rg2Config.api_url.replace("rg2api.php","?manage")}">Manager Login</a>`,es.show()}function Ps(){vn.show()}function Ql(){oe.style.width="420px",Qt.innerHTML=h("Configuration options"),document.getElementById("rg2-about-dialog").classList.add("d-none"),document.getElementById("rg2-option-controls").classList.remove("d-none"),document.getElementById("rg2-stats-dialog").classList.add("d-none"),zl(),es.show()}function Gt(t){oe.style.width="1000px",Qt.innerHTML=Fl(),document.getElementById("rg2-stats-dialog").innerHTML=Hl(),document.getElementById("rg2-about-dialog").classList.add("d-none"),document.getElementById("rg2-option-controls").classList.add("d-none"),document.getElementById("rg2-stats-dialog").classList.remove("d-none"),Xl(t,function(){es.show()})}function ke(){return document.querySelector("#rg2-info-panel-tab-headers button.active").id}function _s(t){let e='<div id="rg2-info-panel">';e+='<div class="tab-content" id="rg2-info-panel-tab-body">';for(let s=0;s<t.length;s=s+1){const n=document.getElementById(t[s].body),i=t[s].active?" active show":"";e+=`<div class="tab-pane fade ${i}" id="rg2-${t[s].name}-body" role="tabpanel" 
    aria-labelledby="${t[s].name}" tabindex="${s}">${n.innerHTML}</div>`,n.remove()}return e+="</div></div>",e}function Ns(t){let e='<ul class="nav nav-pills" id="rg2-info-panel-tab-headers" role="tablist">';for(let s=0;s<t.length;s=s+1){const n=t[s].hidden?" d-none":"",i=t[s].active?" active":"",l=t[s].disabled?" disabled ":"";e+=`
    <li class="nav-item" role="presentation">
      <button class="nav-link${i}${n}"${l}id="${t[s].name}" data-bs-toggle="tab"
      data-bs-target="#rg2-${t[s].name}-body"
        type="button" role="tab"><div id="${t[s].name}-label">${h(t[s].title)}</div>
      </button>
    </li>`}return e+="</ul>",e}function bn(){return`<i class="bi-emoji-smile rg2-run-green"></i> ${C.maxSpeed.toFixed(1)} min/km`}function xn(){return`<i class="bi-emoji-smile rg2-run-red"></i> ${C.minSpeed.toFixed(1)} min/km`}function En(){return`scroll-${ke()}`}function er(t){C.maxSpeed=t.detail.value1,C.minSpeed=t.detail.value2;const e=document.getElementById("rg2-min-gps-speed-label");e.innerHTML=xn();const s=document.getElementById("rg2-max-gps-speed-label");s.innerHTML=bn(),rl(),D()}function tr(){document.getElementById("btn-about").addEventListener("click",t=>{Jl()}),document.getElementById("btn-settings").addEventListener("click",t=>{Ql()}),document.getElementById("btn-toggle-controls").addEventListener("click",()=>{W.toggleControlDisplay(),D()}),document.getElementById("btn-stats").addEventListener("click",()=>{Gt(1)}),document.getElementById("btn-splitsbrowser").addEventListener("click",()=>{window.open(rg2Config.api_url+"?type=splitsbrowser&id="+fe()+"&_="+Date.now())}),document.getElementById("btn-measure").setAttribute("disabled",""),document.getElementById("btn-runners").setAttribute("disabled",""),document.getElementById("btn-toggle-controls").setAttribute("disabled",""),document.getElementById("btn-stats").setAttribute("disabled",""),document.getElementById("btn-splitsbrowser").setAttribute("disabled","")}function sr(){const t=[{name:f.TAB_EVENTS,title:"Events",body:"rg2-event-body",active:!0},{name:f.TAB_COURSES,title:"Courses",body:"rg2-course-body",disabled:!0},{name:f.TAB_RESULTS,title:"Results",body:"rg2-result-body",disabled:!0},{name:f.TAB_DRAW,title:"Draw",body:"rg2-draw-body",disabled:!0}],e=[{name:f.TAB_LOGIN,title:"Login",body:"rg2-login-body",active:!0},{name:f.TAB_CREATE,title:"Add event",body:"rg2-add-event-body",hidden:!0},{name:f.TAB_EDIT,title:"Edit event",body:"rg2-edit-event-body",hidden:!0},{name:f.TAB_MAP,title:"Add map",body:"rg2-add-map-body",hidden:!0},{name:f.TAB_DELETE_MAP,title:"Delete maps",body:"rg2-delete-maps-body",hidden:!0}];f.managing()?(Rs.innerHTML=Ns(e),Bs.innerHTML=_s(e)):(Rs.innerHTML=Ns(t),Bs.innerHTML=_s(t))}function nr(){na(),ln(void 0),document.getElementById("rg2-select-name").setAttribute("disabled",""),is()?(document.getElementById("rg2-name-select").classList.remove("d-none"),document.getElementById("rg2-enter-name-and-time").classList.add("d-none")):(document.getElementById("rg2-name-select").classList.add("d-none"),document.getElementById("rg2-enter-name-and-time").classList.remove("d-none")),lt("chk-align-map","alignMap","Align map to next control"),document.getElementById("btn-three-seconds").setAttribute("disabled",""),document.getElementById("btn-undo").setAttribute("disabled",""),document.getElementById("btn-save-route").setAttribute("disabled",""),document.getElementById("btn-reset-drawing").setAttribute("disabled",""),document.getElementById("rg2-load-gps-file").setAttribute("disabled",""),document.getElementById("btn-autofit-gps").setAttribute("disabled",""),document.getElementById("btn-undo-gps-adjust").setAttribute("disabled",""),document.getElementById("btn-save-gps-route").setAttribute("disabled",""),document.getElementById("chk-move-all").checked=!1}function ts(){const t=document.getElementById("rg2-header-container").offsetHeight,e=ql()?document.getElementById("rg2-animation-controls").offsetHeight:0;ye.style.top=`${t}px`,oe.style.top=`${t}px`,ye.style.bottom=`${e}px`,oe.style.bottom=`${e}px`,ye.style.maxWidth=`${window.innerWidth}px`,oe.style.maxWidth=`${window.innerWidth}px`,document.getElementById("rg2-track-names").style.maxHeight=`${window.innerHeight-t-10}px`}function ir(){document.querySelectorAll(".showcourse").forEach(u=>{u.addEventListener("click",p=>{const v=parseInt(p.target.dataset.courseid,10);ze(v,p.target.checked);const I=document.querySelectorAll(".showcourse");for(let T of I)parseInt(T.dataset.courseid,10)===v&&(T.checked=p.target.checked);const E=document.querySelector(".showallcourses");E.checked=sa(),_e(v),ps(Hs()),D()})}),document.querySelector(".showallcourses").addEventListener("click",u=>{Hn(u.target.checked);const p=document.querySelectorAll(".showcourse");for(let v of p)v.checked=u.target.checked;Gs(),ps(Hs()),D()}),document.querySelectorAll(".showscorecourse").forEach(u=>{u.addEventListener("click",p=>{Ui(parseInt(p.target.dataset.courseid,10),p.target.checked),D()})}),document.querySelectorAll(".showtrack").forEach(u=>{u.addEventListener("click",p=>{const v=parseInt(p.target.dataset.id,10);pl(v,p.target.checked);const I=parseInt(p.target.dataset.courseid,10);document.querySelectorAll(".allcoursetracks").forEach(x=>{parseInt(x.dataset.courseid,10)===I&&(x.checked=Oi(I))}),document.querySelectorAll(".alltracks").forEach(x=>{x.checked=bs()}),_e(I),Ct(At()),D()})});const i=document.querySelectorAll(".deleteroute");for(let u of i)u.addEventListener("click",p=>{hr(parseInt(p.target.dataset.resultidx,10))});const l=document.querySelectorAll(".allcoursetracks");for(let u of l)u.addEventListener("click",p=>{let v=parseInt(p.target.dataset.courseid,10);ks(v,p.target.checked);const I=document.querySelectorAll(".allcoursetracks");for(let x of I)parseInt(x.dataset.courseid,10)===v&&(x.checked=p.target.checked);const E=document.querySelectorAll(".showtrack");for(let x of E)parseInt(x.dataset.courseid,10)===v&&(x.checked=p.target.checked);const T=document.querySelectorAll(".alltracks");for(let x of T)x.checked=bs();_e(v),Ct(At()),D()});const r=document.querySelectorAll(".alltracks");for(let u of r)u.addEventListener("click",p=>{ks(f.DISPLAY_ALL_COURSES,p.target.checked);const v=document.querySelectorAll(".allcoursetracks");for(let E of v)E.checked=p.target.checked;const I=document.querySelectorAll(".showtrack");for(let E of I)E.checked=p.target.checked;Gs(p.target.checked),Ct(At()),D()});const o=document.querySelectorAll(".showreplay");for(let u of o)u.addEventListener("click",p=>{let v=parseInt(p.target.dataset.id,10);p.target.checked?Yn(new zt(v)):zn(v);const I=zi(v),E=document.querySelectorAll(".allcoursetracksreplay");for(let x of E)parseInt(x.dataset.courseid,10)===I&&(x.checked=xs(I));const T=document.querySelectorAll(".allcoursereplay");for(let x of T)x.checked=vs(I);D()});const m=document.querySelectorAll(".allcoursetracksreplay");for(let u of m)u.addEventListener("click",p=>{let v=parseInt(p.target.dataset.courseid,10);const I=qi(v);Vs(I,p.target.checked);const E=document.querySelectorAll(".showreplay.showtrackreplay");for(let R of E)parseInt(R.dataset.courseid,10)===v&&(R.checked=p.target.checked);const T=document.querySelectorAll(".allcoursetracksreplay");for(let R of T)parseInt(R.dataset.courseid,10)===v&&(R.checked=p.target.checked);let x=document.querySelectorAll(".allcoursereplay");for(let R of x)parseInt(R.dataset.courseid,10)===v&&(R.checked=vs(v));D()});const y=document.querySelectorAll(".allcoursereplay");for(let u of y)u.addEventListener("click",p=>{const v=parseInt(p.target.dataset.courseid,10),I=Xi(v);Vs(I,p.target.checked);const E=document.querySelectorAll(".showreplay");for(let x of E)parseInt(x.dataset.courseid,10)===v&&(x.checked=p.target.checked);const T=document.querySelectorAll(".allcoursetracksreplay");for(let x of T)parseInt(x.dataset.courseid,10)===v&&(x.checked=xs(v));D()})}function lr(t){switch(t.target.id){case f.TAB_DRAW:Hn(!1),Nr();break}const e=document.getElementById("rg2-info-panel").getAttribute(En());document.getElementById("rg2-left-info-panel-body").scrollTop=e,D()}const rr=50,Ce=20;let ht=null,ft=[],Ve=!1,Os="#ff0000",Sn=null,c=new sn;c.routeData=new Et;let Tt=null,N=[],U=[],ss=[],$=0,ie=0,Ee=!1;function ar(t,e){Ve&&(cr(t,e)?(Ut(N[$],U[$]),kn($),ie=$,$=Ln($),$===N.length&&(document.getElementById("btn-save-route").removeAttribute("disabled"),Ze())):Ut(Math.round(t),Math.round(e)),document.getElementById("btn-undo").removeAttribute("disabled"),D())}function Ut(t,e){c.routeData.x.push(t),c.routeData.y.push(e)}function or(t,e,s){const n=c.handles.getPreviousLockedHandle(s),i=c.handles.getNextLockedHandle(s);Pe(t,e,n,n.time,s.time),Pe(t,e,i,s.time,i.time)}function Pt(t){c.adjustOffset(t)}function Tn(t,e,s=void 0){if(document.getElementById("chk-move-all").checked||s===f.RIGHT_CLICK)a.translate(e.x-t.x,e.y-t.y);else if(c.handles.handlesLocked()>0)if(c.handles.handlesLocked()===1)Pe(t,e,c.handles.getSingleLockedHandle(),c.handles.getStartHandle().time,c.handles.getFinishHandle().time);else{let l=c.handles.getHandleClicked(t);if(l===void 0||l.locked)return;const r=c.handles.getEarliestLockedHandle(),o=c.handles.getLatestLockedHandle();r.time>=l.time?Pe(t,e,r,c.handles.getStartHandle().time,r.time):o.time<l.time?Pe(t,e,o,o.time,c.handles.getFinishHandle().time):or(t,e,l)}else yr(e.x-t.x,e.y-t.y)}function kn(t){if(C.alignMap&&t<N.length-1){Ve=!1,ft=[];const e=N[t],s=U[t],n=N[t+1],i=U[t+1],l=cs(),r=ti(),o=Y(e,s,n,i),m=Y(l.x,l.y,r.x,r.y);let y=Math.min(m/o,f.MAX_ZOOM);y=Math.max(y,f.MIN_ZOOM);let u;Ee?u=ue(N[t],U[t],N[t+1],U[t+1]):u=ss[t];let p=(a.displayAngle-u-Math.PI/2)%(Math.PI*2);p<-1*Math.PI&&(p=p+2*Math.PI);for(let v=1;v<=Ce;v=v+1){let I={};I.x=l.x-(l.x-e)*v/Ce,I.y=l.y-(l.y-s)*v/Ce,I.angle=(a.displayAngle-p*v/Ce)%(Math.PI*2),I.scale=Math.pow(y,1/Ce),ft.push(I)}ht=setInterval(()=>{Ir()},rr)}else wt(0,N[t],U[t],!1,1),Ve=!0,ht=null}function dr(){c.autofitTrack()}function cr(t,e){let s=C.snap?8:2;return Math.abs(t-N[$])<s&&Math.abs(e-U[$])<s}function ur(){let t={};t.body="The route you have started to draw will be discarded. Are you sure you want to change the course?",t.title="Confirm course change",t.doText="Change course",t.onDo=gr,t.onCancel=fr,jt(t)}function hr(t){Sn=t;let e={};e.body="This route will be permanently deleted. Are you sure?",e.title="Confirm route delete",e.doText="Delete route",e.onDo=mr,jt(e)}function fr(){document.getElementById("rg2-select-course").value=c.routeData.courseid,document.getElementById("rg2-select-name").value=c.routeData.resultid,Tt=null}function gr(){ns(),Vt(Tt)}function mr(){const t=Zi(Sn),e={type:"deletemyroute",id:fe(),routeid:t.id};Zs(JSON.stringify({token:t.token}),e,Tr,"Route save failed")}function ns(){c.routeData.courseid!==null&&ze(c.routeData.courseid,!1),c.routeData.resultid!==null&&He(c.routeData.resultid,!1),wn()}function In(){Br();const t={type:"addroute",id:c.routeData.eventid};Zs(JSON.stringify(c.routeData),t,kr(c.routeData.name),"Route save failed"),ns()}function pr(){c.fileLoaded&&(c.savedBaseX=c.baseX.slice(0),c.savedBaseY=c.baseY.slice(0),c.baseX=c.routeData.x.slice(0),c.baseY=c.routeData.y.slice(0),c.handles.saveForUndo(),c.handles.rebaselineXY(),document.getElementById("btn-undo-gps-adjust").removeAttribute("disabled"))}function yr(t,e){for(let s=0;s<c.baseX.length;s+=1)c.routeData.x[s]=c.baseX[s]+t,c.routeData.y[s]=c.baseY[s]+e;c.handles.dragHandles(t,e)}function _t(t){a.arc(N[$],U[$],t,0,2*Math.PI,!1),a.fill()}function vr(){const t=Fe();a.lineWidth=t.overprintWidth,a.strokeStyle=f.RED,a.fillStyle=f.RED_30,$>0&&!c.fileLoaded&&(a.beginPath(),$<N.length-1?_t(t.controlRadius):(_t(t.finishInnerRadius),a.stroke(),a.beginPath(),_t(t.finishOuterRadius)),a.fillRect(N[$]-1,U[$]-1,3,3),a.stroke()),a.strokeStyle=Os,a.fillStyle=Os,a.font="10pt Arial",a.textAlign="left",a.globalAlpha=.6,br(),c.handles.drawHandles()}function br(){if(c.routeData.x.length>1){a.beginPath(),a.moveTo(c.routeData.x[0],c.routeData.y[0]);for(let t=1;t<c.routeData.x.length;t+=1)a.lineTo(c.routeData.x[t],c.routeData.y[t]);a.stroke()}}function xr(){return{x:N,y:U}}function Ln(t){const e=c.routeData.splits;if(e.length===2)return t+1;for(let s=t+1;s<e.length;s+=1)if(e[s]!==e[s-1])return s;return e.length}function Er(t){const e=c.routeData.splits;if(e.length===2)return t-1;for(let s=t-1;s>0;s-=1)if(e[s]!==e[s-1])return s;return 0}function Sr(){return c.fileLoaded}function Tr(t){t.ok?(V(h("Route deleted"),h("Route has been deleted")),Ti({eventid:parseInt(t.eventid,10),id:parseInt(t.routeid,10)}),Cn()):V(h("Delete failed"),h("Delete failed"))}const kr=t=>e=>{e.ok?Ar(e,t):V(t,h("Your route was not saved. Please try again"))};function Ir(){if(ft.length===0)clearInterval(ht),ht=null,Ve=!0;else{const t=ft.shift();wt(t.angle,t.x,t.y,!0,t.scale)}D()}function Vt(t){Tt=null,c.routeData=new Et,c.routeData.eventid=fe(),c.routeData.courseid=t;const e=J(t);Ee=e.isScoreCourse,Ee||(ze(t,!0),c.routeData.coursename=e.name,e.excludeType===f.EXCLUDED_ZERO_SPLITS?c.routeData.controlsToAdjust=e.exclude.indexOf(!0):c.routeData.controlsToAdjust=e.x.length-1,N=e.x.slice(),U=e.y.slice(),c.routeData.x.length=0,c.routeData.y.length=0,c.routeData.x[0]=N[0],c.routeData.y[0]=U[0],c.routeData.controlx=N.slice(),c.routeData.controly=U.slice(),c.routeData.cumulativeLegLengths=e.cumulativeLegLengths.slice(),ss=e.angle.slice()),document.getElementById("rg2-select-course").value=c.routeData.courseid,ln(t),D()}function wn(){c=new sn,c.routeData=new Et,N.length=0,U.length=0,ss.length=0,$=0,ie=0,Ee=!1,c.initialiseGPS(),nr(),D()}function Lr(t,e,s){if(ke()===f.TAB_DRAW)if(c.fileLoaded){const i=c.handles.getHandleClicked({x:t,y:e});if(i!==void 0)s===f.RIGHT_CLICK?c.handles.deleteHandle(i.index):c.handles.toggleLock(i.index);else for(let l=0;l<c.baseX.length;l+=1)if(c.baseX[l]+3>=t&&c.baseX[l]-3<=t&&c.baseY[l]+3>=e&&c.baseY[l]-3<=e){c.handles.addHandle(t,e,l);break}}else c.routeData.resultid!==null&&c.routeData.courseid!==null?ar(t,e):V("No course/name","Please select course, name and time before you start drawing a route or upload a file.")}function wr(t){Ze(),c.readGPS(t)}function Dr(){let t={};t.body="All information you have entered will be removed. Are you sure you want to reset?",t.title="Confirm reset",t.doText="Reset",t.onDo=ns,jt(t)}function Cr(t,e,s){let n={};return n.x=Math.cos(s)*t-Math.sin(s)*e,n.y=Math.sin(s)*t+Math.cos(s)*e,n}function Ar(t,e){V(e,h("Your route has been saved")),ki({eventid:parseInt(t.eventid,10),id:t.newid,token:t.token}),kt(fe())}function Mr(){const t=c.routeData.time[c.routeData.time.length-1]-c.routeData.time[0];c.routeData.totaltime=P(t);const s=new Date().getTimezoneOffset()*60;c.routeData.startsecs=c.routeData.time[0]-s;for(let n=0;n<c.routeData.x.length;n+=1)c.routeData.x[n]=Math.round(c.routeData.x[n]),c.routeData.y[n]=Math.round(c.routeData.y[n]),c.routeData.time[n]-=c.routeData.startsecs;for(c.routeData.resultid+=f.GPS_RESULT_OFFSET;al(c.routeData.resultid);)c.routeData.resultid+=f.GPS_RESULT_OFFSET,c.routeData.name+="*";c.routeData.comments=document.getElementById("rg2-new-comments").value,document.getElementById("btn-undo-gps-adjust").setAttribute("disabled",""),In()}function Rr(){c.routeData.comments=document.getElementById("rg2-new-comments").value,c.routeData.controlx=N,c.routeData.controly=U,c.routeData.controlx.splice(0,1),c.routeData.controly.splice(0,1),In()}function Pe(t,e,s,n,i){const l=Y(e.x,e.y,s.x,s.y)/Y(t.x,t.y,s.x,s.y),r=ue(e.x,e.y,s.x,s.y)-ue(t.x,t.y,s.x,s.y);for(let o=n;o<=i;o+=1){const m=Cr(c.baseX[o]-s.x,c.baseY[o]-s.y,r);c.routeData.x[o]=m.x*l+s.x,c.routeData.y[o]=m.y*l+s.y}c.handles.alignHandles(c.routeData)}function Br(){for(let t=c.routeData.x.length-1;t>0;t-=1)c.routeData.x[t]=c.routeData.x[t]-c.routeData.x[t-1],c.routeData.y[t]=c.routeData.y[t]-c.routeData.y[t-1];for(let t=c.routeData.time.length-1;t>0;t-=1)c.routeData.time[t]=c.routeData.time[t]-c.routeData.time[t-1]}function Pr(t){isNaN(t)||(c.routeData.courseid!==null?c.routeData.x.length>1?(Tt=t,ur()):(c.routeData.resultid!==null&&He(c.routeData.resultid,!1),ze(c.routeData.courseid,!1),Vt(t)):Vt(t))}function _r(t){if(!isNaN(t)){const e=on(t);if(e.hasValidTrack){const s=h("If you draw a new route it will overwrite the old route for this runner.")+" "+h("GPS routes are saved separately and will not be overwritten.");V(h("Route already drawn"),s)}c.routeData.resultid!==null&&He(c.routeData.resultid,!1),c.routeData.resultid=e.resultid,c.routeData.name=e.name,c.routeData.splits=e.splits,Ee?(He(e.resultid,!0),N=e.scorex,U=e.scorey,c.routeData.x.length=0,c.routeData.y.length=0,c.routeData.x[0]=N[0],c.routeData.y[0]=U[0],c.routeData.controlx=N,c.routeData.controly=U,$=1,D()):($=Ln(0),ie=0),Dn()}}function $s(){const t=document.getElementById("rg2-name-entry"),e=t.value.trim();e?t.classList.add("is-valid"):t.classList.remove("is-valid");const s=document.getElementById("rg2-time-entry");let n=s.value.trim();if(n.match(/\d+[:.][0-5]\d$/)?s.classList.add("is-valid"):(s.classList.remove("is-valid"),n=null),e&&n&&c.routeData.courseid!==null){n=n.replace(".",":"),c.routeData.name=e,c.routeData.resultid=0,c.routeData.totaltime=n,c.routeData.startsecs=0,c.routeData.time[0]=hs(n),c.routeData.totalsecs=hs(n),$=1;const i=c.routeData.cumulativeLegLengths[c.routeData.cumulativeLegLengths.length-1];let l=[];for(let r=0;r<c.routeData.cumulativeLegLengths.length;r=r+1)l[r]=parseInt(c.routeData.cumulativeLegLengths[r]/i*c.routeData.totalsecs,10);c.routeData.splits=l,ie=0,Dn()}}function Nr(){c.routeData.courseid!==null&&(Ee?He(c.routeData.resultid,!0):ze(c.routeData.courseid,!0))}function Dn(){document.getElementById("btn-three-seconds").removeAttribute("disabled"),document.getElementById("btn-reset-drawing").removeAttribute("disabled",""),document.getElementById("rg2-load-gps-file").removeAttribute("disabled"),kn(0),D()}function Or(){c.baseX=c.savedBaseX.slice(0),c.baseY=c.savedBaseY.slice(0),c.routeData.x=c.savedBaseX.slice(0),c.routeData.y=c.savedBaseY.slice(0),c.handles.undo(),document.getElementById("btn-undo-gps-adjust").setAttribute("disabled",""),D()}function $r(){if(Ve){const t=c.routeData.x.length;t>1&&(N[ie]===c.routeData.x[t-1]&&U[ie]===c.routeData.y[t-1]&&($===N.length&&document.getElementById("btn-save-route").setAttribute("disabled",""),$=ie,ie=Er($)),c.routeData.x.pop(),c.routeData.y.pop()),c.routeData.x.length>1?document.getElementById("btn-undo").removeAttribute("disabled"):document.getElementById("btn-undo").setAttribute("disabled",""),D()}}function Fr(){Ut(c.routeData.x[c.routeData.x.length-1],c.routeData.y[c.routeData.y.length-1]),D()}class Be{constructor(e){e.A===void 0?(this.valid=!1,this.A=0,this.B=0,this.C=0,this.D=0,this.E=0,this.F=0):(this.A=parseFloat(e.A),this.B=parseFloat(e.B),this.C=parseFloat(e.C),this.D=parseFloat(e.D),this.E=parseFloat(e.E),this.F=parseFloat(e.F),this.valid=!0,this.AEDB=e.A*e.E-e.D*e.B,this.xCorrection=e.B*e.F-e.E*e.C,this.yCorrection=e.D*e.C-e.A*e.F)}getLat(e,s){return this.D*e+this.E*s+this.F}getLon(e,s){return this.A*e+this.B*s+this.C}getX(e,s){return Math.round((this.E*e-this.B*s+this.xCorrection)/this.AEDB)}getY(e,s){return Math.round((-1*this.D*e+this.A*s+this.yCorrection)/this.AEDB)}}class Hr{constructor(e){switch(this.kartatid=e.id,this.mapid=e.mapid,this.format=e.format,this.name=e.name,this.date=e.date,this.club=e.club,this.rawtype=e.type,e.type){case"I":this.type="International event";break;case"N":this.type="National event";break;case"R":this.type="Regional event";break;case"L":this.type="Local event";break;case"T":this.type="Training event";break;default:this.type="Unknown";break}this.comment=e.comment,this.locked=e.locked,this.courses=0,e.suffix===void 0?this.mapfilename=this.mapid+".jpg":this.mapfilename=this.mapid+"."+e.suffix,this.worldfile=new Be(e)}}let A=[],B=null,Yt=!1;function Gr(t){const e=document.querySelectorAll("#rg2-event-table tr");for(let n of e)parseInt(n.dataset.kartatid,10)===t?n.classList.add("table-success"):n.classList.remove("table-success");const s=document.getElementById("btn-splitsbrowser");rg2Config.enable_splitsbrowser&&is()?s.removeAttribute("disabled"):s.setAttribute("disabled",""),document.getElementById("btn-toggle-controls").removeAttribute("disabled"),document.getElementById("btn-runners").removeAttribute("disabled"),document.getElementById("btn-measure").removeAttribute("disabled"),document.getElementById("btn-stats").removeAttribute("disabled")}function Ur(t){_n(null),qt({type:"event",id:t},Jr,"Event request failed")}function Cn(){qt({type:"events"},Qr,"Events request failed")}function An(){return B===null?!1:A[B].locked}function Vr(){let t="<table class='table table-striped table-hover table-sm'><tbody id='rg2-event-table'>";for(let e=A.length-1;e>=0;e-=1){let s=h(A[e].type,"")+": "+A[e].date;A[e].comment!==""&&(s+=": "+A[e].comment);let n="";A[e].comment!==""&&(n=`<i class='bi-info-circle' id='info-${e}'></i>`);let i="";A[e].worldfile.valid&&(i=`<i class='bi-globe' id='info-${e}'></i>`);let l="";A[e].locked&&(l=`<i class='bi-lock-fill' id='info-${e}'></i>`),t+=`<tr data-kartatid="${A[e].kartatid}"><td class="event-date">${A[e].date}</td><td title='${s}'>`,t+=`${A[e].name} ${l} ${i} ${n}</td ></tr >`}return t+="</tbody></table>",t}function Yr(){return B!==null?A[B].date:""}function Mn(){return B}function Wr(){if(B!==null)return A[B].kartatid}function Xr(){return B!==null?A[B].name:"Routegadget 2"}function qr(){return B!==null?A[B].mapid:null}function jr(t){for(let e=0;e<A.length;e+=1)if(A[e].kartatid===t)return e}function is(){return B!==null?A[B].format===f.FORMAT_NORMAL||A[B].format===f.FORMAT_SCORE_EVENT:!0}function Rn(t){t=t||fe();const e=jr(t);let s=A[e];return s.id=e,s.controls=W.getControlCount(),s.exclude=ga(),s}function zr(){if(B===null)return"";const t=fe(),e=Rn(parseInt(t,10));let s=`<div class='fs-4 fw-bolder pb-3'>${h("Event statistics")+": "+e.name+"&nbsp"+e.date}</div>
  <div class="d-flex flex-wrap justify-content-evenly pb-2">${tl(e)}</div>`;return s+=fa(),s+=ji(),s=s.replace(/&amp;/g,"&"),s}function fe(){return B===null?null:A[B].kartatid}function Kr(){return B===null||!It()?"px":"m"}function Zr(t){for(let e=0;e<A.length;e+=1)if(A[e].kartatid===t)return A[e].mapfilename;return""}function je(){if(B===null||!It())return;const t=Xe(),e=Y(0,0,t.width,t.height),s=A[B].worldfile,n=s.C,i=s.F,l=s.A*t.width+s.B*t.height+s.C,r=s.D*t.width+s.E*t.height+s.F;return $t(i,n,r,l)/e}function Bn(){return B===null?null:A[B].worldfile}function Jr(t,e){if(Yt=!1,bt.getInstance(document.getElementById("rg2-right-info-panel")).hide(),Pi(e),_n(e),ea(),document.getElementById("rg2-load-progress-label").innerHTML=h("Saving courses"),ba(t.courses),document.getElementById("rg2-load-progress-label").textContent=h("Saving results",""),dl(t.results),document.getElementById("rg2-load-progress-label").textContent=h("Saving routes",""),cl(t.routes),ia(),Hi(),f.managing())rg2Config.manager.eventFinishedLoading(e);else{if(document.getElementById(f.TAB_COURSES).removeAttribute("disabled"),document.getElementById(f.TAB_RESULTS).removeAttribute("disabled"),An()?document.getElementById(f.TAB_DRAW).setAttribute("disabled",""):document.getElementById(f.TAB_DRAW).removeAttribute("disabled"),ke()!==f.TAB_DRAW){const l=Ri();document.getElementById(l).click()}const n=Mi();for(let l=0;l<n.length;l+=1){let r=new Event("click",{bubbles:!0});const o=document.querySelector(`.showtrack[data-id='${n[l]}']`);o&&(o.checked=!0,o.dispatchEvent(r))}const i=Ci();for(let l=0;l<i.length;l+=1){let r=new Event("click",{bubbles:!0});const o=document.querySelector(`.showcourse[data-courseid='${i[l]}']`);o&&(o.checked=!0,o.dispatchEvent(r))}}document.getElementById("rg2-load-progress").classList.add("d-none"),wn(),Gr(e)}function Qr(t){A.length=0,B=null;for(const s of t.events)A.push(new Hr(s));Zl();const e=Ai();e&&kt(e),f.managing()&&rg2Config.manager.eventListLoaded(A)}function gt(){return B!==null?A[B].format===f.FORMAT_SCORE_EVENT||A[B].format===f.FORMAT_SCORE_EVENT_NO_RESULTS:!1}function Pn(t){for(let e=0;e<A.length;e+=1)if(A[e].kartatid===t)return!0;return!1}function kt(t){Yt||!Pn(t)||(Yt=!0,Na(),Gi(),On(),so(rg2Config.maps_url+Zr(t)),document.getElementById("rg2-load-progress-label").textContent=h("Loading event",""),document.getElementById("rg2-load-progress").classList.remove("d-none"),Ur(t),D())}function mo(t){for(let e=0;e<A.length;e+=1)if(A[e].mapid===t)return!0;return!1}function It(){return B===null?!1:A[B].worldfile.valid}function _n(t){B=null;for(let e=0;e<A.length;e+=1)if(A[e].kartatid===t){B=e;break}}function ea(){let t="";t=Yr()+" "+at(Xr()),document.title=t,It()&&(t="<i class='bi-globe'>&nbsp;</i>"+t),An()&&(t="<i class='bi-lock-fill'>&nbsp;</i>"+t),document.getElementById("rg2-event-title").innerHTML=t}class Nn{constructor(e,s){this.name=e.name,this.trackcount=0,this.display=!1,this.courseid=e.courseid,this.codes=e.codes,this.setExcluded(e),this.filterTo=this.codes.length,this.filterFrom=0,this.x=e.xpos,this.y=e.ypos,this.isScoreCourse=s,this.resultcount=0,this.angle=[],this.textAngle=[],this.setAngles(),this.setLengths()}drawCourse(e){if(this.display){const s=Fe();if(a.globalAlpha=e,W.drawStart(this.x[0],this.y[0],"",this.angle[0],s),!this.isScoreCourse){const n={from:this.filterFrom,to:this.filterTo};this.drawLinesBetweenControls({x:this.x,y:this.y},this.angle,s,n)}if(this.isScoreCourse)for(let n=1;n<this.x.length;n+=1)this.codes[n].indexOf("F")===0||this.codes[n].indexOf("M")===0?W.drawFinish(this.x[n],this.y[n],"",s):W.drawSingleControl(this.x[n],this.y[n],this.codes[n],this.textAngle[n],s);else{const n=Math.max(this.filterFrom,1),i=Math.min(this.filterTo+1,this.x.length-1);for(let l=n;l<i;l+=1)W.drawSingleControl(this.x[l],this.y[l],l,this.textAngle[l],s);W.drawFinish(this.x[this.x.length-1],this.y[this.y.length-1],"",s)}}}drawLinesBetweenControls(e,s,n,i){let l;for(let r=i.from;r<i.to;r+=1){r===0?l=n.startTriangleLength:l=n.controlRadius;const o=e.x[r]+l*Math.cos(s[r]),m=e.y[r]+l*Math.sin(s[r]);r===this.x.length-2?l=n.finishOuterRadius:l=n.controlRadius;const y=e.x[r+1]-l*Math.cos(s[r]),u=e.y[r+1]-l*Math.sin(s[r]);a.beginPath(),a.moveTo(o,m),a.lineTo(y,u),a.stroke()}}incrementTracksCount(){this.trackcount+=1}setAngles(){for(let e=0;e<this.x.length-1;e+=1)if(this.isScoreCourse)this.angle[e]=Math.PI*1.5,this.textAngle[e]=Math.PI*.25;else if(this.angle[e]=ue(this.x[e],this.y[e],this.x[e+1],this.y[e+1]),e>0){const s=Math.sin(this.angle[e-1]),n=Math.cos(this.angle[e-1]),i=Math.sin(this.angle[e])+s,l=Math.cos(this.angle[e])+n,r=i/2,o=l/2;this.textAngle[e]=ue(r,o,s,n)}else this.textAngle[0]=0;this.angle[this.x.length-1]=Math.PI*1.5,this.textAngle[this.x.length-1]=Math.PI*1.5}setDisplay(e){this.display=e}setExcluded(e){this.excludeType=e.excludeType,this.exclude=e.codes.map((n,i)=>e.exclude.findIndex(l=>l===i)>-1);const s=this.exclude.findIndex(n=>n===!0);this.firstExcluded=s===-1?0:s,this.allowed=e.codes.map((n,i)=>e.exclude.findIndex(l=>l===i)>-1?e.allowed[e.exclude.findIndex(l=>l===i)]:0)}setLengths(){let e=0;this.lengthValid=!0,this.legLengths=[],this.cumulativeLegLengths=[],this.legLengths[0]=0,this.cumulativeLegLengths[0]=0;let s=je();s===void 0&&(this.lengthValid=!1,s=1);for(let n=1;n<this.x.length;n+=1){const i=parseInt((Y(this.x[n],this.y[n],this.x[n-1],this.y[n-1])*s).toFixed(0));this.legLengths[n]=i,this.cumulativeLegLengths[n]=this.cumulativeLegLengths[n-1]+i,e+=i}this.length=(e/1e3).toFixed(1)}}let b=[],W,mt=0,ls=0,Wt=0;function ta(t){b[t.courseid]=new Nn(t,gt()),ls+=1,b[t.courseid].codes!==void 0&&b[t.courseid].codes.length>Wt&&(Wt=b[t.courseid].codes.length-1)}function sa(){for(let t=0;t<b.length;t+=1)if(b[t]!==void 0&&!b[t].display)return!1;return!0}function na(){let t=document.getElementById("rg2-select-course");t.innerHTML="",t.options.add(xe(null,h("Select course","")));for(let e=0;e<b.length;e=e+1)b[e]!==void 0&&t.options.add(xe(e,at(b[e].name)));t.addEventListener("change",e=>{Pr(parseInt(e.target.value,10))})}function ia(){const t=document.getElementById("rg2-course-table");t.innerHTML=da();const e=document.getElementById("rg2-course-filter-table");e.innerHTML=oa(),document.querySelectorAll("[data-course-filter]").forEach(n=>{n.addEventListener("change",ra)})}function On(){b.length=0,mt=0,ls=0,Wt=0}function Fs(t){for(let e=0;e<b.length;e+=1)b[e]!==void 0&&b[e].drawCourse(t)}function la(t,e,s,n,i){b[s].drawLinesBetweenControls(t,e,n,i)}function ra(t){const e=parseInt(t.target.dataset.courseFilter,10);b[e].filterFrom=t.detail.value1,b[e].filterTo=t.detail.value2,D()}function aa(){let t={html:"",res:0,coursecount:0};for(let e=0;e<b.length;e+=1)b[e]!==void 0&&(t.coursecount=t.coursecount+1,t.html+=[`<tr><td>${b[e].name}</td >`,`<td><input class='showcourse' data-courseid=${e} type='checkbox' name='course'></input></td>`,`<td class='text-center'>${b[e].resultcount}</td><td class='text-center'>${b[e].trackcount}</td><td>`].join(""),t.res+=b[e].resultcount,b[e].trackcount>0?(t.html+=`<input data-courseid=${b[e].courseid} class='allcoursetracks' type=checkbox name=track></input></td>`,t.html+=`<td><input data-courseid=${b[e].courseid} class='allcoursetracksreplay' type=checkbox name=replay></input>`):t.html+="</td><td>",t.html+="</td></tr>");return t}function oa(){let t="";for(let e=0;e<b.length;e+=1)b[e]!==void 0&&!b[e].isScoreCourse&&b[e].codes.length>2&&(t+=[`<div id='course-filter-${b[e].courseid}' data-display="false" data-course="${b[e].courseid}" class="row">`,`<div class="col-3">${b[e].name}</div>`,'<div class="col-9 pt-2">',`  <tc-range-slider step="1" min="0" max="${b[e].codes.length}" value1="0"`,`value2="${b[e].codes.length}" round="0" data-course-filter="${b[e].courseid}>"`,"</tc-range-slider></div></div>"].join(""));return t}function da(){let t=["<table class='table table-striped table-hover table-sm'><thead>",`<tr><th>${h("Course")}</th><th><i class='bi-eye-fill'></i></th><th>${h("Runners")}</th>`,`<th>${h("Routes")}</th><th><i class='bi-pencil'></i></th><th><i class='bi-play-fill'></i></th></tr>`,'</thead><tbody class="table-group-divider">'].join("");const e=aa();return t+=e.html+`</tbody><tfoot class="table-group-divider"><tr class='allitemsrow'><td>${h("All")}</td>
    <td><input class='showallcourses' data-id="all" type=checkbox name=course></input></td>
    <td class='text-center'>${e.res}</td><td class='text-center'>${mt}</td><td>`,mt>0&&(t+=`<input data-id="all" class='alltracks' type=checkbox name=track></input>`),t+="</td><td></td></tr></tfoot></table>",t}function $n(){return b}function J(t){return b[t]}function ca(t){return b.find(e=>e?e.name===t:!1)}function ua(t){return b[t].name}function ha(){let t=[];for(let e=0;e<b.length;e+=1)if(b[e]!==void 0){let s={};s.id=b[e].courseid,s.name=b[e].name,s.results=b[e].resultcount,t.push(s)}return t}function Hs(){let t=[];for(let e=0;e<b.length;e+=1)b[e]!==void 0&&b[e].display&&t.push(e);return t}function fa(){const t=[];for(let e=0;e<b.length;e+=1)if(b[e]!==void 0)for(let s=0;s<b[e].exclude.length;s=s+1)b[e].exclude[s]&&t.push({courseid:e,name:b[e].name,type:b[e].excludeType,control:s,time:b[e].allowed[s]});if(t.length>0){let e=[`<h5>${h("Excluded controls")}</h5><table id='rg2-exclusions-table' class='table table-sm table-striped table-bordered'>`,`<thead><tr><th>${h("Course")}</th><th>${h("Control")}</th>`,`<th>${h("Time")}</th></tr></thead><tbody class="table-group-divider">`].join("");for(let s=0;s<t.length;s+=1)e+=`<tr><td>${t[s].name}</td><td>${t[s].control}</td><td>${t[s].time}</td>`;return'<hr class="border border-primary opacity-75 my-5" />'+e+"</tbody></table>"}else return""}function ga(){let t="";for(let e=0;e<b.length;e+=1)b[e]!==void 0&&b[e].excludeType!==f.EXCLUDED_NONE&&(t=t+b[e].courseid+"|"+b[e].excludeType,t=t+b[e].exclude.reduce((s,n,i)=>n?s+"|"+i+","+b[e].allowed[i]:s,""),t=t+`
`);return t}function ma(t){let e={};return e.filterFrom=b[t].filterFrom,e.filterTo=b[t].filterTo,e}function Fn(){return ls}function pa(t){b[t].incrementTracksCount(),mt+=1}function ya(){W=new Li}function va(t){return t in b}function ba(t){On(),W.deleteAllControls();for(const e of t)ta(e);W.generateControlList()}function Hn(t){for(let e=0;e<b.length;e+=1)b[e]!==void 0&&b[e].setDisplay(t)}function Gs(){for(let t=0;t<b.length;t+=1)b[t]!==void 0&&_e(t)}function ze(t,e){b[t]!==void 0&&(b[t].setDisplay(e),_e(t))}function _e(t){t=parseInt(t,10);const e=b[t].display||$i(t);document.querySelectorAll("[data-display]").forEach(s=>{parseInt(s.dataset.course,10)===t&&(s.dataset.display=e)})}function xa(){for(let t=0;t<b.length;t+=1)b[t]!==void 0&&(b[t].resultcount=Fi(t))}function Ea(t,e,s,n){for(let i=0;i<b.length;i+=1)if(b[i]!==void 0&&b[i].courseid===t){b[i].codes=e,b[i].x=s,b[i].y=n,b[i].setAngles();break}}function po(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}let L=[],ne={};const Nt=[100,200,500,1e3,2e3,3e3,5e3,7500,1e4,15e3,2e4,5e4,1e5],Sa=100,Ta=50,Ae=20;let se=!1,Gn="px",Ye=3e3,he=null,Se=null,pt=[],H=0,ae=0,re=!1,ve=0,de=0,We=60,Ne=0,_=0,Ie=!1,Oe=!1,be=!0,$e=0,ce=0,yt=null,j;const rs=`<i title=${h("Run","")} class="bi-play-circle-fill"></i>`,Un=`<i title=${h("Start","")} class="bi-triangle"></i>`,ka=`<i title=${h("Pause","")} class="bi-pause-btn"></i>`,Vn=`<i title=${h("Wait","")} class="bi-hourglass-split"></i>`,Te=document.getElementById("rg2-track-names"),Us=document.querySelector("#rg2-track-names .card-body"),Xt=document.getElementById("btn-runners"),ge=document.getElementById("btn-start-stop");document.querySelector("#rg2-track-names .card-title").innerHTML=h("Runners");document.getElementById("btn-close-track-names").addEventListener("click",()=>{Te.classList.add("d-none")});Xt.addEventListener("click",()=>{Te.classList.toggle("d-none")});const rt=document.getElementById("rg2-replay-by-control");rt.classList.add("d-none");let tt={x:0,y:0};ot(Te).draggable({inertia:!0,listeners:{move(t){tt.x+=t.dx,tt.y+=t.dy,t.target.style.transform=`translate(${tt.x}px, ${tt.y}px)`}},modifiers:[ot.modifiers.restrictRect({restriction:"#rg2-container"})]});function Yn(t,e=!0){for(let s=0;s<L.length;s+=1)if(L[s].resultid===t.resultid)return;L.length===0&&(ne=ca(t.coursename)),t.userColour!==null?t.trackColour=t.userColour:t.trackColour=tn(),L.push(t),e&&Lt()}function Wn(t){se=!1,pt=[];const e=ne.x[t],s=ne.y[t],n=ne.x[t+1],i=ne.y[t+1];if(ne.angle.length>=t){const l=cs(),r=ti(),o=Y(e,s,n,i),m=Y(l.x,l.y,r.x,r.y);let y=Math.min(m/o,f.MAX_ZOOM);y=Math.max(y,f.MIN_ZOOM);let u=(a.displayAngle-ne.angle[t]-Math.PI/2)%(Math.PI*2);u<-1*Math.PI&&(u=u+2*Math.PI);for(let p=1;p<=Ae;p=p+1){let v={};v.x=l.x-(l.x-e)*p/Ae,v.y=l.y-(l.y-s)*p/Ae,v.angle=(a.displayAngle-u*p/Ae)%(Math.PI*2),v.scale=Math.pow(y,1/Ae),pt.push(v)}Se=setInterval(()=>{Ba()},Ta)}else wt(0,e,s,!0,1),Se=null,se=!0}function Vs(t,e){for(let s=0;s<t.length;s+=1)e?Yn(new zt(t[s]),!1):zn(t[s]);Lt()}function Xn(){ve=86400,de=0,ce=0;for(let t=0;t<L.length;t+=1)L[t].starttime<ve&&(ve=L[t].starttime),L[t].starttime+L[t].x.length>de&&(de=L[t].starttime+L[t].x.length),L[t].x.length>ce&&(ce=L[t].x.length)}function Ia(t){if(L.length===0)return;let e=!0;for(let s=0;s<L.length;s+=1)if(L[s].splits[_+1]-L[s].splits[_]>t){e=!1;break}e&&(_+=1,se=!1,as(_),os())}function La(t){t!==H&&Ke(t)}function wa(){let t=document.getElementById("rg2-replay-speed-list"),e="";for(let s=0;s<Nt.length;s=s+1)e+=`<li class="dropdown-item" data-speed="${Nt[s]}">${"x"+Nt[s]/100}</li>`;t.innerHTML=e,document.getElementById("rg2-replay-speed-select").addEventListener("hidden.bs.dropdown",s=>{s.clickEvent&&Jn(parseInt(s.clickEvent.target.dataset.speed,10))})}function Da(){let t=document.getElementById("rg2-replay-start-control-list");t.removeEventListener("hidden.bs.dropdown",Ws);let e="";const n=L.reduce((i,l)=>Math.min(l.splits.length,i),9999);for(let i=0;i<n-1;i=i+1){const l=i===0?`<div>${Un}</div>`:i;e+=`<li class="dropdown-item" data-control="${i}">${l}</li>`}t.innerHTML=e,document.getElementById("rg2-replay-start-control-select").addEventListener("hidden.bs.dropdown",Ws)}function Ca(){let t=document.getElementById("rg2-tails-length-list"),e="";const s=["0:00","0:30","1:00","1:30","2:00","3:00",h("Full tails","")],n=[0,30,60,90,120,180,"Full"];for(let i=0;i<s.length;i=i+1)e+=`<li class="dropdown-item" data-length="${n[i]}">${s[i]}</li>`;t.innerHTML=e,document.getElementById("rg2-tails-length-select").addEventListener("hidden.bs.dropdown",i=>{i.clickEvent&&Ga(i.clickEvent.target.dataset.length)})}function Aa(){if(L.length===0)return;if(j){j.value!==H&&(j.value=H);const e=document.getElementById("rg2-clock");e.innerText=vi(H)}let t=0;for(let e=0;e<L.length;e+=1){const s=L[e];let n=0;if(re?n=s.starttime:_===0||s.splits.length<_?n=0:n=-1*s.splits[_],a.strokeStyle=s.trackColour,a.globalAlpha=C.perCentRouteIntensity/100,a.lineWidth=C.routeWidth/Math.pow(a.displayScale,.5),a.lineJoin="round",a.beginPath(),!se&&!Se&&_>0){const i=s.splits[_];let l=Math.max(i-We,s.splits[_-1]);a.moveTo(s.x[l],s.y[l]);for(let r=l+1;r<=i;r+=1)a.lineTo(s.x[r],s.y[r])}else{a.moveTo(s.x[Ne-n],s.y[Ne-n]);for(let i=Ne;i<H;i+=1)i>n&&i-n<s.nextStopTime&&a.lineTo(s.x[i-n],s.y[i-n])}a.stroke(),a.beginPath(),t=H,t-n<s.nextStopTime?t=t-n:t=s.nextStopTime,a.arc(s.x[t],s.y[t],f.RUNNER_DOT_RADIUS/Math.pow(a.displayScale,.5),0,2*Math.PI,!1),a.globalAlpha=f.FULL_INTENSITY,a.strokeStyle=f.BLACK,a.fillStyle=s.trackColour,a.fill(),a.lineWidth=f.RUNNER_DOT_RADIUS/Math.pow(a.displayScale,.5)/4,a.stroke(),Ma(s,t)}Ua(t),Ie&&Ia(H)}function Ma(t,e){let s="";if((Oe||be)&&e<t.x.length&&e>=0){a.fillStyle=t.trackColour,a.strokeStyle="darkslategray",a.font=C.replayFontSize/Math.pow(a.displayScale,.8)+"pt Arial",a.globalAlpha=f.FULL_INTENSITY,a.textAlign="left",be?s=t.initials:s=t.name,a.save(),a.translate(t.x[e],t.y[e]),a.rotate(a.displayAngle),a.lineWidth=C.replayFontSize/Math.pow(a.displayScale,.8)/8;const n=2+8/Math.pow(a.displayScale,1),i=2+4/Math.pow(a.displayScale,1);a.strokeText(s,n,i),a.fillText(s,n,i),a.restore()}}function Ys(t,e){const s=L[t].cumulativeDistance;let n=e>s.length-1?s[s.length-1]:s[e];return n===void 0&&(n=0),n}function qn(t){let e=[];for(let n=0;n<L.length;n+=1){let i={};i.trackColour=L[n].trackColour,i.course=L[n].coursename,i.name=L[n].name,i.resultid=L[n].resultid,i.rawid=L[n].rawid,re?i.distance=Ys(n,H-L[n].starttime):i.distance=Ys(n,t),i.distance+=Gn,e.push(i)}let s=Ji();for(let n=0;n<s.length;n+=1)if(e.findIndex(i=>i.resultid===s[n].resultid)===-1){let i={};i.trackColour=s[n].trackColour,i.course=s[n].course,i.name=s[n].name,i.resultid=s[n].resultid,i.rawid=s[n].rawid,i.distance="",e.push(i)}return e}function Ra(t){if(t.length===0)return"";let e="",s="";for(let n=0;n<t.length;n+=1)s!==t[n].course&&(e+=`<div></div><div><strong>${t[n].course}</strong></div><div></div>`,s=t[n].course),e+=`<input type="color" class="form-control form-control-color" data-rawid="${t[n].rawid}"`,e+=` value = "${t[n].trackColour}" ><div>${t[n].name}</div><div class="runner-distance text-end"`,e+=` data-resultid="${t[n].resultid}">${t[n].distance}</div>`;return e}function Ws(t){t.clickEvent&&(_=parseInt(t.clickEvent.target.dataset.control),isNaN(_)&&(_=0),se=!1,as(_),os(),Wn(_),ge.innerHTML=Vn)}function Ba(){if(pt.length===0)clearInterval(Se),Se=null,se=!0,ge.innerHTML=rs;else{const t=pt.shift();wt(t.angle,t.x,t.y,!0,t.scale)}D()}function Pa(){re?H<de&&(ae=Math.min(ae+Ye,de*1e3)):H<ce&&(ae=Math.min(ae+Ye,ce*1e3)),H=parseInt(ae/1e3,10),Ne=Math.max(H-We,$e+1),D()}function _a(){if(yt)return;yt=document.getElementById("rg2-animation-controls");const t=document.getElementById("rg2-clock");t.innerText="00:00:00",jn(0,0,0),wa(),Jn(Ye),ge.addEventListener("click",()=>{Ya()}),document.getElementById("btn-mass-start").addEventListener("click",()=>{rt.classList.add("d-none"),$a()});const s=document.getElementById("btn-real-time");s.setAttribute("title",h("Real time","")),s.addEventListener("click",()=>{rt.classList.add("d-none"),Fa()}),document.getElementById("btn-by-control").addEventListener("click",()=>{Oa(),Da(),rt.classList.remove("d-none")}),Ca();let i=document.querySelectorAll("[data-toggle-names]");for(let l of i)l.innerHTML=h(l.dataset.toggleNames),l.addEventListener("click",r=>{Wa(r.currentTarget.dataset.toggleNames)});document.getElementById("rg2-toggle-names-value").setAttribute("title",h("Show names",""))}function jn(t,e,s){if(j&&j.min===t&&j.max===e&&j.value===s)return;j&&j.remove();const n=document.getElementById("rg2-clock-slider-container"),i=document.createElement("tc-range-slider");i.setAttribute("id","rg2-clock-slider"),i.setAttribute("min",t),i.setAttribute("max",e),i.setAttribute("value",s),i.setAttribute("step",1),n.append(i),j=document.getElementById("rg2-clock-slider"),j.addEventListener("change",l=>{La(l.target.value)})}function zn(t){for(let e=0;e<L.length;e+=1)L[e].resultid===t&&L.splice(e,1),L.length===0&&(ne={});Lt()}function Na(){L.length=0,ne={},Ye=3e3,H=0,ae=0,re=!1,ve=0,de=0,We=60,Ne=0,_=0,Ie=!1,Oe=!1,be=!0,$e=0,ce=0,clearInterval(he),he=null,Lt(),ge.innerHTML=rs,Te.classList.add("d-none")}function Kn(){L.forEach(t=>t.nextStopTime=f.VERY_HIGH_TIME_IN_SECS)}function Zn(t){return L.findIndex(e=>e.resultid===t)>-1}function Ke(t){Gn=Kr();let e=0;re?(t>0?H=t:H=ve,e=de,$e=ve):(t>0?H=t:H=0,e=ce,$e=0),ae=H*1e3,t===0&&jn($e,e,H),D()}function as(t){document.getElementById("rg2-replay-start-control").innerHTML=t===0?Un:t}function os(){let t=9999;t=L.reduce((e,s)=>Math.min(s.splits.length,e),t),_>t&&(_=0);for(let e=0;e<L.length;e+=1)_+1<L[e].splits.length?L[e].nextStopTime=L[e].splits[_+1]:L[e].nextStopTime=f.VERY_HIGH_TIME_IN_SECS;Ke(0),Qn(),D()}function Oa(){document.getElementById("rg2-clock-slider").setAttribute("disabled",""),re=!1,_=0,Ie=!0,se=!1,as(_),os()}function $a(){re=!1,Ie=!1,_=0,Kn(),Ke(0),j.removeAttribute("disabled")}function Fa(){re=!0,Ie=!1,_=0,Kn(),Ke(0),j.removeAttribute("disabled")}function Jn(t){isNaN(t)&&(t=1e3),Ye=t,document.getElementById("rg2-replay-speed").innerText="x"+t/100}function Ha(t,e){for(let s=0;s<L.length;s+=1)L[s].rawid===t&&(L[s].userColour=e,L[s].trackColour=e);fl(t,e)}function Ga(t){t==="Full"?We=f.VERY_HIGH_TIME_IN_SECS:We=parseInt(t,10),Xn(),D()}function Ua(t){const e=qn(t);if(e.length===0)return;const s=document.querySelectorAll(".track-names .runner-distance");s&&s.forEach(n=>{const i=parseInt(n.dataset.resultid),l=e.findIndex(r=>r.resultid===i);l>-1&&(n.innerText=e[l].distance)})}function Va(){he===null&&(he=setInterval(()=>{Pa()},Sa)),ge.innerHTML=ka}function Qn(){clearInterval(he),he=null,ge.innerHTML=rs}function Ya(){he===null?(Ie?!se&&Se===null&&(Wn(_),ge.innerHTML=Vn):se=!0,se&&Va()):Qn()}function Wa(t){switch(document.getElementById("rg2-toggle-names-value").setAttribute("title",h(t,"")),t){case"Show names":Oe=!0,be=!1;break;case"Show initials":Oe=!1,be=!0;break;default:Oe=!1,be=!1;break}D()}function Lt(){_a(),ds(),L.length>0?(yt.classList.remove("d-none"),Xt.classList.remove("d-none")):(yt.classList.add("d-none"),Xt.classList.add("d-none")),ts(),Xn(),Ke(0)}function ds(){const t=qn(H);return t.length>0?(Us.innerHTML=Ra(t),document.querySelectorAll(".track-names input").forEach(s=>{s.addEventListener("input",n=>{Ha(parseInt(n.target.dataset.rawid,10),n.target.value),D()})}),Te.classList.remove("d-none")):(Us.innerHTML="",Te.classList.add("d-none")),t.length}class Xa{constructor(e){this.ctx=e,this.measuring=!1,this.dragging=!1,this.colours=["#ff00ff","#0000ff","#00ff00","#ff0000","#00ffff"],this.colourIndex=0,this.overlays=[],this.currentOverlay=this.initialiseOverlay(),this.units="px",this.metresPerPixel=1,this.dotSize=5,this.lineWidth=3,this.measureDialog=document.getElementById("rg2-measure-dialog"),document.getElementById("btn-measure").addEventListener("click",()=>{Mn()!==null&&(document.getElementById("rg2-map-canvas").style.cursor="crosshair",this.measureDialog.classList.remove("d-none"),this.measuring=!0,this.createMeasureDialog(),D())}),document.getElementById("btn-close-measure-dialog").addEventListener("click",()=>{this.measuring=!1,this.measureDialog.classList.add("d-none"),document.getElementById("rg2-map-canvas").style.cursor="auto",D()}),document.getElementById("btn-measure").addEventListener("click",()=>{document.getElementById("rg2-map-canvas").style.cursor="crosshair",this.measureDialog.classList.remove("d-none"),this.measuring=!0,this.createMeasureDialog(),D()});let s={x:0,y:0};ot(this.measureDialog).draggable({inertia:!0,listeners:{move(n){s.x+=n.dx,s.y+=n.dy,n.target.style.transform=`translate(${s.x}px, ${s.y}px)`}},modifiers:[ot.modifiers.restrictRect({restriction:"#rg2-container"})]}),this.createMeasureDialog()}calculateLength(e,s){if(e.length<2)return 0;let n=0;for(let i=1;i<e.length;i+=1)n=n+Y(e[i-1],s[i-1],e[i],s[i]);return n}closeEnough(e,s,n,i){return Math.abs(e-n)<10&&Math.abs(s-i)<10}createMeasureDialog(){this.metresPerPixel=je(),this.metresPerPixel===void 0?(this.metresPerPixel=1,this.units="px"):this.units="m";let e="";for(let l=0;l<this.overlays.length;l+=1)e=e+this.formatOverlay(this.overlays[l],!0);e=e+this.formatOverlay(this.currentOverlay,!1),this.overlays.length>1&&(e+=`<div>${h("All")}</div><div></div><div></div>`,e+="<div><i class='delete-all-overlays bi-trash'></i></div>"),document.querySelector(".rg2-overlay-table").innerHTML=e;let s=document.getElementsByClassName("delete-overlay");for(let l of s)l.addEventListener("click",r=>{this.deleteOverlay(parseInt(r.target.id,10))});let n=document.getElementsByClassName("delete-all-overlays");for(let l of n)l.addEventListener("click",r=>{this.deleteAllOverlays(parseInt(r.target.id,10))});let i=document.getElementsByClassName("end-overlay");for(let l of i)l.addEventListener("click",r=>{this.endOverlay(parseInt(r.target.id,10))})}deleteAllOverlays(){this.overlays.length=0,this.currentOverlay=this.initialiseOverlay(),this.updateOverlays(),this.createMeasureDialog(),D()}deleteOverlay(e){this.overlays.splice(e,1),this.updateOverlays(),this.createMeasureDialog(),D()}dragEnded(){this.dragging=!1}drawSingleOverlay(e,s){this.ctx.strokeStyle=e.colour,this.ctx.fillStyle=e.colour,this.ctx.beginPath(),this.ctx.moveTo(e.x[0],e.y[0]);for(let n=1;n<e.x.length;n+=1)this.ctx.lineTo(e.x[n],e.y[n]);this.ctx.stroke();for(let n=0;n<e.x.length;n+=1)this.ctx.beginPath(),this.ctx.arc(e.x[n],e.y[n],this.dotSize,0,2*Math.PI,!1),s?this.ctx.fill():this.ctx.stroke()}drawOverlays(){if(this.measuring){if(this.ctx.lineWidth=this.lineWidth,this.ctx.globalAlpha=.6,this.overlays.length>0)for(let e=0;e<this.overlays.length;e+=1)this.drawSingleOverlay(this.overlays[e],!0);this.currentOverlay.started&&(this.currentOverlay.x.length===1?(this.ctx.strokeStyle=this.currentOverlay.colour,this.ctx.fillStyle=this.currentOverlay.colour,this.ctx.beginPath(),this.ctx.arc(this.currentOverlay.x[0],this.currentOverlay.y[0],this.dotSize,0,2*Math.PI,!1),this.ctx.stroke()):this.drawSingleOverlay(this.currentOverlay,!1))}}endOverlay(){this.currentOverlay.idx=this.overlays.length,this.overlays.push(this.currentOverlay),this.currentOverlay=this.initialiseOverlay(),this.createMeasureDialog()}formatOverlay(e,s){let n="",i="",l="";return e.started?l=`<div>${parseInt(e.length,10)}${this.units}</div>`:l="<div></div>",s?i=`<div><i class='delete-overlay bi-trash' id="${e.idx}"></i></div>`:e.started?i=`<div><i class='end-overlay bi-save' id="${e.idx}"></i></div>`:i="<div></div>",n+=`<div>${e.id}</div><div class='overlay-bar' style='--overlay-colour:${e.colour};'></div>`,n+=`${l}${i}`,n}getNextColour(){return this.colourIndex=(this.colourIndex+1)%this.colours.length,this.colours[this.colourIndex]}initialiseOverlay(){const e={};return e.id=String.fromCharCode(this.overlays.length+65),e.colour=this.getNextColour(),e.x=[],e.y=[],e.length=0,e.started=!1,e.idx=void 0,e}mouseDrag(e,s){if(!this.measuring)return!1;if(!this.dragging)for(let n=0;n<this.overlays.length;n+=1)for(let i=0;i<this.overlays[n].x.length;i+=1)this.closeEnough(e.x,e.y,this.overlays[n].x[i],this.overlays[n].y[i])&&(this.dragging=!0,this.dragOverlay=n,this.dragPoint=i);return this.dragging?(this.overlays[this.dragOverlay].x[this.dragPoint]=parseInt(s.x,10),this.overlays[this.dragOverlay].y[this.dragPoint]=parseInt(s.y,10),this.overlays[this.dragOverlay].length=this.calculateLength(this.overlays[this.dragOverlay].x,this.overlays[this.dragOverlay].y)*this.metresPerPixel,this.createMeasureDialog(),!0):!1}mouseUp(e,s){this.measuring&&(this.dragging=!1,this.currentOverlay.started||this.startOverlay(),e===this.currentOverlay.x[this.currentOverlay.x.length-1]&&s===this.currentOverlay.y[this.currentOverlay.x.length-1]?this.endOverlay():(this.currentOverlay.x.push(e),this.currentOverlay.y.push(s),this.currentOverlay.length=this.calculateLength(this.currentOverlay.x,this.currentOverlay.y)*this.metresPerPixel,this.createMeasureDialog(),D()))}startOverlay(){this.currentOverlay.started=!0,this.createMeasureDialog()}updateOverlays(){this.colourIndex=0;for(let e=0;e<this.overlays.length;e+=1)this.overlays[e].id=String.fromCharCode(e+65),this.overlays[e].idx=e,this.overlays[e].colour=this.getNextColour();this.currentOverlay.id=String.fromCharCode(this.overlays.length+65),this.currentOverlay.idx=this.overlays.length,this.currentOverlay.colour=this.getNextColour()}}let O=document.getElementById("rg2-map-canvas"),a=O.getContext("2d");a.displayAngle=0;a.displayScale=1;let q=new Image,vt=new Xa(a),S={dragStart:null,dragged:!0,scaleFactor:1.1,pinched:!1},Ot;document.getElementById("rg2-load-progress").classList.add("d-none");document.getElementById("rg2-map-load-progress").classList.add("d-none");function qa(){O.addEventListener("touchstart",eo,!1),O.addEventListener("touchmove",Qa,!1),O.addEventListener("touchend",Ja,!1),O.addEventListener("DOMMouseScroll",Xs,!1),O.addEventListener("wheel",Xs,!1),O.addEventListener("mousedown",za,!1),O.addEventListener("mousemove",Ka,!1),O.addEventListener("mouseup",Za,!1),q.addEventListener("load",()=>no());let t=document.getElementById("btn-zoom-in");t.addEventListener("click",()=>qe(1)),t=document.getElementById("btn-zoom-out"),t.addEventListener("click",()=>qe(-1)),t=document.getElementById("btn-rotate-left"),t.addEventListener("click",()=>qs(-1)),t=document.getElementById("btn-rotate-right"),t.addEventListener("click",()=>qs(1)),t=document.getElementById("btn-reset"),t.addEventListener("click",()=>Ze())}function wt(t,e,s,n=!0,i=1){ei((a.displayAngle-t)%(Math.PI*2),e,s,n,i)}function ei(t,e,s,n,i){if(a.displayAngle=(a.displayAngle-t)%(Math.PI*2),a.translate(e,s),a.rotate(t),i!==1&&(a.scale(i,i),a.displayScale=a.displayScale*i),n){const l=cs();a.translate(l.x-e,l.y-s)}else a.translate(-1*e,-1*s);D()}function ja(){if(!f.managing()&&window.innerWidth>=f.BIG_SCREEN_BREAK_POINT){a.font="16pt Arial",a.textAlign="center",a.fillStyle=f.BLACK;const t=a.transformedPoint(O.width/2,O.height/2);a.fillText("Routegadget 2 Version "+f.RG2VERSION,t.x,t.y)}}function cs(){const t=document.getElementById("rg2-animation-controls").offsetHeight;return a.transformedPoint(O.width/2,(O.height-t)*.85)}function ti(){const t=document.getElementById("rg2-animation-controls").offsetHeight;return a.transformedPoint(O.width/2,(O.height-t)*.15)}function Xe(){return{height:q.height,width:q.width}}function si(t){S.dragStart=a.transformedPoint(S.lastX,S.lastY),S.dragged=!1,S.whichButton=t.which}function ni(){if(S.dragStart){const t=a.transformedPoint(S.lastX,S.lastY);t.x=Math.round(t.x),t.y=Math.round(t.y);const e={x:Math.round(S.dragStart.x),y:Math.round(S.dragStart.y)},s=S.whichButton;Math.abs(t.x-e.x)+Math.abs(t.y-e.y)>5&&(Sr()?Tn(e,t,s):ke()===f.TAB_CREATE?rg2Config.manager.adjustManagerControls(e,t,s):vt.mouseDrag(e,t)||a.translate(t.x-S.dragStart.x,t.y-S.dragStart.y),S.dragged=!0,D())}}function ii(t){const e=ke();if(S.dragged)e===f.TAB_CREATE?rg2Config.manager.managerDragEnded():e===f.TAB_DRAW?pr():vt.dragEnded();else if(e===f.TAB_CREATE){const s=Math.round(S.dragStart.x),n=Math.round(S.dragStart.y);rg2Config.manager.managerMouseUp(s,n)}else e===f.TAB_DRAW?Lr(Math.round(S.dragStart.x),Math.round(S.dragStart.y),t.which):vt.mouseUp(Math.round(S.dragStart.x),Math.round(S.dragStart.y));S.dragStart=null,D()}function za(t){return ri(t),si(t),t.stopPropagation(),t.preventDefault()}function Ka(t){return ri(t),ni(),t.stopPropagation(),t.preventDefault()}function Za(t){return ii(t),t.stopPropagation(),t.preventDefault()}function Xs(t){const e=t.wheelDelta?t.wheelDelta/40:t.detail?-t.detail:0;return e&&qe(e),t.stopPropagation(),t.preventDefault()}function Ja(t){ii(t),S.pinched=!1}function Qa(t){if(t.touches.length>1?S.pinched||ai(t):S.pinched=!1,S.pinched&&t.touches.length>1){S.pinchEnd0=a.transformedPoint(t.touches[0].pageX,t.touches[0].pageY),S.pinchEnd1=a.transformedPoint(t.touches[1].pageX,t.touches[1].pageY);const e=Y(S.pinchStart0.x,S.pinchStart0.y,S.pinchStart1.x,S.pinchStart1.y),s=Y(S.pinchEnd0.x,S.pinchEnd0.y,S.pinchEnd1.x,S.pinchEnd1.y);e/s>1.1?(qe(-1),S.pinchStart0=S.pinchEnd0,S.pinchStart1=S.pinchEnd1):e/s<.9&&(qe(1),S.pinchStart0=S.pinchEnd0,S.pinchStart1=S.pinchEnd1)}else S.lastX=t.touches[0].pageX,S.lastY=t.touches[0].pageY,ni()}function eo(t){t.preventDefault(),t.touches.length>1&&ai(t),S.lastX=t.touches[0].pageX,S.lastY=t.touches[0].pageY,si(t)}function to(){qa(),lo(a),li()}function so(t,e=!1){document.getElementById("rg2-map-load-progress-label").textContent=h("Loading map",""),document.getElementById("rg2-map-load-progress").classList.remove("d-none"),q.onerror=()=>{document.getElementById("rg2-map-load-progress").classList.add("d-none"),V("Map load error","The map for this event could not be loaded.")},q.src=e?t:t+"?"+Date.now()}function no(){document.getElementById("rg2-map-load-progress").classList.add("d-none"),Ze(),f.managing()&&rg2Config.manager.managerMapLoadCallback()}function D(){Ot===void 0&&(Ot=setTimeout(()=>{Ot=void 0,io()},50))}function io(){if(a.save(),a.setTransform(1,0,0,1,0,0),a.globalAlpha=f.FULL_INTENSITY,a.fillStyle=f.GREY,a.fillRect(0,0,a.canvas.width,a.canvas.height),a.restore(),q.height>0){a.fillStyle=f.WHITE,a.globalAlpha=f.FULL_INTENSITY,a.fillRect(0,0,q.width,q.height),a.globalAlpha=C.perCentMapIntensity/100,a.drawImage(q,0,0);const t=ke();t===f.TAB_DRAW?(Fs(f.DIM),W.drawControls(!1),Es(),vr()):t===f.TAB_CREATE?rg2Config.manager.drawManagerControls():(Fs(f.DIM),Es(),vt.drawOverlays(),W.drawControls(!1),Aa())}else ja()}function Ze(){let t=1;const e=O.height/q.height;S.lastX=O.width/2,S.lastY=O.height/2,S.zoomSize=1,S.dragStart=null,S.dragged=!0,e<1&&(t=e),window.innerWidth>=f.BIG_SCREEN_BREAK_POINT?a.setTransform(t,0,0,t,document.getElementById("rg2-left-info-panel").offsetWidth+80,0):a.setTransform(t,0,0,t,0,0),a.displayAngle=0,a.displayScale=t,D()}function li(){S.scaleFactor=f.DEFAULT_SCALE_FACTOR;const t=document.getElementById("rg2-header-container").offsetHeight;document.getElementById("rg2-container").style.height=window.innerHeight-t+"px",O.width=window.innerWidth,O.height=window.innerHeight-t,Ze()}function qs(t){const e=t*(Math.PI/36);a.translate(q.width/2,q.height/2),ei(e,0,0,!1,1),a.translate(-q.width/2,-q.height/2)}function ri(t){S.lastX=t.pageX-O.offsetParent.offsetLeft,S.lastY=t.pageY-O.offsetParent.offsetTop}function ai(t){S.pinchStart0=a.transformedPoint(t.touches[0].pageX,t.touches[0].pageY),S.pinchStart1=a.transformedPoint(t.touches[1].pageX,t.touches[1].pageY),S.pinched=!0}function lo(t){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");let s=e.createSVGMatrix(),n=[],i=t.save;t.save=function(){return n.push(s.translate(0,0)),i.call(t)};let l=t.restore;t.restore=function(){return s=n.pop(),l.call(t)};let r=t.scale;t.scale=function(p,v){return s=s.scale(p,v),r.call(t,p,v)};let o=t.translate;t.translate=function(p,v){return s=s.translate(p,v),o.call(t,p,v)};let m=t.setTransform;t.setTransform=function(p,v,I,E,T,x){return s.a=p,s.b=v,s.c=I,s.d=E,s.e=T,s.f=x,m.call(t,p,v,I,E,T,x)};let y=e.createSVGPoint();t.transformedPoint=function(p,v){return y.x=p,y.y=v,y.matrixTransform(s.inverse())};let u=t.rotate;t.rotate=function(p){return s=s.rotate(p*180/Math.PI),u.call(t,p)}}function qe(t){if(!f.managing()&&Mn()===null)return;const e=Math.pow(S.scaleFactor,t),s=S.zoomSize*e;if(s<f.MAX_ZOOM&&s>f.MIN_ZOOM){S.zoomSize=s;const n=a.transformedPoint(S.lastX,S.lastY);a.translate(n.x,n.y),a.scale(e,e),a.displayScale=a.displayScale*e,a.translate(-n.x,-n.y),D()}}window.assetUrl=function(t){return rg2Config.asset_url+t};document.readyState!=="loading"?js():document.addEventListener("DOMContentLoaded",js);function js(){const t=document.querySelector(".rg2-startup");t.style.opacity=0,t.style.backgroundColor=f.GREY,document.querySelector(".rg2-startup-content").classList.add("startup-transform"),t.addEventListener("transitionend",()=>{document.getElementById("rg2-header-container").classList.remove("d-none"),t.remove(),ya(),Si(),Kl(),pi(),f.managing()?st(()=>import("./manager-BMrk1T3L.js"),__vite__mapDeps([0,1,2,3]),import.meta.url).then(e=>{rg2Config.manager=e,rg2Config.manager.initialiseManager(),zs()}).catch(()=>{console.log("Error loading manager"),V("Error loading manager","Manager functionality failed to  load.")}):zs()},{once:!0})}function zs(){to(),window.onpopstate=ro,window.location.hash&&!f.managing()&&nn(window.location.hash),document.getElementById("rg2-event-title").innerHTML="Routegadget 2",Cn()}function ro(){if(window.location.hash!==""&&!f.managing()){const t=nn(window.location.hash);Pn(t)&&Wr()!==t&&kt(t)}}class yo{constructor(){if(this.georefsystems=[],this.georefsystems.push({name:"Not georeferenced",description:"none",params:"",value:0}),this.georefsystems.push({name:"GB National Grid",description:"EPSG:27700",params:"+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs",value:1}),this.georefsystems.push({name:"Google EPSG:900913",description:"EPSG:900913",params:"+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs",value:2}),rg2Config.epsg_code!==void 0){const e=rg2Config.epsg_code.split("|"),s=rg2Config.epsg_params.split("|");for(let n=0;n<e.length;n=n+1)this.georefsystems.push({name:e[n].replace(" ",""),description:e[n].replace(" ",""),params:s[n],value:n+3});this.defaultGeorefVal=3}else this.defaultGeorefVal=1}getDefaultValue(){return this.georefsystems[this.defaultGeorefVal].value}getGeorefDropdown(){let e="";for(let s=0;s<this.georefsystems.length;s+=1)e+=bi(s,this.georefsystems[s].name,s===0);return e}getGeorefSystem(e){return this.georefsystems[e]}}class vo{constructor(e){e!==void 0?(this.mapid=e.mapid,this.name=e.name,this.worldfile=new Be(e),this.localworldfile=new Be({A:e.localA,B:e.localB,C:e.localC,D:e.localD,E:e.localE,F:e.localF}),e.mapfilename===void 0?this.mapfilename=this.mapid+".jpg":this.mapfilename=e.mapfilename):(this.mapid=0,this.name="",this.worldfile=new Be(0),this.localworldfile=new Be(0)),this.xpx=[],this.ypx=[],this.lat=[],this.lon=[]}}class bo{constructor(){this.x="",this.name=null,this.password=null}setDetails(e,s){const n=/...../;this.name=document.getElementById(e).value;const i=n.test(this.name);this.password=document.getElementById(s).value;const l=n.test(this.password);return i&&l}alterString(e){const s="abcdefghijklmnopqrstuvwxyz0123456789";let n="";for(let i=0;i<e.length;i+=1){const l=Math.floor(Math.random()*s.length);n+=e.charAt(i)+s.charAt(l)}return n}encodeUser(){return{x:this.alterString(this.name+this.password),user:this.name}}}export{po as A,Li as C,yo as G,vo as M,bo as U,Be as W,uo as a,hs as b,jt as c,ho as d,co as e,P as f,bi as g,f as h,a as i,qt as j,Rn as k,so as l,gt as m,Xe as n,kt as o,go as p,mo as q,D as r,V as s,Zs as t,h as u,fo as v,Fe as w,Cn as x,_n as y,ea as z};
//# sourceMappingURL=main-4FAEMXio.js.map
