// Version 1.10.3 2023-07-19T22:04:42+0100;
!function(){function e(e){this.user=new rg2.User(e),this.newMap=new rg2.Map,this.georefsystems=new rg2.Georefs,this.eventName=null,this.eventDate=null,this.eventLevel=null,this.mapIndex=rg2.config.INVALID_MAP_ID,this.club=null,this.comments=null,this.format=rg2.config.FORMAT_NORMAL,this.isScoreEvent=!1,this.hasResults=!0,this.newcontrols=new rg2.Controls,this.courses=[],this.mapping=[],this.isEnrichCourseNames=!1,this.mapLoaded=!1,this.coursesGeoreferenced=!1,this.controlsAdjusted=!1,this.drawingCourses=!1,this.drawnCourse={},this.results=[],this.variants=[],this.resultCourses=[],this.mapWidth=0,this.mapHeight=0,this.mapFile=void 0,this.resultsOrCourseFile=void 0,this.resultsFileFormat="",this.encodings=["UTF-8","ISO-8859-1","windows-1251"],this.errorCount=[],this.encodingIndex=0,this.useThisEncoding=!1,this.backgroundLocked=!1,this.sortResults=!1,this.handle={x:null,y:null},this.maps=[],this.localworldfile=new rg2.Worldfile(0),this.worldfile=new rg2.Worldfile(0),this.georefmap=L.map("rg2-world-file-map"),this.unusedMaps=[],this.initialiseMap(),this.initialiseUI()}e.prototype={Constructor:e,initialiseUI:function(){var e=this;$("#btn-login").button(),$("rg2-manager-courses").hide(),$("rg2-manager-results").hide(),$("#chk-read-only").prop("checked",!1),$("#rg2-manager-login-form").submit(function(){return e.user.setDetails($("#rg2-user-name").val(),$("#rg2-password").val())?e.logIn():rg2.utils.showWarningDialog("Login failed","Please enter user name and password of at least five characters"),!1})},initialiseMap:function(){L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(this.georefmap)},logIn:function(){var e=rg2Config.json_url+"?type=login",t=JSON.stringify(this.user.encodeUser()),s=this;return $.ajax({type:"POST",dataType:"json",data:t,url:e,cache:!1,success:function(e){s.user.y=e.keksi,e.ok?s.enableEventEdit():rg2.utils.showWarningDialog("Login failed","Login failed. Please try again.")},error:function(){rg2.utils.showWarningDialog("Login failed","User name or password incorrect. Please try again.")}}),!1},setButtons:function(){var t=this;$("#btn-create-event").button().click(function(){t.confirmCreateEvent()}).button("enable"),$("#btn-update-event").button().click(function(){t.confirmUpdateEvent()}).button("disable"),$("#btn-delete-route").button().click(function(){t.confirmDeleteRoute()}).button("disable"),$("#btn-delete-event").button().click(function(){t.confirmDeleteEvent()}).button("disable"),$("#btn-add-map").button().click(function(){t.confirmAddMap()}).button("disable"),$("#btn-delete-unused-maps").button().click(function(){t.confirmDeleteUnusedMaps()}).button("disable"),$("#btn-draw-courses").button().click(function(){t.startDrawingCourses()}),$("#rg2-load-georef-file").button().change(function(e){t.readGeorefFile(e)}),$("#rg2-load-map-file").button().change(function(e){t.validateMapUpload(this.files[0]),t.readMapFile(e)}),$("#rg2-load-results-file").button().click(function(e){t.mapLoaded||(rg2.utils.showWarningDialog("No map loaded","Please load a map file before adding results."),e.preventDefault())}).change(function(e){t.resultsOrCourseFile=e.target.files[0],t.initialiseEncodings(),t.readResults()}),$("#btn-move-map-and-controls").click(function(e){t.toggleMoveAll(e.target.checked)}),$("#btn-no-results").click(function(e){t.toggleResultsRequired(e.target.checked)}),$("#btn-score-event").click(function(e){t.toggleScoreEvent(e.target.checked)}),$("#btn-enrich-course-names").click(function(e){t.toggleEnrichCourseNames(e.target.checked)}),$("#btn-sort-results").click(function(e){t.toggleSortResults(e.target.checked)}),$("#rg2-load-course-file").button().click(function(e){t.mapLoaded||(rg2.utils.showWarningDialog("No map loaded","Please load a map file before adding courses."),e.preventDefault())}).change(function(e){t.readCourses(e)})},validateMapUpload:function(s){var e=new FileReader;e.onload=function(e){var t=new Image;t.src=e.target.result,t.onload=function(){var e=Math.round(s.size/1024/1024);(e>rg2.config.FILE_SIZE_WARNING||this.height>rg2.config.PIXEL_SIZE_WARNING||this.width>rg2.config.PIXEL_SIZE_WARNING)&&(e="The uploaded map file is "+e+"MB ("+this.width,e=(e+=" x "+this.height+"px). It is recommended that you use maps under "+rg2.config.FILE_SIZE_WARNING)+"MB with a maximum dimension of "+rg2.config.PIXEL_SIZE_WARNING+"px. Please see the <a href='https://github.com/Maprunner/rg2/wiki/Map-files'>RG2 wiki</a> for guidance on how to create map files.",rg2.utils.showWarningDialog("Oversized map upload",e))}},e.readAsDataURL(s)},initialiseEncodings:function(){this.encodingIndex=0,this.errorCount=[],this.useThisEncoding=!1},enableEventEdit:function(){var t=this;rg2.managerUI.setUIVisibility(),this.getMaps(),this.setButtons(),rg2.managerUI.createEventLevelDropdown("rg2-event-level"),rg2.managerUI.createEventLevelDropdown("rg2-event-level-edit"),rg2.managerUI.createGeorefDropdown(this.georefsystems),rg2.managerUI.createEventEditDropdown(),$("#rg2-event-level").change(function(){t.eventLevel=$("#rg2-event-level").val(),"X"!==t.eventLevel?$("#rg2-select-event-level").addClass("valid"):$("#rg2-select-event-level").removeClass("valid")}),$("#rg2-map-selected").change(function(){t.mapIndex=parseInt($("#rg2-map-selected").val(),10),t.mapIndex!==rg2.config.INVALID_MAP_ID?($("#rg2-manager-map-select").addClass("valid"),rg2.loadNewMap(rg2Config.maps_url+"/"+t.maps[t.mapIndex].mapfilename)):($("#rg2-manager-map-select").removeClass("valid"),t.mapLoaded=!1,t.mapWidth=0,t.mapHeight=0)}),$("#rg2-event-date").datepicker({dateFormat:"yy-mm-dd",onSelect:function(e){t.setDate(e)}}),$("#rg2-event-name").on("change",function(){t.setEventName()}),$("#rg2-map-name").on("change",function(){t.setMapName()}),$("#rg2-club-name").on("change",function(){t.setClub()}),$("#rg2-new-course-name").on("change",function(){t.setCourseName()}),$("#rg2-manager-event-select").change(function(){rg2.managerUI.setEvent(parseInt($("#rg2-event-selected").val(),10))}),$("#rg2-georef-type").change(function(){t.setGeoref($("#rg2-georef-selected").val())}),$("#rg2-info-panel").tabs("option","active",rg2.config.TAB_CREATE)},getMaps:function(){var t,s=this;$.getJSON(rg2Config.json_url,{type:"maps",cache:!1}).done(function(e){for(s.maps.length=0,console.log("Maps: "+e.data.maps.length),t=0;t<e.data.maps.length;t+=1)s.maps.push(new rg2.Map(e.data.maps[t]));rg2.managerUI.createMapDropdown(s.maps),s.findUnusedMaps(s.maps),rg2.managerUI.displayUnusedMaps(s.unusedMaps),$("#btn-toggle-controls").show()}).fail(function(){rg2.utils.showWarningDialog("Map request failed","Error getting map list.")})},setGeoref:function(e){null!==e&&this.convertWorldFile(e)},eventListLoaded:function(){rg2.managerUI.createEventEditDropdown(),0<this.maps.length&&(this.findUnusedMaps(this.maps),rg2.managerUI.displayUnusedMaps(this.unusedMaps))},eventFinishedLoading:function(){var e=parseInt($("#rg2-event-selected").val(),10);rg2.managerUI.eventFinishedLoading(rg2.events.getEventInfo(e))},startDrawingCourses:function(){this.mapLoaded?(this.drawingCourses=!0,this.courses.length=0,this.newcontrols.deleteAllControls(),this.drawnCourse.name="Course",this.drawnCourse.x=[],this.drawnCourse.y=[],this.drawnCourse.codes=[],this.drawnCourse.courseid=0,$("#rg2-new-course-name").val("Course"),$("#rg2-draw-courses").show()):rg2.utils.showWarningDialog("No map selected","Please load a map before drawing courses")},displayCourseAllocations:function(){var e,t;if(this.courses.length&&this.resultCourses.length){for(t="<div id='rg2-course-alloc'><table><thead><tr><th>Results</th><th>Course</th></tr></thead><tbody>",e=0;e<this.resultCourses.length;e+=1)t+="<tr><td>"+this.resultCourses[e].course+"</td><td>"+this.createCourseDropdown(this.resultCourses[e].course,e)+"</td></tr>";t+="</tbody></table></div>",$("#rg2-course-allocations").empty().append(t)}},createResultCourseMapping:function(){var e;if(!this.hasResults)for(e=this.resultCourses.length=0;e<this.courses.length;e+=1)this.resultCourses.push({courseid:this.courses[e].courseid,course:this.courses[e].name})},validateData:function(){return this.eventName?this.mapIndex===rg2.config.INVALID_MAP_ID?"No map selected.":this.club?this.eventDate?this.eventLevel?this.format?0!==this.courses.length||this.drawingCourses?0===this.results.length&&this.hasResults?"No results information. Check your results file.":this.controlsAdjusted?"OK":"Controls have not been adjusted on the map.":"No course information. Check your course XML file.":"Event format is not valid.":"Event level is not valid.":"Date is not valid.":"Club name is not valid.":"Event name is not valid."},confirmCreateEvent:function(){var e=this.validateData();"OK"!==e?rg2.utils.showWarningDialog("Event set-up incomplete",e+" Please enter all necessary information and make sure controls are aligned before creating the event."):((e={selector:"<div id='event-create-dialog'>Are you sure you want to create this event?</div>",title:"Confirm event creation",classes:"rg2-confirm-create-event-dialog",doText:"Create event"}).onDo=this.doCreateEvent.bind(this),e.onCancel=rg2.managerUI.doCancelCreateEvent.bind(this),rg2.utils.createModalDialog(e))},doCreateEvent:function(){var t,e;$("#event-create-dialog").dialog("destroy"),e=(t=this).generateNewEventData(),$("#rg2-load-progress-label").text("Creating event"),$("#rg2-load-progress").show(),$.ajax({data:e,type:"POST",url:rg2Config.json_url+"?type=createevent",dataType:"json",success:function(e){t.user.y=e.keksi,e.ok?(rg2.utils.showWarningDialog("Event created",t.eventName+" has been added with id "+e.newid+"."),window.open(rg2Config.json_url.replace("rg2api.php","")+"#"+e.newid),rg2.getEvents(),rg2.managerUI.setEvent()):rg2.utils.showWarningDialog("Save failed",e.status_msg+" Failed to create event. Please try again.")},error:function(){rg2.utils.showWarningDialog("Save failed"," Failed to create event.")},complete:function(){$("#rg2-load-progress-label").text(""),$("#rg2-load-progress").hide()}})},generateNewEventData:function(){var e,t,s={};if(s.name=this.eventName,s.mapid=this.maps[this.mapIndex].mapid,s.eventdate=this.eventDate,(e=$("#rg2-event-comments").val())===rg2.config.DEFAULT_EVENT_COMMENT?s.comments="":s.comments=e,s.locked=$("#chk-read-only").prop("checked"),s.club=this.club,this.hasResults?this.isScoreEvent?s.format=rg2.config.FORMAT_SCORE_EVENT:s.format=rg2.config.FORMAT_NORMAL:this.isScoreEvent?s.format=rg2.config.FORMAT_SCORE_EVENT_NO_RESULTS:s.format=rg2.config.FORMAT_NORMAL_NO_RESULTS,s.level=this.eventLevel,this.drawingCourses&&(this.courses.push(this.drawnCourse),this.createResultCourseMapping()),this.setControlLocations(),this.mapResultsToCourses(),this.enrichCourseNames(),this.renumberResults(),this.isScoreEvent&&(this.extractVariants(),s.variants=this.variants.slice(0)),s.courses=this.courses.slice(0),this.sortResults?s.results=this.results.slice(0).sort(this.sortResultItems):s.results=this.results.slice(0),s.format===rg2.config.FORMAT_NORMAL)for(t=0;t<s.results.length;t+=1)(s.results[t].splits.match(/;/g)||[]).length===this.getControlCount(s.courses,s.results[t].courseid)+1&&(s.results[t].splits=s.results[t].splits.substring(0,s.results[t].splits.lastIndexOf(";")));for(t=0;t<s.results.length;t+=1)delete s.results[t].codes,delete s.results[t].chipid,delete s.results[t].club;return e=this.user.encodeUser(),s.x=e.x,s.y=e.y,JSON.stringify(s)},enrichCourseNames:function(){if(this.isEnrichCourseNames)for(var e=0;e<this.courses.length;e+=1)this.courses[e].name=this.enrichCourseName(this.courses[e].name)},getControlCount:function(e,t){for(var s=0;s<e.length;s+=1)if(e[s].courseid===t)return e[s].controlcount;return 0},hasZeroTime:function(e){return 0===e||"0"===e||"0:00"===e||"00:00"===e},sortResultItems:function(e,t){return e.courseid!==t.courseid?e.courseid-t.courseid:""!==e.position&&""!==t.position?e.position-t.position:""===e.position&&""!==t.position?1:""!==e.position&&""===t.position?-1:this.rg2.Manager.prototype.hasZeroTime(e.time)&&this.rg2.Manager.prototype.hasZeroTime(t.time)?e.name-t.name:e.time-t.time},renumberResults:function(){for(var e,t=[],s=0;s<this.results.length;s+=1)(e=this.getCourseIDForResult(this.results[s].course))!==rg2.config.DO_NOT_SAVE_COURSE&&(this.results[s].courseid=e,this.results[s].course=this.getCourseName(e),this.results[s].variantid="",t.push(this.results[s]));this.results=t},getCourseName:function(e){for(var t=0;t<this.courses.length;t+=1)if(this.courses[t].courseid===e)return this.courses[t].name;return 0},mapResultsToCourses:function(){for(var e,t=[],s=1,r=0;r<this.resultCourses.length;r+=1)(e=this.drawingCourses?0:parseInt($("#rg2-alloc-"+r).val(),10))!==rg2.config.DO_NOT_SAVE_COURSE&&(0===this.courses[e].courseid?(this.courses[e].courseid=s,t.push(this.courses[e]),this.resultCourses[r].courseid=s,s+=1):this.resultCourses[r].courseid=this.courses[e].courseid);this.courses=t},enrichCourseName:function(e){var t,s="";if(this.mapping&&0<this.mapping.length&&this.isEnrichCourseNames)for(t=0;t<this.mapping.length;t+=1)this.mapping[t].course===e&&(""!==s&&(s+=", "),s+=this.mapping[t].className.replace(/ /g,"").replace(/-/g,""));return""!==s?e+": "+s:e},createCourseDropdown:function(e,t){for(var s,r,n=-1,o=0;o<this.courses.length;o+=1)if(this.courses[o].name===e){n=o;break}if(-1===n&&0<this.mapping.length)for(o=0;o<this.mapping.length;o+=1)if(this.mapping[o].className===e){for(s=0;s<this.courses.length;s+=1)if(this.courses[s].name===this.mapping[o].course){n=s;break}break}for(r="<select id='rg2-alloc-"+t+"'><option value="+rg2.config.DO_NOT_SAVE_COURSE,-1===n&&(r+=" selected"),r+=">Do not save</option>",o=0;o<this.courses.length;o+=1)r+="<option value="+o,n===o&&(r+=" selected"),r+=">"+this.enrichCourseName(this.courses[o].name)+"</option>";return r+="</select>"},extractVariants:function(){for(var e,t,s,r=this.variants.length=0;r<this.results.length;r+=1){for(t=this.results[r].codes,e=0;e<this.courses.length;e+=1)if(this.courses[e].courseid===this.results[r].courseid){s=this.courses[e];break}t.unshift(s.codes[0]),t.push(s.codes[s.codes.length-1]),this.results[r].variantid=this.getVariantID(this.results[r].codes,this.results[r].courseid)}},getVariantID:function(e,t){for(var s,r,n,o=[],i=[],a=0,l=0;l<this.variants.length;l+=1)if(this.variants[l].codes.length===e.length){for(n=!0,s=0;s<e.length;s+=1)if(this.variants[l].codes[s]!==e[s]){n=!1;break}if(n){a=l+1;break}}if(0===a){for(a=this.variants.length+1,l=0;l<e.length;l+=1)r=this.getControlXY(e[l]),o.push(r.x),i.push(r.y);this.variants.push({x:o,y:i,id:a,courseid:t,name:"Variant "+a,codes:e})}return a},getCourseIDForResult:function(e){for(var t=0;t<this.resultCourses.length;t+=1)if(this.resultCourses[t].course===e)return this.resultCourses[t].courseid;return 0},setControlLocations:function(){for(var e,t,s=0;s<this.courses.length;s+=1)for(e=0;e<this.courses[s].codes.length;e+=1)t=this.getControlXY(this.courses[s].codes[e]),this.courses[s].x[e]=t.x,this.courses[s].y[e]=t.y},getControlXY:function(e){for(var t={x:0,y:0},s=0;s<this.newcontrols.controls.length;s+=1)if(this.newcontrols.controls[s].code===e)return t.x=Math.round(this.newcontrols.controls[s].x),t.y=Math.round(this.newcontrols.controls[s].y),t;return t},confirmUpdateEvent:function(){var e={selector:"<div id='event-update-dialog'>Are you sure you want to update this event?</div>",title:"Confirm event update",classes:"rg2-confirm-update-dialog",doText:"Update event"};e.onDo=this.doUpdateEvent.bind(this),e.onCancel=rg2.managerUI.doCancelUpdateEvent.bind(this),rg2.utils.createModalDialog(e)},doUpdateEvent:function(){var t,e,s,r,n;$("#event-update-dialog").dialog("destroy"),t=$("#rg2-event-selected").val(),e=rg2Config.json_url+"?type=editevent&id="+t,(s={}).comments=$("#rg2-edit-event-comments").val(),s.locked=$("#chk-edit-read-only").prop("checked"),s.name=$("#rg2-event-name-edit").val(),s.type=$("#rg2-event-level-edit").val(),s.eventdate=$("#rg2-event-date-edit").val(),s.club=$("#rg2-club-name-edit").val(),s.exclude=$("#rg2-edit-exclude").val().trim(),n=this.user.encodeUser(),s.x=n.x,s.y=n.y,n=JSON.stringify(s),r=this,$.ajax({data:n,type:"POST",url:e,dataType:"json",success:function(e){r.user.y=e.keksi,e.ok?(rg2.utils.showWarningDialog("Event updated","Event "+t+" has been updated."),rg2.events.setActiveEventID(null),rg2.ui.setTitleBar(),rg2.getEvents(),rg2.managerUI.setEvent()):rg2.utils.showWarningDialog("Update failed",e.status_msg+". Event update failed. Please try again.")},error:function(e,t){rg2.utils.showWarningDialog("Update failed",t+". Event update failed.")}})},confirmDeleteRoute:function(){var e={selector:"<div id='route-delete-dialog'>This route will be permanently deleted. Are you sure?</div>",title:"Confirm route delete",classes:"rg2-confirm-route-delete-dialog",doText:"Delete route"};e.onDo=this.doDeleteRoute.bind(this),e.onCancel=rg2.managerUI.doCancelDeleteRoute.bind(this),rg2.utils.createModalDialog(e)},doDeleteRoute:function(){var e,t,s,r;$("#route-delete-dialog").dialog("destroy"),e=$("#rg2-event-selected").val(),t=$("#rg2-route-selected").val(),e=rg2Config.json_url+"?type=deleteroute&id="+e+"&routeid="+t,s=JSON.stringify(this.user.encodeUser()),r=this,$.ajax({data:s,type:"POST",url:e,dataType:"json",success:function(e){r.user.y=e.keksi,e.ok?rg2.utils.showWarningDialog("Route deleted","Route "+t+" has been deleted."):rg2.utils.showWarningDialog("Delete failed",e.status_msg+". Delete failed. Please try again.")},error:function(e,t){rg2.utils.showWarningDialog("Delete failed",t+". Delete failed.")}})},confirmDeleteEvent:function(){var e={selector:"<div id='event-delete-dialog'>This event will be deleted. Are you sure?</div>",title:"Confirm event delete",classes:"rg2-confirm-delete-event-dialog",doText:"Delete event"};e.onDo=this.doDeleteEvent.bind(this),e.onCancel=rg2.managerUI.doCancelDeleteEvent.bind(this),rg2.utils.createModalDialog(e)},doDeleteEvent:function(){var t,e,s,r;$("#event-delete-dialog").dialog("destroy"),t=$("#rg2-event-selected").val(),e=rg2Config.json_url+"?type=deleteevent&id="+t,s=JSON.stringify(this.user.encodeUser()),r=this,$.ajax({data:s,type:"POST",url:e,dataType:"json",success:function(e){r.user.y=e.keksi,e.ok?(rg2.utils.showWarningDialog("Event deleted","Event "+t+" has been deleted."),rg2.getEvents(),rg2.managerUI.setEvent(),$("#rg2-event-selected").empty()):rg2.utils.showWarningDialog("Delete failed",e.status_msg+". Event delete failed. Please try again.")},error:function(e,t){rg2.utils.showWarningDialog("Delete failed",t+". Delete failed.")}})},readResults:function(){var e,t=new FileReader,s=this;t.onerror=function(){rg2.utils.showWarningDialog("Results file error","The selected results file could not be read.")},t.onload=function(e){s.checkResultsFileEncoding(e)},"XML"===(e=this.resultsOrCourseFile.name.substr(-3,3).toUpperCase())||"CSV"===e?(this.resultsFileFormat=e,t.readAsText(this.resultsOrCourseFile,this.encodings[this.encodingIndex])):rg2.utils.showWarningDialog("File type error","Results file type is not recognised. Please select a valid file.")},checkResultsFileEncoding:function(e){var t,s,r=this.testForInvalidCharacters(e.target.result);if(0===r||this.useThisEncoding)this.processResultFile(e);else{if(this.errorCount[this.encodingIndex]=r,this.encodingIndex+=1,this.encodingIndex===this.encodings.length){for(t=99999,s=0;s<this.encodings.length;s+=1)t>this.errorCount[s]&&(this.encodingIndex=s,t=this.errorCount[s]);this.useThisEncoding=!0}this.readResults()}},processResultFile:function(e){e=new rg2.ResultParser(e,this.resultsFileFormat);this.results=e.results,this.resultCourses=e.resultCourses,e.valid?$("#rg2-select-results-file").addClass("valid"):$("#rg2-select-results-file").removeClass("valid"),rg2.managerUI.displayResultInfo(this.getResultInfoAsHTML()),this.displayCourseAllocations()},readCourses:function(e){var t,s=new FileReader;s.onerror=function(){rg2.utils.showWarningDialog("Course file error","The selected course file could not be read.")},t=this,s.onload=function(e){t.processCourseFile(e)},s.readAsText(e.target.files[0])},processCourseFile:function(e){this.coursesGeoreferenced=!1,this.backgroundLocked=!1,$("#btn-move-map-and-controls").prop("checked",!1),this.handle={x:null,y:null},this.newcontrols.deleteAllControls(),e=new rg2.CourseParser(e,this.worldfile,this.localworldfile),this.courses=e.courses,this.newcontrols=e.newcontrols,this.mapping=e.mapping,0<this.mapping.length?$("#rg2-enrich-course-names").show():$("#rg2-enrich-course-names").hide(),this.coursesGeoreferenced=e.georeferenced,rg2.managerUI.displayCourseInfo(this.getCourseInfoAsHTML()),this.createResultCourseMapping(),this.displayCourseAllocations(),this.fitControlsToMap(),rg2.redraw(!1)},getCourseInfoAsHTML:function(){var e,t;if(this.courses.length){for(e="<table><thead><tr><th>Course</th><th>Name</th><th>Controls</th></tr></thead><tbody>",t=0;t<this.courses.length;t+=1)e+="<tr><td>"+(t+1)+"</td><td>"+this.courses[t].name+"</td><td>"+(this.courses[t].codes.length-2)+"</td></tr>";e+="</tbody></table>"}else e="";return e},getResultInfoAsHTML:function(){var e,t,s,r;if(this.results.length){for(e="<table><thead><tr><th>Course</th><th>Winner</th><th>Time</th><th class='align-center'>Runners</th></tr></thead><tbody>",r=null,t=s=0;t<this.results.length;t+=1)this.results[t].course!==r&&(null!==r&&(e+="<td class='align-center'>"+s+"</td></tr>",s=0),e+="<tr><td>"+this.results[t].course+"</td><td>"+this.results[t].name+"</td><td>"+this.results[t].time+"</td>",r=this.results[t].course),s+=1;e+="<td class='align-center'>"+s+"</td></tr></tbody></table>"}else e="No valid results found.";return e},testForInvalidCharacters:function(e){for(var t=0,s=0;s<e.length;s+=1)65533===e.charCodeAt(s)&&(t+=1);return t},readMapFile:function(e){var t,s=new FileReader,r=this;s.onload=function(e){r.processMap(e)},"JPG"===(t=e.target.files[0].name.substr(-3,3).toUpperCase())||"GIF"===t?(this.mapFile=e.target.files[0],s.readAsDataURL(e.target.files[0])):rg2.utils.showWarningDialog("File type error",e.target.files[0].name+" is not recognised. Only .jpg and .gif files are supported at present.")},mapLoadCallback:function(){var e;this.mapLoaded=!0,this.mapIndex!==rg2.config.INVALID_MAP_ID&&(this.localworldfile=this.maps[this.mapIndex].localworldfile,this.worldfile=this.maps[this.mapIndex].worldfile),e=rg2.getMapSize(),this.mapWidth=e.width,this.mapHeight=e.height,this.fitControlsToMap(),rg2.redraw(!1)},processMap:function(e){rg2.loadNewMap(e.target.result),$("#rg2-select-map-file").addClass("valid"),this.mapLoaded=!0,e=rg2.getMapSize(),this.mapWidth=e.width,this.mapHeight=e.height,this.fitControlsToMap(),rg2.redraw(!1),$("#btn-add-map").button("enable")},fitControlsToMap:function(){var e,t,s=!1;if(this.mapLoaded&&0<this.newcontrols.controls.length){if(t=this.getBoundingBox(),this.coursesGeoreferenced&&(t.maxX<0||t.minX>this.mapWidth||t.minY>this.mapHeight||t.maxY<0?rg2.utils.showWarningDialog("Course file problem","Your course file does not match the map co-ordinates. Please check you have selected the correct file."):s=!0),s)this.backgroundLocked=!0,this.controlsAdjusted=!0,$("#btn-move-map-and-controls").prop("checked",!0);else for(e=0;e<this.newcontrols.controls.length;e+=1)this.newcontrols.controls[e].x=(this.newcontrols.controls[e].x-t.minX)*(this.mapWidth/t.xRange)*.8+this.mapWidth*(1-.8)*.5,this.newcontrols.controls[e].y=this.mapHeight-(this.newcontrols.controls[e].y-t.minY)*(this.mapHeight/t.yRange)*.8-this.mapHeight*(1-.8)*.5;this.copyXYToOldXY(),this.newcontrols.displayAllControls()}},getBoundingBox:function(){var e,t={};for(t.minX=this.newcontrols.controls[0].x,t.maxX=this.newcontrols.controls[0].x,t.minY=this.newcontrols.controls[0].y,t.maxY=this.newcontrols.controls[0].y,e=1;e<this.newcontrols.controls.length;e+=1)t.maxX=Math.max(t.maxX,this.newcontrols.controls[e].x),t.maxY=Math.max(t.maxY,this.newcontrols.controls[e].y),t.minX=Math.min(t.minX,this.newcontrols.controls[e].x),t.minY=Math.min(t.minY,this.newcontrols.controls[e].y);return t.xRange=t.maxX-t.minX,t.yRange=t.maxY-t.minY,t},copyXYToOldXY:function(){for(var e=0;e<this.newcontrols.controls.length;e+=1)this.newcontrols.controls[e].oldX=this.newcontrols.controls[e].x,this.newcontrols.controls[e].oldY=this.newcontrols.controls[e].y},setClub:function(){this.club=$("#rg2-club-name").val(),this.club?$("#rg2-select-club-name").addClass("valid"):$("#rg2-select-club-name").removeClass("valid")},setEventName:function(){this.eventName=$("#rg2-event-name").val(),this.eventName?$("#rg2-select-event-name").addClass("valid"):$("#rg2-select-event-name").removeClass("valid")},setCourseName:function(){var e=$("#rg2-new-course-name").val();e&&(this.drawnCourse.name=e)},setMapName:function(){this.newMap.name=$("#rg2-map-name").val(),this.newMap.name?$("#rg2-select-map-name").addClass("valid"):$("#rg2-select-map-name").removeClass("valid")},setDate:function(e){this.eventDate=e,this.eventDate?$("#rg2-select-event-date").addClass("valid"):$("#rg2-select-event-date").removeClass("valid")},drawControls:function(){var e;this.mapLoaded&&0<this.newcontrols.controls.length&&(this.newcontrols.drawControls(!0),e=rg2.getOverprintDetails(),null!==this.handle.x)&&(rg2.ctx.lineWidth=e.overprintWidth,rg2.ctx.strokeStyle=rg2.config.HANDLE_COLOUR,rg2.ctx.fillStyle=rg2.config.HANDLE_COLOUR,rg2.ctx.globalAlpha=1,rg2.ctx.beginPath(),rg2.ctx.arc(this.handle.x,this.handle.y,rg2.config.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),rg2.ctx.fill(),rg2.ctx.beginPath(),rg2.ctx.arc(this.handle.x,this.handle.y,2*rg2.config.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),rg2.ctx.stroke())},adjustControls:function(e,t,s){var r,n,o,i,a,l,u;if(this.backgroundLocked||s===rg2.config.RIGHT_CLICK)rg2.ctx.translate(t.x-e.x,t.y-e.y);else if(this.controlsAdjusted=!0,null!==this.handle.x){if(l=(t.x-this.handle.x)/(e.x-this.handle.x),u=(t.y-this.handle.y)/(e.y-this.handle.y),isFinite(l)&&isFinite(u))for(r=0;r<this.newcontrols.controls.length;r+=1)n=this.newcontrols.controls[r].oldX-this.handle.x,o=this.newcontrols.controls[r].oldY-this.handle.y,this.newcontrols.controls[r].x=n*l+this.handle.x,this.newcontrols.controls[r].y=o*u+this.handle.y}else for(i=t.x-e.x,a=t.y-e.y,r=0;r<this.newcontrols.controls.length;r+=1)this.newcontrols.controls[r].x=this.newcontrols.controls[r].oldX+i,this.newcontrols.controls[r].y=this.newcontrols.controls[r].oldY+a},dragEnded:function(){this.mapLoaded&&0<this.newcontrols.controls.length&&this.copyXYToOldXY()},mouseUp:function(e,t){this.drawingCourses?(this.addNewControl(e,t),this.controlsAdjusted=!0):this.mapLoaded&&0<this.newcontrols.controls.length&&(null===this.handle.x?this.handle={x:e,y:t}:this.handle={x:null,y:null})},addNewControl:function(e,t){var s=0===this.newcontrols.controls.length?"S"+(this.newcontrols.controls.length+1):"X"+(this.newcontrols.controls.length+1);this.newcontrols.addControl(s,e,t),this.newcontrols.displayAllControls(),this.drawnCourse.codes.push(s),this.drawnCourse.x.push(e),this.drawnCourse.y.push(t)},toggleMoveAll:function(e){this.backgroundLocked=e},toggleSortResults:function(e){this.sortResults=e},toggleResultsRequired:function(e){this.hasResults=!e,this.createResultCourseMapping(),this.displayCourseAllocations()},toggleScoreEvent:function(e){this.isScoreEvent=e},toggleEnrichCourseNames:function(e){this.isEnrichCourseNames=e,this.displayCourseAllocations()},confirmAddMap:function(){var e={selector:"<div id='add-map-dialog'>Are you sure you want to add this map?</div>",title:"Confirm new map",classes:"rg2-confirm-add-map-dialog",doText:"Add map"};e.onDo=this.doUploadMapFile.bind(this),e.onCancel=rg2.managerUI.doCancelAddMap.bind(this),rg2.utils.createModalDialog(e)},doUploadMapFile:function(){var e,t,s,r;$("#add-map-dialog").dialog("destroy"),e=rg2Config.json_url+"?type=uploadmapfile",t=this.user.encodeUser(),s=this,(r=new FormData).append(this.mapFile.name,this.mapFile),r.append("name",this.mapFile.name),r.append("x",t.x),r.append("y",t.y),$("#rg2-load-progress-label").text("Saving map"),$("#rg2-load-progress").show(),$.ajax({url:e,data:r,type:"POST",mimeType:"multipart/form-data",processData:!1,contentType:!1,dataType:"json",success:function(e){s.user.y=e.keksi,e.ok?s.doAddMap():rg2.utils.showWarningDialog("Save failed",e.status_msg+". Failed to save map. Please try again.")},error:function(e,t){console.log(t)},complete:function(){$("#rg2-load-progress-label").text(""),$("#rg2-load-progress").hide()}})},doAddMap:function(){var e,t,s=rg2Config.json_url+"?type=addmap",r={};this.newMap.localworldfile=this.localworldfile,r=this.newMap,e=this.user.encodeUser(),r.x=e.x,r.y=e.y,e=JSON.stringify(r),t=this,$.ajax({data:e,type:"POST",url:s,dataType:"json",success:function(e){t.user.y=e.keksi,e.ok?(rg2.utils.showWarningDialog("Map added",t.newMap.name+" has been added with id "+e.newid+"."),t.getMaps()):rg2.utils.showWarningDialog("Save failed",e.status_msg+". Failed to save map. Please try again.")},error:function(e,t){console.log(t)}})},readGeorefFile:function(e){var t=new FileReader,s=this;try{t.readAsText(e.target.files[0])}catch(e){return void rg2.utils.showWarningDialog("File read error","Failed to open selected world file.")}t.onerror=function(){rg2.utils.showWarningDialog("World file error","The selected world file could not be read.")},t.onload=function(e){e=e.target.result.split(/[\r\n]+/g);delete s.localworldfile,s.localworldfile=new rg2.Worldfile({A:e[0],B:e[2],C:e[4],D:e[1],E:e[3],F:e[5]}),$("#rg2-georef-selected").val(s.georefsystems.getDefault()),s.convertWorldFile(s.georefsystems.getDefault())}},convertWorldFile:function(e){try{var t,s,r,n,o,i,a,l,u,g,c=rg2.getMapSize();if(this.mapWidth=c.width,this.mapHeight=c.height,!this.localworldfile.valid||0===this.mapWidth||"none"===e)throw"Do not georeference";for(Proj4js.defs[e]=this.georefsystems.getParams(e),s=new Proj4js.Proj(e),r=new Proj4js.Proj("EPSG:4326"),i=[0,this.mapWidth,this.mapWidth,0],a=[0,this.mapHeight,0,this.mapHeight],n=[],o=[],t=0;t<4;t+=1)n[t]=this.localworldfile.getLon(i[t],a[t]),o[t]=this.localworldfile.getLat(i[t],a[t]);for(this.newMap.xpx.length=0,this.newMap.ypx.length=0,this.newMap.lat.length=0,this.newMap.lon.length=0,l=[],t=0;t<4;t+=1)(u={}).x=n[t],u.y=o[t],l.push(u),Proj4js.transform(s,r,l[t]),this.newMap.xpx.push(i[t]),this.newMap.ypx.push(a[t]),this.newMap.lat.push(l[t].y),this.newMap.lon.push(l[t].x);(g={}).C=l[0].x,g.F=l[0].y,g.A=(l[2].x-g.C)/i[2],g.B=(l[3].x-g.C)/a[3],g.D=(l[2].y-g.F)/i[2],g.E=(l[3].y-g.F)/a[3],delete this.newMap.worldfile,this.newMap.worldfile=new rg2.Worldfile(g),this.updateGeorefDisplay(),this.updateGeorefMap()}catch(e){delete this.newMap.worldfile,this.newMap.worldfile=new rg2.Worldfile(0),this.updateGeorefDisplay(),this.updateGeorefMap()}},updateGeorefDisplay:function(){for(var e=["A","B","C","D","E","F"],t=0;t<e.length;t+=1)$("#georef-"+e[t]).empty().text(e[t]+": "+this.newMap.worldfile[e[t]])},updateGeorefMap:function(){var e,t=this.newMap.lon,s=this.newMap.lat,r=[];[3,1,2,0].forEach(function(e){r.push([s[e],t[e]])}),(e=L.polygon(r,{color:"red"})).addTo(this.georefmap),$("#rg2-world-file-map").show(),this.georefmap.invalidateSize(),this.georefmap.fitBounds(e.getBounds())},confirmDeleteUnusedMaps:function(){var t=$(".unused-map:checkbox:checked").map(function(){return parseInt(this.value,10)}).get();if(0===t.length)rg2.utils.showWarningDialog("Warning","No maps selected.");else{for(let e=0;e<this.unusedMaps.length;e+=1)-1<t.indexOf(this.unusedMaps[e].mapid)?this.unusedMaps[e].delete=!0:this.unusedMaps[e].delete=!1;var e={selector:"<div id='unused-maps-delete-dialog'>Selected maps will be deleted. Are you sure?</div>",title:"Confirm map deletion",classes:"rg2-confirm-unused-map-delete-dialog",doText:"Delete maps"};e.onDo=this.doDeleteUnusedMaps.bind(this),e.onCancel=rg2.managerUI.doCancelDeleteUnusedMaps.bind(this),rg2.utils.createModalDialog(e)}},doDeleteUnusedMaps:function(){$("#unused-maps-delete-dialog").dialog("destroy");var e=rg2Config.json_url+"?type=deleteunusedmaps",t={},s=(t.maps=this.unusedMaps.filter(e=>!0===e.delete).map(e=>e.mapid),this.user.encodeUser()),s=(t.x=s.x,t.y=s.y,JSON.stringify(t));const r=this;$.ajax({data:s,type:"POST",url:e,dataType:"json",success:function(e){r.user.y=e.keksi,e.ok?rg2.utils.showWarningDialog("Maps deleted","All selected maps have been deleted."):rg2.utils.showWarningDialog("Delete failed",e.status_msg+". Delete failed. Please try again.")},error:function(e,t){rg2.utils.showWarningDialog("Delete failed",t+". Unused map deletion failed.")},complete:function(){r.getMaps()}})},findUnusedMaps:function(t){for(let e=this.unusedMaps.length=0;e<t.length;e+=1){var s;rg2.events.mapIDIsInUse(t[e].mapid)||((s={}).mapid=t[e].mapid,s.name=t[e].name,""===s.name&&(s.name="(None)"),s.delete=!1,this.unusedMaps.push(s))}}},rg2.Manager=e}(),function(){function e(e,t,s){return this.courses=[],this.courseClassMapping=[],this.newcontrols=new rg2.Controls,this.courses.length=0,this.courseClassMapping.length=0,this.fromOldCondes=!1,this.coursesGeoreferenced=!1,this.newcontrols.deleteAllControls(),this.localWorldfile=s,this.worldfile=t,this.processCoursesXML(e.target.result),this.addControlCount(),{courses:this.courses,newcontrols:this.newcontrols,mapping:this.courseClassMapping,georeferenced:this.coursesGeoreferenced}}e.prototype={Constructor:e,processCoursesXML:function(e){var t,s;try{t=$.parseXML(e)}catch(e){return void rg2.utils.showWarningDialog("XML file error","File is not a valid XML course file.")}if(0===t.getElementsByTagName("CourseData").length)"kml"===t.documentElement.nodeName?this.processKMLCourses(t):rg2.utils.showWarningDialog("XML file error","File is not a valid XML course file. CourseData element missing.");else switch(s=this.getVersion(t)){case"2.0.3":this.processIOFV2XMLCourses(t);break;case"3.0":this.processIOFV3XMLCourses(t);break;default:rg2.utils.showWarningDialog("XML file error","Invalid IOF file format. Version "+s+" not supported.")}},getVersion:function(e){var t="",s=e.getElementsByTagName("IOFVersion");return""===(t=0<s.length?s[0].getAttribute("version"):t)&&0<(s=e.getElementsByTagName("CourseData")).length&&(t=s[0].getAttribute("iofVersion").trim(),this.setCreator(s[0].getAttribute("creator").trim())),t},setCreator:function(e){-1<e.indexOf("Condes")&&15<e.length&&parseFloat(e.substring(15))<10.1&&(this.fromOldCondes=!0)},processIOFV3XMLCourses:function(e){for(var t,s,r=e.getElementsByTagName("Control"),n={x:0,y:0},o=[],i=0;i<r.length;i+=1)"RaceCourseData"===r[i].parentNode.nodeName&&(s=r[i].getElementsByTagName("Id")[0].textContent,t=r[i].getElementsByTagName("Position"),this.localWorldfile.valid&&0<t.length?(n=this.getXYFromLatLng(t),this.coursesGeoreferenced=!0):n=this.getXYFromMapPosition(r[i].getElementsByTagName("MapPosition")),"CrossingPoint"!==r[i].getAttribute("type"))&&(this.newcontrols.addControl(s.trim(),n.x,n.y),(s={}).id=i,0<t.length?(s.lat=parseFloat(t[0].getAttribute("lat")),s.lng=parseFloat(t[0].getAttribute("lng"))):(s.lat=0,s.lng=0),s.x=n.x,s.y=n.y,o.push(s));r=e.getElementsByTagName("Course"),this.extractV3Courses(r),r=e.getElementsByTagName("ClassCourseAssignment"),this.extractV3CourseClassMapping(r)},processKMLCourses:function(e){var t,s,r,n,o,i,a,l=[];for(this.coursesGeoreferenced=!0,t=e.getElementsByTagName("Placemark"),n=0;n<t.length;n+=1)s={},r=t[n].getElementsByTagName("name")[0].childNodes[0].nodeValue.trim(),i=+(a=t[n].getElementsByTagName("Point")[0].getElementsByTagName("coordinates")[0].childNodes[0].nodeValue.trim().split(","))[1],a=+a[0],s.x=this.worldfile.getX(a,i),s.y=this.worldfile.getY(a,i),this.newcontrols.addControl(r.trim(),s.x,s.y),(r={}).id=n+1,r.lat=i,r.lng=a,r.x=s.x,r.y=s.y,l.push(r);e="Course 1",o=this.newcontrols.controls.map(function(e){return e.code}),this.courses.push({courseid:0,x:[],y:[],codes:o,name:e}),this.courseClassMapping.push({course:e,className:"Course 1"}),$("#rg2-select-course-file").addClass("valid")},getXYFromLatLng:function(e){var t={x:0,y:0},s=parseFloat(e[0].getAttribute("lat")),e=parseFloat(e[0].getAttribute("lng"));return this.fromOldCondes?(t.x=this.localWorldfile.getX(e,s),t.y=this.localWorldfile.getY(e,s)):(t.x=this.worldfile.getX(e,s),t.y=this.worldfile.getY(e,s)),t},processIOFV2XMLCourses:function(e){var t,s,r;if(this.extractV2Controls(e.getElementsByTagName("StartPoint"),"StartPointCode"),this.extractV2Controls(e.getElementsByTagName("Control"),"ControlCode"),this.coursesGeoreferenced=this.extractV2Controls(e.getElementsByTagName("FinishPoint"),"FinishPointCode"),this.coursesGeoreferenced&&this.localWorldfile.valid)for(t=0;t<this.newcontrols.controls.length;t+=1)s=this.newcontrols.controls[t].x,r=this.newcontrols.controls[t].y,this.newcontrols.controls[t].x=this.localWorldfile.getX(s,r),this.newcontrols.controls[t].y=this.localWorldfile.getY(s,r);this.extractV2Courses(e.getElementsByTagName("Course"))},extractV2Courses:function(e){for(var t,s,r,n,o=0;o<e.length;o+=1)s=[],r=[],n=[],t=e[o].getElementsByTagName("CourseName")[0].textContent.trim(),(s=this.extractCodesFromControlList(e[o],"ControlCode")).unshift(e[o].getElementsByTagName("StartPointCode")[0].textContent.trim()),s.push(e[o].getElementsByTagName("FinishPointCode")[0].textContent.trim()),this.courses.push({courseid:0,x:r,y:n,codes:s,name:t});$("#rg2-select-course-file").addClass("valid")},extractV3Courses:function(e){for(var t,s,r,n,o=0;o<e.length;o+=1)r=[],n=[],t=e[o].getElementsByTagName("Name")[0].textContent.trim(),s=this.extractCodesFromControlList(e[o],"Control"),this.courses.push({courseid:0,x:r,y:n,codes:s,name:t});$("#rg2-select-course-file").addClass("valid")},extractV3CourseClassMapping:function(e){for(var t,s,r=0;r<e.length;r+=1)t=e[r].getElementsByTagName("CourseName")[0].textContent.trim(),s=e[r].getElementsByTagName("ClassName")[0].textContent.trim(),this.courseClassMapping.push({course:t,className:s});$("#rg2-select-course-file").addClass("valid")},extractCodesFromControlList:function(e,t){for(var s,r=e.getElementsByTagName("CourseControl"),n=[],o=0;o<r.length;o+=1)0!==o&&"Start"===r[o].getAttribute("type")||(s=r[o].getElementsByTagName(t)[0].textContent.trim(),this.validControlCode(s)&&n.push(s));return n},extractV2Controls:function(e,t){for(var s,r,n=!1,o={x:0,y:0},i=0;i<e.length;i+=1)s=e[i].getElementsByTagName(t)[0].textContent,0<(r=e[i].getElementsByTagName("ControlPosition")).length&&this.localWorldfile.valid?(o.x=parseFloat(r[0].getAttribute("x")),o.y=parseFloat(r[0].getAttribute("y")),n=!0):o=this.getXYFromMapPosition(e[i].getElementsByTagName("MapPosition")),this.newcontrols.addControl(s.trim(),o.x,o.y);return n},getXYFromMapPosition:function(e){return{x:e[0].getAttribute("x").replace(",","."),y:e[0].getAttribute("y").replace(",",".")}},validControlCode:function(e){for(var t=this.newcontrols.controls,s=0;s<t.length;s+=1)if(t[s].code===e)return!0;return!1},addControlCount:function(){for(var e=0;e<this.courses.length;e+=1)this.courses[e].controlcount=this.courses[e].codes.length-2}},rg2.CourseParser=e}(),function(){function e(e){return this.results=[],this.valid=!0,this.processIOFV2Results(e),{results:this.results,valid:this.valid}}e.prototype={Constructor:e,getDBID:function(e,t){return 0!==e.length&&(e=e[0].textContent.replace(/[\n\r]/g,"").trim())||t},getName:function(e){return(e.getElementsByTagName("Given")[0].textContent+" "+e.getElementsByTagName("Family")[0].textContent).replace(/[\n\r]/g,"").trim()},processIOFV2Results:function(e){var t,s,r,n,o,i,a;try{for(t=e.getElementsByTagName("ClassResult"),n=0;n<t.length;n+=1)for(a=t[n].getElementsByTagName("ClassShortName")[0].textContent,s=t[n].getElementsByTagName("PersonResult"),o=0;o<s.length;o+=1)(i={}).course=a,i.name=this.getName(s[o]),i.dbid=this.getDBID(s[o].getElementsByTagName("PersonId"),o),i.club=rg2.utils.extractTextContentZero(s[o].getElementsByTagName("ShortName"),""),r=s[o].getElementsByTagName("Result"),this.extractIOFV2Results(r,i),"DidNotStart"!==i.status&&this.results.push(i)}catch(e){this.valid=!1,rg2.utils.showWarningDialog("XML parse error","Error processing XML file. Error is : "+e.message)}},getStartFinishTimeAsSecs:function(e){return 0<e.length?(e=e[0].getElementsByTagName("Clock")[0].textContent,rg2.utils.getSecsFromHHMMSS(e)):0},getPosition:function(e){return 0<e.length?parseInt(e[0].textContent,10):""},getTime:function(e){return 0<e.length?e[0].textContent.replace(/[\n\r]/g,""):""},extractIOFV2Results:function(e,t){for(var s,r=0;r<e.length;r+=1)t.status=rg2.utils.extractAttributeZero(e[r].getElementsByTagName("CompetitorStatus"),"value",""),t.position=this.getPosition(e[r].getElementsByTagName("ResultPosition")),t.chipid=rg2.utils.extractTextContentZero(e[r].getElementsByTagName("CCardId"),0),t.time=this.getTime(e[r].getElementsByTagName("Time")),t.starttime=this.getStartFinishTimeAsSecs(e[r].getElementsByTagName("StartTime")),t.splits="",t.codes=[],s=e[r].getElementsByTagName("SplitTime"),t.controls=s.length,this.extractIOFV2Splits(s,t),s=this.getStartFinishTimeAsSecs(e[r].getElementsByTagName("FinishTime")),t.splits+=Math.max(s-t.starttime,0)},extractIOFV2Splits:function(e,t){for(var s,r=0;r<e.length;r+=1)0<r&&(t.splits+=";"),0<(s=e[r].getElementsByTagName("Time")).length?(t.splits+=rg2.utils.getSecsFromHHMMSS(s[0].textContent),t.codes[r]=rg2.utils.extractTextContentZero(e[r].getElementsByTagName("ControlCode"),"")):(t.splits+=0,t.codes[r]="");t.splits+=";"}},rg2.ResultParserIOFV2=e}(),function(){function e(e){return this.results=[],this.valid=!0,this.processIOFV3Results(e),{results:this.results,valid:this.valid}}e.prototype={Constructor:e,getID:function(e,t){return 0<e.length?((e=e[0].textContent).replace(/[\n\r]/g,""),e.trim()):t},getClub:function(e){return 0<e.length&&e[0].getElementsByTagName("Name")[0]?e[0].getElementsByTagName("Name")[0].textContent:""},processIOFV3Results:function(e){var t,s,r,n,o,i,a,l;try{for(t=e.getElementsByTagName("ClassResult"),n=0;n<t.length;n+=1)for(a=(l=t[n].getElementsByTagName("Class"))[0].getElementsByTagName("Name")[0].textContent,s=t[n].getElementsByTagName("PersonResult"),o=0;o<s.length;o+=1)(i={}).course=a,l=s[o].getElementsByTagName("Given")[0].textContent+" "+s[o].getElementsByTagName("Family")[0].textContent,i.name=l.replace(/[\n\r]/g,"").trim(),i.dbid=this.getID(s[o].getElementsByTagName("Id"),o),i.club=this.getClub(s[o].getElementsByTagName("Organisation")),r=s[o].getElementsByTagName("Result"),this.extractIOFV3Results(r,i),"DidNotStart"!==i.status&&this.results.push(i)}catch(e){this.valid=!1,rg2.utils.showWarningDialog("XML parse error","Error processing XML file. Error is : "+e.message)}},getStartFinishTimeAsSeconds:function(e){return 19<=e.length?rg2.utils.getSecsFromHHMMSS(e.substr(11,8)):0},getTotalTimeAsSeconds:function(e){return 0<e.length&&e[0].textContent?(e=parseInt(e[0].textContent,10),rg2.utils.formatSecsAsMMSS(e)):"00:00"},extractIOFV3Results:function(e,t){for(var s,r=0;r<e.length;r+=1)t.chipid=rg2.utils.extractTextContentZero(e[r].getElementsByTagName("ControlCard"),0),t.position=rg2.utils.extractTextContentZero(e[r].getElementsByTagName("Position"),""),"0"===t.position&&(t.position=""),t.status=rg2.utils.extractTextContentZero(e[r].getElementsByTagName("Status"),""),t.time=this.getTotalTimeAsSeconds(e[r].getElementsByTagName("Time")),t.starttime=this.getStartFinishTimeAsSeconds(rg2.utils.extractTextContentZero(e[r].getElementsByTagName("StartTime"),0)),t.splits="",t.codes=[],s=e[r].getElementsByTagName("SplitTime"),this.extractIOFV3Splits(s,t),s=this.getStartFinishTimeAsSeconds(rg2.utils.extractTextContentZero(e[r].getElementsByTagName("FinishTime"),0)),t.splits+=0<s?s-t.starttime:0},extractIOFV3Splits:function(e,t){for(var s=[],r=0;r<e.length;r+=1)0===e[r].attributes.length?(t.splits+=rg2.utils.extractTextContentZero(e[r].getElementsByTagName("Time"),0),s.push(rg2.utils.extractTextContentZero(e[r].getElementsByTagName("ControlCode"),"X"+r)),t.splits+=";"):"Missing"===e[r].getAttribute("status")&&(t.splits+="0",s.push(rg2.utils.extractTextContentZero(e[r].getElementsByTagName("ControlCode"),"X"+r)),t.splits+=";");t.codes=s,t.controls=t.codes.length}},rg2.ResultParserIOFV3=e}(),function(){function e(e){return this.results=[],this.CSVFormat={},this.separator="",this.valid=!0,this.processResultsCSV(e),{results:this.results,valid:this.valid}}e.prototype={Constructor:e,processResultsCSV:function(e){var e=e.split(/[\r\n|\n]+/),t=e[0].split(",").length-1,s=e[0].split(";").length-1;this.separator=s<t?",":";",2===e[0].split(this.separator).length?this.processSpklasseCSVResults(e):(this.getCSVFormat(e[0]),this.processCSVResults(e))},processCSVResults:function(e){for(var t,s=1;s<e.length;s+=1)(t=e[s].split(this.separator)).length>=this.CSVFormat.FIRST_SPLIT_IDX&&(t=this.extractSingleCSVResult(t)).valid&&(delete t.valid,this.results.push(t))},getPosition:function(e){e=parseInt(e[this.CSVFormat.POSITION_IDX],10);return e=isNaN(e)?"":e},extractSingleCSVResult:function(e){var t={valid:!0};return t.chipid=e[this.CSVFormat.CHIP_IDX],t.name=(e[this.CSVFormat.FIRST_NAME_IDX]+" "+e[this.CSVFormat.SURNAME_IDX]).trim().replace(/"/g,""),t.dbid=e[this.CSVFormat.DB_IDX],t.starttime=rg2.utils.getSecsFromHHMMSS(e[this.CSVFormat.START_TIME_IDX]),t.time=e[this.CSVFormat.TOTAL_TIME_IDX],t.position=this.getPosition(e),t.status=this.getSICSVStatus(e[this.CSVFormat.NC_IDX],e[this.CSVFormat.CLASSIFIER_IDX]),t.club=e[this.CSVFormat.CLUB_IDX].trim().replace(/"/g,""),t.course=e[this.CSVFormat.COURSE_IDX],""===t.course&&(t.valid=!1),t.controls=parseInt(e[this.CSVFormat.NUM_CONTROLS_IDX],10),e=this.extractSISplits(e,t.controls),t.splits=e.splits,""!==t.splits&&(t.splits+=";"),t.splits+=rg2.utils.getSecsFromHHMMSS(t.time),t.codes=e.codes,t},extractSISplits:function(e,t){for(var s=this.CSVFormat.FIRST_SPLIT_IDX,r=this.CSVFormat.FIRST_CODE_IDX,n={splits:"",codes:[]},o=0;o<t;o+=1)e[r]&&(0<o&&(n.splits+=";"),n.codes[o]=e[r],n.splits+=rg2.utils.getSecsFromHHMMSS(e[s])),s+=this.CSVFormat.STEP,r+=this.CSVFormat.STEP;return{splits:n.splits,codes:n.codes}},getCSVFormat:function(e){for(var t,s,r=["si card","database id","surname","first name","nc","start","time","classifier","city","short","course","course controls","pl","start punch","control1","punch1","control2"],n=[],o=e.split(this.separator).map(function(e){return e.toLowerCase()}),i=0;i<r.length;i+=1){for(s=!1,t=0;t<o.length;t+=1){if(o[t]===r[i]){n[i]=t,s=!0;break}if("si card"===r[i]&&("chipno"===o[t]||"sicard"===o[t]||"database id"===o[t])){n[i]=t,s=!0;break}if("nc"===r[i]&&"classifier"===o[t]){n[i]=t,s=!0;break}if("city"===r[i]&&"club"===o[t]){n[i]=t,s=!0;break}if("pl"===r[i]&&"place"===o[t]){n[i]=t,s=!0;break}}if(!s)break}this.setCSVFormat(n=s?n:[1,2,3,4,8,9,11,12,15,18,39,42,43,44,46,47,48])},setCSVFormat:function(e){this.CSVFormat.CHIP_IDX=e[0],this.CSVFormat.DB_IDX=e[1],this.CSVFormat.SURNAME_IDX=e[2],this.CSVFormat.FIRST_NAME_IDX=e[3],this.CSVFormat.NC_IDX=e[4],this.CSVFormat.START_TIME_IDX=e[5],this.CSVFormat.TOTAL_TIME_IDX=e[6],this.CSVFormat.CLASSIFIER_IDX=e[7],this.CSVFormat.CLUB_IDX=e[8],this.CSVFormat.CLASS_IDX=e[9],this.CSVFormat.COURSE_IDX=e[10],this.CSVFormat.NUM_CONTROLS_IDX=e[11],this.CSVFormat.POSITION_IDX=e[12],this.CSVFormat.START_PUNCH_IDX=e[13],this.CSVFormat.FIRST_CODE_IDX=e[14],this.CSVFormat.FIRST_SPLIT_IDX=e[15],this.CSVFormat.STEP=e[16]-e[14]},getSICSVStatus:function(e,t){return"0"===e||""===e||"N"===e||"n"===e?""===t||"0"===t?"ok":"nok":"nc"},processSpklasseCSVResults:function(e){for(var t,s="",r=0,n=0;n<e.length;n+=1)2===(t=e[n].split(this.separator)).length?(s=t[0],r=parseInt(t[1],10)):this.extractResult(t,s,r)},extractResult:function(e,t,s){var r={chipid:0};r.name=(e[0]+" "+e[1]+" "+e[2]).trim(),r.dbid=r.chipid+"__"+r.name,r.starttime=rg2.utils.getSecsFromHHMM(e[3]),r.club=e[2],r.course=t,r.controls=s,t=this.extractSpklasseSplits(e),r.splits=t.splits,r.codes=t.codes,r.time=rg2.utils.formatSecsAsMMSS(t.totaltime),this.results.push(r)},extractSpklasseSplits:function(e){for(var t="",s=[],r=e.length-4,n=0,o=0;o<r;o+=1)0<o&&(t+=";"),s[o]="X",t+=n+=rg2.utils.getSecsFromHHMMSS(e[o+4]);return{splits:t,codes:s,totaltime:n}}},rg2.ResultParserCSV=e}(),function(){function e(e,t){return this.results=[],this.resultCourses=[],this.valid=!0,e=this.processResults(e,t),this.results=e.results,this.valid=e.valid,this.getCoursesFromResults(),{results:this.results,resultCourses:this.resultCourses,valid:this.valid}}e.prototype={Constructor:e,processResults:function(e,t){switch(t){case"CSV":return new rg2.ResultParserCSV(e.target.result);case"XML":return this.processResultsXML(e.target.result);default:return rg2.utils.showWarningDialog("File type error","Results file type is not recognised. Please select a valid file."),{results:[],valid:!1}}},getCoursesFromResults:function(){for(var e,t,s=0;s<this.results.length;s+=1){for(t=!1,e=0;e<this.resultCourses.length;e+=1)if(this.resultCourses[e].course===this.results[s].course){t=!0;break}t||this.resultCourses.push({course:this.results[s].course,courseid:rg2.config.DO_NOT_SAVE_COURSE})}},processResultsXML:function(e){var t,s="";try{if(0===(t=$.parseXML(e)).getElementsByTagName("ResultList").length)return rg2.utils.showWarningDialog("XML file error","File is not a valid XML results file. ResultList element missing."),{results:[],valid:!1};""===(s=rg2.utils.extractAttributeZero(t.getElementsByTagName("IOFVersion"),"version",""))&&(s=rg2.utils.extractAttributeZero(t.getElementsByTagName("ResultList"),"iofVersion",""))}catch(e){return rg2.utils.showWarningDialog("XML file error","File is not a valid XML results file."),{results:[],valid:!1}}switch(s){case"2.0.3":return new rg2.ResultParserIOFV2(t);case"3.0":return new rg2.ResultParserIOFV3(t);default:return rg2.utils.showWarningDialog("XML file error","Invalid IOF file format. Version "+s+" not supported."),{results:[],valid:!1}}}},rg2.ResultParser=e}(),rg2.managerUI={showItems:function(e,t){for(var s=0;s<e.length;s+=1)t?$(e[s]).show():$(e[s]).hide()},initialiseUI:function(){this.showItems(["#rg2-animation-controls","#rg2-create-tab","#rg2-edit-tab","#rg2-map-tab","#rg2-delete-map-tab","#rg2-draw-tab","#rg2-results-tab","#rg2-courses-tab","#rg2-events-tab"],!1),$("#rg2-manage-login").show(),$("#rg2-info-panel").tabs("disable",rg2.config.TAB_EVENTS).tabs("option","active",rg2.config.TAB_LOGIN)},setUIVisibility:function(){var e=["#rg2-draw-courses","#rg2-manage-login","#rg2-login-tab","#rg2-enrich-course-names"];this.showItems(e,!1),this.showItems(["#rg2-manage-create","#rg2-create-tab","#rg2-edit-tab","#rg2-map-tab","#rg2-delete-map-tab"],!0),$("#rg2-event-date-edit").datepicker({dateFormat:"yy-mm-dd"}),$("#rg2-event-comments").focus(function(){$("#rg2-event-comments").val()===rg2.config.DEFAULT_EVENT_COMMENT&&$("#rg2-event-comments").val("")})},displayCourseInfo:function(e){this.displayInfoDialog(e,"Course")},displayResultInfo:function(e){this.displayInfoDialog(e,"Result")},displayInfoDialog:function(e,t){e&&($("#rg2-manage-"+t.toLowerCase()+"s").empty().html(e),$("#rg2-manage-"+t.toLowerCase()+"s").dialog({title:t+" details",dialogClass:"rg2-"+t.toLowerCase()+"-info-dialog",resizable:!0,width:"auto",maxHeight:.9*window.innerHeight,buttons:{Ok:function(){$(this).dialog("close")}}}))},createMapDropdown:function(e){var t,s;for($("#rg2-map-selected").empty(),(t=document.getElementById("rg2-map-selected")).options.add(rg2.utils.generateOption(rg2.config.INVALID_MAP_ID,"Select map")),s=e.length-1;-1<s;--s)t.options.add(rg2.utils.generateOption(s,e[s].mapid+": "+rg2.he.decode(e[s].name)))},createGeorefDropdown:function(e){$("#rg2-georef-selected").empty();var t=document.getElementById("rg2-georef-selected");e.getDropdown(t)},createEventEditDropdown:function(){$("#rg2-event-selected").empty();var e=document.getElementById("rg2-event-selected");rg2.events.getEventEditDropdown(e)},createRouteDeleteDropdown:function(e){var t,s,r;for($("#rg2-route-selected").empty(),t=document.getElementById("rg2-route-selected"),s=rg2.results.getRoutesForEvent(e),r=0;r<s.length;r+=1)t.options.add(rg2.utils.generateOption(s[r].resultid,s[r].resultid+": "+rg2.he.decode(s[r].name)+" on "+rg2.he.decode(s[r].coursename)))},createEventLevelDropdown:function(e){var t,s,r,n;for($("#"+e).empty(),t=document.getElementById(e),s=["Select level","Training","Local","Regional","National","International"],r=["X","T","L","R","N","I"],n=0;n<s.length;n+=1)t.options.add(rg2.utils.generateOption(r[n],s[n]))},setEvent:function(e){e?(e=rg2.events.getEventInfo(e),rg2.loadEvent(e.id)):(rg2.utils.setButtonState("disable",["#btn-delete-event","#btn-update-event","#btn-delete-route"]),$("#rg2-event-name-edit").val(""),$("#rg2-club-name-edit").val(""),$("#rg2-event-date-edit").val(""),$("#rg2-event-level-edit").val(""),$("#rg2-edit-event-comments").val(""),$("#rg2-edit-exclude").val("e.g. 1|1|6,60|15,60"),$("#rg2-route-selected").empty(),$("#chk-edit-read-only").prop("checked",!1))},eventFinishedLoading:function(e){$("#rg2-event-name-edit").empty().val(rg2.he.decode(e.name)),$("#rg2-club-name-edit").empty().val(rg2.he.decode(e.club)),$("#rg2-event-date-edit").empty().val(e.date),$("#rg2-event-level-edit").val(e.rawtype),$("#rg2-edit-event-comments").empty().val(rg2.he.decode(e.comment)),rg2.events.isScoreEvent()?$("#rg2-exclude-info").hide():($("#rg2-edit-exclude").val(e.exclude),$("#rg2-exclude-info").show()),$("#chk-edit-read-only").prop("checked",e.locked),rg2.utils.setButtonState("enable",["#btn-delete-event","#btn-update-event","#btn-delete-route"]),this.createRouteDeleteDropdown(e.id)},doCancelDeleteEvent:function(){$("#event-delete-dialog").dialog("destroy")},doCancelDeleteRoute:function(){$("#route-delete-dialog").dialog("destroy")},doCancelUpdateEvent:function(){$("#event-update-dialog").dialog("destroy")},doCancelCreateEvent:function(){$("#event-create-dialog").dialog("destroy")},doCancelAddMap:function(){$("#add-map-dialog").dialog("destroy")},doCancelDeleteUnusedMaps:function(){$("#unused-maps-delete-dialog").dialog("destroy")},displayUnusedMaps:function(t){let s="";if(0===t.length)s="<div></div><div>None found.</div><div></div>",$("#btn-delete-unused-maps").button("disable");else{for(let e=0;e<t.length;e+=1)s=(s=(s+="<div>"+t[e].mapid+"</div>")+"<div>"+t[e].name+"</div>")+"<div><input class='unused-map' type='checkbox' value="+t[e].mapid+"></div>";$("#btn-delete-unused-maps").button("enable")}$("#rg2-unused-maps").empty().append("<div class='title'>ID</div><div class='title'>Name</div><div><i class='deleteroute fa fa-trash'></i></div>"+s)}};
//# sourceMappingURL=rg2manager-1.10.3.min.js.map