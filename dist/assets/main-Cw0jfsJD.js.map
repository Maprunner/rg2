{"version":3,"mappings":"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","names":["rg2Axios","axios","getApi","params","onResponse","errorMsg","response","error","reportJSONFail","postApi","data","config","showWarningDialog","dictionary","keys","createLanguageDropdown","languages","dropdown","selected","generateOption","i","e","newlang","setNewLanguage","doGetNewLanguage","lang","handleLanguageResponse","getEnglishKey","str","idx","initLanguageOptions","translateAllText","t","element","key","elements","el","extractAttributeZero","nodelist","attribute","defaultValue","formatSecsAsMMSS","secs","minutes","formattedtime","seconds","formatSecsAsHHMMSS","hours","value","text","opt","generateSelectOption","getAngle","x1","y1","x2","y2","angle","getDistanceBetweenPoints","getLatLonDistance","lat1","lon1","lat2","lon2","dLat","dLon","getSecsFromHHMM","time","bits","getSecsFromHHMMSS","title","showToast","toast","newToast","toastEl","bootstrap.Toast","extractTextContentZero","modalDialog","createModalDialog","dlg","showCancelButton","modalContainer","cancelButton","modalContent","doIt","dialog","options","bootstrap.Modal","validateValue","selector","isValid","elem","valid","colours","colourIndex","getNextTrackColour","getOverprintDetails","size","getMapSize","scaleFact","circleSize","loadConfigOptions","storedOptions","prop","removeDrawnRouteDetails","route","routes","saveConfigOptions","saveDrawnRouteDetails","setConfigOption","option","Controls","code","x","y","newCode","drawDot","ctx","metrics","xoffset","yoffset","scale","startx","starty","DEGREES_120","courses","getCourses","codes","j","Handle","index","Handles","a","b","count","from","to","pt","handle","dx","dy","points","RouteData","GPSTrack","offset","worldFile","getWorldFile","split","adjustTrack","redraw","trk","oldtime","oldx","oldy","nexttime","difftime","xpersec","ypersec","latLon","controlXY","scaleX","scaleY","deltaX","deltaY","getControlXY","speedAverage","speedAtControl","range","speedExtract","bestGuess","timestring","speed","mapIsGeoreferenced","trksegs","trkpts","lat","lon","position","file","reader","err","minX","maxX","minY","maxY","mapSize","id","extractItems","items","introText","generateHash","hashID","hashRoutes","hashCourses","hash","getHashCourses","getHashID","getHashRoutes","getHashTab","getIDFromLocationHash","locationHash","hashid","parseLocationHash","fields","setLocationHash","setEventHash","newid","setHashCourses","displayedCourses","setHashRoutes","displayedRoutes","Result","isScoreEvent","scorecodes","scorex","scorey","decode","getCourseDetails","startindex","endindex","cumulativeDistance","oldt","deltat","olddist","deltadist","trackOK","incrementTracksCount","rawSplits","course","nextcontrol","nextx","nexty","dist","previouscontrolindex","controls","filter","drawLinesBetweenControls","stopCount","nextControlIndex","nextSplit","startIndex","endIndex","fromSplit","toSplit","f","totaltime","currenttime","lastx","lasty","totaldist","moved","colour","red","green","name","initials","addNext","thisControl","info","getTimeAndSplitsForID","maxMetresPerSecond","minMetresPerSecond","secondsPerSample","sorted","metresPerPixel","getMetresPerPixel","maxspeed","minspeed","oldDelta","delta","display","results","addResults","variant","isValidCourseId","result","setDisplayOrder","setDeletionInfo","setScoreCourseInfo","handleExclusions","sanitiseSplits","addTracks","tracks","resultIndex","allResultsForCourseReplayed","courseid","resultIsBeingAnimated","allTracksDisplayed","allTracksForCourseDisplayed","allTracksForCourseReplayed","anyTracksForCourseDisplayed","countResultsByCourseID","getEventInfoForKartatID","createNameDropdown","setName","createResultMenu","html","formatResultListAsAccordion","setResultsSearch","setDisplayedRunnerCounts","setResultCheckboxes","rows","row","displayStatsDialog","deleteResultsForEvent","displayScoreCourse","drawTracks","getFilterDetails","headers","tables","oldCourseID","tracksForThisCourse","prepareResults","res","getBottomRows","getCourseHeader","getNameHTML","showTrack","showReplay","formatTotalRunningTime","generateScoreCourses","updateScoreCourse","getAllResultsForCourse","list","getAllResultsForVariant","getAllRunnersForCourse","runners","getAllRunnersWithTrackForCourse","getCommentsForEvent","hasComments","getCourseForResult","check","getDeletionInfo","getDisplayedTrackDetails","getCourseName","getFullResultforResultID","resultid","getFullResultForRawID","rawid","routeresult","namehtml","getRawDisplayOrder","getResultsInfo","getResultsStats","eventinfo","resultsinfo","coursearray","getCoursesForEvent","wf","digits","lng","card","body","stats","getActiveMapID","getRoutesForEvent","getTracksOnDisplay","getVariantList","variants","currentCourseID","adjustedCourseIDs","excluded","pos","prevTime","sortByCourseIDThenResultID","oldID","canCombine","resetSpeedColours","resultIDExists","previousValidSplit","nextSplitInvalid","expectedSplits","getNumberOfControlsOnCourse","saveResults","getnumberOfCourses","setResultsCount","saveRoutes","eventid","getKartatEventID","deletionInfo","r","displayedRows","setResultColour","trackColour","searchBox","resultTable","setScoreCourseDisplay","baseresult","setTrackDisplayByCourse","updateTrackNames","setTrackDisplayByResult","Runner","lastPointIndex","control","ind","itemsx","itemsy","itemstime","timeatprevitem","timeatitem","fromx","fromy","fromdist","item","tox","toy","diffx","diffy","diffdist","difft","tabs","content","nameButtons","courseButtons","isScoreOrRelay","speedUnits","lengthUnits","byLegPos","byRacePos","splitsChart","legChart","activeLeg","maxIterationIndex","iterationIndex","startTab","activeTab","Chart","adjustSplits","newExclude","calculateLostTimeForIteration","iter","loss","k","calculatePerformanceForIteration","times","refTimes","averages","getAverages","ratios","nonZeroRatios","ratio","sum","weight","calculateSplitsforIteration","splits","changeControlNumberDown","drawLegChart","changeControlNumberUp","changeCourse","direction","newresults","prepareStats","changeName","displayControlDetails","stacks","leg","losses","stack","displayStats","handleTabActivation","nameBack","nameForward","courseBack","courseForward","getBackgroundColor","context","getBackgroundLossColor","getBackgroundGainColor","getBackgroundPredictedColor","predicted","actual","actuals","gains","labels","refTime","worst","scaleBase","timeMax","label","legChartElement","generateLegChart","generateLegPositions","sortLegTimes","prevPos","getMinsPerKm","metres","mins","generateSpeedTable","rowData","runner","gridOptions","timeComparator","table","generateSplitsChart","skipped","val","array","getLegPosInfo","legPos","pred","averageLegPos","best","gain","lossGainMax","splitsChartElem","event","generateSplitsTable","columnDefs","renderSplits","setResultIndex","getStandardDeviation","height","wrapper","generateSummary","packRow","isNumberOverZero","titles","generateTableByLegPos","names","behind","perfComparator","generateTableByRacePos","rawData","perCent","total","adjustedCount","median","average","getMean","getPerfValue","p","values","mean","sq","getStatsHeader","tab","active","getStatsLayout","statsTitleRow","getTimeValue","target","_a","importUtils","createGrid","ModuleRegistry","__vitePreload","n","ClientSideRowModelModule","initialise","initialiseCourse","Course","rg2Exception","legTimes","raceTimes","iterateLostTime","p1","p2","bootstrap.Offcanvas","splitinfo","classes","msg","showStats","eventHasResults","t1","t2","infoPanelControl","rightInfoPanelEl","rightInfoPanelTitle","rightInfoPanel","leftInfoPanelEl","leftInfoPanelTitle","leftInfoPanelBody","leftInfoPanel","resizePanels","MAX_OFFSET","MIN_OFFSET","animationPanelDisplayed","configureDrawDialog","setNameAndTime","comments","waitThreeSeconds","undo","undoLastPoint","save","saveRoute","reset","resetDrawing","input","adjustOffset","adjust","undoGPSAdjust","autofit","autofitGPSTrack","saveGPS","saveGPSRoute","readGPS","configureSettingsDialog","configureSettingsCheckbox","configureSettingsSlider","slider","gpsSpeedChanged","getMinSpeedLabel","getMaxSpeedLabel","units","configureUI","resizeCanvas","getScrollPosAttrName","initialiseInfoPanelDialog","displayInfoPanelDialog","tabActivated","initialiseButtons","createEventMenu","eventList","formatEvents","eventTable","kartatid","loadEventByKartatID","displayAboutDialog","eventStats","getEventStats","displaySettingsDialog","getActiveTab","getInfoPanelBodyHTML","getInfoPanelHeaderHTML","hidden","disabled","minSpeedLabel","maxSpeedLabel","normalTabs","managerTabs","resetDrawDialog","createCourseDropdown","headerHeight","footerHeight","show","setCourseDisplay","showCourse","showAllCourses","allCoursesDisplayed","setFilter","getCoursesOnDisplay","setAllCoursesDisplay","setAllFilters","track","deleteRoute","confirmDeleteRoute","allCourseTracks","allTracks","addRunner","removeRunner","allCourseTracksReplay","allCourseReplay","courseresults","animateRunners","replay","showCourseInProgress","scrollPos","alignmentTimerInterval","alignmentLoopCount","alignmentTimer","alignments","mapIsAligned","routeToDelete","pendingCourseID","controlx","controly","angles","nextControl","previousValidControlIndex","isScoreCourse","addNewPoint","closeEnough","addRouteDataPoint","alignMapToAngle","getNextValidControl","resetMapState","adjustBetweenTwoLockedPoints","previousHandle","nextHandle","scaleRotateAroundSingleLockedPoint","button","earliest","latest","dragTrack","getCentreBottom","getCentreTop","mapDistance","screenDistance","controlAngle","incrementAlignmentTime","alignMap","confirmCourseChange","doChangeCourse","doCancelChangeCourse","doDeleteRoute","doDrawingReset","handleRouteDeleted","initialiseDrawing","doSaveRoute","setDeltas","handleRouteSaved","dragEnded","drawCircle","radius","drawNewTrack","drawRoute","getPreviousValidControl","gpsFileLoaded","doGetEvents","routeSaved","mouseUp","rotatePoint","p3","fromTime","toTime","setDrawingCourse","startDrawing","nameEntry","timeEntry","courseLength","Worldfile","RG2Event","events","activeEventID","eventRequestInProgress","configureUIForNewEvent","btnSplitsbrowser","doGetEvent","setActiveEventIDByKartatID","handleEventResponse","handleEventsResponse","eventIsLocked","comment","georef","lock","getActiveEventDate","getActiveEventID","getActiveKartatID","getActiveEventName","getEventIDForKartatID","realid","getExcludedText","getLengthUnits","getMapFileName","pixels","w","setEventTitleBar","saveCourses","createCourseMenu","isValidKartatID","resetAnimation","deleteAllCourses","loadNewMap","mapIDIsInUse","mapID","intensity","c1x","c1y","c2x","c2y","c3x","c3y","ex","firstExcluded","length","legLength","totaltracks","numberOfCourses","highestControlNumber","addCourse","formatCourses","filterTable","formatCourseFilters","filterChanged","drawCourses","formatCourseDetails","details","getCourseDetailsByName","coursename","displayed","accum","exclude","initialiseCourses","div","timeDeltas","timerInterval","timeDelta","timer","animationSecs","milliSecs","realTime","earliestStartSecs","latestFinishSecs","tailLength","tailStartTimeSecs","massStartControl","massStartByControl","displayNames","displayInitials","startSecs","slowestTimeSecs","animationPanel","clockSlider","playIcon","startIcon","pauseIcon","waitIcon","trackNames","trackNamesBody","btnRunners","btnStartStop","replayByControl","namesPosition","interact","update","updateAnimationDetails","doAnimate","calculateAnimationRange","checkForStopControl","currentTime","allAtControl","setByControlLabel","setNextControlDetails","clockSliderMoved","setAnimationTime","createSpeedDropdown","setReplaySpeed","createByControlDropdown","handleReplayStartDropdown","minLength","createTailsDropdown","tails","setTailsLength","drawAnimation","clock","timeOffset","tailEnd","tailStart","drawName","showDistanceRun","getDistanceAtTime","cumDist","getTrackNames","extraTracks","getTrackNamesHTML","oldCourse","incrementAnimationTime","initialiseAnimationPanel","initialiseClockSlider","toggleAnimation","setReplayMassStart","btnRealTime","setReplayRealTime","setReplayByControl","toggleNameDisplay","min","max","clockSliderContainer","resetNextStopTime","minSplitsLength","stopAnimation","setRunnerColor","startAnimation","color","Overlay","deleteOverlay","ol","deleteAllOverlays","endOverlay","finished","completed","completedDiv","startedDiv","canvas","map","overlay","redrawTimerID","addListeners","handleTouchStart","handleTouchMove","handleTouchEnd","handleScroll","handleMouseDown","handleMouseMove","handleMouseUp","mapLoadedCallback","btn","zoom","rotateMap","moveMap","applyMapRotation","drawDefaultText","controlsHeight","handleInputDown","handleInputMove","handleInputUp","saveMouseEvent","savePinchInfo","oldDistance","newDistance","initialiseCanvas","trackTransforms","mapFile","isBeingCreated","doRedraw","mapscale","heightscale","oldctx","svg","xform","savedTransforms","restore","sx","sy","translate","setTransform","c","d","rotate","radians","zoomDirection","factor","tempZoom","filename","rg2init","startup","module","finishInit","handleNavigation","requestedKartatID","Georefs","MapData","User","nameSelector","passwordSelector","regex","nameValid","passwordValid","chars","rand"],"ignoreList":[],"sources":["../../src/js/api.js","../../src/js/translate.js","../../src/js/utils.js","../../src/js/config.js","../../src/js/controls.js","../../src/js/handles.js","../../src/js/gpstrack.js","../../src/js/hash.js","../../src/js/result.js","../../src/js/results.js","../../src/js/runner.js","../../src/js/statsconstants.js","../../src/js/stats.js","../../src/js/rg2ui.js","../../src/js/draw.js","../../src/js/worldfile.js","../../src/js/event.js","../../src/js/events.js","../../src/js/course.js","../../src/js/courses.js","../../src/js/animation.js","../../src/js/overlay.js","../../src/js/canvas.js","../../src/js/main.js","../../src/js/georefs.js","../../src/js/mapdata.js","../../src/js/user.js"],"sourcesContent":["import axios from \"axios\"\r\nimport { showWarningDialog } from \"./utils\"\r\n\r\nconst rg2Axios = axios.create({\r\n  baseURL: rg2Config.api_url\r\n})\r\n\r\nexport function getApi(params, onResponse, errorMsg) {\r\n  params.t = new Date().getTime()\r\n  document.getElementById(\"rg2-container\").style.cursor = \"wait\"\r\n  rg2Axios({\r\n    method: \"get\",\r\n    url: \"\",\r\n    params: params\r\n  })\r\n    .then((response) => {\r\n      // handlers that need kartatid (unhelpfully called id in the API) send it as a parameter: otherwise it will go as undefined which is OK\r\n      onResponse(response.data.data, params.id)\r\n    })\r\n    .catch(function (error) {\r\n      reportJSONFail(errorMsg + \": \" + error)\r\n    })\r\n    .finally(function () {\r\n      document.getElementById(\"rg2-container\").style.cursor = \"auto\"\r\n    })\r\n}\r\n\r\nexport function postApi(data, params, onResponse, errorMsg) {\r\n  let config = { method: \"post\" }\r\n  config.data = data\r\n  if (params.headers) {\r\n    config.headers = params.headers\r\n    delete params.headers\r\n  }\r\n  params.t = new Date().getTime()\r\n  config.params = params\r\n  document.getElementById(\"rg2-container\").style.cursor = \"wait\"\r\n  rg2Axios(config)\r\n    .then((response) => {\r\n      onResponse(response.data)\r\n    })\r\n    .catch(function (error) {\r\n      reportJSONFail(errorMsg + \": \" + error)\r\n    })\r\n    .finally(function () {\r\n      document.getElementById(\"rg2-container\").style.cursor = \"auto\"\r\n    })\r\n}\r\n\r\nfunction reportJSONFail(error) {\r\n  document.getElementById(\"rg2-load-progress\").classList.add(\"d-none\")\r\n  document.getElementById(\"rg2-map-load-progress\").classList.add(\"d-none\")\r\n  showWarningDialog(\"Configuration error\", error)\r\n}\r\n","import { getApi } from \"./api\"\r\nimport { generateOption } from \"./utils\"\r\n\r\n// use English until we load something else\r\nlet dictionary = {}\r\ndictionary.code = \"en\"\r\nlet keys = []\r\n\r\nexport function createLanguageDropdown(languages) {\r\n  let dropdown = document.getElementById(\"rg2-select-language\")\r\n  dropdown.innerHTML = \"\"\r\n  let selected = dictionary.code === \"en\"\r\n  dropdown.options.add(generateOption(\"en\", \"en: English\", selected))\r\n  for (let i = 0; i < languages.length; i = i + 1) {\r\n    selected = dictionary.code === languages[i].code\r\n    dropdown.options.add(generateOption(languages[i].code, languages[i].code + \": \" + languages[i].language, selected))\r\n  }\r\n  dropdown.addEventListener(\"change\", (e) => {\r\n    const newlang = e.target.value\r\n    if (newlang !== dictionary.code) {\r\n      if (newlang === \"en\") {\r\n        setNewLanguage(\"en\")\r\n      } else {\r\n        doGetNewLanguage(newlang)\r\n      }\r\n    }\r\n  })\r\n}\r\n\r\nfunction doGetNewLanguage(lang) {\r\n  const params = { type: \"lang\", lang: lang }\r\n  getApi(params, handleLanguageResponse, \"Language request failed\")\r\n}\r\n\r\nfunction getEnglishKey(str) {\r\n  // builds an array of everything that has been translated\r\n  // and allocates a key for use in data-rg2t attribute\r\n  const idx = keys.indexOf(str)\r\n  if (idx > -1) {\r\n    return idx\r\n  } else {\r\n    keys.push(str)\r\n    return keys.length - 1\r\n  }\r\n}\r\n\r\nfunction handleLanguageResponse(response) {\r\n  setNewLanguage(response.lang)\r\n}\r\n\r\nexport function initLanguageOptions() {\r\n  // set available languages and set start language if requested\r\n  if (rg2Config.start_language !== \"en\") {\r\n    doGetNewLanguage(rg2Config.start_language)\r\n  }\r\n}\r\n\r\nexport function setNewLanguage(lang) {\r\n  if (lang === \"en\") {\r\n    dictionary = { code: \"en\" }\r\n  } else {\r\n    dictionary = lang\r\n  }\r\n  translateAllText()\r\n}\r\n\r\nexport function t(str, element = \"span\") {\r\n  const key = getEnglishKey(str)\r\n  // eslint-disable-next-line no-prototype-builtins\r\n  if (dictionary.hasOwnProperty(str)) {\r\n    str = dictionary[str]\r\n  }\r\n  // passing an empty element returns an unformatted string\r\n  if (element === \"\") {\r\n    return str\r\n  }\r\n  // otherwise add a wrapper with data attribute to allow translation\r\n  return `<${element} data-rg2t='${key}'>${str}</${element}>`\r\n}\r\n\r\nfunction translateAllText() {\r\n  // translates every element that has a data-rg2t attribute\r\n  const elements = document.querySelectorAll(\"[data-rg2t]\")\r\n  for (let el of elements) {\r\n    const key = parseInt(el.dataset.rg2t, 10)\r\n    el.innerText = t(keys[key], \"\")\r\n  }\r\n}\r\n","import * as bootstrap from \"bootstrap\"\r\nimport { t } from \"./translate\"\r\n\r\nexport function extractAttributeZero(nodelist, attribute, defaultValue) {\r\n  if (nodelist.length > 0) {\r\n    return nodelist[0].getAttribute(attribute).trim()\r\n  }\r\n  return defaultValue\r\n}\r\n\r\n// converts seconds to MM:SS\r\nexport function formatSecsAsMMSS(secs) {\r\n  const minutes = Math.floor(secs / 60)\r\n  let formattedtime = minutes\r\n  const seconds = secs - minutes * 60\r\n  if (seconds < 10) {\r\n    formattedtime += \":0\" + seconds\r\n  } else {\r\n    formattedtime += \":\" + seconds\r\n  }\r\n  return formattedtime\r\n}\r\n\r\n// returns seconds as hh:mm:ss\r\nexport function formatSecsAsHHMMSS(secs) {\r\n  let formattedtime\r\n  const hours = Math.floor(secs / 3600)\r\n  if (hours < 10) {\r\n    formattedtime = \"0\" + hours + \":\"\r\n  } else {\r\n    formattedtime = hours + \":\"\r\n  }\r\n  secs = secs - hours * 3600\r\n  const minutes = Math.floor(secs / 60)\r\n  if (minutes < 10) {\r\n    formattedtime += \"0\" + minutes\r\n  } else {\r\n    formattedtime += minutes\r\n  }\r\n  secs = secs - minutes * 60\r\n  if (secs < 10) {\r\n    formattedtime += \":0\" + secs\r\n  } else {\r\n    formattedtime += \":\" + secs\r\n  }\r\n  return formattedtime\r\n}\r\n\r\nexport function generateOption(value, text, selected = false) {\r\n  let opt = document.createElement(\"option\")\r\n  opt.value = value\r\n  opt.text = text\r\n  if (selected) {\r\n    opt.selected = true\r\n  }\r\n  return opt\r\n}\r\n\r\nexport function generateSelectOption(value, text, selected = false) {\r\n  // returns an option line for a Bootstrap select dropdown\r\n  // <option value=\"0\" selected>Not georeferenced</option>\r\n  return `<option value=\"${value}\"${selected ? \" selected\" : \"\"}>${text}</option>`\r\n}\r\n\r\nexport function getAngle(x1, y1, x2, y2) {\r\n  let angle = Math.atan2(y2 - y1, x2 - x1)\r\n  if (angle < 0) {\r\n    angle = angle + 2 * Math.PI\r\n  }\r\n  return angle\r\n}\r\n\r\nexport function getDistanceBetweenPoints(x1, y1, x2, y2) {\r\n  // Pythagoras\r\n  return Math.sqrt(Math.pow(x1 - x2, 2) + Math.pow(y1 - y2, 2))\r\n}\r\n\r\nexport function getLatLonDistance(lat1, lon1, lat2, lon2) {\r\n  // Haversine formula (http://www.codecodex.com/wiki/Calculate_distance_between_two_points_on_a_globe)\r\n  const dLat = (lat2 - lat1).toRad()\r\n  const dLon = (lon2 - lon1).toRad()\r\n  const a =\r\n    Math.sin(dLat / 2) * Math.sin(dLat / 2) +\r\n    Math.cos(lat1.toRad()) * Math.cos(lat2.toRad()) * Math.sin(dLon / 2) * Math.sin(dLon / 2)\r\n  // multiply by IUUG earth mean radius (http://en.wikipedia.org/wiki/Earth_radius) in metres\r\n  return 6371009 * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))\r\n}\r\n\r\nexport function getSecsFromHHMM(time) {\r\n  if (!time) {\r\n    return 0\r\n  }\r\n  let secs = 0\r\n  const bits = time.split(\":\")\r\n  secs = parseInt(bits[0], 10) * 3600 + parseInt(bits[1], 10) * 60\r\n  if (isNaN(secs)) {\r\n    return 0\r\n  }\r\n  return secs\r\n}\r\n\r\n// converts MM:SS or HH:MM:SS to seconds based on number of :\r\nexport function getSecsFromHHMMSS(time) {\r\n  if (!time) {\r\n    return 0\r\n  }\r\n  let secs = 0\r\n  // force format to use : if it came in with .\r\n  let bits = time.replace(/\\./g, \":\").split(\":\")\r\n  if (bits.length === 2) {\r\n    secs = parseInt(bits[0], 10) * 60 + parseInt(bits[1], 10)\r\n  } else {\r\n    if (bits.length === 3) {\r\n      secs = parseInt(bits[0], 10) * 3600 + parseInt(bits[1], 10) * 60 + parseInt(bits[2], 10)\r\n    }\r\n  }\r\n  if (isNaN(secs)) {\r\n    return 0\r\n  }\r\n  return secs\r\n}\r\n\r\nexport const showWarningDialog = (title, text) => {\r\n  showToast(title, text)\r\n}\r\n\r\nconst toast = document.getElementById(\"rg2-toast-container\")\r\nexport const showToast = (title, text) => {\r\n  const newToast = document.createElement(\"div\")\r\n  newToast.classList.add(\"toast\")\r\n  newToast.setAttribute(\"data-bs-autohide\", \"false\")\r\n  newToast.innerHTML = `<div class=\"toast-header\">\r\n      <strong class=\"me-auto\">${title}</strong>\r\n      <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"toast\" aria-label=\"Close\"></button>\r\n    </div>\r\n    <div class=\"toast-body\">\r\n      ${text}\r\n    </div>`\r\n  toast.appendChild(newToast)\r\n  const toastElList = document.querySelectorAll(\".toast\")\r\n  // eslint-disable-next-line no-unused-vars\r\n  const toastList = [...toastElList].map((toastEl) => {\r\n    const newToast = new bootstrap.Toast(toastEl, {})\r\n    toastEl.addEventListener(\"hidden.bs.toast\", () => {\r\n      if (toastEl.parentNode) {\r\n        toastEl.parentNode.removeChild(toastEl)\r\n      }\r\n    })\r\n    newToast.show()\r\n  })\r\n}\r\n\r\nexport function extractTextContentZero(nodelist, defaultValue) {\r\n  if (nodelist.length > 0) {\r\n    return nodelist[0].textContent.trim()\r\n  }\r\n  return defaultValue\r\n}\r\n\r\nlet modalDialog = undefined\r\nexport function createModalDialog(dlg, showCancelButton = true) {\r\n  if (modalDialog) {\r\n    modalDialog.dispose()\r\n  }\r\n  const modalContainer = document.getElementById(\"rg2-modal-container\")\r\n  modalContainer.innerHTML = \"\"\r\n  const cancelButton = showCancelButton\r\n    ? `<button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">${t(\"Cancel\")}</button>`\r\n    : \"\"\r\n  const modalContent = `<div class=\"modal fade\" id=\"rg2-modal-dialog\" data-bs-backdrop=\"static\" data-bs-keyboard=\"false\"\r\n    tabindex=\"-1\" aria-labelledby=\"staticBackdropLabel\" aria-hidden=\"true\">\r\n    <div class=\"modal-dialog modal-dialog-centered\">\r\n      <div class=\"modal-content\">\r\n        <div class=\"modal-header\">\r\n          <h1 class=\"modal-title fs-5\" id=\"staticBackdropLabel\">${dlg.title}</h1>\r\n          <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button>\r\n        </div>\r\n        <div class=\"modal-body\">\r\n          ${dlg.body}\r\n        </div>\r\n        <div class=\"modal-footer\">\r\n          <button id=\"rg2-do-modal-action\" type=\"button\" class=\"btn btn-primary\">${t(dlg.doText)}</button>\r\n          ${cancelButton}\r\n        </div>\r\n      </div>\r\n    </div>\r\n    </div > `\r\n  modalContainer.innerHTML = modalContent\r\n  // create null cancel function if we din't get anything\r\n  if (typeof dlg.onCancel !== \"function\") {\r\n    dlg.onCancel = () => {}\r\n  }\r\n  let doIt = false\r\n  const dialog = document.getElementById(\"rg2-modal-dialog\")\r\n  document.getElementById(\"rg2-do-modal-action\").addEventListener(\"click\", () => {\r\n    doIt = true\r\n    modalDialog.hide()\r\n  })\r\n  const options = { keyboard: true }\r\n  modalDialog = new bootstrap.Modal(dialog, options)\r\n  dialog.addEventListener(\"hidden.bs.modal\", () => {\r\n    if (doIt) {\r\n      dlg.onDo()\r\n    } else {\r\n      dlg.onCancel()\r\n    }\r\n  })\r\n  modalDialog.show()\r\n}\r\n\r\nexport function validateValue(selector, isValid) {\r\n  const elem = document.getElementById(selector)\r\n  const valid = isValid(elem.value)\r\n  if (valid) {\r\n    elem.classList.add(\"is-valid\")\r\n    elem.classList.remove(\"is-invalid\")\r\n  } else {\r\n    elem.classList.add(\"is-invalid\")\r\n    elem.classList.remove(\"is-valid\")\r\n  }\r\n  return valid\r\n}\r\n\r\nNumber.prototype.toRad = function () {\r\n  return (this * Math.PI) / 180\r\n}\r\n\r\n// used to generate track colours\r\nconst colours = [\r\n  \"#ff0000\",\r\n  \"#00ff00\",\r\n  \"#0000ff\",\r\n  \"#800000\",\r\n  \"#008000\",\r\n  \"#000080\",\r\n  \"#ffff00\",\r\n  \"#ff00ff\",\r\n  \"#00ffff\",\r\n  \"#808000\",\r\n  \"#800080\",\r\n  \"#008080\"\r\n]\r\nlet colourIndex = 0\r\n\r\nexport function getNextTrackColour() {\r\n  colourIndex = (colourIndex + 1) % colours.length\r\n  return colours[colourIndex]\r\n}\r\n","import { showWarningDialog } from \"./utils\"\r\nimport { getMapSize } from \"./canvas\"\r\n\r\nexport const config = {\r\n  // version gets set automatically by grunt file during build process\r\n  RG2VERSION: import.meta.env.VITE_RG2_VERSION,\r\n  DEFAULT_SCALE_FACTOR: 1.1,\r\n  TAB_EVENTS: \"event-tab\",\r\n  TAB_COURSES: \"course-tab\",\r\n  TAB_RESULTS: \"result-tab\",\r\n  TAB_DRAW: \"draw-tab\",\r\n  TAB_LOGIN: \"manage-login-tab\",\r\n  TAB_CREATE: \"manage-create-tab\",\r\n  TAB_EDIT: \"manage-edit-tab\",\r\n  TAB_MAP: \"manage-map-tab\",\r\n  TAB_DELETE_MAP: \"manage-delete-map-tab\",\r\n  INVALID_MAP_ID: 9999,\r\n  // translated when output so leave as English here\r\n  DEFAULT_NEW_COMMENT: \"Type your comment\",\r\n  // added to resultid when saving a GPS track\r\n  GPS_RESULT_OFFSET: 50000,\r\n  MASS_START_REPLAY: 1,\r\n  REAL_TIME_REPLAY: 2,\r\n  // dropdown selection value\r\n  MASS_START_BY_CONTROL: 99999,\r\n  VERY_HIGH_TIME_IN_SECS: 99999,\r\n  // screen sizes for different layouts\r\n  BIG_SCREEN_BREAK_POINT: 800,\r\n  SMALL_SCREEN_BREAK_POINT: 500,\r\n  MAX_ZOOM: 50,\r\n  MIN_ZOOM: 0.05,\r\n  PURPLE: \"#b300ff\",\r\n  RED: \"#ff0000\",\r\n  GREEN: \"#00ff00\",\r\n  BLUE: \"#0000ff\",\r\n  DARK_GREEN: \"rgb(34, 139, 34)\",\r\n  DARK_GREEN_30: \"rgba(34, 139, 34, 0.3)\",\r\n  GREY: \"#e0e0e0\",\r\n  RED_30: \"rgba(255,0,0,0.3)\",\r\n  GREEN_30: \"rgba(0,255,0,0.3)\",\r\n  BLUE_30: \"rgba(0,0,255,0.3)\",\r\n  PURPLE_30: \"rgba(180,0,255,0.3)\",\r\n  WHITE: \"#ffffff\",\r\n  BLACK: \"#000000\",\r\n  RUNNER_DOT_RADIUS: 6,\r\n  HANDLE_DOT_RADIUS: 7,\r\n  HANDLE_COLOUR: \"#ff0000\",\r\n  // parameters for call to draw courses\r\n  DIM: 0.75,\r\n  FULL_INTENSITY: 1.0,\r\n  TIME_NOT_FOUND: 9999,\r\n  // values for eventt.which\r\n  RIGHT_CLICK: 3,\r\n  DO_NOT_SAVE_COURSE: 9999,\r\n  // values of event format\r\n  FORMAT_NORMAL: 1,\r\n  FORMAT_NORMAL_NO_RESULTS: 2,\r\n  FORMAT_SCORE_EVENT: 3,\r\n  FORMAT_SCORE_EVENT_NO_RESULTS: 4,\r\n  DISPLAY_ALL_COURSES: 99999,\r\n  EXCLUDED_NONE: 0,\r\n  EXCLUDED_ZERO_SPLITS: 1,\r\n  EXCLUDED_REAL_SPLITS: 2,\r\n  //number of drawn routes that can be saved for possible later deletion\r\n  MAX_DRAWN_ROUTES: 10,\r\n  // array of available languages: not great to do it like this but it helps for routegadget.co.uk set-up\r\n  languages: [\r\n    { language: \"Čeština\", code: \"cz\" },\r\n    { language: \"Deutsch\", code: \"de\" },\r\n    { language: \"Suomi\", code: \"fi\" },\r\n    { language: \"Français\", code: \"fr\" },\r\n    { language: \"Italiano\", code: \"it\" },\r\n    { language: \"日本語\", code: \"ja\" },\r\n    { language: \"Norsk\", code: \"no\" },\r\n    { language: \"Português - Brasil\", code: \"pt\" },\r\n    { language: \"Русский\", code: \"ru\" }\r\n  ],\r\n  // Size of map upload in MB that triggers the warning dialog\r\n  FILE_SIZE_WARNING: 2,\r\n  // Size of map upload in pixels that triggers the warning dialog\r\n  // emprically this is easily enough for an A3 sensible map\r\n  PIXEL_SIZE_WARNING: 4000,\r\n  CLASS_NOW_ON: 1,\r\n  CLASS_NOW_OFF: 0,\r\n  managing: () => {\r\n    return rg2Config.managing !== undefined\r\n  }\r\n}\r\n\r\nexport const options = {\r\n  // initialised to default values: overwritten from storage later\r\n  perCentMapIntensity: 100,\r\n  perCentRouteIntensity: 100,\r\n  replayFontSize: 12,\r\n  courseWidth: 3,\r\n  routeWidth: 4,\r\n  circleSize: 20,\r\n  snap: true,\r\n  showThreeSeconds: false,\r\n  showGPSSpeed: false,\r\n  // align map with next control at top when drawing route\r\n  alignMap: false,\r\n  // speeds in min/km\r\n  maxSpeed: 5,\r\n  minSpeed: 15,\r\n  // array of up to MAX_DRAWN_ROUTES entries with details to allow deletion\r\n  drawnRoutes: []\r\n}\r\n\r\nexport function getOverprintDetails() {\r\n  let opt = {}\r\n  // attempt to scale overprint depending on map image size\r\n  // this avoids very small/large circles, or at least makes things a bit more sensible\r\n  const size = getMapSize()\r\n  // Empirically derived  so open to suggestions. This is based on a nominal 20px circle\r\n  // as default. The square root stops things getting too big too quickly.\r\n  // 1500px is a typical map image maximum size.\r\n  let scaleFact = Math.pow(Math.min(size.height, size.width) / 1500, 0.5)\r\n  // don't get too carried away, although these would be strange map files\r\n  scaleFact = Math.min(scaleFact, 5)\r\n  scaleFact = Math.max(scaleFact, 0.5)\r\n  const circleSize = Math.round(options.circleSize * scaleFact)\r\n  // ratios based on IOF ISOM overprint specification\r\n  opt.controlRadius = circleSize\r\n  opt.finishInnerRadius = circleSize * (5 / 6)\r\n  opt.finishOuterRadius = circleSize * (7 / 6)\r\n  opt.startTriangleLength = circleSize * (7 / 6)\r\n  opt.overprintWidth = options.courseWidth\r\n  opt.font = circleSize + \"pt Arial\"\r\n  return opt\r\n}\r\n\r\nexport function loadConfigOptions() {\r\n  try {\r\n    // eslint-disable-next-line no-prototype-builtins\r\n    if (window.hasOwnProperty(\"localStorage\") && window.localStorage !== null) {\r\n      if (localStorage.getItem(\"rg2-options\") !== null) {\r\n        const storedOptions = JSON.parse(localStorage.getItem(\"rg2-options\"))\r\n        // overwrite the options array with saved options from local storage\r\n        // need to do this to allow for new options that people don't yet have\r\n        for (let prop in storedOptions) {\r\n          // eslint-disable-next-line no-prototype-builtins\r\n          if (storedOptions.hasOwnProperty(prop)) {\r\n            options[prop] = storedOptions[prop]\r\n          }\r\n        }\r\n        // best to keep these at default?\r\n        options.circleSize = 20\r\n        if (options.perCentMapIntensity === 0) {\r\n          showWarningDialog(\r\n            \"Warning\",\r\n            \"Your saved settings have 0% map intensity so the map is invisible. You can adjust this on the configuration menu\"\r\n          )\r\n        }\r\n      }\r\n    }\r\n  } catch (e) {\r\n    // storage not supported so just continue\r\n  }\r\n}\r\n\r\nexport function removeDrawnRouteDetails(route) {\r\n  let routes = []\r\n  for (let i = 0; i < options.drawnRoutes.length; i += 1) {\r\n    if (options.drawnRoutes[i].id !== route.id || options.drawnRoutes[i].eventid !== route.eventid) {\r\n      routes.push(options.drawnRoutes[i])\r\n    }\r\n  }\r\n  options.drawnRoutes = routes\r\n  saveConfigOptions()\r\n}\r\n\r\nexport function saveConfigOptions() {\r\n  try {\r\n    // eslint-disable-next-line no-prototype-builtins\r\n    if (window.hasOwnProperty(\"localStorage\") && window.localStorage !== null) {\r\n      localStorage.setItem(\"rg2-options\", JSON.stringify(options))\r\n    }\r\n  } catch (e) {\r\n    // storage not supported so just return\r\n    return\r\n  }\r\n}\r\n\r\nexport function saveDrawnRouteDetails(route) {\r\n  // this allows for deletion later\r\n  let routes = options.drawnRoutes\r\n  if (routes.length >= config.MAX_DRAWN_ROUTES) {\r\n    // array is full so delete oldest (=first) entry\r\n    routes.shift()\r\n  }\r\n  routes.push(route)\r\n  options.drawnRoutes = routes\r\n  saveConfigOptions()\r\n}\r\n\r\nexport function setConfigOption(option, value) {\r\n  options[option] = value\r\n  saveConfigOptions()\r\n}\r\n","import { ctx } from \"./canvas\"\r\nimport { config, getOverprintDetails } from \"./config\"\r\nimport { getCourses } from \"./courses\"\r\n\r\nexport class Controls {\r\n  constructor() {\r\n    this.controls = []\r\n    this.displayControls = false\r\n  }\r\n\r\n  addControl(code, x, y) {\r\n    let newCode = true\r\n    for (let i = 0; i < this.controls.length; i += 1) {\r\n      if (this.controls[i].code === code) {\r\n        newCode = false\r\n        break\r\n      }\r\n    }\r\n    if (newCode) {\r\n      this.controls.push({ code: code, x: x, y: y })\r\n    }\r\n  }\r\n\r\n  deleteAllControls() {\r\n    this.controls.length = 0\r\n  }\r\n\r\n  displayAllControls() {\r\n    this.displayControls = true\r\n  }\r\n\r\n  drawControls(drawDot) {\r\n    if (this.displayControls) {\r\n      const opt = getOverprintDetails()\r\n      for (let i = 0; i < this.controls.length; i += 1) {\r\n        // Assume things starting with 'F' or 'M' are Finish or Mal\r\n        if (this.controls[i].code.indexOf(\"F\") === 0 || this.controls[i].code.indexOf(\"M\") === 0) {\r\n          this.drawFinish(this.controls[i].x, this.controls[i].y, this.controls[i].code, opt)\r\n        } else {\r\n          // Assume things starting with 'S' are a Start\r\n          if (this.controls[i].code.indexOf(\"S\") === 0) {\r\n            this.drawStart(this.controls[i].x, this.controls[i].y, this.controls[i].code, 1.5 * Math.PI, opt)\r\n          } else {\r\n            // Else it's a normal control\r\n            this.drawSingleControl(this.controls[i].x, this.controls[i].y, this.controls[i].code, Math.PI * 0.25, opt)\r\n            if (drawDot) {\r\n              ctx.fillRect(this.controls[i].x - 1, this.controls[i].y - 1, 3, 3)\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  drawFinish(x, y, code, opt) {\r\n    //Draw the white halo around the finish control\r\n    ctx.strokeStyle = \"white\"\r\n    ctx.lineWidth = opt.overprintWidth + 2\r\n    ctx.beginPath()\r\n    ctx.arc(x, y, opt.finishInnerRadius, 0, 2 * Math.PI, false)\r\n    ctx.stroke()\r\n    ctx.beginPath()\r\n    ctx.arc(x, y, opt.finishOuterRadius, 0, 2 * Math.PI, false)\r\n    ctx.stroke()\r\n    //Draw the white halo around the finish code\r\n    ctx.beginPath()\r\n    ctx.font = opt.font\r\n    ctx.textAlign = \"left\"\r\n    ctx.strokeStyle = \"white\"\r\n    ctx.miterLimit = 2\r\n    ctx.lineJoin = \"circle\"\r\n    ctx.lineWidth = 1.5\r\n    ctx.strokeText(code, x + opt.controlRadius * 1.5, y + opt.controlRadius)\r\n    ctx.stroke()\r\n    //Draw the purple finish control\r\n    ctx.beginPath()\r\n    ctx.fillStyle = config.PURPLE\r\n    ctx.strokeStyle = config.PURPLE\r\n    ctx.lineWidth = opt.overprintWidth\r\n    ctx.arc(x, y, opt.finishInnerRadius, 0, 2 * Math.PI, false)\r\n    ctx.stroke()\r\n    ctx.beginPath()\r\n    ctx.arc(x, y, opt.finishOuterRadius, 0, 2 * Math.PI, false)\r\n    ctx.fillText(code, x + opt.controlRadius * 1.5, y + opt.controlRadius)\r\n    ctx.stroke()\r\n  }\r\n\r\n  drawSingleControl(x, y, code, angle, opt) {\r\n    //Draw the white halo around the controls\r\n    ctx.beginPath()\r\n    ctx.strokeStyle = \"white\"\r\n    ctx.lineWidth = opt.overprintWidth + 2\r\n    ctx.arc(x, y, opt.controlRadius, 0, 2 * Math.PI, false)\r\n    ctx.stroke()\r\n    //Draw the white halo around the control code\r\n    ctx.beginPath()\r\n    ctx.textAlign = \"center\"\r\n    ctx.font = opt.font\r\n    ctx.strokeStyle = \"white\"\r\n    ctx.miterLimit = 2\r\n    ctx.lineJoin = \"circle\"\r\n    ctx.lineWidth = 1.5\r\n    ctx.textBaseline = \"middle\"\r\n    const metrics = ctx.measureText(code)\r\n    // offset to left if left of centre, to right if right of centre\r\n    let xoffset\r\n    if (angle < Math.PI) {\r\n      xoffset = metrics.width / 2\r\n    } else {\r\n      xoffset = (-1 * metrics.width) / 2\r\n    }\r\n    // control radius is also the control code text height\r\n    // offset up if above half way, down if below half way\r\n    let yoffset\r\n    if (angle >= Math.PI / 2 && angle <= Math.PI * 1.5) {\r\n      yoffset = (-1 * opt.controlRadius) / 2\r\n    } else {\r\n      yoffset = opt.controlRadius / 2\r\n    }\r\n    // empirically looks OK with this scale\r\n    const scale = 1.3\r\n    ctx.strokeText(\r\n      code,\r\n      x + opt.controlRadius * scale * Math.sin(angle) + xoffset,\r\n      y + opt.controlRadius * scale * Math.cos(angle) + yoffset\r\n    )\r\n    //Draw the purple control\r\n    ctx.beginPath()\r\n    ctx.font = opt.font\r\n    ctx.fillStyle = config.PURPLE\r\n    ctx.strokeStyle = config.PURPLE\r\n    ctx.lineWidth = opt.overprintWidth\r\n    ctx.arc(x, y, opt.controlRadius, 0, 2 * Math.PI, false)\r\n    ctx.fillText(\r\n      code,\r\n      x + opt.controlRadius * scale * Math.sin(angle) + xoffset,\r\n      y + opt.controlRadius * scale * Math.cos(angle) + yoffset\r\n    )\r\n    ctx.stroke()\r\n  }\r\n\r\n  drawStart(startx, starty, code, angle, opt) {\r\n    //Draw the white halo around the start triangle\r\n    let x = []\r\n    let y = []\r\n    const DEGREES_120 = (2 * Math.PI) / 3\r\n    angle = angle + Math.PI / 2\r\n    ctx.lineCap = \"round\"\r\n    ctx.strokeStyle = \"white\"\r\n    ctx.lineWidth = opt.overprintWidth + 2\r\n    ctx.beginPath()\r\n    x[0] = startx + opt.startTriangleLength * Math.sin(angle)\r\n    y[0] = starty - opt.startTriangleLength * Math.cos(angle)\r\n    ctx.moveTo(x[0], y[0])\r\n    x[1] = startx + opt.startTriangleLength * Math.sin(angle + DEGREES_120)\r\n    y[1] = starty - opt.startTriangleLength * Math.cos(angle + DEGREES_120)\r\n    ctx.lineTo(x[1], y[1])\r\n    ctx.stroke()\r\n    ctx.beginPath()\r\n    ctx.moveTo(x[1], y[1])\r\n    x[2] = startx + opt.startTriangleLength * Math.sin(angle - DEGREES_120)\r\n    y[2] = starty - opt.startTriangleLength * Math.cos(angle - DEGREES_120)\r\n    ctx.lineTo(x[2], y[2])\r\n    ctx.stroke()\r\n    ctx.beginPath()\r\n    ctx.moveTo(x[2], y[2])\r\n    ctx.lineTo(x[0], y[0])\r\n    ctx.stroke()\r\n    //Draw the white halo around the start code\r\n    ctx.beginPath()\r\n    ctx.font = opt.font\r\n    ctx.textAlign = \"left\"\r\n    ctx.strokeStyle = \"white\"\r\n    ctx.miterLimit = 2\r\n    ctx.lineJoin = \"circle\"\r\n    ctx.lineWidth = 1.5\r\n    ctx.strokeText(code, x[0] + opt.controlRadius * 1.25, y[0] + opt.controlRadius * 1.25)\r\n    ctx.stroke()\r\n    //Draw the purple start control\r\n    ctx.strokeStyle = config.PURPLE\r\n    ctx.lineWidth = opt.overprintWidth\r\n    ctx.font = opt.font\r\n    ctx.fillStyle = config.PURPLE\r\n    ctx.beginPath()\r\n    ctx.moveTo(x[0], y[0])\r\n    ctx.lineTo(x[1], y[1])\r\n    ctx.stroke()\r\n    ctx.beginPath()\r\n    ctx.moveTo(x[1], y[1])\r\n    ctx.lineTo(x[2], y[2])\r\n    ctx.stroke()\r\n    ctx.beginPath()\r\n    ctx.moveTo(x[2], y[2])\r\n    ctx.lineTo(x[0], y[0])\r\n    ctx.fillText(code, x[0] + opt.controlRadius * 1.25, y[0] + opt.controlRadius * 1.25)\r\n    ctx.stroke()\r\n  }\r\n\r\n  generateControlList() {\r\n    this.controls.length = 0\r\n    const courses = getCourses()\r\n    for (let i = 0; i < courses.length; i += 1) {\r\n      if (courses[i] !== undefined) {\r\n        const codes = courses[i].codes\r\n        const x = courses[i].x\r\n        const y = courses[i].y\r\n        // for all controls on course\r\n        if (codes !== undefined) {\r\n          for (let j = 0; j < codes.length; j += 1) {\r\n            this.addControl(codes[j], x[j], y[j])\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  getControlCount() {\r\n    return this.controls.length\r\n  }\r\n\r\n  toggleControlDisplay() {\r\n    this.displayControls = !this.displayControls\r\n  }\r\n}\r\n","import { getDistanceBetweenPoints } from \"./utils\"\r\nimport { config } from \"./config\"\r\nimport { ctx } from \"./canvas\"\r\nclass Handle {\r\n  constructor(x, y, time, index) {\r\n    // current position of handles\r\n    this.x = x\r\n    this.y = y\r\n    // positions before start of adjustment\r\n    this.basex = x\r\n    this.basey = y\r\n    // saved positions to allow undo\r\n    this.undox = x\r\n    this.undoy = y\r\n    this.locked = false\r\n    // not really a time: instead an index into the GPX data\r\n    // this is \"time\" for 1s intervals, but not if in a different recording mode\r\n    this.time = time\r\n    this.index = index\r\n  }\r\n}\r\nexport class Handles {\r\n  constructor() {\r\n    // array of handles used to adjust GPS tracks\r\n    // maintained in time order which means they are also in order along the GPS track\r\n    this.handles = []\r\n  }\r\n\r\n  addHandle(x, y, time) {\r\n    this.handles.push(new Handle(x, y, time, this.handles.length))\r\n    this.handles.sort(function (a, b) {\r\n      return a.time - b.time\r\n    })\r\n    this.renumberHandles()\r\n  }\r\n\r\n  deleteHandle(index) {\r\n    if (index === 0 || index === this.handles.length - 1) {\r\n      // can't delete start or finish\r\n      return\r\n    }\r\n    this.handles.splice(index, 1)\r\n    this.renumberHandles()\r\n  }\r\n\r\n  renumberHandles() {\r\n    for (let i = 0; i < this.handles.length; i += 1) {\r\n      this.handles[i].index = i\r\n    }\r\n  }\r\n\r\n  lockHandle(index) {\r\n    this.handles[index].locked = true\r\n  }\r\n\r\n  lockHandleByTime(time) {\r\n    for (let i = 0; i < this.handles.length; i += 1) {\r\n      if (this.handles[i].time === time) {\r\n        this.handles[i].locked = true\r\n      }\r\n    }\r\n  }\r\n\r\n  unlockHandle(index) {\r\n    this.handles[index].locked = false\r\n  }\r\n\r\n  handlesLocked() {\r\n    let count = 0\r\n    for (let i = 0; i < this.handles.length; i += 1) {\r\n      if (this.handles[i].locked) {\r\n        count += 1\r\n      }\r\n    }\r\n    return count\r\n  }\r\n\r\n  deleteAllHandles() {\r\n    this.handles.length = 0\r\n  }\r\n\r\n  rebaselineXY() {\r\n    // save new locations at end of drag\r\n    this.copyHandleFields(\"\", \"base\")\r\n  }\r\n\r\n  saveForUndo() {\r\n    this.copyHandleFields(\"base\", \"undo\")\r\n  }\r\n\r\n  undo() {\r\n    // undo last move: reset to saved values\r\n    this.copyHandleFields(\"undo\", \"base\")\r\n    this.copyHandleFields(\"undo\", \"\")\r\n  }\r\n\r\n  copyHandleFields(from, to) {\r\n    for (let i = 0; i < this.handles.length; i += 1) {\r\n      this.handles[i][to + \"x\"] = this.handles[i][from + \"x\"]\r\n      this.handles[i][to + \"y\"] = this.handles[i][from + \"y\"]\r\n    }\r\n  }\r\n\r\n  getStartHandle() {\r\n    // always the first entry\r\n    return this.handles[0]\r\n  }\r\n\r\n  getFinishHandle() {\r\n    // always the last entry\r\n    return this.handles[this.handles.length - 1]\r\n  }\r\n\r\n  getHandleClicked(pt) {\r\n    // find if the click was on an existing handle: return handle object or undefined\r\n    // basex and basey are handle locations at the start of the drag which is what we are interested in\r\n    for (let i = 0; i < this.handles.length; i += 1) {\r\n      const distance = getDistanceBetweenPoints(pt.x, pt.y, this.handles[i].basex, this.handles[i].basey)\r\n      if (distance <= config.HANDLE_DOT_RADIUS) {\r\n        return this.handles[i]\r\n      }\r\n    }\r\n    return undefined\r\n  }\r\n\r\n  getEarliestLockedHandle() {\r\n    // called to find earliest locked handle: we already know at least one is locked\r\n    for (let i = 0; i < this.handles.length; i += 1) {\r\n      if (this.handles[i].locked) {\r\n        return this.handles[i]\r\n      }\r\n    }\r\n  }\r\n\r\n  getLatestLockedHandle() {\r\n    // called to find latest locked handle: we already know at least one is locked\r\n    for (let i = this.handles.length - 1; i > 0; i -= 1) {\r\n      if (this.handles[i].locked) {\r\n        return this.handles[i]\r\n      }\r\n    }\r\n  }\r\n\r\n  getPreviousLockedHandle(handle) {\r\n    // called to find previous locked handle: we already know we are between locked handles\r\n    for (let i = handle.index - 1; i >= 0; i -= 1) {\r\n      if (this.handles[i].locked) {\r\n        return this.handles[i]\r\n      }\r\n    }\r\n  }\r\n\r\n  getNextLockedHandle(handle) {\r\n    // called to find next locked handle: we already know we are between locked handles\r\n    for (let i = handle.index + 1; i < this.handles.length; i += 1) {\r\n      if (this.handles[i].locked) {\r\n        return this.handles[i]\r\n      }\r\n    }\r\n  }\r\n\r\n  getSingleLockedHandle() {\r\n    // called when we know there is only one locked handle, so we can reuse another function\r\n    return this.getEarliestLockedHandle()\r\n  }\r\n\r\n  dragHandles(dx, dy) {\r\n    for (let i = 0; i < this.handles.length; i += 1) {\r\n      this.handles[i].x = this.handles[i].basex + dx\r\n      this.handles[i].y = this.handles[i].basey + dy\r\n    }\r\n  }\r\n\r\n  drawHandles() {\r\n    for (let i = 0; i < this.handles.length; i += 1) {\r\n      ctx.lineWidth = 1\r\n      if (this.handles[i].locked === true) {\r\n        ctx.fillStyle = config.RED_30\r\n        ctx.strokeStyle = config.RED\r\n      } else {\r\n        ctx.fillStyle = config.GREEN_30\r\n        ctx.strokeStyle = config.GREEN\r\n      }\r\n      ctx.beginPath()\r\n      ctx.arc(this.handles[i].x, this.handles[i].y, config.HANDLE_DOT_RADIUS, 0, 2 * Math.PI, false)\r\n      ctx.fill()\r\n      ctx.stroke()\r\n    }\r\n  }\r\n\r\n  alignHandles(points) {\r\n    // move handles back to be on adjusted track\r\n    for (let i = 0; i < this.handles.length; i += 1) {\r\n      this.handles[i].x = points.x[this.handles[i].time]\r\n      this.handles[i].y = points.y[this.handles[i].time]\r\n    }\r\n  }\r\n}\r\n","import { getMapSize, redraw } from \"./canvas\"\r\nimport { adjustTrack, getControlXY } from \"./draw\"\r\nimport { getWorldFile, mapIsGeoreferenced } from \"./events\"\r\nimport { Handles } from \"./handles\"\r\nimport { getDistanceBetweenPoints, getLatLonDistance, showWarningDialog } from \"./utils\"\r\n\r\nexport class RouteData {\r\n  constructor() {\r\n    this.courseid = null\r\n    this.coursename = null\r\n    this.controlsToAdjust = 0\r\n    this.resultid = null\r\n    this.isScoreCourse = false\r\n    this.eventid = null\r\n    this.name = null\r\n    this.comments = null\r\n    this.x = []\r\n    this.y = []\r\n    this.controlx = []\r\n    this.controly = []\r\n    this.time = []\r\n    this.startsecs = 0\r\n    this.totaltime = 0\r\n    this.splits = []\r\n    this.xml = null\r\n  }\r\n}\r\n\r\nexport class GPSTrack {\r\n  constructor() {\r\n    this.lat = []\r\n    this.lon = []\r\n    this.startOffset = 0\r\n    this.baseX = []\r\n    this.baseY = []\r\n    this.handles = new Handles()\r\n    this.savedBaseX = []\r\n    this.savedBaseY = []\r\n    this.fileLoaded = false\r\n    this.fileName = \"\"\r\n    this.fileType = \"\"\r\n    this.routeData = new RouteData()\r\n    this.autofitOffset = null\r\n  }\r\n\r\n  adjustOffset(offset) {\r\n    this.autofitOffset = offset\r\n    this.processGPSFile()\r\n    this.autofitTrack()\r\n  }\r\n\r\n  addStartAndFinishHandles() {\r\n    // add handles at start and finish of route\r\n    this.handles.addHandle(this.baseX[0], this.baseY[0], 0)\r\n    this.handles.addHandle(this.baseX[this.baseX.length - 1], this.baseY[this.baseY.length - 1], this.baseY.length - 1)\r\n  }\r\n\r\n  applyWorldFile() {\r\n    // translate lat/lon to x,y based on world file info: see http://en.wikipedia.org/wiki/World_file\r\n    const worldFile = getWorldFile()\r\n    for (let i = 0; i < this.lat.length; i += 1) {\r\n      this.routeData.x[i] = Math.round(\r\n        (worldFile.E * this.lon[i] - worldFile.B * this.lat[i] + worldFile.xCorrection) / worldFile.AEDB\r\n      )\r\n      this.routeData.y[i] = Math.round(\r\n        (-1 * worldFile.D * this.lon[i] + worldFile.A * this.lat[i] + worldFile.yCorrection) / worldFile.AEDB\r\n      )\r\n    }\r\n  }\r\n\r\n  autofitTrack() {\r\n    // fits a GPS track to the course based on split times at control locations\r\n    // unlock map to allow adjustment\r\n    document.getElementById(\"chk-move-all\").checked = false\r\n    this.handles.deleteAllHandles()\r\n    this.addStartAndFinishHandles()\r\n    if (this.autofitOffset === null) {\r\n      this.autofitOffset = this.getOffset()\r\n      //ui.setAutofitSpinner(this.autofitOffset)\r\n    }\r\n    // adjust for each control in turn\r\n    for (let i = 1; i < this.routeData.controlsToAdjust; i += 1) {\r\n      // don't try to adjust missing controls\r\n      if (this.routeData.splits[i] !== this.routeData.splits[i - 1]) {\r\n        const split = this.routeData.splits[i] + this.autofitOffset\r\n        // move track to control location\r\n        if (split < this.baseX.length && split >= 0) {\r\n          // add handle at control on track\r\n          this.handles.addHandle(this.routeData.x[split], this.routeData.y[split], split)\r\n          // drag handle to correct place on map\r\n          adjustTrack(\r\n            { x: this.routeData.x[split], y: this.routeData.y[split] },\r\n            { x: this.routeData.controlx[i], y: this.routeData.controly[i] }\r\n          )\r\n          // lock handle at control\r\n          this.handles.lockHandleByTime(split)\r\n          // rebaseline everything\r\n          this.baseX = this.routeData.x.slice(0)\r\n          this.baseY = this.routeData.y.slice(0)\r\n          this.handles.rebaselineXY()\r\n        }\r\n      }\r\n    }\r\n    document.getElementById(\"btn-autofit-gps\").setAttribute(\"disabled\", \"\")\r\n    document.getElementById(\"btn-undo-gps-adjust\").setAttribute(\"disabled\", \"\")\r\n    redraw()\r\n  }\r\n\r\n  expandToOneSecondInterval() {\r\n    // convert to one second intervals to make what follows a bit easier since we can index x and y directly\r\n    // time from GPX has already been converted to integer seconds so we don't need to worry about sub-seconds in the expansion\r\n    // gets reset to 3 second intervals on server when saved\r\n    let x = []\r\n    let y = []\r\n    let time = []\r\n    const trk = this.routeData\r\n    let oldtime = trk.time[0]\r\n    let oldx = trk.x[0]\r\n    let oldy = trk.y[0]\r\n    x[0] = oldx\r\n    y[0] = oldy\r\n    time[0] = trk.time[0]\r\n    let nexttime = time[0] + 1\r\n    for (let i = 1; i < trk.x.length; i += 1) {\r\n      const difftime = trk.time[i] - oldtime\r\n      // shouldn't have 0 intervals, but discard them if we do\r\n      if (difftime > 0) {\r\n        const xpersec = (trk.x[i] - oldx) / difftime\r\n        const ypersec = (trk.y[i] - oldy) / difftime\r\n        let secs = 1\r\n        while (secs <= difftime) {\r\n          x.push(oldx + xpersec * secs)\r\n          y.push(oldy + ypersec * secs)\r\n          //\r\n          time.push(nexttime)\r\n          nexttime += 1\r\n          secs += 1\r\n        }\r\n        oldx = trk.x[i]\r\n        oldy = trk.y[i]\r\n        oldtime = nexttime - 1\r\n      }\r\n    }\r\n    this.routeData.x = x.slice(0)\r\n    this.routeData.y = y.slice(0)\r\n    this.routeData.time = time.slice(0)\r\n  }\r\n\r\n  fitTrackInsideCourse() {\r\n    // fit track to within limits of course\r\n    // find bounding box for track\r\n    const latLon = this.getLatLonInfo()\r\n    const controlXY = this.getControlInfo()\r\n\r\n    // scale GPS track to within bounding box of controls: a reasonable start\r\n    let scaleX = (controlXY.maxX - controlXY.minX) / (latLon.maxLon - latLon.minLon)\r\n    let scaleY = (controlXY.maxY - controlXY.minY) / (latLon.maxLat - latLon.minLat)\r\n    // don't want to skew track so scale needs to be equal in each direction\r\n    // so we need to account for differences between a degree of latitude and longitude\r\n    if (scaleX > scaleY) {\r\n      // pix/lat = pix/lon * m/lat * lon/m\r\n      scaleY = (scaleX * latLon.latCorrection) / latLon.lonCorrection\r\n    } else {\r\n      // pix/lon = pix/lat * m/lon * lat/m\r\n      scaleX = (scaleY * latLon.lonCorrection) / latLon.latCorrection\r\n    }\r\n    // extra offset to put start of track at start location\r\n    this.routeData.x[0] = (this.lon[0] - latLon.minLon) * scaleX + controlXY.minX\r\n    this.routeData.y[0] = -1 * (this.lat[0] - latLon.maxLat) * scaleY + controlXY.minY\r\n\r\n    // translate lat/lon to x,y\r\n    const deltaX = controlXY.minX - (this.routeData.x[0] - controlXY.x[0])\r\n    const deltaY = controlXY.minY - (this.routeData.y[0] - controlXY.y[0])\r\n\r\n    for (let i = 0; i < this.lat.length; i += 1) {\r\n      this.routeData.x[i] = (this.lon[i] - latLon.minLon) * scaleX + deltaX\r\n      this.routeData.y[i] = -1 * (this.lat[i] - latLon.maxLat) * scaleY + deltaY\r\n    }\r\n  }\r\n\r\n  getControlInfo() {\r\n    let controlXY = getControlXY()\r\n    controlXY.minX = Math.min.apply(Math, controlXY.x)\r\n    controlXY.maxX = Math.max.apply(Math, controlXY.x)\r\n    controlXY.minY = Math.min.apply(Math, controlXY.y)\r\n    controlXY.maxY = Math.max.apply(Math, controlXY.y)\r\n\r\n    // issue #60: allow for no controls or just a few in a small area\r\n    // 100 is an arbitrary but sensible cut-off\r\n    if (controlXY.maxY - controlXY.minY < 100 || controlXY.maxX - controlXY.minX < 100) {\r\n      controlXY.minX = 0\r\n      controlXY.minY = 0\r\n      const size = getMapSize()\r\n      controlXY.maxX = size.width\r\n      controlXY.maxY = size.height\r\n    }\r\n    //console.log (minControlX, maxControlX, minControlY, maxControlY)\r\n    return controlXY\r\n  }\r\n\r\n  getLatLonInfo() {\r\n    let latLon = {}\r\n    latLon.maxLat = Math.max.apply(Math, this.lat)\r\n    latLon.maxLon = Math.max.apply(Math, this.lon)\r\n    latLon.minLat = Math.min.apply(Math, this.lat)\r\n    latLon.minLon = Math.min.apply(Math, this.lon)\r\n    latLon.lonCorrection =\r\n      getLatLonDistance(latLon.minLat, latLon.maxLon, latLon.minLat, latLon.minLon) / (latLon.maxLon - latLon.minLon)\r\n    latLon.latCorrection =\r\n      getLatLonDistance(latLon.minLat, latLon.minLon, latLon.maxLat, latLon.minLon) / (latLon.maxLat - latLon.minLat)\r\n    return latLon\r\n  }\r\n\r\n  getOffset() {\r\n    // calculates an offset to split times based on lowest average speed summed across all controls\r\n    const speedAverage = this.getSpeedAverage()\r\n    let speedAtControl = []\r\n    // range of seconds either side to check for \"minimum speed\" at control\r\n    const range = 10\r\n    for (let i = 0; i <= 2 * range; i += 1) {\r\n      speedAtControl[i] = 0\r\n    }\r\n    // read through each control\r\n    let speedExtract = 0\r\n    for (let i = 1; i < this.routeData.controlsToAdjust; i += 1) {\r\n      const split = this.routeData.splits[i]\r\n      // ignore missing splits\r\n      if (split !== this.routeData.splits[i - 1]) {\r\n        // avoid edge cases near start and finish\r\n        if (split >= range && split + range < speedAverage.length) {\r\n          speedExtract = speedAverage.slice(split - range, split + range + 1)\r\n        }\r\n        for (let j = 0; j <= 2 * range; j += 1) {\r\n          speedAtControl[j] += speedExtract[j]\r\n        }\r\n      }\r\n    }\r\n    let bestGuess = 0\r\n    for (let i = 1; i < speedAtControl.length; i += 1) {\r\n      if (speedAtControl[i] < speedAtControl[bestGuess]) {\r\n        bestGuess = i\r\n      }\r\n    }\r\n    // convert index in bestGuess into offset in x, y, time\r\n    const offset = bestGuess - range\r\n    return offset\r\n  }\r\n\r\n  getSecsFromTrackpoint(timestring) {\r\n    // input is 2013-12-03T12:34:56Z (or 56.000Z)\r\n    // needs to offset from midnight to allow replays, and alos needs to handle date (and year!) rollover\r\n    const secs = parseInt(Date.parse(timestring) / 1000, 10)\r\n    if (isNaN(secs)) {\r\n      return 0\r\n    }\r\n    return secs - this.startOffset\r\n  }\r\n\r\n  getSpeedAverage() {\r\n    // returns an array showing average speed for each second of the run\r\n    let speed = []\r\n    let speedAverage = []\r\n    speed[0] = 0\r\n    for (let i = 1; i < this.routeData.x.length; i += 1) {\r\n      // stored at second intervals so don't need to divide by time'\r\n      speed[i] = getDistanceBetweenPoints(\r\n        this.routeData.x[i],\r\n        this.routeData.y[i],\r\n        this.routeData.x[i - 1],\r\n        this.routeData.y[i - 1]\r\n      )\r\n    }\r\n    // average over 3 seconds to smooth things out\r\n    for (let i = 1; i < this.routeData.x.length - 1; i += 1) {\r\n      speedAverage[i] = (speed[i - 1] + speed[i] + speed[i + 1]) / 3\r\n    }\r\n    // not really worried about these but set to a sensible value\r\n    speedAverage[0] = speed[0]\r\n    speedAverage[this.routeData.x.length - 1] = speed[this.routeData.x.length - 1]\r\n    return speedAverage\r\n  }\r\n\r\n  getStartOffset(timestring) {\r\n    // needs to be set to midnight for supplied timestring\r\n    // input is 2013-12-03T12:34:56Z (or 56.000Z)\r\n    const secs = parseInt(Date.parse(timestring.substr(0, 11) + \"00:00:00Z\") / 1000, 10)\r\n    if (isNaN(secs)) {\r\n      return 0\r\n    }\r\n    return secs\r\n  }\r\n\r\n  initialiseGPS() {\r\n    this.lat.length = 0\r\n    this.lon.length = 0\r\n    this.startOffset = 0\r\n    this.baseX.length = 0\r\n    this.baseY.length = 0\r\n    this.handles.deleteAllHandles()\r\n    this.savedBaseX.length = 0\r\n    this.savedBaseY.length = 0\r\n    this.fileLoaded = false\r\n    this.routeData.x.length = 0\r\n    this.routeData.y.length = 0\r\n    this.routeData.time.length = 0\r\n  }\r\n\r\n  processGPSFile() {\r\n    this.initialiseGPS()\r\n    if (this.fileType === \"gpx\") {\r\n      this.processGPX()\r\n    } else {\r\n      this.processTCX()\r\n    }\r\n    this.processGPSTrack()\r\n  }\r\n\r\n  processGPSTrack() {\r\n    if (mapIsGeoreferenced()) {\r\n      this.applyWorldFile()\r\n      if (this.trackMatchesMapCoordinates()) {\r\n        // everything OK so lock background to avoid accidental adjustment\r\n        document.getElementById(\"chk-move-all\").checked = true\r\n      } else {\r\n        // warn and fit to track\r\n        showWarningDialog(\r\n          \"GPS file problem\",\r\n          \"Your GPS file does not match the map co-ordinates. Please check you have selected the correct file.\"\r\n        )\r\n        this.fitTrackInsideCourse()\r\n      }\r\n    } else {\r\n      this.fitTrackInsideCourse()\r\n    }\r\n    // finished with lat and lon so they can go just in case\r\n    this.lat.length = 0\r\n    this.lon.length = 0\r\n    this.expandToOneSecondInterval()\r\n    this.baseX = this.routeData.x.slice(0)\r\n    this.baseY = this.routeData.y.slice(0)\r\n    this.addStartAndFinishHandles()\r\n    this.fileLoaded = true\r\n    // need more than a start and finish to autofit\r\n    if (this.routeData.splits.length > 2) {\r\n      document.getElementById(\"btn-autofit-gps\").removeAttribute(\"disabled\")\r\n    }\r\n    document.getElementById(\"btn-save-gps-route\").removeAttribute(\"disabled\")\r\n    redraw()\r\n  }\r\n\r\n  processGPX() {\r\n    const trksegs = this.xml.getElementsByTagName(\"trkseg\")\r\n    for (let i = 0; i < trksegs.length; i += 1) {\r\n      const trkpts = trksegs[i].getElementsByTagName(\"trkpt\")\r\n      this.startOffset = this.getStartOffset(trkpts[0].getElementsByTagName(\"time\")[0].textContent)\r\n      // #319 allow for GPS files with (lat 0, lon 0)\r\n      for (let j = 0; j < trkpts.length; j += 1) {\r\n        const lat = trkpts[j].getAttribute(\"lat\")\r\n        const lon = trkpts[j].getAttribute(\"lon\")\r\n        // getAttribute returns strings\r\n        if (lat !== \"0\" && lon !== \"0\") {\r\n          this.lat.push(lat)\r\n          this.lon.push(lon)\r\n          this.routeData.time.push(this.getSecsFromTrackpoint(trkpts[j].getElementsByTagName(\"time\")[0].textContent))\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  processTCX() {\r\n    const trksegs = this.xml.getElementsByTagName(\"Track\")\r\n    for (let i = 0; i < trksegs.length; i += 1) {\r\n      const trkpts = trksegs[i].getElementsByTagName(\"Trackpoint\")\r\n      this.startOffset = this.getStartOffset(trkpts[0].getElementsByTagName(\"Time\")[0].textContent)\r\n      for (let j = 0; j < trkpts.length; j += 1) {\r\n        // allow for <trackpoint> with no position: see #199\r\n        if (trkpts[j].getElementsByTagName(\"Position\").length > 0) {\r\n          const position = trkpts[j].getElementsByTagName(\"Position\")\r\n          // #319 allow for GPS files with (lat 0, lon 0)\r\n          const lat = position[0].getElementsByTagName(\"LatitudeDegrees\")[0].textContent\r\n          const lon = position[0].getElementsByTagName(\"LongitudeDegrees\")[0].textContent\r\n          // textContent returns strings\r\n          if (lat !== \"0\" && lon !== \"0\") {\r\n            this.lat.push(lat)\r\n            this.lon.push(lon)\r\n            this.routeData.time.push(this.getSecsFromTrackpoint(trkpts[j].getElementsByTagName(\"Time\")[0].textContent))\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  readGPS(file) {\r\n    //console.log (\"File\" + e.target.files[0].name)\r\n    let reader = new FileReader()\r\n    this.fileName = file.target.files[0].name\r\n\r\n    reader.onerror = function (e) {\r\n      showWarningDialog(\"GPS file problem\", \"Unable to open GPS file. \" + e)\r\n    }\r\n    reader.onload = (text) => {\r\n      try {\r\n        this.fileType = this.fileName.slice(-3).toLowerCase()\r\n        if (this.fileType !== \"gpx\" && this.fileType !== \"tcx\") {\r\n          showWarningDialog(\r\n            \"GPS file problem\",\r\n            \"File type not recognised. Please check you have selected the correct file.\"\r\n          )\r\n          return\r\n        }\r\n        document.getElementById(\"rg2-load-gps-file\").setAttribute(\"disabled\", \"\")\r\n        this.xml = new DOMParser().parseFromString(text.target.result, \"text/xml\")\r\n        this.processGPSFile()\r\n      } catch (err) {\r\n        showWarningDialog(\r\n          \"GPS file problem\",\r\n          \"File is not valid XML. Please check you have selected the correct file. \" + err\r\n        )\r\n        return\r\n      }\r\n    }\r\n    // read the selected file\r\n    reader.readAsText(file.target.files[0])\r\n  }\r\n\r\n  trackMatchesMapCoordinates() {\r\n    // find bounding box for track\r\n    const minX = Math.min.apply(Math, this.routeData.x)\r\n    const maxX = Math.max.apply(Math, this.routeData.x)\r\n    const minY = Math.min.apply(Math, this.routeData.y)\r\n    const maxY = Math.max.apply(Math, this.routeData.y)\r\n    const mapSize = getMapSize()\r\n    // check we are somewhere on the map\r\n    return maxX > 0 && minX < mapSize.width && minY < mapSize.height && maxY > 0\r\n  }\r\n}\r\n","import { config } from \"./config\"\r\nlet id = 0\r\nlet courses = []\r\nlet routes = []\r\n\r\n// expand an array of routes or courses into a comma-separated string\r\nfunction extractItems(items, introText) {\r\n  if (items.length > 0) {\r\n    return introText + items.join(\",\")\r\n  }\r\n  return \"\"\r\n}\r\n\r\nfunction generateHash(hashID, hashRoutes, hashCourses) {\r\n  let hash = \"#\"\r\n  if (id !== 0) {\r\n    hash += hashID + extractItems(hashCourses, \"&course=\") + extractItems(hashRoutes, \"&route=\")\r\n  }\r\n  return hash\r\n}\r\n\r\nexport function getHashCourses() {\r\n  return courses\r\n}\r\n\r\nexport function getHashID() {\r\n  return id\r\n}\r\n\r\nexport function getHashRoutes() {\r\n  return routes\r\n}\r\n\r\nexport function getHashTab() {\r\n  if (routes.length > 0) {\r\n    return config.TAB_RESULTS\r\n  }\r\n  return config.TAB_COURSES\r\n}\r\n\r\nfunction getIDFromLocationHash(locationHash) {\r\n  let hashid = 0\r\n  // id should be numeric and between # and & or end of string whichever comes first\r\n  if (/#([0-9]+)($|&)/.test(locationHash)) {\r\n    hashid = locationHash.replace(/#([0-9]+)($|&).*/, \"$1\")\r\n    if (hashid.length > 0) {\r\n      return parseInt(hashid, 10)\r\n    }\r\n  }\r\n  return hashid\r\n}\r\n\r\nexport function parseLocationHash(hash) {\r\n  id = 0\r\n  courses.length = 0\r\n  routes.length = 0\r\n  // input looks like #id&course=a,b,c&result=x,y,z\r\n  let fields = hash.split(\"&\")\r\n  for (let i = 0; i < fields.length; i += 1) {\r\n    fields[i] = fields[i].toLowerCase()\r\n    if (fields[i].search(\"#\") !== -1) {\r\n      // remove # and anything else non-numeric before trying to convert to an integer\r\n      id = parseInt(fields[i].replace(/\\D/g, \"\"), 10)\r\n    }\r\n    if (fields[i].search(\"course=\") !== -1) {\r\n      courses = fields[i].replace(\"course=\", \"\").split(\",\")\r\n    }\r\n    if (fields[i].search(\"route=\") !== -1) {\r\n      routes = fields[i].replace(\"route=\", \"\").split(\",\")\r\n    }\r\n  }\r\n  // convert to integers: NaNs sort themselves out on display so don't check here\r\n  courses = courses.map(Number)\r\n  routes = routes.map(Number)\r\n\r\n  if (isNaN(id)) {\r\n    id = 0\r\n    courses.length = 0\r\n    routes.length = 0\r\n  }\r\n  setLocationHash()\r\n  return id\r\n}\r\n\r\nexport function setEventHash(newid) {\r\n  id = newid\r\n  setLocationHash()\r\n}\r\n\r\nexport function setHashCourses(displayedCourses) {\r\n  courses = displayedCourses\r\n  setLocationHash()\r\n}\r\n\r\nexport function setHashRoutes(displayedRoutes) {\r\n  routes = displayedRoutes\r\n  setLocationHash()\r\n}\r\n\r\nfunction setLocationHash() {\r\n  let hash = \"\"\r\n  if (getIDFromLocationHash(window.location.hash) === id) {\r\n    hash = generateHash(id, routes, courses)\r\n    // console.log(\"Replace\" + hash)\r\n    window.history.replaceState({ hash: hash }, \"\", hash)\r\n  } else {\r\n    courses.length = 0\r\n    routes.length = 0\r\n    hash = generateHash(id, routes, courses)\r\n    // console.log(\"Push \" + hash)\r\n    window.history.pushState({ hash: hash }, \"\", hash)\r\n  }\r\n}\r\n","import { ctx } from \"./canvas\"\r\nimport { config, options, getOverprintDetails } from \"./config\"\r\nimport { controls, getCourseDetails, incrementTracksCount, drawLinesBetweenControls } from \"./courses\"\r\nimport { getMetresPerPixel } from \"./events\"\r\nimport { decode } from \"html-entities\"\r\nimport { getTimeAndSplitsForID } from \"./results\"\r\nimport { getAngle, getDistanceBetweenPoints, getNextTrackColour } from \"./utils\"\r\n\r\nexport class Result {\r\n  constructor(data, isScoreEvent, scorecodes, scorex, scorey) {\r\n    // resultid is the kartat id value\r\n    this.resultid = data.resultid\r\n    this.rawid = this.resultid % config.GPS_RESULT_OFFSET\r\n    this.isScoreEvent = isScoreEvent\r\n    this.name = decode(data.name).trim()\r\n    this.initials = this.getInitials(this.name)\r\n    this.starttime = data.starttime\r\n    this.time = data.time\r\n    if (this.time === \"00\" || this.time === \"0\") {\r\n      this.time = \"\"\r\n    }\r\n    this.timeInSecs = data.secs\r\n    this.position = data.position\r\n    this.status = data.status\r\n    this.canDelete = false\r\n    this.showResult = true\r\n    this.token = 0\r\n    // get round iconv problem in API for now: unescape special characters to get sensible text\r\n    if (data.comments) {\r\n      this.comments = decode(data.comments)\r\n    } else {\r\n      this.comments = \"\"\r\n    }\r\n    this.coursename = data.coursename\r\n    if (this.coursename === \"\") {\r\n      // need to force this to be a string for use elsewhere\r\n      this.coursename = data.courseid.toString()\r\n    }\r\n    this.courseid = data.courseid\r\n    this.variant = data.variant\r\n    this.splits = this.adjustRawSplits(data.splits)\r\n    if (this.isScoreEvent) {\r\n      // save control locations for score course result\r\n      this.scorex = scorex\r\n      this.scorey = scorey\r\n      this.scorecodes = scorecodes\r\n    }\r\n    // colours set when track is displayed\r\n    this.trackColour = null\r\n    this.userColour = null\r\n    this.firstExcluded = getCourseDetails(this.courseid).firstExcluded\r\n    this.initialiseTrack(data)\r\n  }\r\n\r\n  addInterpolatedTimes(startindex, endindex, cumulativeDistance) {\r\n    // add interpolated time at each point based on cumulative distance; this assumes uniform speed...\r\n    const oldt = this.xysecs[startindex]\r\n    const deltat = this.xysecs[endindex] - oldt\r\n    const olddist = cumulativeDistance[startindex]\r\n    const deltadist = cumulativeDistance[endindex] - olddist\r\n    for (let i = startindex; i <= endindex; i += 1) {\r\n      this.xysecs[i] = oldt + Math.round(((cumulativeDistance[i] - olddist) * deltat) / deltadist)\r\n    }\r\n  }\r\n\r\n  addTrack(data) {\r\n    this.trackx = data.x.split(\",\").map(function (n) {\r\n      return parseInt(n, 10)\r\n    })\r\n    this.tracky = data.y.split(\",\").map(function (n) {\r\n      return parseInt(n, 10)\r\n    })\r\n    // co-ords sent as differences, so recreate absolute values\r\n    for (let i = 1; i < this.trackx.length; i += 1) {\r\n      this.trackx[i] = this.trackx[i - 1] + this.trackx[i]\r\n      this.tracky[i] = this.tracky[i - 1] + this.tracky[i]\r\n    }\r\n    let trackOK\r\n    if (this.isGPSTrack) {\r\n      trackOK = this.expandGPSTrack()\r\n    } else {\r\n      // handle events that just have a start and finish time\r\n      if (this.splits.length === 2) {\r\n        trackOK = this.expandTrackWithNoSplits()\r\n      } else {\r\n        trackOK = this.expandNormalTrack()\r\n      }\r\n    }\r\n    if (trackOK) {\r\n      incrementTracksCount(this.courseid)\r\n    }\r\n  }\r\n\r\n  adjustRawSplits(rawSplits) {\r\n    // insert a 0 split at the start to make life much easier elsewhere\r\n    rawSplits.splice(0, 0, 0)\r\n    // splits are time in seconds at control, but may have 0 for missing controls\r\n    // make life easier elsewhere by replacing 0 with time at previous valid control\r\n    for (let i = 1; i < rawSplits.length; i += 1) {\r\n      // also allow for negative splits\r\n      if (rawSplits[i] <= 0) {\r\n        rawSplits[i] = rawSplits[i - 1]\r\n      }\r\n    }\r\n    // for some excluded events the finish split is unadjusted (bug in results system?)\r\n    // so safer to copy in running time\r\n    // ...but don't get any slower than we already are (random missing splits or something)\r\n    rawSplits[rawSplits.length - 1] = Math.max(this.timeInSecs, rawSplits[rawSplits.length - 2])\r\n    return rawSplits\r\n  }\r\n\r\n  calculateTotalTrackLength() {\r\n    // read through track to find total distance\r\n    let cumulativeDistance = []\r\n    cumulativeDistance[0] = 0\r\n    let oldx = this.trackx[0]\r\n    let oldy = this.tracky[0]\r\n    for (let i = 1; i < this.trackx.length; i += 1) {\r\n      cumulativeDistance[i] =\r\n        cumulativeDistance[i - 1] + Math.round(getDistanceBetweenPoints(this.trackx[i], this.tracky[i], oldx, oldy))\r\n      oldx = this.trackx[i]\r\n      oldy = this.tracky[i]\r\n    }\r\n    return cumulativeDistance\r\n  }\r\n\r\n  calculateTrackTimes(course) {\r\n    let cumulativeDistance = []\r\n    cumulativeDistance[0] = 0\r\n    let nextcontrol = this.getNextValidControl(0)\r\n    let nextx = course.x[nextcontrol]\r\n    let nexty = course.y[nextcontrol]\r\n    let dist = 0\r\n    let oldx = this.trackx[0]\r\n    let oldy = this.tracky[0]\r\n    let x = 0\r\n    let y = 0\r\n    let previouscontrolindex = 0\r\n    // read through list of controls and copy in split times\r\n    // we are assuming the track starts at the start which is index 0...\r\n    // look at each track point and see if it matches the next control location\r\n    for (let i = 1; i < this.trackx.length; i += 1) {\r\n      // calculate distance while we are looping through\r\n      x = this.trackx[i]\r\n      y = this.tracky[i]\r\n      dist += getDistanceBetweenPoints(x, y, oldx, oldy)\r\n      cumulativeDistance[i] = Math.round(dist)\r\n      oldx = x\r\n      oldy = y\r\n      // track ends at control\r\n      if (nextx === x && nexty === y) {\r\n        this.xysecs[i] = this.splits[nextcontrol]\r\n        this.addInterpolatedTimes(previouscontrolindex, i, cumulativeDistance)\r\n        previouscontrolindex = i\r\n        nextcontrol = this.getNextValidControl(nextcontrol)\r\n        if (nextcontrol === course.x.length) {\r\n          // we have found all the controls\r\n          this.hasValidTrack = true\r\n          break\r\n        }\r\n        nextx = course.x[nextcontrol]\r\n        nexty = course.y[nextcontrol]\r\n      }\r\n    }\r\n  }\r\n\r\n  drawScoreCourse() {\r\n    // draws a score course for an individual runner to show where they went\r\n    // based on drawCourse in course.js\r\n    // could refactor in future...\r\n    // > 1 since we need at least a start and finish to draw something\r\n    if (this.displayScoreCourse && this.scorex.length > 1) {\r\n      const opt = getOverprintDetails()\r\n      ctx.globalAlpha = config.FULL_INTENSITY\r\n      let angle = getAngle(this.scorex[0], this.scorey[0], this.scorex[1], this.scorey[1])\r\n      controls.drawStart(this.scorex[0], this.scorey[0], \"\", angle, opt)\r\n      angle = []\r\n      for (let i = 0; i < this.scorex.length - 1; i += 1) {\r\n        angle[i] = getAngle(this.scorex[i], this.scorey[i], this.scorex[i + 1], this.scorey[i + 1])\r\n      }\r\n      // draw all controls for a score course: too complicated to filter individuals\r\n      const filter = { from: 0, to: this.scorex.length }\r\n      drawLinesBetweenControls({ x: this.scorex, y: this.scorey }, angle, this.courseid, opt, filter)\r\n      for (let i = 1; i < this.scorex.length - 1; i += 1) {\r\n        controls.drawSingleControl(this.scorex[i], this.scorey[i], i, Math.PI * 0.25, opt)\r\n      }\r\n      controls.drawFinish(this.scorex[this.scorex.length - 1], this.scorey[this.scorey.length - 1], \"\", opt)\r\n    }\r\n  }\r\n\r\n  drawTrack(filter) {\r\n    // lots of scope for problems drawing incomplete results so just trap and move on\r\n    try {\r\n      let oldx, oldy, stopCount\r\n      if (this.displayTrack) {\r\n        if (this.isGPSTrack && options.showGPSSpeed && this.speedColour.length === 0) {\r\n          this.setSpeedColours()\r\n        }\r\n        if (this.isGPSTrack) {\r\n          // add circle to show where control should be on GPS track based on split times\r\n          const opt = getOverprintDetails()\r\n          ctx.lineWidth = 1\r\n          ctx.strokeStyle = config.PURPLE\r\n          ctx.fillStyle = config.PURPLE_30\r\n          // get time at first control\r\n          let nextControlIndex = 1\r\n          let nextSplit = this.splits[nextControlIndex]\r\n          for (let i = 1; i < this.xysecs.length - 1; i += 1) {\r\n            // only makes sense up to an excluded control since we don't know how much time\r\n            // to take out of the track after that\r\n            if (this.firstExcluded > 0 && nextControlIndex >= this.firstExcluded) {\r\n              break\r\n            }\r\n            if (this.xysecs[i] >= nextSplit) {\r\n              // draw control circle\r\n              ctx.beginPath()\r\n              ctx.arc(this.trackx[i], this.tracky[i], opt.controlRadius * 0.3, 0, 2 * Math.PI, false)\r\n              // fill in with transparent colour to highlight control better\r\n              ctx.fill()\r\n              ctx.stroke()\r\n              nextControlIndex = nextControlIndex + 1\r\n              if (nextControlIndex >= this.splits.length) {\r\n                break\r\n              }\r\n              nextSplit = this.splits[nextControlIndex]\r\n            }\r\n          }\r\n        }\r\n        let startIndex = 0\r\n        let endIndex = this.xysecs.length\r\n        const fromSplit = this.splits[filter.filterFrom]\r\n        const toSplit = this.splits[filter.filterTo]\r\n        // attempt at loop optimisation since drawing is quite slow...\r\n        for (let f = 0; f < this.xysecs.length; f += 1) {\r\n          if (this.xysecs[f] >= fromSplit) {\r\n            startIndex = f\r\n            break\r\n          }\r\n        }\r\n        for (let f = this.xysecs.length - 1; f >= 0; f -= 1) {\r\n          if (this.xysecs[f] <= toSplit) {\r\n            endIndex = f\r\n            break\r\n          }\r\n        }\r\n        ctx.lineWidth = options.routeWidth\r\n        ctx.strokeStyle = this.trackColour\r\n        ctx.globalAlpha = options.perCentRouteIntensity / 100\r\n        ctx.fillStyle = this.trackColour\r\n        ctx.font = \"10pt Arial\"\r\n        ctx.textAlign = \"left\"\r\n        ctx.beginPath()\r\n        ctx.moveTo(this.trackx[startIndex], this.tracky[startIndex])\r\n        oldx = this.trackx[startIndex]\r\n        oldy = this.tracky[startIndex]\r\n        stopCount = 0\r\n        for (let i = startIndex + 1; i <= endIndex; i += 1) {\r\n          // lines\r\n          ctx.lineTo(this.trackx[i], this.tracky[i])\r\n          if (this.trackx[i] === oldx && this.tracky[i] === oldy) {\r\n            // we haven't moved\r\n            stopCount += 1\r\n          } else {\r\n            // we have started moving again\r\n            if (stopCount > 0) {\r\n              if (!this.isGPSTrack || (this.isGPSTrack && options.showThreeSeconds)) {\r\n                ctx.fillText(\"+\" + 3 * stopCount, oldx + 5, oldy + 5)\r\n              }\r\n              stopCount = 0\r\n            }\r\n          }\r\n          oldx = this.trackx[i]\r\n          oldy = this.tracky[i]\r\n          if (this.isGPSTrack && options.showGPSSpeed) {\r\n            // draw partial track since we need to keep changing colour\r\n            ctx.strokeStyle = this.speedColour[i]\r\n            ctx.stroke()\r\n            ctx.beginPath()\r\n            ctx.moveTo(oldx, oldy)\r\n          }\r\n        }\r\n        ctx.stroke()\r\n      }\r\n    } catch (e) {\r\n      //  console.log(\"Problem drawing track for result ID \" + this.resultid)\r\n      return\r\n    }\r\n  }\r\n\r\n  expandGPSTrack() {\r\n    // in theory we get one point every three seconds\r\n    for (let t = 0; t < this.trackx.length; t += 1) {\r\n      this.xysecs[t] = 3 * t\r\n    }\r\n    // colours now set the first time we try to draw the track: major time saving on initial event load\r\n    this.speedColour.length = 0\r\n    this.hasValidTrack = true\r\n    return this.hasValidTrack\r\n  }\r\n\r\n  expandNormalTrack() {\r\n    // allow for getting two tracks for same result: should have been filtered in API...\r\n    this.xysecs.length = 0\r\n    // add times and distances at each position\r\n    this.xysecs[0] = 0\r\n    // get course details\r\n    let course = {}\r\n    // each person has their own defined score course\r\n    if (this.isScoreEvent) {\r\n      course.x = this.scorex\r\n      course.y = this.scorey\r\n    } else {\r\n      course = getCourseDetails(this.courseid)\r\n    }\r\n    this.calculateTrackTimes(course)\r\n    // treat all score tracks as valid for now\r\n    // may need a complete rethink on score course handling later\r\n    if (this.isScoreEvent) {\r\n      this.hasValidTrack = true\r\n    }\r\n    return this.hasValidTrack\r\n  }\r\n\r\n  expandTrackWithNoSplits() {\r\n    // based on ExpandNormalTrack, but deals with event format 2: no results\r\n    // this means we have a course and a finish time but no split times\r\n    this.xysecs.length = 0\r\n    // only have finish time, which is in [1] at present\r\n    const totaltime = this.splits[1]\r\n    let currenttime = 0\r\n    this.xysecs[0] = 0\r\n    // get course details: can't be a score course since they aren't supported for format 2\r\n    const course = {}\r\n    course.x = getCourseDetails(this.courseid).x\r\n    course.y = getCourseDetails(this.courseid).y\r\n    let nextcontrol = 1\r\n    let nextx = course.x[nextcontrol]\r\n    let nexty = course.y[nextcontrol]\r\n    let lastx = course.x[course.x.length - 1]\r\n    let lasty = course.y[course.y.length - 1]\r\n    // add finish location to track just in case...\r\n    this.trackx.push(lastx)\r\n    this.tracky.push(lasty)\r\n    let previouscontrolindex = 0\r\n    const cumulativeDistance = this.calculateTotalTrackLength()\r\n    const totaldist = cumulativeDistance[cumulativeDistance.length - 1]\r\n    // read through track to generate splits\r\n    let x = 0\r\n    let y = 0\r\n    let moved = false\r\n    for (let i = 1; i < this.trackx.length; i += 1) {\r\n      x = this.trackx[i]\r\n      y = this.tracky[i]\r\n      // cope with routes that have start and finish in same place, and where the first point in a route is a repeat of the start\r\n      if (x !== this.trackx[0] || y !== this.tracky[0]) {\r\n        moved = true\r\n      }\r\n      // track ends at control, as long as we have moved away from the start\r\n      if (nextx === x && nexty === y && moved) {\r\n        currenttime = parseInt((cumulativeDistance[i] / totaldist) * totaltime, 10)\r\n        this.xysecs[i] = currenttime\r\n        this.splits[nextcontrol] = currenttime\r\n        this.addInterpolatedTimes(previouscontrolindex, i, cumulativeDistance)\r\n        previouscontrolindex = i\r\n        nextcontrol += 1\r\n        if (nextcontrol === course.x.length) {\r\n          // we have found all the controls\r\n          this.hasValidTrack = true\r\n          break\r\n        }\r\n        nextx = course.x[nextcontrol]\r\n        nexty = course.y[nextcontrol]\r\n      }\r\n    }\r\n    return this.hasValidTrack\r\n  }\r\n\r\n  getColour(value) {\r\n    // RGB Hex values\r\n    //   Red Or  Yel LGr Gre PaG LBl Bl  DBl\r\n    // R 255 255 255 128 0   0   0   0   0\r\n    // G 0   128 255 255 255 255 255 128 0\r\n    // B 0   0   0   0   0   128 255 255 255\r\n    let colour = \"#\"\r\n    // using range 0 = Red to 1 = Green\r\n    // gets in a value between 0 (slowest) and 1 (fastest) and returns a colour string\r\n    if (value === 0) {\r\n      return \"#0080ff\"\r\n    }\r\n    if (value < 0.5) {\r\n      colour += \"ff\"\r\n    } else {\r\n      const red = parseInt((1 - value) * 255 * 2, 10)\r\n      if (red < 16) {\r\n        colour += \"0\"\r\n      }\r\n      colour += red.toString(16)\r\n    }\r\n    if (value >= 0.5) {\r\n      colour += \"ff\"\r\n    } else {\r\n      const green = 255 - parseInt((0.5 - value) * 255 * 2, 10)\r\n      if (green < 16) {\r\n        colour += \"0\"\r\n      }\r\n      colour += green.toString(16)\r\n    }\r\n    colour += \"00\"\r\n    // console.log(value, colour)\r\n    return colour\r\n  }\r\n\r\n  getInitials(name) {\r\n    // converts name to initials\r\n    if (name === null) {\r\n      return \"??\"\r\n    }\r\n    // replace GPS with * so that we get *SE rather than GSE for initials\r\n    name = name.replace(/GPS/g, \"*\")\r\n    let initials = \"\"\r\n    let addNext = true\r\n    for (let i = 0; i < name.length; i += 1) {\r\n      if (addNext) {\r\n        initials += name.substr(i, 1)\r\n        addNext = false\r\n      }\r\n      if (name.charAt(i) === \" \") {\r\n        addNext = true\r\n      }\r\n    }\r\n    return initials\r\n  }\r\n\r\n  getNextValidControl(thisControl) {\r\n    // look through splits to find next control which has a split time\r\n    // to allow drawing for missed controls where the split time is 0\r\n    for (let i = thisControl + 1; i < this.splits.length; i += 1) {\r\n      if (this.splits[i] !== this.splits[i - 1]) {\r\n        return i\r\n      }\r\n    }\r\n    // implies we have no finish time which is unlikely but anyway...\r\n    return this.splits.length\r\n  }\r\n\r\n  initialiseTrack(data) {\r\n    this.legpos = []\r\n    this.racepos = []\r\n    // set true if track includes all expected controls in correct order or is a GPS track\r\n    this.hasValidTrack = false\r\n    this.displayTrack = false\r\n    this.displayScoreCourse = false\r\n    // raw track data\r\n    this.trackx = []\r\n    this.tracky = []\r\n    this.speedColour = []\r\n    // interpolated times\r\n    this.xysecs = []\r\n    // GPS track ids are normal resultid + GPS_RESULT_OFFSET\r\n    if (this.resultid >= config.GPS_RESULT_OFFSET) {\r\n      this.isGPSTrack = true\r\n      // don't get time or splits so need to copy them in from original result\r\n      const info = getTimeAndSplitsForID(this.rawid)\r\n      this.time = info.time\r\n      this.splits = info.splits\r\n      // allow for events with no results where there won't be a non-GPS result\r\n      if (this.time === config.TIME_NOT_FOUND) {\r\n        this.time = data.time\r\n      }\r\n    } else {\r\n      //this.name = data.name\r\n      this.isGPSTrack = false\r\n    }\r\n  }\r\n\r\n  mapSpeedColours() {\r\n    // speed options are in min/km\r\n    const maxMetresPerSecond = 16.667 / options.maxSpeed\r\n    const minMetresPerSecond = 16.667 / options.minSpeed\r\n    const secondsPerSample = 3\r\n    // converts speed to RGB value\r\n    const sorted = this.speedColour.slice().sort(function (a, b) {\r\n      return a - b\r\n    })\r\n    const metresPerPixel = getMetresPerPixel()\r\n    let maxspeed = 0\r\n    let minspeed = 0\r\n    if (metresPerPixel !== undefined) {\r\n      maxspeed = (secondsPerSample * maxMetresPerSecond) / metresPerPixel\r\n      minspeed = (secondsPerSample * minMetresPerSecond) / metresPerPixel\r\n    } else {\r\n      maxspeed = sorted[sorted.length - 1]\r\n      // arbitrary limit below which everything will be red\r\n      minspeed = sorted[Math.floor(sorted.length / 95)]\r\n    }\r\n    const range = maxspeed - minspeed\r\n    // speedColour comes in with speeds at each point and gets updated to the associated colour\r\n    for (let i = 0; i < this.speedColour.length; i += 1) {\r\n      // force value into allowable range\r\n      let value = Math.max(this.speedColour[i], minspeed)\r\n      value = Math.min(value, maxspeed)\r\n      //console.log(value, (value - minspeed) / range)\r\n      this.speedColour[i] = this.getColour((value - minspeed) / range)\r\n    }\r\n  }\r\n\r\n  setSpeedColours() {\r\n    //calculate distance between each point in pixels, averaged over 2 points\r\n    this.speedColour[0] = 0\r\n    let oldDelta = 0\r\n    for (let t = 1; t < this.trackx.length; t += 1) {\r\n      const delta = getDistanceBetweenPoints(this.trackx[t], this.tracky[t], this.trackx[t - 1], this.tracky[t - 1])\r\n      this.speedColour[t] = (delta + oldDelta) / 2\r\n      oldDelta = delta\r\n    }\r\n    this.mapSpeedColours()\r\n  }\r\n\r\n  setTrackDisplay(display) {\r\n    if (this.hasValidTrack) {\r\n      if (display) {\r\n        if (this.userColour !== null) {\r\n          this.trackColour = this.userColour\r\n        } else {\r\n          this.trackColour = getNextTrackColour()\r\n        }\r\n      } else {\r\n        this.trackColour = null\r\n      }\r\n      this.displayTrack = display\r\n    }\r\n  }\r\n}\r\n","import { resultIsBeingAnimated, updateTrackNames } from \"./animation\"\r\nimport { getMapSize } from \"./canvas\"\r\nimport { config, options } from \"./config\"\r\nimport {\r\n  controls,\r\n  isValidCourseId,\r\n  getCourseDetails,\r\n  getCourseName,\r\n  getCoursesForEvent,\r\n  getNumberOfControlsOnCourse,\r\n  getnumberOfCourses,\r\n  getFilterDetails,\r\n  setResultsCount,\r\n  updateScoreCourse\r\n} from \"./courses\"\r\nimport { setName } from \"./draw\"\r\nimport { getActiveMapID, getEventInfoForKartatID, getKartatEventID, getWorldFile, isScoreEvent } from \"./events\"\r\nimport { Result } from \"./result\"\r\nimport { setResultCheckboxes, displayStatsDialog } from \"./rg2ui\"\r\nimport { t } from \"./translate\"\r\nimport { formatSecsAsMMSS, generateOption } from \"./utils\"\r\n\r\nlet results = []\r\n\r\nexport function addResults(data, isScoreEvent) {\r\n  results.length = 0\r\n  let codes = []\r\n  let scorex = []\r\n  let scorey = []\r\n  // extract score course details if necessary\r\n  if (isScoreEvent) {\r\n    // details are only sent the first time a variant occurs (to reduce file size quite a lot in some cases)\r\n    // so need to extract them for use later\r\n    for (let i = 0; i < data.length; i += 1) {\r\n      let variant = data[i].variant\r\n      if (codes[variant] === undefined) {\r\n        codes[variant] = data[i].scorecodes\r\n        scorex[variant] = data[i].scorex\r\n        scorey[variant] = data[i].scorey\r\n      }\r\n    }\r\n  }\r\n  // save each result\r\n  for (let i = 0; i < data.length; i += 1) {\r\n    // trap cases where only some courses for an event are set up, but for some reason all the results get saved\r\n    // so you end up getting results for courses you don't know about: just ignore these results\r\n    if (isValidCourseId(data[i].courseid)) {\r\n      if (data[i].resultid > config.GPS_RESULT_OFFSET && data[i].coursename === \"\") {\r\n        data[i].coursename = getCourseDetails(data[i].courseid).name\r\n      }\r\n      let result = undefined\r\n      if (isScoreEvent) {\r\n        let variant = data[i].variant\r\n        result = new Result(data[i], isScoreEvent, codes[variant], scorex[variant], scorey[variant])\r\n      } else {\r\n        result = new Result(data[i], isScoreEvent)\r\n      }\r\n      results.push(result)\r\n    }\r\n  }\r\n  setDisplayOrder()\r\n  setDeletionInfo()\r\n  setScoreCourseInfo()\r\n  handleExclusions()\r\n  sanitiseSplits(isScoreEvent)\r\n}\r\n\r\nexport function addTracks(tracks) {\r\n  for (let i = 0; i < tracks.length; i += 1) {\r\n    let resultIndex = tracks[i].id\r\n    let j = 0\r\n    // loop through all results and add it against the correct id\r\n    while (j < results.length) {\r\n      if (resultIndex === results[j].resultid) {\r\n        results[j].addTrack(tracks[i])\r\n        break\r\n      }\r\n      j += 1\r\n    }\r\n  }\r\n}\r\n\r\nexport function allResultsForCourseReplayed(courseid) {\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].courseid === courseid) {\r\n      // careful: animation runners use index, not resultid\r\n      if (!resultIsBeingAnimated(i)) {\r\n        return false\r\n      }\r\n    }\r\n  }\r\n  return true\r\n}\r\n\r\nexport function allTracksDisplayed() {\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].hasValidTrack) {\r\n      if (!results[i].displayTrack) {\r\n        return false\r\n      }\r\n    }\r\n  }\r\n  return true\r\n}\r\n\r\nexport function allTracksForCourseDisplayed(courseid) {\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].courseid === courseid) {\r\n      if (results[i].hasValidTrack) {\r\n        if (!results[i].displayTrack) {\r\n          return false\r\n        }\r\n      }\r\n    }\r\n  }\r\n  return true\r\n}\r\n\r\nexport function allTracksForCourseReplayed(courseid) {\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].courseid === courseid) {\r\n      if (results[i].hasValidTrack) {\r\n        // careful: animation runners use index, not resultid\r\n        if (!resultIsBeingAnimated(i)) {\r\n          return false\r\n        }\r\n      }\r\n    }\r\n  }\r\n  return true\r\n}\r\n\r\nexport function anyTracksForCourseDisplayed(courseid) {\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].courseid === courseid) {\r\n      if (results[i].hasValidTrack) {\r\n        if (results[i].displayTrack) {\r\n          return true\r\n        }\r\n      }\r\n    }\r\n  }\r\n  return false\r\n}\r\n\r\nexport function countResultsByCourseID(courseid) {\r\n  const info = getEventInfoForKartatID()\r\n  let count = 0\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].courseid === courseid) {\r\n      // don't double-count GPS tracks, unless no initial results (#284)\r\n      if (\r\n        results[i].resultid < config.GPS_RESULT_OFFSET ||\r\n        info.format === config.FORMAT_NO_RESULTS ||\r\n        info.format === config.FORMAT_SCORE_EVENT_NO_RESULTS\r\n      ) {\r\n        count += 1\r\n      }\r\n    }\r\n  }\r\n  return count\r\n}\r\n\r\nexport function createNameDropdown(courseid) {\r\n  let dropdown = document.getElementById(\"rg2-select-name\")\r\n  dropdown.innerHTML = \"\"\r\n  dropdown.options.add(generateOption(null, t(\"Select name\", \"\")))\r\n  // empty dropdown if course not yet selected\r\n  if (courseid === undefined) {\r\n    return\r\n  }\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    // only use original results, not GPS results\r\n    if (results[i].courseid === courseid) {\r\n      if (results[i].resultid < config.GPS_RESULT_OFFSET) {\r\n        dropdown.options.add(generateOption(results[i].resultid, results[i].time + \" \" + results[i].name))\r\n      }\r\n    }\r\n  }\r\n  dropdown.addEventListener(\"change\", (e) => {\r\n    setName(parseInt(e.target.value, 10))\r\n  })\r\n  dropdown.removeAttribute(\"disabled\")\r\n}\r\n\r\nexport function createResultMenu() {\r\n  //loads menu from populated result array\r\n  let html = formatResultListAsAccordion()\r\n  // #177 not pretty but gets round problems of double encoding\r\n  html = html.replace(/&amp;/g, \"&\")\r\n  const el = document.getElementById(\"rg2-result-table\")\r\n  el.innerHTML = html\r\n  setResultsSearch()\r\n  setDisplayedRunnerCounts()\r\n  setResultCheckboxes()\r\n  const rows = document.querySelectorAll(\".resultrow\")\r\n  for (let row of rows) {\r\n    row.addEventListener(\"dblclick\", (e) => {\r\n      // currentTarget is the <tr> element: target points to <td> within the <tr>\r\n      const id = parseInt(e.currentTarget.dataset.id, 10)\r\n      if (id) {\r\n        displayStatsDialog(id)\r\n      }\r\n    })\r\n    row.addEventListener(\"contextmenu\", (e) => {\r\n      // currentTarget is the <tr> element: target points to <td> within the <tr>\r\n      const id = parseInt(e.currentTarget.dataset.id, 10)\r\n      if (id) {\r\n        displayStatsDialog(id)\r\n      }\r\n    })\r\n  }\r\n}\r\n\r\nexport function deleteResultsForEvent() {\r\n  results.length = 0\r\n}\r\n\r\nexport function displayScoreCourse(id, display) {\r\n  results[id].displayScoreCourse = display\r\n}\r\n\r\nexport function drawTracks() {\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    let filter\r\n    if (results[i].isScoreEvent) {\r\n      filter = { from: 0, to: results[i].scorex.length }\r\n    } else {\r\n      filter = getFilterDetails(results[i].courseid)\r\n    }\r\n    results[i].drawTrack(filter)\r\n    results[i].drawScoreCourse()\r\n  }\r\n}\r\n\r\nexport function formatResultListAsAccordion() {\r\n  // header rows to create\r\n  let headers = []\r\n  // results tables to create\r\n  let tables = []\r\n\r\n  if (results.length === 0) {\r\n    return `<p>${t(\"No results available\")}</p>`\r\n  }\r\n  let html = \"\"\r\n  let oldCourseID = 0\r\n  let tracksForThisCourse = 0\r\n  prepareResults()\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    const res = results[i]\r\n    if (!res.showResult) {\r\n      // result marked not to display as it is being combined with GPS route\r\n      continue\r\n    }\r\n    if (res.courseid !== oldCourseID) {\r\n      // save previous course table if there was one\r\n      if (headers.length > 0) {\r\n        html += getBottomRows(tracksForThisCourse, oldCourseID) + \"</table>\"\r\n        tables.push(html)\r\n      }\r\n      // found a new course so add header\r\n      tracksForThisCourse = 0\r\n      headers.push(getCourseHeader(res))\r\n      // Start the table with an id that relates to the course name to help with the filtering function\r\n      html = `<table class='resulttable' id='table-${res.courseid}'><thead><tr><th>#</th>`\r\n      html += `<th>${t(\"Name\")}</th><th>${t(\"Time\")}</th>`\r\n      html += `<th><i class='bi-pencil'></i></th><th><i class='bi-play-fill'></i></th></tr></thead><tbody class=\"table-group-divider\">`\r\n      oldCourseID = res.courseid\r\n    }\r\n    html += `<tr class=\"resultrow\" data-id=\"${res.rawid}\"><td>${res.position}</td>`\r\n    // #310 filter default comments in local language just in case\r\n    if (res.comments !== \"\" && res.comments !== t(\"Type your comment\")) {\r\n      // #304 make sure double quotes show up\r\n      res.comments = res.comments.replace(/\"/g, \"&quot;\")\r\n      html += `<td title=\"${res.comments}\"><u>${getNameHTML(res, i)}</u>`\r\n    } else {\r\n      html += `<td>${getNameHTML(res, i)}`\r\n    }\r\n    if (res.canDelete) {\r\n      html += ` <i class='deleteroute bi-trash-fill' data-resultidx=${i}></i>`\r\n    }\r\n    html += `</td><td>${res.time}</td>`\r\n    let showTrack = \"\"\r\n    let showReplay = \"showreplay\"\r\n    if (res.hasValidTrack) {\r\n      tracksForThisCourse += 1\r\n      showTrack = `<input class='showtrack' data-courseid='${oldCourseID}' data-id='${res.resultid}' type=checkbox name=result></input>`\r\n      showReplay += \" showtrackreplay\"\r\n    }\r\n    html += `<td>${showTrack}</td>`\r\n    html += `<td><input class=\"${showReplay}\" data-courseid=${oldCourseID} data-id=${res.resultid} type=checkbox name=replay></input></td></tr>`\r\n  }\r\n  html += `</tbody>${getBottomRows(tracksForThisCourse, oldCourseID)}</table>`\r\n  tables.push(html)\r\n\r\n  html = `<div class=\"accordion\" id=\"results-accordion\">`\r\n  for (let i = 0; i < tables.length; i += 1) {\r\n    html += `<div class=\"accordion-item\">`\r\n    html += `<h2 class=\"accordion-header d-flex\" id=\"header-${i}\">`\r\n    html += `<button class=\"accordion-button collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapse-${i}\" aria-expanded=\"true\" aria-controls=\"collapse-${i}\">`\r\n    html += `${headers[i].title}</button>${headers[i].check}</h2>`\r\n    html += `<div id=\"collapse-${i}\" class=\"accordion-collapse collapse\" aria-labelledby=\"header-${i}\" data-bs-parent=\"#rg2-result-tab-body\">`\r\n    html += `<div class=\"accordion-body px-0\">${tables[i]}</div></div></div>`\r\n  }\r\n  html += `</div>`\r\n  return html\r\n}\r\n\r\nfunction formatTotalRunningTime(secs) {\r\n  let time = Math.floor(secs / 86400) + \" days \"\r\n  secs = secs - 86400 * Math.floor(secs / 86400)\r\n  time += Math.floor(secs / 3600) + \" hours \"\r\n  secs = secs - 3600 * Math.floor(secs / 3600)\r\n  time += Math.floor(secs / 60) + \" minutes \"\r\n  time += secs - 60 * Math.floor(secs / 60) + \" seconds\"\r\n  return time\r\n}\r\n\r\n// read through results to get list of all controls on score courses\r\n// since there is no master list of controls!\r\nexport function generateScoreCourses() {\r\n  let courses = []\r\n  let codes = []\r\n  let x = []\r\n  let y = []\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    const res = results[i]\r\n    // only do this for original results, not GPS results\r\n    if (res.resultid < config.GPS_RESULT_OFFSET) {\r\n      const courseid = res.courseid\r\n      // save courseid if it is new\r\n      if (courses.indexOf(courseid) === -1) {\r\n        courses.push(courseid)\r\n        codes[courseid] = []\r\n        x[courseid] = []\r\n        y[courseid] = []\r\n      }\r\n      // read all controls for this result and save if new\r\n      for (let j = 0; j < res.scorecodes.length; j += 1) {\r\n        if (codes[courseid].indexOf(res.scorecodes[j]) === -1) {\r\n          codes[courseid].push(res.scorecodes[j])\r\n          x[courseid].push(res.scorex[j])\r\n          y[courseid].push(res.scorey[j])\r\n        }\r\n      }\r\n    }\r\n  }\r\n  // save the details we have just generated\r\n  for (let i = 0; i < courses.length; i += 1) {\r\n    const courseid = courses[i]\r\n    updateScoreCourse(courseid, codes[courseid], x[courseid], y[courseid])\r\n  }\r\n}\r\n\r\nexport function getAllResultsForCourse(courseid) {\r\n  let list = []\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].courseid === courseid) {\r\n      // only want first entry: not other drawn routes\r\n      if (results[i].resultid === results[i].rawid) {\r\n        list.push(results[i])\r\n      }\r\n    }\r\n  }\r\n  return list\r\n}\r\n\r\nexport function getAllResultsForVariant(variant) {\r\n  let list = []\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].variant === variant) {\r\n      // only want first entry: not other drawn routes\r\n      if (results[i].resultid === results[i].rawid) {\r\n        list.push(results[i])\r\n      }\r\n    }\r\n  }\r\n  return list\r\n}\r\n\r\nexport function getAllRunnersForCourse(courseid) {\r\n  let runners = []\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].courseid === courseid) {\r\n      runners.push(results[i].resultid)\r\n    }\r\n  }\r\n  return runners\r\n}\r\n\r\nexport function getAllRunnersWithTrackForCourse(courseid) {\r\n  let runners = []\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].courseid === courseid) {\r\n      if (results[i].hasValidTrack) {\r\n        runners.push(results[i].resultid)\r\n      }\r\n    }\r\n  }\r\n  return runners\r\n}\r\n\r\nfunction getBottomRows(tracks, courseid) {\r\n  // create bottom rows for all tracks checkboxes\r\n  // first row is drawn and GPS routes (if they exist)\r\n  let html = `<tfoot class=\"table-group-divider\"><tr class='allitemsrow'><td></td><td>${t(\"Routes\")}</td><td></td>`\r\n  if (tracks > 0) {\r\n    html += `<td><input class='allcoursetracks' data-courseid=${courseid} type=checkbox name=track></input></td>`\r\n    html += `<td><input class='allcoursetracksreplay' data-courseid=${courseid} type=checkbox name=replay></input></td>`\r\n  } else {\r\n    html += \"<td></td><td></td>\"\r\n  }\r\n  // second row allows replay of non-drawn routes\r\n  html += `</tr><tr class='allitemsrow'><td></td><td>${t(\"All\")}</td><td></td><td></td>`\r\n  html += `<td><input class='allcoursereplay' data-courseid=${courseid} type=checkbox name=replay></input></td></tr></tfoot>`\r\n  return html\r\n}\r\n\r\nexport function getCommentsForEvent() {\r\n  let hasComments = false\r\n  let html = [\r\n    `<table id='rg2-comments-table' class='table table-sm table-striped table-bordered'>`,\r\n    `<thead><tr><th>${t(\"Name\")}</th><th>${t(\"Course\")}</th>`,\r\n    `<th>${t(\"Comments\")}</th></tr></thead><tbody class=\"table-group-divider\">`\r\n  ].join(\"\")\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].comments !== \"\") {\r\n      hasComments = true\r\n      html += [\r\n        `<tr><td>${results[i].name}</td><td>${results[i].coursename}</td>`,\r\n        `<td>${results[i].comments}</td></tr>`\r\n      ].join(\"\")\r\n    }\r\n  }\r\n  if (hasComments) {\r\n    html += `</tbody></table>`\r\n  } else {\r\n    html = \"\"\r\n  }\r\n  return html\r\n}\r\n\r\nexport function getCourseForResult(id) {\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].resultid === id) {\r\n      return results[i].courseid\r\n    }\r\n  }\r\n  return undefined\r\n}\r\n\r\nfunction getCourseHeader(result) {\r\n  let text = result.coursename\r\n  const info = getCourseDetails(result.courseid)\r\n  // need to protect against some old events with dodgy results\r\n  // plus don't display length if a score/relay course or only two controls (S and F)\r\n  if (info && !info.isScoreCourse && info.codes.length > 2) {\r\n    text += info.lengthValid ? \": \" + info.length + \" km\" : \"\"\r\n  }\r\n  let html = `<div class=\"d-flex w-100\"><div class=\"flex-grow-1 runners-table-course-header\" data-runners=\"\" data-courseid=\"${result.courseid}\">${text}</div>`\r\n  let check = `<div class=\"px-2\"><input class='showcourse' data-courseid=\"${result.courseid}\"`\r\n  check += ` type=checkbox name =\"course\" title='Show course' ></input ></div >`\r\n  return { title: html, check: check }\r\n}\r\n\r\nexport function getDeletionInfo(id) {\r\n  return { id: results[id].resultid, token: results[id].token }\r\n}\r\n\r\nexport function getDisplayedTrackDetails() {\r\n  // used to populate rg2-track-names within animation on screen redraw\r\n  let tracks = []\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].displayTrack) {\r\n      let info = {}\r\n      info.trackColour = results[i].trackColour\r\n      info.course = getCourseName(results[i].courseid)\r\n      info.name = results[i].name\r\n      info.resultid = results[i].resultid\r\n      info.rawid = results[i].rawid\r\n      tracks.push(info)\r\n    }\r\n  }\r\n  return tracks\r\n}\r\n\r\nexport function getFullResultforResultID(resultid) {\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].resultid === resultid) {\r\n      return results[i]\r\n    }\r\n  }\r\n  return undefined\r\n}\r\n\r\nexport function getFullResultForRawID(rawid) {\r\n  let routeresult = undefined\r\n  let result = results.find((res) => res.rawid === rawid)\r\n  // rawid may be a GPS route: e.g. 50002\r\n  // if so we need to combine with the original result: e.g. 2\r\n  if (result !== undefined) {\r\n    routeresult = results.find((res) => {\r\n      // % needed since you may have 100002, 150002 if they have tried multiple times and deleted some\r\n      // BOC Sprint 2016: http://localhost/rg2/?#22&route=100002\r\n      return (res.resultid - rawid) % config.GPS_RESULT_OFFSET === 0 && res.resultid !== rawid\r\n    })\r\n    if (routeresult === undefined) {\r\n      result.routeresultid = rawid\r\n    } else {\r\n      result.routeresultid = routeresult.resultid\r\n      result.hasValidTrack = routeresult.hasValidTrack\r\n    }\r\n  }\r\n  return result\r\n}\r\n\r\nfunction getNameHTML(res, i) {\r\n  let namehtml\r\n  if (res.rawid === res.resultid) {\r\n    namehtml = res.name\r\n  } else {\r\n    namehtml = \"<i>\" + res.name + \"</i>\"\r\n  }\r\n  if (res.isScoreEvent) {\r\n    namehtml = `<input class='showscorecourse' data-courseid=${i} type=checkbox></input> ${namehtml}`\r\n  }\r\n  return `<div>${namehtml}</div>`\r\n}\r\n\r\nfunction getRawDisplayOrder(rawid) {\r\n  let idx = results.findIndex((res) => res.resultid === rawid)\r\n  return idx > -1 ? results[idx].displayOrder : rawid\r\n}\r\n\r\nfunction getResultsInfo() {\r\n  let info = { results: 0, drawnroutes: 0, gpsroutes: 0, secs: 0 }\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    const res = results[i]\r\n    if (res.resultid < config.GPS_RESULT_OFFSET) {\r\n      info.results += 1\r\n      // beware invalid splits for incomplete runs\r\n      if (res.time) {\r\n        info.secs += res.splits[res.splits.length - 1]\r\n      }\r\n    }\r\n    if (res.hasValidTrack) {\r\n      if (res.resultid < config.GPS_RESULT_OFFSET) {\r\n        info.drawnroutes += 1\r\n      } else {\r\n        info.gpsroutes += 1\r\n      }\r\n    }\r\n  }\r\n  info.totalroutes = info.drawnroutes + info.gpsroutes\r\n  if (info.results > 0) {\r\n    info.percent = ((100 * info.totalroutes) / info.results).toFixed(1)\r\n  } else {\r\n    info.percent = 0\r\n  }\r\n  info.time = formatTotalRunningTime(info.secs)\r\n  return info\r\n}\r\n\r\nexport function getResultsStats(eventinfo) {\r\n  const resultsinfo = getResultsInfo()\r\n  const coursearray = getCoursesForEvent()\r\n  const mapSize = getMapSize()\r\n  let wf = \"\"\r\n  if (eventinfo.worldfile.valid) {\r\n    const worldFile = getWorldFile()\r\n    const digits = 1000000\r\n    const lat = parseInt(worldFile.F * digits) / digits\r\n    const lng = parseInt(worldFile.C * digits) / digits\r\n    wf = `${t(\"Map is georeferenced\")}: <a href=\"https://www.openstreetmap.org/#map=15/${lat}/${lng}\" target=\"_blank\" rel=\"noopener noreferrer\">${lat}, ${lng}</a>.`\r\n  }\r\n\r\n  function card(title, body) {\r\n    const html = `<div class=\"card m-2 text-center\" style=\"width: auto; min-width: 15%\">\r\n    <div class=\"card-header\">${title}</div>\r\n    <div class=\"card-body\">\r\n      <p class=\"card-text\">${body}</p>\r\n    </div>\r\n  </div>`\r\n    return html\r\n  }\r\n  let stats =\r\n    card(t(\"Courses\"), coursearray.length) +\r\n    card(t(\"Controls\"), eventinfo.controls) +\r\n    card(t(\"Results\"), resultsinfo.results) +\r\n    card(t(\"Routes\"), resultsinfo.totalroutes + \" (\" + resultsinfo.percent + \"%)\") +\r\n    card(t(\"Drawn routes\"), resultsinfo.drawnroutes) +\r\n    card(t(\"GPS routes\"), resultsinfo.gpsroutes) +\r\n    card(t(\"Total time\"), resultsinfo.time) +\r\n    card(t(\"Map\") + \" ID \" + getActiveMapID(), mapSize.width + \"x\" + mapSize.height + \" pixels\" + \"<br>\" + wf)\r\n\r\n  if (eventinfo.comment) {\r\n    stats += card(t(\"Comments\"), eventinfo.comment)\r\n  }\r\n\r\n  return stats\r\n}\r\n\r\nexport function getRoutesForEvent() {\r\n  let routes = []\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].hasValidTrack) {\r\n      let route = {}\r\n      route.id = i\r\n      route.resultid = results[i].resultid\r\n      route.name = results[i].name\r\n      route.time = results[i].time\r\n      route.coursename = results[i].coursename\r\n      routes.push(route)\r\n    }\r\n  }\r\n  return routes\r\n}\r\n\r\nexport function getTimeAndSplitsForID(resultid) {\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (resultid === results[i].resultid) {\r\n      return { time: results[i].time, splits: results[i].splits }\r\n    }\r\n  }\r\n  return { time: config.TIME_NOT_FOUND, splits: [] }\r\n}\r\n\r\nexport function getTracksOnDisplay() {\r\n  let tracks = []\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    const result = results[i]\r\n    if (result.displayTrack) {\r\n      tracks.push(result.resultid)\r\n    }\r\n  }\r\n  return tracks\r\n}\r\n\r\nexport function getVariantList() {\r\n  // extract a list of all variants in a set of score/relay results\r\n  const variants = []\r\n  results.forEach((res) => {\r\n    if (!variants.includes(res.variant) && res.variant !== undefined) {\r\n      variants.push(res.variant)\r\n    }\r\n  })\r\n  return variants\r\n}\r\n\r\nfunction handleExclusions() {\r\n  // adjust times for events with excluded controls that have uploaded unadjusted splits\r\n  let currentCourseID = undefined\r\n  let course = undefined\r\n  let adjustedCourseIDs = []\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].courseid !== currentCourseID) {\r\n      currentCourseID = results[i].courseid\r\n      course = getCourseDetails(currentCourseID)\r\n    }\r\n    if (course.excludeType === config.EXCLUDED_REAL_SPLITS) {\r\n      if (adjustedCourseIDs.indexOf(currentCourseID) === -1) {\r\n        adjustedCourseIDs.push(currentCourseID)\r\n      }\r\n      let excluded = 0\r\n      // start at 1 since you can't exclude the start control\r\n      for (let j = 1; j < course.exclude.length; j += 1) {\r\n        if (course.exclude[j]) {\r\n          excluded = excluded + Math.min(results[i].splits[j] - results[i].splits[j - 1], course.allowed[j])\r\n        }\r\n      }\r\n      results[i].timeInSecs = Math.max(results[i].splits[results[i].splits.length - 1] - excluded, 0)\r\n      results[i].time = formatSecsAsMMSS(results[i].timeInSecs)\r\n    }\r\n  }\r\n  // set positions for amended courses\r\n  for (let i = 0; i < adjustedCourseIDs.length; i += 1) {\r\n    let runners = results.filter((res) => res.courseid === adjustedCourseIDs[i])\r\n    // horrid mess since all GPS results show status \"ok\" even if the original results was not \"ok\"\r\n    // so need to copy across status from original result\r\n    for (let j = 0; j < runners.length; j += 1) {\r\n      if (runners[j].rawid !== runners[j].resultid) {\r\n        let idx = runners.findIndex((res) => res.resultid === runners[j].rawid)\r\n        // should always find the index but...\r\n        if (idx > -1) {\r\n          runners[j].status = runners[idx].status\r\n        }\r\n      }\r\n    }\r\n    runners.sort(function (a, b) {\r\n      // sort valid times in ascending order\r\n      if (a.status !== \"ok\" || a.timeInSecs === 0) {\r\n        if (b.status !== \"ok\" || b.timeInSecs === 0) {\r\n          return 0\r\n        } else {\r\n          return 1\r\n        }\r\n      }\r\n      if (b.status !== \"ok\" || b.timeInSecs === 0) {\r\n        return -1\r\n      }\r\n      return a.timeInSecs - b.timeInSecs\r\n    })\r\n    let pos = 0\r\n    let prevTime = 0\r\n    for (let j = 0; j < runners.length; j += 1) {\r\n      if (runners[j].status !== \"ok\" || runners[j].timeInSecs === 0) {\r\n        runners[j].position = \"\"\r\n        continue\r\n      }\r\n      if (prevTime !== runners[j].timeInSecs) {\r\n        pos = pos + 1\r\n        prevTime = runners[j].timeInSecs\r\n      } else {\r\n        // same time, but might be GPS result for a normal result\r\n        if (j > 0) {\r\n          if (runners[j].rawid !== runners[j - 1].rawid) {\r\n            pos = pos + 1\r\n          }\r\n        }\r\n      }\r\n      runners[j].position = pos\r\n    }\r\n    for (let j = 0; j < runners.length; j += 1) {\r\n      let idx = results.findIndex((res) => res.resultid === runners[j].resultid)\r\n      // should always find the index but...\r\n      if (idx > -1) {\r\n        results[idx].position = runners[j].position\r\n        // set new display order for this course\r\n        results[idx].displayOrder = j\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction prepareResults() {\r\n  // want to avoid extra results line for GPS routes if there is no drawn route\r\n  // first sort so that GPS routes come after initial result\r\n  results.sort(sortByCourseIDThenResultID)\r\n  // now we can combine first GPS route with original result if needed\r\n  let oldID = undefined\r\n  let canCombine = false\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].rawid === oldID) {\r\n      if (canCombine) {\r\n        if (results[i].hasValidTrack) {\r\n          // found a GPS track to combine\r\n          results[i - 1].showResult = false\r\n          // add position to GPS route\r\n          results[i].position = results[i - 1].position\r\n          canCombine = false\r\n        }\r\n      }\r\n    } else {\r\n      // this is the original result which can be combined if\r\n      // it doesn't already have a drawn route\r\n      canCombine = !results[i].hasValidTrack\r\n      oldID = results[i].rawid\r\n    }\r\n  }\r\n}\r\n\r\nexport function resetSpeedColours() {\r\n  // called when user changes GPS speed colour configuration\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    // forces colours to recalculate\r\n    results[i].speedColour.length = 0\r\n  }\r\n}\r\n\r\nexport function resultIDExists(resultid) {\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (resultid === results[i].resultid) {\r\n      return true\r\n    }\r\n  }\r\n  return false\r\n}\r\n\r\nfunction sanitiseSplits(isScoreEvent) {\r\n  // sort out missing punches and add some helpful new fields\r\n  let currentCourseID = undefined\r\n  let course = undefined\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].courseid !== currentCourseID) {\r\n      currentCourseID = results[i].courseid\r\n      course = getCourseDetails(currentCourseID)\r\n    }\r\n    results[i].legSplits = []\r\n    results[i].legSplits[0] = 0\r\n    let previousValidSplit = 0\r\n    let nextSplitInvalid = false\r\n    for (let j = 1; j < results[i].splits.length; j += 1) {\r\n      if (results[i].splits[j] - previousValidSplit === 0) {\r\n        if (course.exclude[j]) {\r\n          results[i].legSplits[j] = results[i].splits[j] - previousValidSplit\r\n          previousValidSplit = results[i].splits[j]\r\n        } else {\r\n          // found a zero split\r\n          results[i].legSplits[j] = 0\r\n          // need to ignore next split as well: e.g missing 3 means splits to 3 and 4 are invalid\r\n          nextSplitInvalid = true\r\n          if (results[i].lastValidSplit === undefined) {\r\n            // race positions need to stop at previous control\r\n            results[i].lastValidSplit = j - 1\r\n          }\r\n        }\r\n      } else {\r\n        if (nextSplitInvalid) {\r\n          results[i].legSplits[j] = 0\r\n          previousValidSplit = results[i].splits[j]\r\n          nextSplitInvalid = false\r\n        } else {\r\n          results[i].legSplits[j] = results[i].splits[j] - previousValidSplit\r\n          previousValidSplit = results[i].splits[j]\r\n        }\r\n      }\r\n    }\r\n    if (results[i].lastValidSplit === undefined) {\r\n      results[i].lastValidSplit = results[i].splits.length - 1\r\n    }\r\n\r\n    // handle corrupted events with missing splits\r\n    // force all results to have the correct number of splits to make stats processing work correctly\r\n    if (!isScoreEvent) {\r\n      // splits array contains \"S\" and \"F\" as well as each control\r\n      const expectedSplits = getNumberOfControlsOnCourse(results[i].courseid) + 2\r\n      while (results[i].splits.length < expectedSplits) {\r\n        // copy last valid split data as often as necessary to fill missing gaps\r\n        results[i].splits.push(results[i].splits[results[i].splits.length - 1])\r\n        results[i].legSplits.push(0)\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport function saveResults(results) {\r\n  // TODO remove temporary (?) fix to get round RG1 events with no courses defined: see #179\r\n  if (getnumberOfCourses() > 0) {\r\n    addResults(results, isScoreEvent())\r\n  }\r\n  setResultsCount()\r\n  if (isScoreEvent()) {\r\n    generateScoreCourses()\r\n    controls.generateControlList()\r\n  }\r\n}\r\n\r\nexport function saveRoutes(data) {\r\n  // TODO remove temporary (?) fix to get round RG1 events with no courses defined: see #179\r\n  if (getnumberOfCourses() > 0) {\r\n    addTracks(data)\r\n  }\r\n}\r\n\r\nfunction setDeletionInfo() {\r\n  const eventid = getKartatEventID()\r\n  let deletionInfo = []\r\n  const opt = options.drawnRoutes\r\n  // find routes that can be deleted for this event\r\n  for (let i = 0; i < opt.length; i += 1) {\r\n    if (opt[i].eventid === eventid) {\r\n      deletionInfo.push(opt[i])\r\n    }\r\n  }\r\n  for (let i = 0; i < deletionInfo.length; i += 1) {\r\n    for (let r = 0; r < results.length; r += 1) {\r\n      if (results[r].resultid === deletionInfo[i].id) {\r\n        results[r].canDelete = true\r\n        results[r].token = deletionInfo[i].token\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction setDisplayedRunnerCounts() {\r\n  // set number of displayed runners in each course header\r\n  const resultTable = document.getElementById(\"rg2-result-table\")\r\n  const courses = resultTable.querySelectorAll(\"#results-accordion .accordion-item\")\r\n  courses.forEach((course) => {\r\n    const displayedRows = course.querySelectorAll(\".resulttable tbody tr:not(.d-none)\")\r\n    course.querySelector(\".runners-table-course-header\").setAttribute(\"data-runners\", displayedRows.length)\r\n  })\r\n}\r\n\r\nfunction setDisplayOrder() {\r\n  // used to sort results when generating results table for courses with excluded controls\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].resultid < config.GPS_RESULT_OFFSET) {\r\n      // order stays as it was when event was set up\r\n      results[i].displayOrder = i\r\n    } else {\r\n      results[i].displayOrder = getRawDisplayOrder(results[i].rawid)\r\n    }\r\n  }\r\n}\r\n\r\nexport function setResultColour(rawid, trackColour) {\r\n  // colours set by rawid so that all tracks for same runner are same colour\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].rawid === rawid) {\r\n      results[i].userColour = trackColour\r\n      results[i].trackColour = trackColour\r\n    }\r\n  }\r\n}\r\n\r\nfunction setResultsSearch() {\r\n  let searchBox = document.getElementById(\"rg2-result-search\")\r\n  if (results.length === 0) {\r\n    searchBox.classList.add(\"d-none\")\r\n    return\r\n  }\r\n  searchBox.innerHTML = `<form class=\"d-flex pb-2\" role=\"search\">\r\n  <input class=\"form-control mx-2\" type=\"search\" aria-label=\"${t(\"Search\")}\">\r\n  <i class=\"bi-search mx-2\"></i>\r\n  </form>`\r\n  let resultTable = document.getElementById(\"rg2-result-table\")\r\n  searchBox.addEventListener(\"keyup\", (e) => {\r\n    const filter = e.target.value.toUpperCase()\r\n    const rows = resultTable.querySelectorAll(\"tbody tr\")\r\n    // set visibility of all runners based on filter\r\n    for (let i = 0; i < rows.length; i += 1) {\r\n      if (rows[i].innerText.toUpperCase().indexOf(filter) > -1) {\r\n        rows[i].classList.remove(\"d-none\")\r\n      } else {\r\n        rows[i].classList.add(\"d-none\")\r\n      }\r\n    }\r\n    setDisplayedRunnerCounts()\r\n  })\r\n}\r\n\r\nexport function setScoreCourseDisplay(resultid, display) {\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].resultid === resultid) {\r\n      results[i].displayScoreCourse = display\r\n    }\r\n  }\r\n}\r\n\r\nfunction setScoreCourseInfo() {\r\n  // don't get score course info for GPS tracks so find it from original result\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].resultid >= config.GPS_RESULT_OFFSET) {\r\n      const baseresult = getFullResultForRawID(results[i].rawid)\r\n      if (baseresult !== undefined) {\r\n        if (baseresult.scorex !== undefined) {\r\n          results[i].scorex = baseresult.scorex\r\n          results[i].scorey = baseresult.scorey\r\n          results[i].scorecodes = baseresult.scorecodes\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport function setTrackDisplayByCourse(courseid, display) {\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].courseid === courseid || config.DISPLAY_ALL_COURSES === courseid) {\r\n      results[i].setTrackDisplay(display)\r\n    }\r\n  }\r\n  updateTrackNames()\r\n}\r\n\r\nexport function setTrackDisplayByResult(resultid, display) {\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].resultid === parseInt(resultid, 10)) {\r\n      results[i].setTrackDisplay(display)\r\n    }\r\n  }\r\n  updateTrackNames()\r\n}\r\n\r\nfunction sortByCourseIDThenResultID(a, b) {\r\n  // sorts GPS results to be immediately after the associated main id\r\n  if (a.courseid > b.courseid) {\r\n    return 1\r\n  }\r\n  if (b.courseid > a.courseid) {\r\n    return -1\r\n  }\r\n  // if rawid matches then this is a GPS route for an existing result\r\n  if (a.rawid === b.rawid) {\r\n    return a.resultid - b.resultid\r\n  }\r\n  // we know these are different results\r\n  // now sort by displayOrder to allow handling of excluded controls when results order might change\r\n  // displayOrder defaults to the original results order if nothing is excluded so this works as needed\r\n  // whether controls are excluded or not\r\n  return a.displayOrder - b.displayOrder\r\n}\r\n","import { getDistanceBetweenPoints } from \"./utils\"\r\nimport { config } from \"./config\"\r\nimport { getMetresPerPixel } from \"./events\"\r\nimport { getFullResultforResultID } from \"./results\"\r\nimport { getCourseDetails } from \"./courses\"\r\n\r\nexport class Runner {\r\n  constructor(resultid) {\r\n    const res = getFullResultforResultID(resultid)\r\n    this.name = res.name\r\n    this.initials = res.initials\r\n    // careful: we need the index into results, not the resultid from the text file\r\n    this.resultid = resultid\r\n    this.rawid = res.rawid\r\n    this.starttime = res.starttime\r\n    this.splits = res.splits\r\n    this.trackColour = res.trackColour\r\n    this.userColour = res.userColour\r\n    let course\r\n    if (res.isScoreEvent) {\r\n      course = {}\r\n      course.name = res.coursename\r\n      course.x = res.scorex\r\n      course.y = res.scorey\r\n      course.codes = res.scorecodes\r\n    } else {\r\n      course = getCourseDetails(res.courseid)\r\n    }\r\n    this.coursename = course.name\r\n    // used to stop runners when doing replay by control\r\n    this.nextStopTime = config.VERY_HIGH_TIME_IN_SECS\r\n    // map position x,y indexed by running time in seconds\r\n    this.x = []\r\n    this.y = []\r\n\r\n    // total distance travelled indexed by running time in seconds\r\n    // in metres if georeferenced, otherwise in pixels\r\n    this.cumulativeDistance = []\r\n    this.cumulativeDistance[0] = 0\r\n\r\n    // distance travelled for a leg indexed by control number\r\n    this.legTrackDistance = []\r\n    this.legTrackDistance[0] = 0\r\n\r\n    // total distance travelled at end of leg indexed by control number\r\n    this.cumulativeTrackDistance = []\r\n    this.cumulativeTrackDistance[0] = 0\r\n\r\n    if (res.hasValidTrack) {\r\n      this.expandTrack(res.trackx, res.tracky, res.xysecs)\r\n    } else {\r\n      // no track so use straight line between controls\r\n      this.expandTrack(course.x, course.y, res.splits)\r\n    }\r\n    this.addTrackDistances(course, res)\r\n  }\r\n\r\n  addTrackDistances(course, res) {\r\n    // add track distances for each leg\r\n    const lastPointIndex = this.cumulativeDistance.length - 1\r\n    if (course.codes !== undefined) {\r\n      // if we got no splits then there will just be a finish time\r\n      if (res.splits.length > 1) {\r\n        for (let control = 1; control < course.codes.length; control += 1) {\r\n          // avoid NaN values for GPS tracks that are shorter than the result time\r\n          let ind\r\n          if (res.splits[control] <= lastPointIndex) {\r\n            ind = res.splits[control]\r\n          } else {\r\n            ind = lastPointIndex\r\n          }\r\n          this.cumulativeTrackDistance[control] = this.cumulativeDistance[ind]\r\n          this.legTrackDistance[control] =\r\n            this.cumulativeTrackDistance[control] - this.cumulativeTrackDistance[control - 1]\r\n        }\r\n      } else {\r\n        // allows for tracks at events with no results so no splits: just use start and finish\r\n        this.legTrackDistance[1] = this.cumulativeDistance[lastPointIndex]\r\n        this.cumulativeTrackDistance[1] = this.cumulativeDistance[lastPointIndex]\r\n      }\r\n    }\r\n  }\r\n\r\n  expandTrack(itemsx, itemsy, itemstime) {\r\n    // gets passed arrays of x, y and time\r\n    // iterate over item which will be xy or controls\r\n    let timeatprevitem = 0\r\n    let timeatitem = 0\r\n    let fromx = itemsx[0]\r\n    let fromy = itemsy[0]\r\n    let fromdist = 0\r\n    let dist = 0\r\n    this.x[0] = itemsx[0]\r\n    this.y[0] = itemsy[0]\r\n    let metresPerPixel = getMetresPerPixel()\r\n    if (metresPerPixel === undefined) {\r\n      metresPerPixel = 1\r\n    }\r\n    for (let item = 1; item < itemstime.length; item += 1) {\r\n      let tox = itemsx[item]\r\n      let toy = itemsy[item]\r\n      let diffx = tox - fromx\r\n      let diffy = toy - fromy\r\n      dist = dist + getDistanceBetweenPoints(tox, toy, fromx, fromy) * metresPerPixel\r\n      let diffdist = dist - fromdist\r\n      timeatitem = itemstime[item]\r\n      // allow for 0 splits indicating a missed control\r\n      // just assume a 1 second split for now: probably harmless\r\n      if (timeatitem === 0) {\r\n        timeatitem = timeatprevitem + 1\r\n      }\r\n      let difft = timeatitem - timeatprevitem\r\n      for (let t = timeatprevitem + 1; t < timeatitem; t += 1) {\r\n        this.x[t] = Math.round(fromx + ((t - timeatprevitem) * diffx) / difft)\r\n        this.y[t] = Math.round(fromy + ((t - timeatprevitem) * diffy) / difft)\r\n        this.cumulativeDistance[t] = Math.round(fromdist + ((t - timeatprevitem) * diffdist) / difft)\r\n      }\r\n      this.x[timeatitem] = tox\r\n      this.y[timeatitem] = toy\r\n      this.cumulativeDistance[timeatitem] = Math.round(dist)\r\n      fromx = tox\r\n      fromy = toy\r\n      fromdist = dist\r\n      timeatprevitem = timeatitem\r\n    }\r\n  }\r\n}\r\n","export const tabs = [\r\n  { id: \"rg2-stats-summary\", title: \"Summary\", active: \"true\" },\r\n  { id: \"rg2-legs\", title: \"Leg times\" },\r\n  { id: \"rg2-cumulative\", title: \"Cumulative times\" },\r\n  { id: \"rg2-split-times\", title: \"Split times\" },\r\n  { id: \"rg2-time-loss\", title: \"Time loss\" },\r\n  { id: \"rg2-speed-stats\", title: \"Speed\" }\r\n]\r\n\r\nexport const content = [\r\n  `<div id=\"rg2-stats-summary\" class=\"container\"></div><div style=\"height: 400px;\"><canvas id=\"rg2-splits-chart\"></canvas></div>`,\r\n  `<div id=\"rg2-leg-table\" style=\"width: 950px; height: 100%\" class=\"ag-theme-balham\"></div>`,\r\n  `<div id=\"rg2-race-table\" style=\"width: 950px; height: 100%;\" class=\"ag-theme-balham\"></div>`,\r\n  `<div id=\"rg2-results-table\" class=\"rg2-results-table-container\">\r\n     <div id=\"rg2-results-grid-wrapper\">\r\n       <div id=\"rg2-results-grid\" style=\"height: 100%\" class=\"ag-theme-balham\"></div>\r\n     </div>\r\n   </div>`,\r\n  `<div id=\"rg2-time-loss\" class=\"container\">\r\n     <div class=\"d-flex align-items-center justify-content-between\">\r\n       <div class=\"d-flex align-items-center\">\r\n         <div id=\"rg2-control-change\" class=\"pe-4\">\r\n           <button id=\"rg2-stats-control-back\" class=\"btn btn-outline-primary btn-sm p-2\">&lt;</button>\r\n           <button id=\"rg2-stats-control-forward\" class=\"btn btn-outline-primary btn-sm p-2\">&gt;</button>\r\n         </div>\r\n         <div id=\"rg2-control-number\" class=\"fw-bold pe-2\"></div>\r\n       </div>\r\n       <div id=\"rg2-loss-details\" class=\"d-flex justify-content-center\"></div>\r\n     </div>\r\n     <canvas id=\"rg2-loss-chart\"></canvas>\r\n   </div>`,\r\n  `<div id=\"rg2-speed-stats\" style=\"width: 950px; height: 100%\" class=\"ag-theme-balham\"></div>`\r\n]\r\n\r\nexport const nameButtons = `<div class=\"rg2-stats-runner-change pe-4\">\r\n      <button class=\"rg2-stats-name-back btn btn-outline-primary btn-sm p-2\">\r\n        &lt;\r\n      </button>\r\n      <button class=\"rg2-stats-name-forward btn btn-outline-primary btn-sm p-2\">\r\n        &gt;\r\n      </button>\r\n    </div >`\r\n\r\nexport const courseButtons = `<div class=\"rg2-stats-course-change pe-4\">\r\n      <button class=\"rg2-stats-course-back btn btn-outline-primary btn-sm p-2\">\r\n        &lt;\r\n      </button>\r\n      <button class=\"rg2-stats-course-forward btn btn-outline-primary btn-sm p-2\">\r\n        &gt;\r\n      </button>\r\n    </div >`\r\n","import * as bootstrap from \"bootstrap\"\r\nimport { config } from \"./config\"\r\nimport { Course } from \"./course\"\r\nimport { getCourseDetails, getCourses } from \"./courses\"\r\nimport { eventHasResults, getMetresPerPixel, isScoreEvent } from \"./events\"\r\nimport { getAllResultsForCourse, getAllResultsForVariant, getFullResultForRawID, getVariantList } from \"./results\"\r\nimport { Runner } from \"./runner\"\r\nimport { content, courseButtons, nameButtons, tabs } from \"./statsconstants\"\r\nimport { t } from \"./translate\"\r\nimport { formatSecsAsMMSS, showWarningDialog } from \"./utils\"\r\n\r\nlet result = null\r\nlet rawid = null\r\nlet results = []\r\nlet variants = []\r\nlet isScoreOrRelay = false\r\nlet course = null\r\nlet controls = 0\r\nlet speedUnits = \"\"\r\nlet lengthUnits = \"m\"\r\nlet byLegPos = []\r\nlet byRacePos = []\r\nlet resultIndex = null\r\nlet splitsChart = undefined\r\nlet legChart = undefined\r\nlet activeLeg = 1\r\nlet maxIterationIndex = 9\r\n// starting iteration to use for display\r\nlet iterationIndex = 2\r\n// value returned as event.target.dataset.bsTarget for click on tab header\r\nconst startTab = \"#rg2-stats-summary-tab-label\"\r\nlet activeTab = startTab\r\n// Chart functionality dynamicaly loaded when needed\r\nlet Chart = null\r\n\r\nfunction adjustSplits() {\r\n  // adjust splits for events with excluded controls that have uploaded unadjusted splits\r\n  // total times were adjusted when results were saved initially\r\n  if (course.excludeType === config.EXCLUDED_REAL_SPLITS) {\r\n    for (let i = 0; i < results.length; i += 1) {\r\n      let excluded = 0\r\n      // start at 1 since you can't exclude the start control\r\n      for (let j = 1; j < course.exclude.length; j += 1) {\r\n        if (course.exclude[j]) {\r\n          const newExclude = Math.min(results[i].splits[j] - results[i].splits[j - 1] - excluded, course.allowed[j])\r\n          excluded = excluded + newExclude\r\n        }\r\n        results[i].splits[j] = results[i].splits[j] - excluded\r\n        results[i].legSplits[j] = results[i].splits[j] - results[i].splits[j - 1]\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction calculateLostTimeForIteration(iter) {\r\n  // find predicted times and losses\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (iter === 0) {\r\n      results[i].predictedSplits = []\r\n      results[i].loss = []\r\n      results[i].totalLoss = []\r\n    }\r\n    results[i].predictedSplits[iter] = []\r\n    results[i].predictedSplits[iter][0] = 0\r\n    results[i].loss[iter] = []\r\n    results[i].loss[iter][0] = 0\r\n    let loss = 0\r\n    for (let k = 0; k < controls; k += 1) {\r\n      if (results[i].performanceIndex[iter] > 0) {\r\n        results[i].predictedSplits[iter][k] = parseInt(\r\n          course.refLegTime[iter][k] / results[i].normalPerformanceIndex[iter],\r\n          10\r\n        )\r\n      } else {\r\n        results[i].predictedSplits[iter][k] = results[i].legSplits[k]\r\n      }\r\n      results[i].loss[iter][k] = results[i].legSplits[k] - results[i].predictedSplits[iter][k]\r\n      if (results[i].loss[iter][k] < 0) {\r\n        results[i].loss[iter][k] = 0\r\n      }\r\n      loss = loss + results[i].loss[iter][k]\r\n    }\r\n    results[i].totalLoss[iter] = loss\r\n  }\r\n}\r\n\r\nfunction calculatePerformanceForIteration(iter) {\r\n  // find reference times for each leg\r\n  if (iter === 0) {\r\n    course.refLegTime = []\r\n    course.refTime = []\r\n  }\r\n  let times = []\r\n  let refTimes = []\r\n  for (let i = 0; i < controls; i += 1) {\r\n    times.length = 0\r\n    if (!course.exclude[i]) {\r\n      for (let k = 0; k < results.length; k += 1) {\r\n        if (results[k].iterSplits[iter][i] !== 0) {\r\n          times.push(results[k].iterSplits[iter][i])\r\n        }\r\n      }\r\n    }\r\n    // using median of best 25% of times (minimum of 3) for the leg\r\n    const averages = getAverages(times, 25)\r\n    refTimes.push(averages.median)\r\n  }\r\n  course.refLegTime[iter] = refTimes.slice(0)\r\n  course.refTime[iter] = refTimes.reduce((a, b) => a + b)\r\n  // find ratio to reference times\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (iter === 0) {\r\n      results[i].refRatio = []\r\n      results[i].performanceIndex = []\r\n      results[i].normalPerformanceIndex = []\r\n      results[i].totalSecs = []\r\n    }\r\n    results[i].refRatio[iter] = []\r\n    const ratios = []\r\n    for (let k = 0; k < controls; k += 1) {\r\n      if (results[i].iterSplits[iter][k] === 0) {\r\n        results[i].refRatio[iter][k] = 0\r\n      } else {\r\n        results[i].refRatio[iter][k] = course.refLegTime[iter][k] / results[i].iterSplits[iter][k]\r\n      }\r\n      ratios.push(results[i].refRatio[iter][k])\r\n    }\r\n    const nonZeroRatios = ratios.filter((ratio) => ratio > 0)\r\n    const averages = getAverages(nonZeroRatios, 100)\r\n    results[i].performanceIndex[iter] = averages.median\r\n    results[i].totalSecs[iter] = results[i].iterSplits[iter].reduce((a, b) => a + b)\r\n\r\n    // normal PI weighted by ref times\r\n    let sum = 0\r\n    let weight = 0\r\n    for (let k = 0; k < controls; k += 1) {\r\n      if (results[i].iterSplits[iter][k] !== 0) {\r\n        sum = sum + results[i].refRatio[iter][k] * course.refLegTime[iter][k]\r\n        weight = weight + course.refLegTime[iter][k]\r\n      }\r\n    }\r\n    if (sum === 0) {\r\n      results[i].normalPerformanceIndex[iter] = 0\r\n    } else {\r\n      results[i].normalPerformanceIndex[iter] = sum / weight\r\n    }\r\n  }\r\n}\r\nfunction calculateSplitsforIteration(iter) {\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (iter === 0) {\r\n      results[i].iterSplits = []\r\n    }\r\n    let splits = []\r\n    for (let k = 0; k < controls; k += 1) {\r\n      if (iter === 0) {\r\n        splits.push(results[i].legSplits[k])\r\n      } else {\r\n        splits.push(results[i].predictedSplits[iter - 1][k])\r\n      }\r\n    }\r\n    results[i].iterSplits[iter] = splits.slice(0)\r\n  }\r\n}\r\n\r\nfunction changeControlNumberDown() {\r\n  activeLeg = activeLeg === result.splits.length - 1 ? 1 : activeLeg + 1\r\n  drawLegChart()\r\n}\r\n\r\nfunction changeControlNumberUp() {\r\n  activeLeg = activeLeg > 1 ? activeLeg - 1 : result.splits.length - 1\r\n  drawLegChart()\r\n}\r\n\r\nfunction changeCourse(direction) {\r\n  // aim is to switch course/variant and start with first runner on that course/variant\r\n  // stay where we are if anything goes wrong\r\n  let rawid = result.rawid\r\n  try {\r\n    let newresults = []\r\n    if (isScoreOrRelay) {\r\n      let index = variants.findIndex((variant) => {\r\n        return result.variant === variant\r\n      })\r\n      if (direction < 0) {\r\n        index = index === variants.length - 1 ? 0 : index + 1\r\n      } else {\r\n        index = index > 1 ? index - 1 : variants.length - 1\r\n      }\r\n      newresults = getAllResultsForVariant(variants[index])\r\n    } else {\r\n      const courses = getCourses()\r\n      let index = courses.findIndex((row) => {\r\n        if (!row) return false\r\n        return row.courseid === course.courseid\r\n      })\r\n      if (direction < 0) {\r\n        index = index === courses.length - 1 ? 1 : index + 1\r\n      } else {\r\n        index = index > 1 ? index - 1 : courses.length - 1\r\n      }\r\n      const courseid = courses[index].courseid\r\n      newresults = getAllResultsForCourse(courseid)\r\n    }\r\n    if (newresults.length > 0) {\r\n      rawid = newresults[0].rawid\r\n    }\r\n  } catch (err) {\r\n    console.log(\"Error switching to new course: \" + err)\r\n  }\r\n  prepareStats(rawid)\r\n}\r\n\r\nfunction changeName(direction) {\r\n  if (direction < 0) {\r\n    resultIndex = resultIndex === results.length - 1 ? 0 : resultIndex + 1\r\n  } else {\r\n    resultIndex = resultIndex > 0 ? resultIndex - 1 : results.length - 1\r\n  }\r\n  prepareStats(results[resultIndex].rawid)\r\n}\r\n\r\nfunction displayControlDetails(stacks) {\r\n  let control = \"\"\r\n  let leg = \"\"\r\n  if (result.splits.length - 1 === activeLeg) {\r\n    control = t(\"Finish\")\r\n  } else {\r\n    control = t(\"Control\")\r\n    leg = \": \" + activeLeg\r\n  }\r\n  let html = `<div>${control}${leg}</div>`\r\n  document.getElementById(\"rg2-control-number\").innerHTML = html\r\n\r\n  html = \"\"\r\n  if (course.exclude[activeLeg]) {\r\n    html = t(\"Control excluded\", \"\")\r\n  } else {\r\n    const losses = stacks.filter((stack) => stack.loss > 0).map((stack) => stack.loss)\r\n    const averages = getAverages(losses, 100)\r\n    html = `<div class=\"px-2 fw-bold\">${t(\"Runners with loss\")}: ${averages.count}</div >`\r\n    html += `<div class=\"px-2 fw-bold\">${t(\"Average\")}: ${parseInt(averages.mean, 10)}s (${\r\n      parseInt((averages.mean * 1000) / course.refLegTime[iterationIndex][activeLeg], 10) / 10\r\n    }%)</div>`\r\n    html += `<div class=\"px-2 fw-bold\">${t(\"Median\")}: ${averages.median}s (${\r\n      parseInt((averages.median * 1000) / course.refLegTime[iterationIndex][activeLeg], 10) / 10\r\n    }%)</div>`\r\n  }\r\n  document.getElementById(\"rg2-loss-details\").innerHTML = html\r\n}\r\n\r\nfunction displayStats() {\r\n  document.getElementById(\"rg2-stats-panel-tab-headers\").addEventListener(\"show.bs.tab\", (e) => {\r\n    handleTabActivation(e.target)\r\n  })\r\n\r\n  const nameBack = document.getElementsByClassName(\"rg2-stats-name-back\")\r\n  for (let row of nameBack) {\r\n    row.addEventListener(\"click\", () => {\r\n      changeName(1)\r\n    })\r\n  }\r\n  const nameForward = document.getElementsByClassName(\"rg2-stats-name-forward\")\r\n  for (let row of nameForward) {\r\n    row.addEventListener(\"click\", () => {\r\n      changeName(-1)\r\n    })\r\n  }\r\n\r\n  const courseBack = document.getElementsByClassName(\"rg2-stats-course-back\")\r\n  for (let row of courseBack) {\r\n    row.addEventListener(\"click\", () => {\r\n      changeCourse(1)\r\n    })\r\n  }\r\n  const courseForward = document.getElementsByClassName(\"rg2-stats-course-forward\")\r\n  for (let row of courseForward) {\r\n    row.addEventListener(\"click\", () => {\r\n      changeCourse(-1)\r\n    })\r\n  }\r\n\r\n  document.getElementById(\"rg2-stats-control-back\").addEventListener(\"click\", changeControlNumberUp)\r\n  document.getElementById(\"rg2-stats-control-forward\").addEventListener(\"click\", changeControlNumberDown)\r\n\r\n  // start on active tab: need to remove # which Bootstrap adds for some reason\r\n  document.getElementById(activeTab.replace(\"#\", \"\")).click()\r\n}\r\n\r\nfunction drawLegChart() {\r\n  if (legChart !== undefined) {\r\n    legChart.destroy()\r\n    legChart = undefined\r\n  }\r\n  const ctx = document.getElementById(\"rg2-loss-chart\")\r\n  const getBackgroundColor = (context) => {\r\n    if (stacks.length === 0) {\r\n      return config.DARK_GREEN_30\r\n    }\r\n    return stacks[context.dataIndex].activeRunner ? config.DARK_GREEN : config.DARK_GREEN_30\r\n  }\r\n  const getBackgroundLossColor = (context) => {\r\n    if (stacks.length === 0) {\r\n      return config.RED_30\r\n    }\r\n    return stacks[context.dataIndex].activeRunner ? config.RED : config.RED_30\r\n  }\r\n  const getBackgroundGainColor = (context) => {\r\n    if (stacks.length === 0) {\r\n      return config.BLUE_30\r\n    }\r\n    return stacks[context.dataIndex].activeRunner ? config.BLUE : config.BLUE_30\r\n  }\r\n  const getBackgroundPredictedColor = (context) => {\r\n    if (stacks.length === 0) {\r\n      return config.PURPLE_30\r\n    }\r\n    return stacks[context.dataIndex].activeRunner ? config.PURPLE : config.PURPLE_30\r\n  }\r\n\r\n  const stacks = []\r\n  if (!course.exclude[activeLeg]) {\r\n    results.map((res) => {\r\n      // only add runners with valid split for this control\r\n      if (parseInt(res.legSplits[activeLeg], 10) > 0) {\r\n        let stack = {}\r\n        // either plot predicted + loss (= actual) or actual + gain (= predicted)\r\n        const loss = parseInt(res.loss[iterationIndex][activeLeg], 10)\r\n        const predicted = parseInt(res.predictedSplits[iterationIndex][activeLeg], 10)\r\n        const actual = parseInt(res.legSplits[activeLeg], 10)\r\n        stack.loss = loss\r\n        stack.predicted = loss === 0 ? 0 : predicted\r\n        stack.rawPredicted = predicted\r\n        stack.actual = actual <= predicted ? actual : 0\r\n        stack.gain = actual <= predicted ? predicted - actual : 0\r\n        stack.realSplit = actual\r\n        stack.pos = res.legpos[activeLeg]\r\n        stack.name = res.name\r\n        if (res.rawid === rawid) {\r\n          stack.activeRunner = true\r\n        }\r\n        stacks.push(stack)\r\n      }\r\n    })\r\n  }\r\n  stacks.sort((a, b) => a.realSplit - b.realSplit)\r\n  const predicted = stacks.map((res) => res.predicted)\r\n  const actuals = stacks.map((res) => res.actual)\r\n  const losses = stacks.map((res) => res.loss)\r\n  const gains = stacks.map((res) => res.gain)\r\n  const labels = stacks.map((res) => res.pos)\r\n  const refTime = stacks.map(() => course.refLegTime[iterationIndex][activeLeg])\r\n  const worst = results.reduce((worst, res) => Math.max(worst, res.legSplits[activeLeg]), 0)\r\n  // fit y-axis to nearest higher multiple of x seconds\r\n  const scaleBase = 120\r\n  const timeMax = parseInt((worst + scaleBase - 1) / scaleBase, 10) * scaleBase\r\n  displayControlDetails(stacks)\r\n  legChart = new Chart(ctx, {\r\n    data: {\r\n      labels: labels,\r\n      datasets: [\r\n        {\r\n          label: \"Actual\",\r\n          type: \"bar\",\r\n          data: actuals,\r\n          backgroundColor: getBackgroundColor\r\n        },\r\n        {\r\n          label: \"Gain\",\r\n          type: \"bar\",\r\n          data: gains,\r\n          yAxisID: \"yLoss\",\r\n          backgroundColor: getBackgroundGainColor\r\n        },\r\n        {\r\n          label: \"Predicted\",\r\n          type: \"bar\",\r\n          data: predicted,\r\n          yAxisID: \"yLoss\",\r\n          backgroundColor: getBackgroundPredictedColor\r\n        },\r\n        {\r\n          label: \"Loss\",\r\n          type: \"bar\",\r\n          data: losses,\r\n          yAxisID: \"yLoss\",\r\n          backgroundColor: getBackgroundLossColor\r\n        },\r\n        {\r\n          label: \"Reference time\",\r\n          type: \"line\",\r\n          data: refTime,\r\n          borderColor: config.RED,\r\n          backgroundColor: config.WHITE,\r\n          borderDash: [5, 5],\r\n          yAxisID: \"yLoss\",\r\n          pointStyle: \"circle\",\r\n          pointRadius: 0,\r\n          pointHoverRadius: 0\r\n        }\r\n      ]\r\n    },\r\n    options: {\r\n      scales: {\r\n        x: {\r\n          stacked: true,\r\n          title: {\r\n            display: true,\r\n            text: \"Position\"\r\n          }\r\n        },\r\n        yLoss: {\r\n          stacked: true,\r\n          min: 0,\r\n          max: timeMax,\r\n          title: {\r\n            display: true,\r\n            text: \"Time (s)\"\r\n          }\r\n        }\r\n      },\r\n      plugins: {\r\n        tooltip: {\r\n          callbacks: {\r\n            label(context) {\r\n              let label = context.dataset.label + \": \"\r\n              if (context.dataset.label === \"Loss\") {\r\n                label += formatSecsAsMMSS(stacks[context.dataIndex].loss)\r\n              } else {\r\n                if (context.dataset.label === \"Gain\") {\r\n                  label += formatSecsAsMMSS(stacks[context.dataIndex].gain)\r\n                } else {\r\n                  if (context.dataset.label === \"Actual\") {\r\n                    label += formatSecsAsMMSS(stacks[context.dataIndex].actual)\r\n                  } else {\r\n                    label += formatSecsAsMMSS(stacks[context.dataIndex].predicted)\r\n                  }\r\n                }\r\n              }\r\n              return label\r\n            },\r\n            title(context) {\r\n              const title =\r\n                stacks[context[0].dataIndex].name + \": \" + formatSecsAsMMSS(stacks[context[0].dataIndex].realSplit)\r\n              return title\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  })\r\n  const legChartElement = document.querySelector(\"#rg2-loss-chart\")\r\n  legChartElement.onwheel = (e) => {\r\n    e.preventDefault()\r\n    e.deltaY < 0 ? changeControlNumberDown() : changeControlNumberUp()\r\n  }\r\n}\r\n\r\nfunction generateLegChart() {\r\n  activeLeg = 1\r\n  drawLegChart()\r\n}\r\n\r\nfunction generateLegPositions() {\r\n  let pos = []\r\n  // two very similar bits of code: scope to rationalise...\r\n  // Generate positions for each leg\r\n  // start at 1 since 0 is time 0\r\n  for (let k = 1; k < course.codes.length; k += 1) {\r\n    pos.length = 0\r\n    for (let j = 0; j < results.length; j += 1) {\r\n      if (results[j].resultid === results[j].rawid) {\r\n        if (results[j].isScoreEvent) {\r\n          if (results[j].variant === course.courseid) {\r\n            pos.push({ time: results[j].legSplits[k], id: j })\r\n          }\r\n        } else {\r\n          if (results[j].courseid === course.courseid) {\r\n            pos.push({ time: results[j].legSplits[k], id: j })\r\n          }\r\n        }\r\n      }\r\n    }\r\n    // 0 splits sorted to end\r\n    pos.sort(sortLegTimes)\r\n    let prevPos = 0\r\n    let prevTime = 0\r\n    // set positions\r\n    for (let j = 0; j < pos.length; j += 1) {\r\n      if (course.exclude[k]) {\r\n        results[pos[j].id].legpos[k] = 0\r\n        continue\r\n      }\r\n      if (pos[j].time !== prevTime) {\r\n        if (pos[j].time === 0) {\r\n          // all missing splits sorted to end with time 0\r\n          results[pos[j].id].legpos[k] = 0\r\n          prevTime = 0\r\n          prevPos = 0\r\n        } else {\r\n          // new time so position increments\r\n          results[pos[j].id].legpos[k] = j + 1\r\n          prevTime = pos[j].time\r\n          prevPos = j + 1\r\n        }\r\n      } else {\r\n        // same time so use same position\r\n        results[pos[j].id].legpos[k] = prevPos\r\n      }\r\n    }\r\n  }\r\n\r\n  // Generate positions for cumulative time at each control\r\n  pos.length = 0\r\n\r\n  // start at 1 since 0 is time 0\r\n  for (let k = 1; k < course.codes.length; k += 1) {\r\n    pos.length = 0\r\n    let time = 0\r\n    for (let j = 0; j < results.length; j += 1) {\r\n      if (results[j].resultid === results[j].rawid) {\r\n        if (results[j].isScoreEvent) {\r\n          if (results[j].variant === course.courseid) {\r\n            if (k > results[j].lastValidSplit) {\r\n              time = 0\r\n            } else {\r\n              time = results[j].splits[k]\r\n            }\r\n            pos.push({ time: time, id: j })\r\n          }\r\n        } else {\r\n          if (results[j].courseid === course.courseid) {\r\n            if (k > results[j].lastValidSplit) {\r\n              time = 0\r\n            } else {\r\n              time = results[j].splits[k]\r\n            }\r\n            pos.push({ time: time, id: j })\r\n          }\r\n        }\r\n      }\r\n    }\r\n    // 0 splits sorted to end\r\n    pos.sort(sortLegTimes)\r\n    let prevPos = 0\r\n    let prevTime = 0\r\n    for (let j = 0; j < pos.length; j += 1) {\r\n      if (pos[j].time !== prevTime) {\r\n        if (pos[j].time === 0) {\r\n          results[pos[j].id].racepos[k] = 0\r\n          prevPos = 0\r\n          prevTime = 0\r\n        } else {\r\n          // new time so position increments\r\n          results[pos[j].id].racepos[k] = j + 1\r\n          prevTime = pos[j].time\r\n          prevPos = j + 1\r\n        }\r\n      } else {\r\n        // same time so use same position\r\n        results[pos[j].id].racepos[k] = prevPos\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction getMinsPerKm(seconds, metres) {\r\n  if (metres <= 0 || seconds <= 0) {\r\n    return \"-\"\r\n  }\r\n  const speed = seconds / 60 / (metres / 1000)\r\n  const mins = parseInt(speed, 10)\r\n  const secs = parseInt((speed - mins) * 60, 10)\r\n\r\n  const value = mins + \":\" + (secs < 10 ? \"0\" + secs : secs)\r\n  // put value in brackets if based on pixels as an attempt\r\n  // to show they are not real mins/km\r\n  return speedUnits === \"\" ? \"(\" + value + \")\" : value\r\n}\r\n\r\nfunction generateSpeedTable() {\r\n  const rowData = []\r\n  const runner = new Runner(result.routeresultid)\r\n  for (let i = 0; i < result.splits.length; i += 1) {\r\n    let row = {}\r\n    row.name = result.name\r\n    if (i === 0) {\r\n      row.control = \"S\"\r\n    } else {\r\n      if (i == result.splits.length - 1) {\r\n        row.control = \"F\"\r\n      } else {\r\n        row.control = i + \" (\" + course.codes[i] + \")\"\r\n      }\r\n    }\r\n    if (i === 0) {\r\n      row.time = \"0:00\"\r\n    } else {\r\n      row.time = formatSecsAsMMSS(result.legSplits[i])\r\n    }\r\n    if (i === 0 || course.exclude[i]) {\r\n      row.length = \"-\"\r\n    } else {\r\n      row.length = course.legLengths[i]\r\n    }\r\n    if (i === 0 || course.exclude[i]) {\r\n      row.speed = \"-\"\r\n    } else {\r\n      row.speed = getMinsPerKm(result.legSplits[i], course.legLengths[i])\r\n    }\r\n    // GPS routes stop making sense after an excluded control since you don't know how many seconds were taken out\r\n    if (\r\n      i === 0 ||\r\n      course.exclude[i] ||\r\n      !result.hasValidTrack ||\r\n      (result.firstExcluded > 0 && result.firstExcluded <= i)\r\n    ) {\r\n      row.route = \"-\"\r\n    } else {\r\n      row.route = runner.legTrackDistance[i]\r\n    }\r\n    if (\r\n      i === 0 ||\r\n      course.exclude[i] ||\r\n      !result.hasValidTrack ||\r\n      (result.firstExcluded > 0 && result.firstExcluded <= i)\r\n    ) {\r\n      row.routespeed = \"-\"\r\n    } else {\r\n      row.routespeed = getMinsPerKm(result.legSplits[i], runner.legTrackDistance[i])\r\n    }\r\n    if (\r\n      i === 0 ||\r\n      course.exclude[i] ||\r\n      !result.hasValidTrack ||\r\n      (result.firstExcluded > 0 && result.firstExcluded <= i)\r\n    ) {\r\n      row.percent = \"-\"\r\n    } else {\r\n      row.percent = ((100 * runner.legTrackDistance[i]) / course.legLengths[i]).toFixed(1) + \"%\"\r\n    }\r\n    rowData.push(row)\r\n  }\r\n  let row = {}\r\n  row.name = \"Total\"\r\n  row.control = t(\"Total\", \"\")\r\n  row.time = formatSecsAsMMSS(result.timeInSecs)\r\n  row.length = course.length * 1000\r\n  row.speed = getMinsPerKm(result.timeInSecs, course.length * 1000)\r\n  if (result.hasValidTrack) {\r\n    row.route = runner.cumulativeTrackDistance[runner.cumulativeTrackDistance.length - 1]\r\n    row.routespeed = getMinsPerKm(\r\n      result.timeInSecs,\r\n      runner.cumulativeTrackDistance[runner.cumulativeTrackDistance.length - 1]\r\n    )\r\n    row.percent =\r\n      (\r\n        (100 * runner.cumulativeTrackDistance[runner.cumulativeTrackDistance.length - 1]) /\r\n        course.cumulativeLegLengths[course.cumulativeLegLengths.length - 1]\r\n      ).toFixed(1) + \"%\"\r\n  } else {\r\n    row.route = \"-\"\r\n    row.routespeed = \"-\"\r\n    row.percent = \"-\"\r\n  }\r\n\r\n  rowData.push(row)\r\n\r\n  const gridOptions = {\r\n    columnDefs: [\r\n      { headerName: t(\"Control\", \"\"), field: \"control\", width: 80 },\r\n      {\r\n        headerName: t(\"Time\", \"\"),\r\n        field: \"time\",\r\n        width: 80,\r\n        comparator: timeComparator.bind(this)\r\n      },\r\n      { headerName: t(\"Length\", \"\") + \" \" + lengthUnits, field: \"length\", width: 90 },\r\n      { headerName: t(\"Speed\", \"\") + \" \" + speedUnits, field: \"speed\", width: 125 },\r\n      { headerName: t(\"Route\", \"\") + \" \" + lengthUnits, field: \"route\", width: 90 },\r\n      { headerName: t(\"Speed\", \"\") + \" \" + speedUnits, field: \"routespeed\", width: 125 },\r\n      { headerName: t(\"%\", \"\"), field: \"percent\", width: 90 }\r\n    ],\r\n    rowData: rowData,\r\n    domLayout: \"autoHeight\",\r\n    rowClassRules: {\r\n      // apply green to 2008\r\n      \"fw-bold\": (params) => {\r\n        return params.data.name === \"Total\"\r\n      }\r\n    },\r\n    defaultColDef: {\r\n      headerClass: \"align-center\",\r\n      cellClass: \"align-center\",\r\n      sortable: true\r\n    }\r\n  }\r\n  const table = document.getElementById(\"rg2-speed-stats\")\r\n  table.innerHTML = \"\"\r\n  rg2Config.createGrid(table, gridOptions)\r\n}\r\n\r\nfunction generateSplitsChart() {\r\n  if (splitsChart !== undefined) {\r\n    splitsChart.destroy()\r\n    splitsChart = undefined\r\n  }\r\n  const skipped = (ctx, value) => (ctx.p0.skip || ctx.p1.skip ? value : undefined)\r\n  const ctx = document.getElementById(\"rg2-splits-chart\")\r\n  const res = results[resultIndex]\r\n  const labels = res.legpos.map((val, idx, array) => (idx === array.length - 1 ? \"F\" : idx))\r\n  const info = getLegPosInfo()\r\n  const legPos = res.legpos.map((val) => (val === 0 ? NaN : val))\r\n  const losses = res.loss[iterationIndex].map((val, idx) => (res.legpos[idx] === 0 ? NaN : val))\r\n  const gains = res.predictedSplits[iterationIndex].map((pred, idx) =>\r\n    res.legpos[idx] === 0 ? NaN : pred > res.legSplits[idx] ? pred - res.legSplits[idx] : 0\r\n  )\r\n  const averageLegPos = res.legpos.map(() => info.average)\r\n  const worst = losses.reduce((worst, loss) => Math.max(worst, isNaN(loss) ? 0 : loss), 0)\r\n  const best = gains.reduce((best, gain) => Math.max(best, isNaN(gain) ? 0 : gain), 0)\r\n  // fit y-axis (loss) to nearest higher multiple of x seconds\r\n  const scaleBase = 120\r\n  const lossGainMax = parseInt((Math.max(worst, best) + scaleBase - 1) / scaleBase, 10) * scaleBase\r\n  splitsChart = new Chart(ctx, {\r\n    data: {\r\n      labels: labels,\r\n      datasets: [\r\n        {\r\n          label: \"Leg position\",\r\n          type: \"line\",\r\n          data: legPos,\r\n          borderColor: config.PURPLE,\r\n          backgroundColor: config.PURPLE_30,\r\n          yAxisID: \"yPosition\",\r\n          segment: {\r\n            borderColor: (ctx) => skipped(ctx, \"rgb(0,0,0,0.2)\"),\r\n            borderDash: (ctx) => skipped(ctx, [6, 6])\r\n          },\r\n          spanGaps: true\r\n        },\r\n        {\r\n          label: \"Average leg position\",\r\n          type: \"line\",\r\n          data: averageLegPos,\r\n          borderColor: config.RED,\r\n          backgroundColor: config.WHITE,\r\n          borderDash: [5, 5],\r\n          yAxisID: \"yPosition\",\r\n          pointStyle: \"circle\",\r\n          pointRadius: 0,\r\n          pointHoverRadius: 0\r\n        },\r\n        {\r\n          label: \"Time loss\",\r\n          type: \"bar\",\r\n          data: losses,\r\n          borderColor: config.RED,\r\n          backgroundColor: config.RED_30,\r\n          yAxisID: \"yLoss\",\r\n          segment: {\r\n            borderColor: (ctx) => skipped(ctx, \"rgb(0,0,0,0.2)\"),\r\n            borderDash: (ctx) => skipped(ctx, [6, 6])\r\n          }\r\n        },\r\n        {\r\n          label: \"Time gain\",\r\n          type: \"bar\",\r\n          data: gains,\r\n          borderColor: config.BLUE,\r\n          backgroundColor: config.BLUE_30,\r\n          yAxisID: \"yLoss\",\r\n          segment: {\r\n            borderColor: (ctx) => skipped(ctx, \"rgb(0,0,0,0.2)\"),\r\n            borderDash: (ctx) => skipped(ctx, [6, 6])\r\n          }\r\n        }\r\n      ]\r\n    },\r\n    options: {\r\n      maintainAspectRatio: false,\r\n      responsive: true,\r\n      scales: {\r\n        x: {\r\n          min: 1,\r\n          title: {\r\n            display: true,\r\n            text: t(\"Control\", \"\")\r\n          },\r\n          stacked: true\r\n        },\r\n        yPosition: {\r\n          type: \"linear\",\r\n          display: true,\r\n          position: \"left\",\r\n          min: 0,\r\n          max: parseInt((results.length + 9) / 10, 10) * 10,\r\n          title: {\r\n            display: true,\r\n            text: \"Leg position\"\r\n          }\r\n        },\r\n        yLoss: {\r\n          type: \"linear\",\r\n          display: true,\r\n          position: \"right\",\r\n          min: 0,\r\n          max: lossGainMax,\r\n          grid: {\r\n            drawOnChartArea: false\r\n          },\r\n          title: {\r\n            display: true,\r\n            text: \"Time gain/loss (s)\"\r\n          }\r\n        }\r\n      },\r\n      plugins: {\r\n        tooltip: {\r\n          callbacks: {\r\n            label: function (context) {\r\n              if (context.dataset.label === \"Time loss\") {\r\n                return \"Loss: \" + formatSecsAsMMSS(losses[context.dataIndex])\r\n              }\r\n              if (context.dataset.label === \"Time gain\") {\r\n                return \"Gain: \" + formatSecsAsMMSS(gains[context.dataIndex])\r\n              }\r\n              if (context.dataset.label === \"Leg position\") {\r\n                return \"Position: \" + legPos[context.dataIndex]\r\n              }\r\n              return \"\"\r\n            },\r\n            title: function (context) {\r\n              if (context[0].label === \"F\") {\r\n                return t(\"Finish\", \"\")\r\n              }\r\n              return t(\"Control\", \"\") + \" \" + context[0].label\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  })\r\n  const splitsChartElem = document.querySelector(\"#rg2-splits-chart\")\r\n  splitsChartElem.onwheel = (event) => {\r\n    event.preventDefault()\r\n    event.deltaY < 0 ? changeName(-1) : changeName(1)\r\n  }\r\n}\r\n\r\nfunction generateSplitsTable() {\r\n  const columnDefs = [\r\n    {\r\n      headerName: t(\"Pos\", \"\"),\r\n      field: \"position\",\r\n      cellDataType: \"text\",\r\n      width: 60,\r\n      pinned: \"left\",\r\n      sortable: true\r\n    },\r\n    {\r\n      headerName: t(\"Name\", \"\"),\r\n      field: \"name\",\r\n      cellDataType: \"text\",\r\n      headerClass: \"align-left\",\r\n      cellClass: \"align-left\",\r\n      width: 150,\r\n      pinned: \"left\"\r\n    },\r\n    { headerName: \"rawid\", field: \"rawid\", cellDataType: \"number\", hide: true },\r\n    { headerName: t(\"Time\", \"\"), field: \"time\", cellDataType: \"text\", width: 85 }\r\n  ]\r\n  for (let j = 1; j < controls - 1; j += 1) {\r\n    columnDefs.push({\r\n      headerName: j + \" (\" + course.codes[j] + \")\",\r\n      field: \"C\" + j,\r\n      cellDataType: \"text\",\r\n      cellRenderer: renderSplits,\r\n      width: 110\r\n    })\r\n  }\r\n  columnDefs.push({\r\n    headerName: t(\"F\", \"\"),\r\n    field: \"finish\",\r\n    cellDataType: \"text\",\r\n    cellRenderer: renderSplits,\r\n    width: 110\r\n  })\r\n  columnDefs.push({ headerName: t(\"Loss\", \"\"), field: \"loss\", cellDataType: \"text\", width: 100 })\r\n  columnDefs.push({\r\n    headerName: t(\"Performance\", \"\"),\r\n    field: \"performance\",\r\n    cellDataType: \"text\",\r\n    width: 100\r\n  })\r\n  columnDefs.push({\r\n    headerName: t(\"Consistency\", \"\"),\r\n    field: \"consistency\",\r\n    cellDataType: \"text\",\r\n    width: 100\r\n  })\r\n\r\n  let rowData = []\r\n  // sort results table: this gets round problems of having multiple classes on one course where results were by class\r\n  results.sort(function (a, b) {\r\n    // sort valid times in ascending order\r\n    // sometimes end up with negative or 0 splits so handle those first\r\n    if (a.racepos[a.splits.length - 1] <= 0) {\r\n      return 1\r\n    } else {\r\n      if (b.racepos[b.splits.length - 1] <= 0) {\r\n        return -1\r\n      } else {\r\n        return a.racepos[a.splits.length - 1] - b.racepos[b.splits.length - 1]\r\n      }\r\n    }\r\n  })\r\n  // need to reset index for active result since array has been sorted\r\n  resultIndex = setResultIndex(rawid)\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    let row = {}\r\n    const r = results[i]\r\n    if (r.racepos[controls - 1] == 0) {\r\n      row.position = \"\"\r\n    } else {\r\n      row.position = r.racepos[controls - 1]\r\n    }\r\n    row.name = r.name\r\n    row.rawid = r.rawid\r\n    row.time = r.time\r\n    for (let j = 1; j < controls - 1; j += 1) {\r\n      if (r.splits[j] === r.splits[j - 1]) {\r\n        // no valid split for this control\r\n        row[\"C\" + j] = { split: \"0:00\", pos: r.racepos[j], loss: false }\r\n      } else {\r\n        row[\"C\" + j] = {\r\n          split: formatSecsAsMMSS(r.splits[j]),\r\n          pos: r.racepos[j],\r\n          loss: false\r\n        }\r\n      }\r\n    }\r\n    row.finish = {\r\n      split: formatSecsAsMMSS(r.splits[controls - 1]),\r\n      pos: r.racepos[controls - 1]\r\n    }\r\n    row.loss = formatSecsAsMMSS(r.timeInSecs - r.totalLoss[iterationIndex])\r\n    row.performance = (r.performanceIndex[0] * 100).toFixed(1)\r\n    // discard all 0 entries which relate to missed controls\r\n    const ratios = r.refRatio[0].filter((ratio) => ratio > 0)\r\n    row.consistency = (100 * getStandardDeviation(ratios)).toFixed(1)\r\n    rowData.push(row)\r\n    row = {}\r\n    row.rawid = r.rawid\r\n    for (let j = 1; j < controls - 1; j += 1) {\r\n      // highlight predicted losses greater than 20 seconds\r\n      row[\"C\" + j] = {\r\n        split: formatSecsAsMMSS(r.legSplits[j]),\r\n        pos: r.legpos[j],\r\n        loss: r.loss[iterationIndex][j] > 19\r\n      }\r\n    }\r\n    row.finish = {\r\n      split: formatSecsAsMMSS(r.legSplits[controls - 1]),\r\n      pos: r.legpos[controls - 1],\r\n      loss: r.loss[iterationIndex][controls - 1] > 19\r\n    }\r\n    row.loss = formatSecsAsMMSS(r.totalLoss[iterationIndex])\r\n    rowData.push(row)\r\n  }\r\n\r\n  const gridOptions = {\r\n    columnDefs: columnDefs,\r\n    rowData: rowData,\r\n    defaultColDef: {\r\n      headerClass: \"align-center\",\r\n      cellClass: \"align-center\"\r\n    },\r\n    rowClassRules: {\r\n      // apply green to 2008\r\n      \"rg2-active-runner\": (params) => {\r\n        return params.data.rawid === rawid\r\n      }\r\n    }\r\n  }\r\n\r\n  // can't get ag-grid examples to work in terms of height adjustment so this is\r\n  // the quick and dirty fix: 120 is content/padding/margin etc. for everything else in the dialog\r\n  const height = document.getElementById(\"rg2-map-canvas\").height * 0.98 - 120\r\n  const wrapper = document.getElementById(\"rg2-results-grid-wrapper\")\r\n  wrapper.removeAttribute(\"style\")\r\n  wrapper.setAttribute(\"style\", \"height: \" + height + \"px;\")\r\n  const table = document.getElementById(\"rg2-results-grid\")\r\n  table.innerHTML = \"\"\r\n  rg2Config.createGrid(table, gridOptions)\r\n}\r\n\r\nfunction generateSummary() {\r\n  const info = getLegPosInfo()\r\n  const packRow = (elem) => {\r\n    return `${elem}`\r\n  }\r\n\r\n  let html = packRow(`<div class=\"d-flex align-items-center justify-content-between pb-4\">`)\r\n  html += packRow(`<div class=\"d-flex align-items-center\">`)\r\n  html += packRow(`${nameButtons}`)\r\n  html += packRow(`<div class=\"fw-bold pe-4\">${result.name}</div>`)\r\n  html += packRow(`<div class=\"fw-bold pe-4\">${result.time}</div>`)\r\n  html += packRow(`<div class=\"fw-bold pe-4\">(${results[resultIndex].racepos[controls - 1]}/${results.length})</div>`)\r\n  let loss = \"\"\r\n  if (isNumberOverZero(result.timeInSecs)) {\r\n    loss = ` (${((100 * results[resultIndex].totalLoss[iterationIndex]) / result.timeInSecs).toFixed(1)}%)`\r\n  }\r\n  html += packRow(\r\n    `<div class=\"fw-bold pe-4\">${t(\"Estimated loss\")}: ${formatSecsAsMMSS(results[resultIndex].totalLoss[iterationIndex])}${loss}</div>`\r\n  )\r\n  html += packRow(`</div>`)\r\n  html += packRow(`<div class=\"d-flex align-items-center\">`)\r\n  const variant = isScoreOrRelay ? \"V\" + result.variant + \"&nbsp;\" : \"\"\r\n  html += packRow(`<div class=\"fw-bold pe-4\">${variant}${result.coursename}</div><div>${courseButtons}</div>`)\r\n  html += packRow(`</div></div>`)\r\n  // put title row at top of each tab\r\n  const titles = document.getElementsByClassName(\"rg2-stats-title-row\")\r\n  for (let title of titles) {\r\n    title.innerHTML = html\r\n  }\r\n\r\n  html = `<div class=\"d-flex align-items-center\">`\r\n  html += packRow(\r\n    `<div class=\"fw-bold pe-4\">${t(\"Average leg position\")}: ${info.average} (${t(\"Best\", \"\")}: ${info.best}, ${t(\"Worst\")}: ${\r\n      info.worst\r\n    })</div >`\r\n  )\r\n\r\n  // performanceIndex[0] is based on actual splits\r\n  html += packRow(\r\n    `<div  class=\"fw-bold pe-4\">${t(\"Performance\")} ${(result.performanceIndex[0] * 100).toFixed(1)}%</div>`\r\n  )\r\n  // discard all 0 entries which relate to missed controls\r\n  const ratios = results[resultIndex].refRatio[0].filter((ratio) => ratio > 0)\r\n  html += packRow(`<div  class=\"fw-bold\">${t(\"Consistency\")} ${(100 * getStandardDeviation(ratios)).toFixed(1)}%</div>`)\r\n  html += packRow(`</div>`)\r\n  document.getElementById(\"rg2-stats-summary\").innerHTML = html\r\n}\r\n\r\nfunction generateTableByLegPos() {\r\n  const rowData = []\r\n  for (let i = 0; i < results[resultIndex].splits.length; i += 1) {\r\n    let row = {}\r\n    row.name = result.name\r\n    if (i === 0) {\r\n      row.control = \"S\"\r\n    } else {\r\n      if (i == results[resultIndex].splits.length - 1) {\r\n        row.control = \"F\"\r\n      } else {\r\n        row.control = i + \" (\" + course.codes[i] + \")\"\r\n      }\r\n    }\r\n    if (i === 0) {\r\n      row.time = \"0:00\"\r\n    } else {\r\n      row.time = formatSecsAsMMSS(results[resultIndex].legSplits[i])\r\n    }\r\n    if (i === 0 || results[resultIndex].legpos[i] === 0 || course.exclude[i]) {\r\n      row.position = \"-\"\r\n    } else {\r\n      row.position = results[resultIndex].legpos[i]\r\n    }\r\n    if (i === 0 || course.exclude[i]) {\r\n      row.performance = \"-\"\r\n    } else {\r\n      row.performance = (100 * results[resultIndex].refRatio[0][i]).toFixed(1)\r\n    }\r\n    if (course.exclude[i]) {\r\n      row.best = \"-\"\r\n    } else {\r\n      row.best = formatSecsAsMMSS(byLegPos[i][0].t)\r\n    }\r\n    if (i === 0 || course.exclude[i]) {\r\n      row.who = \"-\"\r\n    } else {\r\n      let names = byLegPos[i][0].name\r\n      for (let j = 1; j < byLegPos[i].length; j += 1) {\r\n        if (byLegPos[i][0].t === byLegPos[i][j].t) {\r\n          names += \", \" + byLegPos[i][j].name\r\n        } else {\r\n          break\r\n        }\r\n      }\r\n      row.who = names\r\n    }\r\n    const behind = results[resultIndex].legSplits[i] - byLegPos[i][0].t\r\n    if (i === 0) {\r\n      row.behind = \"-\"\r\n    } else {\r\n      if (results[resultIndex].legSplits[i] <= 0) {\r\n        row.behind = \"-\"\r\n      } else {\r\n        row.behind = formatSecsAsMMSS(behind)\r\n      }\r\n    }\r\n    if (i === 0) {\r\n      row.percent = 0\r\n    } else {\r\n      if (results[resultIndex].legSplits[i] <= 0) {\r\n        row.percent = 0\r\n      } else {\r\n        row.percent = parseInt((behind * 100) / byLegPos[i][0].t, 10)\r\n      }\r\n    }\r\n    if (course.exclude[i]) {\r\n      row.predicted = \"-\"\r\n    } else {\r\n      row.predicted = formatSecsAsMMSS(results[resultIndex].predictedSplits[iterationIndex][i])\r\n    }\r\n    if (results[resultIndex].legSplits[i] <= 0) {\r\n      row.loss = \"\"\r\n    } else {\r\n      const loss = results[resultIndex].predictedSplits[iterationIndex][i] - results[resultIndex].legSplits[i]\r\n      row.loss = loss >= 0 ? formatSecsAsMMSS(loss) : \"-\" + formatSecsAsMMSS(loss * -1)\r\n    }\r\n    rowData.push(row)\r\n  }\r\n\r\n  const gridOptions = {\r\n    columnDefs: [\r\n      { headerName: t(\"Control\", \"\"), field: \"control\", width: 80 },\r\n      {\r\n        headerName: t(\"Time\", \"\"),\r\n        field: \"time\",\r\n        width: 80,\r\n        comparator: timeComparator.bind(this)\r\n      },\r\n      { headerName: t(\"Position\", \"\"), field: \"position\", width: 75 },\r\n      {\r\n        headerName: t(\"Performance\", \"\"),\r\n        field: \"performance\",\r\n        width: 95,\r\n        comparator: perfComparator.bind(this)\r\n      },\r\n      { headerName: t(\"Best\", \"\"), field: \"best\", width: 80 },\r\n      {\r\n        headerName: t(\"Who\", \"\"),\r\n        field: \"who\",\r\n        headerClass: \"align-left\",\r\n        cellClass: (params) => {\r\n          return params.data.who.indexOf(params.data.name) > -1 ? \"rg2-green-text align-left\" : \"align-left\"\r\n        },\r\n        flex: 1,\r\n        tooltipField: \"who\"\r\n      },\r\n      {\r\n        headerName: t(\"Behind\", \"\"),\r\n        field: \"behind\",\r\n        width: 80,\r\n        comparator: timeComparator.bind(this)\r\n      },\r\n      { headerName: \"%\", field: \"percent\", width: 60 },\r\n      {\r\n        headerName: t(\"Predicted\", \"\"),\r\n        field: \"predicted\",\r\n        width: 100,\r\n        comparator: timeComparator.bind(this)\r\n      },\r\n      {\r\n        headerName: t(\"+/-\", \"\"),\r\n        field: \"loss\",\r\n        width: 75,\r\n        cellClass: (params) => {\r\n          return params.data.loss.substring(0, 1) === \"-\" ? \"rg2-red-text align-center\" : \"align-center\"\r\n        },\r\n        comparator: timeComparator.bind(this)\r\n      }\r\n    ],\r\n    rowData: rowData,\r\n    domLayout: \"autoHeight\",\r\n    defaultColDef: {\r\n      headerClass: \"align-center\",\r\n      cellClass: \"align-center\",\r\n      sortable: true\r\n    }\r\n  }\r\n  const table = document.getElementById(\"rg2-leg-table\")\r\n  table.innerHTML = \"\"\r\n  rg2Config.createGrid(table, gridOptions)\r\n}\r\n\r\nfunction generateTableByRacePos() {\r\n  const rowData = []\r\n  let loss = 0\r\n  for (let i = 0; i < results[resultIndex].splits.length; i += 1) {\r\n    let row = {}\r\n    row.name = result.name\r\n    if (i == 0) {\r\n      row.control = \"S\"\r\n    } else {\r\n      if (i == results[resultIndex].splits.length - 1) {\r\n        row.control = \"F\"\r\n      } else {\r\n        row.control = i + \" (\" + course.codes[i] + \")\"\r\n      }\r\n    }\r\n    if (i == 0) {\r\n      row.time = \"0:00\"\r\n    } else {\r\n      if (results[resultIndex].splits[i] === results[resultIndex].splits[i - 1]) {\r\n        row.time = \"\"\r\n      } else {\r\n        row.time = formatSecsAsMMSS(results[resultIndex].splits[i])\r\n      }\r\n    }\r\n    if (i === 0 || results[resultIndex].racepos[i] === 0) {\r\n      row.position = \"-\"\r\n    } else {\r\n      row.position = results[resultIndex].racepos[i]\r\n    }\r\n    row.best = formatSecsAsMMSS(byRacePos[i][0].t)\r\n    if (i === 0) {\r\n      row.who = \"-\"\r\n    } else {\r\n      let names = byRacePos[i][0].name\r\n      for (let j = 1; j < byRacePos[i].length; j += 1) {\r\n        if (byRacePos[i][0].t === byRacePos[i][j].t) {\r\n          names += \", \" + byRacePos[i][j].name\r\n        } else {\r\n          break\r\n        }\r\n      }\r\n      row.who = names\r\n    }\r\n    const behind = results[resultIndex].splits[i] - byRacePos[i][0].t\r\n    if (i === 0 || results[resultIndex].racepos[i] === 0) {\r\n      row.behind = \"-\"\r\n    } else {\r\n      row.behind = formatSecsAsMMSS(behind)\r\n    }\r\n    if (i === 0 || results[resultIndex].racepos[i] === 0) {\r\n      row.percent = \"-\"\r\n    } else {\r\n      row.percent = parseInt((behind * 100) / byRacePos[i][0].t, 10)\r\n    }\r\n    loss = loss + results[resultIndex].loss[iterationIndex][i]\r\n    row.loss = formatSecsAsMMSS(loss)\r\n    rowData.push(row)\r\n  }\r\n\r\n  const gridOptions = {\r\n    columnDefs: [\r\n      { headerName: t(\"Control\", \"\"), field: \"control\", width: 88 },\r\n      { headerName: t(\"Time\", \"\"), field: \"time\", width: 85 },\r\n      { headerName: t(\"Position\", \"\"), field: \"position\", width: 100 },\r\n      { headerName: t(\"Best\", \"\"), field: \"best\", width: 85 },\r\n      {\r\n        headerName: t(\"Who\", \"\"),\r\n        field: \"who\",\r\n        headerClass: \"align-left\",\r\n        cellClass: (params) => {\r\n          return params.data.who.indexOf(params.data.name) > -1 ? \"rg2-green-text align-left\" : \"align-left\"\r\n        },\r\n        flex: 1,\r\n        tooltipField: \"who\"\r\n      },\r\n      { headerName: t(\"Behind\", \"\"), field: \"behind\", width: 85 },\r\n      { headerName: \"%\", field: \"percent\", width: 85 },\r\n      { headerName: \"Loss\", field: \"loss\", width: 100 }\r\n    ],\r\n    rowData: rowData,\r\n    domLayout: \"autoHeight\",\r\n    defaultColDef: {\r\n      headerClass: \"align-center\",\r\n      cellClass: \"align-center\"\r\n    }\r\n  }\r\n\r\n  const table = document.getElementById(\"rg2-race-table\")\r\n  table.innerHTML = \"\"\r\n  rg2Config.createGrid(table, gridOptions)\r\n}\r\n\r\nfunction getAverages(rawData, perCent) {\r\n  // avoid mutating source array\r\n  let data = rawData.slice()\r\n\r\n  if (data.length === 0) {\r\n    return { mean: 0, median: 0, count: 0 }\r\n  }\r\n  // sort incoming values\r\n  data.sort(function compare(a, b) {\r\n    return a - b\r\n  })\r\n  let total = 0\r\n  let count = data.length\r\n  // select top perCent items\r\n  if (perCent < 100) {\r\n    // arbitrary choice to keep at least three entries\r\n    const adjustedCount = Math.max(parseInt((count * perCent) / 100, 10), 3)\r\n    data.splice(adjustedCount)\r\n    count = data.length\r\n  }\r\n\r\n  for (let i = 0; i < count; i += 1) {\r\n    total = total + data[i]\r\n  }\r\n  let median\r\n  if (count === 1) {\r\n    median = data[0]\r\n  } else {\r\n    if (count % 2 === 0) {\r\n      median = (data[count / 2 - 1] + data[count / 2]) / 2\r\n    } else {\r\n      median = data[Math.floor(count / 2)]\r\n    }\r\n  }\r\n  return { mean: total / count, median: median, count: count }\r\n}\r\n\r\nfunction getLegPosInfo() {\r\n  let total = 0\r\n  let count = 0\r\n  let worst = 0\r\n  let best = 9999\r\n  for (let i = 1; i < result.legpos.length; i += 1) {\r\n    if (result.legpos[i] === 0) {\r\n      continue\r\n    }\r\n    total += result.legpos[i]\r\n    count += 1\r\n    if (best > result.legpos[i]) {\r\n      best = result.legpos[i]\r\n    }\r\n    if (worst < result.legpos[i]) {\r\n      worst = result.legpos[i]\r\n    }\r\n  }\r\n\r\n  // allow for people with no valid leg times\r\n  let average\r\n  if (count > 0) {\r\n    average = (total / count).toFixed(1)\r\n  } else {\r\n    average = 0\r\n    best = 0\r\n    worst = 0\r\n  }\r\n  return { best: best, worst: worst, average: average }\r\n}\r\n\r\nfunction getMean(data) {\r\n  return data.reduce((a, b) => a + b, 0) / data.length\r\n}\r\n\r\nfunction getPerfValue(p) {\r\n  if (p === \"-\") {\r\n    return 0\r\n  } else {\r\n    return parseFloat(p)\r\n  }\r\n}\r\n\r\nfunction getStandardDeviation(values) {\r\n  if (values.length === 0) {\r\n    return 0\r\n  }\r\n  const mean = getMean(values)\r\n  return Math.sqrt(values.reduce((sq, n) => sq + Math.pow(n - mean, 2), 0) / values.length)\r\n}\r\n\r\nexport function getStatsHeader() {\r\n  // generates HTML for a Bootstrap Tab layout\r\n  let html = `<ul class=\"nav nav-pills\" id=\"rg2-stats-panel-tab-headers\" role=\"tablist\">`\r\n  // add tab headers\r\n  for (let tab of tabs) {\r\n    const title = t(tab.title)\r\n    const active = tab.active ? \" active\" : \"\"\r\n    const index = tab.active ? \"\" : \"tabindex='-1'\"\r\n    html += `<li class=\"nav-item${active}\" role=\"presentation\">\r\n    <button class=\"nav-link\" data-bs-toggle=\"tab\" data-bs-target=\"#${tab.id}-tab\"\r\n      type=\"button\" role=\"tab\" ${index}>\r\n      <div id=\"${tab.id}-tab-label\">${title}</div>\r\n    </button>\r\n    </li>`\r\n  }\r\n  html += `</ul>`\r\n\r\n  return html\r\n}\r\n\r\nexport function getStatsLayout() {\r\n  // class rather than id since we use this on multiple tabs and all need to be kept in sync\r\n  const statsTitleRow = `<div class=\"rg2-stats-title-row container\"></div>`\r\n  // generates HTML for a Bootstrap Tab layout\r\n  let html = `<div id=\"rg2-stats-table\"><div class=\"tab-content\" id=\"rg2-stats-panel-tab-body\">`\r\n  for (let i = 0; i < tabs.length; i += 1) {\r\n    const active = tabs[i].active ? \" active\" : \"\"\r\n    html += `<div class=\"tab-pane fade ${active} pt-2\" id=\"${tabs[i].id}-tab\" role=\"tabpanel\" tabindex=\"${i}\">\r\n      ${statsTitleRow}${content[i]}</div>`\r\n  }\r\n  html += `</div></div></div>`\r\n\r\n  return html\r\n}\r\n\r\nfunction getTimeValue(t) {\r\n  // gets \"-\" or \"mm:ss\"\r\n  if (t === \"-\") {\r\n    return 0\r\n  } else {\r\n    return parseFloat(t.replace(\":\", \".\"))\r\n  }\r\n}\r\n\r\nfunction handleTabActivation(target) {\r\n  activeTab = target?.dataset?.bsTarget\r\n}\r\n\r\n// dynamic import of Grid and Chart utilities\r\nasync function importUtils() {\r\n  const { createGrid, ModuleRegistry } = await import(\"@ag-grid-community/core\")\r\n  rg2Config.createGrid = createGrid\r\n  const { ClientSideRowModelModule } = await import(\"@ag-grid-community/client-side-row-model\")\r\n  let chart = await import(\"chart.js/auto\")\r\n  Chart = chart.default\r\n  ModuleRegistry.registerModules([ClientSideRowModelModule])\r\n}\r\n\r\nfunction initialise(id) {\r\n  rawid = id\r\n  isScoreOrRelay = isScoreEvent()\r\n  const metresPerPixel = getMetresPerPixel()\r\n  if (metresPerPixel === undefined) {\r\n    speedUnits = \"\"\r\n    lengthUnits = \"px\"\r\n  } else {\r\n    speedUnits = \"min/km\"\r\n    lengthUnits = \"m\"\r\n  }\r\n  result = getFullResultForRawID(rawid)\r\n\r\n  if (isScoreOrRelay) {\r\n    variants = getVariantList()\r\n    results = getAllResultsForVariant(result.variant)\r\n  } else {\r\n    results = getAllResultsForCourse(result.courseid)\r\n  }\r\n  initialiseCourse(result.courseid)\r\n  adjustSplits()\r\n  generateLegPositions()\r\n  resultIndex = setResultIndex(rawid)\r\n}\r\n\r\nfunction initialiseCourse(id) {\r\n  if (isScoreOrRelay) {\r\n    course = new Course(\r\n      {\r\n        courseid: result.variant,\r\n        name: \"V\" + result.variant,\r\n        codes: result.scorecodes,\r\n        xpos: result.scorex,\r\n        ypos: result.scorey,\r\n        exclude: [],\r\n        allowed: [],\r\n        excludeType: 0\r\n      },\r\n      true\r\n    )\r\n  } else {\r\n    course = getCourseDetails(id)\r\n  }\r\n  // includes start and finish\r\n  controls = course.codes.length\r\n  if (controls <= 2) {\r\n    throw new rg2Exception(t(\"No splits available.\"))\r\n  }\r\n  byLegPos.length = 0\r\n  byRacePos.length = 0\r\n  let legTimes = []\r\n  let raceTimes = []\r\n  // for each leg\r\n  for (let i = 0; i < controls; i += 1) {\r\n    legTimes.length = 0\r\n    raceTimes.length = 0\r\n    // for each runner\r\n    for (let k = 0; k < results.length; k += 1) {\r\n      // create array of valid splits to this control\r\n      if (i === 0) {\r\n        // start control\r\n        legTimes.push({ t: 0, name: \"\", pos: 0 })\r\n        raceTimes.push({ t: 0, name: \"\", pos: 0 })\r\n      } else {\r\n        legTimes.push({\r\n          t: results[k].legSplits[i],\r\n          name: results[k].name,\r\n          pos: results[k].legpos[i]\r\n        })\r\n        // race position only valid if all controls to that point are valid\r\n        if (i <= results[k].lastValidSplit) {\r\n          raceTimes.push({\r\n            t: results[k].splits[i],\r\n            name: results[k].name,\r\n            pos: results[k].racepos[i]\r\n          })\r\n        }\r\n      }\r\n    }\r\n    legTimes.sort(function (a, b) {\r\n      // sort array of times in ascending order: 0 splits get sorted to the bottom\r\n      if (a.t === 0) {\r\n        return 1\r\n      } else {\r\n        if (b.t === 0) {\r\n          return -1\r\n        } else {\r\n          return a.t - b.t\r\n        }\r\n      }\r\n    })\r\n    raceTimes.sort(function (a, b) {\r\n      return a.t - b.t\r\n    })\r\n    byLegPos.push(legTimes.slice())\r\n    byRacePos.push(raceTimes.slice())\r\n  }\r\n}\r\n\r\nfunction isNumberOverZero(n) {\r\n  if (!isNaN(parseFloat(n)) && isFinite(n)) {\r\n    if (n > 0) {\r\n      return true\r\n    } else {\r\n      return false\r\n    }\r\n  }\r\n  return false\r\n}\r\n\r\nfunction iterateLostTime() {\r\n  for (let iter = 0; iter <= maxIterationIndex; iter += 1) {\r\n    calculateSplitsforIteration(iter)\r\n    calculatePerformanceForIteration(iter)\r\n    calculateLostTimeForIteration(iter)\r\n  }\r\n}\r\n\r\nfunction perfComparator(p1, p2) {\r\n  return getPerfValue(p1) - getPerfValue(p2)\r\n}\r\n\r\nfunction prepareStats(rawid) {\r\n  // all sorts of possible data consistency errors that might turn up\r\n  try {\r\n    initialise(rawid)\r\n    iterateLostTime()\r\n    generateSummary()\r\n    generateSplitsChart()\r\n    generateLegChart()\r\n    generateTableByLegPos()\r\n    generateTableByRacePos()\r\n    generateSplitsTable()\r\n    generateSpeedTable()\r\n    displayStats()\r\n    return true\r\n  } catch (err) {\r\n    if (err instanceof rg2Exception) {\r\n      // one we trapped ourselves\r\n      showWarningDialog(t(\"Statistics\"), err.message)\r\n    } else {\r\n      // general problem: probably an index out of bounds on an array somewhere: dodgy results files\r\n      showWarningDialog(t(\"Statistics\", \"\"), t(\"Data inconsistency.\", \"\"))\r\n    }\r\n    bootstrap.Offcanvas.getInstance(document.getElementById(\"rg2-right-info-panel\")).hide()\r\n  }\r\n  return false\r\n}\r\n\r\nfunction renderSplits(params) {\r\n  if (params.value.split === \"0:00\") {\r\n    return \"\"\r\n  }\r\n  let splitinfo = params.value.split\r\n  let classes = \"\"\r\n  if (params.value.pos !== 0) {\r\n    splitinfo += \" (\" + params.value.pos + \")\"\r\n    if (params.value.pos === 1) {\r\n      classes = \"rg2-first\"\r\n    }\r\n    if (params.value.pos === 2) {\r\n      classes = \"rg2-second\"\r\n    }\r\n    if (params.value.pos === 3) {\r\n      classes = \"rg2-third\"\r\n    }\r\n  }\r\n  if (params.value.loss) {\r\n    classes += \" rg2-lost-time\"\r\n  }\r\n  return '<span class=\"' + classes + '\">' + splitinfo + \"</span>\"\r\n}\r\n\r\nfunction rg2Exception(msg) {\r\n  this.message = msg\r\n}\r\n\r\nfunction setResultIndex(rawid) {\r\n  for (let i = 0; i < results.length; i += 1) {\r\n    if (results[i].rawid === rawid) {\r\n      // index for runner we are analysing\r\n      // reset result since we may have adjusted splits for excluded controls\r\n      result = results[i]\r\n      return i\r\n    }\r\n  }\r\n  return null\r\n}\r\n\r\nexport function showStats(rawid, displayStats) {\r\n  if (!eventHasResults()) {\r\n    showWarningDialog(t(\"Statistics\", \"\"), t(\"No statistics available for this event format.\", \"\"))\r\n    return false\r\n  }\r\n  activeTab = startTab\r\n  if (!rg2Config.createGrid) {\r\n    importUtils()\r\n      .then(() => {\r\n        if (prepareStats(rawid)) {\r\n          displayStats()\r\n        }\r\n      })\r\n      .catch(() => {\r\n        console.log(\"Error loading Grid and Chart\")\r\n        showWarningDialog(\"Error loading Grid and Chart\", \"Statistics functionality failed to load.\")\r\n      })\r\n  } else {\r\n    if (prepareStats(rawid)) {\r\n      displayStats()\r\n    }\r\n  }\r\n}\r\n\r\nfunction sortLegTimes(a, b) {\r\n  // sort array of times in ascending order\r\n  // 0 splits get sorted to the bottom\r\n  if (a.time === 0) {\r\n    return 1\r\n  } else {\r\n    if (b.time === 0) {\r\n      return -1\r\n    } else {\r\n      return a.time - b.time\r\n    }\r\n  }\r\n}\r\n\r\nfunction timeComparator(t1, t2) {\r\n  return getTimeValue(t1) - getTimeValue(t2)\r\n}\r\n","import { addRunner, animateRunners, removeRunner } from \"./animation\"\r\nimport * as bootstrap from \"bootstrap\"\r\nimport { redraw, resizeCanvas } from \"./canvas\"\r\nimport { config, options, saveConfigOptions, setConfigOption } from \"./config\"\r\nimport {\r\n  allCoursesDisplayed,\r\n  controls,\r\n  createCourseDropdown,\r\n  setCourseDisplay,\r\n  setAllCoursesDisplay,\r\n  setAllFilters,\r\n  setFilter,\r\n  getCoursesOnDisplay\r\n} from \"./courses\"\r\nimport {\r\n  adjustOffset,\r\n  autofitGPSTrack,\r\n  confirmDeleteRoute,\r\n  resetDrawing,\r\n  saveGPSRoute,\r\n  saveRoute,\r\n  showCourseInProgress,\r\n  undoGPSAdjust,\r\n  undoLastPoint,\r\n  readGPS,\r\n  waitThreeSeconds,\r\n  setNameAndTime\r\n} from \"./draw\"\r\nimport { eventHasResults, formatEvents, getEventStats, getKartatEventID, loadEventByKartatID } from \"./events\"\r\nimport { setHashCourses, setHashRoutes } from \"./hash\"\r\nimport {\r\n  allResultsForCourseReplayed,\r\n  allTracksDisplayed,\r\n  allTracksForCourseDisplayed,\r\n  allTracksForCourseReplayed,\r\n  createNameDropdown,\r\n  displayScoreCourse,\r\n  getAllRunnersForCourse,\r\n  getAllRunnersWithTrackForCourse,\r\n  getCourseForResult,\r\n  getTracksOnDisplay,\r\n  resetSpeedColours,\r\n  setTrackDisplayByCourse,\r\n  setTrackDisplayByResult\r\n} from \"./results\"\r\nimport { Runner } from \"./runner\"\r\nimport { getStatsHeader, getStatsLayout, showStats } from \"./stats\"\r\nimport { t, createLanguageDropdown } from \"./translate\"\r\n\r\nconst infoPanelControl = document.getElementById(\"rg2-show-info-panel-control\")\r\nconst rightInfoPanelEl = document.getElementById(\"rg2-right-info-panel\")\r\nconst rightInfoPanelTitle = document.getElementById(\"rg2-right-info-panel-title\")\r\n//const rightInfoPanelBody = document.getElementById(\"rg2-right-info-panel-body\")\r\nconst rightInfoPanel = new bootstrap.Offcanvas(rightInfoPanelEl, { backdrop: false })\r\n\r\nconst leftInfoPanelEl = document.getElementById(\"rg2-left-info-panel\")\r\nconst leftInfoPanelTitle = document.getElementById(\"rg2-left-info-panel-title\")\r\nlet leftInfoPanelBody = document.getElementById(\"rg2-left-info-panel-body\")\r\n\r\nconst leftInfoPanel = new bootstrap.Offcanvas(leftInfoPanelEl, { backdrop: false })\r\nleftInfoPanelEl.style.width = `420px`\r\nleftInfoPanelEl.addEventListener(\"hidden.bs.offcanvas\", () => {\r\n  // display close button when panel has finished closing\r\n  infoPanelControl.classList.remove(\"d-none\")\r\n})\r\nresizePanels()\r\n\r\nconst MAX_OFFSET = 10\r\nconst MIN_OFFSET = -10\r\n\r\nfunction animationPanelDisplayed() {\r\n  const animationPanel = document.getElementById(\"rg2-animation-controls\")\r\n  if (animationPanel.classList.contains(\"d-none\")) {\r\n    return false\r\n  }\r\n  return true\r\n}\r\n\r\nexport function configureDrawDialog() {\r\n  // sets up all non-changing aspects of draw dialog at start-up\r\n  // variable aspects set by resetDrawDialog when needed\r\n\r\n  document.querySelector(\"label[for=rg2-select-course]\").innerHTML = `${t(\"Select course\")}`\r\n  document.querySelector(\"label[for=rg2-select-name]\").innerHTML = `${t(\"Select name\")}`\r\n  // name and time entry for events with no results\r\n  document.querySelector(`label[for=rg2-name-entry]`).innerHTML = t(\"Name\")\r\n  document.querySelector(\"#rg2-name-entry\").addEventListener(\"input\", () => {\r\n    setNameAndTime()\r\n  })\r\n  document.querySelector(`label[for=rg2-time-entry]`).innerHTML = t(\"Time\")\r\n  document.querySelector(\"#rg2-time-entry\").addEventListener(\"input\", () => {\r\n    setNameAndTime()\r\n  })\r\n  const comments = document.getElementById(\"rg2-new-comments\")\r\n  comments.setAttribute(\"placeholder\", t(config.DEFAULT_NEW_COMMENT, \"\"))\r\n  comments.addEventListener(\"focus\", () => {\r\n    const comments = document.getElementById(\"rg2-new-comments\")\r\n    // Clear placeholder when user focuses on it\r\n    comments.setAttribute(\"placeholder\", \"\")\r\n  })\r\n\r\n  const secs = document.getElementById(\"btn-three-seconds\")\r\n  secs.innerHTML = t(\"+3 secs\")\r\n  secs.addEventListener(\"click\", (e) => {\r\n    e.preventDefault()\r\n    waitThreeSeconds()\r\n  })\r\n\r\n  const undo = document.getElementById(\"btn-undo\")\r\n  undo.innerHTML = t(\"Undo\")\r\n  undo.addEventListener(\"click\", (e) => {\r\n    e.preventDefault()\r\n    undoLastPoint()\r\n  })\r\n\r\n  const save = document.getElementById(\"btn-save-route\")\r\n  save.innerHTML = t(\"Save\")\r\n  save.addEventListener(\"click\", (e) => {\r\n    e.preventDefault()\r\n    saveRoute()\r\n  })\r\n\r\n  const reset = document.getElementById(\"btn-reset-drawing\")\r\n  reset.innerHTML = t(\"Reset\")\r\n  reset.addEventListener(\"click\", (e) => {\r\n    e.preventDefault()\r\n    resetDrawing()\r\n  })\r\n\r\n  document.getElementById(\"rg2-load-gps-title\").innerHTML = t(\"Load GPS file (GPX or TCX)\")\r\n\r\n  document.getElementById(\"btn-offset-plus\").addEventListener(\"click\", () => {\r\n    const input = document.getElementById(\"rg2-offset-value\")\r\n    let val = parseInt(input.value, 10)\r\n    if (val < MAX_OFFSET) {\r\n      val = val + 1\r\n      input.value = val\r\n      adjustOffset(val)\r\n    }\r\n  })\r\n\r\n  document.getElementById(\"btn-offset-minus\").addEventListener(\"click\", () => {\r\n    const input = document.getElementById(\"rg2-offset-value\")\r\n    let val = parseInt(input.value, 10)\r\n    if (val > MIN_OFFSET) {\r\n      val = val - 1\r\n      input.value = val\r\n      adjustOffset(val)\r\n    }\r\n  })\r\n\r\n  document.getElementById(\"rg2-offset-value\").addEventListener(\"input\", () => {\r\n    const input = document.getElementById(\"rg2-offset-value\")\r\n    let val = parseInt(input.value, 10)\r\n    if (isNaN(val)) {\r\n      val = 0\r\n    }\r\n    if (val < MIN_OFFSET) {\r\n      val = MIN_OFFSET\r\n    }\r\n    if (val > MAX_OFFSET) {\r\n      val = MAX_OFFSET\r\n    }\r\n    input.value = val\r\n    adjustOffset(val)\r\n  })\r\n\r\n  const adjust = document.getElementById(\"btn-undo-gps-adjust\")\r\n  adjust.innerHTML = t(\"Undo\")\r\n  adjust.addEventListener(\"click\", (e) => {\r\n    e.preventDefault()\r\n    undoGPSAdjust()\r\n  })\r\n\r\n  const autofit = document.getElementById(\"btn-autofit-gps\")\r\n  autofit.innerHTML = t(\"Autofit\")\r\n  autofit.addEventListener(\"click\", (e) => {\r\n    e.preventDefault()\r\n    autofitGPSTrack()\r\n  })\r\n\r\n  document.querySelector(`label[for=chk-move-all]`).innerHTML = t(\"Move track and map together (or right click-drag)\")\r\n\r\n  const saveGPS = document.getElementById(\"btn-save-gps-route\")\r\n  saveGPS.innerHTML = t(\"Save GPS route\")\r\n  saveGPS.addEventListener(\"click\", (e) => {\r\n    e.preventDefault()\r\n    saveGPSRoute()\r\n  })\r\n\r\n  const help = [\r\n    \"Left click to add/lock/unlock a handle\",\r\n    \"Green - draggable\",\r\n    \"Red - locked\",\r\n    \"Right click to delete a handle\",\r\n    \"Drag a handle to adjust track around locked point(s)\"\r\n  ]\r\n  help.forEach((text, i) => {\r\n    const el = document.getElementById(`draw-text-${i + 1}`)\r\n    el.innerHTML = `${t(text)}.`\r\n  })\r\n\r\n  const file = document.getElementById(\"rg2-load-gps-file\")\r\n  file.addEventListener(\"input\", (e) => {\r\n    readGPS(e)\r\n  })\r\n}\r\n\r\nfunction configureSettingsDialog() {\r\n  document.querySelector(`label[for=rg2-select-language]`).innerHTML = `${t(\"Language\")}`\r\n  createLanguageDropdown(config.languages)\r\n  configureSettingsCheckbox(\"chk-show-GPS-speed\", \"showGPSSpeed\", \"Show GPS speed colours\")\r\n  configureSettingsCheckbox(\"chk-snap-toggle\", \"snap\", \"Snap to control when drawing\")\r\n  configureSettingsCheckbox(\"chk-show-three-seconds\", \"showThreeSeconds\", \"Show +3 time loss for GPS routes\")\r\n  configureSettingsSlider(\"map-intensity\", \"perCentMapIntensity\", \"Map intensity\", \"%\")\r\n  configureSettingsSlider(\"route-intensity\", \"perCentRouteIntensity\", \"Route intensity\", \"%\")\r\n  configureSettingsSlider(\"control-circle\", \"circleSize\", \"Control circle size\")\r\n  configureSettingsSlider(\"course-width\", \"courseWidth\", \"Course overprint width\")\r\n  configureSettingsSlider(\"route-width\", \"routeWidth\", \"Route width\")\r\n  configureSettingsSlider(\"name-font-size\", \"replayFontSize\", \"Replay label font size\")\r\n\r\n  const slider = document.getElementById(\"rg2-gps-speed-slider\")\r\n  slider.setAttribute(\"value1\", options.maxSpeed)\r\n  slider.setAttribute(\"value2\", options.minSpeed)\r\n  slider.addEventListener(\"change\", gpsSpeedChanged)\r\n\r\n  document.getElementById(\"rg2-min-gps-speed-label\").innerHTML = getMinSpeedLabel()\r\n  document.getElementById(\"rg2-max-gps-speed-label\").innerHTML = getMaxSpeedLabel()\r\n}\r\n\r\nfunction configureSettingsCheckbox(selector, option, text) {\r\n  document.querySelector(`label[for=${selector}]`).innerHTML = `${t(text)}`\r\n  const el = document.getElementById(selector)\r\n  el.addEventListener(\"click\", (e) => {\r\n    options[option] = e.target.checked\r\n    saveConfigOptions()\r\n    redraw()\r\n  })\r\n  el.checked = options[option]\r\n}\r\n\r\nfunction configureSettingsSlider(selector, option, text, units = \"\") {\r\n  let label = document.querySelector(`label[for=spn-${selector}]`)\r\n  label.innerHTML = `${t(text)} ${options[option]}${units}`\r\n  let el = document.getElementById(`spn-${selector}`)\r\n  el.setAttribute(\"value\", options[option])\r\n  el.addEventListener(\"change\", (e) => {\r\n    setConfigOption(option, parseInt(e.target.value, 10))\r\n    label = document.querySelector(`label[for=spn-${selector}`)\r\n    label.innerHTML = `${t(text)} ${options[option]}${units}`\r\n    redraw()\r\n  })\r\n}\r\n\r\nexport function configureUI() {\r\n  // disable right click menu: may add our own later\r\n  document.body.addEventListener(\"contextmenu\", (e) => {\r\n    e.preventDefault()\r\n  })\r\n\r\n  window.addEventListener(\"resize\", () => {\r\n    resizePanels()\r\n    resizeCanvas()\r\n  })\r\n\r\n  document.getElementById(\"rg2-left-info-panel-body\").addEventListener(\"scroll\", (e) => {\r\n    // Save current scroll bar position in tab\r\n    document.getElementById(\"rg2-info-panel\").setAttribute(getScrollPosAttrName(), e.target.scrollTop)\r\n  })\r\n\r\n  initialiseInfoPanelDialog()\r\n  if (!config.managing()) {\r\n    configureDrawDialog()\r\n  }\r\n  displayInfoPanelDialog()\r\n\r\n  const logo = document.getElementById(\"rg2-logo\")\r\n  logo.addEventListener(\"click\", () => {\r\n    leftInfoPanel.toggle()\r\n  })\r\n\r\n  const tabsBody = document.querySelector(\"#rg2-info-panel-tab-headers\")\r\n  const tabs = tabsBody.querySelectorAll('button[data-bs-toggle=\"tab\"]')\r\n  tabs.forEach((tab) => {\r\n    tab.addEventListener(\"shown.bs.tab\", (e) => {\r\n      tabActivated(e)\r\n    })\r\n  })\r\n\r\n  infoPanelControl.addEventListener(\"click\", () => {\r\n    displayInfoPanelDialog()\r\n    infoPanelControl.classList.add(\"d-none\")\r\n  })\r\n\r\n  initialiseButtons()\r\n}\r\n\r\nexport function createEventMenu() {\r\n  if (config.managing()) {\r\n    return\r\n  }\r\n  let eventList = document.getElementById(\"rg2-event-list\")\r\n  eventList.innerHTML = formatEvents()\r\n  let eventTable = document.getElementById(\"rg2-event-table\")\r\n  let searchBox = document.getElementById(\"rg2-event-search\")\r\n  searchBox.innerHTML = `<form class=\"d-flex pb-2\" role=\"search\">\r\n  <input class=\"form-control mr-2\" type=\"search\" aria-label=\"${t(\"Search\")}\">\r\n  <i class=\"bi-search ms-2 mt-2\"></i>\r\n  </form>`\r\n  searchBox.addEventListener(\"keyup\", (e) => {\r\n    let filter = e.target.value.toUpperCase()\r\n    let rows = eventTable.getElementsByTagName(\"tr\")\r\n    for (let i = 0; i < rows.length; i += 1) {\r\n      if (rows[i].innerText.toUpperCase().indexOf(filter) > -1) {\r\n        rows[i].classList.remove(\"d-none\")\r\n      } else {\r\n        rows[i].classList.add(\"d-none\")\r\n      }\r\n    }\r\n  })\r\n  eventTable.addEventListener(\"click\", (e) => {\r\n    // get tr that contains element that was clicked\r\n    const row = e.target.closest(\"tr\")\r\n    const kartatid = parseInt(row.dataset.kartatid, 10)\r\n    if (!isNaN(kartatid)) {\r\n      loadEventByKartatID(kartatid)\r\n    }\r\n  })\r\n}\r\n\r\nfunction displayAboutDialog() {\r\n  rightInfoPanelEl.style.width = `800px`\r\n  rightInfoPanelTitle.innerHTML = \"RG2 Version \" + config.RG2VERSION\r\n  document.getElementById(\"rg2-about-dialog\").classList.remove(\"d-none\")\r\n  document.getElementById(\"rg2-option-controls\").classList.add(\"d-none\")\r\n  document.getElementById(\"rg2-stats-dialog\").classList.add(\"d-none\")\r\n  let eventStats = document.getElementById(\"rg2-event-stats\")\r\n  eventStats.innerHTML = getEventStats()\r\n  document.getElementById(\"rg2-manager-link\").innerHTML = `<a href=\"${rg2Config.api_url.replace(\r\n    \"rg2api.php\",\r\n    \"?manage\"\r\n  )}\">Manager Login</a>`\r\n  rightInfoPanel.show()\r\n}\r\n\r\nfunction displayInfoPanelDialog() {\r\n  leftInfoPanel.show()\r\n}\r\n\r\nfunction displaySettingsDialog() {\r\n  rightInfoPanelEl.style.width = `420px`\r\n  rightInfoPanelTitle.innerHTML = t(\"Configuration options\")\r\n  document.getElementById(\"rg2-about-dialog\").classList.add(\"d-none\")\r\n  document.getElementById(\"rg2-option-controls\").classList.remove(\"d-none\")\r\n  document.getElementById(\"rg2-stats-dialog\").classList.add(\"d-none\")\r\n  configureSettingsDialog()\r\n  rightInfoPanel.show()\r\n}\r\n\r\nexport function displayStatsDialog(resultid) {\r\n  rightInfoPanelEl.style.width = `1000px`\r\n  rightInfoPanelTitle.innerHTML = getStatsHeader()\r\n  document.getElementById(\"rg2-stats-dialog\").innerHTML = getStatsLayout()\r\n  document.getElementById(\"rg2-about-dialog\").classList.add(\"d-none\")\r\n  document.getElementById(\"rg2-option-controls\").classList.add(\"d-none\")\r\n  document.getElementById(\"rg2-stats-dialog\").classList.remove(\"d-none\")\r\n  showStats(resultid, function () {\r\n    rightInfoPanel.show()\r\n  })\r\n}\r\n\r\nexport function getActiveTab() {\r\n  return document.querySelector(\"#rg2-info-panel-tab-headers button.active\").id\r\n}\r\n\r\nfunction getInfoPanelBodyHTML(tabs) {\r\n  let html = `<div id=\"rg2-info-panel\">`\r\n  html += `<div class=\"tab-content\" id=\"rg2-info-panel-tab-body\">`\r\n  for (let i = 0; i < tabs.length; i = i + 1) {\r\n    const body = document.getElementById(tabs[i].body)\r\n    const active = tabs[i].active ? \" active show\" : \"\"\r\n    html += `<div class=\"tab-pane fade ${active}\" id=\"rg2-${tabs[i].name}-body\" role=\"tabpanel\" \r\n    aria-labelledby=\"${tabs[i].name}\" tabindex=\"${i}\">${body.innerHTML}</div>`\r\n    body.remove()\r\n  }\r\n  html += `</div></div>`\r\n  return html\r\n}\r\n\r\nfunction getInfoPanelHeaderHTML(tabs) {\r\n  let html = `<ul class=\"nav nav-pills\" id=\"rg2-info-panel-tab-headers\" role=\"tablist\">`\r\n  for (let i = 0; i < tabs.length; i = i + 1) {\r\n    const hidden = tabs[i].hidden ? \" d-none\" : \"\"\r\n    const active = tabs[i].active ? \" active\" : \"\"\r\n    const disabled = tabs[i].disabled ? \" disabled \" : \"\"\r\n    html += `\r\n    <li class=\"nav-item\" role=\"presentation\">\r\n      <button class=\"nav-link${active}${hidden}\"${disabled}id=\"${tabs[i].name}\" data-bs-toggle=\"tab\"\r\n      data-bs-target=\"#rg2-${tabs[i].name}-body\"\r\n        type=\"button\" role=\"tab\"><div id=\"${tabs[i].name}-label\">${t(tabs[i].title)}</div>\r\n      </button>\r\n    </li>`\r\n  }\r\n  html += `</ul>`\r\n  return html\r\n}\r\n\r\nfunction getMaxSpeedLabel() {\r\n  return `<i class=\"bi-emoji-smile rg2-run-green\"></i> ${options.maxSpeed.toFixed(1)} min/km`\r\n}\r\n\r\nfunction getMinSpeedLabel() {\r\n  return `<i class=\"bi-emoji-smile rg2-run-red\"></i> ${options.minSpeed.toFixed(1)} min/km`\r\n}\r\n\r\nfunction getScrollPosAttrName() {\r\n  return `scroll-${getActiveTab()}`\r\n}\r\n\r\nfunction gpsSpeedChanged(e) {\r\n  options.maxSpeed = e.detail.value1\r\n  options.minSpeed = e.detail.value2\r\n  const minSpeedLabel = document.getElementById(\"rg2-min-gps-speed-label\")\r\n  minSpeedLabel.innerHTML = getMinSpeedLabel()\r\n  const maxSpeedLabel = document.getElementById(\"rg2-max-gps-speed-label\")\r\n  maxSpeedLabel.innerHTML = getMaxSpeedLabel()\r\n  resetSpeedColours()\r\n  redraw()\r\n}\r\n\r\nfunction initialiseButtons() {\r\n  document.getElementById(\"btn-about\").addEventListener(\"click\", (e) => {\r\n    displayAboutDialog(e)\r\n  })\r\n  document.getElementById(\"btn-settings\").addEventListener(\"click\", (e) => {\r\n    displaySettingsDialog(e)\r\n  })\r\n  document.getElementById(\"btn-toggle-controls\").addEventListener(\"click\", () => {\r\n    controls.toggleControlDisplay()\r\n    redraw()\r\n  })\r\n  document.getElementById(\"btn-stats\").addEventListener(\"click\", () => {\r\n    // stats display: start with first runner in results list\r\n    displayStatsDialog(1)\r\n  })\r\n  document.getElementById(\"btn-splitsbrowser\").addEventListener(\"click\", () => {\r\n    // <timestamp> mimics jQuery cache busting strategy to force reload of event data: needed to get\r\n    // around events that are deleted and then recreated with same number\r\n    window.open(rg2Config.api_url + \"?type=splitsbrowser&id=\" + getKartatEventID() + \"&_=\" + Date.now())\r\n  })\r\n  document.getElementById(\"btn-measure\").setAttribute(\"disabled\", \"\")\r\n  document.getElementById(\"btn-runners\").setAttribute(\"disabled\", \"\")\r\n  document.getElementById(\"btn-toggle-controls\").setAttribute(\"disabled\", \"\")\r\n  document.getElementById(\"btn-stats\").setAttribute(\"disabled\", \"\")\r\n  document.getElementById(\"btn-splitsbrowser\").setAttribute(\"disabled\", \"\")\r\n}\r\n\r\nfunction initialiseInfoPanelDialog() {\r\n  const normalTabs = [\r\n    { name: config.TAB_EVENTS, title: \"Events\", body: \"rg2-event-body\", active: true },\r\n    { name: config.TAB_COURSES, title: \"Courses\", body: \"rg2-course-body\", disabled: true },\r\n    { name: config.TAB_RESULTS, title: \"Results\", body: \"rg2-result-body\", disabled: true },\r\n    { name: config.TAB_DRAW, title: \"Draw\", body: \"rg2-draw-body\", disabled: true }\r\n  ]\r\n\r\n  const managerTabs = [\r\n    { name: config.TAB_LOGIN, title: \"Login\", body: \"rg2-login-body\", active: true },\r\n    { name: config.TAB_CREATE, title: \"Add event\", body: \"rg2-add-event-body\", hidden: true },\r\n    { name: config.TAB_EDIT, title: \"Edit event\", body: \"rg2-edit-event-body\", hidden: true },\r\n    { name: config.TAB_MAP, title: \"Add map\", body: \"rg2-add-map-body\", hidden: true },\r\n    { name: config.TAB_DELETE_MAP, title: \"Delete maps\", body: \"rg2-delete-maps-body\", hidden: true }\r\n  ]\r\n\r\n  if (config.managing()) {\r\n    leftInfoPanelTitle.innerHTML = getInfoPanelHeaderHTML(managerTabs)\r\n    leftInfoPanelBody.innerHTML = getInfoPanelBodyHTML(managerTabs)\r\n  } else {\r\n    leftInfoPanelTitle.innerHTML = getInfoPanelHeaderHTML(normalTabs)\r\n    leftInfoPanelBody.innerHTML = getInfoPanelBodyHTML(normalTabs)\r\n  }\r\n}\r\n\r\nexport function resetDrawDialog() {\r\n  createCourseDropdown()\r\n  // name dialog initialised empty and disabled until course selected\r\n  createNameDropdown(undefined)\r\n  document.getElementById(\"rg2-select-name\").setAttribute(\"disabled\", \"\")\r\n  if (eventHasResults()) {\r\n    document.getElementById(\"rg2-name-select\").classList.remove(\"d-none\")\r\n    document.getElementById(\"rg2-enter-name-and-time\").classList.add(\"d-none\")\r\n  } else {\r\n    document.getElementById(\"rg2-name-select\").classList.add(\"d-none\")\r\n    document.getElementById(\"rg2-enter-name-and-time\").classList.remove(\"d-none\")\r\n  }\r\n\r\n  configureSettingsCheckbox(\"chk-align-map\", \"alignMap\", \"Align map to next control\")\r\n  document.getElementById(\"btn-three-seconds\").setAttribute(\"disabled\", \"\")\r\n  document.getElementById(\"btn-undo\").setAttribute(\"disabled\", \"\")\r\n  document.getElementById(\"btn-save-route\").setAttribute(\"disabled\", \"\")\r\n  document.getElementById(\"btn-reset-drawing\").setAttribute(\"disabled\", \"\")\r\n\r\n  document.getElementById(\"rg2-load-gps-file\").setAttribute(\"disabled\", \"\")\r\n  document.getElementById(\"btn-autofit-gps\").setAttribute(\"disabled\", \"\")\r\n  document.getElementById(\"btn-undo-gps-adjust\").setAttribute(\"disabled\", \"\")\r\n  document.getElementById(\"btn-save-gps-route\").setAttribute(\"disabled\", \"\")\r\n\r\n  document.getElementById(\"chk-move-all\").checked = false\r\n}\r\n\r\nexport function resizePanels() {\r\n  const headerHeight = document.getElementById(\"rg2-header-container\").offsetHeight\r\n  const footerHeight = animationPanelDisplayed() ? document.getElementById(\"rg2-animation-controls\").offsetHeight : 0\r\n  leftInfoPanelEl.style.top = `${headerHeight}px`\r\n  rightInfoPanelEl.style.top = `${headerHeight}px`\r\n  leftInfoPanelEl.style.bottom = `${footerHeight}px`\r\n  rightInfoPanelEl.style.bottom = `${footerHeight}px`\r\n  // maxWidth overrides width in CSS so we can set width elsewhere and this will always clamp to screen size\r\n  leftInfoPanelEl.style.maxWidth = `${window.innerWidth}px`\r\n  rightInfoPanelEl.style.maxWidth = `${window.innerWidth}px`\r\n  document.getElementById(\"rg2-track-names\").style.maxHeight = `${window.innerHeight - headerHeight - 10}px`\r\n}\r\n\r\nexport function setResultCheckboxes() {\r\n  // checkbox to show a course\r\n  const showCourse = document.querySelectorAll(\".showcourse\")\r\n  showCourse.forEach((show) => {\r\n    show.addEventListener(\"click\", (e) => {\r\n      const courseid = parseInt(e.target.dataset.courseid, 10)\r\n      setCourseDisplay(courseid, e.target.checked)\r\n      // align courses and results tab\r\n      const showCourse = document.querySelectorAll(\".showcourse\")\r\n      for (let elem of showCourse) {\r\n        if (parseInt(elem.dataset.courseid, 10) === courseid) {\r\n          elem.checked = e.target.checked\r\n        }\r\n      }\r\n      // align allcourses for this course\r\n      const showAllCourses = document.querySelector(\".showallcourses\")\r\n      showAllCourses.checked = allCoursesDisplayed()\r\n      setFilter(courseid)\r\n      setHashCourses(getCoursesOnDisplay())\r\n      redraw()\r\n    })\r\n  })\r\n\r\n  // checkbox to show all courses\r\n  const showAllCourses = document.querySelector(\".showallcourses\")\r\n  showAllCourses.addEventListener(\"click\", (e) => {\r\n    setAllCoursesDisplay(e.target.checked)\r\n    // align all the individual checkboxes for each course\r\n    const showCourse = document.querySelectorAll(\".showcourse\")\r\n    for (let elem of showCourse) {\r\n      elem.checked = e.target.checked\r\n    }\r\n    setAllFilters()\r\n    setHashCourses(getCoursesOnDisplay())\r\n    redraw()\r\n  })\r\n\r\n  // checkbox to show an individual score course\r\n  const showScoreCourse = document.querySelectorAll(\".showscorecourse\")\r\n  showScoreCourse.forEach((show) => {\r\n    show.addEventListener(\"click\", (e) => {\r\n      displayScoreCourse(parseInt(e.target.dataset.courseid, 10), e.target.checked)\r\n      redraw()\r\n    })\r\n  })\r\n\r\n  // checkbox to show a track\r\n  const showTrack = document.querySelectorAll(\".showtrack\")\r\n  showTrack.forEach((show) => {\r\n    show.addEventListener(\"click\", (e) => {\r\n      const id = parseInt(e.target.dataset.id, 10)\r\n      setTrackDisplayByResult(id, e.target.checked)\r\n      const courseid = parseInt(e.target.dataset.courseid, 10)\r\n      // align all routes for this course checkboxes\r\n      const allCourseTracks = document.querySelectorAll(\".allcoursetracks\")\r\n      allCourseTracks.forEach((course) => {\r\n        if (parseInt(course.dataset.courseid, 10) === courseid) {\r\n          course.checked = allTracksForCourseDisplayed(courseid)\r\n        }\r\n      })\r\n      // align all routes for all courses checkbox\r\n      const allTracks = document.querySelectorAll(\".alltracks\")\r\n      allTracks.forEach((track) => {\r\n        track.checked = allTracksDisplayed()\r\n      })\r\n      setFilter(courseid)\r\n      setHashRoutes(getTracksOnDisplay())\r\n      redraw()\r\n    })\r\n  })\r\n\r\n  // checkbox to delete a route\r\n  const deleteRoute = document.querySelectorAll(\".deleteroute\")\r\n  for (let route of deleteRoute) {\r\n    route.addEventListener(\"click\", (e) => {\r\n      confirmDeleteRoute(parseInt(e.target.dataset.resultidx, 10))\r\n    })\r\n  }\r\n\r\n  // checkbox to display all tracks for course\r\n  const allCourseTracks = document.querySelectorAll(\".allcoursetracks\")\r\n  for (let course of allCourseTracks) {\r\n    course.addEventListener(\"click\", (e) => {\r\n      let courseid = parseInt(e.target.dataset.courseid, 10)\r\n      setTrackDisplayByCourse(courseid, e.target.checked)\r\n      // align all tabs\r\n      const allCourseTracks = document.querySelectorAll(\".allcoursetracks\")\r\n      for (let elem of allCourseTracks) {\r\n        if (parseInt(elem.dataset.courseid, 10) === courseid) {\r\n          elem.checked = e.target.checked\r\n        }\r\n      }\r\n      // align individual result checkboxes\r\n      const showTrack = document.querySelectorAll(\".showtrack\")\r\n      for (let elem of showTrack) {\r\n        if (parseInt(elem.dataset.courseid, 10) === courseid) {\r\n          elem.checked = e.target.checked\r\n        }\r\n      }\r\n      // align all routes for all courses checkbox\r\n      const allTracks = document.querySelectorAll(\".alltracks\")\r\n      for (let elem of allTracks) {\r\n        elem.checked = allTracksDisplayed()\r\n      }\r\n      setFilter(courseid)\r\n      setHashRoutes(getTracksOnDisplay())\r\n      redraw()\r\n    })\r\n  }\r\n\r\n  // checkbox to show all tracks for all courses\r\n  const allTracks = document.querySelectorAll(\".alltracks\")\r\n  for (let elem of allTracks) {\r\n    elem.addEventListener(\"click\", (e) => {\r\n      setTrackDisplayByCourse(config.DISPLAY_ALL_COURSES, e.target.checked)\r\n      const allCourseTracks = document.querySelectorAll(\".allcoursetracks\")\r\n      for (let elem of allCourseTracks) {\r\n        elem.checked = e.target.checked\r\n      }\r\n      const showTrack = document.querySelectorAll(\".showtrack\")\r\n      for (let elem of showTrack) {\r\n        elem.checked = e.target.checked\r\n      }\r\n      setAllFilters(e.target.checked)\r\n      setHashRoutes(getTracksOnDisplay())\r\n      redraw()\r\n    })\r\n  }\r\n\r\n  // checkbox to animate a result\r\n  const showReplay = document.querySelectorAll(\".showreplay\")\r\n  for (let elem of showReplay) {\r\n    elem.addEventListener(\"click\", (e) => {\r\n      let resultid = parseInt(e.target.dataset.id, 10)\r\n      if (e.target.checked) {\r\n        addRunner(new Runner(resultid))\r\n      } else {\r\n        removeRunner(resultid)\r\n      }\r\n      const courseid = getCourseForResult(resultid)\r\n      const allCourseTracksReplay = document.querySelectorAll(\".allcoursetracksreplay\")\r\n      for (let elem of allCourseTracksReplay) {\r\n        if (parseInt(elem.dataset.courseid, 10) === courseid) {\r\n          elem.checked = allTracksForCourseReplayed(courseid)\r\n        }\r\n      }\r\n      const allCourseReplay = document.querySelectorAll(\".allcoursereplay\")\r\n      for (let elem of allCourseReplay) {\r\n        elem.checked = allResultsForCourseReplayed(courseid)\r\n      }\r\n      redraw()\r\n    })\r\n  }\r\n\r\n  const allCourseTracksReplay = document.querySelectorAll(\".allcoursetracksreplay\")\r\n  for (let elem of allCourseTracksReplay) {\r\n    elem.addEventListener(\"click\", (e) => {\r\n      let courseid = parseInt(e.target.dataset.courseid, 10)\r\n      const courseresults = getAllRunnersWithTrackForCourse(courseid)\r\n      animateRunners(courseresults, e.target.checked)\r\n      const replay = document.querySelectorAll(\".showreplay.showtrackreplay\")\r\n      for (let elem of replay) {\r\n        if (parseInt(elem.dataset.courseid, 10) === courseid) {\r\n          elem.checked = e.target.checked\r\n        }\r\n      }\r\n      const allCourseTracksReplay = document.querySelectorAll(\".allcoursetracksreplay\")\r\n      for (let elem of allCourseTracksReplay) {\r\n        if (parseInt(elem.dataset.courseid, 10) === courseid) {\r\n          elem.checked = e.target.checked\r\n        }\r\n      }\r\n      let allCourseReplay = document.querySelectorAll(\".allcoursereplay\")\r\n      for (let elem of allCourseReplay) {\r\n        if (parseInt(elem.dataset.courseid, 10) === courseid) {\r\n          elem.checked = allResultsForCourseReplayed(courseid)\r\n        }\r\n      }\r\n      redraw()\r\n    })\r\n  }\r\n\r\n  // checkbox to animate all results for course\r\n  // this one draws straight lines between controls for non-drawn routes\r\n  const allCourseReplay = document.querySelectorAll(\".allcoursereplay\")\r\n  for (let elem of allCourseReplay) {\r\n    elem.addEventListener(\"click\", (e) => {\r\n      const courseid = parseInt(e.target.dataset.courseid, 10)\r\n      const courseresults = getAllRunnersForCourse(courseid)\r\n      animateRunners(courseresults, e.target.checked)\r\n      const replay = document.querySelectorAll(\".showreplay\")\r\n      for (let elem of replay) {\r\n        if (parseInt(elem.dataset.courseid, 10) === courseid) {\r\n          elem.checked = e.target.checked\r\n        }\r\n      }\r\n      const allCourseTracksReplay = document.querySelectorAll(\".allcoursetracksreplay\")\r\n      for (let elem of allCourseTracksReplay) {\r\n        if (parseInt(elem.dataset.courseid, 10) === courseid) {\r\n          elem.checked = allTracksForCourseReplayed(courseid)\r\n        }\r\n      }\r\n      redraw()\r\n    })\r\n  }\r\n}\r\n\r\nfunction tabActivated(e) {\r\n  switch (e.target.id) {\r\n    case config.TAB_DRAW:\r\n      setAllCoursesDisplay(false)\r\n      showCourseInProgress()\r\n      break\r\n    default:\r\n      break\r\n  }\r\n\r\n  // Set scroll bar position in tab to how it was when user was last looking at it\r\n  const scrollPos = document.getElementById(\"rg2-info-panel\").getAttribute(getScrollPosAttrName())\r\n  document.getElementById(\"rg2-left-info-panel-body\").scrollTop = scrollPos\r\n  redraw()\r\n}\r\n","import { postApi } from \"./api\"\r\nimport { alignMap, ctx, getCentreBottom, getCentreTop, redraw, resetMapState } from \"./canvas\"\r\nimport { config, getOverprintDetails, options, removeDrawnRouteDetails, saveDrawnRouteDetails } from \"./config\"\r\nimport { getCourseDetails, setCourseDisplay } from \"./courses\"\r\nimport { doGetEvents, getKartatEventID, loadEventByKartatID } from \"./events\"\r\nimport { GPSTrack, RouteData } from \"./gpstrack\"\r\nimport { getActiveTab, resetDrawDialog } from \"./rg2ui\"\r\nimport {\r\n  createNameDropdown,\r\n  getDeletionInfo,\r\n  getFullResultforResultID,\r\n  setScoreCourseDisplay,\r\n  resultIDExists\r\n} from \"./results\"\r\nimport { t } from \"./translate\"\r\nimport {\r\n  createModalDialog,\r\n  formatSecsAsMMSS,\r\n  getAngle,\r\n  getDistanceBetweenPoints,\r\n  getSecsFromHHMMSS,\r\n  showWarningDialog\r\n} from \"./utils\"\r\n\r\nconst alignmentTimerInterval = 50\r\nconst alignmentLoopCount = 20\r\nlet alignmentTimer = null\r\nlet alignments = []\r\nlet mapIsAligned = false\r\n\r\nlet trackColour = \"#ff0000\"\r\nlet routeToDelete = null\r\nlet trk = new GPSTrack()\r\ntrk.routeData = new RouteData()\r\nlet pendingCourseID = null\r\n// the RouteData versions of these have the start control removed for saving\r\nlet controlx = []\r\nlet controly = []\r\nlet angles = []\r\nlet nextControl = 0\r\nlet previousValidControlIndex = 0\r\nlet isScoreCourse = false\r\n\r\nfunction addNewPoint(x, y) {\r\n  // ignore input if we are still aligning map\r\n  if (mapIsAligned) {\r\n    if (closeEnough(x, y)) {\r\n      addRouteDataPoint(controlx[nextControl], controly[nextControl])\r\n      // angles will be wrong for missing splits since we don't know angles between non-consecutive controls and I\r\n      // don't intend to start calculating them now...\r\n      alignMapToAngle(nextControl)\r\n      previousValidControlIndex = nextControl\r\n      nextControl = getNextValidControl(nextControl)\r\n      if (nextControl === controlx.length) {\r\n        document.getElementById(\"btn-save-route\").removeAttribute(\"disabled\")\r\n        // show full map now that we have drawn the complete route\r\n        resetMapState()\r\n      }\r\n    } else {\r\n      addRouteDataPoint(Math.round(x), Math.round(y))\r\n    }\r\n    document.getElementById(\"btn-undo\").removeAttribute(\"disabled\")\r\n    redraw()\r\n  }\r\n}\r\n\r\nfunction addRouteDataPoint(x, y) {\r\n  trk.routeData.x.push(x)\r\n  trk.routeData.y.push(y)\r\n}\r\n\r\nfunction adjustBetweenTwoLockedPoints(p1, p2, handle) {\r\n  // case 5: adjust between two locked points\r\n  // see, there is an easier way\r\n  //console.log(\"Point (\", p1.x, \", \", p1.y, \") for handle \", handle.index, handle.basex, handle.basey)\r\n  const previousHandle = trk.handles.getPreviousLockedHandle(handle)\r\n  const nextHandle = trk.handles.getNextLockedHandle(handle)\r\n  // adjust route between previous locked handle and dragged point\r\n  scaleRotateAroundSingleLockedPoint(p1, p2, previousHandle, previousHandle.time, handle.time)\r\n  // adjust route between dragged point and next locked handle\r\n  scaleRotateAroundSingleLockedPoint(p1, p2, nextHandle, handle.time, nextHandle.time)\r\n}\r\n\r\nexport function adjustOffset(offset) {\r\n  trk.adjustOffset(offset)\r\n}\r\n\r\nexport function adjustTrack(p1, p2, button = undefined) {\r\n  // called whilst dragging a GPS track\r\n  //console.log(\"adjustTrack \", p1.x, p1.y, p2.x, p2.y)\r\n  // check if background is locked or right click\r\n  const chk = document.getElementById(\"chk-move-all\")\r\n  const moveAll = chk.checked\r\n  if (moveAll || button === config.RIGHT_CLICK) {\r\n    ctx.translate(p2.x - p1.x, p2.y - p1.y)\r\n  } else {\r\n    if (trk.handles.handlesLocked() > 0) {\r\n      if (trk.handles.handlesLocked() === 1) {\r\n        scaleRotateAroundSingleLockedPoint(\r\n          p1,\r\n          p2,\r\n          trk.handles.getSingleLockedHandle(),\r\n          trk.handles.getStartHandle().time,\r\n          trk.handles.getFinishHandle().time\r\n        )\r\n      } else {\r\n        // check if start of drag is on a handle\r\n        let handle = trk.handles.getHandleClicked(p1)\r\n        // we already know we have at least two points locked: cases to deal with from here\r\n        // 1: drag point not on a handle: exit\r\n        // 2: drag point on a locked handle: exit\r\n        // 3: drag point between start and a locked handle: scale and rotate around single point\r\n        // 4: drag point between locked handle and end: scale and rotate around single handle\r\n        // 5: drag point between two locked handles: shear around two fixed handles\r\n        //case 1\r\n        if (handle === undefined) {\r\n          return\r\n        }\r\n        // case 2\r\n        if (handle.locked) {\r\n          return\r\n        }\r\n        const earliest = trk.handles.getEarliestLockedHandle()\r\n        const latest = trk.handles.getLatestLockedHandle()\r\n\r\n        if (earliest.time >= handle.time) {\r\n          // case 3: drag point between start and a locked handle\r\n          scaleRotateAroundSingleLockedPoint(p1, p2, earliest, trk.handles.getStartHandle().time, earliest.time)\r\n        } else if (latest.time < handle.time) {\r\n          // case 4: drag point between locked handle and end\r\n          scaleRotateAroundSingleLockedPoint(p1, p2, latest, latest.time, trk.handles.getFinishHandle().time)\r\n        } else {\r\n          // case 5: adjust between two locked points\r\n          adjustBetweenTwoLockedPoints(p1, p2, handle)\r\n        }\r\n      }\r\n    } else {\r\n      // nothing locked so drag track\r\n      dragTrack(p2.x - p1.x, p2.y - p1.y)\r\n    }\r\n  }\r\n}\r\n\r\nfunction alignMapToAngle(control) {\r\n  if (options.alignMap && control < controlx.length - 1) {\r\n    mapIsAligned = false\r\n    alignments = []\r\n    const x = controlx[control]\r\n    const y = controly[control]\r\n    const x2 = controlx[control + 1]\r\n    const y2 = controly[control + 1]\r\n    // Set up array of transformations to move control to centre bottom of screen and rotate map\r\n    // so next control is straight up and near top of screen.\r\n    const from = getCentreBottom()\r\n    const to = getCentreTop()\r\n    const mapDistance = getDistanceBetweenPoints(x, y, x2, y2)\r\n    const screenDistance = getDistanceBetweenPoints(from.x, from.y, to.x, to.y)\r\n    let scale = Math.min(screenDistance / mapDistance, config.MAX_ZOOM)\r\n    scale = Math.max(scale, config.MIN_ZOOM)\r\n    let controlAngle\r\n    if (isScoreCourse) {\r\n      // need to calculate this here since score courses use variants for\r\n      // each person, not single courses\r\n      controlAngle = getAngle(controlx[control], controly[control], controlx[control + 1], controly[control + 1])\r\n    } else {\r\n      controlAngle = angles[control]\r\n    }\r\n    let angle = (ctx.displayAngle - controlAngle - Math.PI / 2) % (Math.PI * 2)\r\n    if (angle < -1 * Math.PI) {\r\n      angle = angle + 2 * Math.PI\r\n    }\r\n    for (let i = 1; i <= alignmentLoopCount; i = i + 1) {\r\n      let values = {}\r\n\r\n      // translations to move current control to centre bottom\r\n      values.x = from.x - ((from.x - x) * i) / alignmentLoopCount\r\n      values.y = from.y - ((from.y - y) * i) / alignmentLoopCount\r\n\r\n      // Rotation to get from current display angle to angle with next control straight up.\r\n      // Course angles are based on horizontal as 0: need to reset to north.\r\n      // Angle parameter is absolute angle to draw map.\r\n      values.angle = (ctx.displayAngle - (angle * i) / alignmentLoopCount) % (Math.PI * 2)\r\n\r\n      // scale to stretch map: value is a multiplier so use xth root each time and apply it x times\r\n      values.scale = Math.pow(scale, 1 / alignmentLoopCount)\r\n\r\n      alignments.push(values)\r\n    }\r\n    alignmentTimer = setInterval(() => {\r\n      incrementAlignmentTime()\r\n    }, alignmentTimerInterval)\r\n  } else {\r\n    alignMap(0, controlx[control], controly[control], false, 1)\r\n    mapIsAligned = true\r\n    alignmentTimer = null\r\n  }\r\n}\r\n\r\nexport function autofitGPSTrack() {\r\n  trk.autofitTrack()\r\n}\r\n\r\nfunction closeEnough(x, y) {\r\n  // snapto: test if drawn route is close enough to control\r\n  let range = options.snap ? 8 : 2\r\n  console.log(x, y, controlx[nextControl], controly[nextControl])\r\n  if (Math.abs(x - controlx[nextControl]) < range) {\r\n    if (Math.abs(y - controly[nextControl]) < range) {\r\n      return true\r\n    }\r\n  }\r\n  return false\r\n}\r\n\r\nfunction confirmCourseChange() {\r\n  let dlg = {}\r\n  dlg.body = \"The route you have started to draw will be discarded. Are you sure you want to change the course?\"\r\n  dlg.title = \"Confirm course change\"\r\n  dlg.doText = \"Change course\"\r\n  dlg.onDo = doChangeCourse\r\n  dlg.onCancel = doCancelChangeCourse\r\n  createModalDialog(dlg)\r\n}\r\n\r\nexport function confirmDeleteRoute(id) {\r\n  routeToDelete = id\r\n  let dlg = {}\r\n  dlg.body = \"This route will be permanently deleted. Are you sure?\"\r\n  dlg.title = \"Confirm route delete\"\r\n  dlg.doText = \"Delete route\"\r\n  dlg.onDo = doDeleteRoute\r\n  createModalDialog(dlg)\r\n}\r\n\r\nfunction doCancelChangeCourse() {\r\n  document.getElementById(\"rg2-select-course\").value = trk.routeData.courseid\r\n  document.getElementById(\"rg2-select-name\").value = trk.routeData.resultid\r\n  pendingCourseID = null\r\n}\r\n\r\nfunction doChangeCourse() {\r\n  doDrawingReset()\r\n  initialiseCourse(pendingCourseID)\r\n}\r\n\r\nfunction doDeleteRoute() {\r\n  const info = getDeletionInfo(routeToDelete)\r\n  const params = { type: \"deletemyroute\", id: getKartatEventID(), routeid: info.id }\r\n  postApi(JSON.stringify({ token: info.token }), params, handleRouteDeleted, \"Route save failed\")\r\n}\r\n\r\nfunction doDrawingReset() {\r\n  // remove any displayed courses before resetting drawing\r\n  if (trk.routeData.courseid !== null) {\r\n    setCourseDisplay(trk.routeData.courseid, false)\r\n  }\r\n  if (trk.routeData.resultid !== null) {\r\n    setScoreCourseDisplay(trk.routeData.resultid, false)\r\n  }\r\n  initialiseDrawing()\r\n}\r\n\r\nfunction doSaveRoute() {\r\n  setDeltas()\r\n  const params = { type: \"addroute\", id: trk.routeData.eventid }\r\n  postApi(JSON.stringify(trk.routeData), params, handleRouteSaved(trk.routeData.name), \"Route save failed\")\r\n  // reset route here to avoid annoying flash of redrawn route\r\n  doDrawingReset()\r\n}\r\n\r\nexport function dragEnded() {\r\n  if (trk.fileLoaded) {\r\n    // rebaseline GPS track\r\n    trk.savedBaseX = trk.baseX.slice(0)\r\n    trk.savedBaseY = trk.baseY.slice(0)\r\n    trk.baseX = trk.routeData.x.slice(0)\r\n    trk.baseY = trk.routeData.y.slice(0)\r\n    trk.handles.saveForUndo()\r\n    trk.handles.rebaselineXY()\r\n    document.getElementById(\"btn-undo-gps-adjust\").removeAttribute(\"disabled\")\r\n  }\r\n}\r\n\r\nexport function dragTrack(dx, dy) {\r\n  for (let i = 0; i < trk.baseX.length; i += 1) {\r\n    trk.routeData.x[i] = trk.baseX[i] + dx\r\n    trk.routeData.y[i] = trk.baseY[i] + dy\r\n  }\r\n  trk.handles.dragHandles(dx, dy)\r\n}\r\n\r\nexport function drawCircle(radius) {\r\n  ctx.arc(controlx[nextControl], controly[nextControl], radius, 0, 2 * Math.PI, false)\r\n  // fill in with transparent colour to highlight control better\r\n  ctx.fill()\r\n}\r\n\r\nexport function drawNewTrack() {\r\n  const opt = getOverprintDetails()\r\n  ctx.lineWidth = opt.overprintWidth\r\n  ctx.strokeStyle = config.RED\r\n  ctx.fillStyle = config.RED_30\r\n  // highlight next control if we have a course selected\r\n  if (nextControl > 0 && !trk.fileLoaded) {\r\n    ctx.beginPath()\r\n    if (nextControl < controlx.length - 1) {\r\n      // normal control\r\n      drawCircle(opt.controlRadius)\r\n    } else {\r\n      // finish\r\n      drawCircle(opt.finishInnerRadius)\r\n      ctx.stroke()\r\n      ctx.beginPath()\r\n      drawCircle(opt.finishOuterRadius)\r\n    }\r\n    // dot at centre of control circle\r\n    ctx.fillRect(controlx[nextControl] - 1, controly[nextControl] - 1, 3, 3)\r\n    ctx.stroke()\r\n  }\r\n  ctx.strokeStyle = trackColour\r\n  ctx.fillStyle = trackColour\r\n  ctx.font = \"10pt Arial\"\r\n  ctx.textAlign = \"left\"\r\n  ctx.globalAlpha = 0.6\r\n  drawRoute()\r\n  trk.handles.drawHandles()\r\n}\r\n\r\nfunction drawRoute() {\r\n  if (trk.routeData.x.length > 1) {\r\n    ctx.beginPath()\r\n    ctx.moveTo(trk.routeData.x[0], trk.routeData.y[0])\r\n    // don't bother with +3 second displays in GPS adjustment\r\n    for (let i = 1; i < trk.routeData.x.length; i += 1) {\r\n      ctx.lineTo(trk.routeData.x[i], trk.routeData.y[i])\r\n    }\r\n    ctx.stroke()\r\n  }\r\n}\r\n\r\nexport function getControlXY() {\r\n  return { x: controlx, y: controly }\r\n}\r\n\r\nfunction getNextValidControl(thisControl) {\r\n  // look through splits to find next control which has a split time\r\n  // to allow drawing for missed controls where the split time is 0\r\n  const splits = trk.routeData.splits\r\n  // allow for events with no results: splits will be a start and finish time only\r\n  // in this case just move to next control\r\n  if (splits.length === 2) {\r\n    return thisControl + 1\r\n  }\r\n  for (let i = thisControl + 1; i < splits.length; i += 1) {\r\n    if (splits[i] !== splits[i - 1]) {\r\n      return i\r\n    }\r\n  }\r\n  // implies we have no finish time which is unlikely but anyway...\r\n  return splits.length\r\n}\r\n\r\nfunction getPreviousValidControl(thisControl) {\r\n  // look through splits to find previous control which has a split time\r\n  // to allow drawing for missed controls where the split time is 0\r\n  const splits = trk.routeData.splits\r\n  // allow for events with no results: splits will be a start and finish time only\r\n  // in this case just move to previous control\r\n  if (splits.length === 2) {\r\n    return thisControl - 1\r\n  }\r\n  for (let i = thisControl - 1; i > 0; i -= 1) {\r\n    if (splits[i] !== splits[i - 1]) {\r\n      return i\r\n    }\r\n  }\r\n  // go back to start...\r\n  return 0\r\n}\r\n\r\nexport function gpsFileLoaded() {\r\n  return trk.fileLoaded\r\n}\r\n\r\nfunction handleRouteDeleted(response) {\r\n  if (response.ok) {\r\n    showWarningDialog(t(\"Route deleted\"), t(\"Route has been deleted\"))\r\n    removeDrawnRouteDetails({\r\n      eventid: parseInt(response.eventid, 10),\r\n      id: parseInt(response.routeid, 10)\r\n    })\r\n    doGetEvents()\r\n  } else {\r\n    showWarningDialog(t(\"Delete failed\"), t(\"Delete failed\"))\r\n  }\r\n}\r\n\r\nconst handleRouteSaved = (name) => (response) => {\r\n  if (response.ok) {\r\n    routeSaved(response, name)\r\n  } else {\r\n    showWarningDialog(name, t(\"Your route was not saved. Please try again\"))\r\n  }\r\n}\r\n\r\nfunction incrementAlignmentTime() {\r\n  if (alignments.length === 0) {\r\n    clearInterval(alignmentTimer)\r\n    alignmentTimer = null\r\n    mapIsAligned = true\r\n  } else {\r\n    const data = alignments.shift()\r\n    alignMap(data.angle, data.x, data.y, true, data.scale)\r\n  }\r\n  redraw()\r\n}\r\n\r\nfunction initialiseCourse(courseid) {\r\n  pendingCourseID = null\r\n  trk.routeData = new RouteData()\r\n  trk.routeData.eventid = getKartatEventID()\r\n  trk.routeData.courseid = courseid\r\n  const course = getCourseDetails(courseid)\r\n  isScoreCourse = course.isScoreCourse\r\n  // save details for normal courses\r\n  // can't do this here for score courses since you need to know the\r\n  // variant for a given runner\r\n  if (!isScoreCourse) {\r\n    setCourseDisplay(courseid, true)\r\n    trk.routeData.coursename = course.name\r\n    if (course.excludeType === config.EXCLUDED_ZERO_SPLITS) {\r\n      trk.routeData.controlsToAdjust = course.exclude.indexOf(true)\r\n    } else {\r\n      trk.routeData.controlsToAdjust = course.x.length - 1\r\n    }\r\n    controlx = course.x.slice()\r\n    controly = course.y.slice()\r\n    trk.routeData.x.length = 0\r\n    trk.routeData.y.length = 0\r\n    trk.routeData.x[0] = controlx[0]\r\n    trk.routeData.y[0] = controly[0]\r\n    trk.routeData.controlx = controlx.slice()\r\n    trk.routeData.controly = controly.slice()\r\n    trk.routeData.cumulativeLegLengths = course.cumulativeLegLengths.slice()\r\n    angles = course.angle.slice()\r\n  }\r\n  document.getElementById(\"rg2-select-course\").value = trk.routeData.courseid\r\n  createNameDropdown(courseid)\r\n  redraw()\r\n}\r\n\r\nexport function initialiseDrawing() {\r\n  // called when we know we have an event loaded\r\n  trk = new GPSTrack()\r\n  trk.routeData = new RouteData()\r\n  // the RouteData versions of these have the start control removed for saving\r\n  controlx.length = 0\r\n  controly.length = 0\r\n  angles.length = 0\r\n  nextControl = 0\r\n  previousValidControlIndex = 0\r\n  isScoreCourse = false\r\n  trk.initialiseGPS()\r\n  resetDrawDialog()\r\n  redraw()\r\n}\r\n\r\nexport function mouseUp(x, y, button) {\r\n  // console.log(x, y)\r\n  // called after a click at (x, y)\r\n  const delta = 3\r\n  if (getActiveTab() !== config.TAB_DRAW) {\r\n    return\r\n  }\r\n  if (trk.fileLoaded) {\r\n    const handle = trk.handles.getHandleClicked({ x: x, y: y })\r\n    if (handle !== undefined) {\r\n      // delete or unlock if not first or last entry\r\n      if (button === config.RIGHT_CLICK && handle.index !== 0 && handle.index !== trk.handles.length) {\r\n        if (handle.locked) {\r\n          // unlock, don't delete\r\n          trk.handles.unlockHandle(handle.index)\r\n        } else {\r\n          // delete handle\r\n          trk.handles.deleteHandle(handle.index)\r\n        }\r\n      } else {\r\n        // clicked in a handle area so toggle state\r\n        if (handle.locked) {\r\n          trk.handles.unlockHandle(handle.index)\r\n        } else {\r\n          trk.handles.lockHandle(handle.index)\r\n        }\r\n      }\r\n    } else {\r\n      // not an existing handle so read through track to look for x,y\r\n      for (let i = 0; i < trk.baseX.length; i += 1) {\r\n        if (\r\n          trk.baseX[i] + delta >= x &&\r\n          trk.baseX[i] - delta <= x &&\r\n          trk.baseY[i] + delta >= y &&\r\n          trk.baseY[i] - delta <= y\r\n        ) {\r\n          // found on track so add new handle\r\n          trk.handles.addHandle(x, y, i)\r\n          break\r\n        }\r\n      }\r\n    }\r\n  } else {\r\n    // drawing new track\r\n    // only allow drawing if we have valid name and course\r\n    if (trk.routeData.resultid !== null && trk.routeData.courseid !== null) {\r\n      addNewPoint(x, y)\r\n    } else {\r\n      showWarningDialog(\r\n        \"No course/name\",\r\n        \"Please select course, name and time before you start drawing a route or upload a file.\"\r\n      )\r\n    }\r\n  }\r\n}\r\n\r\nexport function readGPS(file) {\r\n  // show full map aligned to north\r\n  resetMapState()\r\n  trk.readGPS(file)\r\n}\r\n\r\nexport function resetDrawing() {\r\n  let dlg = {}\r\n  dlg.body = \"All information you have entered will be removed. Are you sure you want to reset?\"\r\n  dlg.title = \"Confirm reset\"\r\n  dlg.doText = \"Reset\"\r\n  dlg.onDo = doDrawingReset\r\n  createModalDialog(dlg)\r\n}\r\n\r\nfunction rotatePoint(x, y, angle) {\r\n  // rotation matrix: see http://en.wikipedia.org/wiki/Rotation_matrix\r\n  let pt = {}\r\n  pt.x = Math.cos(angle) * x - Math.sin(angle) * y\r\n  pt.y = Math.sin(angle) * x + Math.cos(angle) * y\r\n  return pt\r\n}\r\n\r\nfunction routeSaved(data, name) {\r\n  showWarningDialog(name, t(\"Your route has been saved\"))\r\n  saveDrawnRouteDetails({\r\n    eventid: parseInt(data.eventid, 10),\r\n    id: data.newid,\r\n    token: data.token\r\n  })\r\n  loadEventByKartatID(getKartatEventID())\r\n}\r\n\r\nexport function saveGPSRoute() {\r\n  // called to save GPS file route\r\n  // tidy up route details\r\n  const t = trk.routeData.time[trk.routeData.time.length - 1] - trk.routeData.time[0]\r\n  trk.routeData.totaltime = formatSecsAsMMSS(t)\r\n  // GPS uses UTC: adjust to local time based on local user setting\r\n  // only affects replay in real time\r\n  let date = new Date()\r\n  // returns offset in minutes, so convert to seconds\r\n  const offset = date.getTimezoneOffset() * 60\r\n  trk.routeData.startsecs = trk.routeData.time[0] - offset\r\n\r\n  for (let i = 0; i < trk.routeData.x.length; i += 1) {\r\n    trk.routeData.x[i] = Math.round(trk.routeData.x[i])\r\n    trk.routeData.y[i] = Math.round(trk.routeData.y[i])\r\n    // convert real time seconds to offset seconds from start time\r\n    trk.routeData.time[i] -= trk.routeData.startsecs\r\n  }\r\n  // allow for already having a GPS route for this runner\r\n  trk.routeData.resultid += config.GPS_RESULT_OFFSET\r\n  while (resultIDExists(trk.routeData.resultid)) {\r\n    trk.routeData.resultid += config.GPS_RESULT_OFFSET\r\n    // add marker(s) to name to show it is a duplicate\r\n    trk.routeData.name += \"*\"\r\n  }\r\n  trk.routeData.comments = document.getElementById(\"rg2-new-comments\").value\r\n  document.getElementById(\"btn-undo-gps-adjust\").setAttribute(\"disabled\", \"\")\r\n  doSaveRoute()\r\n}\r\n\r\nexport function saveRoute() {\r\n  // called to save manually entered route\r\n  trk.routeData.comments = document.getElementById(\"rg2-new-comments\").value\r\n  trk.routeData.controlx = controlx\r\n  trk.routeData.controly = controly\r\n  // don't need start control so remove it\r\n  trk.routeData.controlx.splice(0, 1)\r\n  trk.routeData.controly.splice(0, 1)\r\n  doSaveRoute()\r\n}\r\n\r\nfunction scaleRotateAroundSingleLockedPoint(p1, p2, p3, fromTime, toTime) {\r\n  // rotate p1 to p2 around p3\r\n  // scale and rotate track around single locked point\r\n  const scale = getDistanceBetweenPoints(p2.x, p2.y, p3.x, p3.y) / getDistanceBetweenPoints(p1.x, p1.y, p3.x, p3.y)\r\n  const angle = getAngle(p2.x, p2.y, p3.x, p3.y) - getAngle(p1.x, p1.y, p3.x, p3.y)\r\n  //console.log (p1.x, p1.y, p2.x, p2.y, p3.x, p3.y, scale, angle, fromTime, toTime)\r\n  for (let i = fromTime; i <= toTime; i += 1) {\r\n    const pt = rotatePoint(trk.baseX[i] - p3.x, trk.baseY[i] - p3.y, angle)\r\n    trk.routeData.x[i] = pt.x * scale + p3.x\r\n    trk.routeData.y[i] = pt.y * scale + p3.y\r\n  }\r\n  trk.handles.alignHandles(trk.routeData)\r\n}\r\n\r\nfunction setDeltas() {\r\n  // send as differences rather than absolute values: provides almost 50% reduction in size of json file\r\n  for (let i = trk.routeData.x.length - 1; i > 0; i -= 1) {\r\n    trk.routeData.x[i] = trk.routeData.x[i] - trk.routeData.x[i - 1]\r\n    trk.routeData.y[i] = trk.routeData.y[i] - trk.routeData.y[i - 1]\r\n  }\r\n  // in theory time is same length as x and y but why take the risk...\r\n  for (let i = trk.routeData.time.length - 1; i > 0; i -= 1) {\r\n    trk.routeData.time[i] = trk.routeData.time[i] - trk.routeData.time[i - 1]\r\n  }\r\n}\r\n\r\nexport function setDrawingCourse(courseid) {\r\n  if (!isNaN(courseid)) {\r\n    if (trk.routeData.courseid !== null) {\r\n      // already have a course so we are trying to change it\r\n      if (trk.routeData.x.length > 1) {\r\n        // drawing started so ask to confirm change\r\n        pendingCourseID = courseid\r\n        confirmCourseChange()\r\n      } else {\r\n        // nothing done yet so just change course\r\n        if (trk.routeData.resultid !== null) {\r\n          setScoreCourseDisplay(trk.routeData.resultid, false)\r\n        }\r\n        setCourseDisplay(trk.routeData.courseid, false)\r\n        initialiseCourse(courseid)\r\n      }\r\n    } else {\r\n      // first time course has been selected\r\n      initialiseCourse(courseid)\r\n    }\r\n  }\r\n}\r\n\r\nexport function setName(resultid) {\r\n  // callback from select box when we have results\r\n  if (!isNaN(resultid)) {\r\n    const res = getFullResultforResultID(resultid)\r\n    if (res.hasValidTrack) {\r\n      const msg =\r\n        t(\"If you draw a new route it will overwrite the old route for this runner.\") +\r\n        \" \" +\r\n        t(\"GPS routes are saved separately and will not be overwritten.\")\r\n      showWarningDialog(t(\"Route already drawn\"), msg)\r\n    }\r\n    // remove old course from display just in case we missed it somewhere else\r\n    if (trk.routeData.resultid !== null) {\r\n      setScoreCourseDisplay(trk.routeData.resultid, false)\r\n    }\r\n    trk.routeData.resultid = res.resultid\r\n    trk.routeData.name = res.name\r\n    trk.routeData.splits = res.splits\r\n    // set up individual course if this is a score event\r\n    if (isScoreCourse) {\r\n      setScoreCourseDisplay(res.resultid, true)\r\n      controlx = res.scorex\r\n      controly = res.scorey\r\n      trk.routeData.x.length = 0\r\n      trk.routeData.y.length = 0\r\n      trk.routeData.x[0] = controlx[0]\r\n      trk.routeData.y[0] = controly[0]\r\n      trk.routeData.controlx = controlx\r\n      trk.routeData.controly = controly\r\n      nextControl = 1\r\n      redraw()\r\n    } else {\r\n      nextControl = getNextValidControl(0)\r\n      previousValidControlIndex = 0\r\n    }\r\n    startDrawing()\r\n  }\r\n}\r\n\r\nexport function setNameAndTime() {\r\n  // callback for an entered name when no results available\r\n  const nameEntry = document.getElementById(\"rg2-name-entry\")\r\n  const name = nameEntry.value.trim()\r\n  if (name) {\r\n    nameEntry.classList.add(\"is-valid\")\r\n  } else {\r\n    nameEntry.classList.remove(\"is-valid\")\r\n  }\r\n  const timeEntry = document.getElementById(\"rg2-time-entry\")\r\n  let time = timeEntry.value.trim()\r\n  // matches something like 0:00 to 999:59\r\n  if (time.match(/\\d+[:.][0-5]\\d$/)) {\r\n    timeEntry.classList.add(\"is-valid\")\r\n  } else {\r\n    timeEntry.classList.remove(\"is-valid\")\r\n    time = null\r\n  }\r\n  if (name && time && trk.routeData.courseid !== null) {\r\n    time = time.replace(\".\", \":\")\r\n    trk.routeData.name = name\r\n    trk.routeData.resultid = 0\r\n    trk.routeData.totaltime = time\r\n    trk.routeData.startsecs = 0\r\n    trk.routeData.time[0] = getSecsFromHHMMSS(time)\r\n    trk.routeData.totalsecs = getSecsFromHHMMSS(time)\r\n    nextControl = 1\r\n    const courseLength = trk.routeData.cumulativeLegLengths[trk.routeData.cumulativeLegLengths.length - 1]\r\n    // generate pro rata splits\r\n    // TODO: handle score courses or anything else that gives 0 course lengths\r\n    let splits = []\r\n    for (let i = 0; i < trk.routeData.cumulativeLegLengths.length; i = i + 1) {\r\n      splits[i] = parseInt((trk.routeData.cumulativeLegLengths[i] / courseLength) * trk.routeData.totalsecs, 10)\r\n    }\r\n    trk.routeData.splits = splits\r\n    previousValidControlIndex = 0\r\n    startDrawing()\r\n  }\r\n}\r\n\r\nexport function showCourseInProgress() {\r\n  if (trk.routeData.courseid !== null) {\r\n    if (isScoreCourse) {\r\n      setScoreCourseDisplay(trk.routeData.resultid, true)\r\n    } else {\r\n      setCourseDisplay(trk.routeData.courseid, true)\r\n    }\r\n  }\r\n}\r\n\r\nexport function startDrawing() {\r\n  document.getElementById(\"btn-three-seconds\").removeAttribute(\"disabled\")\r\n  document.getElementById(\"btn-reset-drawing\").removeAttribute(\"disabled\", \"\")\r\n  // setting value to null allows you to open the same file again if needed\r\n  // TODO really???\r\n  const file = document.getElementById(\"rg2-load-gps-file\")\r\n  file.removeAttribute(\"disabled\")\r\n  alignMapToAngle(0)\r\n  redraw()\r\n}\r\n\r\nexport function undoGPSAdjust() {\r\n  // restore route from before last adjust operation\r\n  trk.baseX = trk.savedBaseX.slice(0)\r\n  trk.baseY = trk.savedBaseY.slice(0)\r\n  trk.routeData.x = trk.savedBaseX.slice(0)\r\n  trk.routeData.y = trk.savedBaseY.slice(0)\r\n  trk.handles.undo()\r\n  const btn = document.getElementById(\"btn-undo-gps-adjust\")\r\n  btn.setAttribute(\"disabled\", \"\")\r\n  redraw()\r\n}\r\n\r\nexport function undoLastPoint() {\r\n  // ignore if we are still aligning map\r\n  if (mapIsAligned) {\r\n    // remove last point if we have one\r\n    const points = trk.routeData.x.length\r\n    if (points > 1) {\r\n      // are we undoing from previous control?\r\n      if (\r\n        controlx[previousValidControlIndex] === trk.routeData.x[points - 1] &&\r\n        controly[previousValidControlIndex] === trk.routeData.y[points - 1]\r\n      ) {\r\n        // are we undoing from the finish?\r\n        if (nextControl === controlx.length) {\r\n          document.getElementById(\"btn-save-route\").setAttribute(\"disabled\", \"\")\r\n        }\r\n        nextControl = previousValidControlIndex\r\n        previousValidControlIndex = getPreviousValidControl(nextControl)\r\n        // don't do anything clever about realigning map: just leave it as it is\r\n      }\r\n      trk.routeData.x.pop()\r\n      trk.routeData.y.pop()\r\n    }\r\n    // note that array length has changed so can't use points\r\n    if (trk.routeData.x.length > 1) {\r\n      document.getElementById(\"btn-undo\").removeAttribute(\"disabled\")\r\n    } else {\r\n      document.getElementById(\"btn-undo\").setAttribute(\"disabled\", \"\")\r\n    }\r\n    redraw()\r\n  }\r\n}\r\n\r\nexport function waitThreeSeconds() {\r\n  // insert a new point in the same place as the last point\r\n  addRouteDataPoint(trk.routeData.x[trk.routeData.x.length - 1], trk.routeData.y[trk.routeData.y.length - 1])\r\n  redraw()\r\n}\r\n","export class Worldfile {\r\n  // see http://en.wikipedia.org/wiki/World_file\r\n  constructor(wf) {\r\n    if (wf.A === undefined) {\r\n      this.valid = false\r\n      this.A = 0\r\n      this.B = 0\r\n      this.C = 0\r\n      this.D = 0\r\n      this.E = 0\r\n      this.F = 0\r\n    } else {\r\n      this.A = parseFloat(wf.A)\r\n      this.B = parseFloat(wf.B)\r\n      this.C = parseFloat(wf.C)\r\n      this.D = parseFloat(wf.D)\r\n      this.E = parseFloat(wf.E)\r\n      this.F = parseFloat(wf.F)\r\n      this.valid = true\r\n      // helps make later calculations easier\r\n      this.AEDB = wf.A * wf.E - wf.D * wf.B\r\n      this.xCorrection = wf.B * wf.F - wf.E * wf.C\r\n      this.yCorrection = wf.D * wf.C - wf.A * wf.F\r\n    }\r\n  }\r\n\r\n  // use worldfile to generate latitude\r\n  getLat(x, y) {\r\n    return this.D * x + this.E * y + this.F\r\n  }\r\n\r\n  // use worldfile to generate longitude\r\n  getLon(x, y) {\r\n    return this.A * x + this.B * y + this.C\r\n  }\r\n\r\n  // use worldfile to generate X value\r\n  getX(lng, lat) {\r\n    return Math.round((this.E * lng - this.B * lat + this.xCorrection) / this.AEDB)\r\n  }\r\n\r\n  // use worldfile to generate y value\r\n  getY(lng, lat) {\r\n    return Math.round((-1 * this.D * lng + this.A * lat + this.yCorrection) / this.AEDB)\r\n  }\r\n}\r\n","import { Worldfile } from \"./worldfile\"\r\n\r\n// Need to avoid unfortunate name clash with DOM Event class\r\nexport class RG2Event {\r\n  constructor(data) {\r\n    this.kartatid = data.id\r\n    this.mapid = data.mapid\r\n    this.format = data.format\r\n    this.name = data.name\r\n    this.date = data.date\r\n    this.club = data.club\r\n    this.rawtype = data.type\r\n    switch (data.type) {\r\n      case \"I\":\r\n        this.type = \"International event\"\r\n        break\r\n      case \"N\":\r\n        this.type = \"National event\"\r\n        break\r\n      case \"R\":\r\n        this.type = \"Regional event\"\r\n        break\r\n      case \"L\":\r\n        this.type = \"Local event\"\r\n        break\r\n      case \"T\":\r\n        this.type = \"Training event\"\r\n        break\r\n      default:\r\n        this.type = \"Unknown\"\r\n        break\r\n    }\r\n    this.comment = data.comment\r\n    this.locked = data.locked\r\n    this.courses = 0\r\n    if (data.suffix === undefined) {\r\n      this.mapfilename = this.mapid + \".\" + \"jpg\"\r\n    } else {\r\n      this.mapfilename = this.mapid + \".\" + data.suffix\r\n    }\r\n    this.worldfile = new Worldfile(data)\r\n  }\r\n}\r\n","import { getApi } from \"./api\"\r\nimport { resetAnimation } from \"./animation\"\r\nimport * as bootstrap from \"bootstrap\"\r\nimport { loadNewMap, getMapSize, redraw } from \"./canvas\"\r\nimport { config } from \"./config\"\r\nimport { controls, createCourseMenu, deleteAllCourses, getExcludedText, saveCourses } from \"./courses\"\r\nimport { initialiseDrawing } from \"./draw\"\r\nimport { RG2Event } from \"./event\"\r\nimport { createResultMenu } from \"./results\"\r\nimport { getHashID, getHashRoutes, getHashCourses, getHashTab, setEventHash } from \"./hash\"\r\nimport { decode } from \"html-entities\"\r\nimport { deleteResultsForEvent, getCommentsForEvent, getResultsStats, saveResults, saveRoutes } from \"./results\"\r\nimport { createEventMenu, getActiveTab } from \"./rg2ui\"\r\nimport { t } from \"./translate\"\r\nimport { getDistanceBetweenPoints, getLatLonDistance } from \"./utils\"\r\n\r\nlet events = []\r\nlet activeEventID = null\r\nlet eventRequestInProgress = false\r\n\r\nfunction configureUIForNewEvent(kartatid) {\r\n  const events = document.querySelectorAll(\"#rg2-event-table tr\")\r\n  // highlight active event in event list\r\n  for (let row of events) {\r\n    if (parseInt(row.dataset.kartatid, 10) === kartatid) {\r\n      row.classList.add(\"table-success\")\r\n    } else {\r\n      row.classList.remove(\"table-success\")\r\n    }\r\n  }\r\n  const btnSplitsbrowser = document.getElementById(\"btn-splitsbrowser\")\r\n  if (rg2Config.enable_splitsbrowser && eventHasResults()) {\r\n    btnSplitsbrowser.removeAttribute(\"disabled\")\r\n  } else {\r\n    btnSplitsbrowser.setAttribute(\"disabled\", \"\")\r\n  }\r\n  document.getElementById(\"btn-toggle-controls\").removeAttribute(\"disabled\")\r\n  document.getElementById(\"btn-runners\").removeAttribute(\"disabled\")\r\n  document.getElementById(\"btn-measure\").removeAttribute(\"disabled\")\r\n  document.getElementById(\"btn-stats\").removeAttribute(\"disabled\")\r\n}\r\n\r\nfunction doGetEvent(kartatid) {\r\n  setActiveEventIDByKartatID(null)\r\n  const params = { type: \"event\", id: kartatid }\r\n  getApi(params, handleEventResponse, \"Event request failed\")\r\n}\r\n\r\nexport function doGetEvents() {\r\n  const params = { type: \"events\" }\r\n  getApi(params, handleEventsResponse, \"Events request failed\")\r\n}\r\n\r\nfunction eventIsLocked() {\r\n  if (activeEventID === null) {\r\n    return false\r\n  }\r\n  return events[activeEventID].locked\r\n}\r\n\r\nexport function eventLoadFailed() {\r\n  eventRequestInProgress = false\r\n}\r\n\r\nexport function formatEvents() {\r\n  let html = \"<table class='table table-striped table-hover table-sm'><tbody id='rg2-event-table'>\"\r\n  for (let i = events.length - 1; i >= 0; i -= 1) {\r\n    let title = t(events[i].type, \"\") + \": \" + events[i].date\r\n    if (events[i].comment !== \"\") {\r\n      title += \": \" + events[i].comment\r\n    }\r\n    let comment = \"\"\r\n    if (events[i].comment !== \"\") {\r\n      comment = `<i class='bi-info-circle' id='info-${i}'></i>`\r\n    }\r\n    let georef = \"\"\r\n    if (events[i].worldfile.valid) {\r\n      georef = `<i class='bi-globe' id='info-${i}'></i>`\r\n    }\r\n    let lock = \"\"\r\n    if (events[i].locked) {\r\n      lock = `<i class='bi-lock-fill' id='info-${i}'></i>`\r\n    }\r\n    html += `<tr data-kartatid=\"${events[i].kartatid}\"><td class=\"event-date\">${events[i].date}</td><td title='${title}'>`\r\n    html += `${events[i].name} ${lock} ${georef} ${comment}</td ></tr >`\r\n  }\r\n  html += `</tbody></table>`\r\n  return html\r\n}\r\n\r\nfunction getActiveEventDate() {\r\n  if (activeEventID !== null) {\r\n    return events[activeEventID].date\r\n  }\r\n  return \"\"\r\n}\r\n\r\nexport function getActiveEventID() {\r\n  return activeEventID\r\n}\r\n\r\nexport function getActiveKartatID() {\r\n  if (activeEventID !== null) {\r\n    return events[activeEventID].kartatid\r\n  }\r\n  return undefined\r\n}\r\n\r\nexport function getActiveEventName() {\r\n  if (activeEventID !== null) {\r\n    return events[activeEventID].name\r\n  }\r\n  return \"Routegadget 2\"\r\n}\r\n\r\nexport function getActiveMapID() {\r\n  if (activeEventID !== null) {\r\n    return events[activeEventID].mapid\r\n  }\r\n  return null\r\n}\r\n\r\nexport function getEventIDForKartatID(kartatid) {\r\n  for (let i = 0; i < events.length; i += 1) {\r\n    if (events[i].kartatid === kartatid) {\r\n      return i\r\n    }\r\n  }\r\n  return undefined\r\n}\r\n\r\nexport function eventHasResults() {\r\n  if (activeEventID !== null) {\r\n    return (\r\n      events[activeEventID].format === config.FORMAT_NORMAL ||\r\n      events[activeEventID].format === config.FORMAT_SCORE_EVENT\r\n    )\r\n  }\r\n  return true\r\n}\r\n\r\nexport function getEventInfoForKartatID(kartatid) {\r\n  kartatid = kartatid || getKartatEventID()\r\n  const realid = getEventIDForKartatID(kartatid)\r\n  let info = events[realid]\r\n  info.id = realid\r\n  info.controls = controls.getControlCount()\r\n  info.exclude = getExcludedText()\r\n  return info\r\n}\r\n\r\nexport function getEventStats() {\r\n  // check there is an event to report on\r\n  if (activeEventID === null) {\r\n    return \"\"\r\n  }\r\n  const id = getKartatEventID()\r\n  const eventinfo = getEventInfoForKartatID(parseInt(id, 10))\r\n\r\n  let stats = `<div class='fs-4 fw-bolder pb-3'>${t(\"Event statistics\") + \": \" + eventinfo.name + \"&nbsp\" + eventinfo.date}</div>\r\n  <div class=\"d-flex flex-wrap justify-content-evenly pb-2\">\r\n  ${getResultsStats(eventinfo)}\r\n  </div>`\r\n  if (eventinfo.comment) {\r\n    stats += `<table class='table table-sm table-striped-columns table-bordered'><tbody>`\r\n    stats += `<tr><td>${t(\"Comments\")}</td><td>${eventinfo.comment}</td></tr>`\r\n    stats += `</tbody></table>`\r\n  }\r\n  stats += `<hr class=\"border border-primary opacity-75\" />`\r\n  stats += getCommentsForEvent()\r\n  // #177 not pretty but gets round problems of double encoding\r\n  stats = stats.replace(/&amp;/g, \"&\")\r\n  return stats\r\n}\r\n\r\nexport function getKartatEventID() {\r\n  if (activeEventID === null) {\r\n    return null\r\n  }\r\n  return events[activeEventID].kartatid\r\n}\r\n\r\nexport function getLengthUnits() {\r\n  if (activeEventID === null || !mapIsGeoreferenced()) {\r\n    return \"px\"\r\n  }\r\n  return \"m\"\r\n}\r\n\r\nexport function getMapFileName(kartatid) {\r\n  for (let i = 0; i < events.length; i += 1) {\r\n    if (events[i].kartatid === kartatid) {\r\n      return events[i].mapfilename\r\n    }\r\n  }\r\n  return \"\"\r\n}\r\n\r\nexport function getMetresPerPixel() {\r\n  if (activeEventID === null || !mapIsGeoreferenced()) {\r\n    return undefined\r\n  }\r\n  const size = getMapSize()\r\n  const pixels = getDistanceBetweenPoints(0, 0, size.width, size.height)\r\n  const w = events[activeEventID].worldfile\r\n  const lon1 = w.C\r\n  const lat1 = w.F\r\n  const lon2 = w.A * size.width + w.B * size.height + w.C\r\n  const lat2 = w.D * size.width + w.E * size.height + w.F\r\n  return getLatLonDistance(lat1, lon1, lat2, lon2) / pixels\r\n}\r\n\r\nexport function getWorldFile() {\r\n  if (activeEventID === null) {\r\n    return null\r\n  }\r\n  return events[activeEventID].worldfile\r\n}\r\n\r\nfunction handleEventResponse(response, kartatid) {\r\n  eventRequestInProgress = false\r\n  bootstrap.Offcanvas.getInstance(document.getElementById(\"rg2-right-info-panel\")).hide()\r\n  setEventHash(kartatid)\r\n  setActiveEventIDByKartatID(kartatid)\r\n  setEventTitleBar()\r\n  document.getElementById(\"rg2-load-progress-label\").innerHTML = t(\"Saving courses\")\r\n  saveCourses(response.courses)\r\n  document.getElementById(\"rg2-load-progress-label\").textContent = t(\"Saving results\", \"\")\r\n  saveResults(response.results)\r\n  document.getElementById(\"rg2-load-progress-label\").textContent = t(\"Saving routes\", \"\")\r\n  saveRoutes(response.routes)\r\n  createCourseMenu()\r\n  createResultMenu()\r\n  if (config.managing()) {\r\n    rg2Config.manager.eventFinishedLoading(kartatid)\r\n  } else {\r\n    document.getElementById(config.TAB_COURSES).removeAttribute(\"disabled\")\r\n    document.getElementById(config.TAB_RESULTS).removeAttribute(\"disabled\")\r\n    if (eventIsLocked()) {\r\n      document.getElementById(config.TAB_DRAW).setAttribute(\"disabled\", \"\")\r\n    } else {\r\n      document.getElementById(config.TAB_DRAW).removeAttribute(\"disabled\")\r\n    }\r\n    // open courses tab for new event: else stay on draw tab\r\n    const active = getActiveTab()\r\n    // don't change tab if we have come from DRAW since it means\r\n    // we have just reloaded following a save\r\n    if (active !== config.TAB_DRAW) {\r\n      const tab = getHashTab()\r\n      const target = document.getElementById(tab)\r\n      target.click()\r\n    }\r\n    // set up screen as requested in hash\r\n    const routes = getHashRoutes()\r\n    for (let i = 0; i < routes.length; i += 1) {\r\n      let e = new Event(\"click\", { bubbles: true })\r\n      const target = document.querySelector(`.showtrack[data-id='${routes[i]}']`)\r\n      if (target) {\r\n        target.checked = true\r\n        target.dispatchEvent(e)\r\n      }\r\n    }\r\n    const courses = getHashCourses()\r\n    for (let i = 0; i < courses.length; i += 1) {\r\n      let e = new Event(\"click\", { bubbles: true })\r\n      const target = document.querySelector(`.showcourse[data-courseid='${courses[i]}']`)\r\n      if (target) {\r\n        target.checked = true\r\n        target.dispatchEvent(e)\r\n      }\r\n    }\r\n  }\r\n  document.getElementById(\"rg2-load-progress\").classList.add(\"d-none\")\r\n  initialiseDrawing()\r\n  configureUIForNewEvent(kartatid)\r\n}\r\n\r\nfunction handleEventsResponse(response) {\r\n  events.length = 0\r\n  activeEventID = null\r\n  for (const event of response.events) {\r\n    events.push(new RG2Event(event))\r\n  }\r\n  createEventMenu()\r\n  // load requested event if set\r\n  // input is kartat ID so need to find internal ID first\r\n  const kartatid = getHashID()\r\n  if (kartatid) {\r\n    loadEventByKartatID(kartatid)\r\n  }\r\n  if (config.managing()) {\r\n    rg2Config.manager.eventListLoaded(events)\r\n  }\r\n}\r\n\r\nexport function isScoreEvent() {\r\n  if (activeEventID !== null) {\r\n    return (\r\n      events[activeEventID].format === config.FORMAT_SCORE_EVENT ||\r\n      events[activeEventID].format === config.FORMAT_SCORE_EVENT_NO_RESULTS\r\n    )\r\n  }\r\n  return false\r\n}\r\n\r\nexport function isValidKartatID(id) {\r\n  for (let i = 0; i < events.length; i += 1) {\r\n    if (events[i].kartatid === id) {\r\n      return true\r\n    }\r\n  }\r\n  return false\r\n}\r\n\r\nexport function loadEventByKartatID(kartatid) {\r\n  // prevent double loading if user double clicks on event or we get a garbage event id from a hash\r\n  if (eventRequestInProgress || !isValidKartatID(kartatid)) {\r\n    return\r\n  }\r\n  eventRequestInProgress = true\r\n  // clear animation first to avoid redraw problems as things get deleted\r\n  resetAnimation()\r\n  deleteResultsForEvent()\r\n  deleteAllCourses()\r\n  loadNewMap(rg2Config.maps_url + getMapFileName(kartatid))\r\n  document.getElementById(\"rg2-load-progress-label\").textContent = t(\"Loading event\", \"\")\r\n  document.getElementById(\"rg2-load-progress\").classList.remove(\"d-none\")\r\n  doGetEvent(kartatid)\r\n  redraw()\r\n}\r\n\r\nexport function mapIDIsInUse(mapID) {\r\n  for (let i = 0; i < events.length; i += 1) {\r\n    if (events[i].mapid === mapID) {\r\n      return true\r\n    }\r\n  }\r\n  return false\r\n}\r\n\r\nexport function mapIsGeoreferenced() {\r\n  if (activeEventID === null) {\r\n    return false\r\n  }\r\n  return events[activeEventID].worldfile.valid\r\n}\r\n\r\nexport function setActiveEventIDByKartatID(kartatid) {\r\n  activeEventID = null\r\n  for (let i = 0; i < events.length; i += 1) {\r\n    if (events[i].kartatid === kartatid) {\r\n      activeEventID = i\r\n      break\r\n    }\r\n  }\r\n}\r\n\r\nexport function setEventTitleBar() {\r\n  let title = \"\"\r\n  title = getActiveEventDate() + \" \" + decode(getActiveEventName())\r\n  document.title = title\r\n  if (mapIsGeoreferenced()) {\r\n    title = \"<i class='bi-globe'>&nbsp;</i>\" + title\r\n  }\r\n  if (eventIsLocked()) {\r\n    title = \"<i class='bi-lock-fill'>&nbsp;</i>\" + title\r\n  }\r\n  document.getElementById(\"rg2-event-title\").innerHTML = title\r\n}\r\n","import { getAngle, getDistanceBetweenPoints } from \"./utils\"\r\nimport { getMetresPerPixel } from \"./events\"\r\nimport { getOverprintDetails } from \"./config\"\r\nimport { ctx } from \"./canvas\"\r\nimport { controls } from \"./courses\"\r\n\r\nexport class Course {\r\n  constructor(data, isScoreCourse) {\r\n    this.name = data.name\r\n    this.trackcount = 0\r\n    this.display = false\r\n    this.courseid = data.courseid\r\n    this.codes = data.codes\r\n    this.setExcluded(data)\r\n    this.filterTo = this.codes.length\r\n    this.filterFrom = 0\r\n    this.x = data.xpos\r\n    this.y = data.ypos\r\n    this.isScoreCourse = isScoreCourse\r\n    this.resultcount = 0\r\n    // save angle to next control to simplify later calculations\r\n    this.angle = []\r\n    // save angle to show control code text\r\n    this.textAngle = []\r\n    this.setAngles()\r\n    this.setLengths()\r\n  }\r\n\r\n  drawCourse(intensity) {\r\n    if (this.display) {\r\n      const opt = getOverprintDetails()\r\n      ctx.globalAlpha = intensity\r\n      controls.drawStart(this.x[0], this.y[0], \"\", this.angle[0], opt)\r\n      // don't join up controls for score events\r\n      if (!this.isScoreCourse) {\r\n        const filter = { from: this.filterFrom, to: this.filterTo }\r\n        this.drawLinesBetweenControls({ x: this.x, y: this.y }, this.angle, opt, filter)\r\n      }\r\n      if (this.isScoreCourse) {\r\n        for (let i = 1; i < this.x.length; i += 1) {\r\n          if (this.codes[i].indexOf(\"F\") === 0 || this.codes[i].indexOf(\"M\") === 0) {\r\n            controls.drawFinish(this.x[i], this.y[i], \"\", opt)\r\n          } else {\r\n            controls.drawSingleControl(this.x[i], this.y[i], this.codes[i], this.textAngle[i], opt)\r\n          }\r\n        }\r\n      } else {\r\n        // don't want to draw an extra circle round the start or finish\r\n        const from = Math.max(this.filterFrom, 1)\r\n        const to = Math.min(this.filterTo + 1, this.x.length - 1)\r\n        for (let i = from; i < to; i += 1) {\r\n          controls.drawSingleControl(this.x[i], this.y[i], i, this.textAngle[i], opt)\r\n        }\r\n        controls.drawFinish(this.x[this.x.length - 1], this.y[this.y.length - 1], \"\", opt)\r\n      }\r\n    }\r\n  }\r\n\r\n  drawLinesBetweenControls(pt, angle, opt, filter) {\r\n    let dist\r\n    for (let i = filter.from; i < filter.to; i += 1) {\r\n      if (i === 0) {\r\n        dist = opt.startTriangleLength\r\n      } else {\r\n        dist = opt.controlRadius\r\n      }\r\n      const c1x = pt.x[i] + dist * Math.cos(angle[i])\r\n      const c1y = pt.y[i] + dist * Math.sin(angle[i])\r\n      //Assume the last control in the array is a finish\r\n      if (i === this.x.length - 2) {\r\n        dist = opt.finishOuterRadius\r\n      } else {\r\n        dist = opt.controlRadius\r\n      }\r\n      const c2x = pt.x[i + 1] - dist * Math.cos(angle[i])\r\n      const c2y = pt.y[i + 1] - dist * Math.sin(angle[i])\r\n      ctx.beginPath()\r\n      ctx.moveTo(c1x, c1y)\r\n      ctx.lineTo(c2x, c2y)\r\n      ctx.stroke()\r\n    }\r\n  }\r\n\r\n  incrementTracksCount() {\r\n    this.trackcount += 1\r\n  }\r\n\r\n  setAngles() {\r\n    for (let i = 0; i < this.x.length - 1; i += 1) {\r\n      if (this.isScoreCourse) {\r\n        // align score event start triangle and controls upwards\r\n        this.angle[i] = Math.PI * 1.5\r\n        this.textAngle[i] = Math.PI * 0.25\r\n      } else {\r\n        // angle of line to next control\r\n        this.angle[i] = getAngle(this.x[i], this.y[i], this.x[i + 1], this.y[i + 1])\r\n        if (i > 0) {\r\n          // create bisector of angle to position number\r\n          const c1x = Math.sin(this.angle[i - 1])\r\n          const c1y = Math.cos(this.angle[i - 1])\r\n          const c2x = Math.sin(this.angle[i]) + c1x\r\n          const c2y = Math.cos(this.angle[i]) + c1y\r\n          const c3x = c2x / 2\r\n          const c3y = c2y / 2\r\n          this.textAngle[i] = getAngle(c3x, c3y, c1x, c1y)\r\n        } else {\r\n          this.textAngle[0] = 0\r\n        }\r\n      }\r\n    }\r\n    // angle for finish aligns to north\r\n    this.angle[this.x.length - 1] = Math.PI * 1.5\r\n    this.textAngle[this.x.length - 1] = Math.PI * 1.5\r\n  }\r\n\r\n  setDisplay(display) {\r\n    this.display = display\r\n  }\r\n\r\n  setExcluded(data) {\r\n    this.excludeType = data.excludeType\r\n    this.exclude = data.codes.map((control, i) => {\r\n      if (data.exclude.findIndex((ex) => ex === i) > -1) {\r\n        return true\r\n      } else {\r\n        return false\r\n      }\r\n    })\r\n    // need to know which is first excluded control for later drawing purposes\r\n    const firstExcluded = this.exclude.findIndex((ex) => ex === true)\r\n    // setting it to 0 is OK since start cannot be excluded (?!)\r\n    this.firstExcluded = firstExcluded === -1 ? 0 : firstExcluded\r\n    this.allowed = data.codes.map((control, i) => {\r\n      if (data.exclude.findIndex((ex) => ex === i) > -1) {\r\n        return data.allowed[data.exclude.findIndex((ex) => ex === i)]\r\n      } else {\r\n        return 0\r\n      }\r\n    })\r\n  }\r\n\r\n  setLengths() {\r\n    let length = 0\r\n    this.lengthValid = true\r\n    this.legLengths = []\r\n    this.cumulativeLegLengths = []\r\n    this.legLengths[0] = 0\r\n    this.cumulativeLegLengths[0] = 0\r\n    let metresPerPixel = getMetresPerPixel()\r\n    if (metresPerPixel === undefined) {\r\n      this.lengthValid = false\r\n      metresPerPixel = 1\r\n    }\r\n    for (let i = 1; i < this.x.length; i += 1) {\r\n      const legLength = parseInt(\r\n        (getDistanceBetweenPoints(this.x[i], this.y[i], this.x[i - 1], this.y[i - 1]) * metresPerPixel).toFixed(0)\r\n      )\r\n      this.legLengths[i] = legLength\r\n      this.cumulativeLegLengths[i] = this.cumulativeLegLengths[i - 1] + legLength\r\n      length += legLength\r\n    }\r\n\r\n    this.length = (length / 1000).toFixed(1)\r\n  }\r\n}\r\n","import { redraw } from \"./canvas\"\r\nimport { config } from \"./config\"\r\nimport { Controls } from \"./controls\"\r\nimport { Course } from \"./course\"\r\nimport { setDrawingCourse } from \"./draw\"\r\nimport { isScoreEvent } from \"./events\"\r\nimport { decode } from \"html-entities\"\r\nimport { anyTracksForCourseDisplayed, countResultsByCourseID } from \"./results\"\r\nimport { t } from \"./translate\"\r\nimport { generateOption } from \"./utils\"\r\nimport \"toolcool-range-slider\"\r\n\r\n// indexed by the provided courseid which omits 0 and hence a sparse array\r\n// careful when iterating or getting length!\r\nlet courses = []\r\nexport let controls = undefined\r\nlet totaltracks = 0\r\nlet numberOfCourses = 0\r\nlet highestControlNumber = 0\r\n\r\nfunction addCourse(data) {\r\n  courses[data.courseid] = new Course(data, isScoreEvent())\r\n  numberOfCourses += 1\r\n  // allow for courses with no defined controls\r\n  // careful here: != catches null and undefined, but !== just catches undefined\r\n  if (courses[data.courseid].codes !== undefined) {\r\n    if (courses[data.courseid].codes.length > highestControlNumber) {\r\n      // the codes includes Start and Finish: we don't need F so subtract 1 to get controls\r\n      highestControlNumber = courses[data.courseid].codes.length - 1\r\n    }\r\n  }\r\n}\r\n\r\nexport function allCoursesDisplayed() {\r\n  for (let i = 0; i < courses.length; i += 1) {\r\n    if (courses[i] !== undefined) {\r\n      if (!courses[i].display) {\r\n        return false\r\n      }\r\n    }\r\n  }\r\n  return true\r\n}\r\n\r\nexport function createCourseDropdown() {\r\n  let dropdown = document.getElementById(\"rg2-select-course\")\r\n  dropdown.innerHTML = \"\"\r\n  dropdown.options.add(generateOption(null, t(\"Select course\", \"\")))\r\n  for (let i = 0; i < courses.length; i = i + 1) {\r\n    if (courses[i] !== undefined) {\r\n      dropdown.options.add(generateOption(i, decode(courses[i].name)))\r\n    }\r\n  }\r\n  dropdown.addEventListener(\"change\", (e) => {\r\n    setDrawingCourse(parseInt(e.target.value, 10))\r\n  })\r\n}\r\n\r\nexport function createCourseMenu() {\r\n  const el = document.getElementById(\"rg2-course-table\")\r\n  el.innerHTML = formatCourses()\r\n  const filterTable = document.getElementById(\"rg2-course-filter-table\")\r\n  filterTable.innerHTML = formatCourseFilters()\r\n  const filters = document.querySelectorAll(\"[data-course-filter]\")\r\n  filters.forEach((filter) => {\r\n    filter.addEventListener(\"change\", filterChanged)\r\n  })\r\n}\r\n\r\nexport function deleteAllCourses() {\r\n  courses.length = 0\r\n  totaltracks = 0\r\n  numberOfCourses = 0\r\n  highestControlNumber = 0\r\n}\r\n\r\nexport function drawCourses(intensity) {\r\n  for (let i = 0; i < courses.length; i += 1) {\r\n    if (courses[i] !== undefined) {\r\n      courses[i].drawCourse(intensity)\r\n    }\r\n  }\r\n}\r\n\r\nexport function drawLinesBetweenControls(pt, angle, courseid, opt, filter) {\r\n  courses[courseid].drawLinesBetweenControls(pt, angle, opt, filter)\r\n}\r\n\r\nfunction filterChanged(e) {\r\n  const courseid = parseInt(e.target.dataset.courseFilter, 10)\r\n  courses[courseid].filterFrom = e.detail.value1\r\n  courses[courseid].filterTo = e.detail.value2\r\n  redraw()\r\n}\r\n\r\nfunction formatCourseDetails() {\r\n  let details = { html: \"\", res: 0, coursecount: 0 }\r\n  for (let i = 0; i < courses.length; i += 1) {\r\n    if (courses[i] !== undefined) {\r\n      details.coursecount = details.coursecount + 1\r\n      details.html += [\r\n        `<tr><td>${courses[i].name}</td >`,\r\n        `<td><input class='showcourse' data-courseid=${i} type='checkbox' name='course'></input></td>`,\r\n        `<td class='text-center'>${courses[i].resultcount}</td><td class='text-center'>${courses[i].trackcount}</td><td>`\r\n      ].join(\"\")\r\n      details.res += courses[i].resultcount\r\n      if (courses[i].trackcount > 0) {\r\n        details.html += `<input data-courseid=${courses[i].courseid} class='allcoursetracks' type=checkbox name=track></input></td>`\r\n        details.html += `<td><input data-courseid=${courses[i].courseid} class='allcoursetracksreplay' type=checkbox name=replay></input>`\r\n      } else {\r\n        details.html += `</td><td>`\r\n      }\r\n      details.html += `</td></tr>`\r\n    }\r\n  }\r\n  return details\r\n}\r\n\r\nfunction formatCourseFilters() {\r\n  let html = \"\"\r\n  for (let i = 0; i < courses.length; i += 1) {\r\n    if (courses[i] !== undefined) {\r\n      // only filter for normal events with at least one control as well as start and finish\r\n      if (!courses[i].isScoreCourse && courses[i].codes.length > 2) {\r\n        html += [\r\n          `<div id='course-filter-${courses[i].courseid}' data-display=\"false\" data-course=\"${courses[i].courseid}\" class=\"row\">`,\r\n          `<div class=\"col-3\">${courses[i].name}</div>`,\r\n          `<div class=\"col-9 pt-2\">`,\r\n          `  <tc-range-slider step=\"1\" min=\"0\" max=\"${courses[i].codes.length}\" value1=\"0\"`,\r\n          `value2=\"${courses[i].codes.length}\" round=\"0\" data-course-filter=\"${courses[i].courseid}>\"`,\r\n          `</tc-range-slider></div></div>`\r\n        ].join(\"\")\r\n      }\r\n    }\r\n  }\r\n  return html\r\n}\r\n\r\nfunction formatCourses() {\r\n  let html = [\r\n    `<table class='table table-striped table-hover table-sm'><thead>`,\r\n    `<tr><th>${t(\"Course\")}</th><th><i class='bi-eye-fill'></i></th><th>${t(\"Runners\")}</th>`,\r\n    `<th>${t(\"Routes\")}</th><th><i class='bi-pencil'></i></th><th><i class='bi-play-fill'></i></th></tr>`,\r\n    `</thead><tbody class=\"table-group-divider\">`\r\n  ].join(\"\")\r\n  const details = formatCourseDetails()\r\n  // add bottom row for all courses checkboxes\r\n  html +=\r\n    details.html +\r\n    `</tbody><tfoot class=\"table-group-divider\"><tr class='allitemsrow'><td>${t(\"All\")}</td>\r\n    <td><input class='showallcourses' data-id=\"all\" type=checkbox name=course></input></td>\r\n    <td class='text-center'>${details.res}</td><td class='text-center'>${totaltracks}</td><td>`\r\n\r\n  if (totaltracks > 0) {\r\n    html += `<input data-id=\"all\" class='alltracks' type=checkbox name=track></input>`\r\n  }\r\n  html += \"</td><td></td></tr></tfoot></table>\"\r\n  return html\r\n}\r\n\r\nexport function getCourses() {\r\n  return courses\r\n}\r\n\r\nexport function getCourseDetails(courseid) {\r\n  return courses[courseid]\r\n}\r\n\r\nexport function getCourseDetailsByName(coursename) {\r\n  // courses is a sparse array so need to handle empty entries\r\n  return courses.find((course) => (course ? course.name === coursename : false))\r\n}\r\n\r\nexport function getCourseName(courseid) {\r\n  return courses[courseid].name\r\n}\r\n\r\nexport function getCoursesForEvent() {\r\n  let list = []\r\n  for (let i = 0; i < courses.length; i += 1) {\r\n    if (courses[i] !== undefined) {\r\n      let course = {}\r\n      course.id = courses[i].courseid\r\n      course.name = courses[i].name\r\n      course.results = courses[i].resultcount\r\n      list.push(course)\r\n    }\r\n  }\r\n  return list\r\n}\r\n\r\nexport function getCoursesOnDisplay() {\r\n  let displayed = []\r\n  for (let i = 0; i < courses.length; i += 1) {\r\n    if (courses[i] !== undefined) {\r\n      if (courses[i].display) {\r\n        displayed.push(i)\r\n      }\r\n    }\r\n  }\r\n  return displayed\r\n}\r\n\r\nexport function getExcludedText() {\r\n  // recreates excluded_* text file contents\r\n  // courseid|type|control,time|...\r\n  let text = \"\"\r\n  for (let i = 0; i < courses.length; i += 1) {\r\n    if (courses[i] !== undefined) {\r\n      if (courses[i].excludeType !== config.EXCLUDED_NONE) {\r\n        text = text + courses[i].courseid + \"|\" + courses[i].excludeType\r\n        text =\r\n          text +\r\n          courses[i].exclude.reduce((accum, exclude, index) => {\r\n            return exclude ? accum + \"|\" + index + \",\" + courses[i].allowed[index] : accum\r\n          }, \"\")\r\n        text = text + \"\\n\"\r\n      }\r\n    }\r\n  }\r\n  return text\r\n}\r\n\r\nexport function getFilterDetails(courseid) {\r\n  let filter = {}\r\n  filter.filterFrom = courses[courseid].filterFrom\r\n  filter.filterTo = courses[courseid].filterTo\r\n  return filter\r\n}\r\n\r\nexport function getHighestControlNumber() {\r\n  return highestControlNumber\r\n}\r\n\r\nexport function getNumberOfControlsOnCourse(courseid) {\r\n  // codes list includes \"S\" and \"F\", so allow for them\r\n  return courses[courseid].codes.length - 2\r\n}\r\n\r\nexport function getnumberOfCourses() {\r\n  return numberOfCourses\r\n}\r\n\r\nexport function incrementTracksCount(courseid) {\r\n  courses[courseid].incrementTracksCount()\r\n  totaltracks += 1\r\n}\r\n\r\nexport function initialiseCourses() {\r\n  controls = new Controls()\r\n}\r\n\r\nexport function isValidCourseId(courseid) {\r\n  // detects the unused entries in the courses array\r\n  // index 0 never used: some others not used if you only set up certain courses for a set of results\r\n  return courseid in courses\r\n}\r\n\r\nexport function saveCourses(data) {\r\n  deleteAllCourses()\r\n  controls.deleteAllControls()\r\n  for (const course of data) {\r\n    addCourse(course)\r\n  }\r\n  controls.generateControlList()\r\n}\r\n\r\nexport function setAllCoursesDisplay(display) {\r\n  for (let i = 0; i < courses.length; i += 1) {\r\n    if (courses[i] !== undefined) {\r\n      courses[i].setDisplay(display)\r\n    }\r\n  }\r\n}\r\n\r\nexport function setAllFilters() {\r\n  for (let i = 0; i < courses.length; i += 1) {\r\n    if (courses[i] !== undefined) {\r\n      setFilter(i)\r\n    }\r\n  }\r\n}\r\n\r\nexport function setCourseDisplay(courseid, display) {\r\n  if (courses[courseid] !== undefined) {\r\n    courses[courseid].setDisplay(display)\r\n    setFilter(courseid)\r\n  }\r\n}\r\n\r\nexport function setFilter(courseid) {\r\n  // may come in as string or integer\r\n  courseid = parseInt(courseid, 10)\r\n  // assumes display properties set on courses and results before this call\r\n  const display = courses[courseid].display || anyTracksForCourseDisplayed(courseid)\r\n  document.querySelectorAll(\"[data-display]\").forEach((div) => {\r\n    if (parseInt(div.dataset.course, 10) === courseid) {\r\n      div.dataset.display = display\r\n    }\r\n  })\r\n}\r\n\r\nexport function setResultsCount() {\r\n  for (let i = 0; i < courses.length; i += 1) {\r\n    if (courses[i] !== undefined) {\r\n      courses[i].resultcount = countResultsByCourseID(i)\r\n    }\r\n  }\r\n}\r\n\r\nexport function updateScoreCourse(courseid, codes, x, y) {\r\n  for (let i = 0; i < courses.length; i += 1) {\r\n    if (courses[i] !== undefined) {\r\n      if (courses[i].courseid === courseid) {\r\n        courses[i].codes = codes\r\n        courses[i].x = x\r\n        courses[i].y = y\r\n        courses[i].setAngles()\r\n        break\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { alignMap, ctx, getCentreBottom, getCentreTop, redraw } from \"./canvas\"\r\nimport { options, config } from \"./config\"\r\nimport { getCourseDetailsByName } from \"./courses\"\r\nimport { getLengthUnits } from \"./events\"\r\nimport interact from \"interactjs\"\r\nimport { getDisplayedTrackDetails, setResultColour } from \"./results\"\r\nimport { resizePanels } from \"./rg2ui\"\r\nimport { Runner } from \"./runner\"\r\nimport { t } from \"./translate\"\r\nimport { formatSecsAsHHMMSS, getDistanceBetweenPoints, getNextTrackColour } from \"./utils\"\r\nlet runners = []\r\nlet course = {}\r\n// possible time increment values in milliseconds when timer expires\r\nconst timeDeltas = [100, 200, 500, 1000, 2000, 3000, 5000, 7500, 10000, 15000, 20000, 50000, 100000]\r\n// value in milliseconds\r\nconst timerInterval = 100\r\nconst alignmentTimerInterval = 50\r\nconst alignmentLoopCount = 20\r\nlet mapIsAligned = false\r\nlet units = \"px\"\r\nlet timeDelta = 3000\r\nlet timer = null\r\nlet alignmentTimer = null\r\nlet alignments = []\r\n// current time of animation\r\nlet animationSecs = 0\r\n// animation time in millisecs to avoid rounding problems at very slow speed\r\n// animationSecs is always int(milliSecs/1000)\r\nlet milliSecs = 0\r\nlet realTime = false\r\nlet earliestStartSecs = 0\r\nlet latestFinishSecs = 0\r\nlet tailLength = 60\r\nlet tailStartTimeSecs = 0\r\n// control to start from if this option selected\r\nlet massStartControl = 0\r\n// run each leg as a mass start if true\r\nlet massStartByControl = false\r\nlet displayNames = false\r\nlet displayInitials = true\r\nlet startSecs = 0\r\nlet slowestTimeSecs = 0\r\nlet animationPanel = null\r\n// animation control panel location\r\n// const position = { x: 0, y: 0 }\r\nlet clockSlider = undefined\r\n\r\nconst playIcon = `<i title=${t(\"Run\", \"\")} class=\"bi-play-circle-fill\"></i>`\r\nconst startIcon = `<i title=${t(\"Start\", \"\")} class=\"bi-triangle\"></i>`\r\nconst pauseIcon = `<i title=${t(\"Pause\", \"\")} class=\"bi-pause-btn\"></i>`\r\nconst waitIcon = `<i title=${t(\"Wait\", \"\")} class=\"bi-hourglass-split\"></i>`\r\nconst trackNames = document.getElementById(\"rg2-track-names\")\r\nconst trackNamesBody = document.querySelector(\"#rg2-track-names .card-body\")\r\nconst btnRunners = document.getElementById(\"btn-runners\")\r\nconst btnStartStop = document.getElementById(\"btn-start-stop\")\r\ndocument.querySelector(\"#rg2-track-names .card-title\").innerHTML = t(\"Runners\")\r\ndocument.getElementById(\"btn-close-track-names\").addEventListener(\"click\", () => {\r\n  trackNames.classList.add(\"d-none\")\r\n})\r\nbtnRunners.addEventListener(\"click\", () => {\r\n  trackNames.classList.toggle(\"d-none\")\r\n})\r\nconst replayByControl = document.getElementById(\"rg2-replay-by-control\")\r\nreplayByControl.classList.add(\"d-none\")\r\n//  allow dialog to be moved\r\nlet namesPosition = { x: 0, y: 0 }\r\ninteract(trackNames).draggable({\r\n  inertia: true,\r\n  listeners: {\r\n    move(e) {\r\n      namesPosition.x += e.dx\r\n      namesPosition.y += e.dy\r\n      e.target.style.transform = `translate(${namesPosition.x}px, ${namesPosition.y}px)`\r\n    }\r\n  },\r\n  modifiers: [\r\n    interact.modifiers.restrictRect({\r\n      restriction: \"#rg2-container\"\r\n    })\r\n  ]\r\n})\r\n\r\n// TODO: enabling this interferes with clock slider\r\n// let panelPosition = { x: 0, y: 0 }\r\n// interact(document.getElementById(\"rg2-animation-controls\")).draggable({\r\n//   inertia: true,\r\n//   listeners: {\r\n//     move(e) {\r\n//       panelPosition.x += e.dx\r\n//       panelPosition.y += e.dy\r\n//       e.target.style.transform = `translate(${panelPosition.x}px, ${panelPosition.y}px)`\r\n//     }\r\n//   },\r\n//   modifiers: [\r\n//     interact.modifiers.restrictRect({\r\n//       restriction: \"#rg2-container\"\r\n//     })\r\n//   ]\r\n// })\r\n\r\n// update flag prevents multiple rapid updates to slider which can cause recursion problems\r\n// needs to be set to false if called in a loop, and calling function then needs to call updateAnimationDetails\r\nexport function addRunner(runner, update = true) {\r\n  for (let i = 0; i < runners.length; i += 1) {\r\n    if (runners[i].resultid === runner.resultid) {\r\n      // runner already exists so ignore\r\n      return\r\n    }\r\n  }\r\n  // if this is the first runner to be added then get course details\r\n  // needed for replay by control to allow alignment of map. Don't worry that not all\r\n  // runners are on same course. Just assume first runner added is the relevant course\r\n  if (runners.length === 0) {\r\n    course = getCourseDetailsByName(runner.coursename)\r\n  }\r\n  if (runner.userColour !== null) {\r\n    runner.trackColour = runner.userColour\r\n  } else {\r\n    runner.trackColour = getNextTrackColour()\r\n  }\r\n  runners.push(runner)\r\n  if (update) {\r\n    updateAnimationDetails()\r\n  }\r\n}\r\n\r\nfunction alignMapToAngle(control) {\r\n  mapIsAligned = false\r\n  alignments = []\r\n  const x = course.x[control]\r\n  const y = course.y[control]\r\n  const x2 = course.x[control + 1]\r\n  const y2 = course.y[control + 1]\r\n  if (course.angle.length >= control) {\r\n    // Set up array of transformations to move control to centre bottom of screen and rotate map\r\n    // so next control is straight up and near top of screen.\r\n    const from = getCentreBottom()\r\n    const to = getCentreTop()\r\n    const mapDistance = getDistanceBetweenPoints(x, y, x2, y2)\r\n    const screenDistance = getDistanceBetweenPoints(from.x, from.y, to.x, to.y)\r\n    let scale = Math.min(screenDistance / mapDistance, config.MAX_ZOOM)\r\n    scale = Math.max(scale, config.MIN_ZOOM)\r\n    let angle = (ctx.displayAngle - course.angle[control] - Math.PI / 2) % (Math.PI * 2)\r\n    if (angle < -1 * Math.PI) {\r\n      angle = angle + 2 * Math.PI\r\n    }\r\n    for (let i = 1; i <= alignmentLoopCount; i = i + 1) {\r\n      let values = {}\r\n\r\n      // translations to move current control to centre bottom\r\n      values.x = from.x - ((from.x - x) * i) / alignmentLoopCount\r\n      values.y = from.y - ((from.y - y) * i) / alignmentLoopCount\r\n\r\n      // Rotation to get from current display angle to angle with next control straight up.\r\n      // Course angles are based on horizontal as 0: need to reset to north.\r\n      // Angle parameter is absolute angle to draw map.\r\n      values.angle = (ctx.displayAngle - (angle * i) / alignmentLoopCount) % (Math.PI * 2)\r\n\r\n      // scale to stretch map: value is a multiplier so use xth root each time and apply it x times\r\n      values.scale = Math.pow(scale, 1 / alignmentLoopCount)\r\n\r\n      alignments.push(values)\r\n    }\r\n\r\n    alignmentTimer = setInterval(() => {\r\n      incrementAlignmentTime()\r\n    }, alignmentTimerInterval)\r\n  } else {\r\n    // just set to north and keep going\r\n    alignMap(0, x, y, true, 1)\r\n    alignmentTimer = null\r\n    mapIsAligned = true\r\n  }\r\n}\r\n\r\nexport function animateRunners(courseresults, doAnimate) {\r\n  for (let i = 0; i < courseresults.length; i += 1) {\r\n    if (doAnimate) {\r\n      addRunner(new Runner(courseresults[i]), false)\r\n    } else {\r\n      removeRunner(courseresults[i], false)\r\n    }\r\n  }\r\n  updateAnimationDetails()\r\n}\r\n\r\nfunction calculateAnimationRange() {\r\n  // in theory start time will be less than 24:00\r\n  // TODO: races over midnight: a few other things to sort out before we get to that\r\n  earliestStartSecs = 86400\r\n  latestFinishSecs = 0\r\n  slowestTimeSecs = 0\r\n  for (let i = 0; i < runners.length; i += 1) {\r\n    if (runners[i].starttime < earliestStartSecs) {\r\n      earliestStartSecs = runners[i].starttime\r\n    }\r\n    if (runners[i].starttime + runners[i].x.length > latestFinishSecs) {\r\n      latestFinishSecs = runners[i].starttime + runners[i].x.length\r\n    }\r\n    if (runners[i].x.length > slowestTimeSecs) {\r\n      slowestTimeSecs = runners[i].x.length\r\n    }\r\n  }\r\n}\r\n\r\n// see if all runners have reached stop control and reset if they have\r\nfunction checkForStopControl(currentTime) {\r\n  // avoid problems when changing event with replay by control in progress\r\n  if (runners.length === 0) {\r\n    return\r\n  }\r\n\r\n  let allAtControl = true\r\n  // work out if everybody has got to the next control\r\n  for (let i = 0; i < runners.length; i += 1) {\r\n    const legTime = runners[i].splits[massStartControl + 1] - runners[i].splits[massStartControl]\r\n    if (legTime > currentTime) {\r\n      allAtControl = false\r\n      break\r\n    }\r\n  }\r\n  if (allAtControl) {\r\n    //move on to next control\r\n    massStartControl += 1\r\n    mapIsAligned = false\r\n    setByControlLabel(massStartControl)\r\n    setNextControlDetails()\r\n  }\r\n}\r\n\r\n// slider callback\r\nfunction clockSliderMoved(time) {\r\n  // setting attribute elsewhere triggers synchronous callback via dispatchEvent so best to filter out non-changes here\r\n  if (time !== animationSecs) {\r\n    setAnimationTime(time)\r\n  }\r\n}\r\n\r\nfunction createSpeedDropdown() {\r\n  let dropdown = document.getElementById(\"rg2-replay-speed-list\")\r\n  let html = \"\"\r\n  for (let i = 0; i < timeDeltas.length; i = i + 1) {\r\n    html += `<li class=\"dropdown-item\" data-speed=\"${timeDeltas[i]}\">${\"x\" + timeDeltas[i] / 100}</li>`\r\n  }\r\n  dropdown.innerHTML = html\r\n  document.getElementById(\"rg2-replay-speed-select\").addEventListener(\"hidden.bs.dropdown\", (e) => {\r\n    // only need to deal with close caused by a click on a new value\r\n    if (e.clickEvent) {\r\n      setReplaySpeed(parseInt(e.clickEvent.target.dataset.speed, 10))\r\n    }\r\n  })\r\n}\r\n\r\nexport function createByControlDropdown() {\r\n  let dropdown = document.getElementById(\"rg2-replay-start-control-list\")\r\n  // setting innerHTML doesn't seem to remove event handlers so need to do that here\r\n  // just gets ignored the first time the function is called\r\n  dropdown.removeEventListener(\"hidden.bs.dropdown\", handleReplayStartDropdown)\r\n  let html = \"\"\r\n  // find shortest set of splits being animated\r\n  let minSplitsLength = 9999\r\n  const controls = runners.reduce((minLength, r) => {\r\n    return Math.min(r.splits.length, minLength)\r\n  }, minSplitsLength)\r\n  // count includes the finish split which we need to ignore\r\n  for (let i = 0; i < controls - 1; i = i + 1) {\r\n    const control = i === 0 ? `<div>${startIcon}</div>` : i\r\n    html += `<li class=\"dropdown-item\" data-control=\"${i}\">${control}</li>`\r\n  }\r\n  dropdown.innerHTML = html\r\n  document\r\n    .getElementById(\"rg2-replay-start-control-select\")\r\n    .addEventListener(\"hidden.bs.dropdown\", handleReplayStartDropdown)\r\n}\r\n\r\nexport function createTailsDropdown() {\r\n  let dropdown = document.getElementById(\"rg2-tails-length-list\")\r\n  let html = \"\"\r\n  const tails = [\"0:00\", \"0:30\", \"1:00\", \"1:30\", \"2:00\", \"3:00\", t(\"Full tails\", \"\")]\r\n  const secs = [0, 30, 60, 90, 120, 180, \"Full\"]\r\n  for (let i = 0; i < tails.length; i = i + 1) {\r\n    html += `<li class=\"dropdown-item\" data-length=\"${secs[i]}\">${tails[i]}</li>`\r\n  }\r\n  dropdown.innerHTML = html\r\n  document.getElementById(\"rg2-tails-length-select\").addEventListener(\"hidden.bs.dropdown\", (e) => {\r\n    // only need to deal with close caused by a click on a new value\r\n    if (e.clickEvent) {\r\n      setTailsLength(e.clickEvent.target.dataset.length)\r\n    }\r\n  })\r\n}\r\n\r\nexport function drawAnimation() {\r\n  if (runners.length === 0) {\r\n    return\r\n  }\r\n  if (clockSlider) {\r\n    if (clockSlider.value !== animationSecs) {\r\n      clockSlider.value = animationSecs\r\n    }\r\n    const clock = document.getElementById(\"rg2-clock\")\r\n    clock.innerText = formatSecsAsHHMMSS(animationSecs)\r\n  }\r\n  let time = 0\r\n  for (let i = 0; i < runners.length; i += 1) {\r\n    const runner = runners[i]\r\n    let timeOffset = 0\r\n    if (realTime) {\r\n      timeOffset = runner.starttime\r\n    } else {\r\n      if (massStartControl === 0 || runner.splits.length < massStartControl) {\r\n        // no offset since we are starting from the start\r\n        timeOffset = 0\r\n      } else {\r\n        // offset needs to move forward (hence negative) to time at control\r\n        timeOffset = -1 * runner.splits[massStartControl]\r\n      }\r\n    }\r\n    ctx.strokeStyle = runner.trackColour\r\n    ctx.globalAlpha = options.perCentRouteIntensity / 100\r\n    ctx.lineWidth = options.routeWidth / Math.pow(ctx.displayScale, 0.5)\r\n    ctx.lineJoin = \"round\"\r\n    ctx.beginPath()\r\n    if (!mapIsAligned && !alignmentTimer && massStartControl > 0) {\r\n      // draw tails when using replay by control and all runners have reached the next control\r\n      const tailEnd = runner.splits[massStartControl]\r\n      let tailStart = Math.max(tailEnd - tailLength, runner.splits[massStartControl - 1])\r\n      ctx.moveTo(runner.x[tailStart], runner.y[tailStart])\r\n      for (let t = tailStart + 1; t <= tailEnd; t += 1) {\r\n        ctx.lineTo(runner.x[t], runner.y[t])\r\n      }\r\n    } else {\r\n      // draws tails in all other scenarios\r\n      // t runs as real time seconds or 0-based seconds depending on realTime\r\n      // runner.x[] is always indexed in 0-based time so needs to be adjusted for starttime offset\r\n      ctx.moveTo(runner.x[tailStartTimeSecs - timeOffset], runner.y[tailStartTimeSecs - timeOffset])\r\n      for (let t = tailStartTimeSecs; t < animationSecs; t += 1) {\r\n        if (t > timeOffset && t - timeOffset < runner.nextStopTime) {\r\n          ctx.lineTo(runner.x[t - timeOffset], runner.y[t - timeOffset])\r\n        }\r\n      }\r\n    }\r\n    ctx.stroke()\r\n    ctx.beginPath()\r\n    time = animationSecs\r\n    if (time - timeOffset < runner.nextStopTime) {\r\n      time = time - timeOffset\r\n    } else {\r\n      time = runner.nextStopTime\r\n    }\r\n    ctx.arc(\r\n      runner.x[time],\r\n      runner.y[time],\r\n      config.RUNNER_DOT_RADIUS / Math.pow(ctx.displayScale, 0.5),\r\n      0,\r\n      2 * Math.PI,\r\n      false\r\n    )\r\n    ctx.globalAlpha = config.FULL_INTENSITY\r\n    ctx.strokeStyle = config.BLACK\r\n    ctx.fillStyle = runner.trackColour\r\n    ctx.fill()\r\n    ctx.lineWidth = config.RUNNER_DOT_RADIUS / Math.pow(ctx.displayScale, 0.5) / 4\r\n    ctx.stroke()\r\n    drawName(runner, time)\r\n  }\r\n\r\n  showDistanceRun(time)\r\n  if (massStartByControl) {\r\n    checkForStopControl(animationSecs)\r\n  }\r\n}\r\n\r\nfunction drawName(runner, time) {\r\n  let text = \"\"\r\n  if (displayNames || displayInitials) {\r\n    // make sure we have a valid position to display\r\n    if (time < runner.x.length && time >= 0) {\r\n      ctx.fillStyle = runner.trackColour\r\n      ctx.strokeStyle = \"darkslategray\"\r\n      // empirically reasonable font scaling\r\n      ctx.font = options.replayFontSize / Math.pow(ctx.displayScale, 0.8) + \"pt Arial\"\r\n      ctx.globalAlpha = config.FULL_INTENSITY\r\n      ctx.textAlign = \"left\"\r\n      if (displayInitials) {\r\n        text = runner.initials\r\n      } else {\r\n        text = runner.name\r\n      }\r\n      ctx.save()\r\n      // centre map on runner location\r\n      ctx.translate(runner.x[time], runner.y[time])\r\n      // rotate map so that text stays horizontal\r\n      ctx.rotate(ctx.displayAngle)\r\n      // no real science: offsets just look OK\r\n      ctx.lineWidth = options.replayFontSize / Math.pow(ctx.displayScale, 0.8) / 8\r\n      const x = 2 + 8 / Math.pow(ctx.displayScale, 1)\r\n      const y = 2 + 4 / Math.pow(ctx.displayScale, 1)\r\n      ctx.strokeText(text, x, y)\r\n      ctx.fillText(text, x, y)\r\n      ctx.restore()\r\n    }\r\n  }\r\n}\r\n\r\nfunction getDistanceAtTime(idx, time) {\r\n  const cumDist = runners[idx].cumulativeDistance\r\n  let dist = time > cumDist.length - 1 ? cumDist[cumDist.length - 1] : cumDist[time]\r\n  if (dist === undefined) {\r\n    dist = 0\r\n  }\r\n  return dist\r\n}\r\n\r\nfunction getTrackNames(time) {\r\n  let tracks = []\r\n  for (let i = 0; i < runners.length; i += 1) {\r\n    let info = {}\r\n    info.trackColour = runners[i].trackColour\r\n    info.course = runners[i].coursename\r\n    info.name = runners[i].name\r\n    info.resultid = runners[i].resultid\r\n    info.rawid = runners[i].rawid\r\n    if (realTime) {\r\n      info.distance = getDistanceAtTime(i, animationSecs - runners[i].starttime)\r\n    } else {\r\n      info.distance = getDistanceAtTime(i, time)\r\n    }\r\n    info.distance += units\r\n    tracks.push(info)\r\n  }\r\n  // get all tracks displayed so we can add them if they are not animated as well\r\n  let extraTracks = getDisplayedTrackDetails()\r\n  for (let i = 0; i < extraTracks.length; i += 1) {\r\n    // add tracks not already in tracks list\r\n    if (\r\n      tracks.findIndex((track) => {\r\n        return track.resultid === extraTracks[i].resultid\r\n      }) === -1\r\n    ) {\r\n      let info = {}\r\n      info.trackColour = extraTracks[i].trackColour\r\n      info.course = extraTracks[i].course\r\n      info.name = extraTracks[i].name\r\n      info.resultid = extraTracks[i].resultid\r\n      info.rawid = extraTracks[i].rawid\r\n      info.distance = \"\"\r\n      tracks.push(info)\r\n    }\r\n  }\r\n  return tracks\r\n}\r\n\r\nfunction getTrackNamesHTML(tracks) {\r\n  if (tracks.length === 0) {\r\n    return \"\"\r\n  }\r\n  let html = \"\"\r\n  let oldCourse = \"\"\r\n  for (let i = 0; i < tracks.length; i += 1) {\r\n    if (oldCourse !== tracks[i].course) {\r\n      html += `<div></div><div><strong>${tracks[i].course}</strong></div><div></div>`\r\n      oldCourse = tracks[i].course\r\n    }\r\n    html += `<input type=\"color\" class=\"form-control form-control-color\" data-rawid=\"${tracks[i].rawid}\"`\r\n    html += ` value = \"${tracks[i].trackColour}\" ><div>${tracks[i].name}</div><div class=\"runner-distance text-end\"`\r\n    html += ` data-resultid=\"${tracks[i].resultid}\">${tracks[i].distance}</div>`\r\n  }\r\n  return html\r\n}\r\n\r\nfunction handleReplayStartDropdown(e) {\r\n  // only need to deal with close caused by a click on a new value\r\n  if (e.clickEvent) {\r\n    massStartControl = parseInt(e.clickEvent.target.dataset.control)\r\n    if (isNaN(massStartControl)) {\r\n      massStartControl = 0\r\n    }\r\n    mapIsAligned = false\r\n    setByControlLabel(massStartControl)\r\n    setNextControlDetails()\r\n    alignMapToAngle(massStartControl)\r\n    btnStartStop.innerHTML = waitIcon\r\n  }\r\n}\r\n\r\nfunction incrementAlignmentTime() {\r\n  if (alignments.length === 0) {\r\n    clearInterval(alignmentTimer)\r\n    alignmentTimer = null\r\n    mapIsAligned = true\r\n    btnStartStop.innerHTML = playIcon\r\n  } else {\r\n    const data = alignments.shift()\r\n    alignMap(data.angle, data.x, data.y, true, data.scale)\r\n  }\r\n  redraw()\r\n}\r\n\r\nexport function incrementAnimationTime() {\r\n  // only increment time if we haven't got to the end already\r\n  if (realTime) {\r\n    if (animationSecs < latestFinishSecs) {\r\n      milliSecs = Math.min(milliSecs + timeDelta, latestFinishSecs * 1000)\r\n    }\r\n  } else {\r\n    if (animationSecs < slowestTimeSecs) {\r\n      milliSecs = Math.min(milliSecs + timeDelta, slowestTimeSecs * 1000)\r\n    }\r\n  }\r\n  animationSecs = parseInt(milliSecs / 1000, 10)\r\n  // find earliest time we need to worry about when drawing screen\r\n  tailStartTimeSecs = Math.max(animationSecs - tailLength, startSecs + 1)\r\n  redraw()\r\n}\r\n\r\nexport function initialiseAnimationPanel() {\r\n  if (animationPanel) {\r\n    return\r\n  }\r\n  animationPanel = document.getElementById(\"rg2-animation-controls\")\r\n  const clock = document.getElementById(\"rg2-clock\")\r\n  clock.innerText = \"00:00:00\"\r\n\r\n  initialiseClockSlider(0, 0, 0)\r\n\r\n  createSpeedDropdown()\r\n  setReplaySpeed(timeDelta)\r\n\r\n  btnStartStop.addEventListener(\"click\", () => {\r\n    toggleAnimation()\r\n  })\r\n\r\n  const btnMassStart = document.getElementById(\"btn-mass-start\")\r\n  btnMassStart.addEventListener(\"click\", () => {\r\n    replayByControl.classList.add(\"d-none\")\r\n    setReplayMassStart()\r\n  })\r\n\r\n  const btnRealTime = document.getElementById(\"btn-real-time\")\r\n  btnRealTime.setAttribute(\"title\", t(\"Real time\", \"\"))\r\n  btnRealTime.addEventListener(\"click\", () => {\r\n    replayByControl.classList.add(\"d-none\")\r\n    setReplayRealTime()\r\n  })\r\n\r\n  const btnByControl = document.getElementById(\"btn-by-control\")\r\n  btnByControl.addEventListener(\"click\", () => {\r\n    setReplayByControl()\r\n    createByControlDropdown()\r\n    replayByControl.classList.remove(\"d-none\")\r\n  })\r\n\r\n  createTailsDropdown()\r\n\r\n  let options = document.querySelectorAll(\"[data-toggle-names]\")\r\n  for (let opt of options) {\r\n    opt.innerHTML = t(opt.dataset.toggleNames)\r\n    opt.addEventListener(\"click\", (e) => {\r\n      toggleNameDisplay(e.currentTarget.dataset.toggleNames)\r\n    })\r\n  }\r\n  document.getElementById(\"rg2-toggle-names-value\").setAttribute(\"title\", t(\"Show names\", \"\"))\r\n}\r\n\r\nfunction initialiseClockSlider(min, max, val) {\r\n  // avoid unnecessary reinitialisation\r\n  if (clockSlider && clockSlider.min === min && clockSlider.max === max && clockSlider.value === val) {\r\n    return\r\n  }\r\n  if (clockSlider) {\r\n    clockSlider.remove()\r\n  }\r\n  const clockSliderContainer = document.getElementById(\"rg2-clock-slider-container\")\r\n  const slider = document.createElement(\"tc-range-slider\")\r\n  slider.setAttribute(\"id\", \"rg2-clock-slider\")\r\n  slider.setAttribute(\"min\", min)\r\n  slider.setAttribute(\"max\", max)\r\n  slider.setAttribute(\"value\", val)\r\n  slider.setAttribute(\"step\", 1)\r\n  clockSliderContainer.append(slider)\r\n  clockSlider = document.getElementById(\"rg2-clock-slider\")\r\n  clockSlider.addEventListener(\"change\", (e) => {\r\n    clockSliderMoved(e.target.value)\r\n  })\r\n}\r\n\r\nexport function removeRunner(resultid) {\r\n  for (let i = 0; i < runners.length; i += 1) {\r\n    if (runners[i].resultid === resultid) {\r\n      // delete 1 runner at position i\r\n      runners.splice(i, 1)\r\n    }\r\n    // if this was the last runner then delete course details\r\n    if (runners.length === 0) {\r\n      course = {}\r\n    }\r\n  }\r\n  updateAnimationDetails()\r\n}\r\n\r\n// called before a new event is loaded\r\nexport function resetAnimation() {\r\n  runners.length = 0\r\n  course = {}\r\n  timeDelta = 3000\r\n  animationSecs = 0\r\n  milliSecs = 0\r\n  realTime = false\r\n  earliestStartSecs = 0\r\n  latestFinishSecs = 0\r\n  tailLength = 60\r\n  tailStartTimeSecs = 0\r\n  massStartControl = 0\r\n  massStartByControl = false\r\n  displayNames = false\r\n  displayInitials = true\r\n  startSecs = 0\r\n  slowestTimeSecs = 0\r\n  clearInterval(timer)\r\n  timer = null\r\n  updateAnimationDetails()\r\n  btnStartStop.innerHTML = playIcon\r\n  trackNames.classList.add(\"d-none\")\r\n}\r\n\r\n// needed if you run replay by control and then switch back to something else\r\nfunction resetNextStopTime() {\r\n  runners.forEach((r) => (r.nextStopTime = config.VERY_HIGH_TIME_IN_SECS))\r\n}\r\n\r\nexport function resultIsBeingAnimated(resultid) {\r\n  // is given result in the array of animated runners?\r\n  return runners.findIndex((runner) => runner.resultid === resultid) > -1\r\n}\r\n\r\nfunction setAnimationTime(time) {\r\n  units = getLengthUnits()\r\n  // if we got a non-0 time it was from the slider so use it\r\n  // otherwise reset to base time\r\n  let max = 0\r\n  if (realTime) {\r\n    if (time > 0) {\r\n      animationSecs = time\r\n    } else {\r\n      animationSecs = earliestStartSecs\r\n    }\r\n    max = latestFinishSecs\r\n    startSecs = earliestStartSecs\r\n  } else {\r\n    if (time > 0) {\r\n      animationSecs = time\r\n    } else {\r\n      animationSecs = 0\r\n    }\r\n    max = slowestTimeSecs\r\n    startSecs = 0\r\n  }\r\n  milliSecs = animationSecs * 1000\r\n  if (time === 0) {\r\n    initialiseClockSlider(startSecs, max, animationSecs)\r\n  }\r\n  redraw()\r\n}\r\n\r\nfunction setByControlLabel(control) {\r\n  document.getElementById(\"rg2-replay-start-control\").innerHTML = control === 0 ? startIcon : control\r\n}\r\n\r\nfunction setNextControlDetails() {\r\n  let minSplitsLength = 9999\r\n  // not all runners have the same number of controls\r\n  // since they may be on different courses or a score course\r\n  minSplitsLength = runners.reduce((minLength, r) => {\r\n    return Math.min(r.splits.length, minLength)\r\n  }, minSplitsLength)\r\n  // splits array contains entries for S, controls and F\r\n  // stop replaying once we have got to F\r\n  if (massStartControl > minSplitsLength) {\r\n    massStartControl = 0\r\n  }\r\n  // find time at next control\r\n  for (let i = 0; i < runners.length; i += 1) {\r\n    // splits includes a start time so index to control is + 1\r\n    // also need to allow for runners on different courses so not\r\n    // all runners have same number of controls\r\n    if (massStartControl + 1 < runners[i].splits.length) {\r\n      runners[i].nextStopTime = runners[i].splits[massStartControl + 1]\r\n    } else {\r\n      runners[i].nextStopTime = config.VERY_HIGH_TIME_IN_SECS\r\n    }\r\n  }\r\n  setAnimationTime(0)\r\n  // stop animation and wait for next leg\r\n  stopAnimation()\r\n  redraw()\r\n}\r\n\r\n// callback when user selects replay by control\r\nfunction setReplayByControl() {\r\n  // disable slider since moving it during replay by control is open to interpretation\r\n  document.getElementById(\"rg2-clock-slider\").setAttribute(\"disabled\", \"\")\r\n  realTime = false\r\n  // default to 0 (start) until user selects another control\r\n  massStartControl = 0\r\n  massStartByControl = true\r\n  mapIsAligned = false\r\n  setByControlLabel(massStartControl)\r\n  setNextControlDetails()\r\n}\r\n\r\nfunction setReplayMassStart() {\r\n  realTime = false\r\n  massStartByControl = false\r\n  massStartControl = 0\r\n  resetNextStopTime()\r\n  setAnimationTime(0)\r\n  clockSlider.removeAttribute(\"disabled\")\r\n}\r\n\r\nfunction setReplayRealTime() {\r\n  realTime = true\r\n  massStartByControl = false\r\n  massStartControl = 0\r\n  resetNextStopTime()\r\n  setAnimationTime(0)\r\n  clockSlider.removeAttribute(\"disabled\")\r\n}\r\n\r\nfunction setReplaySpeed(speed) {\r\n  if (isNaN(speed)) {\r\n    speed = 1000\r\n  }\r\n  timeDelta = speed\r\n  document.getElementById(\"rg2-replay-speed\").innerText = \"x\" + speed / 100\r\n}\r\n\r\nfunction setRunnerColor(rawid, trackColour) {\r\n  // set colour for runners already selected\r\n  for (let i = 0; i < runners.length; i += 1) {\r\n    if (runners[i].rawid === rawid) {\r\n      runners[i].userColour = trackColour\r\n      runners[i].trackColour = trackColour\r\n    }\r\n  }\r\n  // and save colour for next time runner is selected\r\n  setResultColour(rawid, trackColour)\r\n}\r\n\r\nfunction setTailsLength(value) {\r\n  if (value === \"Full\") {\r\n    tailLength = config.VERY_HIGH_TIME_IN_SECS\r\n  } else {\r\n    tailLength = parseInt(value, 10)\r\n  }\r\n  calculateAnimationRange()\r\n  redraw()\r\n}\r\n\r\nfunction showDistanceRun(time) {\r\n  const names = getTrackNames(time)\r\n  if (names.length === 0) {\r\n    return\r\n  }\r\n  const runners = document.querySelectorAll(\".track-names .runner-distance\")\r\n  if (runners) {\r\n    runners.forEach((runner) => {\r\n      const resultid = parseInt(runner.dataset.resultid)\r\n      const idx = names.findIndex((name) => {\r\n        return name.resultid === resultid\r\n      })\r\n      if (idx > -1) {\r\n        runner.innerText = names[idx].distance\r\n      }\r\n    })\r\n  }\r\n}\r\n\r\nfunction startAnimation() {\r\n  if (timer === null) {\r\n    timer = setInterval(() => {\r\n      incrementAnimationTime()\r\n    }, timerInterval)\r\n  }\r\n  btnStartStop.innerHTML = pauseIcon\r\n}\r\n\r\nfunction stopAnimation() {\r\n  clearInterval(timer)\r\n  timer = null\r\n  btnStartStop.innerHTML = playIcon\r\n}\r\n\r\nfunction toggleAnimation() {\r\n  if (timer === null) {\r\n    // only align replay by control for now\r\n    // may also decide to make this user-configurable\r\n    if (massStartByControl) {\r\n      // if timer is running then we are doing alignment already\r\n      if (!mapIsAligned && alignmentTimer === null) {\r\n        alignMapToAngle(massStartControl)\r\n        btnStartStop.innerHTML = waitIcon\r\n      }\r\n    } else {\r\n      mapIsAligned = true\r\n    }\r\n\r\n    if (mapIsAligned) {\r\n      startAnimation()\r\n    }\r\n  } else {\r\n    stopAnimation()\r\n  }\r\n}\r\n\r\nfunction toggleNameDisplay(value) {\r\n  document.getElementById(\"rg2-toggle-names-value\").setAttribute(\"title\", t(value, \"\"))\r\n  switch (value) {\r\n    case \"Show names\":\r\n      displayNames = true\r\n      displayInitials = false\r\n      break\r\n    case \"Show initials\":\r\n      displayNames = false\r\n      displayInitials = true\r\n      break\r\n    default:\r\n      displayNames = false\r\n      displayInitials = false\r\n      break\r\n  }\r\n  redraw()\r\n}\r\n\r\nfunction updateAnimationDetails() {\r\n  initialiseAnimationPanel()\r\n  updateTrackNames()\r\n  if (runners.length > 0) {\r\n    animationPanel.classList.remove(\"d-none\")\r\n    btnRunners.classList.remove(\"d-none\")\r\n  } else {\r\n    animationPanel.classList.add(\"d-none\")\r\n    btnRunners.classList.add(\"d-none\")\r\n  }\r\n  resizePanels()\r\n  calculateAnimationRange()\r\n  setAnimationTime(0)\r\n}\r\n\r\nexport function updateTrackNames() {\r\n  const names = getTrackNames(animationSecs)\r\n  if (names.length > 0) {\r\n    trackNamesBody.innerHTML = getTrackNamesHTML(names)\r\n    const colorSelects = document.querySelectorAll(\".track-names input\")\r\n    colorSelects.forEach((color) => {\r\n      color.addEventListener(\"input\", (e) => {\r\n        setRunnerColor(parseInt(e.target.dataset.rawid, 10), e.target.value)\r\n        redraw()\r\n      })\r\n    })\r\n    trackNames.classList.remove(\"d-none\")\r\n  } else {\r\n    trackNamesBody.innerHTML = \"\"\r\n    trackNames.classList.add(\"d-none\")\r\n  }\r\n  return names.length\r\n}\r\n","import { getDistanceBetweenPoints } from \"./utils\"\r\nimport { redraw } from \"./canvas\"\r\nimport interact from \"interactjs\"\r\nimport { t } from \"./translate\"\r\nimport { getActiveEventID, getMetresPerPixel } from \"./events\"\r\n\r\nexport class Overlay {\r\n  constructor(ctx) {\r\n    this.ctx = ctx\r\n    this.measuring = false\r\n    this.dragging = false\r\n    this.colours = [\"#ff00ff\", \"#0000ff\", \"#00ff00\", \"#ff0000\", \"#00ffff\"]\r\n    this.colourIndex = 0\r\n    // array of completed overlays\r\n    this.overlays = []\r\n    // overlay being drawn or not yet started\r\n    this.currentOverlay = this.initialiseOverlay()\r\n    this.units = \"px\"\r\n    this.metresPerPixel = 1\r\n    // empirical settings\r\n    this.dotSize = 5\r\n    this.lineWidth = 3\r\n    this.measureDialog = document.getElementById(\"rg2-measure-dialog\")\r\n    document.getElementById(\"btn-measure\").addEventListener(\"click\", () => {\r\n      if (getActiveEventID() === null) {\r\n        return\r\n      }\r\n      document.getElementById(\"rg2-map-canvas\").style.cursor = \"crosshair\"\r\n      this.measureDialog.classList.remove(\"d-none\")\r\n      this.measuring = true\r\n      this.createMeasureDialog()\r\n      redraw()\r\n    })\r\n\r\n    document.getElementById(\"btn-close-measure-dialog\").addEventListener(\"click\", () => {\r\n      this.measuring = false\r\n      this.measureDialog.classList.add(\"d-none\")\r\n      document.getElementById(\"rg2-map-canvas\").style.cursor = \"auto\"\r\n      redraw()\r\n    })\r\n\r\n    document.getElementById(\"btn-measure\").addEventListener(\"click\", () => {\r\n      document.getElementById(\"rg2-map-canvas\").style.cursor = \"crosshair\"\r\n      this.measureDialog.classList.remove(\"d-none\")\r\n      this.measuring = true\r\n      this.createMeasureDialog()\r\n      redraw()\r\n    })\r\n\r\n    //  allow dialog to be moved\r\n    let position = { x: 0, y: 0 }\r\n    interact(this.measureDialog).draggable({\r\n      inertia: true,\r\n      listeners: {\r\n        move(e) {\r\n          position.x += e.dx\r\n          position.y += e.dy\r\n          e.target.style.transform = `translate(${position.x}px, ${position.y}px)`\r\n        }\r\n      },\r\n      modifiers: [\r\n        interact.modifiers.restrictRect({\r\n          restriction: \"#rg2-container\"\r\n        })\r\n      ]\r\n    })\r\n    this.createMeasureDialog()\r\n  }\r\n\r\n  calculateLength(x, y) {\r\n    if (x.length < 2) {\r\n      return 0\r\n    }\r\n    let length = 0\r\n    for (let i = 1; i < x.length; i += 1) {\r\n      length = length + getDistanceBetweenPoints(x[i - 1], y[i - 1], x[i], y[i])\r\n    }\r\n    return length\r\n  }\r\n\r\n  closeEnough(x1, y1, x2, y2) {\r\n    const range = 10\r\n    if (Math.abs(x1 - x2) < range) {\r\n      if (Math.abs(y1 - y2) < range) {\r\n        return true\r\n      }\r\n    }\r\n    return false\r\n  }\r\n\r\n  createMeasureDialog() {\r\n    this.metresPerPixel = getMetresPerPixel()\r\n    if (this.metresPerPixel === undefined) {\r\n      this.metresPerPixel = 1\r\n      this.units = \"px\"\r\n    } else {\r\n      this.units = \"m\"\r\n    }\r\n    let details = \"\"\r\n    for (let i = 0; i < this.overlays.length; i += 1) {\r\n      details = details + this.formatOverlay(this.overlays[i], true)\r\n    }\r\n    details = details + this.formatOverlay(this.currentOverlay, false)\r\n    // show \"delete all\" if at least two exist\r\n    if (this.overlays.length > 1) {\r\n      details += `<div>${t(\"All\")}</div><div></div><div></div>`\r\n      details += `<div><i class='delete-all-overlays bi-trash'></i></div>`\r\n    }\r\n    document.querySelector(\".rg2-overlay-table\").innerHTML = details\r\n    let deleteOverlay = document.getElementsByClassName(\"delete-overlay\")\r\n    for (let ol of deleteOverlay) {\r\n      ol.addEventListener(\"click\", (e) => {\r\n        this.deleteOverlay(parseInt(e.target.id, 10))\r\n      })\r\n    }\r\n    let deleteAllOverlays = document.getElementsByClassName(\"delete-all-overlays\")\r\n    for (let ol of deleteAllOverlays) {\r\n      ol.addEventListener(\"click\", (e) => {\r\n        this.deleteAllOverlays(parseInt(e.target.id, 10))\r\n      })\r\n    }\r\n    let endOverlay = document.getElementsByClassName(\"end-overlay\")\r\n    for (let ol of endOverlay) {\r\n      ol.addEventListener(\"click\", (e) => {\r\n        this.endOverlay(parseInt(e.target.id, 10))\r\n      })\r\n    }\r\n  }\r\n\r\n  deleteAllOverlays() {\r\n    this.overlays.length = 0\r\n    this.currentOverlay = this.initialiseOverlay()\r\n    this.updateOverlays()\r\n    this.createMeasureDialog()\r\n    redraw()\r\n  }\r\n\r\n  deleteOverlay(idx) {\r\n    this.overlays.splice(idx, 1)\r\n    this.updateOverlays()\r\n    this.createMeasureDialog()\r\n    redraw()\r\n  }\r\n\r\n  dragEnded() {\r\n    //console.log(\"Drag ended\")\r\n    this.dragging = false\r\n  }\r\n\r\n  drawSingleOverlay(ol, finished) {\r\n    this.ctx.strokeStyle = ol.colour\r\n    this.ctx.fillStyle = ol.colour\r\n    // draw lines\r\n    this.ctx.beginPath()\r\n    this.ctx.moveTo(ol.x[0], ol.y[0])\r\n    for (let i = 1; i < ol.x.length; i += 1) {\r\n      this.ctx.lineTo(ol.x[i], ol.y[i])\r\n    }\r\n    this.ctx.stroke()\r\n    // draw dots\r\n    for (let i = 0; i < ol.x.length; i += 1) {\r\n      this.ctx.beginPath()\r\n      this.ctx.arc(ol.x[i], ol.y[i], this.dotSize, 0, 2 * Math.PI, false)\r\n      if (finished) {\r\n        this.ctx.fill()\r\n      } else {\r\n        this.ctx.stroke()\r\n      }\r\n    }\r\n  }\r\n\r\n  drawOverlays() {\r\n    // only draw if measuring dialog is open\r\n    if (!this.measuring) {\r\n      return\r\n    }\r\n    this.ctx.lineWidth = this.lineWidth\r\n    this.ctx.globalAlpha = 0.6\r\n    // draw completed overlays\r\n    if (this.overlays.length > 0) {\r\n      for (let j = 0; j < this.overlays.length; j += 1) {\r\n        this.drawSingleOverlay(this.overlays[j], true)\r\n      }\r\n    }\r\n    // draw overlay in progress\r\n    if (this.currentOverlay.started) {\r\n      if (this.currentOverlay.x.length === 1) {\r\n        // only one point so draw ring to mark start\r\n        this.ctx.strokeStyle = this.currentOverlay.colour\r\n        this.ctx.fillStyle = this.currentOverlay.colour\r\n        this.ctx.beginPath()\r\n        this.ctx.arc(this.currentOverlay.x[0], this.currentOverlay.y[0], this.dotSize, 0, 2 * Math.PI, false)\r\n        this.ctx.stroke()\r\n      } else {\r\n        this.drawSingleOverlay(this.currentOverlay, false)\r\n      }\r\n    }\r\n  }\r\n\r\n  endOverlay() {\r\n    this.currentOverlay.idx = this.overlays.length\r\n    this.overlays.push(this.currentOverlay)\r\n    this.currentOverlay = this.initialiseOverlay()\r\n    this.createMeasureDialog()\r\n  }\r\n\r\n  formatOverlay(ol, completed) {\r\n    let html = \"\"\r\n    let completedDiv = \"\"\r\n    let startedDiv = \"\"\r\n    if (ol.started) {\r\n      startedDiv = `<div>${parseInt(ol.length, 10)}${this.units}</div>`\r\n    } else {\r\n      startedDiv = `<div></div>`\r\n    }\r\n\r\n    if (completed) {\r\n      completedDiv = `<div><i class='delete-overlay bi-trash' id=\"${ol.idx}\"></i></div>`\r\n    } else {\r\n      if (ol.started) {\r\n        completedDiv = `<div><i class='end-overlay bi-save' id=\"${ol.idx}\"></i></div>`\r\n      } else {\r\n        completedDiv = `<div></div>`\r\n      }\r\n    }\r\n    html += `<div>${ol.id}</div><div class='overlay-bar' style='--overlay-colour:${ol.colour};'></div>`\r\n    html += `${startedDiv}${completedDiv}`\r\n    return html\r\n  }\r\n\r\n  getNextColour() {\r\n    this.colourIndex = (this.colourIndex + 1) % this.colours.length\r\n    return this.colours[this.colourIndex]\r\n  }\r\n\r\n  initialiseOverlay() {\r\n    const ol = {}\r\n    // ids start at A\r\n    ol.id = String.fromCharCode(this.overlays.length + 65)\r\n    ol.colour = this.getNextColour()\r\n    ol.x = []\r\n    ol.y = []\r\n    ol.length = 0\r\n    ol.started = false\r\n    ol.idx = undefined\r\n    return ol\r\n  }\r\n\r\n  mouseDrag(from, to) {\r\n    // return value indicates if we handled the move or not\r\n    if (!this.measuring) {\r\n      return false\r\n    }\r\n    if (!this.dragging) {\r\n      for (let i = 0; i < this.overlays.length; i += 1) {\r\n        for (let j = 0; j < this.overlays[i].x.length; j += 1) {\r\n          if (this.closeEnough(from.x, from.y, this.overlays[i].x[j], this.overlays[i].y[j])) {\r\n            this.dragging = true\r\n            this.dragOverlay = i\r\n            this.dragPoint = j\r\n          }\r\n        }\r\n      }\r\n    }\r\n    if (this.dragging) {\r\n      this.overlays[this.dragOverlay].x[this.dragPoint] = parseInt(to.x, 10)\r\n      this.overlays[this.dragOverlay].y[this.dragPoint] = parseInt(to.y, 10)\r\n      this.overlays[this.dragOverlay].length =\r\n        this.calculateLength(this.overlays[this.dragOverlay].x, this.overlays[this.dragOverlay].y) * this.metresPerPixel\r\n      this.createMeasureDialog()\r\n      //redraw()\r\n      return true\r\n    }\r\n    return false\r\n  }\r\n\r\n  mouseUp(x, y) {\r\n    if (!this.measuring) {\r\n      return\r\n    }\r\n    this.dragging = false\r\n    if (!this.currentOverlay.started) {\r\n      this.startOverlay()\r\n    }\r\n    // double click so  treat as an end to drawing\r\n    if (\r\n      x === this.currentOverlay.x[this.currentOverlay.x.length - 1] &&\r\n      y === this.currentOverlay.y[this.currentOverlay.x.length - 1]\r\n    ) {\r\n      this.endOverlay()\r\n    } else {\r\n      this.currentOverlay.x.push(x)\r\n      this.currentOverlay.y.push(y)\r\n      this.currentOverlay.length =\r\n        this.calculateLength(this.currentOverlay.x, this.currentOverlay.y) * this.metresPerPixel\r\n      this.createMeasureDialog()\r\n      redraw()\r\n    }\r\n  }\r\n\r\n  startOverlay() {\r\n    this.currentOverlay.started = true\r\n    this.createMeasureDialog()\r\n  }\r\n\r\n  updateOverlays() {\r\n    this.colourIndex = 0\r\n    // recolour and reallocate labels starting from A after deletion\r\n    for (let i = 0; i < this.overlays.length; i += 1) {\r\n      this.overlays[i].id = String.fromCharCode(i + 65)\r\n      this.overlays[i].idx = i\r\n      this.overlays[i].colour = this.getNextColour()\r\n    }\r\n    this.currentOverlay.id = String.fromCharCode(this.overlays.length + 65)\r\n    this.currentOverlay.idx = this.overlays.length\r\n    this.currentOverlay.colour = this.getNextColour()\r\n  }\r\n}\r\n","import { drawAnimation } from \"./animation\"\r\nimport { config, options } from \"./config\"\r\nimport { controls, drawCourses } from \"./courses\"\r\nimport { adjustTrack, dragEnded, drawNewTrack, gpsFileLoaded, mouseUp } from \"./draw\"\r\nimport { getActiveEventID } from \"./events\"\r\nimport { Overlay } from \"./overlay\"\r\nimport { drawTracks } from \"./results\"\r\nimport { getActiveTab } from \"./rg2ui\"\r\nimport { t } from \"./translate\"\r\nimport { getDistanceBetweenPoints, showWarningDialog } from \"./utils\"\r\n\r\nlet canvas = document.getElementById(\"rg2-map-canvas\")\r\nexport let ctx = canvas.getContext(\"2d\")\r\nctx.displayAngle = 0\r\nctx.displayScale = 1\r\nlet map = new Image()\r\nlet overlay = new Overlay(ctx)\r\nlet input = {\r\n  dragStart: null,\r\n  // looks odd but this works for initialisation\r\n  dragged: true,\r\n  scaleFactor: 1.1,\r\n  pinched: false\r\n}\r\nlet savedRedraws = 0\r\nlet redrawTimerID = undefined\r\ndocument.getElementById(\"rg2-load-progress\").classList.add(\"d-none\")\r\ndocument.getElementById(\"rg2-map-load-progress\").classList.add(\"d-none\")\r\n\r\nfunction addListeners() {\r\n  canvas.addEventListener(\"touchstart\", handleTouchStart, false)\r\n  canvas.addEventListener(\"touchmove\", handleTouchMove, false)\r\n  canvas.addEventListener(\"touchend\", handleTouchEnd, false)\r\n  canvas.addEventListener(\"DOMMouseScroll\", handleScroll, false)\r\n  canvas.addEventListener(\"wheel\", handleScroll, false)\r\n  canvas.addEventListener(\"mousedown\", handleMouseDown, false)\r\n  canvas.addEventListener(\"mousemove\", handleMouseMove, false)\r\n  canvas.addEventListener(\"mouseup\", handleMouseUp, false)\r\n\r\n  map.addEventListener(\"load\", () => mapLoadedCallback())\r\n  let btn = document.getElementById(\"btn-zoom-in\")\r\n  btn.addEventListener(\"click\", () => zoom(1))\r\n\r\n  btn = document.getElementById(\"btn-zoom-out\")\r\n  btn.addEventListener(\"click\", () => zoom(-1))\r\n\r\n  btn = document.getElementById(\"btn-rotate-left\")\r\n  btn.addEventListener(\"click\", () => rotateMap(-1))\r\n\r\n  btn = document.getElementById(\"btn-rotate-right\")\r\n  btn.addEventListener(\"click\", () => rotateMap(1))\r\n\r\n  btn = document.getElementById(\"btn-reset\")\r\n  btn.addEventListener(\"click\", () => resetMapState())\r\n}\r\n\r\nexport function alignMap(angle, x, y, moveMap = true, scale = 1) {\r\n  // align to an absolute angle: 0 is up/north\r\n  // rotate around defined x, y\r\n  applyMapRotation((ctx.displayAngle - angle) % (Math.PI * 2), x, y, moveMap, scale)\r\n}\r\n\r\nfunction applyMapRotation(angle, x, y, moveMap, scale) {\r\n  // save new absolute angle\r\n  ctx.displayAngle = (ctx.displayAngle - angle) % (Math.PI * 2)\r\n  // rotate around given co-ordinates\r\n  ctx.translate(x, y)\r\n  ctx.rotate(angle)\r\n  if (scale !== 1) {\r\n    ctx.scale(scale, scale)\r\n    ctx.displayScale = ctx.displayScale * scale\r\n  }\r\n  if (moveMap) {\r\n    // move map so that given point is centre-bottom of screen\r\n    const pt = getCentreBottom()\r\n    ctx.translate(pt.x - x, pt.y - y)\r\n  } else {\r\n    // put map back where it started\r\n    ctx.translate(-1 * x, -1 * y)\r\n  }\r\n  redraw()\r\n}\r\n\r\nfunction drawDefaultText() {\r\n  if (!config.managing() && window.innerWidth >= config.BIG_SCREEN_BREAK_POINT) {\r\n    ctx.font = \"16pt Arial\"\r\n    ctx.textAlign = \"center\"\r\n    ctx.fillStyle = config.BLACK\r\n    const pt = ctx.transformedPoint(canvas.width / 2, canvas.height / 2)\r\n    ctx.fillText(\"Routegadget 2 Version \" + config.RG2VERSION, pt.x, pt.y)\r\n  }\r\n}\r\n\r\nexport function getCentreBottom() {\r\n  const controlsHeight = document.getElementById(\"rg2-animation-controls\").offsetHeight\r\n  return ctx.transformedPoint(canvas.width / 2, (canvas.height - controlsHeight) * 0.85)\r\n}\r\n\r\nexport function getCentreTop() {\r\n  const controlsHeight = document.getElementById(\"rg2-animation-controls\").offsetHeight\r\n  return ctx.transformedPoint(canvas.width / 2, (canvas.height - controlsHeight) * 0.15)\r\n}\r\n\r\nexport function getMapSize() {\r\n  return { height: map.height, width: map.width }\r\n}\r\n\r\nfunction handleInputDown(e) {\r\n  input.dragStart = ctx.transformedPoint(input.lastX, input.lastY)\r\n  input.dragged = false\r\n  // need to cache this here since IE and FF don't set it for mousemove events\r\n  input.whichButton = e.which\r\n}\r\n\r\nfunction handleInputMove() {\r\n  if (input.dragStart) {\r\n    const to = ctx.transformedPoint(input.lastX, input.lastY)\r\n    to.x = Math.round(to.x)\r\n    to.y = Math.round(to.y)\r\n    const from = { x: Math.round(input.dragStart.x), y: Math.round(input.dragStart.y) }\r\n    const button = input.whichButton\r\n    // simple debounce so that very small drags are treated as clicks instead\r\n    if (Math.abs(to.x - from.x) + Math.abs(to.y - from.y) > 5) {\r\n      if (gpsFileLoaded()) {\r\n        adjustTrack(from, to, button)\r\n      } else {\r\n        if (getActiveTab() === config.TAB_CREATE) {\r\n          rg2Config.manager.adjustManagerControls(from, to, button)\r\n        } else {\r\n          const overlayDragged = overlay.mouseDrag(from, to)\r\n          if (!overlayDragged) {\r\n            ctx.translate(to.x - input.dragStart.x, to.y - input.dragStart.y)\r\n          }\r\n        }\r\n      }\r\n      input.dragged = true\r\n      redraw()\r\n    }\r\n  }\r\n}\r\n\r\nfunction handleInputUp(e) {\r\n  // console.log(\"Up\", e.pageX, e.pageY, e)\r\n  const activeTab = getActiveTab()\r\n  if (!input.dragged) {\r\n    if (activeTab === config.TAB_CREATE) {\r\n      const x = Math.round(input.dragStart.x)\r\n      const y = Math.round(input.dragStart.y)\r\n      rg2Config.manager.managerMouseUp(x, y)\r\n    } else {\r\n      // pass button that was clicked\r\n      if (activeTab === config.TAB_DRAW) {\r\n        mouseUp(Math.round(input.dragStart.x), Math.round(input.dragStart.y), e.which)\r\n      } else {\r\n        // on results or courses tab\r\n        overlay.mouseUp(Math.round(input.dragStart.x), Math.round(input.dragStart.y))\r\n      }\r\n    }\r\n  } else {\r\n    if (activeTab === config.TAB_CREATE) {\r\n      rg2Config.manager.managerDragEnded()\r\n    } else {\r\n      if (activeTab === config.TAB_DRAW) {\r\n        dragEnded()\r\n      } else {\r\n        // on results or courses tab\r\n        overlay.dragEnded()\r\n      }\r\n    }\r\n  }\r\n  input.dragStart = null\r\n  redraw()\r\n}\r\n\r\nfunction handleMouseDown(e) {\r\n  saveMouseEvent(e)\r\n  handleInputDown(e)\r\n  e.stopPropagation()\r\n  return e.preventDefault()\r\n}\r\n\r\nfunction handleMouseMove(e) {\r\n  saveMouseEvent(e)\r\n  handleInputMove(e)\r\n  e.stopPropagation()\r\n  return e.preventDefault()\r\n}\r\n\r\nfunction handleMouseUp(e) {\r\n  handleInputUp(e)\r\n  e.stopPropagation()\r\n  return e.preventDefault()\r\n}\r\n\r\nfunction handleScroll(e) {\r\n  // console.log(e)\r\n  const delta = e.wheelDelta ? e.wheelDelta / 40 : e.detail ? -e.detail : 0\r\n  if (delta) {\r\n    zoom(delta)\r\n  }\r\n  e.stopPropagation()\r\n  return e.preventDefault()\r\n}\r\n\r\nfunction handleTouchEnd(e) {\r\n  // console.log(\"Touch end \", e)\r\n  handleInputUp(e)\r\n  input.pinched = false\r\n}\r\n\r\nfunction handleTouchMove(e) {\r\n  // console.log(\"Touch move \", e)\r\n  if (e.touches.length > 1) {\r\n    if (!input.pinched) {\r\n      savePinchInfo(e)\r\n    }\r\n  } else {\r\n    input.pinched = false\r\n  }\r\n  if (input.pinched && e.touches.length > 1) {\r\n    input.pinchEnd0 = ctx.transformedPoint(e.touches[0].pageX, e.touches[0].pageY)\r\n    input.pinchEnd1 = ctx.transformedPoint(e.touches[1].pageX, e.touches[1].pageY)\r\n    const oldDistance = getDistanceBetweenPoints(\r\n      input.pinchStart0.x,\r\n      input.pinchStart0.y,\r\n      input.pinchStart1.x,\r\n      input.pinchStart1.y\r\n    )\r\n    const newDistance = getDistanceBetweenPoints(\r\n      input.pinchEnd0.x,\r\n      input.pinchEnd0.y,\r\n      input.pinchEnd1.x,\r\n      input.pinchEnd1.y\r\n    )\r\n    // console.log (\"Pinch distance\", oldDistance / newDistance)\r\n    if (oldDistance / newDistance > 1.1) {\r\n      zoom(-1)\r\n      input.pinchStart0 = input.pinchEnd0\r\n      input.pinchStart1 = input.pinchEnd1\r\n    } else if (oldDistance / newDistance < 0.9) {\r\n      zoom(1)\r\n      input.pinchStart0 = input.pinchEnd0\r\n      input.pinchStart1 = input.pinchEnd1\r\n    }\r\n  } else {\r\n    input.lastX = e.touches[0].pageX\r\n    input.lastY = e.touches[0].pageY\r\n    handleInputMove(e)\r\n  }\r\n}\r\n\r\n// homegrown touch handling: seems no worse than adding some other library in\r\n// pinch zoom is primitive but works\r\nfunction handleTouchStart(e) {\r\n  // console.log(\"Touch start\", e)\r\n  e.preventDefault()\r\n  if (e.touches.length > 1) {\r\n    savePinchInfo(e)\r\n  }\r\n  input.lastX = e.touches[0].pageX\r\n  input.lastY = e.touches[0].pageY\r\n  handleInputDown(e)\r\n}\r\n\r\nexport function initialiseCanvas() {\r\n  addListeners()\r\n  trackTransforms(ctx)\r\n  resizeCanvas()\r\n}\r\n\r\nexport function loadNewMap(mapFile, isBeingCreated = false) {\r\n  document.getElementById(\"rg2-map-load-progress-label\").textContent = t(\"Loading map\", \"\")\r\n  document.getElementById(\"rg2-map-load-progress\").classList.remove(\"d-none\")\r\n  map.onerror = () => {\r\n    // probably a 404: should only really happen in testing\r\n    // clear loading indicator\r\n    document.getElementById(\"rg2-map-load-progress\").classList.add(\"d-none\")\r\n    showWarningDialog(\"Map load error\", \"The map for this event could not be loaded.\")\r\n  }\r\n  // setting src on an Image automatically triggers a request to load the map\r\n  // if this is a new map being created by the manager then just use the name we got\r\n  // else we are loading an existing map from the server\r\n  // adding date forces reload from server and avoids all sorts of caching problems with images\r\n  map.src = isBeingCreated ? mapFile : mapFile + \"?\" + Date.now()\r\n}\r\n\r\nfunction mapLoadedCallback() {\r\n  document.getElementById(\"rg2-map-load-progress\").classList.add(\"d-none\")\r\n  resetMapState()\r\n  if (config.managing()) {\r\n    rg2Config.manager.managerMapLoadCallback()\r\n  }\r\n}\r\n\r\n// called whenever anything changes enough to need screen redraw\r\nexport function redraw() {\r\n  // timer used to debounce redraw for significant performance improvement\r\n  // if timer not running then schedule a redraw\r\n  if (redrawTimerID === undefined) {\r\n    // console.log(savedRedraws + \" saved redraws\")\r\n    savedRedraws = 0\r\n    redrawTimerID = setTimeout(() => {\r\n      redrawTimerID = undefined\r\n      doRedraw()\r\n    }, 50)\r\n  } else {\r\n    // timer is already running so redraw will happen when timer expires\r\n    savedRedraws = savedRedraws + 1\r\n  }\r\n}\r\n\r\nfunction doRedraw() {\r\n  // console.time(\"redraw\")\r\n  // Clear the entire canvas\r\n  // first save current transformed state\r\n  ctx.save()\r\n  // reset everything back to initial size/state/orientation\r\n  ctx.setTransform(1, 0, 0, 1, 0, 0)\r\n  // fill canvas to erase things: clearRect doesn't work on Android (?) and leaves the old map as background when changing\r\n  ctx.globalAlpha = config.FULL_INTENSITY\r\n  ctx.fillStyle = config.GREY\r\n  ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height)\r\n  // go back to where we started\r\n  ctx.restore()\r\n  // using non-zero map height to show we have a map loaded\r\n  if (map.height > 0) {\r\n    // set map background white so that dimmed maps do not have grey showing through\r\n    ctx.fillStyle = config.WHITE\r\n    // this might have been reset by the ctx.restore()\r\n    ctx.globalAlpha = config.FULL_INTENSITY\r\n    ctx.fillRect(0, 0, map.width, map.height)\r\n    // set transparency of map\r\n    ctx.globalAlpha = options.perCentMapIntensity / 100\r\n    ctx.drawImage(map, 0, 0)\r\n    const tab = getActiveTab()\r\n    if (tab === config.TAB_DRAW) {\r\n      drawCourses(config.DIM)\r\n      controls.drawControls(false)\r\n      drawTracks()\r\n      drawNewTrack()\r\n    } else {\r\n      if (tab === config.TAB_CREATE) {\r\n        rg2Config.manager.drawManagerControls()\r\n      } else {\r\n        drawCourses(config.DIM)\r\n        drawTracks()\r\n        overlay.drawOverlays()\r\n        controls.drawControls(false)\r\n        drawAnimation()\r\n      }\r\n    }\r\n  } else {\r\n    drawDefaultText()\r\n  }\r\n  // console.timeEnd(\"redraw\")\r\n}\r\n\r\nexport function resetMapState() {\r\n  // place map in centre of canvas and scale it down to fit\r\n  let mapscale = 1\r\n  const heightscale = canvas.height / map.height\r\n  input.lastX = canvas.width / 2\r\n  input.lastY = canvas.height / 2\r\n  input.zoomSize = 1\r\n  input.dragStart = null\r\n  // looks odd but this works for initialisation\r\n  input.dragged = true\r\n  // don't stretch map: just shrink to fit\r\n  if (heightscale < 1) {\r\n    mapscale = heightscale\r\n  }\r\n  // move map into view on small screens\r\n  // avoid annoying jumps on larger screens\r\n  if (window.innerWidth >= config.BIG_SCREEN_BREAK_POINT) {\r\n    // TODO sort out offsets for control panel\r\n    ctx.setTransform(mapscale, 0, 0, mapscale, document.getElementById(\"rg2-left-info-panel\").offsetWidth + 80, 0)\r\n  } else {\r\n    ctx.setTransform(mapscale, 0, 0, mapscale, 0, 0)\r\n  }\r\n  // don't need to rotate here since the call to setTransform above does that for us\r\n  ctx.displayAngle = 0\r\n  ctx.displayScale = mapscale\r\n  redraw()\r\n}\r\n\r\nexport function resizeCanvas() {\r\n  input.scaleFactor = config.DEFAULT_SCALE_FACTOR\r\n  // allow for header\r\n  const headerHeight = document.getElementById(\"rg2-header-container\").offsetHeight\r\n  document.getElementById(\"rg2-container\").style.height = window.innerHeight - headerHeight + \"px\"\r\n  canvas.width = window.innerWidth\r\n  canvas.height = window.innerHeight - headerHeight\r\n  resetMapState()\r\n}\r\n\r\nfunction rotateMap(direction) {\r\n  // rotate a little bit from UI control input\r\n  // direction is -1 for left and 1 for right\r\n  const angle = direction * (Math.PI / 36)\r\n  // rotate around centre of map\r\n  ctx.translate(map.width / 2, map.height / 2)\r\n  applyMapRotation(angle, 0, 0, false, 1)\r\n  ctx.translate(-map.width / 2, -map.height / 2)\r\n}\r\n\r\nfunction saveMouseEvent(e) {\r\n  input.lastX = e.pageX - canvas.offsetParent.offsetLeft\r\n  input.lastY = e.pageY - canvas.offsetParent.offsetTop\r\n}\r\n\r\nfunction savePinchInfo(e) {\r\n  input.pinchStart0 = ctx.transformedPoint(e.touches[0].pageX, e.touches[0].pageY)\r\n  input.pinchStart1 = ctx.transformedPoint(e.touches[1].pageX, e.touches[1].pageY)\r\n  input.pinched = true\r\n}\r\n\r\nfunction trackTransforms(oldctx) {\r\n  const svg = document.createElementNS(\"http://www.w3.org/2000/svg\", \"svg\")\r\n  let xform = svg.createSVGMatrix()\r\n  let savedTransforms = []\r\n  let save = oldctx.save\r\n  oldctx.save = function () {\r\n    savedTransforms.push(xform.translate(0, 0))\r\n    return save.call(oldctx)\r\n  }\r\n  let restore = oldctx.restore\r\n  oldctx.restore = function () {\r\n    xform = savedTransforms.pop()\r\n    return restore.call(oldctx)\r\n  }\r\n  let scale = oldctx.scale\r\n  oldctx.scale = function (sx, sy) {\r\n    xform = xform.scale(sx, sy)\r\n    return scale.call(oldctx, sx, sy)\r\n  }\r\n  let translate = oldctx.translate\r\n  oldctx.translate = function (dx, dy) {\r\n    xform = xform.translate(dx, dy)\r\n    return translate.call(oldctx, dx, dy)\r\n  }\r\n  let setTransform = oldctx.setTransform\r\n  oldctx.setTransform = function (a, b, c, d, e, f) {\r\n    xform.a = a\r\n    xform.b = b\r\n    xform.c = c\r\n    xform.d = d\r\n    xform.e = e\r\n    xform.f = f\r\n    return setTransform.call(oldctx, a, b, c, d, e, f)\r\n  }\r\n  let pt = svg.createSVGPoint()\r\n  oldctx.transformedPoint = function (x, y) {\r\n    // converts x, y screen co-ords to x, y in map image\r\n    pt.x = x\r\n    pt.y = y\r\n    return pt.matrixTransform(xform.inverse())\r\n  }\r\n  let rotate = oldctx.rotate\r\n  oldctx.rotate = function (radians) {\r\n    xform = xform.rotate((radians * 180) / Math.PI)\r\n    return rotate.call(oldctx, radians)\r\n  }\r\n}\r\n\r\nfunction zoom(zoomDirection) {\r\n  if (!config.managing() && getActiveEventID() === null) {\r\n    return\r\n  }\r\n  const factor = Math.pow(input.scaleFactor, zoomDirection)\r\n  const tempZoom = input.zoomSize * factor\r\n  // limit zoom to avoid things disappearing\r\n  // chosen values seem reasonable after some quick tests\r\n  if (tempZoom < config.MAX_ZOOM && tempZoom > config.MIN_ZOOM) {\r\n    input.zoomSize = tempZoom\r\n    const pt = ctx.transformedPoint(input.lastX, input.lastY)\r\n    ctx.translate(pt.x, pt.y)\r\n    ctx.scale(factor, factor)\r\n    ctx.displayScale = ctx.displayScale * factor\r\n    ctx.translate(-pt.x, -pt.y)\r\n    redraw()\r\n  }\r\n}\r\n","import \"../scss/rg2.scss\"\r\n// eslint-disable-next-line no-unused-vars\r\nimport * as bootstrap from \"bootstrap\"\r\nimport { initialiseCanvas } from \"./canvas\"\r\nimport { config, loadConfigOptions } from \"./config\"\r\nimport { initialiseCourses } from \"./courses\"\r\nimport { doGetEvents, getActiveKartatID, isValidKartatID, loadEventByKartatID } from \"./events\"\r\nimport { parseLocationHash } from \"./hash\"\r\nimport { configureUI } from \"./rg2ui\"\r\nimport { initLanguageOptions } from \"./translate\"\r\nimport { showWarningDialog } from \"./utils.js\"\r\n\r\nwindow.assetUrl = function (filename) {\r\n  return rg2Config.asset_url + filename\r\n}\r\n\r\nif (document.readyState !== \"loading\") {\r\n  rg2init()\r\n} else {\r\n  document.addEventListener(\"DOMContentLoaded\", rg2init)\r\n}\r\n\r\nfunction rg2init() {\r\n  // everything now loaded: trigger CSS transitions on start-up screen\r\n  const startup = document.querySelector(\".rg2-startup\")\r\n  startup.style.opacity = 0\r\n  startup.style.backgroundColor = config.GREY\r\n  document.querySelector(\".rg2-startup-content\").classList.add(\"startup-transform\")\r\n  startup.addEventListener(\r\n    \"transitionend\",\r\n    () => {\r\n      document.getElementById(\"rg2-header-container\").classList.remove(\"d-none\")\r\n      startup.remove()\r\n      // looks odd to do this inmediateky but needed to avoid problems with Controls class\r\n      initialiseCourses()\r\n      loadConfigOptions()\r\n      configureUI()\r\n      initLanguageOptions()\r\n      if (config.managing()) {\r\n        import(\"./manager.js\")\r\n          .then((module) => {\r\n            rg2Config.manager = module\r\n            rg2Config.manager.initialiseManager()\r\n            finishInit()\r\n          })\r\n          .catch(() => {\r\n            console.log(\"Error loading manager\")\r\n            showWarningDialog(\"Error loading manager\", \"Manager functionality failed to  load.\")\r\n          })\r\n      } else {\r\n        finishInit()\r\n      }\r\n    },\r\n    // only need to run initialistaion once even if we have multiple transitions\r\n    { once: true }\r\n  )\r\n}\r\n\r\nfunction finishInit() {\r\n  initialiseCanvas()\r\n  window.onpopstate = handleNavigation\r\n  // check if a specific event has been requested\r\n  if (window.location.hash && !config.managing()) {\r\n    parseLocationHash(window.location.hash)\r\n  }\r\n  document.getElementById(\"rg2-event-title\").innerHTML = \"Routegadget 2\"\r\n  doGetEvents()\r\n}\r\n\r\nfunction handleNavigation() {\r\n  // console.log(\"Pop \" + window.location.hash)\r\n  // strange null popstates get generated when you toggle the left info panel via the rg2 logo\r\n  // so just protect against it for now\r\n  if (window.location.hash === \"\") {\r\n    return\r\n  }\r\n  // don't try to do anything clever in manager\r\n  if (!config.managing()) {\r\n    // find out where we are trying to go\r\n    const requestedKartatID = parseLocationHash(window.location.hash)\r\n    if (isValidKartatID(requestedKartatID)) {\r\n      // prevent double loading of events for cases where we get popstate for a change\r\n      // triggered via RG2 interaction rather than browser navigation\r\n      // ... or something like that: at least this seems to work in FF, Chrome and Edge\r\n      // which is a start\r\n      if (getActiveKartatID() !== requestedKartatID) {\r\n        loadEventByKartatID(requestedKartatID)\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { generateSelectOption } from \"./utils\"\r\n\r\nexport class Georefs {\r\n  constructor() {\r\n    this.georefsystems = []\r\n    this.georefsystems.push({ name: \"Not georeferenced\", description: \"none\", params: \"\", value: 0 })\r\n    this.georefsystems.push({\r\n      name: \"GB National Grid\",\r\n      description: \"EPSG:27700\",\r\n      params:\r\n        \"+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs\",\r\n      value: 1\r\n    })\r\n    this.georefsystems.push({\r\n      name: \"Google EPSG:900913\",\r\n      description: \"EPSG:900913\",\r\n      params:\r\n        \"+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs\",\r\n      value: 2\r\n    })\r\n    if (rg2Config.epsg_code !== undefined) {\r\n      // if more than one user-defined then they come in as |-separated strings\r\n      const codes = rg2Config.epsg_code.split(\"|\")\r\n      const params = rg2Config.epsg_params.split(\"|\")\r\n      for (let i = 0; i < codes.length; i = i + 1) {\r\n        this.georefsystems.push({\r\n          name: codes[i].replace(\" \", \"\"),\r\n          description: codes[i].replace(\" \", \"\"),\r\n          params: params[i],\r\n          value: i + 3\r\n        })\r\n      }\r\n      // default value for select option is first of the newly added items, afetr None, GBNG and Google\r\n      this.defaultGeorefVal = 3\r\n    } else {\r\n      // default to GB National Grid\r\n      this.defaultGeorefVal = 1\r\n    }\r\n  }\r\n\r\n  getDefaultValue() {\r\n    return this.georefsystems[this.defaultGeorefVal].value\r\n  }\r\n\r\n  getGeorefDropdown() {\r\n    let html = \"\"\r\n    for (let i = 0; i < this.georefsystems.length; i += 1) {\r\n      html += generateSelectOption(i, this.georefsystems[i].name, i === 0)\r\n    }\r\n    return html\r\n  }\r\n\r\n  getGeorefSystem(index) {\r\n    return this.georefsystems[index]\r\n  }\r\n}\r\n","import { Worldfile } from \"./worldfile\"\r\n\r\n// can't call this Map since that is a built-in class\r\nexport class MapData {\r\n  constructor(data) {\r\n    if (data !== undefined) {\r\n      // existing map from database\r\n      this.mapid = data.mapid\r\n      this.name = data.name\r\n      // worldfile for GPS to map image conversion (for GPS files)\r\n      this.worldfile = new Worldfile(data)\r\n      // worldfile for local co-ords to map image conversion (for georeferenced courses)\r\n      this.localworldfile = new Worldfile({\r\n        A: data.localA,\r\n        B: data.localB,\r\n        C: data.localC,\r\n        D: data.localD,\r\n        E: data.localE,\r\n        F: data.localF\r\n      })\r\n      if (data.mapfilename === undefined) {\r\n        this.mapfilename = this.mapid + \".\" + \"jpg\"\r\n      } else {\r\n        this.mapfilename = data.mapfilename\r\n      }\r\n    } else {\r\n      // new map to be added\r\n      this.mapid = 0\r\n      this.name = \"\"\r\n      this.worldfile = new Worldfile(0)\r\n      this.localworldfile = new Worldfile(0)\r\n    }\r\n    this.xpx = []\r\n    this.ypx = []\r\n    this.lat = []\r\n    this.lon = []\r\n  }\r\n}\r\n","export class User {\r\n  constructor() {\r\n    this.x = \"\"\r\n    this.name = null\r\n    this.password = null\r\n  }\r\n\r\n  setDetails(nameSelector, passwordSelector) {\r\n    // mickey mouse 5 character requirement\r\n    const regex = /...../\r\n    this.name = document.getElementById(nameSelector).value\r\n    const nameValid = regex.test(this.name)\r\n    this.password = document.getElementById(passwordSelector).value\r\n    const passwordValid = regex.test(this.password)\r\n    return nameValid && passwordValid\r\n  }\r\n\r\n  alterString(input) {\r\n    const chars = \"abcdefghijklmnopqrstuvwxyz0123456789\"\r\n    let str = \"\"\r\n    for (let i = 0; i < input.length; i += 1) {\r\n      const rand = Math.floor(Math.random() * chars.length)\r\n      str += input.charAt(i) + chars.charAt(rand)\r\n    }\r\n    return str\r\n  }\r\n\r\n  encodeUser() {\r\n    return { x: this.alterString(this.name + this.password), user: this.name }\r\n  }\r\n}\r\n"],"file":"assets/main-Cw0jfsJD.js"}