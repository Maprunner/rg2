import{a as Wi,T as ji,M as qi,d as ae,C as Dn,O as Ln,i as wt}from"./vendor-cZRM5MRd.js";import{L as gs,D as Vs,p as vt}from"./manager-eBKvXMG6.js";import{M as zi,C as Ki,G as ms}from"./grid-FILuImag.js";const wn=Wi.create({baseURL:rg2Config.api_url});function Pt(t,e,s){t.t=new Date().getTime(),document.getElementById("rg2-container").style.cursor="wait",wn({method:"get",url:"",params:t}).then(n=>{e(n.data.data,t.id)}).catch(function(n){Bn(s+": "+n)}).finally(function(){document.getElementById("rg2-container").style.cursor="auto"})}function pe(t,e,s,n,i=()=>{}){let l={method:"post"};l.data=t,e.headers&&(l.headers=e.headers,delete e.headers),e.t=new Date().getTime(),l.params=e,document.getElementById("rg2-container").style.cursor="wait",wn(l).then(r=>{r.data.keksi&&i(r.data.keksi),s(r.data)}).catch(function(r){Bn(n+": "+r)}).finally(function(){document.getElementById("rg2-container").style.cursor="auto"})}function Bn(t){document.getElementById("rg2-load-progress").classList.add("d-none"),document.getElementById("rg2-map-load-progress").classList.add("d-none"),b("Configuration error",t)}let Te={};Te.code="en";let St=[];function Zi(t){let e=document.getElementById("rg2-select-language");e.innerHTML="";let s=Te.code==="en";e.options.add(Ye("en","en: English",s));for(let n=0;n<t.length;n=n+1)s=Te.code===t[n].code,e.options.add(Ye(t[n].code,t[n].code+": "+t[n].language,s));e.addEventListener("change",n=>{const i=n.target.value;i!==Te.code&&(i==="en"?Rn("en"):An(i))})}function An(t){Pt({type:"lang",lang:t},Qi,"Language request failed")}function Ji(t){const e=St.indexOf(t);return e>-1?e:(St.push(t),St.length-1)}function Qi(t){Rn(t.lang)}function el(){rg2Config.start_language!=="en"&&An(rg2Config.start_language)}function Rn(t){t==="en"?Te={code:"en"}:Te=t,tl()}function p(t,e="span"){const s=Ji(t);return Te.hasOwnProperty(t)&&(t=Te[t]),e===""?t:`<${e} data-rg2t='${s}'>${t}</${e}>`}function tl(){const t=document.querySelectorAll("[data-rg2t]");for(let e of t){const s=parseInt(e.dataset.rg2t,10);e.innerText=p(St[s],"")}}function ns(t,e,s){return t.length>0?t[0].getAttribute(e).trim():s}function _(t){const e=Math.floor(t/60);let s=e;const n=t-e*60;return n<10?s+=":0"+n:s+=":"+n,s}function sl(t){let e;const s=Math.floor(t/3600);s<10?e="0"+s+":":e=s+":",t=t-s*3600;const n=Math.floor(t/60);return n<10?e+="0"+n:e+=n,t=t-n*60,t<10?e+=":0"+t:e+=":"+t,e}function Ye(t,e,s=!1){let n=document.createElement("option");return n.value=t,n.text=e,s&&(n.selected=!0),n}function Ce(t,e,s=!1){return`<option value="${t}"${s?" selected":""}>${e}</option>`}function Ne(t,e,s,n){let i=Math.atan2(n-e,s-t);return i<0&&(i=i+2*Math.PI),i}function J(t,e,s,n){return Math.sqrt(Math.pow(t-s,2)+Math.pow(e-n,2))}function is(t,e,s,n){const i=(s-t).toRad(),l=(n-e).toRad(),r=Math.sin(i/2)*Math.sin(i/2)+Math.cos(t.toRad())*Math.cos(s.toRad())*Math.sin(l/2)*Math.sin(l/2);return 6371009*2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r))}function nl(t){if(!t)return 0;let e=0;const s=t.split(":");return e=parseInt(s[0],10)*3600+parseInt(s[1],10)*60,isNaN(e)?0:e}function ve(t){if(!t)return 0;let e=0,s=t.replace(/\./g,":").split(":");return s.length===2?e=parseInt(s[0],10)*60+parseInt(s[1],10):s.length===3&&(e=parseInt(s[0],10)*3600+parseInt(s[1],10)*60+parseInt(s[2],10)),isNaN(e)?0:e}const b=(t,e)=>{ll(t,e)},il=document.getElementById("rg2-toast-container"),ll=(t,e)=>{const s=document.createElement("div");s.classList.add("toast"),s.setAttribute("data-bs-autohide","false"),s.innerHTML=`<div class="toast-header">
      <strong class="me-auto">${t}</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">
      ${e}
    </div>`,il.appendChild(s),[...document.querySelectorAll(".toast")].map(i=>{const l=new ji(i,{});i.addEventListener("hidden.bs.toast",()=>{i.parentNode&&i.parentNode.removeChild(i)}),l.show()})};function ne(t,e){return t.length>0?t[0].textContent.trim():e}let Je;function ye(t,e=!0){Je&&Je.dispose();const s=document.getElementById("rg2-modal-container");s.innerHTML="";const n=e?`<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${p("Cancel")}</button>`:"",i=`<div class="modal fade" id="rg2-modal-dialog" data-bs-backdrop="static" data-bs-keyboard="false"
    tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="staticBackdropLabel">${t.title}</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          ${t.body}
        </div>
        <div class="modal-footer">
          <button id="rg2-do-modal-action" type="button" class="btn btn-primary">${p(t.doText)}</button>
          ${n}
        </div>
      </div>
    </div>
    </div > `;s.innerHTML=i,typeof t.onCancel!="function"&&(t.onCancel=()=>{});let l=!1;const r=document.getElementById("rg2-modal-dialog");document.getElementById("rg2-do-modal-action").addEventListener("click",()=>{l=!0,Je.hide()});const o={keyboard:!0};Je=new qi(r,o),r.addEventListener("hidden.bs.modal",()=>{l?t.onDo():t.onCancel()}),Je.show()}function rl(t,e){const s=document.getElementById(t),n=e(s.value);return n?(s.classList.add("is-valid"),s.classList.remove("is-invalid")):(s.classList.add("is-invalid"),s.classList.remove("is-valid")),n}Number.prototype.toRad=function(){return this*Math.PI/180};const Us=["#ff0000","#00ff00","#0000ff","#800000","#008000","#000080","#ffff00","#ff00ff","#00ffff","#808000","#800080","#008080"];let qt=0;function Mn(){return qt=(qt+1)%Us.length,Us[qt]}const h={RG2VERSION:"2.0.4",DEFAULT_SCALE_FACTOR:1.1,TAB_EVENTS:"event-tab",TAB_COURSES:"course-tab",TAB_RESULTS:"result-tab",TAB_DRAW:"draw-tab",TAB_LOGIN:"manage-login-tab",TAB_CREATE:"manage-create-tab",TAB_EDIT:"manage-edit-tab",TAB_MAP:"manage-map-tab",TAB_DELETE_MAP:"manage-delete-map-tab",INVALID_MAP_ID:9999,DEFAULT_NEW_COMMENT:"Type your comment",GPS_RESULT_OFFSET:5e4,MASS_START_REPLAY:1,REAL_TIME_REPLAY:2,MASS_START_BY_CONTROL:99999,VERY_HIGH_TIME_IN_SECS:99999,BIG_SCREEN_BREAK_POINT:800,SMALL_SCREEN_BREAK_POINT:500,PURPLE:"#b300ff",RED:"#ff0000",GREEN:"#00ff00",DARK_GREEN:"rgb(34, 139, 34)",DARK_GREEN_30:"rgba(34, 139, 34, 0.3)",GREY:"#e0e0e0",RED_30:"rgba(255,0,0,0.3)",GREEN_30:"rgba(0,255,0,0.3)",WHITE:"#ffffff",BLACK:"#000000",RUNNER_DOT_RADIUS:6,HANDLE_DOT_RADIUS:7,HANDLE_COLOUR:"#ff0000",DIM:.75,FULL_INTENSITY:1,TIME_NOT_FOUND:9999,RIGHT_CLICK:3,DO_NOT_SAVE_COURSE:9999,FORMAT_NORMAL:1,FORMAT_NORMAL_NO_RESULTS:2,FORMAT_SCORE_EVENT:3,FORMAT_SCORE_EVENT_NO_RESULTS:4,DISPLAY_ALL_COURSES:99999,EXCLUDED_NONE:0,EXCLUDED_ZERO_SPLITS:1,EXCLUDED_REAL_SPLITS:2,MAX_DRAWN_ROUTES:10,languages:[{language:"Čeština",code:"cz"},{language:"Deutsch",code:"de"},{language:"Suomi",code:"fi"},{language:"Français",code:"fr"},{language:"Italiano",code:"it"},{language:"日本語",code:"ja"},{language:"Norsk",code:"no"},{language:"Português - Brasil",code:"pt"},{language:"Русский",code:"ru"}],FILE_SIZE_WARNING:2,PIXEL_SIZE_WARNING:4e3,CLASS_NOW_ON:1,CLASS_NOW_OFF:0,managing:()=>rg2Config.keksi!==void 0},k={perCentMapIntensity:100,perCentRouteIntensity:100,replayFontSize:12,courseWidth:3,routeWidth:4,circleSize:20,snap:!0,showThreeSeconds:!1,showGPSSpeed:!1,alignMap:!1,maxSpeed:5,minSpeed:15,drawnRoutes:[]};function dt(){let t={};const e=ke();let s=Math.pow(Math.min(e.height,e.width)/1500,.5);s=Math.min(s,5),s=Math.max(s,.5);const n=Math.round(k.circleSize*s);return t.controlRadius=n,t.finishInnerRadius=n*(5/6),t.finishOuterRadius=n*(7/6),t.startTriangleLength=n*(7/6),t.overprintWidth=k.courseWidth,t.font=n+"pt Arial",t}function ol(){try{if(window.hasOwnProperty("localStorage")&&window.localStorage!==null&&localStorage.getItem("rg2-options")!==null){const t=JSON.parse(localStorage.getItem("rg2-options"));for(let e in t)t.hasOwnProperty(e)&&(k[e]=t[e]);k.circleSize=20,k.perCentMapIntensity===0&&b("Warning","Your saved settings have 0% map intensity so the map is invisible. You can adjust this on the configuration menu")}}catch{}}function al(t){let e=[];for(let s=0;s<k.drawnRoutes.length;s+=1)(k.drawnRoutes[s].id!==t.id||k.drawnRoutes[s].eventid!==t.eventid)&&e.push(k.drawnRoutes[s]);k.drawnRoutes=e,Ft()}function Ft(){try{window.hasOwnProperty("localStorage")&&window.localStorage!==null&&localStorage.setItem("rg2-options",JSON.stringify(k))}catch{return}}function dl(t){let e=k.drawnRoutes;e.length>=h.MAX_DRAWN_ROUTES&&e.shift(),e.push(t),k.drawnRoutes=e,Ft()}function cl(t,e){k[t]=e,Ft()}class ps{constructor(){this.controls=[],this.displayControls=!1}addControl(e,s,n){let i=!0;for(let l=0;l<this.controls.length;l+=1)if(this.controls[l].code===e){i=!1;break}i&&this.controls.push({code:e,x:s,y:n})}deleteAllControls(){this.controls.length=0}displayAllControls(){this.displayControls=!0}drawControls(e){if(this.displayControls){const s=dt();for(let n=0;n<this.controls.length;n+=1)this.controls[n].code.indexOf("F")===0||this.controls[n].code.indexOf("M")===0?this.drawFinish(this.controls[n].x,this.controls[n].y,this.controls[n].code,s):this.controls[n].code.indexOf("S")===0?this.drawStart(this.controls[n].x,this.controls[n].y,this.controls[n].code,1.5*Math.PI,s):(this.drawSingleControl(this.controls[n].x,this.controls[n].y,this.controls[n].code,Math.PI*.25,s),e&&a.fillRect(this.controls[n].x-1,this.controls[n].y-1,3,3))}}drawFinish(e,s,n,i){a.strokeStyle="white",a.lineWidth=i.overprintWidth+2,a.beginPath(),a.arc(e,s,i.finishInnerRadius,0,2*Math.PI,!1),a.stroke(),a.beginPath(),a.arc(e,s,i.finishOuterRadius,0,2*Math.PI,!1),a.stroke(),a.beginPath(),a.font=i.font,a.textAlign="left",a.strokeStyle="white",a.miterLimit=2,a.lineJoin="circle",a.lineWidth=1.5,a.strokeText(n,e+i.controlRadius*1.5,s+i.controlRadius),a.stroke(),a.beginPath(),a.fillStyle=h.PURPLE,a.strokeStyle=h.PURPLE,a.lineWidth=i.overprintWidth,a.arc(e,s,i.finishInnerRadius,0,2*Math.PI,!1),a.stroke(),a.beginPath(),a.arc(e,s,i.finishOuterRadius,0,2*Math.PI,!1),a.fillText(n,e+i.controlRadius*1.5,s+i.controlRadius),a.stroke()}drawSingleControl(e,s,n,i,l){a.beginPath(),a.strokeStyle="white",a.lineWidth=l.overprintWidth+2,a.arc(e,s,l.controlRadius,0,2*Math.PI,!1),a.stroke(),a.beginPath(),a.textAlign="center",a.font=l.font,a.strokeStyle="white",a.miterLimit=2,a.lineJoin="circle",a.lineWidth=1.5,a.textBaseline="middle";const r=a.measureText(n);let o;i<Math.PI?o=r.width/2:o=-1*r.width/2;let f;i>=Math.PI/2&&i<=Math.PI*1.5?f=-1*l.controlRadius/2:f=l.controlRadius/2;const y=1.3;a.strokeText(n,e+l.controlRadius*y*Math.sin(i)+o,s+l.controlRadius*y*Math.cos(i)+f),a.beginPath(),a.font=l.font,a.fillStyle=h.PURPLE,a.strokeStyle=h.PURPLE,a.lineWidth=l.overprintWidth,a.arc(e,s,l.controlRadius,0,2*Math.PI,!1),a.fillText(n,e+l.controlRadius*y*Math.sin(i)+o,s+l.controlRadius*y*Math.cos(i)+f),a.stroke()}drawStart(e,s,n,i,l){let r=[],o=[];const f=2*Math.PI/3;i=i+Math.PI/2,a.lineCap="round",a.strokeStyle="white",a.lineWidth=l.overprintWidth+2,a.beginPath(),r[0]=e+l.startTriangleLength*Math.sin(i),o[0]=s-l.startTriangleLength*Math.cos(i),a.moveTo(r[0],o[0]),r[1]=e+l.startTriangleLength*Math.sin(i+f),o[1]=s-l.startTriangleLength*Math.cos(i+f),a.lineTo(r[1],o[1]),a.stroke(),a.beginPath(),a.moveTo(r[1],o[1]),r[2]=e+l.startTriangleLength*Math.sin(i-f),o[2]=s-l.startTriangleLength*Math.cos(i-f),a.lineTo(r[2],o[2]),a.stroke(),a.beginPath(),a.moveTo(r[2],o[2]),a.lineTo(r[0],o[0]),a.stroke(),a.beginPath(),a.font=l.font,a.textAlign="left",a.strokeStyle="white",a.miterLimit=2,a.lineJoin="circle",a.lineWidth=1.5,a.strokeText(n,r[0]+l.controlRadius*1.25,o[0]+l.controlRadius*1.25),a.stroke(),a.strokeStyle=h.PURPLE,a.lineWidth=l.overprintWidth,a.font=l.font,a.fillStyle=h.PURPLE,a.beginPath(),a.moveTo(r[0],o[0]),a.lineTo(r[1],o[1]),a.stroke(),a.beginPath(),a.moveTo(r[1],o[1]),a.lineTo(r[2],o[2]),a.stroke(),a.beginPath(),a.moveTo(r[2],o[2]),a.lineTo(r[0],o[0]),a.fillText(n,r[0]+l.controlRadius*1.25,o[0]+l.controlRadius*1.25),a.stroke()}generateControlList(){this.controls.length=0;const e=ed();for(let s=0;s<e.length;s+=1)if(e[s]!==void 0){const n=e[s].codes,i=e[s].x,l=e[s].y;if(n!==void 0)for(let r=0;r<n.length;r+=1)this.addControl(n[r],i[r],l[r])}}getControlCount(){return this.controls.length}toggleControlDisplay(){this.displayControls=!this.displayControls}}class ul{constructor(e,s){this.name=e.name,this.trackcount=0,this.display=!1,this.courseid=e.courseid,this.codes=e.codes,this.setExcluded(e),this.filterTo=this.codes.length,this.filterFrom=0,this.x=e.xpos,this.y=e.ypos,this.isScoreCourse=s,this.resultcount=0,this.angle=[],this.textAngle=[],this.setAngles(),this.length=this.setLength()}drawCourse(e){if(this.display){const s=dt();if(a.globalAlpha=e,z.drawStart(this.x[0],this.y[0],"",this.angle[0],s),!this.isScoreCourse){const n={from:this.filterFrom,to:this.filterTo};this.drawLinesBetweenControls({x:this.x,y:this.y},this.angle,s,n)}if(this.isScoreCourse)for(let n=1;n<this.x.length;n+=1)this.codes[n].indexOf("F")===0||this.codes[n].indexOf("M")===0?z.drawFinish(this.x[n],this.y[n],"",s):z.drawSingleControl(this.x[n],this.y[n],this.codes[n],this.textAngle[n],s);else{const n=Math.max(this.filterFrom,1),i=Math.min(this.filterTo+1,this.x.length-1);for(let l=n;l<i;l+=1)z.drawSingleControl(this.x[l],this.y[l],l,this.textAngle[l],s);z.drawFinish(this.x[this.x.length-1],this.y[this.y.length-1],"",s)}}}drawLinesBetweenControls(e,s,n,i){let l;for(let r=i.from;r<i.to;r+=1){r===0?l=n.startTriangleLength:l=n.controlRadius;const o=e.x[r]+l*Math.cos(s[r]),f=e.y[r]+l*Math.sin(s[r]);r===this.x.length-2?l=n.finishOuterRadius:l=n.controlRadius;const y=e.x[r+1]-l*Math.cos(s[r]),u=e.y[r+1]-l*Math.sin(s[r]);a.beginPath(),a.moveTo(o,f),a.lineTo(y,u),a.stroke()}}getLegLengths(){let e=[];if(this.isScoreCourse)return e[1]=1,e;e[0]=0;for(let s=1;s<this.x.length;s+=1)e[s]=parseInt(e[s-1]+J(this.x[s],this.y[s],this.x[s-1],this.y[s-1]),0);return e}incrementTracksCount(){this.trackcount+=1}setAngles(){for(let e=0;e<this.x.length-1;e+=1)if(this.isScoreCourse)this.angle[e]=Math.PI*1.5,this.textAngle[e]=Math.PI*.25;else{this.angle[e]=Ne(this.x[e],this.y[e],this.x[e+1],this.y[e+1]);const s=Math.sin(this.angle[e-1]),n=Math.cos(this.angle[e-1]),i=Math.sin(this.angle[e])+s,l=Math.cos(this.angle[e])+n,r=i/2,o=l/2;this.textAngle[e]=Ne(r,o,s,n)}this.angle[this.x.length-1]=Math.PI*1.5,this.textAngle[this.x.length-1]=Math.PI*1.5}setDisplay(e){this.display=e}setExcluded(e){this.excludeType=e.excludeType,this.exclude=e.codes.map((s,n)=>e.exclude.findIndex(i=>i===n)>-1),this.allowed=e.codes.map((s,n)=>e.exclude.findIndex(i=>i===n)>-1?e.allowed[e.exclude.findIndex(i=>i===n)]:0)}setLength(){let e=0;const s=Gt();if(!(s===void 0||this.isScoreCourse)){for(let n=1;n<this.x.length;n+=1)e+=J(this.x[n],this.y[n],this.x[n-1],this.y[n-1]);if(e!==0)return(e*s/1e3).toFixed(1)}}}class hl{constructor(e,s,n,i){this.x=e,this.y=s,this.basex=e,this.basey=s,this.undox=e,this.undoy=s,this.locked=!1,this.time=n,this.index=i}}class fl{constructor(){this.handles=[]}addHandle(e,s,n){this.handles.push(new hl(e,s,n,this.handles.length)),this.handles.sort(function(i,l){return i.time-l.time}),this.renumberHandles()}deleteHandle(e){e===0||e===this.handles.length-1||(this.handles.splice(e,1),this.renumberHandles())}renumberHandles(){for(let e=0;e<this.handles.length;e+=1)this.handles[e].index=e}lockHandle(e){this.handles[e].locked=!0}lockHandleByTime(e){for(let s=0;s<this.handles.length;s+=1)this.handles[s].time===e&&(this.handles[s].locked=!0)}unlockHandle(e){this.handles[e].locked=!1}handlesLocked(){let e=0;for(let s=0;s<this.handles.length;s+=1)this.handles[s].locked&&(e+=1);return e}deleteAllHandles(){this.handles.length=0}rebaselineXY(){this.copyHandleFields("","base")}saveForUndo(){this.copyHandleFields("base","undo")}undo(){this.copyHandleFields("undo","base"),this.copyHandleFields("undo","")}copyHandleFields(e,s){for(let n=0;n<this.handles.length;n+=1)this.handles[n][s+"x"]=this.handles[n][e+"x"],this.handles[n][s+"y"]=this.handles[n][e+"y"]}getStartHandle(){return this.handles[0]}getFinishHandle(){return this.handles[this.handles.length-1]}getHandleClicked(e){for(let s=0;s<this.handles.length;s+=1)if(J(e.x,e.y,this.handles[s].basex,this.handles[s].basey)<=h.HANDLE_DOT_RADIUS)return this.handles[s]}getEarliestLockedHandle(){for(let e=0;e<this.handles.length;e+=1)if(this.handles[e].locked)return this.handles[e]}getLatestLockedHandle(){for(let e=this.handles.length-1;e>0;e-=1)if(this.handles[e].locked)return this.handles[e]}getPreviousLockedHandle(e){for(let s=e.index-1;s>=0;s-=1)if(this.handles[s].locked)return this.handles[s]}getNextLockedHandle(e){for(let s=e.index+1;s<this.handles.length;s+=1)if(this.handles[s].locked)return this.handles[s]}getSingleLockedHandle(){return this.getEarliestLockedHandle()}dragHandles(e,s){for(let n=0;n<this.handles.length;n+=1)this.handles[n].x=this.handles[n].basex+e,this.handles[n].y=this.handles[n].basey+s}drawHandles(){for(let e=0;e<this.handles.length;e+=1)a.lineWidth=1,this.handles[e].locked===!0?(a.fillStyle=h.RED_30,a.strokeStyle=h.RED):(a.fillStyle=h.GREEN_30,a.strokeStyle=h.GREEN),a.beginPath(),a.arc(this.handles[e].x,this.handles[e].y,h.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),a.fill(),a.stroke()}alignHandles(e){for(let s=0;s<this.handles.length;s+=1)this.handles[s].x=e.x[this.handles[s].time],this.handles[s].y=e.y[this.handles[s].time]}}class Ot{constructor(){this.courseid=null,this.coursename=null,this.controlsToAdjust=0,this.resultid=null,this.isScoreCourse=!1,this.eventid=null,this.name=null,this.comments=null,this.x=[],this.y=[],this.controlx=[],this.controly=[],this.time=[],this.startsecs=0,this.totaltime=0,this.splits=[],this.xml=null}}class Nn{constructor(){this.lat=[],this.lon=[],this.startOffset=0,this.baseX=[],this.baseY=[],this.handles=new fl,this.savedBaseX=[],this.savedBaseY=[],this.fileLoaded=!1,this.fileName="",this.fileType="",this.routeData=new Ot,this.autofitOffset=null}adjustOffset(e){this.autofitOffset=e,this.processGPSFile(),this.autofitTrack()}addStartAndFinishHandles(){this.handles.addHandle(this.baseX[0],this.baseY[0],0),this.handles.addHandle(this.baseX[this.baseX.length-1],this.baseY[this.baseY.length-1],this.baseY.length-1)}applyWorldFile(){const e=ki();for(let s=0;s<this.lat.length;s+=1)this.routeData.x[s]=Math.round((e.E*this.lon[s]-e.B*this.lat[s]+e.xCorrection)/e.AEDB),this.routeData.y[s]=Math.round((-1*e.D*this.lon[s]+e.A*this.lat[s]+e.yCorrection)/e.AEDB)}autofitTrack(){document.getElementById("chk-move-all").checked=!1,this.handles.deleteAllHandles(),this.addStartAndFinishHandles(),this.autofitOffset===null&&(this.autofitOffset=this.getOffset());for(let e=1;e<this.routeData.controlsToAdjust;e+=1)if(this.routeData.splits[e]!==this.routeData.splits[e-1]){const s=this.routeData.splits[e]+this.autofitOffset;s<this.baseX.length&&s>=0&&(this.handles.addHandle(this.routeData.x[s],this.routeData.y[s],s),pi({x:this.routeData.x[s],y:this.routeData.y[s]},{x:this.routeData.controlx[e],y:this.routeData.controly[e]}),this.handles.lockHandleByTime(s),this.baseX=this.routeData.x.slice(0),this.baseY=this.routeData.y.slice(0),this.handles.rebaselineXY())}document.getElementById("btn-autofit-gps").setAttribute("disabled",""),document.getElementById("btn-undo-gps-adjust").setAttribute("disabled",""),S()}expandToOneSecondInterval(){let e=[],s=[],n=[];const i=this.routeData;let l=i.time[0],r=i.x[0],o=i.y[0];e[0]=r,s[0]=o,n[0]=i.time[0];let f=n[0]+1;for(let y=1;y<i.x.length;y+=1){const u=i.time[y]-l;if(u>0){const m=(i.x[y]-r)/u,v=(i.y[y]-o)/u;let B=1;for(;B<=u;)e.push(r+m*B),s.push(o+v*B),n.push(f),f+=1,B+=1;r=i.x[y],o=i.y[y],l=f-1}}this.routeData.x=e.slice(0),this.routeData.y=s.slice(0),this.routeData.time=n.slice(0)}fitTrackInsideCourse(){const e=this.getLatLonInfo(),s=this.getControlInfo();let n=(s.maxX-s.minX)/(e.maxLon-e.minLon),i=(s.maxY-s.minY)/(e.maxLat-e.minLat);n>i?i=n*e.latCorrection/e.lonCorrection:n=i*e.lonCorrection/e.latCorrection,this.routeData.x[0]=(this.lon[0]-e.minLon)*n+s.minX,this.routeData.y[0]=-1*(this.lat[0]-e.maxLat)*i+s.minY;const l=s.minX-(this.routeData.x[0]-s.x[0]),r=s.minY-(this.routeData.y[0]-s.y[0]);for(let o=0;o<this.lat.length;o+=1)this.routeData.x[o]=(this.lon[o]-e.minLon)*n+l,this.routeData.y[o]=-1*(this.lat[o]-e.maxLat)*i+r}getControlInfo(){let e=ka();if(e.minX=Math.min.apply(Math,e.x),e.maxX=Math.max.apply(Math,e.x),e.minY=Math.min.apply(Math,e.y),e.maxY=Math.max.apply(Math,e.y),e.maxY-e.minY<100||e.maxX-e.minX<100){e.minX=0,e.minY=0;const s=ke();e.maxX=s.width,e.maxY=s.height}return e}getLatLonInfo(){let e={};return e.maxLat=Math.max.apply(Math,this.lat),e.maxLon=Math.max.apply(Math,this.lon),e.minLat=Math.min.apply(Math,this.lat),e.minLon=Math.min.apply(Math,this.lon),e.lonCorrection=is(e.minLat,e.maxLon,e.minLat,e.minLon)/(e.maxLon-e.minLon),e.latCorrection=is(e.minLat,e.minLon,e.maxLat,e.minLon)/(e.maxLat-e.minLat),e}getOffset(){const e=this.getSpeedAverage();let s=[];const n=10;for(let o=0;o<=2*n;o+=1)s[o]=0;let i=0;for(let o=1;o<this.routeData.controlsToAdjust;o+=1){const f=this.routeData.splits[o];if(f!==this.routeData.splits[o-1]){f>=n&&f+n<e.length&&(i=e.slice(f-n,f+n+1));for(let y=0;y<=2*n;y+=1)s[y]+=i[y]}}let l=0;for(let o=1;o<s.length;o+=1)s[o]<s[l]&&(l=o);return l-n}getSecsFromTrackpoint(e){const s=parseInt(Date.parse(e)/1e3,10);return isNaN(s)?0:s-this.startOffset}getSpeedAverage(){let e=[],s=[];e[0]=0;for(let n=1;n<this.routeData.x.length;n+=1)e[n]=J(this.routeData.x[n],this.routeData.y[n],this.routeData.x[n-1],this.routeData.y[n-1]);for(let n=1;n<this.routeData.x.length-1;n+=1)s[n]=(e[n-1]+e[n]+e[n+1])/3;return s[0]=e[0],s[this.routeData.x.length-1]=e[this.routeData.x.length-1],s}getStartOffset(e){const s=parseInt(Date.parse(e.substr(0,11)+"00:00:00Z")/1e3,10);return isNaN(s)?0:s}initialiseGPS(){this.lat.length=0,this.lon.length=0,this.startOffset=0,this.baseX.length=0,this.baseY.length=0,this.handles.deleteAllHandles(),this.savedBaseX.length=0,this.savedBaseY.length=0,this.fileLoaded=!1,this.routeData.x.length=0,this.routeData.y.length=0,this.routeData.time.length=0}processGPSFile(){this.initialiseGPS(),this.fileType==="gpx"?this.processGPX():this.processTCX(),this.processGPSTrack()}processGPSTrack(){Yt()?(this.applyWorldFile(),this.trackMatchesMapCoordinates()?document.getElementById("chk-move-all").checked=!0:(b("GPS file problem","Your GPS file does not match the map co-ordinates. Please check you have selected the correct file."),this.fitTrackInsideCourse())):this.fitTrackInsideCourse(),this.lat.length=0,this.lon.length=0,this.expandToOneSecondInterval(),this.baseX=this.routeData.x.slice(0),this.baseY=this.routeData.y.slice(0),this.addStartAndFinishHandles(),this.fileLoaded=!0,this.routeData.splits.length>2&&document.getElementById("btn-autofit-gps").removeAttribute("disabled"),document.getElementById("btn-save-gps-route").removeAttribute("disabled"),S()}processGPX(){const e=this.xml.getElementsByTagName("trkseg");for(let s=0;s<e.length;s+=1){const n=e[s].getElementsByTagName("trkpt");this.startOffset=this.getStartOffset(n[0].getElementsByTagName("time")[0].textContent);for(let i=0;i<n.length;i+=1){const l=n[i].getAttribute("lat"),r=n[i].getAttribute("lon");l!=="0"&&r!=="0"&&(this.lat.push(l),this.lon.push(r),this.routeData.time.push(this.getSecsFromTrackpoint(n[i].getElementsByTagName("time")[0].textContent)))}}}processTCX(){const e=this.xml.getElementsByTagName("Track");for(let s=0;s<e.length;s+=1){const n=e[s].getElementsByTagName("Trackpoint");this.startOffset=this.getStartOffset(n[0].getElementsByTagName("Time")[0].textContent);for(let i=0;i<n.length;i+=1)if(n[i].getElementsByTagName("Position").length>0){const l=n[i].getElementsByTagName("Position"),r=l[0].getElementsByTagName("LatitudeDegrees")[0].textContent,o=l[0].getElementsByTagName("LongitudeDegrees")[0].textContent;r!=="0"&&o!=="0"&&(this.lat.push(r),this.lon.push(o),this.routeData.time.push(this.getSecsFromTrackpoint(n[i].getElementsByTagName("Time")[0].textContent)))}}}readGPS(e){let s=new FileReader;this.fileName=e.target.files[0].name,s.onerror=function(n){b("GPS file problem","Unable to open GPS file. "+n)},s.onload=n=>{try{if(this.fileType=this.fileName.slice(-3).toLowerCase(),this.fileType!=="gpx"&&this.fileType!=="tcx"){b("GPS file problem","File type not recognised. Please check you have selected the correct file.");return}document.getElementById("rg2-load-gps-file").setAttribute("disabled",""),this.xml=new DOMParser().parseFromString(n.target.result,"text/xml"),this.processGPSFile()}catch(i){b("GPS file problem","File is not valid XML. Please check you have selected the correct file. "+i);return}},s.readAsText(e.target.files[0])}trackMatchesMapCoordinates(){const e=Math.min.apply(Math,this.routeData.x),s=Math.max.apply(Math,this.routeData.x),n=Math.min.apply(Math,this.routeData.y),i=Math.max.apply(Math,this.routeData.y),l=ke();return s>0&&e<l.width&&n<l.height&&i>0}}let ie=0,he=[],le=[];function Gs(t,e){return t.length>0?e+t.join(","):""}function Ys(t,e,s){let n=0;return ie!==0&&(n="#"+t+Gs(s,"&course=")+Gs(e,"&route=")),n}function gl(){return he}function ml(){return ie}function pl(){return le}function yl(){return le.length>0?h.TAB_RESULTS:h.TAB_COURSES}function vl(t){let e=t.replace(/#([0-9]+)($|&).*/,"$1");return e.length>0?parseInt(e,10):e}function _n(t){ie=0,he.length=0,le.length=0;let e=t.split("&");for(let s=0;s<e.length;s+=1)e[s]=e[s].toLowerCase(),e[s].search("#")!==-1&&(ie=parseInt(e[s].replace(/\D/g,""),10)),e[s].search("course=")!==-1&&(he=e[s].replace("course=","").split(",")),e[s].search("route=")!==-1&&(le=e[s].replace("route=","").split(","));return he=he.map(Number),le=le.map(Number),isNaN(ie)&&(ie=0,he.length=0,le.length=0),$t(),ie}function El(t){ie=t,$t()}function Ws(t){he=t,$t()}function zt(t){le=t,$t()}function $t(){let t="";vl(window.location.hash)===ie?(t=Ys(ie,le,he),window.history.replaceState({hash:t},"",t)):(he.length=0,le.length=0,t=Ys(ie,le,he),window.history.pushState({hash:t},"",t))}class xl{constructor(e,s,n){return this.courses=[],this.courseClassMapping=[],this.newcontrols=new ps,this.courses.length=0,this.courseClassMapping.length=0,this.fromOldCondes=!1,this.coursesGeoreferenced=!1,this.newcontrols.deleteAllControls(),this.localWorldfile=n,this.worldfile=s,this.processCoursesXML(e.target.result),this.addControlCount(),{courses:this.courses,newcontrols:this.newcontrols,mapping:this.courseClassMapping,georeferenced:this.coursesGeoreferenced}}processCoursesXML(e){let s=null;try{s=new DOMParser().parseFromString(e,"text/xml")}catch{b("XML file error","File is not a valid XML course file.");return}if(s.getElementsByTagName("CourseData").length===0){s.documentElement.nodeName==="kml"?this.processKMLCourses(s):b("XML file error","File is not a valid XML course file. CourseData element missing.");return}const i=this.getVersion(s);switch(i){case"2.0.3":this.processIOFV2XMLCourses(s);break;case"3.0":this.processIOFV3XMLCourses(s);break;default:b("XML file error","Invalid IOF file format. Version "+i+" not supported.")}}getVersion(e){let s="",n=e.getElementsByTagName("IOFVersion");return n.length>0&&(s=n[0].getAttribute("version")),s===""&&(n=e.getElementsByTagName("CourseData"),n.length>0&&(s=n[0].getAttribute("iofVersion").trim(),this.setCreator(n[0].getAttribute("creator").trim()))),s}setCreator(e){e.indexOf("Condes")>-1&&e.length>15&&parseFloat(e.substring(15))<10.1&&(this.fromOldCondes=!0)}processIOFV3XMLCourses(e){let s=e.getElementsByTagName("Control"),n={x:0,y:0};for(let i=0;i<s.length;i+=1)if(s[i].parentNode.nodeName==="RaceCourseData"){const l=s[i].getElementsByTagName("Id")[0].textContent,r=s[i].getElementsByTagName("Position");this.localWorldfile.valid&&r.length>0?(n=this.getXYFromLatLng(r),this.coursesGeoreferenced=!0):n=this.getXYFromMapPosition(s[i].getElementsByTagName("MapPosition")),s[i].getAttribute("type")!=="CrossingPoint"&&(this.newcontrols.addControl(l.trim(),n.x,n.y),r.length>0&&(parseFloat(r[0].getAttribute("lat")),parseFloat(r[0].getAttribute("lng"))),n.x,n.y)}s=e.getElementsByTagName("Course"),this.extractV3Courses(s),s=e.getElementsByTagName("ClassCourseAssignment"),this.extractV3CourseClassMapping(s)}processKMLCourses(e){this.coursesGeoreferenced=!0;const s=e.getElementsByTagName("Placemark");for(let r=0;r<s.length;r=r+1){let o={};const f=s[r].getElementsByTagName("name")[0].childNodes[0].nodeValue.trim(),u=s[r].getElementsByTagName("Point")[0].getElementsByTagName("coordinates")[0].childNodes[0].nodeValue.trim().split(","),m=+u[1],v=+u[0];o.x=this.worldfile.getX(v,m),o.y=this.worldfile.getY(v,m),this.newcontrols.addControl(f.trim(),o.x,o.y)}let n=[];const i="Course 1",l="Course 1";n=this.newcontrols.controls.map(function(r){return r.code}),this.courses.push({courseid:0,x:[],y:[],codes:n,name:i}),this.courseClassMapping.push({course:i,className:l}),document.getElementById("rg2-select-course-file").classList.add("is-valid")}getXYFromLatLng(e){let s={x:0,y:0};const n=parseFloat(e[0].getAttribute("lat")),i=parseFloat(e[0].getAttribute("lng"));return this.fromOldCondes?(s.x=this.localWorldfile.getX(i,n),s.y=this.localWorldfile.getY(i,n)):(s.x=this.worldfile.getX(i,n),s.y=this.worldfile.getY(i,n)),s}processIOFV2XMLCourses(e){if(this.extractV2Controls(e.getElementsByTagName("StartPoint"),"StartPointCode"),this.extractV2Controls(e.getElementsByTagName("Control"),"ControlCode"),this.coursesGeoreferenced=this.extractV2Controls(e.getElementsByTagName("FinishPoint"),"FinishPointCode"),this.coursesGeoreferenced&&this.localWorldfile.valid)for(let s=0;s<this.newcontrols.controls.length;s+=1){const n=this.newcontrols.controls[s].x,i=this.newcontrols.controls[s].y;this.newcontrols.controls[s].x=this.localWorldfile.getX(n,i),this.newcontrols.controls[s].y=this.localWorldfile.getY(n,i)}this.extractV2Courses(e.getElementsByTagName("Course"))}extractV2Courses(e){for(let s=0;s<e.length;s+=1){let n=[],i=[],l=[];const r=e[s].getElementsByTagName("CourseName")[0].textContent.trim();n=this.extractCodesFromControlList(e[s],"ControlCode"),n.unshift(e[s].getElementsByTagName("StartPointCode")[0].textContent.trim()),n.push(e[s].getElementsByTagName("FinishPointCode")[0].textContent.trim()),this.courses.push({courseid:0,x:i,y:l,codes:n,name:r})}document.getElementById("rg2-select-course-file").classList.add("is-valid")}extractV3Courses(e){for(let s=0;s<e.length;s+=1){let n=[],i=[],l=[];const r=e[s].getElementsByTagName("Name")[0].textContent.trim();n=this.extractCodesFromControlList(e[s],"Control"),this.courses.push({courseid:0,x:i,y:l,codes:n,name:r})}document.getElementById("rg2-select-course-file").classList.add("is-valid")}extractV3CourseClassMapping(e){for(let s=0;s<e.length;s+=1){const n=e[s].getElementsByTagName("CourseName")[0].textContent.trim(),i=e[s].getElementsByTagName("ClassName")[0].textContent.trim();this.courseClassMapping.push({course:n,className:i})}document.getElementById("rg2-select-course-file").classList.add("is-valid")}extractCodesFromControlList(e,s){const n=e.getElementsByTagName("CourseControl");let i=[];for(let l=0;l<n.length;l+=1)if(l===0||n[l].getAttribute("type")!=="Start"){const r=n[l].getElementsByTagName(s)[0].textContent.trim();this.validControlCode(r)&&i.push(r)}return i}extractV2Controls(e,s){let n=!1,i={x:0,y:0};for(let l=0;l<e.length;l+=1){const r=e[l].getElementsByTagName(s)[0].textContent,o=e[l].getElementsByTagName("ControlPosition");o.length>0&&this.localWorldfile.valid?(i.x=parseFloat(o[0].getAttribute("x")),i.y=parseFloat(o[0].getAttribute("y")),n=!0):i=this.getXYFromMapPosition(e[l].getElementsByTagName("MapPosition")),this.newcontrols.addControl(r.trim(),i.x,i.y)}return n}getXYFromMapPosition(e){return{x:e[0].getAttribute("x").replace(",","."),y:e[0].getAttribute("y").replace(",",".")}}validControlCode(e){const s=this.newcontrols.controls;for(let n=0;n<s.length;n+=1)if(s[n].code===e)return!0;return!1}addControlCount(){for(let e=0;e<this.courses.length;e+=1)this.courses[e].controlcount=this.courses[e].codes.length-2}}class bl{constructor(){if(this.georefsystems=[],this.georefsystems.push({name:"Not georeferenced",description:"none",params:"",value:0}),this.georefsystems.push({name:"GB National Grid",description:"EPSG:27700",params:"+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs",value:1}),this.georefsystems.push({name:"Google EPSG:900913",description:"EPSG:900913",params:"+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs",value:2}),rg2Config.epsg_code!==void 0){const e=rg2Config.epsg_code.split("|"),s=rg2Config.epsg_params.split("|");for(let n=0;n<e.length;n=n+1)this.georefsystems.push({name:e[n].replace(" ",""),description:e[n].replace(" ",""),params:s[n],value:n+3});this.defaultGeorefVal=3}else this.defaultGeorefVal=1}getDefaultValue(){return this.georefsystems[this.defaultGeorefVal].value}getGeorefDropdown(){let e="";for(let s=0;s<this.georefsystems.length;s+=1)e+=Ce(s,this.georefsystems[s].name,s===0);return e}getGeorefSystem(e){return this.georefsystems[e]}}class fe{constructor(e){e.A===void 0?(this.valid=!1,this.A=0,this.B=0,this.C=0,this.D=0,this.E=0,this.F=0):(this.A=parseFloat(e.A),this.B=parseFloat(e.B),this.C=parseFloat(e.C),this.D=parseFloat(e.D),this.E=parseFloat(e.E),this.F=parseFloat(e.F),this.valid=!0,this.AEDB=e.A*e.E-e.D*e.B,this.xCorrection=e.B*e.F-e.E*e.C,this.yCorrection=e.D*e.C-e.A*e.F)}getLat(e,s){return this.D*e+this.E*s+this.F}getLon(e,s){return this.A*e+this.B*s+this.C}getX(e,s){return Math.round((this.E*e-this.B*s+this.xCorrection)/this.AEDB)}getY(e,s){return Math.round((-1*this.D*e+this.A*s+this.yCorrection)/this.AEDB)}}class Pn{constructor(e){e!==void 0?(this.mapid=e.mapid,this.name=e.name,this.worldfile=new fe(e),this.localworldfile=new fe({A:e.localA,B:e.localB,C:e.localC,D:e.localD,E:e.localE,F:e.localF}),e.mapfilename===void 0?this.mapfilename=this.mapid+".jpg":this.mapfilename=e.mapfilename):(this.mapid=0,this.name="",this.worldfile=new fe(0),this.localworldfile=new fe(0)),this.xpx=[],this.ypx=[],this.lat=[],this.lon=[]}}class Il{constructor(e){return this.results=[],this.CSVFormat={},this.separator="",this.valid=!0,this.processResultsCSV(e),{results:this.results,valid:this.valid}}extractResult(e,s,n){let f={};f.chipid=0,f.name=(e[0]+" "+e[1]+" "+e[2]).trim(),f.dbid=f.chipid+"__"+f.name,f.starttime=nl(e[3]),f.club=e[2],f.course=s,f.controls=n;const y=this.extractSpklasseSplits(e);f.splits=y.splits,f.codes=y.codes,f.time=_(y.totaltime),this.results.push(f)}extractSingleCSVResult(e){let s={};s.valid=!0,s.chipid=e[this.CSVFormat.CHIP_IDX],s.name=(e[this.CSVFormat.FIRST_NAME_IDX]+" "+e[this.CSVFormat.SURNAME_IDX]).trim().replace(/"/g,""),s.dbid=e[this.CSVFormat.DB_IDX],s.starttime=ve(e[this.CSVFormat.START_TIME_IDX]),s.time=e[this.CSVFormat.TOTAL_TIME_IDX],s.position=this.getPosition(e),s.status=this.getSICSVStatus(e[this.CSVFormat.NC_IDX],e[this.CSVFormat.CLASSIFIER_IDX]),s.club=e[this.CSVFormat.CLUB_IDX].trim().replace(/"/g,""),s.course=e[this.CSVFormat.COURSE_IDX],s.course===""&&(s.valid=!1),s.controls=parseInt(e[this.CSVFormat.NUM_CONTROLS_IDX],10);const n=this.extractSISplits(e,s.controls);return s.splits=n.splits,s.splits!==""&&(s.splits+=";"),s.splits+=ve(s.time),s.codes=n.codes,s}extractSISplits(e,s){let n=this.CSVFormat.FIRST_SPLIT_IDX,i=this.CSVFormat.FIRST_CODE_IDX,l={};l.splits="",l.codes=[];for(let r=0;r<s;r+=1)e[i]&&(r>0&&(l.splits+=";"),l.codes[r]=e[i],l.splits+=ve(e[n])),n+=this.CSVFormat.STEP,i+=this.CSVFormat.STEP;return{splits:l.splits,codes:l.codes}}extractSpklasseSplits(e){let n="",i=[],l=0;for(let r=0;r<e.length-4;r+=1)r>0&&(n+=";"),i[r]="X",l+=ve(e[r+4]),n+=l;return{splits:n,codes:i,totaltime:l}}getCSVFormat(e){const s=["si card","database id","surname","first name","nc","start","time","classifier","city","short","course","course controls","pl","start punch","control1","punch1","control2"];let n=[];const i=e.split(this.separator).map(function(r){return r.toLowerCase()});let l=!1;for(let r=0;r<s.length;r+=1){l=!1;for(let o=0;o<i.length;o+=1){if(i[o]===s[r]){n[r]=o,l=!0;break}if(s[r]==="si card"&&(i[o]==="chipno"||i[o]==="sicard"||i[o]==="database id")){n[r]=o,l=!0;break}if(s[r]==="nc"&&i[o]==="classifier"){n[r]=o,l=!0;break}if(s[r]==="city"&&i[o]==="club"){n[r]=o,l=!0;break}if(s[r]==="pl"&&i[o]==="place"){n[r]=o,l=!0;break}}if(!l)break}l||(n=[1,2,3,4,8,9,11,12,15,18,39,42,43,44,46,47,48]),this.setCSVFormat(n)}getPosition(e){let s=parseInt(e[this.CSVFormat.POSITION_IDX],10);return isNaN(s)&&(s=""),s}getSICSVStatus(e,s){return e==="0"||e===""||e==="N"||e==="n"?s===""||s==="0"?"ok":"nok":"nc"}processCSVResults(e){for(let s=1;s<e.length;s+=1){const n=e[s].split(this.separator);if(n.length>=this.CSVFormat.FIRST_SPLIT_IDX){let i=this.extractSingleCSVResult(n);i.valid&&(delete i.valid,this.results.push(i))}}}processResultsCSV(e){const s=e.split(/[\r\n|\n]+/),n=s[0].split(",").length-1,i=s[0].split(";").length-1;n>i?this.separator=",":this.separator=";",s[0].split(this.separator).length===2?this.processSpklasseCSVResults(s):(this.getCSVFormat(s[0]),this.processCSVResults(s))}processSpklasseCSVResults(e){let i=[],l="",r=0;for(let o=0;o<e.length;o+=1)i=e[o].split(this.separator),i.length===2?(l=i[0],r=parseInt(i[1],10)):this.extractResult(i,l,r)}setCSVFormat(e){this.CSVFormat.CHIP_IDX=e[0],this.CSVFormat.DB_IDX=e[1],this.CSVFormat.SURNAME_IDX=e[2],this.CSVFormat.FIRST_NAME_IDX=e[3],this.CSVFormat.NC_IDX=e[4],this.CSVFormat.START_TIME_IDX=e[5],this.CSVFormat.TOTAL_TIME_IDX=e[6],this.CSVFormat.CLASSIFIER_IDX=e[7],this.CSVFormat.CLUB_IDX=e[8],this.CSVFormat.CLASS_IDX=e[9],this.CSVFormat.COURSE_IDX=e[10],this.CSVFormat.NUM_CONTROLS_IDX=e[11],this.CSVFormat.POSITION_IDX=e[12],this.CSVFormat.START_PUNCH_IDX=e[13],this.CSVFormat.FIRST_CODE_IDX=e[14],this.CSVFormat.FIRST_SPLIT_IDX=e[15],this.CSVFormat.STEP=e[16]-e[14]}}class Sl{constructor(e){return this.results=[],this.valid=!0,this.processIOFV2Results(e),{results:this.results,valid:this.valid}}extractIOFV2Results(e,s){for(let n=0;n<e.length;n+=1){s.status=ns(e[n].getElementsByTagName("CompetitorStatus"),"value",""),s.position=this.getPosition(e[n].getElementsByTagName("ResultPosition")),s.chipid=ne(e[n].getElementsByTagName("CCardId"),0),s.time=this.getTime(e[n].getElementsByTagName("Time")),s.starttime=this.getStartFinishTimeAsSecs(e[n].getElementsByTagName("StartTime")),s.splits="",s.codes=[];const i=e[n].getElementsByTagName("SplitTime");s.controls=i.length,this.extractIOFV2Splits(i,s);const l=this.getStartFinishTimeAsSecs(e[n].getElementsByTagName("FinishTime"));s.splits+=Math.max(l-s.starttime,0)}}extractIOFV2Splits(e,s){for(let n=0;n<e.length;n+=1){n>0&&(s.splits+=";");const i=e[n].getElementsByTagName("Time");i.length>0?(s.splits+=ve(i[0].textContent),s.codes[n]=ne(e[n].getElementsByTagName("ControlCode"),"")):(s.splits+=0,s.codes[n]="")}s.splits+=";"}getDBID(e,s){return e.length===0?s:(e=e[0].textContent.replace(/[\n\r]/g,"").trim(),e||s)}getName(e){return(e.getElementsByTagName("Given")[0].textContent+" "+e.getElementsByTagName("Family")[0].textContent).replace(/[\n\r]/g,"").trim()}getPosition(e){return e.length>0?parseInt(e[0].textContent,10):""}getStartFinishTimeAsSecs(e){if(e.length>0){const s=e[0].getElementsByTagName("Clock")[0].textContent;return ve(s)}return 0}getTime(e){return e.length>0?e[0].textContent.replace(/[\n\r]/g,""):""}processIOFV2Results(e){try{const s=e.getElementsByTagName("ClassResult");for(let n=0;n<s.length;n+=1){const i=s[n].getElementsByTagName("ClassShortName")[0].textContent,l=s[n].getElementsByTagName("PersonResult");for(let r=0;r<l.length;r+=1){let o={};o.course=i,o.name=this.getName(l[r]),o.dbid=this.getDBID(l[r].getElementsByTagName("PersonId"),r),o.club=ne(l[r].getElementsByTagName("ShortName"),"");const f=l[r].getElementsByTagName("Result");this.extractIOFV2Results(f,o),o.status!=="DidNotStart"&&this.results.push(o)}}}catch(s){this.valid=!1,b("XML parse error","Error processing XML file. Error is : "+s.message);return}}}class Tl{constructor(e){return this.results=[],this.valid=!0,this.processIOFV3Results(e),{results:this.results,valid:this.valid}}extractIOFV3Results(e,s){for(let n=0;n<e.length;n+=1){s.chipid=ne(e[n].getElementsByTagName("ControlCard"),0),s.position=ne(e[n].getElementsByTagName("Position"),""),s.position==="0"&&(s.position=""),s.status=ne(e[n].getElementsByTagName("Status"),""),s.time=this.getTotalTimeAsSeconds(e[n].getElementsByTagName("Time")),s.starttime=this.getStartFinishTimeAsSeconds(ne(e[n].getElementsByTagName("StartTime"),0)),s.splits="",s.codes=[];const i=e[n].getElementsByTagName("SplitTime");this.extractIOFV3Splits(i,s);const l=this.getStartFinishTimeAsSeconds(ne(e[n].getElementsByTagName("FinishTime"),0));l>0?s.splits+=l-s.starttime:s.splits+=0}}extractIOFV3Splits(e,s){let n=[];for(let i=0;i<e.length;i+=1)e[i].attributes.length===0?(s.splits+=ne(e[i].getElementsByTagName("Time"),0),n.push(ne(e[i].getElementsByTagName("ControlCode"),"X"+i)),s.splits+=";"):e[i].getAttribute("status")==="Missing"&&(s.splits+="0",n.push(ne(e[i].getElementsByTagName("ControlCode"),"X"+i)),s.splits+=";");s.codes=n,s.controls=s.codes.length}getClub(e){return e.length>0&&e[0].getElementsByTagName("Name")[0]?e[0].getElementsByTagName("Name")[0].textContent:""}getID(e,s){if(e.length>0){let n=e[0].textContent;return n.replace(/[\n\r]/g,""),n.trim()}return s}getStartFinishTimeAsSeconds(e){return e.length>=19?ve(e.substr(11,8)):0}getTotalTimeAsSeconds(e){if(e.length>0&&e[0].textContent){const s=parseInt(e[0].textContent,10);return _(s)}return"00:00"}processIOFV3Results(e){try{const s=e.getElementsByTagName("ClassResult");for(let n=0;n<s.length;n+=1){const l=s[n].getElementsByTagName("Class")[0].getElementsByTagName("Name")[0].textContent,r=s[n].getElementsByTagName("PersonResult");for(let o=0;o<r.length;o+=1){let f={};f.course=l;const y=r[o].getElementsByTagName("Given")[0].textContent+" "+r[o].getElementsByTagName("Family")[0].textContent;f.name=y.replace(/[\n\r]/g,"").trim(),f.dbid=this.getID(r[o].getElementsByTagName("Id"),o),f.club=this.getClub(r[o].getElementsByTagName("Organisation"));const u=r[o].getElementsByTagName("Result");this.extractIOFV3Results(u,f),f.status!=="DidNotStart"&&this.results.push(f)}}}catch(s){this.valid=!1,b("XML parse error","Error processing XML file. Error is : "+s.message);return}}}class Cl{constructor(e,s){this.results=[],this.resultCourses=[],this.valid=!0;const n=this.processResults(e,s);return this.results=n.results,this.valid=n.valid,this.getCoursesFromResults(),{results:this.results,resultCourses:this.resultCourses,valid:this.valid}}getCoursesFromResults(){for(let e=0;e<this.results.length;e+=1){let s=!1;for(let n=0;n<this.resultCourses.length;n+=1)if(this.resultCourses[n].course===this.results[e].course){s=!0;break}s||this.resultCourses.push({course:this.results[e].course,courseid:h.DO_NOT_SAVE_COURSE})}}processResults(e,s){switch(s){case"CSV":return new Il(e.target.result);case"XML":return this.processResultsXML(e.target.result);default:return b("File type error","Results file type is not recognised. Please select a valid file."),{results:[],valid:!1}}}processResultsXML(e){let s="",n;try{if(n=new DOMParser().parseFromString(e,"text/xml"),n.getElementsByTagName("ResultList").length===0)return b("XML file error","File is not a valid XML results file. ResultList element missing."),{results:[],valid:!1};s=ns(n.getElementsByTagName("IOFVersion"),"version",""),s===""&&(s=ns(n.getElementsByTagName("ResultList"),"iofVersion",""))}catch{return b("XML file error","File is not a valid XML results file."),{results:[],valid:!1}}switch(s){case"2.0.3":return new Sl(n);case"3.0":return new Tl(n);default:return b("XML file error","Invalid IOF file format. Version "+s+" not supported."),{results:[],valid:!1}}}}class kl{constructor(e){this.x="",this.y=e,this.name=null,this.password=null}setDetails(e,s){const n=/...../;this.name=document.getElementById(e).value;const i=n.test(this.name);this.password=document.getElementById(s).value;const l=n.test(this.password);return i&&l}alterString(e,s){let n="";for(let i=0;i<e.length;i+=1)n+=e.charAt(i)+s.charAt(i);return n}encodeUser(){return{x:this.alterString(this.name+this.password,this.y),y:this.y}}}let se=null,K=new Pn,ys=new bl,xe=null,Oe=null,Qe=!1,ct=!0,I=null,D=[],te=[],Ht=!1,de=!1,Bt=!1,ut=!1,ze=!1,re={},M=[],Ie=[],Z=[],Tt,At,vs="";const ls=["UTF-8","ISO-8859-1","windows-1251"];let Ct=[],$e=0,rs=!1,ht=!1,Es=!1,Y={x:null,y:null},ge=[],j={height:0,width:0},Be=new fe(0),Fn=new fe(0),et=null,Ee=[],xs=null,Xt=null;const On="e.g. 1|1|6,60|15,60";function Dl(t,e){let s;I.controls.length===0?s="S"+(I.controls.length+1):s="X"+(I.controls.length+1),I.addControl(s,t,e),I.displayAllControls(),re.codes.push(s),re.x.push(t),re.y.push(e)}function Ll(t,e,s){if(ht||s===h.RIGHT_CLICK)a.translate(e.x-t.x,e.y-t.y);else if(ut=!0,Y.x!==null){const n=(e.x-Y.x)/(t.x-Y.x),i=(e.y-Y.y)/(t.y-Y.y);if(isFinite(n)&&isFinite(i))for(let l=0;l<I.controls.length;l+=1){const r=I.controls[l].oldX-Y.x,o=I.controls[l].oldY-Y.y;I.controls[l].x=r*n+Y.x,I.controls[l].y=o*i+Y.y}}else{const n=e.x-t.x,i=e.y-t.y;for(let l=0;l<I.controls.length;l+=1)I.controls[l].x=I.controls[l].oldX+n,I.controls[l].y=I.controls[l].oldY+i}}function wl(t){const e=Or(t.target.result);if(e===0||rs){kr(t);return}if(Ct[$e]=e,$e+=1,$e===ls.length){let s=99999;for(let n=0;n<ls.length;n+=1)s>Ct[n]&&($e=n,s=Ct[n]);rs=!0}jn()}function Bl(){let t={};t.body="Are you sure you want to add this map?",t.title="Confirm new map",t.classes="rg2-confirm-add-map-dialog",t.doText="Add map",t.onDo=Gl,ye(t)}function Al(t){t.preventDefault();const e=Gr();if(e!=="OK"){b("Event set-up incomplete",e+" Please enter all necessary information and make sure controls are aligned before creating the event.");return}let s={};s.body="Are you sure you want to create this event?",s.title="Confirm event creation",s.classes="rg2-confirm-create-event-dialog",s.doText="Create event",s.onDo=Ol,ye(s)}function Rl(){let t={};t.body="This event will be deleted. Are you sure?",t.title="Confirm event delete",t.classes="rg2-confirm-delete-event-dialog",t.doText="Delete event",t.onDo=$l,ye(t)}function Ml(){let t={};t.body="This route will be permanently deleted. Are you sure?",t.title="Confirm route delete",t.classes="rg2-confirm-route-delete-dialog",t.doText="Delete route",t.onDo=Hl,ye(t)}function Nl(){const t=document.querySelectorAll(".unused-map input[type=checkbox]:checked");let e=[];for(let n of t){n.checked&&e.push(parseInt(n.dataset.mapId,10));for(let i=0;i<Ee.length;i+=1)e.indexOf(Ee[i].mapid)>-1?Ee[i].delete=!0:Ee[i].delete=!1}if(e.length===0){b("Warning","No maps selected.");return}const s={};s.body="Selected maps will be deleted. Are you sure?",s.title="Confirm map deletion",s.doText="Delete maps",s.onDo=Xl,ye(s)}function _l(){let t={};t.body=`Are you sure you want to update ${document.getElementById("rg2-edit-event-name").value}?`,t.title="Confirm event update",t.doText="Update event",t.onDo=Ul,ye(t)}function $n(t){try{const e=ys.getGeorefSystem(t);if(j=ke(),!Be.valid||j.width===0||e.name==="none")throw"Do not georeference";vt.defs(e.name,e.params);const s=new vt.Proj(e.name),n=new vt.Proj("EPSG:4326"),i=[0,j.width,j.width,0],l=[0,j.height,0,j.height];let r=[],o=[];for(let u=0;u<4;u+=1)r[u]=Be.getLon(i[u],l[u]),o[u]=Be.getLat(i[u],l[u]);K.xpx.length=0,K.ypx.length=0,K.lat.length=0,K.lon.length=0;let f=[];for(let u=0;u<4;u+=1){let m={};m.x=r[u],m.y=o[u],f.push(m);const v=vt(s,n,f[u]);K.xpx.push(i[u]),K.ypx.push(l[u]),K.lat.push(v.y),K.lon.push(v.x)}let y={};y.C=f[0].x,y.F=f[0].y,y.A=(f[2].x-y.C)/i[2],y.B=(f[3].x-y.C)/l[3],y.D=(f[2].y-y.F)/i[2],y.E=(f[3].y-y.F)/l[3],K.worldfile=new fe(y),zs()}catch{K.worldfile=new fe(0),zs();return}}function Hn(){for(let t=0;t<I.controls.length;t+=1)I.controls[t].oldX=I.controls[t].x,I.controls[t].oldY=I.controls[t].y}function Pl(t,e){let s=-1;for(let i=0;i<D.length;i+=1)if(D[i].name===t){s=i;break}if(s===-1&&te.length>0){for(let i=0;i<te.length;i+=1)if(te[i].className===t){for(let l=0;l<D.length;l+=1)if(D[l].name===te[i].course){s=l;break}break}}let n=`<select id='rg2-alloc-${e}' class="form-control form-control-sm">`;n+=`<option value="${h.DO_NOT_SAVE_COURSE}"${s===-1?" selected":""}>Do not save</option>`;for(let i=0;i<D.length;i+=1)n+=`<option value="${i}"${s===i?" selected":""}>${Un(D[i].name)}</option>`;return n+="</select >",n}function bs(){if(!ct){Z.length=0;for(let t=0;t<D.length;t+=1)Z.push({courseid:D[t].courseid,course:D[t].name})}}function Vt(){let t="";if(D.length&&Z.length){t='<div class="fw-bold">Results</div><div class="fw-bold">Course</div>';for(let e=0;e<Z.length;e+=1)t+=`<div>${Z[e].course}</div>`,t+=`<div>${Pl(Z[e].course,e)}</div>`;document.getElementById("rg2-course-allocations").innerHTML=t}}function Xn(t,e){let s={};s.body=e,s.title=t,s.doText="Ok",s.onDo=()=>{},ye(s,!1)}function Vn(t){let e="<div class='title'>ID</div><div class='title'>Name</div><div><i class='bi-trash'></i></div>";if(t.length===0)e+="<div></div><div>None found.</div><div></div>",document.getElementById("btn-delete-unused-maps").setAttribute("disabled","");else{for(let s=0;s<t.length;s+=1)e+="<div>"+t[s].mapid+"</div>",e+="<div>"+t[s].name+"</div>",e+="<div class='unused-map'><input type='checkbox' data-map-id="+t[s].mapid+"></div>";document.getElementById("btn-delete-unused-maps").removeAttribute("disabled")}document.getElementById("rg2-unused-maps").innerHTML=e}function Fl(){const t={type:"addmap"};K.localworldfile=Be;const e={...K,...se.encodeUser()};pe(JSON.stringify(e),t,hr,"Map save failed",De)}function Ol(){const t={...Zl(),...se.encodeUser()},e={type:"createevent"};pe(JSON.stringify(t),e,ar,"Event creation failed",De)}function $l(){const e={type:"deleteevent",id:document.getElementById("rg2-edit-event-selected").value};pe(JSON.stringify(se.encodeUser()),e,dr,"Event deletion failed",De)}function Hl(){const t=document.getElementById("rg2-edit-event-selected").value,e=document.getElementById("rg2-route-selected").value,s={type:"deleteroute",id:t,routeid:e};pe(JSON.stringify(se.encodeUser()),s,mr,"Route delete failed",De)}function Xl(){let t=se.encodeUser();t.maps=Ee.filter(s=>s.delete===!0).map(s=>s.mapid);const e={type:"deleteunusedmaps"};pe(JSON.stringify(t),e,pr,"Map deletion failed",De)}function Is(){Pt({type:"maps"},gr,"Events request failed")}function Vl(){const t={type:"login"};pe(JSON.stringify(se.encodeUser()),t,ur,"Login failed",De)}function Ul(){const t=document.getElementById("rg2-edit-event-selected").value;let e=se.encodeUser();e.comments=document.getElementById("rg2-edit-event-comments").value,e.locked=document.getElementById("chk-edit-read-only").checked,e.name=document.getElementById("rg2-edit-event-name").value,e.type=document.getElementById("rg2-edit-event-level").value,e.eventdate=Xt.getDate("yyyy-mm-dd"),e.club=document.getElementById("rg2-edit-club-name").value;let s=document.getElementById("rg2-edit-exclude").value.trim();s===On&&(s=""),e.exclude=s;const n={type:"editevent",id:t};pe(JSON.stringify(e),n,cr,"Event update failed",De)}function Gl(){const t=se.encodeUser();let e=new FormData;e.append(Tt.name,Tt),e.append("name",Tt.name),e.append("x",t.x),e.append("y",t.y),pe(e,{type:"uploadmapfile",headers:{"Content-Type":"multipart/form-data"}},fr,"Map upload failed",De)}function Yl(){if(de&&I.controls.length>0){I.drawControls(!0);const t=dt();Y.x!==null&&(a.lineWidth=t.overprintWidth,a.strokeStyle=h.HANDLE_COLOUR,a.fillStyle=h.HANDLE_COLOUR,a.globalAlpha=1,a.beginPath(),a.arc(Y.x,Y.y,h.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),a.fill(),a.beginPath(),a.arc(Y.x,Y.y,2*h.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),a.stroke())}}function Wl(){document.querySelector("#rg2-info-panel-tab-headers li").remove(),document.querySelector("#rg2-manage-login-tab-body").remove(),document.getElementById(h.TAB_CREATE).classList.remove("d-none"),document.getElementById(h.TAB_CREATE).click(),document.getElementById(h.TAB_EDIT).classList.remove("d-none"),document.getElementById(h.TAB_MAP).classList.remove("d-none"),document.getElementById(h.TAB_DELETE_MAP).classList.remove("d-none"),Is(),Ar(),document.getElementById("rg2-select-event-level").innerHTML=js(),document.getElementById("rg2-edit-event-level").innerHTML=js(),document.getElementById("rg2-georef-type").innerHTML=ys.getGeorefDropdown(),document.getElementById("rg2-select-map").addEventListener("change",t=>{xe=parseInt(t.target.value,10),xe!==h.INVALID_MAP_ID?Hs(rg2Config.maps_url+"/"+ge[xe].mapfilename):(de=!1,j.width=0,j.height=0)}),xs=new Vs(document.getElementById("rg2-select-event-date"),{buttonClass:"btn",autohide:!0,format:"yyyy-mm-dd"}),Xt=new Vs(document.getElementById("rg2-edit-event-date"),{buttonClass:"btn",autohide:!0,format:"yyyy-mm-dd"}),document.getElementById("rg2-map-name").addEventListener("change",function(){_r()}),document.getElementById("rg2-new-course-name").addEventListener("change",function(){Mr()}),document.getElementById("rg2-edit-event-selected").addEventListener("change",t=>{ft(parseInt(t.target.value,10))}),document.getElementById("rg2-georef-type").addEventListener("change",t=>{Nr(parseInt(t.target.value,10))})}function Un(t){let e="";if(te&&te.length>0&&Ht)for(let s=0;s<te.length;s+=1){const n=te[s].course;let i="";n===t&&(e!==""&&(e+=", "),i=te[s].className,i=i.replace(/ /g,""),i=i.replace(/-/g,""),e+=i)}return e!==""?t+": "+e:t}function jl(){if(Ht)for(let t=0;t<D.length;t+=1)D[t].name=Un(D[t].name)}function ql(){const t=parseInt(document.getElementById("rg2-edit-event-selected").value,10),e=Ms(t);document.getElementById("rg2-edit-event-name").value=ae(e.name),document.getElementById("rg2-edit-club-name").value=ae(e.club),Xt.setDate(e.date),document.getElementById("rg2-edit-event-level").value=e.rawtype,document.getElementById("rg2-edit-event-comments").value=ae(e.comment),rt()?document.getElementById("rg2-exclude-info").classList.add("d-none"):(document.getElementById("rg2-edit-exclude").value=e.exclude,document.getElementById("rg2-exclude-info").classList.remove("d-none")),document.getElementById("chk-edit-read-only").checked=e.locked,document.getElementById("rg2-route-selected").innerHTML=rr(e.id)}function zl(t){document.getElementById("rg2-edit-event-selected").innerHTML=nr(t),ge.length>0&&(Gn(ge),Vn(Ee))}function Kl(){Ie.length=0;let t;for(let e=0;e<M.length;e+=1){let s=M[e].codes;for(let n=0;n<D.length;n+=1)if(D[n].courseid===M[e].courseid){t=D[n];break}s.unshift(t.codes[0]),s.push(t.codes[t.codes.length-1]),M[e].variantid=or(M[e].codes,M[e].courseid)}}function Gn(t){Ee.length=0;for(let e=0;e<t.length;e+=1)if(!Dd(t[e].mapid)){const s={};s.mapid=t[e].mapid,s.name=t[e].name,s.name===""&&(s.name="(None)"),s.delete=!1,Ee.push(s)}}function Ss(){let t=!1;if(de&&I.controls.length>0){const e=Jl();if(Bt&&(e.maxX<0||e.minX>j.width||e.minY>j.height||e.maxY<0?b("Course file problem","Your course file does not match the map co-ordinates. Please check you have selected the correct file."):t=!0),t)ht=!0,ut=!0,document.getElementById("chk-move-map-and-controls").checked=!0;else{let s=.8;for(let n=0;n<I.controls.length;n+=1)I.controls[n].x=(I.controls[n].x-e.minX)*(j.width/e.xRange)*s+j.width*(1-s)*.5,I.controls[n].y=j.height-(I.controls[n].y-e.minY)*(j.height/e.yRange)*s-j.height*(1-s)*.5}Hn(),I.displayAllControls()}}function Zl(){let t=se.encodeUser();if(t.name=document.getElementById("rg2-event-name").value,t.mapid=ge[xe].mapid,t.eventdate=xs.getDate("yyyy-mm-dd"),t.comments=document.getElementById("rg2-enter-event-comments").value,t.locked=document.getElementById("chk-read-only").checked,t.club=document.getElementById("rg2-select-club-name").value,ct?Qe?t.format=h.FORMAT_SCORE_EVENT:t.format=h.FORMAT_NORMAL:Qe?t.format=h.FORMAT_SCORE_EVENT_NO_RESULTS:t.format=h.FORMAT_NORMAL_NO_RESULTS,t.level=document.getElementById("rg2-select-event-level").value,ze&&(D.push(re),bs()),Rr(),Sr(),jl(),Br(),Qe&&(Kl(),t.variants=Ie.slice(0)),t.courses=D.slice(0),Es?t.results=M.slice(0).sort(Pr):t.results=M.slice(0),t.format===h.FORMAT_NORMAL)for(let e=0;e<t.results.length;e+=1)(t.results[e].splits.match(/;/g)||[]).length===Ql(t.courses,t.results[e].courseid)+1&&(t.results[e].splits=t.results[e].splits.substring(0,t.results[e].splits.lastIndexOf(";")));for(let e=0;e<t.results.length;e+=1)delete t.results[e].codes,delete t.results[e].chipid,delete t.results[e].club;return t}function Jl(){let t={};t.minX=I.controls[0].x,t.maxX=I.controls[0].x,t.minY=I.controls[0].y,t.maxY=I.controls[0].y;for(let e=1;e<I.controls.length;e+=1)t.maxX=Math.max(t.maxX,I.controls[e].x),t.maxY=Math.max(t.maxY,I.controls[e].y),t.minX=Math.min(t.minX,I.controls[e].x),t.minY=Math.min(t.minY,I.controls[e].y);return t.xRange=t.maxX-t.minX,t.yRange=t.maxY-t.minY,t}function Ql(t,e){for(let s=0;s<t.length;s+=1)if(t[s].courseid===e)return t[s].controlcount;return 0}function Yn(t){let e={x:0,y:0};for(let s=0;s<I.controls.length;s+=1)if(I.controls[s].code===t)return e.x=Math.round(I.controls[s].x),e.y=Math.round(I.controls[s].y),e;return e}function er(t){for(let e=0;e<Z.length;e+=1)if(Z[e].course===t)return Z[e].courseid;return 0}function tr(){let t='<div class="new-courses-table">';if(D.length){t+=`<div>${p("Course")}</div><div>${p("Name")}</div><div>${p("Controls")}</div>`;for(let e=0;e<D.length;e+=1)t+=`<div>${e+1}</div><div>${D[e].name}</div><div>${D[e].codes.length-2}</div>`}return t+="</div>",t}function sr(t){for(let e=0;e<D.length;e+=1)if(D[e].courseid===t)return D[e].name;return 0}function nr(t){let e=Ce(null,"No event selected",!0);for(let s=t.length-1;s>-1;s-=1)e+=Ce(t[s].kartatid,t[s].kartatid+": "+t[s].date+": "+ae(t[s].name));return e}function js(){let t="";const e=["Select level","Training","Local","Regional","National","International"],s=["X","T","L","R","N","I"];for(let n=0;n<e.length;n+=1)t+=Ce(s[n],e[n],n===0);return t}function ir(t){let e=Ce(h.INVALID_MAP_ID,"Select map",!0);for(let s=t.length-1;s>-1;s-=1)e+=Ce(s,t[s].mapid+": "+ae(t[s].name));return e}function lr(){let t="";if(M.length){t='<div class="new-results-table">';let e=0,s=null;for(let n=0;n<M.length;n+=1)M[n].course!==s&&(s!==null&&(t+=`<div>${e}</div>`,e=0),t+=`<div>${M[n].course}</div><div>${M[n].name}</div><div>${M[n].time}</div>`,s=M[n].course),e+=1;t+=`<div>${e}</div></div>`}else t="No valid results found.";return t}function rr(t){const e=po();let s=Ce("undefined","Select route");for(let n=0;n<e.length;n+=1)s+=Ce(e[n].resultid,e[n].resultid+": "+ae(e[n].name)+" on "+ae(e[n].coursename));return s}function or(t,e){let s=[],n=[],i=0;for(let l=0;l<Ie.length;l+=1)if(Ie[l].codes.length===t.length){let r=!0;for(let o=0;o<t.length;o+=1)if(Ie[l].codes[o]!==t[o]){r=!1;break}if(r){i=l+1;break}}if(i===0){i=Ie.length+1;for(let l=0;l<t.length;l+=1){const r=Yn(t[l]);s.push(r.x),n.push(r.y)}Ie.push({x:s,y:n,id:i,courseid:e,name:"Variant "+i,codes:t})}return i}function ar(t){t.ok?(b("Event created",document.getElementById("rg2-event-name").value+" has been added with id "+t.newid+"."),window.open(rg2Config.api_url.replace("rg2api.php","")+"#"+t.newid),Ze(),ft()):b("Save failed",t.status_msg+" Failed to create event. Please try again.")}function dr(t){t.ok?(b("Event deleted","Event has been deleted."),Ze(),ft(),document.getElementById("rg2-edit-event-selected").replaceChildren()):b("Delete failed",t.status_msg+". Event delete failed. Please try again.")}function cr(t,e){t.ok?(b("Event updated","Event "+e+" has been updated."),Wt(null),Ns(),Ze(),ft()):b("Update failed",t.status_msg+". Event update failed. Please try again.")}function De(t){se.y=t}function ur(t){t.ok?Wl():b("Login failed","User name or password incorrect. Please try again.")}function hr(t){t.ok?(b("Map added",t.name+" has been added with id "+t.newid+"."),Is()):b("Save failed",t.status_msg+". Failed to save map. Please try again.")}function fr(t){t.ok?Fl():b("Upload failed",t.status_msg+". Failed to upload map. Please try again.")}function gr(t){ge.length=0;for(let e=0;e<t.maps.length;e+=1)ge.push(new Pn(t.maps[e]));document.getElementById("rg2-select-map").innerHTML=ir(ge),Gn(ge),Vn(Ee)}function mr(t){t.ok?(b("Route deleted","Route has been deleted."),Wt(null),Ns(),Ze(),ft()):b("Delete failed",t.status_msg+". Delete failed. Please try again.")}function pr(t){t.ok?b("Maps deleted","Selected maps have been deleted."):b("Delete failed",t.status_msg+". Delete failed. Please try again."),Is()}function qs(t){return t===0||t==="0"||t==="0:00"||t==="00:00"}function Wn(){I=new ps,xe=h.INVALID_MAP_ID,Oe=h.FORMAT_NORMAL,Qe=!1,ct=!0,D=[],te=[],Ht=!1,de=!1,Bt=!1,ut=!1,ze=!1,re={},M=[],Ie=[],Z=[],j={height:0,width:0},At=void 0,vs="",ht=!1,Es=!1,Y={x:null,y:null}}function yr(){$e=0,Ct=[],rs=!1}function vr(t){se=new kl(t),et=gs.map("rg2-world-file-map"),Wn(),Er(),document.getElementById("rg2-manager-login-form").addEventListener("submit",e=>{e.preventDefault(),se.setDetails("rg2-user-name","rg2-password")?Vl():b("Login failed","Please enter user name and password of at least five characters")})}function Er(){gs.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(et),document.getElementById("rg2-world-file-map-container").classList.remove("d-none")}function xr(){de&&I.controls.length>0&&Hn()}function br(){de=!0,xe!==h.INVALID_MAP_ID&&(Be=ge[xe].localworldfile,Fn=ge[xe].worldfile),j=ke(),Ss(),S()}function Ir(t,e){if(ze){Dl(t,e),ut=!0;return}de&&I.controls.length>0&&(Y.x===null?Y={x:t,y:e}:Y={x:null,y:null})}function Sr(){let t=[],e=1;for(let s=0;s<Z.length;s+=1){let n;if(ze)n=0;else{const i=document.getElementById("rg2-alloc-"+s);i&&(n=parseInt(i.value,10))}n!==void 0&&n!==h.DO_NOT_SAVE_COURSE&&(D[n].courseid===0?(D[n].courseid=e,t.push(D[n]),Z[s].courseid=e,e+=1):Z[s].courseid=D[n].courseid)}D=t}function Tr(t){Bt=!1,ht=!1,document.getElementById("chk-move-map-and-controls").checked=!1,Y={x:null,y:null},I.deleteAllControls();const e=new xl(t,Fn,Be);D=e.courses,D.length>0&&(I=e.newcontrols,te=e.mapping,te.length>0?document.getElementById("chk-enrich-course-names").classList.remove("d-none"):document.getElementById("chk-enrich-course-names").classList.add("d-none"),Bt=e.georeferenced,Xn("Course details",tr()),bs(),Vt(),Ss()),S()}function Cr(t){Hs(t.target.result,!0),document.getElementById("rg2-load-map-file").classList.add("is-valid"),de=!0,j=ke(),Ss(),S(),document.getElementById("btn-add-map").removeAttribute("disabled")}function kr(t){const e=new Cl(t,vs);M=e.results,M.length>0&&(Z=e.resultCourses,Xn("Result details",lr()),Vt())}function Dr(t){let e=new FileReader;e.onerror=function(){b("Course file error","The selected course file could not be read.")},e.onload=function(s){Tr(s)},e.readAsText(t.target.files[0])}function Lr(t){const e=new FileReader;try{e.readAsText(t.target.files[0])}catch{b("File read error","Failed to open selected world file.");return}e.onerror=function(){b("World file error","The selected world file could not be read.")},e.onload=function(s){const i=s.target.result.split(/[\r\n]+/g);Be=new fe({A:i[0],B:i[2],C:i[4],D:i[1],E:i[3],F:i[5]});const l=ys.getDefaultValue();document.getElementById("rg2-georef-type").value=l,$n(l)}}function wr(t){const e=new FileReader;e.onload=function(n){Cr(n)};const s=t.target.files[0].name.substr(-3,3).toUpperCase();s==="JPG"||s==="GIF"?(Tt=t.target.files[0],e.readAsDataURL(t.target.files[0])):b("File type error",t.target.files[0].name+" is not recognised. Only .jpg and .gif files are supported at present.")}function jn(){let t=new FileReader;t.onerror=function(){b("Results file error","The selected results file could not be read.")},t.onload=function(e){wl(e)},Oe=At.name.substr(-3,3).toUpperCase(),Oe==="XML"||Oe==="CSV"?(vs=Oe,t.readAsText(At,ls[$e])):b("File type error","Results file type is not recognised. Please select a valid file.")}function Br(){let t=[];for(let e=0;e<M.length;e+=1){const s=er(M[e].course);s!==h.DO_NOT_SAVE_COURSE&&(M[e].courseid=s,M[e].course=sr(s),M[e].variantid="",t.push(M[e]))}M=t}function Ar(){document.getElementById("btn-create-event").addEventListener("click",s=>{Al(s)}),document.getElementById("btn-update-event").addEventListener("click",s=>{_l()}),document.getElementById("btn-delete-route").addEventListener("click",s=>{Ml()}),document.getElementById("btn-delete-event").addEventListener("click",s=>{Rl()}),document.getElementById("btn-add-map").addEventListener("click",s=>{Bl()}),document.getElementById("btn-delete-unused-maps").addEventListener("click",s=>{Nl()}),document.getElementById("btn-draw-courses").addEventListener("click",s=>{Fr()}),document.getElementById("rg2-load-georef-file").addEventListener("input",s=>{Lr(s)}),document.getElementById("rg2-load-map-file").addEventListener("input",s=>{Yr(s.target.files[0]),wr(s)});const t=document.getElementById("rg2-load-results-file");t.addEventListener("click",s=>{de||(b("No map loaded","Please load a map file before adding results."),s.preventDefault())}),t.addEventListener("change",s=>{At=s.target.files[0],yr(),jn()}),document.getElementById("chk-move-map-and-controls").addEventListener("click",s=>{Hr(s.target.checked)}),document.getElementById("chk-no-results").addEventListener("click",s=>{Xr(s.target.checked)}),document.getElementById("chk-score-event").addEventListener("click",s=>{Vr(s.target.checked)}),document.getElementById("chk-enrich-course-names").addEventListener("click",s=>{$r(s.target.checked)}),document.getElementById("chk-sort-results").addEventListener("click",s=>{Ur(s.target.checked)});const e=document.getElementById("rg2-load-course-file");e.addEventListener("click",s=>{de||(b("No map loaded","Please load a map file before adding courses."),s.preventDefault())}),e.addEventListener("change",s=>{Dr(s)})}function Rr(){for(let t=0;t<D.length;t+=1)for(let e=0;e<D[t].codes.length;e+=1){const s=Yn(D[t].codes[e]);D[t].x[e]=s.x,D[t].y[e]=s.y}}function Mr(){const t=document.getElementById("rg2-new-course-name").value;t&&(re.name=t)}function ft(t){t?mt(t):(Wn(),document.getElementById("rg2-edit-event-name").value="",document.getElementById("rg2-edit-club-name").value="",Xt.setDate(""),document.getElementById("rg2-edit-event-level").value="",document.getElementById("rg2-edit-event-comments").value="",document.getElementById("rg2-edit-exclude").value=On,document.getElementById("rg2-route-selected").replaceChildren(),document.getElementById("chk-edit-read-only").checked=!1,document.getElementById("rg2-course-allocations").innerHTML="")}function Nr(t){t!==0&&$n(t)}function _r(){K.name=document.getElementById("rg2-map-name").value,rl("rg2-map-name",t=>/./.test(t))}function Pr(t,e){return t.courseid!==e.courseid?t.courseid-e.courseid:t.position!==""&&e.position!==""?t.position-e.position:t.position===""&&e.position!==""?1:t.position!==""&&e.position===""?-1:qs(t.time)&&qs(e.time)?t.name-e.name:t.time-e.time}function Fr(){de?(ze=!0,D.length=0,I.deleteAllControls(),re.name="Course",re.x=[],re.y=[],re.codes=[],re.courseid=0,document.getElementById("rg2-new-course-name").value,document.getElementById("rg2-draw-courses").classList.remove("d-none")):b("No map selected","Please load a map before drawing courses")}function Or(t){let e=0;for(let s=0;s<t.length;s+=1)t.charCodeAt(s)===65533&&(e+=1);return e}function $r(t){Ht=t,Vt()}function Hr(t){ht=t}function Xr(t){ct=!t,bs(),Vt()}function Vr(t){Qe=t}function Ur(t){Es=t}function zs(){const t=K.lon,e=K.lat;let s=[];[3,1,2,0].forEach(function(l){s.push([e[l],t[l]])});const i=gs.polygon(s,{color:"red"});i.addTo(et),document.getElementById("rg2-world-file-map-container").classList.remove("d-none"),et.invalidateSize(),et.fitBounds(i.getBounds())}function Gr(){return document.getElementById("rg2-event-name").value===""?"Event name is not valid.":xe===h.INVALID_MAP_ID?"No map selected.":document.getElementById("rg2-select-club-name").value===""?"Club name is not valid.":xs.getDate("yyyy-mm-dd")===void 0?"Date is not valid.":document.getElementById("rg2-select-event-level").value==="X"?"Event level is not valid.":Oe?D.length===0&&!ze?"No course information. Check your course XML file.":M.length===0&&ct?"No results information. Check your results file.":ut?"OK":"Controls have not been adjusted on the map.":"Event format is not valid."}function Yr(t){let e=new FileReader;e.onload=function(s){let n=new Image;n.src=s.target.result,n.onload=function(){const i=Math.round(t.size/1024/1024);if(i>h.FILE_SIZE_WARNING||n.height>h.PIXEL_SIZE_WARNING||n.width>h.PIXEL_SIZE_WARNING){let l="The uploaded map file is "+i+"MB ("+n.width;l+=" x "+n.height+"px). It is recommended that you use maps under "+h.FILE_SIZE_WARNING,l+="MB with a maximum dimension of "+h.PIXEL_SIZE_WARNING+"px. Please see the ",l+="<a href='https://github.com/Maprunner/rg2/wiki/Map-files'>RG2 wiki</a> for ",l+="guidance on how to create map files.",b("Oversized map upload",l)}}},e.readAsDataURL(t)}class Ks{constructor(e,s,n,i,l){this.resultid=e.resultid,this.rawid=this.resultid%h.GPS_RESULT_OFFSET,this.isScoreEvent=s,this.name=ae(e.name).trim(),this.initials=this.getInitials(this.name),this.starttime=e.starttime,this.time=e.time,(this.time==="00"||this.time==="0")&&(this.time=""),this.timeInSecs=e.secs,this.position=e.position,this.status=e.status,this.canDelete=!1,this.showResult=!0,this.token=0,e.comments?this.comments=ae(e.comments):this.comments="",this.coursename=e.coursename,this.coursename===""&&(this.coursename=e.courseid.toString()),this.courseid=e.courseid,this.variant=e.variant,this.splits=this.adjustRawSplits(e.splits),this.isScoreEvent&&(this.scorex=i,this.scorey=l,this.scorecodes=n),this.trackColour=null,this.userColour=null,this.initialiseTrack(e)}addInterpolatedTimes(e,s,n){const i=this.xysecs[e],l=this.xysecs[s]-i,r=n[e],o=n[s]-r;for(let f=e;f<=s;f+=1)this.xysecs[f]=i+Math.round((n[f]-r)*l/o)}addTrack(e){this.trackx=e.x.split(",").map(function(n){return parseInt(n,10)}),this.tracky=e.y.split(",").map(function(n){return parseInt(n,10)});for(let n=1;n<this.trackx.length;n+=1)this.trackx[n]=this.trackx[n-1]+this.trackx[n],this.tracky[n]=this.tracky[n-1]+this.tracky[n];let s;this.isGPSTrack?s=this.expandGPSTrack():this.splits.length===2?s=this.expandTrackWithNoSplits():s=this.expandNormalTrack(),s&&od(this.courseid)}adjustRawSplits(e){e.splice(0,0,0);for(let s=1;s<e.length;s+=1)e[s]<=0&&(e[s]=e[s-1]);return e[e.length-1]=Math.max(this.timeInSecs,e[e.length-2]),e}calculateTotalTrackLength(){let e=[];e[0]=0;let s=this.trackx[0],n=this.tracky[0];for(let i=1;i<this.trackx.length;i+=1)e[i]=e[i-1]+Math.round(J(this.trackx[i],this.tracky[i],s,n)),s=this.trackx[i],n=this.tracky[i];return e}calculateTrackTimes(e){let s=[];s[0]=0;let n=this.getNextValidControl(0),i=e.x[n],l=e.y[n],r=0,o=this.trackx[0],f=this.tracky[0],y=0,u=0,m=0;for(let v=1;v<this.trackx.length;v+=1)if(y=this.trackx[v],u=this.tracky[v],r+=J(y,u,o,f),s[v]=Math.round(r),o=y,f=u,i===y&&l===u){if(this.xysecs[v]=this.splits[n],this.addInterpolatedTimes(m,v,s),m=v,n=this.getNextValidControl(n),n===e.x.length){this.hasValidTrack=!0;break}i=e.x[n],l=e.y[n]}}drawScoreCourse(){if(this.displayScoreCourse&&this.scorex.length>1){const e=dt();a.globalAlpha=h.FULL_INTENSITY;let s=Ne(this.scorex[0],this.scorey[0],this.scorex[1],this.scorey[1]);z.drawStart(this.scorex[0],this.scorey[0],"",s,e),s=[];for(let i=0;i<this.scorex.length-1;i+=1)s[i]=Ne(this.scorex[i],this.scorey[i],this.scorex[i+1],this.scorey[i+1]);const n={from:0,to:this.scorex.length};za({x:this.scorex,y:this.scorey},s,this.courseid,e,n);for(let i=1;i<this.scorex.length-1;i+=1)z.drawSingleControl(this.scorex[i],this.scorey[i],i,Math.PI*.25,e);z.drawFinish(this.scorex[this.scorex.length-1],this.scorey[this.scorey.length-1],"",e)}}drawTrack(e){try{let s,n,i;if(this.displayTrack){this.isGPSTrack&&k.showGPSSpeed&&this.speedColour.length===0&&this.setSpeedColours();let l=0,r=this.xysecs.length;const o=this.splits[e.filterFrom],f=this.splits[e.filterTo];for(let y=0;y<this.xysecs.length;y+=1)if(this.xysecs[y]>=o){l=y;break}for(let y=this.xysecs.length-1;y>=0;y-=1)if(this.xysecs[y]<=f){r=y;break}a.lineWidth=k.routeWidth,a.strokeStyle=this.trackColour,a.globalAlpha=k.perCentRouteIntensity/100,a.fillStyle=this.trackColour,a.font="10pt Arial",a.textAlign="left",a.beginPath(),a.moveTo(this.trackx[l],this.tracky[l]),s=this.trackx[l],n=this.tracky[l],i=0;for(let y=l+1;y<=r;y+=1)a.lineTo(this.trackx[y],this.tracky[y]),this.trackx[y]===s&&this.tracky[y]===n?i+=1:i>0&&((!this.isGPSTrack||this.isGPSTrack&&k.showThreeSeconds)&&a.fillText("+"+3*i,s+5,n+5),i=0),s=this.trackx[y],n=this.tracky[y],this.isGPSTrack&&k.showGPSSpeed&&(a.strokeStyle=this.speedColour[y],a.stroke(),a.beginPath(),a.moveTo(s,n));a.stroke()}}catch{return}}expandGPSTrack(){for(let e=0;e<this.trackx.length;e+=1)this.xysecs[e]=3*e;return this.speedColour.length=0,this.hasValidTrack=!0,this.hasValidTrack}expandNormalTrack(){this.xysecs.length=0,this.xysecs[0]=0;let e={};return this.isScoreEvent?(e.x=this.scorex,e.y=this.scorey):e=me(this.courseid),this.calculateTrackTimes(e),this.isScoreEvent&&(this.hasValidTrack=!0),this.hasValidTrack}expandTrackWithNoSplits(){this.xysecs.length=0;const e=this.splits[1];let s=0;this.xysecs[0]=0;const n={};n.x=me(this.courseid).x,n.y=me(this.courseid).y;let i=1,l=n.x[i],r=n.y[i],o=n.x[n.x.length-1],f=n.y[n.y.length-1];this.trackx.push(o),this.tracky.push(f);let y=0;const u=this.calculateTotalTrackLength(),m=u[u.length-1];let v=0,B=0,O=!1;for(let N=1;N<this.trackx.length;N+=1)if(v=this.trackx[N],B=this.tracky[N],(v!==this.trackx[0]||B!==this.tracky[0])&&(O=!0),l===v&&r===B&&O){if(s=parseInt(u[N]/m*e,10),this.xysecs[N]=s,this.splits[i]=s,this.addInterpolatedTimes(y,N,u),y=N,i+=1,i===n.x.length){this.hasValidTrack=!0;break}l=n.x[i],r=n.y[i]}return this.hasValidTrack}getColour(e){let s="#";if(e===0)return"#0080ff";if(e<.5)s+="ff";else{const n=parseInt((1-e)*255*2,10);n<16&&(s+="0"),s+=n.toString(16)}if(e>=.5)s+="ff";else{const n=255-parseInt((.5-e)*255*2,10);n<16&&(s+="0"),s+=n.toString(16)}return s+="00",s}getInitials(e){if(e===null)return"??";e=e.replace(/GPS/g,"*");let s="",n=!0;for(let i=0;i<e.length;i+=1)n&&(s+=e.substr(i,1),n=!1),e.charAt(i)===" "&&(n=!0);return s}getNextValidControl(e){for(let s=e+1;s<this.splits.length;s+=1)if(this.splits[s]!==this.splits[s-1])return s;return this.splits.length}initialiseTrack(e){if(this.legpos=[],this.racepos=[],this.hasValidTrack=!1,this.displayTrack=!1,this.displayScoreCourse=!1,this.trackx=[],this.tracky=[],this.speedColour=[],this.xysecs=[],this.resultid>=h.GPS_RESULT_OFFSET){this.isGPSTrack=!0;const s=yo(this.rawid);this.time=s.time,this.splits=s.splits,this.time===h.TIME_NOT_FOUND&&(this.time=e.time)}else this.isGPSTrack=!1}mapSpeedColours(){const e=16.667/k.maxSpeed,s=16.667/k.minSpeed,n=3,i=this.speedColour.slice().sort(function(y,u){return y-u}),l=Gt();let r=0,o=0;l!==void 0?(r=n*e/l,o=n*s/l):(r=i[i.length-1],o=i[Math.floor(i.length/95)]);const f=r-o;for(let y=0;y<this.speedColour.length;y+=1){let u=Math.max(this.speedColour[y],o);u=Math.min(u,r),this.speedColour[y]=this.getColour((u-o)/f)}}setSpeedColours(){this.speedColour[0]=0;let e=0;for(let s=1;s<this.trackx.length;s+=1){const n=J(this.trackx[s],this.tracky[s],this.trackx[s-1],this.tracky[s-1]);this.speedColour[s]=(n+e)/2,e=n}this.mapSpeedColours()}setTrackDisplay(e){this.hasValidTrack&&(e?this.userColour!==null?this.trackColour=this.userColour:this.trackColour=Mn():this.trackColour=null,this.displayTrack=e)}}let d=[];function Wr(t,e){d.length=0;let s=[],n=[],i=[];if(e)for(let l=0;l<t.length;l+=1){let r=t[l].variant;s[r]===void 0&&(s[r]=t[l].scorecodes,n[r]=t[l].scorex,i[r]=t[l].scorey)}for(let l=0;l<t.length;l+=1)if(dd(t[l].courseid)){t[l].resultid>h.GPS_RESULT_OFFSET&&t[l].coursename===""&&(t[l].coursename=me(t[l].courseid).name);let r;if(e){let o=t[l].variant;r=new Ks(t[l],e,s[o],n[o],i[o])}else r=new Ks(t[l],e);d.push(r)}ko(),Co(),wo(),vo(),Io(e)}function jr(t){for(let e=0;e<t.length;e+=1){let s=t[e].id,n=0;for(;n<d.length;){if(s===d[n].resultid){d[n].addTrack(t[e]);break}n+=1}}}function Zs(t){for(let e=0;e<d.length;e+=1)if(d[e].courseid===t&&!Pi(e))return!1;return!0}function Js(){for(let t=0;t<d.length;t+=1)if(d[t].hasValidTrack&&!d[t].displayTrack)return!1;return!0}function qr(t){for(let e=0;e<d.length;e+=1)if(d[e].courseid===t&&d[e].hasValidTrack&&!d[e].displayTrack)return!1;return!0}function Qs(t){for(let e=0;e<d.length;e+=1)if(d[e].courseid===t&&d[e].hasValidTrack&&!Pi(e))return!1;return!0}function zr(t){for(let e=0;e<d.length;e+=1)if(d[e].courseid===t&&d[e].hasValidTrack&&d[e].displayTrack)return!0;return!1}function Kr(t){const e=Ms();let s=0;for(let n=0;n<d.length;n+=1)d[n].courseid===t&&(d[n].resultid<h.GPS_RESULT_OFFSET||e.format===h.FORMAT_NO_RESULTS||e.format===h.FORMAT_SCORE_EVENT_NO_RESULTS)&&(s+=1);return s}function qn(t){let e=document.getElementById("rg2-select-name");if(e.innerHTML="",e.options.add(Ye(null,p("Select name",""))),t!==void 0){for(let s=0;s<d.length;s+=1)d[s].courseid===t&&d[s].resultid<h.GPS_RESULT_OFFSET&&e.options.add(Ye(d[s].resultid,d[s].time+" "+d[s].name));e.addEventListener("change",s=>{Ha(parseInt(s.target.value,10))}),e.removeAttribute("disabled")}}function Zr(){let t=eo();t=t.replace(/&amp;/g,"&");const e=document.getElementById("rg2-result-table");e.innerHTML=t,Lo(),Zn(),ua();const s=document.querySelectorAll(".resultrow");for(let n of s)n.addEventListener("dblclick",i=>{const l=parseInt(i.currentTarget.dataset.id,10);l&&hn(l)}),n.addEventListener("contextmenu",i=>{const l=parseInt(i.currentTarget.dataset.id,10);l&&hn(l)})}function Jr(){d.length=0}function Qr(t,e){d[t].displayScoreCourse=e}function en(){for(let t=0;t<d.length;t+=1){let e;d[t].isScoreEvent?e={from:0,to:d[t].scorex.length}:e=ld(d[t].courseid),d[t].drawTrack(e),d[t].drawScoreCourse()}}function eo(){let t=[],e=[];if(d.length===0)return`<p>${p("No results available")}</p>`;let s="",n=0,i=0;Eo();for(let l=0;l<d.length;l+=1){const r=d[l];if(!r.showResult)continue;r.courseid!==n&&(t.length>0&&(s+=tn(i,n)+"</table>",e.push(s)),i=0,t.push(co(r)),s=`<table class='resulttable' id='table-${r.courseid}'><thead><tr><th>#</th>`,s+=`<th>${p("Name")}</th><th>${p("Time")}</th>`,s+=`<th><i class='bi-pencil'></i></th><th><i class='bi-play-fill'></i></th></tr></thead><tbody class="table-group-divider">`,n=r.courseid),s+=`<tr class="resultrow" data-id="${r.rawid}"><td>${r.position}</td>`,r.comments!==""&&r.comments!==p("Type your comment")?(r.comments=r.comments.replace(/"/g,"&quot;"),s+=`<td title="${r.comments}"><u>${sn(r,l)}</u>`):s+=`<td>${sn(r,l)}`,r.canDelete&&(s+=` <i class='deleteroute bi-trash-fill' data-resultidx=${l}></i>`),s+=`</td><td>${r.time}</td>`;let o="",f="showreplay";r.hasValidTrack&&(i+=1,o=`<input class='showtrack' data-courseid='${n}' data-id='${r.resultid}' type=checkbox name=result></input>`,f+=" showtrackreplay"),s+=`<td>${o}</td>`,s+=`<td><input class="${f}" data-courseid=${n} data-id=${r.resultid} type=checkbox name=replay></input></td></tr>`}s+=`</tbody>${tn(i,n)}</table>`,e.push(s),s='<div class="accordion" id="results-accordion">';for(let l=0;l<e.length;l+=1)s+='<div class="accordion-item">',s+=`<h2 class="accordion-header d-flex" id="header-${l}">`,s+=`<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${l}" aria-expanded="true" aria-controls="collapse-${l}">`,s+=`${t[l].title}</button>${t[l].check}</h2>`,s+=`<div id="collapse-${l}" class="accordion-collapse collapse" aria-labelledby="header-${l}" data-bs-parent="#rg2-result-tab-body">`,s+=`<div class="accordion-body px-0">${e[l]}</div></div></div>`;return s+="</div>",s}function to(t){let e=Math.floor(t/86400)+" days ";return t=t-86400*Math.floor(t/86400),e+=Math.floor(t/3600)+" hours ",t=t-3600*Math.floor(t/3600),e+=Math.floor(t/60)+" minutes ",e+=t-60*Math.floor(t/60)+" seconds",e}function so(){let t=[],e=[],s=[],n=[];for(let i=0;i<d.length;i+=1){const l=d[i];if(l.resultid<h.GPS_RESULT_OFFSET){const r=l.courseid;t.indexOf(r)===-1&&(t.push(r),e[r]=[],s[r]=[],n[r]=[]);for(let o=0;o<l.scorecodes.length;o+=1)e[r].indexOf(l.scorecodes[o])===-1&&(e[r].push(l.scorecodes[o]),s[r].push(l.scorex[o]),n[r].push(l.scorey[o]))}}for(let i=0;i<t.length;i+=1){const l=t[i];hd(l,e[l],s[l],n[l])}}function no(t){let e=[];for(let s=0;s<d.length;s+=1)d[s].courseid===t&&d[s].resultid===d[s].rawid&&e.push(d[s]);return e}function io(t){let e=[];for(let s=0;s<d.length;s+=1)d[s].variant===t&&d[s].resultid===d[s].rawid&&e.push(d[s]);return e}function lo(t){let e=[];for(let s=0;s<d.length;s+=1)d[s].courseid===t&&e.push(d[s].resultid);return e}function ro(t){let e=[];for(let s=0;s<d.length;s+=1)d[s].courseid===t&&d[s].hasValidTrack&&e.push(d[s].resultid);return e}function tn(t,e){let s=`<tfoot class="table-group-divider"><tr class='allitemsrow'><td></td><td>${p("Routes")}</td><td></td>`;return t>0?(s+=`<td><input class='allcoursetracks' data-courseid=${e} type=checkbox name=track></input></td>`,s+=`<td><input class='allcoursetracksreplay' data-courseid=${e} type=checkbox name=replay></input></td>`):s+="<td></td><td></td>",s+=`</tr><tr class='allitemsrow'><td></td><td>${p("All")}</td><td></td><td></td>`,s+=`<td><input class='allcoursereplay' data-courseid=${e} type=checkbox name=replay></input></td></tr></tfoot>`,s}function oo(){let t=!1,e=["<table id='rg2-comments-table' class='table table-sm table-striped table-bordered'>",`<thead><tr><th>${p("Name")}</th><th>${p("Course")}</th>`,`<th>${p("Comments")}</th></tr></thead><tbody class="table-group-divider">`].join("");for(let s=0;s<d.length;s+=1)d[s].comments!==""&&(t=!0,e+=[`<tr><td>${d[s].name}</td><td>${d[s].coursename}</td>`,`<td>${d[s].comments}</td></tr>`].join(""));return t?e+="</tbody></table>":e="",e}function ao(t){for(let e=0;e<d.length;e+=1)if(d[e].resultid===t)return d[e].courseid}function co(t){let e=t.coursename;const s=me(t.courseid);s&&(e+=s.length===void 0?"":": "+s.length+" km");let n=`<div class="d-flex w-100"><div class="flex-grow-1 runners-table-course-header" data-runners="" data-courseid="${t.courseid}">${e}</div>`,i=`<div class="px-2"><input class='showcourse' data-courseid="${t.courseid}"`;return i+=` type=checkbox name ="course" title='Show course' ></input ></div >`,{title:n,check:i}}function uo(t){return{id:d[t].resultid,token:d[t].token}}function ho(){let t=[];for(let e=0;e<d.length;e+=1)if(d[e].displayTrack){let s={};s.trackColour=d[e].trackColour,s.course=sd(d[e].courseid),s.name=d[e].name,s.resultid=d[e].resultid,s.rawid=d[e].rawid,t.push(s)}return t}function zn(t){for(let e=0;e<d.length;e+=1)if(d[e].resultid===t)return d[e]}function Kn(t){for(let e=0;e<d.length;e+=1)if(d[e].resultid===t)return d[e]}function sn(t,e){let s;return t.rawid===t.resultid?s=t.name:s="<i>"+t.name+"</i>",t.isScoreEvent&&(s=`<input class='showscorecourse' data-courseid=${e} type=checkbox></input> ${s}`),`<div>${s}</div>`}function fo(t){let e=d.findIndex(s=>s.resultid===t);return e>-1?d[e].displayOrder:t}function go(){let t={results:0,drawnroutes:0,gpsroutes:0,secs:0};for(let e=0;e<d.length;e+=1){const s=d[e];s.resultid<h.GPS_RESULT_OFFSET&&(t.results+=1,s.time&&(t.secs+=s.splits[s.splits.length-1])),s.hasValidTrack&&(s.resultid<h.GPS_RESULT_OFFSET?t.drawnroutes+=1:t.gpsroutes+=1)}return t.totalroutes=t.drawnroutes+t.gpsroutes,t.results>0?t.percent=(100*t.totalroutes/t.results).toFixed(1):t.percent=0,t.time=to(t.secs),t}function mo(t,e){const s=go(),n=nd(),i=ke();let l="";if(e){const o=ki(),f=1e6;l=`. ${p("Map is georeferenced")}: ${parseInt(o.F*f)/f}`,l+=`, ${parseInt(o.C*f)/f}.`}return[`<tr><td>${p("Courses")}</td><td>${n.length}</td></tr>`,`<tr><td>${p("Controls")}</td><td>${t}</td></tr>`,`<tr><td>${p("Results")}</td><td>${s.results}</td></tr>`,`<tr><td>${p("Routes")}</td><td>${s.totalroutes} (${s.percent}%)</td></tr>`,`<tr><td>${p("Drawn routes")}</td><td>${s.drawnroutes}</td></tr>`,`<tr><td>${p("GPS routes")}</td><td>${s.gpsroutes}</td></tr>`,`<tr><td>${p("Total time")}</td><td>${s.time}</td></tr>`,`<tr><td>${p("Map")} ID ${xd()}</td><td>${i.width}  x ${i.height} pixels${l}</td></tr>`].join("")}function po(){let t=[];for(let e=0;e<d.length;e+=1)if(d[e].hasValidTrack){let s={};s.id=e,s.resultid=d[e].resultid,s.name=d[e].name,s.time=d[e].time,s.coursename=d[e].coursename,t.push(s)}return t}function yo(t){for(let e=0;e<d.length;e+=1)if(t===d[e].resultid)return{time:d[e].time,splits:d[e].splits};return{time:h.TIME_NOT_FOUND,splits:[]}}function Kt(){let t=[];for(let e=0;e<d.length;e+=1){const s=d[e];s.displayTrack&&t.push(s.resultid)}return t}function vo(){let t,e,s=[];for(let n=0;n<d.length;n+=1)if(d[n].courseid!==t&&(t=d[n].courseid,e=me(t)),e.excludeType===h.EXCLUDED_REAL_SPLITS){s.indexOf(t)===-1&&s.push(t);let i=0;for(let l=1;l<e.exclude.length;l+=1)e.exclude[l]&&(i=i+Math.min(d[n].splits[l]-d[n].splits[l-1],e.allowed[l]));d[n].timeInSecs=Math.max(d[n].splits[d[n].splits.length-1]-i,0),d[n].time=_(d[n].timeInSecs)}for(let n=0;n<s.length;n+=1){let i=d.filter(o=>o.courseid===s[n]);for(let o=0;o<i.length;o+=1)if(i[o].rawid!==i[o].resultid){let f=i.findIndex(y=>y.resultid===i[o].rawid);f>-1&&(i[o].status=i[f].status)}i.sort(function(o,f){return o.status!=="ok"||o.timeInSecs===0?f.status!=="ok"||f.timeInSecs===0?0:1:f.status!=="ok"||f.timeInSecs===0?-1:o.timeInSecs-f.timeInSecs});let l=0,r=0;for(let o=0;o<i.length;o+=1){if(i[o].status!=="ok"||i[o].timeInSecs===0){i[o].position="";continue}r!==i[o].timeInSecs?(l=l+1,r=i[o].timeInSecs):o>0&&i[o].rawid!==i[o-1].rawid&&(l=l+1),i[o].position=l}for(let o=0;o<i.length;o+=1){let f=d.findIndex(y=>y.resultid===i[o].resultid);f>-1&&(d[f].position=i[o].position,d[f].displayOrder=o)}}}function Eo(){d.sort(Ao);let t,e=!1;for(let s=0;s<d.length;s+=1)d[s].rawid===t?e&&d[s].hasValidTrack&&(d[s-1].showResult=!1,d[s].position=d[s-1].position,e=!1):(e=!d[s].hasValidTrack,t=d[s].rawid)}function xo(){for(let t=0;t<d.length;t+=1)d[t].speedColour.length=0}function bo(t){for(let e=0;e<d.length;e+=1)if(t===d[e].resultid)return!0;return!1}function Io(t){let e,s;for(let n=0;n<d.length;n+=1){d[n].courseid!==e&&(e=d[n].courseid,s=me(e)),d[n].legSplits=[],d[n].legSplits[0]=0;let i=0,l=!1;for(let r=1;r<d[n].splits.length;r+=1)d[n].splits[r]-i===0?s.exclude[r]?(d[n].legSplits[r]=d[n].splits[r]-i,i=d[n].splits[r]):(d[n].legSplits[r]=0,l=!0,d[n].lastValidSplit===void 0&&(d[n].lastValidSplit=r-1)):l?(d[n].legSplits[r]=0,i=d[n].splits[r],l=!1):(d[n].legSplits[r]=d[n].splits[r]-i,i=d[n].splits[r]);if(d[n].lastValidSplit===void 0&&(d[n].lastValidSplit=d[n].splits.length-1),!t){const r=rd(d[n].courseid)+2;for(;d[n].splits.length<r;)d[n].splits.push(d[n].splits[d[n].splits.length-1]),d[n].legSplits.push(0)}}}function So(t){document.getElementById("rg2-load-progress-label").textContent=p("Saving results",""),Ii()>0&&Wr(t,rt()),ud(),rt()&&(so(),z.generateControlList())}function To(t){if(document.getElementById("rg2-load-progress-label").textContent=p("Saving routes",""),Ii()>0&&jr(t),qa(),Zr(),h.managing())ql();else{if(document.getElementById(h.TAB_COURSES).removeAttribute("disabled"),document.getElementById(h.TAB_RESULTS).removeAttribute("disabled"),Ti()?document.getElementById(h.TAB_DRAW).setAttribute("disabled",""):document.getElementById(h.TAB_DRAW).removeAttribute("disabled"),Ke()!==h.TAB_DRAW){const i=yl();document.getElementById(i).click()}const s=pl();for(let i=0;i<s.length;i+=1){let l=new Event("click",{bubbles:!0});const r=document.querySelector(`.showtrack[data-id='${s[i]}']`);r&&(r.checked=!0,r.dispatchEvent(l))}const n=gl();for(let i=0;i<n.length;i+=1){let l=new Event("click",{bubbles:!0});const r=document.querySelector(`.showcourse[data-courseid='${n[i]}']`);r&&(r.checked=!0,r.dispatchEvent(l))}}document.getElementById("rg2-load-progress").classList.add("d-none"),S()}function Co(){const t=Pe();let e=[];const s=k.drawnRoutes;for(let n=0;n<s.length;n+=1)s[n].eventid===t&&e.push(s[n]);for(let n=0;n<e.length;n+=1)for(let i=0;i<d.length;i+=1)d[i].resultid===e[n].id&&(d[i].canDelete=!0,d[i].token=e[n].token)}function Zn(){document.getElementById("rg2-result-table").querySelectorAll("#results-accordion .accordion-item").forEach(s=>{const n=s.querySelectorAll(".resulttable tbody tr:not(.d-none)");s.querySelector(".runners-table-course-header").setAttribute("data-runners",n.length)})}function ko(){for(let t=0;t<d.length;t+=1)d[t].resultid<h.GPS_RESULT_OFFSET?d[t].displayOrder=t:d[t].displayOrder=fo(d[t].rawid)}function Do(t,e){for(let s=0;s<d.length;s+=1)d[s].rawid===t&&(d[s].userColour=e,d[s].trackColour=e)}function Lo(){let t=document.getElementById("rg2-result-search");if(d.length===0){t.classList.add("d-none");return}t.innerHTML=`<form class="d-flex pb-2" role="search">
  <input class="form-control mx-2" type="search" aria-label="${p("Search")}">
  <i class="bi-search mx-2"></i>
  </form>`;let e=document.getElementById("rg2-result-table");t.addEventListener("keyup",s=>{const n=s.target.value.toUpperCase(),i=e.querySelectorAll("tbody tr");for(let l=0;l<i.length;l+=1)i[l].innerText.toUpperCase().indexOf(n)>-1?i[l].classList.remove("d-none"):i[l].classList.add("d-none");Zn()})}function lt(t,e){for(let s=0;s<d.length;s+=1)d[s].resultid===t&&(d[s].displayScoreCourse=e)}function wo(){for(let t=0;t<d.length;t+=1)if(d[t].resultid>=h.GPS_RESULT_OFFSET){const e=Kn(d[t].rawid);e!==void 0&&e.scorex!==void 0&&(d[t].scorex=e.scorex,d[t].scorey=e.scorey,d[t].scorecodes=e.scorecodes)}}function nn(t,e){for(let s=0;s<d.length;s+=1)(d[s].courseid===t||h.DISPLAY_ALL_COURSES===t)&&d[s].setTrackDisplay(e);$s()}function Bo(t,e){for(let s=0;s<d.length;s+=1)d[s].resultid===parseInt(t,10)&&d[s].setTrackDisplay(e);$s()}function Ao(t,e){return t.courseid>e.courseid?1:e.courseid>t.courseid?-1:t.rawid===e.rawid?t.resultid-e.resultid:t.displayOrder-e.displayOrder}class Jn{constructor(e){const s=zn(e);this.name=s.name,this.initials=s.initials,this.resultid=e,this.rawid=s.rawid,this.starttime=s.starttime,this.splits=s.splits,this.trackColour=s.trackColour,this.userColour=s.userColour;let n;s.isScoreEvent?(n={},n.name=s.coursename,n.x=s.scorex,n.y=s.scorey,n.codes=s.scorecodes):n=me(s.courseid),this.coursename=n.name,this.nextStopTime=h.VERY_HIGH_TIME_IN_SECS,this.x=[],this.y=[],this.cumulativeDistance=[],this.cumulativeDistance[0]=0,this.legTrackDistance=[],this.legTrackDistance[0]=0,this.cumulativeTrackDistance=[],this.cumulativeTrackDistance[0]=0,s.hasValidTrack?this.expandTrack(s.trackx,s.tracky,s.xysecs):this.expandTrack(n.x,n.y,s.splits),this.addTrackDistances(n,s)}addTrackDistances(e,s){const n=this.cumulativeDistance.length-1;if(e.codes!==void 0)if(s.splits.length>1)for(let i=1;i<e.codes.length;i+=1){let l;s.splits[i]<=n?l=s.splits[i]:l=n,this.cumulativeTrackDistance[i]=this.cumulativeDistance[l],this.legTrackDistance[i]=this.cumulativeTrackDistance[i]-this.cumulativeTrackDistance[i-1]}else this.legTrackDistance[1]=this.cumulativeDistance[n],this.cumulativeTrackDistance[1]=this.cumulativeDistance[n]}expandTrack(e,s,n){let i=0,l=0,r=e[0],o=s[0],f=0,y=0;this.x[0]=e[0],this.y[0]=s[0];let u=Gt();u===void 0&&(u=1);for(let m=1;m<n.length;m+=1){let v=e[m],B=s[m],O=v-r,N=B-o;y=y+J(v,B,r,o)*u;let A=y-f;l=n[m],l===0&&(l=i+1);let ee=l-i;for(let be=i+1;be<l;be+=1)this.x[be]=Math.round(r+(be-i)*O/ee),this.y[be]=Math.round(o+(be-i)*N/ee),this.cumulativeDistance[be]=Math.round(f+(be-i)*A/ee);this.x[l]=v,this.y[l]=B,this.cumulativeDistance[l]=Math.round(y),r=v,o=B,f=y,i=l}}}zi.registerModules([Ki]);const kt=[{id:"rg2-stats-summary",title:"Summary",active:"true"},{id:"rg2-legs",title:"Leg times"},{id:"rg2-cumulative",title:"Cumulative times"},{id:"rg2-split-times",title:"Split times"},{id:"rg2-time-loss",title:"Time loss"}],Ro=['<div id="rg2-stats-summary" class="container"></div><div style="height: 400px;"><canvas id="rg2-splits-chart"></canvas></div>','<div id="rg2-leg-table" style="width: 950px; height: 100%" class="ag-theme-balham"></div>','<div id="rg2-race-table" style="width: 950px; height: 100%;" class="ag-theme-balham"></div>',`<div id="rg2-results-table" class="rg2-results-table-container">
     <div id="rg2-results-grid-wrapper">
       <div id="rg2-results-grid" style="height: 100%" class="ag-theme-balham"></div>
     </div>
   </div>`,`<div id="rg2-time-loss" class="container">
      <div class="rg2-control-slider-grid d-flex flex-column">
        <div class="d-flex">
          <div id="rg2-control-number"></div>
          <div id="rg2-control-slider"></div>
        </div>
        <div id="rg2-loss-details" class="d-flex justify-content-center"></div>
      </div>
      <canvas id="rg2-loss-chart"></canvas>
    </div>`];let P=null,tt=null,g=[],os=!1,w=null,G=0,ce=[],ue=[],C=null,Et,xt,U=1,Qn=9,X=2;function Mo(){if(w.excludeType===h.EXCLUDED_REAL_SPLITS)for(let t=0;t<g.length;t+=1){let e=0;for(let s=1;s<w.exclude.length;s+=1){if(w.exclude[s]){const n=Math.min(g[t].splits[s]-g[t].splits[s-1]-e,w.allowed[s]);e=e+n}g[t].splits[s]=g[t].splits[s]-e,g[t].legSplits[s]=g[t].splits[s]-g[t].splits[s-1]}}}function No(t){for(let e=0;e<g.length;e+=1){t===0&&(g[e].predictedSplits=[],g[e].loss=[],g[e].totalLoss=[]),g[e].predictedSplits[t]=[],g[e].predictedSplits[t][0]=0,g[e].loss[t]=[],g[e].loss[t][0]=0;let s=0;for(let n=0;n<G;n+=1)g[e].performanceIndex[t]>0?g[e].predictedSplits[t][n]=parseInt(w.refLegTime[t][n]/g[e].normalPerformanceIndex[t],10):g[e].predictedSplits[t][n]=g[e].legSplits[n],g[e].loss[t][n]=g[e].legSplits[n]-g[e].predictedSplits[t][n],g[e].loss[t][n]<0&&(g[e].loss[t][n]=0),s=s+g[e].loss[t][n];g[e].totalLoss[t]=s}}function _o(t){t===0&&(w.refLegTime=[],w.refTime=[]);let e=[],s=[];for(let n=0;n<G;n+=1){if(e.length=0,!w.exclude[n])for(let l=0;l<g.length;l+=1)g[l].iterSplits[t][n]!==0&&e.push(g[l].iterSplits[t][n]);const i=as(e,25);s.push(i.median)}w.refLegTime[t]=s.slice(0),w.refTime[t]=s.reduce((n,i)=>n+i);for(let n=0;n<g.length;n+=1){t===0&&(g[n].refRatio=[],g[n].performanceIndex=[],g[n].normalPerformanceIndex=[],g[n].totalSecs=[]),g[n].refRatio[t]=[];const i=[];for(let y=0;y<G;y+=1)g[n].iterSplits[t][y]===0?g[n].refRatio[t][y]=0:g[n].refRatio[t][y]=w.refLegTime[t][y]/g[n].iterSplits[t][y],i.push(g[n].refRatio[t][y]);const l=i.filter(y=>y>0),r=as(l,100);g[n].performanceIndex[t]=r.median,g[n].totalSecs[t]=g[n].iterSplits[t].reduce((y,u)=>y+u);let o=0,f=0;for(let y=0;y<G;y+=1)g[n].iterSplits[t][y]!==0&&(o=o+g[n].refRatio[t][y]*w.refLegTime[t][y],f=f+w.refLegTime[t][y]);o===0?g[n].normalPerformanceIndex[t]=0:g[n].normalPerformanceIndex[t]=o/f}}function Po(t){for(let e=0;e<g.length;e+=1){t===0&&(g[e].iterSplits=[]);let s=[];for(let n=0;n<G;n+=1)t===0?s.push(g[e].legSplits[n]):s.push(g[e].predictedSplits[t-1][n]);g[e].iterSplits[t]=s.slice(0)}}function Fo(){X=Math.max(X-1,0),di()}function Oo(t){let e="",s="";P.splits.length-1===U?e=p("Finish"):(e=p("Control"),s=": "+U);let n=`<div>${e}${s}</div>`;if(document.getElementById("rg2-control-number").innerHTML=n,n="",w.exclude[U])n=p("Control excluded","");else{const i=t.filter(r=>r.loss>0).map(r=>r.loss),l=as(i,100);n=`<div class="px-2 fw-bold">${p("Runners")}: ${l.count}</div >`,n+=`<div class="px-2 fw-bold">${p("Average")}: ${parseInt(l.mean,10)}s (${parseInt(l.mean*1e3/w.refLegTime[X][U],10)/10}%)</div>`,n+=`<div class="px-2 fw-bold">${p("Median")}: ${l.median}s (${parseInt(l.median*1e3/w.refLegTime[X][U],10)/10}%)</div>`}document.getElementById("rg2-loss-details").innerHTML=n}function $o(){document.getElementById("rg2-stats-panel-tab-headers").addEventListener("show.bs.tab",t=>{Yo(t)}),document.getElementById("rg2-stats-summary-tab-label").click()}function Ts(){xt!==void 0&&(xt.destroy(),xt=void 0);const t=document.getElementById("rg2-loss-chart"),e=m=>n.length===0?h.DARK_GREEN_30:n[m.dataIndex].activeRunner?h.DARK_GREEN:h.DARK_GREEN_30,s=m=>n.length===0?h.RED_30:n[m.dataIndex].activeRunner?h.RED:h.RED_30,n=[];w.exclude[U]||g.map(m=>{if(parseInt(m.legSplits[U],10)>0){let v={};v.loss=parseInt(m.loss[X][U],10),v.total=parseInt(m.legSplits[U],10),v.predicted=v.total-v.loss,v.pos=m.legpos[U],v.name=m.name,m.rawid===tt&&(v.activeRunner=!0),n.push(v)}}),n.sort((m,v)=>m.total-v.total);const i=n.map(m=>m.predicted),l=n.map(m=>m.loss),r=n.map(m=>m.pos),o=n.map(()=>w.refLegTime[X][U]),f=g.reduce((m,v)=>Math.max(m,v.legSplits[U]),0),y=parseInt((f+299)/300,10)*300;Oo(n),xt=new Dn(t,{data:{labels:r,datasets:[{label:"Predicted",type:"bar",data:i,backgroundColor:e},{label:"Loss",type:"bar",data:l,yAxisID:"yLoss",backgroundColor:s},{label:"Reference time",type:"line",data:o,borderColor:h.RED,backgroundColor:h.WHITE,borderDash:[5,5],yAxisID:"yLoss",pointStyle:"circle",pointRadius:0,pointHoverRadius:0}]},options:{scales:{x:{stacked:!0,title:{display:!0,text:"Position"}},yLoss:{stacked:!0,min:0,max:y,title:{display:!0,text:"Time (s)"}}},plugins:{tooltip:{callbacks:{label(m){let v=m.dataset.label+": ";return m.dataset.label==="Loss"?v+=_(n[m.dataIndex].loss):v+=_(n[m.dataIndex].predicted),v},title(m){return n[m[0].dataIndex].name+": "+_(n[m[0].dataIndex].total)}}}}}});const u=document.querySelector("#rg2-loss-chart");u.onwheel=m=>{m.preventDefault(),m.deltaY<0?U=U===P.splits.length-1?1:U+1:U=U>1?U-1:P.splits.length-1,Ts()}}function Ho(){U=1,Ts()}function Xo(){let t=[];for(let e=1;e<w.codes.length;e+=1){t.length=0;for(let i=0;i<g.length;i+=1)g[i].resultid===g[i].rawid&&(g[i].isScoreEvent?g[i].variant===w.courseid&&t.push({time:g[i].legSplits[e],id:i}):g[i].courseid===w.courseid&&t.push({time:g[i].legSplits[e],id:i}));t.sort(an);let s=0,n=0;for(let i=0;i<t.length;i+=1){if(w.exclude[e]){g[t[i].id].legpos[e]=0;continue}t[i].time!==n?t[i].time===0?(g[t[i].id].legpos[e]=0,n=0,s=0):(g[t[i].id].legpos[e]=i+1,n=t[i].time,s=i+1):g[t[i].id].legpos[e]=s}}t.length=0;for(let e=1;e<w.codes.length;e+=1){t.length=0;let s=0;for(let l=0;l<g.length;l+=1)g[l].resultid===g[l].rawid&&(g[l].isScoreEvent?g[l].variant===w.courseid&&(e>g[l].lastValidSplit?s=0:s=g[l].splits[e],t.push({time:s,id:l})):g[l].courseid===w.courseid&&(e>g[l].lastValidSplit?s=0:s=g[l].splits[e],t.push({time:s,id:l})));t.sort(an);let n=0,i=0;for(let l=0;l<t.length;l+=1)t[l].time!==i?t[l].time===0?(g[t[l].id].racepos[e]=0,n=0,i=0):(g[t[l].id].racepos[e]=l+1,i=t[l].time,n=l+1):g[t[l].id].racepos[e]=n}}function ei(){Et!==void 0&&(Et.destroy(),Et=void 0);const t=(u,m)=>u.p0.skip||u.p1.skip?m:void 0,e=document.getElementById("rg2-splits-chart"),s=g[C].legpos.map((u,m,v)=>m===v.length-1?"F":m),n=li(),i=g[C].legpos.map(u=>u===0?NaN:u),l=g[C].loss[X].map((u,m)=>g[C].legpos[m]===0?NaN:u),r=g[C].legpos.map(()=>n.average),o=g[C].loss[X].reduce((u,m)=>Math.max(u,m),0),f=parseInt((o+299)/300,10)*300;Et=new Dn(e,{data:{labels:s,datasets:[{label:"Leg position",type:"line",data:i,borderColor:h.RED,backgroundColor:h.RED_30,yAxisID:"yPosition",segment:{borderColor:u=>t(u,"rgb(0,0,0,0.2)"),borderDash:u=>t(u,[6,6])},spanGaps:!0},{label:"Average leg position",type:"line",data:r,borderColor:h.RED,backgroundColor:h.WHITE,borderDash:[5,5],yAxisID:"yPosition",pointStyle:"circle",pointRadius:0,pointHoverRadius:0},{label:"Time loss",type:"bar",data:l,borderColor:h.DARK_GREEN,backgroundColor:h.DARK_GREEN_30,yAxisID:"yLoss",segment:{borderColor:u=>t(u,"rgb(0,0,0,0.2)"),borderDash:u=>t(u,[6,6])},spanGaps:!0}]},options:{maintainAspectRatio:!1,responsive:!0,scales:{x:{min:1,title:{display:!0,text:p("Control","")}},yPosition:{type:"linear",display:!0,position:"left",min:0,max:parseInt((g.length+9)/10,10)*10,title:{display:!0,text:"Leg position"}},yLoss:{type:"linear",display:!0,position:"right",min:0,max:f,grid:{drawOnChartArea:!1},title:{display:!0,text:"Time loss"}}},plugins:{tooltip:{callbacks:{label:function(u){return u.dataset.label==="Time loss"?"Loss: "+_(l[u.dataIndex]):u.dataset.label==="Leg position"?"Position: "+i[u.dataIndex]:""},title:function(u){return u[0].label==="F"?p("Finish",""):p("Control","")+" "+u[0].label}}}}}});const y=document.querySelector("#rg2-splits-chart");y.onwheel=u=>{u.preventDefault(),u.deltaY<0?C=C===g.length-1?0:C+1:C=C>0?C-1:g.length-1,oi(g[C].rawid)}}function ti(){const t=[{headerName:p("Pos",""),field:"position",cellDataType:"text",width:60,pinned:"left",sortable:!0},{headerName:p("Name",""),field:"name",cellDataType:"text",headerClass:"align-left",cellClass:"align-left",width:150,pinned:"left"},{headerName:p("Time",""),field:"time",cellDataType:"text",width:85}];for(let r=1;r<G-1;r+=1)t.push({headerName:r+" ("+w.codes[r]+")",field:"C"+r,cellRenderer:on,width:110});t.push({headerName:p("F",""),field:"finish",cellRenderer:on,width:110}),t.push({headerName:p("Loss",""),field:"loss",cellDataType:"text",width:100}),t.push({headerName:p("Performance",""),field:"performance",cellDataType:"text",width:100}),t.push({headerName:p("Consistency",""),field:"consistency",cellDataType:"text",width:100});let e=[];g.sort(function(r,o){return r.racepos[r.splits.length-1]<=0?1:o.racepos[o.splits.length-1]<=0?-1:r.racepos[r.splits.length-1]-o.racepos[o.splits.length-1]}),C=ci(tt);for(let r=0;r<g.length;r+=1){let o={};const f=g[r];f.racepos[G-1]==0?o.position="":o.position=f.racepos[G-1],o.name=f.name,o.time=f.time;for(let u=1;u<G-1;u+=1)f.splits[u]===f.splits[u-1]?o["C"+u]={split:"0:00",pos:f.racepos[u],loss:!1}:o["C"+u]={split:_(f.splits[u]),pos:f.racepos[u],loss:!1};o.finish={split:_(f.splits[G-1]),pos:f.racepos[G-1]},o.loss=_(f.timeInSecs-f.totalLoss[X]),o.performance=(f.performanceIndex[0]*100).toFixed(1);const y=f.refRatio[0].filter(u=>u>0);o.consistency=(100*ri(y)).toFixed(1),e.push(o),o={};for(let u=1;u<G-1;u+=1)o["C"+u]={split:_(f.legSplits[u]),pos:f.legpos[u],loss:f.loss[X][u]>19};o.finish={split:_(f.legSplits[G-1]),pos:f.legpos[G-1],loss:f.loss[X][G-1]>19},o.loss=_(f.totalLoss[X]),e.push(o)}const s={columnDefs:t,rowData:e,defaultColDef:{headerClass:"align-center",cellClass:"align-center"}},n=document.getElementById("rg2-map-canvas").height*.98-120,i=document.getElementById("rg2-results-grid-wrapper");i.removeAttribute("style"),i.setAttribute("style","height: "+n+"px;");const l=document.getElementById("rg2-results-grid");l.innerHTML="",new ms(l,s)}function si(){const t=li(),e=l=>`${l}`;let s=e(`<div>${p("Name")}</div><div>${P.name}</div>`);s+=e(`<div>${p("Course")}</div><div>${P.coursename}</div>`),s+=e(`<div>${p("Time")}</div><div>${P.time}</div>`),s+=e(`<div>${p("Position")}</div><div>${g[C].racepos[G-1]} / ${g.length}</div>`),s+=e(`<div>${p("Average leg position")}</div><div>${t.average} (${p("Best","")}: ${t.best}, ${p("Worst")}: ${t.worst})</div >`);let n="";zo(P.timeInSecs)&&(n=` (${(100*g[C].totalLoss[X]/P.timeInSecs).toFixed(1)}%)`),s+=e(`<div>${p("Estimated loss")}</div><div>${_(g[C].totalLoss[X])}${n}</div>`),s+=e(`<div>${p("Performance")}</div><div>${(P.performanceIndex[0]*100).toFixed(1)}%</div>`);const i=g[C].refRatio[0].filter(l=>l>0);s+=e(`<div>${p("Consistency")}</div><div>${(100*ri(i)).toFixed(1)}%</div>`),document.getElementById("rg2-stats-summary").innerHTML=s}function ni(){const t=[];for(let n=0;n<g[C].splits.length;n+=1){let i={};if(n===0?i.control="S":n==g[C].splits.length-1?i.control="F":i.control=n+" ("+w.codes[n]+")",n===0?i.time="0:00":i.time=_(g[C].legSplits[n]),n===0||g[C].legpos[n]===0||w.exclude[n]?i.position="-":i.position=g[C].legpos[n],n===0||w.exclude[n]?i.performance="-":i.performance=(100*g[C].refRatio[0][n]).toFixed(1),w.exclude[n]?i.best="-":i.best=_(ce[n][0].t),n===0||w.exclude[n])i.who="-";else{let r=ce[n][0].name;for(let o=1;o<ce[n].length&&ce[n][0].t===ce[n][o].t;o+=1)r+=", "+ce[n][o].name;i.who=r}const l=g[C].legSplits[n]-ce[n][0].t;n===0||g[C].legSplits[n]===0?i.behind="-":i.behind=_(l),n===0?i.percent=0:g[C].legSplits[n]===0?i.percent="-":i.percent=parseInt(l*100/ce[n][0].t,10),w.exclude[n]?i.predicted="-":i.predicted=_(g[C].predictedSplits[X][n]),g[C].legSplits[n]===0?i.loss="-":i.loss=_(g[C].loss[X][n]),t.push(i)}const e={columnDefs:[{headerName:p("Control",""),field:"control",width:80},{headerName:p("Time",""),field:"time",width:80,comparator:bt.bind(this)},{headerName:p("Position",""),field:"position",width:75},{headerName:p("Performance",""),field:"performance",width:95,comparator:Jo.bind(this)},{headerName:p("Best",""),field:"best",width:80},{headerName:p("Who",""),field:"who",headerClass:"align-left",cellClass:"align-left",flex:1,tooltipField:"who"},{headerName:p("Behind",""),field:"behind",width:80,comparator:bt.bind(this)},{headerName:"%",field:"percent",width:60},{headerName:p("Predicted",""),field:"predicted",width:100,comparator:bt.bind(this)},{headerName:p("Loss",""),field:"loss",width:75,comparator:bt.bind(this)}],rowData:t,domLayout:"autoHeight",defaultColDef:{headerClass:"align-center",cellClass:"align-center",sortable:!0}},s=document.getElementById("rg2-leg-table");s.innerHTML="",new ms(s,e)}function ii(){const t=[];let e=0;for(let i=0;i<g[C].splits.length;i+=1){let l={};if(i==0?l.control="S":i==g[C].splits.length-1?l.control="F":l.control=i+" ("+w.codes[i]+")",i==0?l.time="0:00":g[C].splits[i]===g[C].splits[i-1]?l.time="":l.time=_(g[C].splits[i]),i===0||g[C].racepos[i]===0?l.position="-":l.position=g[C].racepos[i],l.best=_(ue[i][0].t),i===0)l.who="-";else{let o=ue[i][0].name;for(let f=1;f<ue[i].length&&ue[i][0].t===ue[i][f].t;f+=1)o+=", "+ue[i][f].name;l.who=o}const r=g[C].splits[i]-ue[i][0].t;i===0||g[C].racepos[i]===0?l.behind="-":l.behind=_(r),i===0||g[C].racepos[i]===0?l.percent="-":l.percent=parseInt(r*100/ue[i][0].t,10),e=e+g[C].loss[X][i],l.loss=_(e),t.push(l)}const s={columnDefs:[{headerName:p("Control",""),field:"control",width:88},{headerName:p("Time",""),field:"time",width:85},{headerName:p("Position",""),field:"position",width:100},{headerName:p("Best",""),field:"best",width:85},{headerName:p("Who",""),field:"who",headerClass:"align-left",cellClass:"align-left",flex:1,tooltipField:"who"},{headerName:p("Behind",""),field:"behind",width:85},{headerName:"%",field:"percent",width:85},{headerName:"Loss",field:"loss",width:100}],rowData:t,domLayout:"autoHeight",defaultColDef:{headerClass:"align-center",cellClass:"align-center"}},n=document.getElementById("rg2-race-table");n.innerHTML="",new ms(n,s)}function as(t,e){let s=t.slice();if(s.length===0)return{mean:0,median:0,count:0};s.sort(function(o,f){return o-f});let n=0,i=s.length;if(e<100){const r=Math.max(parseInt(i*e/100,10),3);s.splice(r),i=s.length}for(let r=0;r<i;r+=1)n=n+s[r];let l;return i===1?l=s[0]:i%2===0?l=(s[i/2-1]+s[i/2])/2:l=s[Math.floor(i/2)],{mean:n/i,median:l,count:i}}function li(){let t=0,e=0,s=0,n=9999;for(let l=1;l<P.legpos.length;l+=1)P.legpos[l]!==0&&(t+=P.legpos[l],e+=1,n>P.legpos[l]&&(n=P.legpos[l]),s<P.legpos[l]&&(s=P.legpos[l]));let i;return e>0?i=(t/e).toFixed(1):(i=0,n=0,s=0),{best:n,worst:s,average:i}}function Vo(t){return t.reduce((e,s)=>e+s,0)/t.length}function ln(t){return t==="-"?0:parseFloat(t)}function ri(t){if(t.length===0)return 0;const e=Vo(t);return Math.sqrt(t.reduce((s,n)=>s+Math.pow(n-e,2),0)/t.length)}function Uo(){let t='<ul class="nav nav-pills" id="rg2-stats-panel-tab-headers" role="tablist">';for(let e of kt){const s=p(e.title),n=e.active?" active":"",i=e.active?"":"tabindex='-1'";t+=`<li class="nav-item${n}" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#${e.id}-tab"
      type="button" role="tab" ${i}>
      <div id="${e.id}-tab-label">${s}</div>
    </button>
    </li>`}return t+="</ul>",t}function Go(){let t='<div id="rg2-stats-table"><div class="tab-content" id="rg2-stats-panel-tab-body">';for(let e=0;e<kt.length;e+=1){const s=kt[e].active?" active":"";t+=`<div class="tab-pane fade ${s} pt-2" id="${kt[e].id}-tab" role="tabpanel" tabindex="${e}">
      ${Ro[e]}</div>`}return t+="</div></div></div>",t}function rn(t){return t==="-"?0:parseFloat(t.replace(":","."))}function Yo(t){if(t.currentTarget)switch(t.currentTarget.id){case"rg2-iter-plus-text":Wo(),t.preventDefault();break;case"rg2-iter-minus-text":Fo(),t.preventDefault();break;case"rg2-iter-text":t.preventDefault();break}}function Wo(){X=Math.min(X+1,Qn),di()}function jo(t){tt=t,os=rt(),P=Kn(tt),os?g=io(P.variant):g=no(P.courseid),qo(P.courseid),Mo(),Xo(),C=ci(tt)}function qo(t){if(os?w={courseid:P.variant,codes:P.scorecodes,exclude:!1}:w=me(t),G=w.codes.length,G<=2)throw new ai(p("No splits available."));ce.length=0,ue.length=0;let e=[],s=[];for(let n=0;n<G;n+=1){e.length=0,s.length=0;for(let i=0;i<g.length;i+=1)n===0?(e.push({t:0,name:"",pos:0}),s.push({t:0,name:"",pos:0})):(e.push({t:g[i].legSplits[n],name:g[i].name,pos:g[i].legpos[n]}),n<=g[i].lastValidSplit&&s.push({t:g[i].splits[n],name:g[i].name,pos:g[i].racepos[n]}));e.sort(function(i,l){return i.t===0?1:l.t===0?-1:i.t-l.t}),s.sort(function(i,l){return i.t-l.t}),ce.push(e.slice()),ue.push(s.slice())}}function zo(t){return!isNaN(parseFloat(t))&&isFinite(t)?t>0:!1}function Ko(){for(let t=0;t<=Qn;t+=1)Po(t),_o(t),No(t)}function Zo(t){return Rs()?(oi(t),!0):(b(p("Statistics",""),p("No statistics available for this event format.","")),!1)}function Jo(t,e){return ln(t)-ln(e)}function oi(t){try{jo(t),Ko(),si(),ei(),Ho(),ni(),ii(),ti(),$o()}catch(e){e instanceof ai?b(p("Statistics"),e.message):b(p("Statistics",""),p("Data inconsistency.",""));return}}function on(t){if(t.value.split==="0:00")return"";let e=t.value.split,s="";return t.value.pos!==0&&(e+=" ("+t.value.pos+")",t.value.pos===1&&(s="rg2-first"),t.value.pos===2&&(s="rg2-second"),t.value.pos===3&&(s="rg2-third")),t.value.loss&&(s+=" rg2-lost-time"),'<span class="'+s+'">'+e+"</span>"}function ai(t){this.message=t}function di(){document.getElementById("rg2-iter-count-tab-label").innerText=X+1,Ts(),si(),ei(),ni(),ii(),ti()}function ci(t){for(let e=0;e<g.length;e+=1)if(g[e].rawid===t)return P=g[e],e;return null}function an(t,e){return t.time===0?1:e.time===0?-1:t.time-e.time}function bt(t,e){return rn(t)-rn(e)}const ds=document.getElementById("rg2-show-info-panel-control"),Ae=document.getElementById("rg2-right-info-panel"),Cs=document.getElementById("rg2-right-info-panel-title"),ks=new Ln(Ae,{backdrop:!1}),He=document.getElementById("rg2-left-info-panel"),dn=document.getElementById("rg2-left-info-panel-title");let cn=document.getElementById("rg2-left-info-panel-body");const ui=new Ln(He,{backdrop:!1});He.style.width="420px";He.addEventListener("hidden.bs.offcanvas",()=>{ds.classList.remove("d-none")});Ds();const Zt=10,Jt=-10;function Qo(){return!document.getElementById("rg2-animation-controls").classList.contains("d-none")}function ea(){document.querySelector("label[for=rg2-select-course]").innerHTML=`${p("Select course")}`,document.querySelector("label[for=rg2-select-name]").innerHTML=`${p("Select name")}`,document.querySelector("label[for=rg2-name-entry]").innerHTML=p("Name"),document.querySelector("#rg2-name-entry").addEventListener("input",()=>{pn()}),document.querySelector("label[for=rg2-time-entry]").innerHTML=p("Time"),document.querySelector("#rg2-time-entry").addEventListener("input",()=>{pn()});const t=document.getElementById("rg2-new-comments");t.setAttribute("placeholder",p(h.DEFAULT_NEW_COMMENT,"")),t.addEventListener("focus",()=>{document.getElementById("rg2-new-comments").setAttribute("placeholder","")});const e=document.getElementById("btn-three-seconds");e.innerHTML=p("+3 secs"),e.addEventListener("click",u=>{u.preventDefault(),Ga()});const s=document.getElementById("btn-undo");s.innerHTML=p("Undo"),s.addEventListener("click",u=>{u.preventDefault(),Ua()});const n=document.getElementById("btn-save-route");n.innerHTML=p("Save"),n.addEventListener("click",u=>{u.preventDefault(),Fa()});const i=document.getElementById("btn-reset-drawing");i.innerHTML=p("Reset"),i.addEventListener("click",u=>{u.preventDefault(),Ma()}),document.getElementById("rg2-load-gps-title").innerHTML=p("Load GPS file (GPX or TCX)"),document.getElementById("btn-offset-plus").addEventListener("click",()=>{const u=document.getElementById("rg2-offset-value");let m=parseInt(u.value,10);m<Zt&&(m=m+1,u.value=m,Qt(m))}),document.getElementById("btn-offset-minus").addEventListener("click",()=>{const u=document.getElementById("rg2-offset-value");let m=parseInt(u.value,10);m>Jt&&(m=m-1,u.value=m,Qt(m))}),document.getElementById("rg2-offset-value").addEventListener("input",()=>{const u=document.getElementById("rg2-offset-value");let m=parseInt(u.value,10);isNaN(m)&&(m=0),m<Jt&&(m=Jt),m>Zt&&(m=Zt),u.value=m,Qt(m)});const l=document.getElementById("btn-undo-gps-adjust");l.innerHTML=p("Undo"),l.addEventListener("click",u=>{u.preventDefault(),Va()});const r=document.getElementById("btn-autofit-gps");r.innerHTML=p("Autofit"),r.addEventListener("click",u=>{u.preventDefault(),ma()}),document.querySelector("label[for=chk-move-all]").innerHTML=p("Move track and map together (or right click-drag)");const o=document.getElementById("btn-save-gps-route");o.innerHTML=p("Save GPS route"),o.addEventListener("click",u=>{u.preventDefault(),Pa()}),["Left click to add/lock/unlock a handle","Green - draggable","Red - locked","Right click to delete a handle","Drag a handle to adjust track around locked point(s)"].forEach((u,m)=>{const v=document.getElementById(`draw-text-${m+1}`);v.innerHTML=`${p(u)}.`}),document.getElementById("rg2-load-gps-file").addEventListener("input",u=>{Ra(u)})}function ta(){document.querySelector("label[for=rg2-select-language]").innerHTML=`${p("Language")}`,Zi(h.languages),Dt("chk-show-GPS-speed","showGPSSpeed","Show GPS speed colours"),Dt("chk-snap-toggle","snap","Snap to control when drawing"),Dt("chk-show-three-seconds","showThreeSeconds","Show +3 time loss for GPS routes"),Fe("map-intensity","perCentMapIntensity","Map intensity","%"),Fe("route-intensity","perCentRouteIntensity","Route intensity","%"),Fe("control-circle","circleSize","Control circle size"),Fe("course-width","courseWidth","Course overprint width"),Fe("route-width","routeWidth","Route width"),Fe("name-font-size","replayFontSize","Replay label font size");const t=document.getElementById("rg2-gps-speed-slider");t.setAttribute("value1",k.maxSpeed),t.setAttribute("value2",k.minSpeed),t.addEventListener("change",oa),document.getElementById("rg2-min-gps-speed-label").innerHTML=fi(),document.getElementById("rg2-max-gps-speed-label").innerHTML=hi()}function Dt(t,e,s){document.querySelector(`label[for=${t}]`).innerHTML=`${p(s)}`;const n=document.getElementById(t);n.addEventListener("click",i=>{k[e]=i.target.checked,Ft(),S()}),n.checked=k[e]}function Fe(t,e,s,n=""){let i=document.querySelector(`label[for=spn-${t}]`);i.innerHTML=`${p(s)} ${k[e]}${n}`;let l=document.getElementById(`spn-${t}`);l.setAttribute("value",k[e]),l.addEventListener("change",r=>{cl(e,parseInt(r.target.value,10)),i=document.querySelector(`label[for=spn-${t}`),i.innerHTML=`${p(s)} ${k[e]}${n}`,S()})}function sa(t){return Zo(t)}function na(){document.body.addEventListener("contextmenu",n=>{n.preventDefault()}),window.addEventListener("resize",()=>{Ds(),Ui()}),document.getElementById("rg2-left-info-panel-body").addEventListener("scroll",n=>{document.getElementById("rg2-info-panel").setAttribute(gi(),n.target.scrollTop)}),da(),h.managing()||ea(),un(),document.getElementById("rg2-logo").addEventListener("click",()=>{ui.toggle()}),document.querySelector("#rg2-info-panel-tab-headers").querySelectorAll('button[data-bs-toggle="tab"]').forEach(n=>{n.addEventListener("shown.bs.tab",i=>{ha(i)})}),ds.addEventListener("click",()=>{un(),ds.classList.add("d-none")}),aa()}function ia(){if(h.managing())return;let t=document.getElementById("rg2-event-list");t.innerHTML=pd();let e=document.getElementById("rg2-event-table"),s=document.getElementById("rg2-event-search");s.innerHTML=`<form class="d-flex pb-2" role="search">
  <input class="form-control mr-2" type="search" aria-label="${p("Search")}">
  <i class="bi-search ms-2 mt-2"></i>
  </form>`,s.addEventListener("keyup",n=>{let i=n.target.value.toUpperCase(),l=e.getElementsByTagName("tr");for(let r=0;r<l.length;r+=1)l[r].innerText.toUpperCase().indexOf(i)>-1?l[r].classList.remove("d-none"):l[r].classList.add("d-none")}),e.addEventListener("click",n=>{const i=n.target.closest("tr"),l=parseInt(i.dataset.kartatid,10);isNaN(l)||mt(l)})}function la(){Ae.style.width="800px",Cs.innerHTML="RG2 Version "+h.RG2VERSION,document.getElementById("rg2-about-dialog").classList.remove("d-none"),document.getElementById("rg2-option-controls").classList.add("d-none"),document.getElementById("rg2-stats-dialog").classList.add("d-none");let t=document.getElementById("rg2-event-stats");t.innerHTML=Id(),document.getElementById("rg2-manager-link").innerHTML=`<a href="${rg2Config.api_url.replace("rg2api.php","?manage")}">Manager Login</a>`,ks.show()}function un(){ui.show()}function ra(){Ae.style.width="420px",Cs.innerHTML=p("Configuration options"),document.getElementById("rg2-about-dialog").classList.add("d-none"),document.getElementById("rg2-option-controls").classList.remove("d-none"),document.getElementById("rg2-stats-dialog").classList.add("d-none"),ta(),ks.show()}function hn(t){Ae.style.width="1000px",Cs.innerHTML=Uo(),document.getElementById("rg2-stats-dialog").innerHTML=Go(),document.getElementById("rg2-about-dialog").classList.add("d-none"),document.getElementById("rg2-option-controls").classList.add("d-none"),document.getElementById("rg2-stats-dialog").classList.remove("d-none"),sa(t)&&ks.show()}function Ke(){return document.querySelector("#rg2-info-panel-tab-headers button.active").id}function fn(t){let e='<div id="rg2-info-panel">';e+='<div class="tab-content" id="rg2-info-panel-tab-body">';for(let s=0;s<t.length;s=s+1){const n=document.getElementById(t[s].body),i=t[s].active?" active show":"";e+=`<div class="tab-pane fade ${i}" id="rg2-${t[s].name}-body" role="tabpanel" 
    aria-labelledby="${t[s].name}" tabindex="${s}">${n.innerHTML}</div>`,n.remove()}return e+="</div></div>",e}function gn(t){let e='<ul class="nav nav-pills" id="rg2-info-panel-tab-headers" role="tablist">';for(let s=0;s<t.length;s=s+1){const n=t[s].hidden?" d-none":"",i=t[s].active?" active":"",l=t[s].disabled?" disabled ":"";e+=`
    <li class="nav-item" role="presentation">
      <button class="nav-link${i}${n}"${l}id="${t[s].name}" data-bs-toggle="tab"
      data-bs-target="#rg2-${t[s].name}-body"
        type="button" role="tab"><div id="${t[s].name}-label">${p(t[s].title)}</div>
      </button>
    </li>`}return e+="</ul>",e}function hi(){return`<i class="bi-emoji-smile rg2-run-green"></i> ${k.maxSpeed.toFixed(1)} min/km`}function fi(){return`<i class="bi-emoji-smile rg2-run-red"></i> ${k.minSpeed.toFixed(1)} min/km`}function gi(){return`scroll-${Ke()}`}function oa(t){k.maxSpeed=t.detail.value1,k.minSpeed=t.detail.value2;const e=document.getElementById("rg2-min-gps-speed-label");e.innerHTML=fi();const s=document.getElementById("rg2-max-gps-speed-label");s.innerHTML=hi(),xo(),S()}function aa(){document.getElementById("btn-about").addEventListener("click",e=>{la()}),document.getElementById("btn-settings").addEventListener("click",e=>{ra()}),document.getElementById("btn-splitsbrowser").addEventListener("click",()=>{window.open(rg2Config.api_url+"?type=splitsbrowser&id="+Pe()+"&_="+Date.now())}),document.getElementById("btn-measure").setAttribute("disabled",""),document.getElementById("btn-runners").setAttribute("disabled","");const t=document.getElementById("btn-toggle-controls");t.setAttribute("disabled",""),t.addEventListener("click",()=>{z.toggleControlDisplay(),S()})}function da(){const t=[{name:h.TAB_EVENTS,title:"Events",body:"rg2-event-body",active:!0},{name:h.TAB_COURSES,title:"Courses",body:"rg2-course-body",disabled:!0},{name:h.TAB_RESULTS,title:"Results",body:"rg2-result-body",disabled:!0},{name:h.TAB_DRAW,title:"Draw",body:"rg2-draw-body",disabled:!0}],e=[{name:h.TAB_LOGIN,title:"Login",body:"rg2-login-body",active:!0},{name:h.TAB_CREATE,title:"Add event",body:"rg2-add-event-body",hidden:!0},{name:h.TAB_EDIT,title:"Edit event",body:"rg2-edit-event-body",hidden:!0},{name:h.TAB_MAP,title:"Add map",body:"rg2-add-map-body",hidden:!0},{name:h.TAB_DELETE_MAP,title:"Delete maps",body:"rg2-delete-maps-body",hidden:!0}];h.managing()?(dn.innerHTML=gn(e),cn.innerHTML=fn(e)):(dn.innerHTML=gn(t),cn.innerHTML=fn(t))}function ca(){ja(),qn(void 0),document.getElementById("rg2-select-name").setAttribute("disabled",""),Rs()?(document.getElementById("rg2-name-select").classList.remove("d-none"),document.getElementById("rg2-enter-name-and-time").classList.add("d-none")):(document.getElementById("rg2-name-select").classList.add("d-none"),document.getElementById("rg2-enter-name-and-time").classList.remove("d-none")),Dt("chk-align-map","alignMap","Align map to next control"),document.getElementById("btn-three-seconds").setAttribute("disabled",""),document.getElementById("btn-undo").setAttribute("disabled",""),document.getElementById("btn-save-route").setAttribute("disabled",""),document.getElementById("btn-reset-drawing").setAttribute("disabled",""),document.getElementById("rg2-load-gps-file").setAttribute("disabled",""),document.getElementById("btn-autofit-gps").setAttribute("disabled",""),document.getElementById("btn-undo-gps-adjust").setAttribute("disabled",""),document.getElementById("btn-save-gps-route").setAttribute("disabled",""),document.getElementById("chk-move-all").checked=!1}function Ds(){const t=document.getElementById("rg2-header-container").offsetHeight,e=Qo()?document.getElementById("rg2-animation-controls").offsetHeight:0;He.style.top=`${t}px`,Ae.style.top=`${t}px`,He.style.bottom=`${e}px`,Ae.style.bottom=`${e}px`,He.style.maxWidth=`${window.innerWidth}px`,Ae.style.maxWidth=`${window.innerWidth}px`,document.getElementById("rg2-track-names").style.maxHeight=`${window.innerHeight-t-10}px`}function ua(){document.querySelectorAll(".showcourse").forEach(u=>{u.addEventListener("click",m=>{const v=parseInt(m.target.dataset.courseid,10);gt(v,m.target.checked);const B=document.querySelectorAll(".showcourse");for(let N of B)parseInt(N.dataset.courseid,10)===v&&(N.checked=m.target.checked);const O=document.querySelector(".showallcourses");O.checked=Wa(),nt(v),Ws(vn()),S()})}),document.querySelector(".showallcourses").addEventListener("click",u=>{Si(u.target.checked);const m=document.querySelectorAll(".showcourse");for(let v of m)v.checked=u.target.checked;En(),Ws(vn()),S()}),document.querySelectorAll(".showscorecourse").forEach(u=>{u.addEventListener("click",m=>{Qr(parseInt(m.target.dataset.courseid,10),m.target.checked),S()})}),document.querySelectorAll(".showtrack").forEach(u=>{u.addEventListener("click",m=>{const v=parseInt(m.target.dataset.id,10);Bo(v,m.target.checked);const B=parseInt(m.target.dataset.courseid,10);document.querySelectorAll(".allcoursetracks").forEach(A=>{parseInt(A.dataset.courseid,10)===B&&(A.checked=qr(B))}),document.querySelectorAll(".alltracks").forEach(A=>{A.checked=Js()}),nt(B),zt(Kt()),S()})});const i=document.querySelectorAll(".deleteroute");for(let u of i)u.addEventListener("click",m=>{va(parseInt(m.target.dataset.resultidx,10))});const l=document.querySelectorAll(".allcoursetracks");for(let u of l)u.addEventListener("click",m=>{let v=parseInt(m.target.dataset.courseid,10);nn(v,m.target.checked);const B=document.querySelectorAll(".allcoursetracks");for(let A of B)parseInt(A.dataset.courseid,10)===v&&(A.checked=m.target.checked);const O=document.querySelectorAll(".showtrack");for(let A of O)parseInt(A.dataset.courseid,10)===v&&(A.checked=m.target.checked);const N=document.querySelectorAll(".alltracks");for(let A of N)A.checked=Js();nt(v),zt(Kt()),S()});const r=document.querySelectorAll(".alltracks");for(let u of r)u.addEventListener("click",m=>{nn(h.DISPLAY_ALL_COURSES,m.target.checked);const v=document.querySelectorAll(".allcoursetracks");for(let O of v)O.checked=m.target.checked;const B=document.querySelectorAll(".showtrack");for(let O of B)O.checked=m.target.checked;En(m.target.checked),zt(Kt()),S()});const o=document.querySelectorAll(".showreplay");for(let u of o)u.addEventListener("click",m=>{let v=parseInt(m.target.dataset.id,10);m.target.checked?Ai(new Jn(v)):_i(v);const B=ao(v),O=document.querySelectorAll(".allcoursetracksreplay");for(let A of O)parseInt(A.dataset.courseid,10)===B&&(A.checked=Qs(B));const N=document.querySelectorAll(".allcoursereplay");for(let A of N)A.checked=Zs(B);S()});const f=document.querySelectorAll(".allcoursetracksreplay");for(let u of f)u.addEventListener("click",m=>{let v=parseInt(m.target.dataset.courseid,10);const B=ro(v);bn(B,m.target.checked);const O=document.querySelectorAll(".showreplay.showtrackreplay");for(let ee of O)parseInt(ee.dataset.courseid,10)===v&&(ee.checked=m.target.checked);const N=document.querySelectorAll(".allcoursetracksreplay");for(let ee of N)parseInt(ee.dataset.courseid,10)===v&&(ee.checked=m.target.checked);let A=document.querySelectorAll(".allcoursereplay");for(let ee of A)parseInt(ee.dataset.courseid,10)===v&&(ee.checked=Zs(v));S()});const y=document.querySelectorAll(".allcoursereplay");for(let u of y)u.addEventListener("click",m=>{const v=parseInt(m.target.dataset.courseid,10),B=lo(v);bn(B,m.target.checked);const O=document.querySelectorAll(".showreplay");for(let A of O)parseInt(A.dataset.courseid,10)===v&&(A.checked=m.target.checked);const N=document.querySelectorAll(".allcoursetracksreplay");for(let A of N)parseInt(A.dataset.courseid,10)===v&&(A.checked=Qs(v));S()})}function ha(t){switch(t.target.id){case h.TAB_DRAW:Si(!1),Xa();break}const e=document.getElementById("rg2-info-panel").getAttribute(gi());document.getElementById("rg2-left-info-panel-body").scrollTop=e,S()}let mn="#ff0000",mi=null,c=new Nn;c.routeData=new Ot;let Ut=null,$=[],q=[],Ls=[],F=0,Se=0,We=!1;function fa(t,e){pa(t,e)?(cs($[F],q[F]),ws(F),Se=F,F=vi(F),F===$.length&&document.getElementById("btn-save-route").removeAttribute("disabled")):cs(Math.round(t),Math.round(e)),document.getElementById("btn-undo").removeAttribute("disabled"),S()}function cs(t,e){c.routeData.x.push(t),c.routeData.y.push(e)}function ga(t,e,s){const n=c.handles.getPreviousLockedHandle(s),i=c.handles.getNextLockedHandle(s);st(t,e,n,n.time,s.time),st(t,e,i,s.time,i.time)}function Qt(t){c.adjustOffset(t)}function pi(t,e,s=void 0){if(document.getElementById("chk-move-all").checked||s===h.RIGHT_CLICK)a.translate(e.x-t.x,e.y-t.y);else if(c.handles.handlesLocked()>0)if(c.handles.handlesLocked()===1)st(t,e,c.handles.getSingleLockedHandle(),c.handles.getStartHandle().time,c.handles.getFinishHandle().time);else{let l=c.handles.getHandleClicked(t);if(l===void 0||l.locked)return;const r=c.handles.getEarliestLockedHandle(),o=c.handles.getLatestLockedHandle();r.time>=l.time?st(t,e,r,c.handles.getStartHandle().time,r.time):o.time<l.time?st(t,e,o,o.time,c.handles.getFinishHandle().time):ga(t,e,l)}else Sa(e.x-t.x,e.y-t.y)}function ws(t){if(k.alignMap){let e;t<$.length-1&&(We?e=Ne($[t],q[t],$[t+1],q[t+1]):e=Ls[t],Sn(e+Math.PI/2,$[t],q[t]))}else Sn(0,$[t],q[t],!1)}function ma(){c.autofitTrack()}function pa(t,e){let s=k.snap?8:2;return Math.abs(t-$[F])<s&&Math.abs(e-q[F])<s}function ya(){let t={};t.body="The route you have started to draw will be discarded. Are you sure you want to change the course?",t.title="Confirm course change",t.doText="Change course",t.onDo=xa,t.onCancel=Ea,ye(t)}function va(t){mi=t;let e={};e.body="This route will be permanently deleted. Are you sure?",e.title="Confirm route delete",e.doText="Delete route",e.onDo=ba,ye(e)}function Ea(){document.getElementById("rg2-select-course").value=c.routeData.courseid,document.getElementById("rg2-select-name").value=c.routeData.resultid,Ut=null}function xa(){Bs(),us(Ut)}function ba(){const t=uo(mi),e={type:"deletemyroute",id:Pe(),routeid:t.id};pe(JSON.stringify({token:t.token}),e,wa,"Route save failed")}function Bs(){c.routeData.courseid!==null&&gt(c.routeData.courseid,!1),c.routeData.resultid!==null&&lt(c.routeData.resultid,!1),Ei()}function yi(){Oa();const t={type:"addroute",id:c.routeData.eventid};pe(JSON.stringify(c.routeData),t,Ba(c.routeData.name),"Route save failed"),Bs()}function Ia(){c.fileLoaded&&(c.savedBaseX=c.baseX.slice(0),c.savedBaseY=c.baseY.slice(0),c.baseX=c.routeData.x.slice(0),c.baseY=c.routeData.y.slice(0),c.handles.saveForUndo(),c.handles.rebaselineXY(),document.getElementById("btn-undo-gps-adjust").removeAttribute("disabled"))}function Sa(t,e){for(let s=0;s<c.baseX.length;s+=1)c.routeData.x[s]=c.baseX[s]+t,c.routeData.y[s]=c.baseY[s]+e;c.handles.dragHandles(t,e)}function es(t){a.arc($[F],q[F],t,0,2*Math.PI,!1),a.fill()}function Ta(){const t=dt();a.lineWidth=t.overprintWidth,a.strokeStyle=h.RED,a.fillStyle=h.RED_30,F>0&&!c.fileLoaded&&(a.beginPath(),F<$.length-1?es(t.controlRadius):(es(t.finishInnerRadius),a.stroke(),a.beginPath(),es(t.finishOuterRadius)),a.fillRect($[F]-1,q[F]-1,3,3),a.stroke()),a.strokeStyle=mn,a.fillStyle=mn,a.font="10pt Arial",a.textAlign="left",a.globalAlpha=.6,Ca(),c.handles.drawHandles()}function Ca(){if(c.routeData.x.length>1){a.beginPath(),a.moveTo(c.routeData.x[0],c.routeData.y[0]);for(let t=1;t<c.routeData.x.length;t+=1)a.lineTo(c.routeData.x[t],c.routeData.y[t]);a.stroke()}}function ka(){return{x:$,y:q}}function vi(t){const e=c.routeData.splits;if(e.length===2)return t+1;for(let s=t+1;s<e.length;s+=1)if(e[s]!==e[s-1])return s;return e.length}function Da(t){const e=c.routeData.splits;if(e.length===2)return t-1;for(let s=t-1;s>0;s-=1)if(e[s]!==e[s-1])return s;return 0}function La(){return c.fileLoaded}function wa(t){t.ok?(b(p("Route deleted"),p("Route has been deleted")),al({eventid:parseInt(t.eventid,10),id:parseInt(t.routeid,10)}),Ze()):b(p("Delete failed"),p("Delete failed"))}const Ba=t=>e=>{e.ok?_a(e,t):b(t,p("Your route was not saved. Please try again"))};function us(t){Ut=null,c.routeData=new Ot,c.routeData.eventid=Pe(),c.routeData.courseid=t;const e=me(t);We=e.isScoreCourse,We||(gt(t,!0),c.routeData.coursename=e.name,e.excludeType===h.EXCLUDED_ZERO_SPLITS?c.routeData.controlsToAdjust=e.exclude.indexOf(!0):c.routeData.controlsToAdjust=e.x.length-1,$=e.x.slice(),q=e.y.slice(),c.routeData.x.length=0,c.routeData.y.length=0,c.routeData.x[0]=$[0],c.routeData.y[0]=q[0],c.routeData.controlx=$.slice(),c.routeData.controly=q.slice(),Ls=e.angle.slice()),document.getElementById("rg2-select-course").value=c.routeData.courseid,qn(t),S()}function Ei(){c=new Nn,c.routeData=new Ot,$.length=0,q.length=0,Ls.length=0,F=0,Se=0,We=!1,c.initialiseGPS(),ca(),S()}function Aa(t,e,s){if(Ke()===h.TAB_DRAW)if(c.fileLoaded){const i=c.handles.getHandleClicked({x:t,y:e});if(i!==void 0)s===h.RIGHT_CLICK&&i.index!==0&&i.index!==c.handles.length?i.locked?c.handles.unlockHandle(i.index):c.handles.deleteHandle(i.index):i.locked?c.handles.unlockHandle(i.index):c.handles.lockHandle(i.index);else for(let l=0;l<c.baseX.length;l+=1)if(c.baseX[l]+3>=t&&c.baseX[l]-3<=t&&c.baseY[l]+3>=e&&c.baseY[l]-3<=e){c.handles.addHandle(t,e,l);break}}else c.routeData.resultid!==null&&c.routeData.courseid!==null?fa(t,e):b("No course/name","Please select course, name and time before you start drawing a route or upload a file.")}function Ra(t){c.readGPS(t)}function Ma(){let t={};t.body="All information you have entered will be removed. Are you sure you want to reset?",t.title="Confirm reset",t.doText="Reset",t.onDo=Bs,ye(t)}function Na(t,e,s){let n={};return n.x=Math.cos(s)*t-Math.sin(s)*e,n.y=Math.sin(s)*t+Math.cos(s)*e,n}function _a(t,e){b(e,p("Your route has been saved")),dl({eventid:parseInt(t.eventid,10),id:t.newid,token:t.token}),mt(Pe())}function Pa(){const t=c.routeData.time[c.routeData.time.length-1]-c.routeData.time[0];c.routeData.totaltime=_(t);const s=new Date().getTimezoneOffset()*60;c.routeData.startsecs=c.routeData.time[0]-s;for(let n=0;n<c.routeData.x.length;n+=1)c.routeData.x[n]=Math.round(c.routeData.x[n]),c.routeData.y[n]=Math.round(c.routeData.y[n]),c.routeData.time[n]-=c.routeData.startsecs;for(c.routeData.resultid+=h.GPS_RESULT_OFFSET;bo(c.routeData.resultid);)c.routeData.resultid+=h.GPS_RESULT_OFFSET,c.routeData.name+="*";c.routeData.comments=document.getElementById("rg2-new-comments").value,document.getElementById("btn-undo-gps-adjust").setAttribute("disabled",""),yi()}function Fa(){c.routeData.comments=document.getElementById("rg2-new-comments").value,c.routeData.controlx=$,c.routeData.controly=q,c.routeData.controlx.splice(0,1),c.routeData.controly.splice(0,1),yi()}function st(t,e,s,n,i){const l=J(e.x,e.y,s.x,s.y)/J(t.x,t.y,s.x,s.y),r=Ne(e.x,e.y,s.x,s.y)-Ne(t.x,t.y,s.x,s.y);for(let o=n;o<=i;o+=1){const f=Na(c.baseX[o]-s.x,c.baseY[o]-s.y,r);c.routeData.x[o]=f.x*l+s.x,c.routeData.y[o]=f.y*l+s.y}c.handles.alignHandles(c.routeData)}function Oa(){for(let t=c.routeData.x.length-1;t>0;t-=1)c.routeData.x[t]=c.routeData.x[t]-c.routeData.x[t-1],c.routeData.y[t]=c.routeData.y[t]-c.routeData.y[t-1];for(let t=c.routeData.time.length-1;t>0;t-=1)c.routeData.time[t]=c.routeData.time[t]-c.routeData.time[t-1]}function $a(t){isNaN(t)||(c.routeData.courseid!==null?c.routeData.x.length>1?(Ut=t,ya()):(c.routeData.resultid!==null&&lt(c.routeData.resultid,!1),gt(c.routeData.courseid,!1),us(t)):us(t))}function Ha(t){if(!isNaN(t)){const e=zn(t);if(e.hasValidTrack){const s=p("If you draw a new route it will overwrite the old route for this runner.")+" "+p("GPS routes are saved separately and will not be overwritten.");b(p("Route already drawn"),s)}c.routeData.resultid!==null&&lt(c.routeData.resultid,!1),c.routeData.resultid=e.resultid,c.routeData.name=e.name,c.routeData.splits=e.splits,We?(lt(e.resultid,!0),$=e.scorex,q=e.scorey,c.routeData.x.length=0,c.routeData.y.length=0,c.routeData.x[0]=$[0],c.routeData.y[0]=q[0],c.routeData.controlx=$,c.routeData.controly=q,F=1,S()):(F=vi(0),Se=0),ws(0),xi()}}function pn(){const t=document.getElementById("rg2-name-entry"),e=t.value.trim();e?t.classList.add("is-valid"):t.classList.remove("is-valid");const s=document.getElementById("rg2-time-entry");let n=s.value.trim();if(n.match(/\d+[:.][0-5]\d$/)?s.classList.add("is-valid"):(s.classList.remove("is-valid"),n=null),e&&n&&c.routeData.courseid!==null){n=n.replace(".",":"),c.routeData.name=e,c.routeData.resultid=0,c.routeData.totaltime=n,c.routeData.startsecs=0,c.routeData.time[0]=ve(n),c.routeData.totalsecs=ve(n),F=1;const i=td(c.routeData.courseid),l=i[i.length-1];let r=[];for(let o=0;o<i.length;o=o+1)r[o]=parseInt(i[o]/l*c.routeData.totalsecs,10);c.routeData.splits=r,Se=0,S(),xi()}}function Xa(){c.routeData.courseid!==null&&(We?lt(c.routeData.resultid,!0):gt(c.routeData.courseid,!0))}function xi(){document.getElementById("btn-three-seconds").removeAttribute("disabled"),document.getElementById("btn-reset-drawing").removeAttribute("disabled",""),document.getElementById("rg2-load-gps-file").removeAttribute("disabled"),S()}function Va(){c.baseX=c.savedBaseX.slice(0),c.baseY=c.savedBaseY.slice(0),c.routeData.x=c.savedBaseX.slice(0),c.routeData.y=c.savedBaseY.slice(0),c.handles.undo(),document.getElementById("btn-undo-gps-adjust").setAttribute("disabled",""),S()}function Ua(){const t=c.routeData.x.length;t>1&&($[Se]===c.routeData.x[t-1]&&q[Se]===c.routeData.y[t-1]&&(F===$.length&&document.getElementById("btn-save-route").setAttribute("disabled",""),F=Se,Se=Da(F),ws(F-1)),c.routeData.x.pop(),c.routeData.y.pop()),c.routeData.x.length>1?document.getElementById("btn-undo").removeAttribute("disabled"):document.getElementById("btn-undo").setAttribute("disabled",""),S()}function Ga(){cs(c.routeData.x[c.routeData.x.length-1],c.routeData.y[c.routeData.y.length-1]),S()}let E=[],z,Rt=0,As=0,hs=0;function Ya(t){E[t.courseid]=new ul(t,rt()),As+=1,E[t.courseid].codes!==void 0&&E[t.courseid].codes.length>hs&&(hs=E[t.courseid].codes.length-1)}function Wa(){for(let t=0;t<E.length;t+=1)if(E[t]!==void 0&&!E[t].display)return!1;return!0}function ja(){let t=document.getElementById("rg2-select-course");t.innerHTML="",t.options.add(Ye(null,p("Select course","")));for(let e=0;e<E.length;e=e+1)E[e]!==void 0&&t.options.add(Ye(e,ae(E[e].name)));t.addEventListener("change",e=>{$a(parseInt(e.target.value,10))})}function qa(){const t=document.getElementById("rg2-course-table");t.innerHTML=Qa();const e=document.getElementById("rg2-course-filter-table");e.innerHTML=Ja(),document.querySelectorAll("[data-course-filter]").forEach(n=>{n.addEventListener("change",Ka)})}function bi(){E.length=0,Rt=0,As=0,hs=0}function yn(t){for(let e=0;e<E.length;e+=1)E[e]!==void 0&&E[e].drawCourse(t)}function za(t,e,s,n,i){E[s].drawLinesBetweenControls(t,e,n,i)}function Ka(t){const e=parseInt(t.target.dataset.courseFilter,10);E[e].filterFrom=t.detail.value1,E[e].filterTo=t.detail.value2,S()}function Za(){let t={html:"",res:0,coursecount:0};for(let e=0;e<E.length;e+=1)E[e]!==void 0&&(t.coursecount=t.coursecount+1,t.html+=[`<tr><td>${E[e].name}</td >`,`<td><input class='showcourse' data-courseid=${e} type='checkbox' name='course'></input></td>`,`<td class='text-center'>${E[e].resultcount}</td><td class='text-center'>${E[e].trackcount}</td><td>`].join(""),t.res+=E[e].resultcount,E[e].trackcount>0?(t.html+=`<input data-courseid=${E[e].courseid} class='allcoursetracks' type=checkbox name=track></input></td>`,t.html+=`<td><input data-courseid=${E[e].courseid} class='allcoursetracksreplay' type=checkbox name=replay></input>`):t.html+="</td><td>",t.html+="</td></tr>");return t}function Ja(){let t="";for(let e=0;e<E.length;e+=1)E[e]!==void 0&&!E[e].isScoreCourse&&E[e].codes.length>2&&(t+=[`<div id='course-filter-${E[e].courseid}' data-display="false" data-course="${E[e].courseid}" class="row">`,`<div class="col-3">${E[e].name}</div>`,'<div class="col-9 pt-2">',`  <tc-range-slider step="1" min="0" max="${E[e].codes.length}" value1="0"`,`value2="${E[e].codes.length}" round="0" data-course-filter="${E[e].courseid}>"`,"</tc-range-slider></div></div>"].join(""));return t}function Qa(){let t=["<table class='table table-striped table-hover table-sm'><thead>",`<tr><th>${p("Course")}</th><th><i class='bi-eye-fill'></i></th><th>${p("Runners")}</th>`,`<th>${p("Routes")}</th><th><i class='bi-pencil'></i></th><th><i class='bi-play-fill'></i></th></tr>`,'</thead><tbody class="table-group-divider">'].join("");const e=Za();return t+=e.html+`</tbody><tfoot class="table-group-divider"><tr class='allitemsrow'><td>${p("All")}</td>
    <td><input class='showallcourses' data-id="all" type=checkbox name=course></input></td>
    <td class='text-center'>${e.res}</td><td class='text-center'>${Rt}</td><td>`,Rt>0&&(t+=`<input data-id="all" class='alltracks' type=checkbox name=track></input>`),t+="</td><td></td></tr></tfoot></table>",t}function ed(){return E}function me(t){return E[t]}function td(t){return E[t].getLegLengths()}function sd(t){return E[t].name}function nd(){let t=[];for(let e=0;e<E.length;e+=1)if(E[e]!==void 0){let s={};s.id=E[e].courseid,s.name=E[e].name,s.results=E[e].resultcount,t.push(s)}return t}function vn(){let t=[];for(let e=0;e<E.length;e+=1)E[e]!==void 0&&E[e].display&&t.push(e);return t}function id(){let t="";for(let e=0;e<E.length;e+=1)E[e]!==void 0&&E[e].excludeType!==h.EXCLUDED_NONE&&(t=t+E[e].courseid+"|"+E[e].excludeType,t=t+E[e].exclude.reduce((s,n,i)=>n?s+"|"+i+","+E[e].allowed[i]:s,""),t=t+`
`);return t}function ld(t){let e={};return e.filterFrom=E[t].filterFrom,e.filterTo=E[t].filterTo,e}function rd(t){return E[t].codes.length-2}function Ii(){return As}function od(t){E[t].incrementTracksCount(),Rt+=1}function ad(){z=new ps}function dd(t){return t in E}function cd(t){bi(),z.deleteAllControls(),document.getElementById("rg2-load-progress-label").innerHTML=p("Saving courses");for(const e of t)Ya(e);z.generateControlList()}function Si(t){for(let e=0;e<E.length;e+=1)E[e]!==void 0&&E[e].setDisplay(t)}function En(){for(let t=0;t<E.length;t+=1)E[t]!==void 0&&nt(t)}function gt(t,e){E[t]!==void 0&&(E[t].setDisplay(e),nt(t))}function nt(t){t=parseInt(t,10);const e=E[t].display||zr(t);document.querySelectorAll("[data-display]").forEach(s=>{parseInt(s.dataset.course,10)===t&&(s.dataset.display=e)})}function ud(){for(let t=0;t<E.length;t+=1)E[t]!==void 0&&(E[t].resultcount=Kr(t))}function hd(t,e,s,n){for(let i=0;i<E.length;i+=1)if(E[i]!==void 0&&E[i].courseid===t){E[i].codes=e,E[i].x=s,E[i].y=n,E[i].setAngles();break}}let fd=class{constructor(e){switch(this.kartatid=e.id,this.mapid=e.mapid,this.format=e.format,this.name=e.name,this.date=e.date,this.club=e.club,this.rawtype=e.type,e.type){case"I":this.type="International event";break;case"N":this.type="National event";break;case"R":this.type="Regional event";break;case"L":this.type="Local event";break;case"T":this.type="Training event";break;default:this.type="Unknown";break}this.comment=e.comment,this.locked=e.locked,this.courses=0,e.suffix===void 0?this.mapfilename=this.mapid+".jpg":this.mapfilename=this.mapid+"."+e.suffix,this.worldfile=new fe(e)}},L=[],R=null,fs=!1;function gd(t){const e=document.querySelectorAll("#rg2-event-table tr");for(let n of e)parseInt(n.dataset.kartatid,10)===t?n.classList.add("table-success"):n.classList.remove("table-success");const s=document.getElementById("btn-splitsbrowser");rg2Config.enable_splitsbrowser&&Rs()?s.classList.remove("d-none"):s.classList.add("d-none"),document.getElementById("btn-toggle-controls").removeAttribute("disabled"),document.getElementById("btn-runners").removeAttribute("disabled"),document.getElementById("btn-measure").removeAttribute("disabled")}function md(t){Wt(null),Pt({type:"event",id:t},Cd,"Event request failed")}function Ze(){Pt({type:"events"},kd,"Events request failed")}function Ti(){return R===null?!1:L[R].locked}function pd(){let t="<table class='table table-striped table-hover table-sm'><tbody id='rg2-event-table'>";for(let e=L.length-1;e>=0;e-=1){let s=p(L[e].type,"")+": "+L[e].date;L[e].comment!==""&&(s+=": "+L[e].comment);let n="";L[e].comment!==""&&(n=`<i class='bi-info-circle' id='info-${e}'></i>`);let i="";L[e].worldfile.valid&&(i=`<i class='bi-globe' id='info-${e}'></i>`);let l="";L[e].locked&&(l=`<i class='bi-lock-fill' id='info-${e}'></i>`),t+=`<tr data-kartatid="${L[e].kartatid}"><td class="event-date">${L[e].date}</td><td title='${s}'>`,t+=`${L[e].name} ${l} ${i} ${n}</td ></tr >`}return t+="</tbody></table>",t}function yd(){return R!==null?L[R].date:""}function Ci(){return R}function vd(){if(R!==null)return L[R].kartatid}function Ed(){return R!==null?L[R].name:"Routegadget 2"}function xd(){return R!==null?L[R].mapid:null}function bd(t){for(let e=0;e<L.length;e+=1)if(L[e].kartatid===t)return e}function Rs(){return R!==null?L[R].format===h.FORMAT_NORMAL||L[R].format===h.FORMAT_SCORE_EVENT:!0}function Ms(t){t=t||Pe();const e=bd(t);let s=L[e];return s.id=e,s.controls=z.getControlCount(),s.exclude=id(),s}function Id(){if(R===null)return"";const t=Pe(),e=Ms(parseInt(t,10));let s=`<div class='fs-4 fw-bolder pb-3'>${p("Event statistics")}</div>`;return s+="<table class='table table-sm table-striped-columns table-bordered'><tbody>",s+=`<tr><td>${p("Event")}</td><td>${e.name}:${e.date}</td></tr>`,e.comment&&(s+=`<tr><td>${p("Comments")}</td><td>${e.comment}</td></tr>`),s+=mo(e.controls,e.worldfile.valid),s+="</tbody></table>",s+='<hr class="border border-primary opacity-75" />',s+=oo(),s=s.replace(/&amp;/g,"&"),s}function Pe(){return R===null?null:L[R].kartatid}function Sd(){return R===null||!Yt()?"px":"m"}function Td(t){for(let e=0;e<L.length;e+=1)if(L[e].kartatid===t)return L[e].mapfilename;return""}function Gt(){if(R===null||!Yt())return;const t=ke(),e=J(0,0,t.width,t.height),s=L[R].worldfile,n=s.C,i=s.F,l=s.A*t.width+s.B*t.height+s.C,r=s.D*t.width+s.E*t.height+s.F;return is(i,n,r,l)/e}function ki(){return R===null?null:L[R].worldfile}function Cd(t,e){fs=!1,El(e),Wt(e),Ns(),cd(t.courses),So(t.results),To(t.routes),Ei(),gd(e)}function kd(t){L.length=0,R=null;for(const s of t.events)L.push(new fd(s));ia();const e=ml();e&&mt(e),h.managing()&&zl(L)}function rt(){return R!==null?L[R].format===h.FORMAT_SCORE_EVENT||L[R].format===h.FORMAT_SCORE_EVENT_NO_RESULTS:!1}function Di(t){for(let e=0;e<L.length;e+=1)if(L[e].kartatid===t)return!0;return!1}function mt(t){fs||!Di(t)||(fs=!0,Hd(),Jr(),bi(),Hs(rg2Config.maps_url+Td(t)),document.getElementById("rg2-load-progress-label").textContent=p("Loading event",""),document.getElementById("rg2-load-progress").classList.remove("d-none"),md(t),S())}function Dd(t){for(let e=0;e<L.length;e+=1)if(L[e].mapid===t)return!0;return!1}function Yt(){return R===null?!1:L[R].worldfile.valid}function Wt(t){R=null;for(let e=0;e<L.length;e+=1)if(L[e].kartatid===t){R=e;break}}function Ns(){let t="";t=yd()+" "+ae(Ed()),document.title=t,Yt()&&(t="<i class='bi-globe'>&nbsp;</i>"+t),Ti()&&(t="<i class='bi-lock-fill'>&nbsp;</i>"+t),document.getElementById("rg2-event-title").innerHTML=t}let T=[];const ts=[100,200,500,1e3,2e3,3e3,5e3,7500,1e4,15e3,2e4,5e4,1e5],Ld=100;let Li="px",ot=1e3,_e=null,H=0,we=0,Le=!1,Xe=0,Re=0,_s=0,Ve=0,Mt=!1,V=0,pt=!1,it=!0,Ue=!1,Ge=0,Me=0,Nt=null,Q;const Ps=`<i title=${p("Run","")} class="bi-play-circle-fill"></i>`,wi=`<i title=${p("Start","")} class="bi-triangle"></i>`,Bi=`<i title=${p("Pause","")} class="bi-pause-btn"></i>`,je=document.getElementById("rg2-track-names"),xn=document.querySelector("#rg2-track-names .card-body"),wd=document.getElementById("btn-runners"),qe=document.getElementById("btn-start-stop");document.querySelector("#rg2-track-names .card-title").innerHTML=p("Runners");document.getElementById("btn-close-track-names").addEventListener("click",()=>{je.classList.add("d-none")});wd.addEventListener("click",()=>{je.classList.toggle("d-none")});const Lt=document.getElementById("rg2-replay-by-control");Lt.classList.add("d-none");let It={x:0,y:0};wt(je).draggable({inertia:!0,listeners:{move(t){It.x+=t.dx,It.y+=t.dy,t.target.style.transform=`translate(${It.x}px, ${It.y}px)`}},modifiers:[wt.modifiers.restrictRect({restriction:"#rg2-container"})]});function Ai(t,e=!0){for(let s=0;s<T.length;s+=1)if(T[s].resultid===t.resultid)return;t.userColour!==null?t.trackColour=t.userColour:t.trackColour=Mn(),T.push(t),e&&jt()}function bn(t,e){for(let s=0;s<t.length;s+=1)e?Ai(new Jn(t[s]),!1):_i(t[s]);jt()}function Ri(){Xe=86400,Re=0,Me=0;for(let t=0;t<T.length;t+=1)T[t].starttime<Xe&&(Xe=T[t].starttime),T[t].starttime+T[t].x.length>Re&&(Re=T[t].starttime+T[t].x.length),T[t].x.length>Me&&(Me=T[t].x.length)}function Bd(t){if(T.length===0)return;let e=!0;for(let s=0;s<T.length;s+=1)if(T[s].splits[V+1]-T[s].splits[V]>t){e=!1;break}e&&(V+=1,Fs(V),Os())}function Ad(t){t!==H&&yt(t)}function Rd(){let t=document.getElementById("rg2-replay-speed-list"),e="";for(let s=0;s<ts.length;s=s+1)e+=`<li class="dropdown-item" data-speed="${ts[s]}">${"x"+ts[s]/100}</li>`;t.innerHTML=e,document.getElementById("rg2-replay-speed-select").addEventListener("hidden.bs.dropdown",s=>{s.clickEvent&&Fi(parseInt(s.clickEvent.target.dataset.speed,10))})}function Md(){let t=document.getElementById("rg2-replay-start-control-list"),e="";const n=T.reduce((i,l)=>Math.min(l.splits.length,i),9999);for(let i=0;i<n-1;i=i+1){const l=i===0?`<div>${wi}</div>`:i;e+=`<li class="dropdown-item" data-control="${i}">${l}</li>`}t.innerHTML=e,document.getElementById("rg2-replay-start-control-select").addEventListener("hidden.bs.dropdown",i=>{i.clickEvent&&(V=parseInt(i.clickEvent.target.dataset.control),isNaN(V)&&(V=0),Fs(V),Os())})}function Nd(){let t=document.getElementById("rg2-tails-length-list"),e="";const s=["0:00","0:30","1:00","1:30","2:00","3:00",p("Full tails","")],n=[0,30,60,90,120,180,"Full"];for(let i=0;i<s.length;i=i+1)e+=`<li class="dropdown-item" data-length="${n[i]}">${s[i]}</li>`;t.innerHTML=e,document.getElementById("rg2-tails-length-select").addEventListener("hidden.bs.dropdown",i=>{i.clickEvent&&Yd(i.clickEvent.target.dataset.length)})}function _d(){if(T.length===0)return;if(Q){Q.value!==H&&(Q.value=H);const e=document.getElementById("rg2-clock");e.innerText=sl(H)}let t=0;for(let e=0;e<T.length;e+=1){const s=T[e];let n=0;Le?n=s.starttime:V===0||s.splits.length<V?n=0:n=-1*s.splits[V],a.strokeStyle=s.trackColour,a.globalAlpha=k.perCentRouteIntensity/100,a.lineWidth=k.routeWidth,a.beginPath(),a.moveTo(s.x[Ve-n],s.y[Ve-n]);for(let i=Ve;i<H;i+=1)i>n&&i-n<s.nextStopTime&&a.lineTo(s.x[i-n],s.y[i-n]);a.stroke(),a.beginPath(),t=H,t-n<s.nextStopTime?t=t-n:t=s.nextStopTime,a.arc(s.x[t],s.y[t],h.RUNNER_DOT_RADIUS,0,2*Math.PI,!1),a.globalAlpha=h.FULL_INTENSITY,a.strokeStyle=h.BLACK,a.fillStyle=s.trackColour,a.fill(),a.lineWidth=h.RUNNER_DOT_RADIUS/4,a.stroke(),Pd(s,t)}Wd(t),pt&&Bd(H)}function Pd(t,e){let s="";(it||Ue)&&e<t.x.length&&e>=0&&(a.fillStyle="black",a.strokeStyle="white",a.font=k.replayFontSize+"pt Arial",a.globalAlpha=h.FULL_INTENSITY,a.textAlign="left",Ue?s=t.initials:s=t.name,a.save(),a.translate(t.x[e],t.y[e]),a.rotate(a.displayAngle),a.lineWidth=k.replayFontSize/8,a.strokeText(s,12,6),a.fillText(s,12,6),a.restore())}function In(t,e){const s=T[t].cumulativeDistance;let n=e>s.length-1?s[s.length-1]:s[e];return n===void 0&&(n=0),n}function Mi(t){let e=[];for(let n=0;n<T.length;n+=1){let i={};i.trackColour=T[n].trackColour,i.course=T[n].coursename,i.name=T[n].name,i.resultid=T[n].resultid,i.rawid=T[n].rawid,Le?i.distance=In(n,H-T[n].starttime):i.distance=In(n,t),i.distance+=Li,e.push(i)}let s=ho();for(let n=0;n<s.length;n+=1)if(e.findIndex(i=>i.resultid===s[n].resultid)===-1){let i={};i.trackColour=s[n].trackColour,i.course=s[n].course,i.name=s[n].name,i.resultid=s[n].resultid,i.rawid=s[n].rawid,i.distance="",e.push(i)}return e}function Fd(t){if(t.length===0)return"";let e="",s="";for(let n=0;n<t.length;n+=1)s!==t[n].course&&(e+=`<div></div><div><strong>${t[n].course}</strong></div><div></div>`,s=t[n].course),e+=`<input type="color" class="form-control form-control-color" data-rawid="${t[n].rawid}"`,e+=` value = "${t[n].trackColour}" ><div>${t[n].name}</div><div class="runner-distance text-end"`,e+=` data-resultid="${t[n].resultid}">${t[n].distance}</div>`;return e}function Od(){Le?H<Re&&(we=Math.min(we+ot,Re*1e3)):H<Me&&(we=Math.min(we+ot,Me*1e3)),H=parseInt(we/1e3,10),Mt?Ve=Ge+1:Ve=Math.max(H-_s,Ge+1),S()}function $d(){if(Nt)return;Nt=document.getElementById("rg2-animation-controls");const t=document.getElementById("rg2-clock");t.innerText="00:00:00",Ni(0,0,0),Rd(),Fi(ot),qe.addEventListener("click",()=>{qd()}),document.getElementById("btn-mass-start").addEventListener("click",()=>{Lt.classList.add("d-none"),Vd()});const s=document.getElementById("btn-real-time");s.setAttribute("title",p("Real time","")),s.addEventListener("click",()=>{Lt.classList.add("d-none"),Ud()}),document.getElementById("btn-by-control").addEventListener("click",()=>{Xd(),Md(),Lt.classList.remove("d-none")}),Nd();let i=document.querySelectorAll("[data-toggle-names]");for(let l of i)l.innerHTML=p(l.dataset.toggleNames),l.addEventListener("click",r=>{zd(r.currentTarget.dataset.toggleNames)});document.getElementById("rg2-toggle-names-value").setAttribute("title",p("Show names",""))}function Ni(t,e,s){if(Q&&Q.min===t&&Q.max===e&&Q.value===s)return;Q&&Q.remove();const n=document.getElementById("rg2-clock-slider-container"),i=document.createElement("tc-range-slider");i.setAttribute("id","rg2-clock-slider"),i.setAttribute("min",t),i.setAttribute("max",e),i.setAttribute("value",s),i.setAttribute("step",1),n.append(i),Q=document.getElementById("rg2-clock-slider"),Q.addEventListener("change",l=>{Ad(l.target.value)})}function _i(t){for(let e=0;e<T.length;e+=1)T[e].resultid===t&&T.splice(e,1);jt()}function Hd(){T.length=0,ot=1e3,H=0,we=0,Le=!1,Xe=0,Re=0,_s=0,Ve=0,Mt=!1,V=0,pt=!1,it=!0,Ue=!1,Ge=0,Me=0,clearInterval(_e),_e=null,jt(),qe.innerHTML=Ps,je.classList.add("d-none")}function Pi(t){return T.findIndex(e=>e.resultid===t)>-1}function yt(t){Li=Sd();let e=0;Le?(t>0?H=t:H=Xe,e=Re,Ge=Xe):(t>0?H=t:H=0,e=Me,Ge=0),we=H*1e3,t===0&&Ni(Ge,e,H),S()}function Fs(t){document.getElementById("rg2-replay-start-control").innerHTML=t===0?wi:t}function Os(){let t=9999;t=T.reduce((e,s)=>Math.min(s.splits.length,e),t),V>t&&(V=0);for(let e=0;e<T.length;e+=1)V+1<T[e].splits.length?T[e].nextStopTime=T[e].splits[V+1]:T[e].nextStopTime=h.VERY_HIGH_TIME_IN_SECS;yt(0),Oi(),S()}function Xd(){document.getElementById("rg2-clock-slider").setAttribute("disabled",""),Le=!1,V=0,pt=!0,Fs(V),Os()}function Vd(){Le=!1,pt=!1,V=0,yt(0),Q.removeAttribute("disabled")}function Ud(){Le=!0,pt=!1,V=0,yt(0),Q.removeAttribute("disabled")}function Fi(t){isNaN(t)&&(t=1e3),ot=t,document.getElementById("rg2-replay-speed").innerText="x"+t/100}function Gd(t,e){for(let s=0;s<T.length;s+=1)T[s].rawid===t&&(T[s].userColour=e,T[s].trackColour=e);Do(t,e)}function Yd(t){t==="Full"?Mt=!0:(_s=parseInt(t,10),Mt=!1),Ri(),S()}function Wd(t){const e=Mi(t);if(e.length===0)return;const s=document.querySelectorAll(".track-names .runner-distance");s&&s.forEach(n=>{const i=parseInt(n.dataset.resultid),l=e.findIndex(r=>r.resultid===i);l>-1&&(n.innerText=e[l].distance)})}function jd(){_e===null&&(_e=setInterval(()=>{Od()},Ld)),qe.innerHTML=Bi}function Oi(){clearInterval(_e),_e=null,qe.innerHTML=Ps}function qd(){_e===null?(jd(),qe.innerHTML=Bi):(Oi(),qe.innerHTML=Ps)}function zd(t){switch(document.getElementById("rg2-toggle-names-value").setAttribute("title",p(t,"")),t){case"Show names":it=!0,Ue=!1;break;case"Show initials":it=!1,Ue=!0;break;default:it=!1,Ue=!1;break}S()}function jt(){$d(),$s(),T.length>0?Nt.classList.remove("d-none"):Nt.classList.add("d-none"),Ds(),Ri(),yt(0)}function $s(){const t=Mi(H);return t.length>0?(xn.innerHTML=Fd(t),document.querySelectorAll(".track-names input").forEach(s=>{s.addEventListener("input",n=>{Gd(parseInt(n.target.dataset.rawid,10),n.target.value),S()})}),je.classList.remove("d-none")):(xn.innerHTML="",je.classList.add("d-none")),t.length}class Kd{constructor(e){this.ctx=e,this.measuring=!1,this.dragging=!1,this.colours=["#ff00ff","#0000ff","#00ff00","#ff0000","#00ffff"],this.colourIndex=0,this.overlays=[],this.currentOverlay=this.initialiseOverlay(),this.units="px",this.metresPerPixel=1,this.dotSize=5,this.lineWidth=3,this.measureDialog=document.getElementById("rg2-measure-dialog"),document.getElementById("btn-measure").addEventListener("click",()=>{Ci()!==null&&(document.getElementById("rg2-map-canvas").style.cursor="crosshair",this.measureDialog.classList.remove("d-none"),this.measuring=!0,this.createMeasureDialog(),S())}),document.getElementById("btn-close-measure-dialog").addEventListener("click",()=>{this.measuring=!1,this.measureDialog.classList.add("d-none"),document.getElementById("rg2-map-canvas").style.cursor="auto",S()}),document.getElementById("btn-measure").addEventListener("click",()=>{document.getElementById("rg2-map-canvas").style.cursor="crosshair",this.measureDialog.classList.remove("d-none"),this.measuring=!0,this.createMeasureDialog(),S()});let s={x:0,y:0};wt(this.measureDialog).draggable({inertia:!0,listeners:{move(n){s.x+=n.dx,s.y+=n.dy,n.target.style.transform=`translate(${s.x}px, ${s.y}px)`}},modifiers:[wt.modifiers.restrictRect({restriction:"#rg2-container"})]}),this.createMeasureDialog()}calculateLength(e,s){if(e.length<2)return 0;let n=0;for(let i=1;i<e.length;i+=1)n=n+J(e[i-1],s[i-1],e[i],s[i]);return n}closeEnough(e,s,n,i){return Math.abs(e-n)<10&&Math.abs(s-i)<10}createMeasureDialog(){this.metresPerPixel=Gt(),this.metresPerPixel===void 0?(this.metresPerPixel=1,this.units="px"):this.units="m";let e="";for(let l=0;l<this.overlays.length;l+=1)e=e+this.formatOverlay(this.overlays[l],!0);e=e+this.formatOverlay(this.currentOverlay,!1),this.overlays.length>1&&(e+=`<div>${p("All")}</div><div></div><div></div>`,e+="<div><i class='delete-all-overlays bi-trash'></i></div>"),document.querySelector(".rg2-overlay-table").innerHTML=e;let s=document.getElementsByClassName("delete-overlay");for(let l of s)l.addEventListener("click",r=>{this.deleteOverlay(parseInt(r.target.id,10))});let n=document.getElementsByClassName("delete-all-overlays");for(let l of n)l.addEventListener("click",r=>{this.deleteAllOverlays(parseInt(r.target.id,10))});let i=document.getElementsByClassName("end-overlay");for(let l of i)l.addEventListener("click",r=>{this.endOverlay(parseInt(r.target.id,10))})}deleteAllOverlays(){this.overlays.length=0,this.currentOverlay=this.initialiseOverlay(),this.updateOverlays(),this.createMeasureDialog(),S()}deleteOverlay(e){this.overlays.splice(e,1),this.updateOverlays(),this.createMeasureDialog(),S()}dragEnded(){this.dragging=!1}drawSingleOverlay(e,s){this.ctx.strokeStyle=e.colour,this.ctx.fillStyle=e.colour,this.ctx.beginPath(),this.ctx.moveTo(e.x[0],e.y[0]);for(let n=1;n<e.x.length;n+=1)this.ctx.lineTo(e.x[n],e.y[n]);this.ctx.stroke();for(let n=0;n<e.x.length;n+=1)this.ctx.beginPath(),this.ctx.arc(e.x[n],e.y[n],this.dotSize,0,2*Math.PI,!1),s?this.ctx.fill():this.ctx.stroke()}drawOverlays(){if(this.measuring){if(this.ctx.lineWidth=this.lineWidth,this.ctx.globalAlpha=.6,this.overlays.length>0)for(let e=0;e<this.overlays.length;e+=1)this.drawSingleOverlay(this.overlays[e],!0);this.currentOverlay.started&&(this.currentOverlay.x.length===1?(this.ctx.strokeStyle=this.currentOverlay.colour,this.ctx.fillStyle=this.currentOverlay.colour,this.ctx.beginPath(),this.ctx.arc(this.currentOverlay.x[0],this.currentOverlay.y[0],this.dotSize,0,2*Math.PI,!1),this.ctx.stroke()):this.drawSingleOverlay(this.currentOverlay,!1))}}endOverlay(){this.currentOverlay.idx=this.overlays.length,this.overlays.push(this.currentOverlay),this.currentOverlay=this.initialiseOverlay(),this.createMeasureDialog()}formatOverlay(e,s){let n="",i="",l="";return e.started?l=`<div>${parseInt(e.length,10)}${this.units}</div>`:l="<div></div>",s?i=`<div><i class='delete-overlay bi-trash' id="${e.idx}"></i></div>`:e.started?i=`<div><i class='end-overlay bi-save' id="${e.idx}"></i></div>`:i="<div></div>",n+=`<div>${e.id}</div><div class='overlay-bar' style='--overlay-colour:${e.colour};'></div>`,n+=`${l}${i}`,n}getNextColour(){return this.colourIndex=(this.colourIndex+1)%this.colours.length,this.colours[this.colourIndex]}initialiseOverlay(){const e={};return e.id=String.fromCharCode(this.overlays.length+65),e.colour=this.getNextColour(),e.x=[],e.y=[],e.length=0,e.started=!1,e.idx=void 0,e}mouseDrag(e,s){if(!this.measuring)return!1;if(!this.dragging)for(let n=0;n<this.overlays.length;n+=1)for(let i=0;i<this.overlays[n].x.length;i+=1)this.closeEnough(e.x,e.y,this.overlays[n].x[i],this.overlays[n].y[i])&&(this.dragging=!0,this.dragOverlay=n,this.dragPoint=i);return this.dragging?(this.overlays[this.dragOverlay].x[this.dragPoint]=parseInt(s.x,10),this.overlays[this.dragOverlay].y[this.dragPoint]=parseInt(s.y,10),this.overlays[this.dragOverlay].length=this.calculateLength(this.overlays[this.dragOverlay].x,this.overlays[this.dragOverlay].y)*this.metresPerPixel,this.createMeasureDialog(),!0):!1}mouseUp(e,s){this.measuring&&(this.dragging=!1,this.currentOverlay.started||this.startOverlay(),e===this.currentOverlay.x[this.currentOverlay.x.length-1]&&s===this.currentOverlay.y[this.currentOverlay.x.length-1]?this.endOverlay():(this.currentOverlay.x.push(e),this.currentOverlay.y.push(s),this.currentOverlay.length=this.calculateLength(this.currentOverlay.x,this.currentOverlay.y)*this.metresPerPixel,this.createMeasureDialog(),S()))}startOverlay(){this.currentOverlay.started=!0,this.createMeasureDialog()}updateOverlays(){this.colourIndex=0;for(let e=0;e<this.overlays.length;e+=1)this.overlays[e].id=String.fromCharCode(e+65),this.overlays[e].idx=e,this.overlays[e].colour=this.getNextColour();this.currentOverlay.id=String.fromCharCode(this.overlays.length+65),this.currentOverlay.idx=this.overlays.length,this.currentOverlay.colour=this.getNextColour()}}let W=document.getElementById("rg2-map-canvas"),a=W.getContext("2d");a.displayAngle=0;let oe=new Image,_t=new Kd(a),x={dragStart:null,dragged:!0,scaleFactor:1.1,pinched:!1},ss;document.getElementById("rg2-load-progress").classList.add("d-none");document.getElementById("rg2-map-load-progress").classList.add("d-none");function Zd(){W.addEventListener("touchstart",ic,!1),W.addEventListener("touchmove",nc,!1),W.addEventListener("touchend",sc,!1),W.addEventListener("DOMMouseScroll",Tn,!1),W.addEventListener("wheel",Tn,!1),W.addEventListener("mousedown",Qd,!1),W.addEventListener("mousemove",ec,!1),W.addEventListener("mouseup",tc,!1),oe.addEventListener("load",()=>rc());let t=document.getElementById("btn-zoom-in");t.addEventListener("click",()=>at(1)),t=document.getElementById("btn-zoom-out"),t.addEventListener("click",()=>at(-1)),t=document.getElementById("btn-rotate-left"),t.addEventListener("click",()=>Cn(-1)),t=document.getElementById("btn-rotate-right"),t.addEventListener("click",()=>Cn(1)),t=document.getElementById("btn-reset"),t.addEventListener("click",()=>Xs())}function Sn(t,e,s,n=!0){$i((a.displayAngle-t)%(Math.PI*2),e,s,n)}function $i(t,e,s,n){if(a.displayAngle=(a.displayAngle-t)%(Math.PI*2),a.translate(e,s),a.rotate(t),n){const i=a.transformedPoint(W.width/2,W.height*.9);a.translate(i.x-e,i.y-s)}else a.translate(-1*e,-1*s);a.save(),S()}function Jd(){!h.managing()&&window.innerWidth>=h.BIG_SCREEN_BREAK_POINT&&(a.font="30pt Arial",a.textAlign="left",a.fillStyle=h.BLACK,a.fillText(p("Select an event",""),20,W.height/2))}function ke(){return{height:oe.height,width:oe.width}}function Hi(t){x.dragStart=a.transformedPoint(x.lastX,x.lastY),x.dragged=!1,x.whichButton=t.which}function Xi(){if(x.dragStart){const t=a.transformedPoint(x.lastX,x.lastY);t.x=Math.round(t.x),t.y=Math.round(t.y);const e={x:Math.round(x.dragStart.x),y:Math.round(x.dragStart.y)};Math.abs(t.x-e.x)+Math.abs(t.y-e.y)>5&&(La()?pi(e,t,x.whichButton):Ke()===h.TAB_CREATE?Ll(e,t,x.whichButton):_t.mouseDrag(e,t)||a.translate(t.x-x.dragStart.x,t.y-x.dragStart.y),x.dragged=!0,S())}}function Vi(t){const e=Ke();x.dragged?e===h.TAB_CREATE?xr():e===h.TAB_DRAW?Ia():_t.dragEnded():e===h.TAB_CREATE?Ir(Math.round(x.dragStart.x),Math.round(x.dragStart.y)):e===h.TAB_DRAW?Aa(Math.round(x.dragStart.x),Math.round(x.dragStart.y),t.which):_t.mouseUp(Math.round(x.dragStart.x),Math.round(x.dragStart.y)),x.dragStart=null,S()}function Qd(t){return Gi(t),Hi(t),t.stopPropagation(),t.preventDefault()}function ec(t){return Gi(t),Xi(),t.stopPropagation(),t.preventDefault()}function tc(t){return Vi(t),t.stopPropagation(),t.preventDefault()}function Tn(t){const e=t.wheelDelta?t.wheelDelta/40:t.detail?-t.detail:0;return e&&at(e),t.stopPropagation(),t.preventDefault()}function sc(t){Vi(t),x.pinched=!1}function nc(t){if(t.touches.length>1?x.pinched||Yi(t):x.pinched=!1,x.pinched&&t.touches.length>1){x.pinchEnd0=a.transformedPoint(t.touches[0].pageX,t.touches[0].pageY),x.pinchEnd1=a.transformedPoint(t.touches[1].pageX,t.touches[1].pageY);const e=J(x.pinchStart0.x,x.pinchStart0.y,x.pinchStart1.x,x.pinchStart1.y),s=J(x.pinchEnd0.x,x.pinchEnd0.y,x.pinchEnd1.x,x.pinchEnd1.y);e/s>1.1?(at(-1),x.pinchStart0=x.pinchEnd0,x.pinchStart1=x.pinchEnd1):e/s<.9&&(at(1),x.pinchStart0=x.pinchEnd0,x.pinchStart1=x.pinchEnd1)}else x.lastX=t.touches[0].pageX,x.lastY=t.touches[0].pageY,Xi()}function ic(t){t.preventDefault(),t.touches.length>1&&Yi(t),x.lastX=t.touches[0].pageX,x.lastY=t.touches[0].pageY,Hi(t)}function lc(){Zd(),ac(a),Ui()}function Hs(t,e=!1){document.getElementById("rg2-map-load-progress-label").textContent=p("Loading map",""),document.getElementById("rg2-map-load-progress").classList.remove("d-none"),oe.src=e?t:t+"?"+Date.now()}function rc(){document.getElementById("rg2-map-load-progress").classList.add("d-none"),Xs(),h.managing()&&br()}function S(){ss===void 0&&(ss=setTimeout(()=>{ss=void 0,oc()},75))}function oc(){if(a.save(),a.setTransform(1,0,0,1,0,0),a.globalAlpha=h.FULL_INTENSITY,a.fillStyle=h.GREY,a.fillRect(0,0,a.canvas.width,a.canvas.height),a.restore(),oe.height>0){a.fillStyle=h.WHITE,a.globalAlpha=h.FULL_INTENSITY,a.fillRect(0,0,oe.width,oe.height),a.globalAlpha=k.perCentMapIntensity/100,a.drawImage(oe,0,0);const t=Ke();t===h.TAB_DRAW?(yn(h.DIM),z.drawControls(!1),en(),Ta()):t===h.TAB_CREATE?Yl():(yn(h.DIM),en(),_t.drawOverlays(),z.drawControls(!1),_d())}else Jd()}function Xs(){let t=1;const e=W.height/oe.height;x.lastX=W.width/2,x.lastY=W.height/2,x.zoomSize=1,x.dragStart=null,x.dragged=!0,e<1&&(t=e),window.innerWidth>=h.BIG_SCREEN_BREAK_POINT?a.setTransform(t,0,0,t,document.getElementById("rg2-left-info-panel").offsetWidth+80,0):a.setTransform(t,0,0,t,0,0),a.displayAngle=0,a.save(),S()}function Ui(){x.scaleFactor=h.DEFAULT_SCALE_FACTOR;const t=document.getElementById("rg2-header-container").offsetHeight;document.getElementById("rg2-container").style.height=window.innerHeight-t+"px",W.width=window.innerWidth,W.height=window.innerHeight-t,Xs()}function Cn(t){const e=t*(Math.PI/36);$i(e,oe.width/2,oe.height/2,!1)}function Gi(t){x.lastX=t.pageX-W.offsetParent.offsetLeft,x.lastY=t.pageY-W.offsetParent.offsetTop}function Yi(t){x.pinchStart0=a.transformedPoint(t.touches[0].pageX,t.touches[0].pageY),x.pinchStart1=a.transformedPoint(t.touches[1].pageX,t.touches[1].pageY),x.pinched=!0}function ac(t){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");let s=e.createSVGMatrix(),n=[],i=t.save;t.save=function(){return n.push(s.translate(0,0)),i.call(t)};let l=t.restore;t.restore=function(){return s=n.pop(),l.call(t)};let r=t.scale;t.scale=function(m,v){return s=s.scaleNonUniform(m,v),r.call(t,m,v)};let o=t.translate;t.translate=function(m,v){return s=s.translate(m,v),o.call(t,m,v)};let f=t.setTransform;t.setTransform=function(m,v,B,O,N,A){return s.a=m,s.b=v,s.c=B,s.d=O,s.e=N,s.f=A,f.call(t,m,v,B,O,N,A)};let y=e.createSVGPoint();t.transformedPoint=function(m,v){return y.x=m,y.y=v,y.matrixTransform(s.inverse())};let u=t.rotate;t.rotate=function(m){return s=s.rotate(m*180/Math.PI),u.call(t,m)}}function at(t){if(!h.managing()&&Ci()===null)return;const e=Math.pow(x.scaleFactor,t),s=x.zoomSize*e;if(s<50&&s>.05){x.zoomSize=s;const n=a.transformedPoint(x.lastX,x.lastY);a.translate(n.x,n.y),a.scale(e,e),a.translate(-n.x,-n.y),a.save(),S()}}document.readyState!=="loading"?kn():document.addEventListener("DOMContentLoaded",kn);function kn(){const t=document.querySelector(".rg2-startup");t.addEventListener("transitionend",()=>{t.remove(),ad(),ol(),na(),el(),h.managing()&&vr(rg2Config.keksi),lc(),window.onpopstate=dc,window.location.hash&&!h.managing()&&_n(window.location.hash),document.getElementById("rg2-event-title").innerHTML="Routegadget 2",Ze()}),t.style.opacity=0}function dc(){if(window.location.hash!==""&&!h.managing()){const t=_n(window.location.hash);Di(t)&&vd()!==t&&mt(t)}}
//# sourceMappingURL=main-11eD86JJ.js.map
