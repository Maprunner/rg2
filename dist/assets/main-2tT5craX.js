import{a as Ji,T as Qi,M as el,d as ae,C as Rn,O as Mn,i as Mt}from"./vendor-oPMpqxxv.js";import{L as xs,D as qs,p as It}from"./manager-Cw-VX6TE.js";import{M as tl,C as sl,c as Is}from"./grid-DnPZ0k3G.js";const Nn=Ji.create({baseURL:rg2Config.api_url});function Vt(t,e,s){t.t=new Date().getTime(),document.getElementById("rg2-container").style.cursor="wait",Nn({method:"get",url:"",params:t}).then(n=>{e(n.data.data,t.id)}).catch(function(n){_n(s+": "+n)}).finally(function(){document.getElementById("rg2-container").style.cursor="auto"})}function pe(t,e,s,n,i=()=>{}){let l={method:"post"};l.data=t,e.headers&&(l.headers=e.headers,delete e.headers),e.t=new Date().getTime(),l.params=e,document.getElementById("rg2-container").style.cursor="wait",Nn(l).then(r=>{r.data.keksi&&i(r.data.keksi),s(r.data)}).catch(function(r){_n(n+": "+r)}).finally(function(){document.getElementById("rg2-container").style.cursor="auto"})}function _n(t){document.getElementById("rg2-load-progress").classList.add("d-none"),document.getElementById("rg2-map-load-progress").classList.add("d-none"),I("Configuration error",t)}let Te={};Te.code="en";let Dt=[];function nl(t){let e=document.getElementById("rg2-select-language");e.innerHTML="";let s=Te.code==="en";e.options.add(je("en","en: English",s));for(let n=0;n<t.length;n=n+1)s=Te.code===t[n].code,e.options.add(je(t[n].code,t[n].code+": "+t[n].language,s));e.addEventListener("change",n=>{const i=n.target.value;i!==Te.code&&(i==="en"?Fn("en"):Pn(i))})}function Pn(t){Vt({type:"lang",lang:t},ll,"Language request failed")}function il(t){const e=Dt.indexOf(t);return e>-1?e:(Dt.push(t),Dt.length-1)}function ll(t){Fn(t.lang)}function rl(){rg2Config.start_language!=="en"&&Pn(rg2Config.start_language)}function Fn(t){t==="en"?Te={code:"en"}:Te=t,ol()}function p(t,e="span"){const s=il(t);return Te.hasOwnProperty(t)&&(t=Te[t]),e===""?t:`<${e} data-rg2t='${s}'>${t}</${e}>`}function ol(){const t=document.querySelectorAll("[data-rg2t]");for(let e of t){const s=parseInt(e.dataset.rg2t,10);e.innerText=p(Dt[s],"")}}function ds(t,e,s){return t.length>0?t[0].getAttribute(e).trim():s}function _(t){const e=Math.floor(t/60);let s=e;const n=t-e*60;return n<10?s+=":0"+n:s+=":"+n,s}function al(t){let e;const s=Math.floor(t/3600);s<10?e="0"+s+":":e=s+":",t=t-s*3600;const n=Math.floor(t/60);return n<10?e+="0"+n:e+=n,t=t-n*60,t<10?e+=":0"+t:e+=":"+t,e}function je(t,e,s=!1){let n=document.createElement("option");return n.value=t,n.text=e,s&&(n.selected=!0),n}function Ce(t,e,s=!1){return`<option value="${t}"${s?" selected":""}>${e}</option>`}function Pe(t,e,s,n){let i=Math.atan2(n-e,s-t);return i<0&&(i=i+2*Math.PI),i}function J(t,e,s,n){return Math.sqrt(Math.pow(t-s,2)+Math.pow(e-n,2))}function cs(t,e,s,n){const i=(s-t).toRad(),l=(n-e).toRad(),r=Math.sin(i/2)*Math.sin(i/2)+Math.cos(t.toRad())*Math.cos(s.toRad())*Math.sin(l/2)*Math.sin(l/2);return 6371009*2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r))}function dl(t){if(!t)return 0;let e=0;const s=t.split(":");return e=parseInt(s[0],10)*3600+parseInt(s[1],10)*60,isNaN(e)?0:e}function ve(t){if(!t)return 0;let e=0,s=t.replace(/\./g,":").split(":");return s.length===2?e=parseInt(s[0],10)*60+parseInt(s[1],10):s.length===3&&(e=parseInt(s[0],10)*3600+parseInt(s[1],10)*60+parseInt(s[2],10)),isNaN(e)?0:e}const I=(t,e)=>{ul(t,e)},cl=document.getElementById("rg2-toast-container"),ul=(t,e)=>{const s=document.createElement("div");s.classList.add("toast"),s.setAttribute("data-bs-autohide","false"),s.innerHTML=`<div class="toast-header">
      <strong class="me-auto">${t}</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">
      ${e}
    </div>`,cl.appendChild(s),[...document.querySelectorAll(".toast")].map(i=>{const l=new Qi(i,{});i.addEventListener("hidden.bs.toast",()=>{i.parentNode&&i.parentNode.removeChild(i)}),l.show()})};function ne(t,e){return t.length>0?t[0].textContent.trim():e}let tt;function ye(t,e=!0){tt&&tt.dispose();const s=document.getElementById("rg2-modal-container");s.innerHTML="";const n=e?`<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${p("Cancel")}</button>`:"",i=`<div class="modal fade" id="rg2-modal-dialog" data-bs-backdrop="static" data-bs-keyboard="false"
    tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="staticBackdropLabel">${t.title}</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          ${t.body}
        </div>
        <div class="modal-footer">
          <button id="rg2-do-modal-action" type="button" class="btn btn-primary">${p(t.doText)}</button>
          ${n}
        </div>
      </div>
    </div>
    </div > `;s.innerHTML=i,typeof t.onCancel!="function"&&(t.onCancel=()=>{});let l=!1;const r=document.getElementById("rg2-modal-dialog");document.getElementById("rg2-do-modal-action").addEventListener("click",()=>{l=!0,tt.hide()});const o={keyboard:!0};tt=new el(r,o),r.addEventListener("hidden.bs.modal",()=>{l?t.onDo():t.onCancel()}),tt.show()}function hl(t,e){const s=document.getElementById(t),n=e(s.value);return n?(s.classList.add("is-valid"),s.classList.remove("is-invalid")):(s.classList.add("is-invalid"),s.classList.remove("is-valid")),n}Number.prototype.toRad=function(){return this*Math.PI/180};const zs=["#ff0000","#00ff00","#0000ff","#800000","#008000","#000080","#ffff00","#ff00ff","#00ffff","#808000","#800080","#008080"];let es=0;function On(){return es=(es+1)%zs.length,zs[es]}const h={RG2VERSION:"2.0.5",DEFAULT_SCALE_FACTOR:1.1,TAB_EVENTS:"event-tab",TAB_COURSES:"course-tab",TAB_RESULTS:"result-tab",TAB_DRAW:"draw-tab",TAB_LOGIN:"manage-login-tab",TAB_CREATE:"manage-create-tab",TAB_EDIT:"manage-edit-tab",TAB_MAP:"manage-map-tab",TAB_DELETE_MAP:"manage-delete-map-tab",INVALID_MAP_ID:9999,DEFAULT_NEW_COMMENT:"Type your comment",GPS_RESULT_OFFSET:5e4,MASS_START_REPLAY:1,REAL_TIME_REPLAY:2,MASS_START_BY_CONTROL:99999,VERY_HIGH_TIME_IN_SECS:99999,BIG_SCREEN_BREAK_POINT:800,SMALL_SCREEN_BREAK_POINT:500,PURPLE:"#b300ff",RED:"#ff0000",GREEN:"#00ff00",DARK_GREEN:"rgb(34, 139, 34)",DARK_GREEN_30:"rgba(34, 139, 34, 0.3)",GREY:"#e0e0e0",RED_30:"rgba(255,0,0,0.3)",GREEN_30:"rgba(0,255,0,0.3)",WHITE:"#ffffff",BLACK:"#000000",RUNNER_DOT_RADIUS:6,HANDLE_DOT_RADIUS:7,HANDLE_COLOUR:"#ff0000",DIM:.75,FULL_INTENSITY:1,TIME_NOT_FOUND:9999,RIGHT_CLICK:3,DO_NOT_SAVE_COURSE:9999,FORMAT_NORMAL:1,FORMAT_NORMAL_NO_RESULTS:2,FORMAT_SCORE_EVENT:3,FORMAT_SCORE_EVENT_NO_RESULTS:4,DISPLAY_ALL_COURSES:99999,EXCLUDED_NONE:0,EXCLUDED_ZERO_SPLITS:1,EXCLUDED_REAL_SPLITS:2,MAX_DRAWN_ROUTES:10,languages:[{language:"Čeština",code:"cz"},{language:"Deutsch",code:"de"},{language:"Suomi",code:"fi"},{language:"Français",code:"fr"},{language:"Italiano",code:"it"},{language:"日本語",code:"ja"},{language:"Norsk",code:"no"},{language:"Português - Brasil",code:"pt"},{language:"Русский",code:"ru"}],FILE_SIZE_WARNING:2,PIXEL_SIZE_WARNING:4e3,CLASS_NOW_ON:1,CLASS_NOW_OFF:0,managing:()=>rg2Config.keksi!==void 0},D={perCentMapIntensity:100,perCentRouteIntensity:100,replayFontSize:12,courseWidth:3,routeWidth:4,circleSize:20,snap:!0,showThreeSeconds:!1,showGPSSpeed:!1,alignMap:!1,maxSpeed:5,minSpeed:15,drawnRoutes:[]};function ft(){let t={};const e=ke();let s=Math.pow(Math.min(e.height,e.width)/1500,.5);s=Math.min(s,5),s=Math.max(s,.5);const n=Math.round(D.circleSize*s);return t.controlRadius=n,t.finishInnerRadius=n*(5/6),t.finishOuterRadius=n*(7/6),t.startTriangleLength=n*(7/6),t.overprintWidth=D.courseWidth,t.font=n+"pt Arial",t}function fl(){try{if(window.hasOwnProperty("localStorage")&&window.localStorage!==null&&localStorage.getItem("rg2-options")!==null){const t=JSON.parse(localStorage.getItem("rg2-options"));for(let e in t)t.hasOwnProperty(e)&&(D[e]=t[e]);D.circleSize=20,D.perCentMapIntensity===0&&I("Warning","Your saved settings have 0% map intensity so the map is invisible. You can adjust this on the configuration menu")}}catch{}}function gl(t){let e=[];for(let s=0;s<D.drawnRoutes.length;s+=1)(D.drawnRoutes[s].id!==t.id||D.drawnRoutes[s].eventid!==t.eventid)&&e.push(D.drawnRoutes[s]);D.drawnRoutes=e,Ut()}function Ut(){try{window.hasOwnProperty("localStorage")&&window.localStorage!==null&&localStorage.setItem("rg2-options",JSON.stringify(D))}catch{return}}function ml(t){let e=D.drawnRoutes;e.length>=h.MAX_DRAWN_ROUTES&&e.shift(),e.push(t),D.drawnRoutes=e,Ut()}function pl(t,e){D[t]=e,Ut()}class bs{constructor(){this.controls=[],this.displayControls=!1}addControl(e,s,n){let i=!0;for(let l=0;l<this.controls.length;l+=1)if(this.controls[l].code===e){i=!1;break}i&&this.controls.push({code:e,x:s,y:n})}deleteAllControls(){this.controls.length=0}displayAllControls(){this.displayControls=!0}drawControls(e){if(this.displayControls){const s=ft();for(let n=0;n<this.controls.length;n+=1)this.controls[n].code.indexOf("F")===0||this.controls[n].code.indexOf("M")===0?this.drawFinish(this.controls[n].x,this.controls[n].y,this.controls[n].code,s):this.controls[n].code.indexOf("S")===0?this.drawStart(this.controls[n].x,this.controls[n].y,this.controls[n].code,1.5*Math.PI,s):(this.drawSingleControl(this.controls[n].x,this.controls[n].y,this.controls[n].code,Math.PI*.25,s),e&&a.fillRect(this.controls[n].x-1,this.controls[n].y-1,3,3))}}drawFinish(e,s,n,i){a.strokeStyle="white",a.lineWidth=i.overprintWidth+2,a.beginPath(),a.arc(e,s,i.finishInnerRadius,0,2*Math.PI,!1),a.stroke(),a.beginPath(),a.arc(e,s,i.finishOuterRadius,0,2*Math.PI,!1),a.stroke(),a.beginPath(),a.font=i.font,a.textAlign="left",a.strokeStyle="white",a.miterLimit=2,a.lineJoin="circle",a.lineWidth=1.5,a.strokeText(n,e+i.controlRadius*1.5,s+i.controlRadius),a.stroke(),a.beginPath(),a.fillStyle=h.PURPLE,a.strokeStyle=h.PURPLE,a.lineWidth=i.overprintWidth,a.arc(e,s,i.finishInnerRadius,0,2*Math.PI,!1),a.stroke(),a.beginPath(),a.arc(e,s,i.finishOuterRadius,0,2*Math.PI,!1),a.fillText(n,e+i.controlRadius*1.5,s+i.controlRadius),a.stroke()}drawSingleControl(e,s,n,i,l){a.beginPath(),a.strokeStyle="white",a.lineWidth=l.overprintWidth+2,a.arc(e,s,l.controlRadius,0,2*Math.PI,!1),a.stroke(),a.beginPath(),a.textAlign="center",a.font=l.font,a.strokeStyle="white",a.miterLimit=2,a.lineJoin="circle",a.lineWidth=1.5,a.textBaseline="middle";const r=a.measureText(n);let o;i<Math.PI?o=r.width/2:o=-1*r.width/2;let f;i>=Math.PI/2&&i<=Math.PI*1.5?f=-1*l.controlRadius/2:f=l.controlRadius/2;const y=1.3;a.strokeText(n,e+l.controlRadius*y*Math.sin(i)+o,s+l.controlRadius*y*Math.cos(i)+f),a.beginPath(),a.font=l.font,a.fillStyle=h.PURPLE,a.strokeStyle=h.PURPLE,a.lineWidth=l.overprintWidth,a.arc(e,s,l.controlRadius,0,2*Math.PI,!1),a.fillText(n,e+l.controlRadius*y*Math.sin(i)+o,s+l.controlRadius*y*Math.cos(i)+f),a.stroke()}drawStart(e,s,n,i,l){let r=[],o=[];const f=2*Math.PI/3;i=i+Math.PI/2,a.lineCap="round",a.strokeStyle="white",a.lineWidth=l.overprintWidth+2,a.beginPath(),r[0]=e+l.startTriangleLength*Math.sin(i),o[0]=s-l.startTriangleLength*Math.cos(i),a.moveTo(r[0],o[0]),r[1]=e+l.startTriangleLength*Math.sin(i+f),o[1]=s-l.startTriangleLength*Math.cos(i+f),a.lineTo(r[1],o[1]),a.stroke(),a.beginPath(),a.moveTo(r[1],o[1]),r[2]=e+l.startTriangleLength*Math.sin(i-f),o[2]=s-l.startTriangleLength*Math.cos(i-f),a.lineTo(r[2],o[2]),a.stroke(),a.beginPath(),a.moveTo(r[2],o[2]),a.lineTo(r[0],o[0]),a.stroke(),a.beginPath(),a.font=l.font,a.textAlign="left",a.strokeStyle="white",a.miterLimit=2,a.lineJoin="circle",a.lineWidth=1.5,a.strokeText(n,r[0]+l.controlRadius*1.25,o[0]+l.controlRadius*1.25),a.stroke(),a.strokeStyle=h.PURPLE,a.lineWidth=l.overprintWidth,a.font=l.font,a.fillStyle=h.PURPLE,a.beginPath(),a.moveTo(r[0],o[0]),a.lineTo(r[1],o[1]),a.stroke(),a.beginPath(),a.moveTo(r[1],o[1]),a.lineTo(r[2],o[2]),a.stroke(),a.beginPath(),a.moveTo(r[2],o[2]),a.lineTo(r[0],o[0]),a.fillText(n,r[0]+l.controlRadius*1.25,o[0]+l.controlRadius*1.25),a.stroke()}generateControlList(){this.controls.length=0;const e=Id();for(let s=0;s<e.length;s+=1)if(e[s]!==void 0){const n=e[s].codes,i=e[s].x,l=e[s].y;if(n!==void 0)for(let r=0;r<n.length;r+=1)this.addControl(n[r],i[r],l[r])}}getControlCount(){return this.controls.length}toggleControlDisplay(){this.displayControls=!this.displayControls}}class yl{constructor(e,s,n,i){this.x=e,this.y=s,this.basex=e,this.basey=s,this.undox=e,this.undoy=s,this.locked=!1,this.time=n,this.index=i}}class vl{constructor(){this.handles=[]}addHandle(e,s,n){this.handles.push(new yl(e,s,n,this.handles.length)),this.handles.sort(function(i,l){return i.time-l.time}),this.renumberHandles()}deleteHandle(e){e===0||e===this.handles.length-1||(this.handles.splice(e,1),this.renumberHandles())}renumberHandles(){for(let e=0;e<this.handles.length;e+=1)this.handles[e].index=e}lockHandle(e){this.handles[e].locked=!0}lockHandleByTime(e){for(let s=0;s<this.handles.length;s+=1)this.handles[s].time===e&&(this.handles[s].locked=!0)}unlockHandle(e){this.handles[e].locked=!1}handlesLocked(){let e=0;for(let s=0;s<this.handles.length;s+=1)this.handles[s].locked&&(e+=1);return e}deleteAllHandles(){this.handles.length=0}rebaselineXY(){this.copyHandleFields("","base")}saveForUndo(){this.copyHandleFields("base","undo")}undo(){this.copyHandleFields("undo","base"),this.copyHandleFields("undo","")}copyHandleFields(e,s){for(let n=0;n<this.handles.length;n+=1)this.handles[n][s+"x"]=this.handles[n][e+"x"],this.handles[n][s+"y"]=this.handles[n][e+"y"]}getStartHandle(){return this.handles[0]}getFinishHandle(){return this.handles[this.handles.length-1]}getHandleClicked(e){for(let s=0;s<this.handles.length;s+=1)if(J(e.x,e.y,this.handles[s].basex,this.handles[s].basey)<=h.HANDLE_DOT_RADIUS)return this.handles[s]}getEarliestLockedHandle(){for(let e=0;e<this.handles.length;e+=1)if(this.handles[e].locked)return this.handles[e]}getLatestLockedHandle(){for(let e=this.handles.length-1;e>0;e-=1)if(this.handles[e].locked)return this.handles[e]}getPreviousLockedHandle(e){for(let s=e.index-1;s>=0;s-=1)if(this.handles[s].locked)return this.handles[s]}getNextLockedHandle(e){for(let s=e.index+1;s<this.handles.length;s+=1)if(this.handles[s].locked)return this.handles[s]}getSingleLockedHandle(){return this.getEarliestLockedHandle()}dragHandles(e,s){for(let n=0;n<this.handles.length;n+=1)this.handles[n].x=this.handles[n].basex+e,this.handles[n].y=this.handles[n].basey+s}drawHandles(){for(let e=0;e<this.handles.length;e+=1)a.lineWidth=1,this.handles[e].locked===!0?(a.fillStyle=h.RED_30,a.strokeStyle=h.RED):(a.fillStyle=h.GREEN_30,a.strokeStyle=h.GREEN),a.beginPath(),a.arc(this.handles[e].x,this.handles[e].y,h.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),a.fill(),a.stroke()}alignHandles(e){for(let s=0;s<this.handles.length;s+=1)this.handles[s].x=e.x[this.handles[s].time],this.handles[s].y=e.y[this.handles[s].time]}}class Gt{constructor(){this.courseid=null,this.coursename=null,this.controlsToAdjust=0,this.resultid=null,this.isScoreCourse=!1,this.eventid=null,this.name=null,this.comments=null,this.x=[],this.y=[],this.controlx=[],this.controly=[],this.time=[],this.startsecs=0,this.totaltime=0,this.splits=[],this.xml=null}}class $n{constructor(){this.lat=[],this.lon=[],this.startOffset=0,this.baseX=[],this.baseY=[],this.handles=new vl,this.savedBaseX=[],this.savedBaseY=[],this.fileLoaded=!1,this.fileName="",this.fileType="",this.routeData=new Gt,this.autofitOffset=null}adjustOffset(e){this.autofitOffset=e,this.processGPSFile(),this.autofitTrack()}addStartAndFinishHandles(){this.handles.addHandle(this.baseX[0],this.baseY[0],0),this.handles.addHandle(this.baseX[this.baseX.length-1],this.baseY[this.baseY.length-1],this.baseY.length-1)}applyWorldFile(){const e=Li();for(let s=0;s<this.lat.length;s+=1)this.routeData.x[s]=Math.round((e.E*this.lon[s]-e.B*this.lat[s]+e.xCorrection)/e.AEDB),this.routeData.y[s]=Math.round((-1*e.D*this.lon[s]+e.A*this.lat[s]+e.yCorrection)/e.AEDB)}autofitTrack(){document.getElementById("chk-move-all").checked=!1,this.handles.deleteAllHandles(),this.addStartAndFinishHandles(),this.autofitOffset===null&&(this.autofitOffset=this.getOffset());for(let e=1;e<this.routeData.controlsToAdjust;e+=1)if(this.routeData.splits[e]!==this.routeData.splits[e-1]){const s=this.routeData.splits[e]+this.autofitOffset;s<this.baseX.length&&s>=0&&(this.handles.addHandle(this.routeData.x[s],this.routeData.y[s],s),Ii({x:this.routeData.x[s],y:this.routeData.y[s]},{x:this.routeData.controlx[e],y:this.routeData.controly[e]}),this.handles.lockHandleByTime(s),this.baseX=this.routeData.x.slice(0),this.baseY=this.routeData.y.slice(0),this.handles.rebaselineXY())}document.getElementById("btn-autofit-gps").setAttribute("disabled",""),document.getElementById("btn-undo-gps-adjust").setAttribute("disabled",""),b()}expandToOneSecondInterval(){let e=[],s=[],n=[];const i=this.routeData;let l=i.time[0],r=i.x[0],o=i.y[0];e[0]=r,s[0]=o,n[0]=i.time[0];let f=n[0]+1;for(let y=1;y<i.x.length;y+=1){const u=i.time[y]-l;if(u>0){const g=(i.x[y]-r)/u,v=(i.y[y]-o)/u;let k=1;for(;k<=u;)e.push(r+g*k),s.push(o+v*k),n.push(f),f+=1,k+=1;r=i.x[y],o=i.y[y],l=f-1}}this.routeData.x=e.slice(0),this.routeData.y=s.slice(0),this.routeData.time=n.slice(0)}fitTrackInsideCourse(){const e=this.getLatLonInfo(),s=this.getControlInfo();let n=(s.maxX-s.minX)/(e.maxLon-e.minLon),i=(s.maxY-s.minY)/(e.maxLat-e.minLat);n>i?i=n*e.latCorrection/e.lonCorrection:n=i*e.lonCorrection/e.latCorrection,this.routeData.x[0]=(this.lon[0]-e.minLon)*n+s.minX,this.routeData.y[0]=-1*(this.lat[0]-e.maxLat)*i+s.minY;const l=s.minX-(this.routeData.x[0]-s.x[0]),r=s.minY-(this.routeData.y[0]-s.y[0]);for(let o=0;o<this.lat.length;o+=1)this.routeData.x[o]=(this.lon[o]-e.minLon)*n+l,this.routeData.y[o]=-1*(this.lat[o]-e.maxLat)*i+r}getControlInfo(){let e=Aa();if(e.minX=Math.min.apply(Math,e.x),e.maxX=Math.max.apply(Math,e.x),e.minY=Math.min.apply(Math,e.y),e.maxY=Math.max.apply(Math,e.y),e.maxY-e.minY<100||e.maxX-e.minX<100){e.minX=0,e.minY=0;const s=ke();e.maxX=s.width,e.maxY=s.height}return e}getLatLonInfo(){let e={};return e.maxLat=Math.max.apply(Math,this.lat),e.maxLon=Math.max.apply(Math,this.lon),e.minLat=Math.min.apply(Math,this.lat),e.minLon=Math.min.apply(Math,this.lon),e.lonCorrection=cs(e.minLat,e.maxLon,e.minLat,e.minLon)/(e.maxLon-e.minLon),e.latCorrection=cs(e.minLat,e.minLon,e.maxLat,e.minLon)/(e.maxLat-e.minLat),e}getOffset(){const e=this.getSpeedAverage();let s=[];const n=10;for(let o=0;o<=2*n;o+=1)s[o]=0;let i=0;for(let o=1;o<this.routeData.controlsToAdjust;o+=1){const f=this.routeData.splits[o];if(f!==this.routeData.splits[o-1]){f>=n&&f+n<e.length&&(i=e.slice(f-n,f+n+1));for(let y=0;y<=2*n;y+=1)s[y]+=i[y]}}let l=0;for(let o=1;o<s.length;o+=1)s[o]<s[l]&&(l=o);return l-n}getSecsFromTrackpoint(e){const s=parseInt(Date.parse(e)/1e3,10);return isNaN(s)?0:s-this.startOffset}getSpeedAverage(){let e=[],s=[];e[0]=0;for(let n=1;n<this.routeData.x.length;n+=1)e[n]=J(this.routeData.x[n],this.routeData.y[n],this.routeData.x[n-1],this.routeData.y[n-1]);for(let n=1;n<this.routeData.x.length-1;n+=1)s[n]=(e[n-1]+e[n]+e[n+1])/3;return s[0]=e[0],s[this.routeData.x.length-1]=e[this.routeData.x.length-1],s}getStartOffset(e){const s=parseInt(Date.parse(e.substr(0,11)+"00:00:00Z")/1e3,10);return isNaN(s)?0:s}initialiseGPS(){this.lat.length=0,this.lon.length=0,this.startOffset=0,this.baseX.length=0,this.baseY.length=0,this.handles.deleteAllHandles(),this.savedBaseX.length=0,this.savedBaseY.length=0,this.fileLoaded=!1,this.routeData.x.length=0,this.routeData.y.length=0,this.routeData.time.length=0}processGPSFile(){this.initialiseGPS(),this.fileType==="gpx"?this.processGPX():this.processTCX(),this.processGPSTrack()}processGPSTrack(){Zt()?(this.applyWorldFile(),this.trackMatchesMapCoordinates()?document.getElementById("chk-move-all").checked=!0:(I("GPS file problem","Your GPS file does not match the map co-ordinates. Please check you have selected the correct file."),this.fitTrackInsideCourse())):this.fitTrackInsideCourse(),this.lat.length=0,this.lon.length=0,this.expandToOneSecondInterval(),this.baseX=this.routeData.x.slice(0),this.baseY=this.routeData.y.slice(0),this.addStartAndFinishHandles(),this.fileLoaded=!0,this.routeData.splits.length>2&&document.getElementById("btn-autofit-gps").removeAttribute("disabled"),document.getElementById("btn-save-gps-route").removeAttribute("disabled"),b()}processGPX(){const e=this.xml.getElementsByTagName("trkseg");for(let s=0;s<e.length;s+=1){const n=e[s].getElementsByTagName("trkpt");this.startOffset=this.getStartOffset(n[0].getElementsByTagName("time")[0].textContent);for(let i=0;i<n.length;i+=1){const l=n[i].getAttribute("lat"),r=n[i].getAttribute("lon");l!=="0"&&r!=="0"&&(this.lat.push(l),this.lon.push(r),this.routeData.time.push(this.getSecsFromTrackpoint(n[i].getElementsByTagName("time")[0].textContent)))}}}processTCX(){const e=this.xml.getElementsByTagName("Track");for(let s=0;s<e.length;s+=1){const n=e[s].getElementsByTagName("Trackpoint");this.startOffset=this.getStartOffset(n[0].getElementsByTagName("Time")[0].textContent);for(let i=0;i<n.length;i+=1)if(n[i].getElementsByTagName("Position").length>0){const l=n[i].getElementsByTagName("Position"),r=l[0].getElementsByTagName("LatitudeDegrees")[0].textContent,o=l[0].getElementsByTagName("LongitudeDegrees")[0].textContent;r!=="0"&&o!=="0"&&(this.lat.push(r),this.lon.push(o),this.routeData.time.push(this.getSecsFromTrackpoint(n[i].getElementsByTagName("Time")[0].textContent)))}}}readGPS(e){let s=new FileReader;this.fileName=e.target.files[0].name,s.onerror=function(n){I("GPS file problem","Unable to open GPS file. "+n)},s.onload=n=>{try{if(this.fileType=this.fileName.slice(-3).toLowerCase(),this.fileType!=="gpx"&&this.fileType!=="tcx"){I("GPS file problem","File type not recognised. Please check you have selected the correct file.");return}document.getElementById("rg2-load-gps-file").setAttribute("disabled",""),this.xml=new DOMParser().parseFromString(n.target.result,"text/xml"),this.processGPSFile()}catch(i){I("GPS file problem","File is not valid XML. Please check you have selected the correct file. "+i);return}},s.readAsText(e.target.files[0])}trackMatchesMapCoordinates(){const e=Math.min.apply(Math,this.routeData.x),s=Math.max.apply(Math,this.routeData.x),n=Math.min.apply(Math,this.routeData.y),i=Math.max.apply(Math,this.routeData.y),l=ke();return s>0&&e<l.width&&n<l.height&&i>0}}let ie=0,he=[],le=[];function Ks(t,e){return t.length>0?e+t.join(","):""}function Zs(t,e,s){let n=0;return ie!==0&&(n="#"+t+Ks(s,"&course=")+Ks(e,"&route=")),n}function El(){return he}function xl(){return ie}function Il(){return le}function bl(){return le.length>0?h.TAB_RESULTS:h.TAB_COURSES}function Sl(t){let e=t.replace(/#([0-9]+)($|&).*/,"$1");return e.length>0?parseInt(e,10):e}function Hn(t){ie=0,he.length=0,le.length=0;let e=t.split("&");for(let s=0;s<e.length;s+=1)e[s]=e[s].toLowerCase(),e[s].search("#")!==-1&&(ie=parseInt(e[s].replace(/\D/g,""),10)),e[s].search("course=")!==-1&&(he=e[s].replace("course=","").split(",")),e[s].search("route=")!==-1&&(le=e[s].replace("route=","").split(","));return he=he.map(Number),le=le.map(Number),isNaN(ie)&&(ie=0,he.length=0,le.length=0),Yt(),ie}function Tl(t){ie=t,Yt()}function Js(t){he=t,Yt()}function ts(t){le=t,Yt()}function Yt(){let t="";Sl(window.location.hash)===ie?(t=Zs(ie,le,he),window.history.replaceState({hash:t},"",t)):(he.length=0,le.length=0,t=Zs(ie,le,he),window.history.pushState({hash:t},"",t))}class Cl{constructor(e,s,n){return this.courses=[],this.courseClassMapping=[],this.newcontrols=new bs,this.courses.length=0,this.courseClassMapping.length=0,this.fromOldCondes=!1,this.coursesGeoreferenced=!1,this.newcontrols.deleteAllControls(),this.localWorldfile=n,this.worldfile=s,this.processCoursesXML(e.target.result),this.addControlCount(),{courses:this.courses,newcontrols:this.newcontrols,mapping:this.courseClassMapping,georeferenced:this.coursesGeoreferenced}}processCoursesXML(e){let s=null;try{s=new DOMParser().parseFromString(e,"text/xml")}catch{I("XML file error","File is not a valid XML course file.");return}if(s.getElementsByTagName("CourseData").length===0){s.documentElement.nodeName==="kml"?this.processKMLCourses(s):I("XML file error","File is not a valid XML course file. CourseData element missing.");return}const i=this.getVersion(s);switch(i){case"2.0.3":this.processIOFV2XMLCourses(s);break;case"3.0":this.processIOFV3XMLCourses(s);break;default:I("XML file error","Invalid IOF file format. Version "+i+" not supported.")}}getVersion(e){let s="",n=e.getElementsByTagName("IOFVersion");return n.length>0&&(s=n[0].getAttribute("version")),s===""&&(n=e.getElementsByTagName("CourseData"),n.length>0&&(s=n[0].getAttribute("iofVersion").trim(),this.setCreator(n[0].getAttribute("creator").trim()))),s}setCreator(e){e.indexOf("Condes")>-1&&e.length>15&&parseFloat(e.substring(15))<10.1&&(this.fromOldCondes=!0)}processIOFV3XMLCourses(e){let s=e.getElementsByTagName("Control"),n={x:0,y:0};for(let i=0;i<s.length;i+=1)if(s[i].parentNode.nodeName==="RaceCourseData"){const l=s[i].getElementsByTagName("Id")[0].textContent,r=s[i].getElementsByTagName("Position");this.localWorldfile.valid&&r.length>0?(n=this.getXYFromLatLng(r),this.coursesGeoreferenced=!0):n=this.getXYFromMapPosition(s[i].getElementsByTagName("MapPosition"));let o={};s[i].getAttribute("type")!=="CrossingPoint"&&(this.newcontrols.addControl(l.trim(),n.x,n.y),o.id=i,r.length>0?(o.lat=parseFloat(r[0].getAttribute("lat")),o.lng=parseFloat(r[0].getAttribute("lng"))):(o.lat=0,o.lng=0),o.x=n.x,o.y=n.y)}s=e.getElementsByTagName("Course"),this.extractV3Courses(s),s=e.getElementsByTagName("ClassCourseAssignment"),this.extractV3CourseClassMapping(s)}processKMLCourses(e){this.coursesGeoreferenced=!0;const s=e.getElementsByTagName("Placemark");for(let r=0;r<s.length;r=r+1){let o={};const f=s[r].getElementsByTagName("name")[0].childNodes[0].nodeValue.trim(),u=s[r].getElementsByTagName("Point")[0].getElementsByTagName("coordinates")[0].childNodes[0].nodeValue.trim().split(","),g=+u[1],v=+u[0];o.x=this.worldfile.getX(v,g),o.y=this.worldfile.getY(v,g),this.newcontrols.addControl(f.trim(),o.x,o.y);let k={};k.id=r+1,k.lat=g,k.lng=v,k.x=o.x,k.y=o.y}let n=[];const i="Course 1",l="Course 1";n=this.newcontrols.controls.map(function(r){return r.code}),this.courses.push({courseid:0,x:[],y:[],codes:n,name:i}),this.courseClassMapping.push({course:i,className:l}),document.getElementById("rg2-select-course-file").classList.add("is-valid")}getXYFromLatLng(e){let s={x:0,y:0};const n=parseFloat(e[0].getAttribute("lat")),i=parseFloat(e[0].getAttribute("lng"));return this.fromOldCondes?(s.x=this.localWorldfile.getX(i,n),s.y=this.localWorldfile.getY(i,n)):(s.x=this.worldfile.getX(i,n),s.y=this.worldfile.getY(i,n)),s}processIOFV2XMLCourses(e){if(this.extractV2Controls(e.getElementsByTagName("StartPoint"),"StartPointCode"),this.extractV2Controls(e.getElementsByTagName("Control"),"ControlCode"),this.coursesGeoreferenced=this.extractV2Controls(e.getElementsByTagName("FinishPoint"),"FinishPointCode"),this.coursesGeoreferenced&&this.localWorldfile.valid)for(let s=0;s<this.newcontrols.controls.length;s+=1){const n=this.newcontrols.controls[s].x,i=this.newcontrols.controls[s].y;this.newcontrols.controls[s].x=this.localWorldfile.getX(n,i),this.newcontrols.controls[s].y=this.localWorldfile.getY(n,i)}this.extractV2Courses(e.getElementsByTagName("Course"))}extractV2Courses(e){for(let s=0;s<e.length;s+=1){let n=[],i=[],l=[];const r=e[s].getElementsByTagName("CourseName")[0].textContent.trim();n=this.extractCodesFromControlList(e[s],"ControlCode"),n.unshift(e[s].getElementsByTagName("StartPointCode")[0].textContent.trim()),n.push(e[s].getElementsByTagName("FinishPointCode")[0].textContent.trim()),this.courses.push({courseid:0,x:i,y:l,codes:n,name:r})}document.getElementById("rg2-select-course-file").classList.add("is-valid")}extractV3Courses(e){for(let s=0;s<e.length;s+=1){let n=[],i=[],l=[];const r=e[s].getElementsByTagName("Name")[0].textContent.trim();n=this.extractCodesFromControlList(e[s],"Control"),this.courses.push({courseid:0,x:i,y:l,codes:n,name:r})}document.getElementById("rg2-select-course-file").classList.add("is-valid")}extractV3CourseClassMapping(e){for(let s=0;s<e.length;s+=1){const n=e[s].getElementsByTagName("CourseName")[0].textContent.trim(),i=e[s].getElementsByTagName("ClassName")[0].textContent.trim();this.courseClassMapping.push({course:n,className:i})}document.getElementById("rg2-select-course-file").classList.add("is-valid")}extractCodesFromControlList(e,s){const n=e.getElementsByTagName("CourseControl");let i=[];for(let l=0;l<n.length;l+=1)if(l===0||n[l].getAttribute("type")!=="Start"){const r=n[l].getElementsByTagName(s)[0].textContent.trim();this.validControlCode(r)&&i.push(r)}return i}extractV2Controls(e,s){let n=!1,i={x:0,y:0};for(let l=0;l<e.length;l+=1){const r=e[l].getElementsByTagName(s)[0].textContent,o=e[l].getElementsByTagName("ControlPosition");o.length>0&&this.localWorldfile.valid?(i.x=parseFloat(o[0].getAttribute("x")),i.y=parseFloat(o[0].getAttribute("y")),n=!0):i=this.getXYFromMapPosition(e[l].getElementsByTagName("MapPosition")),this.newcontrols.addControl(r.trim(),i.x,i.y)}return n}getXYFromMapPosition(e){return{x:e[0].getAttribute("x").replace(",","."),y:e[0].getAttribute("y").replace(",",".")}}validControlCode(e){const s=this.newcontrols.controls;for(let n=0;n<s.length;n+=1)if(s[n].code===e)return!0;return!1}addControlCount(){for(let e=0;e<this.courses.length;e+=1)this.courses[e].controlcount=this.courses[e].codes.length-2}}class kl{constructor(){if(this.georefsystems=[],this.georefsystems.push({name:"Not georeferenced",description:"none",params:"",value:0}),this.georefsystems.push({name:"GB National Grid",description:"EPSG:27700",params:"+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs",value:1}),this.georefsystems.push({name:"Google EPSG:900913",description:"EPSG:900913",params:"+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs",value:2}),rg2Config.epsg_code!==void 0){const e=rg2Config.epsg_code.split("|"),s=rg2Config.epsg_params.split("|");for(let n=0;n<e.length;n=n+1)this.georefsystems.push({name:e[n].replace(" ",""),description:e[n].replace(" ",""),params:s[n],value:n+3});this.defaultGeorefVal=3}else this.defaultGeorefVal=1}getDefaultValue(){return this.georefsystems[this.defaultGeorefVal].value}getGeorefDropdown(){let e="";for(let s=0;s<this.georefsystems.length;s+=1)e+=Ce(s,this.georefsystems[s].name,s===0);return e}getGeorefSystem(e){return this.georefsystems[e]}}class fe{constructor(e){e.A===void 0?(this.valid=!1,this.A=0,this.B=0,this.C=0,this.D=0,this.E=0,this.F=0):(this.A=parseFloat(e.A),this.B=parseFloat(e.B),this.C=parseFloat(e.C),this.D=parseFloat(e.D),this.E=parseFloat(e.E),this.F=parseFloat(e.F),this.valid=!0,this.AEDB=e.A*e.E-e.D*e.B,this.xCorrection=e.B*e.F-e.E*e.C,this.yCorrection=e.D*e.C-e.A*e.F)}getLat(e,s){return this.D*e+this.E*s+this.F}getLon(e,s){return this.A*e+this.B*s+this.C}getX(e,s){return Math.round((this.E*e-this.B*s+this.xCorrection)/this.AEDB)}getY(e,s){return Math.round((-1*this.D*e+this.A*s+this.yCorrection)/this.AEDB)}}class Xn{constructor(e){e!==void 0?(this.mapid=e.mapid,this.name=e.name,this.worldfile=new fe(e),this.localworldfile=new fe({A:e.localA,B:e.localB,C:e.localC,D:e.localD,E:e.localE,F:e.localF}),e.mapfilename===void 0?this.mapfilename=this.mapid+".jpg":this.mapfilename=e.mapfilename):(this.mapid=0,this.name="",this.worldfile=new fe(0),this.localworldfile=new fe(0)),this.xpx=[],this.ypx=[],this.lat=[],this.lon=[]}}class Dl{constructor(e){return this.results=[],this.CSVFormat={},this.separator="",this.valid=!0,this.processResultsCSV(e),{results:this.results,valid:this.valid}}extractResult(e,s,n){let f={};f.chipid=0,f.name=(e[0]+" "+e[1]+" "+e[2]).trim(),f.dbid=f.chipid+"__"+f.name,f.starttime=dl(e[3]),f.club=e[2],f.course=s,f.controls=n;const y=this.extractSpklasseSplits(e);f.splits=y.splits,f.codes=y.codes,f.time=_(y.totaltime),this.results.push(f)}extractSingleCSVResult(e){let s={};s.valid=!0,s.chipid=e[this.CSVFormat.CHIP_IDX],s.name=(e[this.CSVFormat.FIRST_NAME_IDX]+" "+e[this.CSVFormat.SURNAME_IDX]).trim().replace(/"/g,""),s.dbid=e[this.CSVFormat.DB_IDX],s.starttime=ve(e[this.CSVFormat.START_TIME_IDX]),s.time=e[this.CSVFormat.TOTAL_TIME_IDX],s.position=this.getPosition(e),s.status=this.getSICSVStatus(e[this.CSVFormat.NC_IDX],e[this.CSVFormat.CLASSIFIER_IDX]),s.club=e[this.CSVFormat.CLUB_IDX].trim().replace(/"/g,""),s.course=e[this.CSVFormat.COURSE_IDX],s.course===""&&(s.valid=!1),s.controls=parseInt(e[this.CSVFormat.NUM_CONTROLS_IDX],10);const n=this.extractSISplits(e,s.controls);return s.splits=n.splits,s.splits!==""&&(s.splits+=";"),s.splits+=ve(s.time),s.codes=n.codes,s}extractSISplits(e,s){let n=this.CSVFormat.FIRST_SPLIT_IDX,i=this.CSVFormat.FIRST_CODE_IDX,l={};l.splits="",l.codes=[];for(let r=0;r<s;r+=1)e[i]&&(r>0&&(l.splits+=";"),l.codes[r]=e[i],l.splits+=ve(e[n])),n+=this.CSVFormat.STEP,i+=this.CSVFormat.STEP;return{splits:l.splits,codes:l.codes}}extractSpklasseSplits(e){let n="",i=[],l=0;for(let r=0;r<e.length-4;r+=1)r>0&&(n+=";"),i[r]="X",l+=ve(e[r+4]),n+=l;return{splits:n,codes:i,totaltime:l}}getCSVFormat(e){const s=["si card","database id","surname","first name","nc","start","time","classifier","city","short","course","course controls","pl","start punch","control1","punch1","control2"];let n=[];const i=e.split(this.separator).map(function(r){return r.toLowerCase()});let l=!1;for(let r=0;r<s.length;r+=1){l=!1;for(let o=0;o<i.length;o+=1){if(i[o]===s[r]){n[r]=o,l=!0;break}if(s[r]==="si card"&&(i[o]==="chipno"||i[o]==="sicard"||i[o]==="database id")){n[r]=o,l=!0;break}if(s[r]==="nc"&&i[o]==="classifier"){n[r]=o,l=!0;break}if(s[r]==="city"&&i[o]==="club"){n[r]=o,l=!0;break}if(s[r]==="pl"&&i[o]==="place"){n[r]=o,l=!0;break}}if(!l)break}l||(n=[1,2,3,4,8,9,11,12,15,18,39,42,43,44,46,47,48]),this.setCSVFormat(n)}getPosition(e){let s=parseInt(e[this.CSVFormat.POSITION_IDX],10);return isNaN(s)&&(s=""),s}getSICSVStatus(e,s){return e==="0"||e===""||e==="N"||e==="n"?s===""||s==="0"?"ok":"nok":"nc"}processCSVResults(e){for(let s=1;s<e.length;s+=1){const n=e[s].split(this.separator);if(n.length>=this.CSVFormat.FIRST_SPLIT_IDX){let i=this.extractSingleCSVResult(n);i.valid&&(delete i.valid,this.results.push(i))}}}processResultsCSV(e){const s=e.split(/[\r\n|\n]+/),n=s[0].split(",").length-1,i=s[0].split(";").length-1;n>i?this.separator=",":this.separator=";",s[0].split(this.separator).length===2?this.processSpklasseCSVResults(s):(this.getCSVFormat(s[0]),this.processCSVResults(s))}processSpklasseCSVResults(e){let i=[],l="",r=0;for(let o=0;o<e.length;o+=1)i=e[o].split(this.separator),i.length===2?(l=i[0],r=parseInt(i[1],10)):this.extractResult(i,l,r)}setCSVFormat(e){this.CSVFormat.CHIP_IDX=e[0],this.CSVFormat.DB_IDX=e[1],this.CSVFormat.SURNAME_IDX=e[2],this.CSVFormat.FIRST_NAME_IDX=e[3],this.CSVFormat.NC_IDX=e[4],this.CSVFormat.START_TIME_IDX=e[5],this.CSVFormat.TOTAL_TIME_IDX=e[6],this.CSVFormat.CLASSIFIER_IDX=e[7],this.CSVFormat.CLUB_IDX=e[8],this.CSVFormat.CLASS_IDX=e[9],this.CSVFormat.COURSE_IDX=e[10],this.CSVFormat.NUM_CONTROLS_IDX=e[11],this.CSVFormat.POSITION_IDX=e[12],this.CSVFormat.START_PUNCH_IDX=e[13],this.CSVFormat.FIRST_CODE_IDX=e[14],this.CSVFormat.FIRST_SPLIT_IDX=e[15],this.CSVFormat.STEP=e[16]-e[14]}}class Ll{constructor(e){return this.results=[],this.valid=!0,this.processIOFV2Results(e),{results:this.results,valid:this.valid}}extractIOFV2Results(e,s){for(let n=0;n<e.length;n+=1){s.status=ds(e[n].getElementsByTagName("CompetitorStatus"),"value",""),s.position=this.getPosition(e[n].getElementsByTagName("ResultPosition")),s.chipid=ne(e[n].getElementsByTagName("CCardId"),0),s.time=this.getTime(e[n].getElementsByTagName("Time")),s.starttime=this.getStartFinishTimeAsSecs(e[n].getElementsByTagName("StartTime")),s.splits="",s.codes=[];const i=e[n].getElementsByTagName("SplitTime");s.controls=i.length,this.extractIOFV2Splits(i,s);const l=this.getStartFinishTimeAsSecs(e[n].getElementsByTagName("FinishTime"));s.splits+=Math.max(l-s.starttime,0)}}extractIOFV2Splits(e,s){for(let n=0;n<e.length;n+=1){n>0&&(s.splits+=";");const i=e[n].getElementsByTagName("Time");i.length>0?(s.splits+=ve(i[0].textContent),s.codes[n]=ne(e[n].getElementsByTagName("ControlCode"),"")):(s.splits+=0,s.codes[n]="")}s.splits+=";"}getDBID(e,s){return e.length===0?s:(e=e[0].textContent.replace(/[\n\r]/g,"").trim(),e||s)}getName(e){return(e.getElementsByTagName("Given")[0].textContent+" "+e.getElementsByTagName("Family")[0].textContent).replace(/[\n\r]/g,"").trim()}getPosition(e){return e.length>0?parseInt(e[0].textContent,10):""}getStartFinishTimeAsSecs(e){if(e.length>0){const s=e[0].getElementsByTagName("Clock")[0].textContent;return ve(s)}return 0}getTime(e){return e.length>0?e[0].textContent.replace(/[\n\r]/g,""):""}processIOFV2Results(e){try{const s=e.getElementsByTagName("ClassResult");for(let n=0;n<s.length;n+=1){const i=s[n].getElementsByTagName("ClassShortName")[0].textContent,l=s[n].getElementsByTagName("PersonResult");for(let r=0;r<l.length;r+=1){let o={};o.course=i,o.name=this.getName(l[r]),o.dbid=this.getDBID(l[r].getElementsByTagName("PersonId"),r),o.club=ne(l[r].getElementsByTagName("ShortName"),"");const f=l[r].getElementsByTagName("Result");this.extractIOFV2Results(f,o),o.status!=="DidNotStart"&&this.results.push(o)}}}catch(s){this.valid=!1,I("XML parse error","Error processing XML file. Error is : "+s.message);return}}}class wl{constructor(e){return this.results=[],this.valid=!0,this.processIOFV3Results(e),{results:this.results,valid:this.valid}}extractIOFV3Results(e,s){for(let n=0;n<e.length;n+=1){s.chipid=ne(e[n].getElementsByTagName("ControlCard"),0),s.position=ne(e[n].getElementsByTagName("Position"),""),s.position==="0"&&(s.position=""),s.status=ne(e[n].getElementsByTagName("Status"),""),s.time=this.getTotalTimeAsSeconds(e[n].getElementsByTagName("Time")),s.starttime=this.getStartFinishTimeAsSeconds(ne(e[n].getElementsByTagName("StartTime"),0)),s.splits="",s.codes=[];const i=e[n].getElementsByTagName("SplitTime");this.extractIOFV3Splits(i,s);const l=this.getStartFinishTimeAsSeconds(ne(e[n].getElementsByTagName("FinishTime"),0));l>0?s.splits+=l-s.starttime:s.splits+=0}}extractIOFV3Splits(e,s){let n=[];for(let i=0;i<e.length;i+=1)e[i].attributes.length===0?(s.splits+=ne(e[i].getElementsByTagName("Time"),0),n.push(ne(e[i].getElementsByTagName("ControlCode"),"X"+i)),s.splits+=";"):e[i].getAttribute("status")==="Missing"&&(s.splits+="0",n.push(ne(e[i].getElementsByTagName("ControlCode"),"X"+i)),s.splits+=";");s.codes=n,s.controls=s.codes.length}getClub(e){return e.length>0&&e[0].getElementsByTagName("Name")[0]?e[0].getElementsByTagName("Name")[0].textContent:""}getID(e,s){if(e.length>0){let n=e[0].textContent;return n.replace(/[\n\r]/g,""),n.trim()}return s}getStartFinishTimeAsSeconds(e){return e.length>=19?ve(e.substr(11,8)):0}getTotalTimeAsSeconds(e){if(e.length>0&&e[0].textContent){const s=parseInt(e[0].textContent,10);return _(s)}return"00:00"}processIOFV3Results(e){try{const s=e.getElementsByTagName("ClassResult");for(let n=0;n<s.length;n+=1){const l=s[n].getElementsByTagName("Class")[0].getElementsByTagName("Name")[0].textContent,r=s[n].getElementsByTagName("PersonResult");for(let o=0;o<r.length;o+=1){let f={};f.course=l;const y=r[o].getElementsByTagName("Given")[0].textContent+" "+r[o].getElementsByTagName("Family")[0].textContent;f.name=y.replace(/[\n\r]/g,"").trim(),f.dbid=this.getID(r[o].getElementsByTagName("Id"),o),f.club=this.getClub(r[o].getElementsByTagName("Organisation"));const u=r[o].getElementsByTagName("Result");this.extractIOFV3Results(u,f),f.status!=="DidNotStart"&&this.results.push(f)}}}catch(s){this.valid=!1,I("XML parse error","Error processing XML file. Error is : "+s.message);return}}}class Bl{constructor(e,s){this.results=[],this.resultCourses=[],this.valid=!0;const n=this.processResults(e,s);return this.results=n.results,this.valid=n.valid,this.getCoursesFromResults(),{results:this.results,resultCourses:this.resultCourses,valid:this.valid}}getCoursesFromResults(){for(let e=0;e<this.results.length;e+=1){let s=!1;for(let n=0;n<this.resultCourses.length;n+=1)if(this.resultCourses[n].course===this.results[e].course){s=!0;break}s||this.resultCourses.push({course:this.results[e].course,courseid:h.DO_NOT_SAVE_COURSE})}}processResults(e,s){switch(s){case"CSV":return new Dl(e.target.result);case"XML":return this.processResultsXML(e.target.result);default:return I("File type error","Results file type is not recognised. Please select a valid file."),{results:[],valid:!1}}}processResultsXML(e){let s="",n;try{if(n=new DOMParser().parseFromString(e,"text/xml"),n.getElementsByTagName("ResultList").length===0)return I("XML file error","File is not a valid XML results file. ResultList element missing."),{results:[],valid:!1};s=ds(n.getElementsByTagName("IOFVersion"),"version",""),s===""&&(s=ds(n.getElementsByTagName("ResultList"),"iofVersion",""))}catch{return I("XML file error","File is not a valid XML results file."),{results:[],valid:!1}}switch(s){case"2.0.3":return new Ll(n);case"3.0":return new wl(n);default:return I("XML file error","Invalid IOF file format. Version "+s+" not supported."),{results:[],valid:!1}}}}class Al{constructor(e){this.x="",this.y=e,this.name=null,this.password=null}setDetails(e,s){const n=/...../;this.name=document.getElementById(e).value;const i=n.test(this.name);this.password=document.getElementById(s).value;const l=n.test(this.password);return i&&l}alterString(e,s){let n="";for(let i=0;i<e.length;i+=1)n+=e.charAt(i)+s.charAt(i);return n}encodeUser(){return{x:this.alterString(this.name+this.password,this.y),y:this.y}}}let se=null,K=new Xn,Ss=new kl,xe=null,He=null,st=!1,gt=!0,S=null,L=[],te=[],Wt=!1,de=!1,Nt=!1,mt=!1,Ke=!1,re={},M=[],be=[],Z=[],Lt,_t,Ts="";const us=["UTF-8","ISO-8859-1","windows-1251"];let wt=[],Xe=0,hs=!1,pt=!1,Cs=!1,Y={x:null,y:null},ge=[],j={height:0,width:0},Ae=new fe(0),Vn=new fe(0),nt=null,Ee=[],ks=null,jt=null;const Un="e.g. 1|1|6,60|15,60";function Rl(t,e){let s;S.controls.length===0?s="S"+(S.controls.length+1):s="X"+(S.controls.length+1),S.addControl(s,t,e),S.displayAllControls(),re.codes.push(s),re.x.push(t),re.y.push(e)}function Ml(t,e,s){if(pt||s===h.RIGHT_CLICK)a.translate(e.x-t.x,e.y-t.y);else if(mt=!0,Y.x!==null){const n=(e.x-Y.x)/(t.x-Y.x),i=(e.y-Y.y)/(t.y-Y.y);if(isFinite(n)&&isFinite(i))for(let l=0;l<S.controls.length;l+=1){const r=S.controls[l].oldX-Y.x,o=S.controls[l].oldY-Y.y;S.controls[l].x=r*n+Y.x,S.controls[l].y=o*i+Y.y}}else{const n=e.x-t.x,i=e.y-t.y;for(let l=0;l<S.controls.length;l+=1)S.controls[l].x=S.controls[l].oldX+n,S.controls[l].y=S.controls[l].oldY+i}}function Nl(t){const e=Ur(t.target.result);if(e===0||hs){Ar(t);return}if(wt[Xe]=e,Xe+=1,Xe===us.length){let s=99999;for(let n=0;n<us.length;n+=1)s>wt[n]&&(Xe=n,s=wt[n]);hs=!0}Jn()}function _l(){let t={};t.body="Are you sure you want to add this map?",t.title="Confirm new map",t.classes="rg2-confirm-add-map-dialog",t.doText="Add map",t.onDo=zl,ye(t)}function Pl(t){t.preventDefault();const e=zr();if(e!=="OK"){I("Event set-up incomplete",e+" Please enter all necessary information and make sure controls are aligned before creating the event.");return}let s={};s.body="Are you sure you want to create this event?",s.title="Confirm event creation",s.classes="rg2-confirm-create-event-dialog",s.doText="Create event",s.onDo=Ul,ye(s)}function Fl(){let t={};t.body="This event will be deleted. Are you sure?",t.title="Confirm event delete",t.classes="rg2-confirm-delete-event-dialog",t.doText="Delete event",t.onDo=Gl,ye(t)}function Ol(){let t={};t.body="This route will be permanently deleted. Are you sure?",t.title="Confirm route delete",t.classes="rg2-confirm-route-delete-dialog",t.doText="Delete route",t.onDo=Yl,ye(t)}function $l(){const t=document.querySelectorAll(".unused-map input[type=checkbox]:checked");let e=[];for(let n of t){n.checked&&e.push(parseInt(n.dataset.mapId,10));for(let i=0;i<Ee.length;i+=1)e.indexOf(Ee[i].mapid)>-1?Ee[i].delete=!0:Ee[i].delete=!1}if(e.length===0){I("Warning","No maps selected.");return}const s={};s.body="Selected maps will be deleted. Are you sure?",s.title="Confirm map deletion",s.doText="Delete maps",s.onDo=Wl,ye(s)}function Hl(){let t={};t.body=`Are you sure you want to update ${document.getElementById("rg2-edit-event-name").value}?`,t.title="Confirm event update",t.doText="Update event",t.onDo=ql,ye(t)}function Gn(t){try{const e=Ss.getGeorefSystem(t);if(j=ke(),!Ae.valid||j.width===0||e.name==="none")throw"Do not georeference";It.defs(e.name,e.params);const s=new It.Proj(e.name),n=new It.Proj("EPSG:4326"),i=[0,j.width,j.width,0],l=[0,j.height,0,j.height];let r=[],o=[];for(let u=0;u<4;u+=1)r[u]=Ae.getLon(i[u],l[u]),o[u]=Ae.getLat(i[u],l[u]);K.xpx.length=0,K.ypx.length=0,K.lat.length=0,K.lon.length=0;let f=[];for(let u=0;u<4;u+=1){let g={};g.x=r[u],g.y=o[u],f.push(g);const v=It(s,n,f[u]);K.xpx.push(i[u]),K.ypx.push(l[u]),K.lat.push(v.y),K.lon.push(v.x)}let y={};y.C=f[0].x,y.F=f[0].y,y.A=(f[2].x-y.C)/i[2],y.B=(f[3].x-y.C)/l[3],y.D=(f[2].y-y.F)/i[2],y.E=(f[3].y-y.F)/l[3],K.worldfile=new fe(y),tn()}catch{K.worldfile=new fe(0),tn();return}}function Yn(){for(let t=0;t<S.controls.length;t+=1)S.controls[t].oldX=S.controls[t].x,S.controls[t].oldY=S.controls[t].y}function Xl(t,e){let s=-1;for(let i=0;i<L.length;i+=1)if(L[i].name===t){s=i;break}if(s===-1&&te.length>0){for(let i=0;i<te.length;i+=1)if(te[i].className===t){for(let l=0;l<L.length;l+=1)if(L[l].name===te[i].course){s=l;break}break}}let n=`<select id='rg2-alloc-${e}' class="form-control form-control-sm">`;n+=`<option value="${h.DO_NOT_SAVE_COURSE}"${s===-1?" selected":""}>Do not save</option>`;for(let i=0;i<L.length;i+=1)n+=`<option value="${i}"${s===i?" selected":""}>${qn(L[i].name)}</option>`;return n+="</select >",n}function Ds(){if(!gt){Z.length=0;for(let t=0;t<L.length;t+=1)Z.push({courseid:L[t].courseid,course:L[t].name})}}function qt(){let t="";if(L.length&&Z.length){t='<div class="fw-bold">Results</div><div class="fw-bold">Course</div>';for(let e=0;e<Z.length;e+=1)t+=`<div>${Z[e].course}</div>`,t+=`<div>${Xl(Z[e].course,e)}</div>`;document.getElementById("rg2-course-allocations").innerHTML=t}}function Wn(t,e){let s={};s.body=e,s.title=t,s.doText="Ok",s.onDo=()=>{},ye(s,!1)}function jn(t){let e="<div class='title'>ID</div><div class='title'>Name</div><div><i class='bi-trash'></i></div>";if(t.length===0)e+="<div></div><div>None found.</div><div></div>",document.getElementById("btn-delete-unused-maps").setAttribute("disabled","");else{for(let s=0;s<t.length;s+=1)e+="<div>"+t[s].mapid+"</div>",e+="<div>"+t[s].name+"</div>",e+="<div class='unused-map'><input type='checkbox' data-map-id="+t[s].mapid+"></div>";document.getElementById("btn-delete-unused-maps").removeAttribute("disabled")}document.getElementById("rg2-unused-maps").innerHTML=e}function Vl(){const t={type:"addmap"};K.localworldfile=Ae;const e={...K,...se.encodeUser()};pe(JSON.stringify(e),t,yr,"Map save failed",De)}function Ul(){const t={...sr(),...se.encodeUser()},e={type:"createevent"};pe(JSON.stringify(t),e,fr,"Event creation failed",De)}function Gl(){const e={type:"deleteevent",id:document.getElementById("rg2-edit-event-selected").value};pe(JSON.stringify(se.encodeUser()),e,gr,"Event deletion failed",De)}function Yl(){const t=document.getElementById("rg2-edit-event-selected").value,e=document.getElementById("rg2-route-selected").value,s={type:"deleteroute",id:t,routeid:e};pe(JSON.stringify(se.encodeUser()),s,xr,"Route delete failed",De)}function Wl(){let t=se.encodeUser();t.maps=Ee.filter(s=>s.delete===!0).map(s=>s.mapid);const e={type:"deleteunusedmaps"};pe(JSON.stringify(t),e,Ir,"Map deletion failed",De)}function Ls(){Vt({type:"maps"},Er,"Events request failed")}function jl(){const t={type:"login"};pe(JSON.stringify(se.encodeUser()),t,pr,"Login failed",De)}function ql(){const t=document.getElementById("rg2-edit-event-selected").value;let e=se.encodeUser();e.comments=document.getElementById("rg2-edit-event-comments").value,e.locked=document.getElementById("chk-edit-read-only").checked,e.name=document.getElementById("rg2-edit-event-name").value,e.type=document.getElementById("rg2-edit-event-level").value,e.eventdate=jt.getDate("yyyy-mm-dd"),e.club=document.getElementById("rg2-edit-club-name").value;let s=document.getElementById("rg2-edit-exclude").value.trim();s===Un&&(s=""),e.exclude=s;const n={type:"editevent",id:t};pe(JSON.stringify(e),n,mr,"Event update failed",De)}function zl(){const t=se.encodeUser();let e=new FormData;e.append(Lt.name,Lt),e.append("name",Lt.name),e.append("x",t.x),e.append("y",t.y),pe(e,{type:"uploadmapfile",headers:{"Content-Type":"multipart/form-data"}},vr,"Map upload failed",De)}function Kl(){if(de&&S.controls.length>0){S.drawControls(!0);const t=ft();Y.x!==null&&(a.lineWidth=t.overprintWidth,a.strokeStyle=h.HANDLE_COLOUR,a.fillStyle=h.HANDLE_COLOUR,a.globalAlpha=1,a.beginPath(),a.arc(Y.x,Y.y,h.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),a.fill(),a.beginPath(),a.arc(Y.x,Y.y,2*h.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),a.stroke())}}function Zl(){document.querySelector("#rg2-info-panel-tab-headers li").remove(),document.querySelector("#rg2-manage-login-tab-body").remove(),document.getElementById(h.TAB_CREATE).classList.remove("d-none"),document.getElementById(h.TAB_CREATE).click(),document.getElementById(h.TAB_EDIT).classList.remove("d-none"),document.getElementById(h.TAB_MAP).classList.remove("d-none"),document.getElementById(h.TAB_DELETE_MAP).classList.remove("d-none"),Ls(),Pr(),document.getElementById("rg2-select-event-level").innerHTML=Qs(),document.getElementById("rg2-edit-event-level").innerHTML=Qs(),document.getElementById("rg2-georef-type").innerHTML=Ss.getGeorefDropdown(),document.getElementById("rg2-select-map").addEventListener("change",t=>{xe=parseInt(t.target.value,10),xe!==h.INVALID_MAP_ID?Ws(rg2Config.maps_url+"/"+ge[xe].mapfilename):(de=!1,j.width=0,j.height=0)}),ks=new qs(document.getElementById("rg2-select-event-date"),{buttonClass:"btn",autohide:!0,format:"yyyy-mm-dd"}),jt=new qs(document.getElementById("rg2-edit-event-date"),{buttonClass:"btn",autohide:!0,format:"yyyy-mm-dd"}),document.getElementById("rg2-map-name").addEventListener("change",function(){Hr()}),document.getElementById("rg2-new-course-name").addEventListener("change",function(){Or()}),document.getElementById("rg2-edit-event-selected").addEventListener("change",t=>{yt(parseInt(t.target.value,10))}),document.getElementById("rg2-georef-type").addEventListener("change",t=>{$r(parseInt(t.target.value,10))})}function qn(t){let e="";if(te&&te.length>0&&Wt)for(let s=0;s<te.length;s+=1){const n=te[s].course;let i="";n===t&&(e!==""&&(e+=", "),i=te[s].className,i=i.replace(/ /g,""),i=i.replace(/-/g,""),e+=i)}return e!==""?t+": "+e:t}function Jl(){if(Wt)for(let t=0;t<L.length;t+=1)L[t].name=qn(L[t].name)}function Ql(){const t=parseInt(document.getElementById("rg2-edit-event-selected").value,10),e=Os(t);document.getElementById("rg2-edit-event-name").value=ae(e.name),document.getElementById("rg2-edit-club-name").value=ae(e.club),jt.setDate(e.date),document.getElementById("rg2-edit-event-level").value=e.rawtype,document.getElementById("rg2-edit-event-comments").value=ae(e.comment),dt()?document.getElementById("rg2-exclude-info").classList.add("d-none"):(document.getElementById("rg2-edit-exclude").value=e.exclude,document.getElementById("rg2-exclude-info").classList.remove("d-none")),document.getElementById("chk-edit-read-only").checked=e.locked,document.getElementById("rg2-route-selected").innerHTML=ur(e.id)}function er(t){document.getElementById("rg2-edit-event-selected").innerHTML=ar(t),ge.length>0&&(zn(ge),jn(Ee))}function tr(){be.length=0;let t;for(let e=0;e<M.length;e+=1){let s=M[e].codes;for(let n=0;n<L.length;n+=1)if(L[n].courseid===M[e].courseid){t=L[n];break}s.unshift(t.codes[0]),s.push(t.codes[t.codes.length-1]),M[e].variantid=hr(M[e].codes,M[e].courseid)}}function zn(t){Ee.length=0;for(let e=0;e<t.length;e+=1)if(!cd(t[e].mapid)){const s={};s.mapid=t[e].mapid,s.name=t[e].name,s.name===""&&(s.name="(None)"),s.delete=!1,Ee.push(s)}}function ws(){let t=!1;if(de&&S.controls.length>0){const e=nr();if(Nt&&(e.maxX<0||e.minX>j.width||e.minY>j.height||e.maxY<0?I("Course file problem","Your course file does not match the map co-ordinates. Please check you have selected the correct file."):t=!0),t)pt=!0,mt=!0,document.getElementById("chk-move-map-and-controls").checked=!0;else{let s=.8;for(let n=0;n<S.controls.length;n+=1)S.controls[n].x=(S.controls[n].x-e.minX)*(j.width/e.xRange)*s+j.width*(1-s)*.5,S.controls[n].y=j.height-(S.controls[n].y-e.minY)*(j.height/e.yRange)*s-j.height*(1-s)*.5}Yn(),S.displayAllControls()}}function sr(){let t=se.encodeUser();if(t.name=document.getElementById("rg2-event-name").value,t.mapid=ge[xe].mapid,t.eventdate=ks.getDate("yyyy-mm-dd"),t.comments=document.getElementById("rg2-enter-event-comments").value,t.locked=document.getElementById("chk-read-only").checked,t.club=document.getElementById("rg2-select-club-name").value,gt?st?t.format=h.FORMAT_SCORE_EVENT:t.format=h.FORMAT_NORMAL:st?t.format=h.FORMAT_SCORE_EVENT_NO_RESULTS:t.format=h.FORMAT_NORMAL_NO_RESULTS,t.level=document.getElementById("rg2-select-event-level").value,Ke&&(L.push(re),Ds()),Fr(),Lr(),Jl(),_r(),st&&(tr(),t.variants=be.slice(0)),t.courses=L.slice(0),Cs?t.results=M.slice(0).sort(Xr):t.results=M.slice(0),t.format===h.FORMAT_NORMAL)for(let e=0;e<t.results.length;e+=1)(t.results[e].splits.match(/;/g)||[]).length===ir(t.courses,t.results[e].courseid)+1&&(t.results[e].splits=t.results[e].splits.substring(0,t.results[e].splits.lastIndexOf(";")));for(let e=0;e<t.results.length;e+=1)delete t.results[e].codes,delete t.results[e].chipid,delete t.results[e].club;return t}function nr(){let t={};t.minX=S.controls[0].x,t.maxX=S.controls[0].x,t.minY=S.controls[0].y,t.maxY=S.controls[0].y;for(let e=1;e<S.controls.length;e+=1)t.maxX=Math.max(t.maxX,S.controls[e].x),t.maxY=Math.max(t.maxY,S.controls[e].y),t.minX=Math.min(t.minX,S.controls[e].x),t.minY=Math.min(t.minY,S.controls[e].y);return t.xRange=t.maxX-t.minX,t.yRange=t.maxY-t.minY,t}function ir(t,e){for(let s=0;s<t.length;s+=1)if(t[s].courseid===e)return t[s].controlcount;return 0}function Kn(t){let e={x:0,y:0};for(let s=0;s<S.controls.length;s+=1)if(S.controls[s].code===t)return e.x=Math.round(S.controls[s].x),e.y=Math.round(S.controls[s].y),e;return e}function lr(t){for(let e=0;e<Z.length;e+=1)if(Z[e].course===t)return Z[e].courseid;return 0}function rr(){let t='<div class="new-courses-table">';if(L.length){t+=`<div>${p("Course")}</div><div>${p("Name")}</div><div>${p("Controls")}</div>`;for(let e=0;e<L.length;e+=1)t+=`<div>${e+1}</div><div>${L[e].name}</div><div>${L[e].codes.length-2}</div>`}return t+="</div>",t}function or(t){for(let e=0;e<L.length;e+=1)if(L[e].courseid===t)return L[e].name;return 0}function ar(t){let e=Ce(null,"No event selected",!0);for(let s=t.length-1;s>-1;s-=1)e+=Ce(t[s].kartatid,t[s].kartatid+": "+t[s].date+": "+ae(t[s].name));return e}function Qs(){let t="";const e=["Select level","Training","Local","Regional","National","International"],s=["X","T","L","R","N","I"];for(let n=0;n<e.length;n+=1)t+=Ce(s[n],e[n],n===0);return t}function dr(t){let e=Ce(h.INVALID_MAP_ID,"Select map",!0);for(let s=t.length-1;s>-1;s-=1)e+=Ce(s,t[s].mapid+": "+ae(t[s].name));return e}function cr(){let t="";if(M.length){t='<div class="new-results-table">';let e=0,s=null;for(let n=0;n<M.length;n+=1)M[n].course!==s&&(s!==null&&(t+=`<div>${e}</div>`,e=0),t+=`<div>${M[n].course}</div><div>${M[n].name}</div><div>${M[n].time}</div>`,s=M[n].course),e+=1;t+=`<div>${e}</div></div>`}else t="No valid results found.";return t}function ur(t){const e=Io();let s=Ce("undefined","Select route");for(let n=0;n<e.length;n+=1)s+=Ce(e[n].resultid,e[n].resultid+": "+ae(e[n].name)+" on "+ae(e[n].coursename));return s}function hr(t,e){let s=[],n=[],i=0;for(let l=0;l<be.length;l+=1)if(be[l].codes.length===t.length){let r=!0;for(let o=0;o<t.length;o+=1)if(be[l].codes[o]!==t[o]){r=!1;break}if(r){i=l+1;break}}if(i===0){i=be.length+1;for(let l=0;l<t.length;l+=1){const r=Kn(t[l]);s.push(r.x),n.push(r.y)}be.push({x:s,y:n,id:i,courseid:e,name:"Variant "+i,codes:t})}return i}function fr(t){t.ok?(I("Event created",document.getElementById("rg2-event-name").value+" has been added with id "+t.newid+"."),window.open(rg2Config.api_url.replace("rg2api.php","")+"#"+t.newid),Je(),yt()):I("Save failed",t.status_msg+" Failed to create event. Please try again.")}function gr(t){t.ok?(I("Event deleted","Event has been deleted."),Je(),yt(),document.getElementById("rg2-edit-event-selected").replaceChildren()):I("Delete failed",t.status_msg+". Event delete failed. Please try again.")}function mr(t,e){t.ok?(I("Event updated","Event "+e+" has been updated."),Jt(null),$s(),Je(),yt()):I("Update failed",t.status_msg+". Event update failed. Please try again.")}function De(t){se.y=t}function pr(t){t.ok?Zl():I("Login failed","User name or password incorrect. Please try again.")}function yr(t){t.ok?(I("Map added",t.name+" has been added with id "+t.newid+"."),Ls()):I("Save failed",t.status_msg+". Failed to save map. Please try again.")}function vr(t){t.ok?Vl():I("Upload failed",t.status_msg+". Failed to upload map. Please try again.")}function Er(t){ge.length=0;for(let e=0;e<t.maps.length;e+=1)ge.push(new Xn(t.maps[e]));document.getElementById("rg2-select-map").innerHTML=dr(ge),zn(ge),jn(Ee)}function xr(t){t.ok?(I("Route deleted","Route has been deleted."),Jt(null),$s(),Je(),yt()):I("Delete failed",t.status_msg+". Delete failed. Please try again.")}function Ir(t){t.ok?I("Maps deleted","Selected maps have been deleted."):I("Delete failed",t.status_msg+". Delete failed. Please try again."),Ls()}function en(t){return t===0||t==="0"||t==="0:00"||t==="00:00"}function Zn(){S=new bs,xe=h.INVALID_MAP_ID,He=h.FORMAT_NORMAL,st=!1,gt=!0,L=[],te=[],Wt=!1,de=!1,Nt=!1,mt=!1,Ke=!1,re={},M=[],be=[],Z=[],j={height:0,width:0},_t=void 0,Ts="",pt=!1,Cs=!1,Y={x:null,y:null}}function br(){Xe=0,wt=[],hs=!1}function Sr(t){se=new Al(t),nt=xs.map("rg2-world-file-map"),Zn(),Tr(),document.getElementById("rg2-manager-login-form").addEventListener("submit",e=>{e.preventDefault(),se.setDetails("rg2-user-name","rg2-password")?jl():I("Login failed","Please enter user name and password of at least five characters")})}function Tr(){xs.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(nt),document.getElementById("rg2-world-file-map-container").classList.remove("d-none")}function Cr(){de&&S.controls.length>0&&Yn()}function kr(){de=!0,xe!==h.INVALID_MAP_ID&&(Ae=ge[xe].localworldfile,Vn=ge[xe].worldfile),j=ke(),ws(),b()}function Dr(t,e){if(Ke){Rl(t,e),mt=!0;return}de&&S.controls.length>0&&(Y.x===null?Y={x:t,y:e}:Y={x:null,y:null})}function Lr(){let t=[],e=1;for(let s=0;s<Z.length;s+=1){let n;if(Ke)n=0;else{const i=document.getElementById("rg2-alloc-"+s);i&&(n=parseInt(i.value,10))}n!==void 0&&n!==h.DO_NOT_SAVE_COURSE&&(L[n].courseid===0?(L[n].courseid=e,t.push(L[n]),Z[s].courseid=e,e+=1):Z[s].courseid=L[n].courseid)}L=t}function wr(t){Nt=!1,pt=!1,document.getElementById("chk-move-map-and-controls").checked=!1,Y={x:null,y:null},S.deleteAllControls();const e=new Cl(t,Vn,Ae);L=e.courses,L.length>0&&(S=e.newcontrols,te=e.mapping,te.length>0?document.getElementById("chk-enrich-course-names").classList.remove("d-none"):document.getElementById("chk-enrich-course-names").classList.add("d-none"),Nt=e.georeferenced,Wn("Course details",rr()),Ds(),qt(),ws()),b()}function Br(t){Ws(t.target.result,!0),document.getElementById("rg2-load-map-file").classList.add("is-valid"),de=!0,j=ke(),ws(),b(),document.getElementById("btn-add-map").removeAttribute("disabled")}function Ar(t){const e=new Bl(t,Ts);M=e.results,M.length>0&&(Z=e.resultCourses,Wn("Result details",cr()),qt())}function Rr(t){let e=new FileReader;e.onerror=function(){I("Course file error","The selected course file could not be read.")},e.onload=function(s){wr(s)},e.readAsText(t.target.files[0])}function Mr(t){const e=new FileReader;try{e.readAsText(t.target.files[0])}catch{I("File read error","Failed to open selected world file.");return}e.onerror=function(){I("World file error","The selected world file could not be read.")},e.onload=function(s){const i=s.target.result.split(/[\r\n]+/g);Ae=new fe({A:i[0],B:i[2],C:i[4],D:i[1],E:i[3],F:i[5]});const l=Ss.getDefaultValue();document.getElementById("rg2-georef-type").value=l,Gn(l)}}function Nr(t){const e=new FileReader;e.onload=function(n){Br(n)};const s=t.target.files[0].name.substr(-3,3).toUpperCase();s==="JPG"||s==="GIF"?(Lt=t.target.files[0],e.readAsDataURL(t.target.files[0])):I("File type error",t.target.files[0].name+" is not recognised. Only .jpg and .gif files are supported at present.")}function Jn(){let t=new FileReader;t.onerror=function(){I("Results file error","The selected results file could not be read.")},t.onload=function(e){Nl(e)},He=_t.name.substr(-3,3).toUpperCase(),He==="XML"||He==="CSV"?(Ts=He,t.readAsText(_t,us[Xe])):I("File type error","Results file type is not recognised. Please select a valid file.")}function _r(){let t=[];for(let e=0;e<M.length;e+=1){const s=lr(M[e].course);s!==h.DO_NOT_SAVE_COURSE&&(M[e].courseid=s,M[e].course=or(s),M[e].variantid="",t.push(M[e]))}M=t}function Pr(){document.getElementById("btn-create-event").addEventListener("click",s=>{Pl(s)}),document.getElementById("btn-update-event").addEventListener("click",s=>{Hl()}),document.getElementById("btn-delete-route").addEventListener("click",s=>{Ol()}),document.getElementById("btn-delete-event").addEventListener("click",s=>{Fl()}),document.getElementById("btn-add-map").addEventListener("click",s=>{_l()}),document.getElementById("btn-delete-unused-maps").addEventListener("click",s=>{$l()}),document.getElementById("btn-draw-courses").addEventListener("click",s=>{Vr()}),document.getElementById("rg2-load-georef-file").addEventListener("input",s=>{Mr(s)}),document.getElementById("rg2-load-map-file").addEventListener("input",s=>{Kr(s.target.files[0]),Nr(s)});const t=document.getElementById("rg2-load-results-file");t.addEventListener("click",s=>{de||(I("No map loaded","Please load a map file before adding results."),s.preventDefault())}),t.addEventListener("change",s=>{_t=s.target.files[0],br(),Jn()}),document.getElementById("chk-move-map-and-controls").addEventListener("click",s=>{Yr(s.target.checked)}),document.getElementById("chk-no-results").addEventListener("click",s=>{Wr(s.target.checked)}),document.getElementById("chk-score-event").addEventListener("click",s=>{jr(s.target.checked)}),document.getElementById("chk-enrich-course-names").addEventListener("click",s=>{Gr(s.target.checked)}),document.getElementById("chk-sort-results").addEventListener("click",s=>{qr(s.target.checked)});const e=document.getElementById("rg2-load-course-file");e.addEventListener("click",s=>{de||(I("No map loaded","Please load a map file before adding courses."),s.preventDefault())}),e.addEventListener("change",s=>{Rr(s)})}function Fr(){for(let t=0;t<L.length;t+=1)for(let e=0;e<L[t].codes.length;e+=1){const s=Kn(L[t].codes[e]);L[t].x[e]=s.x,L[t].y[e]=s.y}}function Or(){const t=document.getElementById("rg2-new-course-name").value;t&&(re.name=t)}function yt(t){t?vt(t):(Zn(),document.getElementById("rg2-edit-event-name").value="",document.getElementById("rg2-edit-club-name").value="",jt.setDate(""),document.getElementById("rg2-edit-event-level").value="",document.getElementById("rg2-edit-event-comments").value="",document.getElementById("rg2-edit-exclude").value=Un,document.getElementById("rg2-route-selected").replaceChildren(),document.getElementById("chk-edit-read-only").checked=!1,document.getElementById("rg2-course-allocations").innerHTML="")}function $r(t){t!==0&&Gn(t)}function Hr(){K.name=document.getElementById("rg2-map-name").value,hl("rg2-map-name",t=>/./.test(t))}function Xr(t,e){return t.courseid!==e.courseid?t.courseid-e.courseid:t.position!==""&&e.position!==""?t.position-e.position:t.position===""&&e.position!==""?1:t.position!==""&&e.position===""?-1:en(t.time)&&en(e.time)?t.name-e.name:t.time-e.time}function Vr(){de?(Ke=!0,L.length=0,S.deleteAllControls(),re.name="Course",re.x=[],re.y=[],re.codes=[],re.courseid=0,document.getElementById("rg2-new-course-name").value,document.getElementById("rg2-draw-courses").classList.remove("d-none")):I("No map selected","Please load a map before drawing courses")}function Ur(t){let e=0;for(let s=0;s<t.length;s+=1)t.charCodeAt(s)===65533&&(e+=1);return e}function Gr(t){Wt=t,qt()}function Yr(t){pt=t}function Wr(t){gt=!t,Ds(),qt()}function jr(t){st=t}function qr(t){Cs=t}function tn(){const t=K.lon,e=K.lat;let s=[];[3,1,2,0].forEach(function(l){s.push([e[l],t[l]])});const i=xs.polygon(s,{color:"red"});i.addTo(nt),document.getElementById("rg2-world-file-map-container").classList.remove("d-none"),nt.invalidateSize(),nt.fitBounds(i.getBounds())}function zr(){return document.getElementById("rg2-event-name").value===""?"Event name is not valid.":xe===h.INVALID_MAP_ID?"No map selected.":document.getElementById("rg2-select-club-name").value===""?"Club name is not valid.":ks.getDate("yyyy-mm-dd")===void 0?"Date is not valid.":document.getElementById("rg2-select-event-level").value==="X"?"Event level is not valid.":He?L.length===0&&!Ke?"No course information. Check your course XML file.":M.length===0&&gt?"No results information. Check your results file.":mt?"OK":"Controls have not been adjusted on the map.":"Event format is not valid."}function Kr(t){let e=new FileReader;e.onload=function(s){let n=new Image;n.src=s.target.result,n.onload=function(){const i=Math.round(t.size/1024/1024);if(i>h.FILE_SIZE_WARNING||n.height>h.PIXEL_SIZE_WARNING||n.width>h.PIXEL_SIZE_WARNING){let l="The uploaded map file is "+i+"MB ("+n.width;l+=" x "+n.height+"px). It is recommended that you use maps under "+h.FILE_SIZE_WARNING,l+="MB with a maximum dimension of "+h.PIXEL_SIZE_WARNING+"px. Please see the ",l+="<a href='https://github.com/Maprunner/rg2/wiki/Map-files'>RG2 wiki</a> for ",l+="guidance on how to create map files.",I("Oversized map upload",l)}}},e.readAsDataURL(t)}class sn{constructor(e,s,n,i,l){this.resultid=e.resultid,this.rawid=this.resultid%h.GPS_RESULT_OFFSET,this.isScoreEvent=s,this.name=ae(e.name).trim(),this.initials=this.getInitials(this.name),this.starttime=e.starttime,this.time=e.time,(this.time==="00"||this.time==="0")&&(this.time=""),this.timeInSecs=e.secs,this.position=e.position,this.status=e.status,this.canDelete=!1,this.showResult=!0,this.token=0,e.comments?this.comments=ae(e.comments):this.comments="",this.coursename=e.coursename,this.coursename===""&&(this.coursename=e.courseid.toString()),this.courseid=e.courseid,this.variant=e.variant,this.splits=this.adjustRawSplits(e.splits),this.isScoreEvent&&(this.scorex=i,this.scorey=l,this.scorecodes=n),this.trackColour=null,this.userColour=null,this.initialiseTrack(e)}addInterpolatedTimes(e,s,n){const i=this.xysecs[e],l=this.xysecs[s]-i,r=n[e],o=n[s]-r;for(let f=e;f<=s;f+=1)this.xysecs[f]=i+Math.round((n[f]-r)*l/o)}addTrack(e){this.trackx=e.x.split(",").map(function(n){return parseInt(n,10)}),this.tracky=e.y.split(",").map(function(n){return parseInt(n,10)});for(let n=1;n<this.trackx.length;n+=1)this.trackx[n]=this.trackx[n-1]+this.trackx[n],this.tracky[n]=this.tracky[n-1]+this.tracky[n];let s;this.isGPSTrack?s=this.expandGPSTrack():this.splits.length===2?s=this.expandTrackWithNoSplits():s=this.expandNormalTrack(),s&&wd(this.courseid)}adjustRawSplits(e){e.splice(0,0,0);for(let s=1;s<e.length;s+=1)e[s]<=0&&(e[s]=e[s-1]);return e[e.length-1]=Math.max(this.timeInSecs,e[e.length-2]),e}calculateTotalTrackLength(){let e=[];e[0]=0;let s=this.trackx[0],n=this.tracky[0];for(let i=1;i<this.trackx.length;i+=1)e[i]=e[i-1]+Math.round(J(this.trackx[i],this.tracky[i],s,n)),s=this.trackx[i],n=this.tracky[i];return e}calculateTrackTimes(e){let s=[];s[0]=0;let n=this.getNextValidControl(0),i=e.x[n],l=e.y[n],r=0,o=this.trackx[0],f=this.tracky[0],y=0,u=0,g=0;for(let v=1;v<this.trackx.length;v+=1)if(y=this.trackx[v],u=this.tracky[v],r+=J(y,u,o,f),s[v]=Math.round(r),o=y,f=u,i===y&&l===u){if(this.xysecs[v]=this.splits[n],this.addInterpolatedTimes(g,v,s),g=v,n=this.getNextValidControl(n),n===e.x.length){this.hasValidTrack=!0;break}i=e.x[n],l=e.y[n]}}drawScoreCourse(){if(this.displayScoreCourse&&this.scorex.length>1){const e=ft();a.globalAlpha=h.FULL_INTENSITY;let s=Pe(this.scorex[0],this.scorey[0],this.scorex[1],this.scorey[1]);z.drawStart(this.scorex[0],this.scorey[0],"",s,e),s=[];for(let i=0;i<this.scorex.length-1;i+=1)s[i]=Pe(this.scorex[i],this.scorey[i],this.scorex[i+1],this.scorey[i+1]);const n={from:0,to:this.scorex.length};pd({x:this.scorex,y:this.scorey},s,this.courseid,e,n);for(let i=1;i<this.scorex.length-1;i+=1)z.drawSingleControl(this.scorex[i],this.scorey[i],i,Math.PI*.25,e);z.drawFinish(this.scorex[this.scorex.length-1],this.scorey[this.scorey.length-1],"",e)}}drawTrack(e){try{let s,n,i;if(this.displayTrack){this.isGPSTrack&&D.showGPSSpeed&&this.speedColour.length===0&&this.setSpeedColours();let l=0,r=this.xysecs.length;const o=this.splits[e.filterFrom],f=this.splits[e.filterTo];for(let y=0;y<this.xysecs.length;y+=1)if(this.xysecs[y]>=o){l=y;break}for(let y=this.xysecs.length-1;y>=0;y-=1)if(this.xysecs[y]<=f){r=y;break}a.lineWidth=D.routeWidth,a.strokeStyle=this.trackColour,a.globalAlpha=D.perCentRouteIntensity/100,a.fillStyle=this.trackColour,a.font="10pt Arial",a.textAlign="left",a.beginPath(),a.moveTo(this.trackx[l],this.tracky[l]),s=this.trackx[l],n=this.tracky[l],i=0;for(let y=l+1;y<=r;y+=1)a.lineTo(this.trackx[y],this.tracky[y]),this.trackx[y]===s&&this.tracky[y]===n?i+=1:i>0&&((!this.isGPSTrack||this.isGPSTrack&&D.showThreeSeconds)&&a.fillText("+"+3*i,s+5,n+5),i=0),s=this.trackx[y],n=this.tracky[y],this.isGPSTrack&&D.showGPSSpeed&&(a.strokeStyle=this.speedColour[y],a.stroke(),a.beginPath(),a.moveTo(s,n));a.stroke()}}catch{return}}expandGPSTrack(){for(let e=0;e<this.trackx.length;e+=1)this.xysecs[e]=3*e;return this.speedColour.length=0,this.hasValidTrack=!0,this.hasValidTrack}expandNormalTrack(){this.xysecs.length=0,this.xysecs[0]=0;let e={};return this.isScoreEvent?(e.x=this.scorex,e.y=this.scorey):e=me(this.courseid),this.calculateTrackTimes(e),this.isScoreEvent&&(this.hasValidTrack=!0),this.hasValidTrack}expandTrackWithNoSplits(){this.xysecs.length=0;const e=this.splits[1];let s=0;this.xysecs[0]=0;const n={};n.x=me(this.courseid).x,n.y=me(this.courseid).y;let i=1,l=n.x[i],r=n.y[i],o=n.x[n.x.length-1],f=n.y[n.y.length-1];this.trackx.push(o),this.tracky.push(f);let y=0;const u=this.calculateTotalTrackLength(),g=u[u.length-1];let v=0,k=0,O=!1;for(let N=1;N<this.trackx.length;N+=1)if(v=this.trackx[N],k=this.tracky[N],(v!==this.trackx[0]||k!==this.tracky[0])&&(O=!0),l===v&&r===k&&O){if(s=parseInt(u[N]/g*e,10),this.xysecs[N]=s,this.splits[i]=s,this.addInterpolatedTimes(y,N,u),y=N,i+=1,i===n.x.length){this.hasValidTrack=!0;break}l=n.x[i],r=n.y[i]}return this.hasValidTrack}getColour(e){let s="#";if(e===0)return"#0080ff";if(e<.5)s+="ff";else{const n=parseInt((1-e)*255*2,10);n<16&&(s+="0"),s+=n.toString(16)}if(e>=.5)s+="ff";else{const n=255-parseInt((.5-e)*255*2,10);n<16&&(s+="0"),s+=n.toString(16)}return s+="00",s}getInitials(e){if(e===null)return"??";e=e.replace(/GPS/g,"*");let s="",n=!0;for(let i=0;i<e.length;i+=1)n&&(s+=e.substr(i,1),n=!1),e.charAt(i)===" "&&(n=!0);return s}getNextValidControl(e){for(let s=e+1;s<this.splits.length;s+=1)if(this.splits[s]!==this.splits[s-1])return s;return this.splits.length}initialiseTrack(e){if(this.legpos=[],this.racepos=[],this.hasValidTrack=!1,this.displayTrack=!1,this.displayScoreCourse=!1,this.trackx=[],this.tracky=[],this.speedColour=[],this.xysecs=[],this.resultid>=h.GPS_RESULT_OFFSET){this.isGPSTrack=!0;const s=bo(this.rawid);this.time=s.time,this.splits=s.splits,this.time===h.TIME_NOT_FOUND&&(this.time=e.time)}else this.isGPSTrack=!1}mapSpeedColours(){const e=16.667/D.maxSpeed,s=16.667/D.minSpeed,n=3,i=this.speedColour.slice().sort(function(y,u){return y-u}),l=Kt();let r=0,o=0;l!==void 0?(r=n*e/l,o=n*s/l):(r=i[i.length-1],o=i[Math.floor(i.length/95)]);const f=r-o;for(let y=0;y<this.speedColour.length;y+=1){let u=Math.max(this.speedColour[y],o);u=Math.min(u,r),this.speedColour[y]=this.getColour((u-o)/f)}}setSpeedColours(){this.speedColour[0]=0;let e=0;for(let s=1;s<this.trackx.length;s+=1){const n=J(this.trackx[s],this.tracky[s],this.trackx[s-1],this.tracky[s-1]);this.speedColour[s]=(n+e)/2,e=n}this.mapSpeedColours()}setTrackDisplay(e){this.hasValidTrack&&(e?this.userColour!==null?this.trackColour=this.userColour:this.trackColour=On():this.trackColour=null,this.displayTrack=e)}}let d=[];function Zr(t,e){d.length=0;let s=[],n=[],i=[];if(e)for(let l=0;l<t.length;l+=1){let r=t[l].variant;s[r]===void 0&&(s[r]=t[l].scorecodes,n[r]=t[l].scorex,i[r]=t[l].scorey)}for(let l=0;l<t.length;l+=1)if(Ad(t[l].courseid)){t[l].resultid>h.GPS_RESULT_OFFSET&&t[l].coursename===""&&(t[l].coursename=me(t[l].courseid).name);let r;if(e){let o=t[l].variant;r=new sn(t[l],e,s[o],n[o],i[o])}else r=new sn(t[l],e);d.push(r)}Ao(),Bo(),No(),So(),Do(e)}function Jr(t){for(let e=0;e<t.length;e+=1){let s=t[e].id,n=0;for(;n<d.length;){if(s===d[n].resultid){d[n].addTrack(t[e]);break}n+=1}}}function nn(t){for(let e=0;e<d.length;e+=1)if(d[e].courseid===t&&!Xi(e))return!1;return!0}function ln(){for(let t=0;t<d.length;t+=1)if(d[t].hasValidTrack&&!d[t].displayTrack)return!1;return!0}function Qr(t){for(let e=0;e<d.length;e+=1)if(d[e].courseid===t&&d[e].hasValidTrack&&!d[e].displayTrack)return!1;return!0}function rn(t){for(let e=0;e<d.length;e+=1)if(d[e].courseid===t&&d[e].hasValidTrack&&!Xi(e))return!1;return!0}function eo(t){for(let e=0;e<d.length;e+=1)if(d[e].courseid===t&&d[e].hasValidTrack&&d[e].displayTrack)return!0;return!1}function to(t){const e=Os();let s=0;for(let n=0;n<d.length;n+=1)d[n].courseid===t&&(d[n].resultid<h.GPS_RESULT_OFFSET||e.format===h.FORMAT_NO_RESULTS||e.format===h.FORMAT_SCORE_EVENT_NO_RESULTS)&&(s+=1);return s}function Qn(t){let e=document.getElementById("rg2-select-name");if(e.innerHTML="",e.options.add(je(null,p("Select name",""))),t!==void 0){for(let s=0;s<d.length;s+=1)d[s].courseid===t&&d[s].resultid<h.GPS_RESULT_OFFSET&&e.options.add(je(d[s].resultid,d[s].time+" "+d[s].name));e.addEventListener("change",s=>{Ya(parseInt(s.target.value,10))}),e.removeAttribute("disabled")}}function so(){let t=lo();t=t.replace(/&amp;/g,"&");const e=document.getElementById("rg2-result-table");e.innerHTML=t,Mo(),si(),pa();const s=document.querySelectorAll(".resultrow");for(let n of s)n.addEventListener("dblclick",i=>{const l=parseInt(i.currentTarget.dataset.id,10);l&&vn(l)}),n.addEventListener("contextmenu",i=>{const l=parseInt(i.currentTarget.dataset.id,10);l&&vn(l)})}function no(){d.length=0}function io(t,e){d[t].displayScoreCourse=e}function on(){for(let t=0;t<d.length;t+=1){let e;d[t].isScoreEvent?e={from:0,to:d[t].scorex.length}:e=Dd(d[t].courseid),d[t].drawTrack(e),d[t].drawScoreCourse()}}function lo(){let t=[],e=[];if(d.length===0)return`<p>${p("No results available")}</p>`;let s="",n=0,i=0;To();for(let l=0;l<d.length;l+=1){const r=d[l];if(!r.showResult)continue;r.courseid!==n&&(t.length>0&&(s+=an(i,n)+"</table>",e.push(s)),i=0,t.push(mo(r)),s=`<table class='resulttable' id='table-${r.courseid}'><thead><tr><th>#</th>`,s+=`<th>${p("Name")}</th><th>${p("Time")}</th>`,s+=`<th><i class='bi-pencil'></i></th><th><i class='bi-play-fill'></i></th></tr></thead><tbody class="table-group-divider">`,n=r.courseid),s+=`<tr class="resultrow" data-id="${r.rawid}"><td>${r.position}</td>`,r.comments!==""&&r.comments!==p("Type your comment")?(r.comments=r.comments.replace(/"/g,"&quot;"),s+=`<td title="${r.comments}"><u>${dn(r,l)}</u>`):s+=`<td>${dn(r,l)}`,r.canDelete&&(s+=` <i class='deleteroute bi-trash-fill' data-resultidx=${l}></i>`),s+=`</td><td>${r.time}</td>`;let o="",f="showreplay";r.hasValidTrack&&(i+=1,o=`<input class='showtrack' data-courseid='${n}' data-id='${r.resultid}' type=checkbox name=result></input>`,f+=" showtrackreplay"),s+=`<td>${o}</td>`,s+=`<td><input class="${f}" data-courseid=${n} data-id=${r.resultid} type=checkbox name=replay></input></td></tr>`}s+=`</tbody>${an(i,n)}</table>`,e.push(s),s='<div class="accordion" id="results-accordion">';for(let l=0;l<e.length;l+=1)s+='<div class="accordion-item">',s+=`<h2 class="accordion-header d-flex" id="header-${l}">`,s+=`<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${l}" aria-expanded="true" aria-controls="collapse-${l}">`,s+=`${t[l].title}</button>${t[l].check}</h2>`,s+=`<div id="collapse-${l}" class="accordion-collapse collapse" aria-labelledby="header-${l}" data-bs-parent="#rg2-result-tab-body">`,s+=`<div class="accordion-body px-0">${e[l]}</div></div></div>`;return s+="</div>",s}function ro(t){let e=Math.floor(t/86400)+" days ";return t=t-86400*Math.floor(t/86400),e+=Math.floor(t/3600)+" hours ",t=t-3600*Math.floor(t/3600),e+=Math.floor(t/60)+" minutes ",e+=t-60*Math.floor(t/60)+" seconds",e}function oo(){let t=[],e=[],s=[],n=[];for(let i=0;i<d.length;i+=1){const l=d[i];if(l.resultid<h.GPS_RESULT_OFFSET){const r=l.courseid;t.indexOf(r)===-1&&(t.push(r),e[r]=[],s[r]=[],n[r]=[]);for(let o=0;o<l.scorecodes.length;o+=1)e[r].indexOf(l.scorecodes[o])===-1&&(e[r].push(l.scorecodes[o]),s[r].push(l.scorex[o]),n[r].push(l.scorey[o]))}}for(let i=0;i<t.length;i+=1){const l=t[i];Nd(l,e[l],s[l],n[l])}}function ao(t){let e=[];for(let s=0;s<d.length;s+=1)d[s].courseid===t&&d[s].resultid===d[s].rawid&&e.push(d[s]);return e}function co(t){let e=[];for(let s=0;s<d.length;s+=1)d[s].variant===t&&d[s].resultid===d[s].rawid&&e.push(d[s]);return e}function uo(t){let e=[];for(let s=0;s<d.length;s+=1)d[s].courseid===t&&e.push(d[s].resultid);return e}function ho(t){let e=[];for(let s=0;s<d.length;s+=1)d[s].courseid===t&&d[s].hasValidTrack&&e.push(d[s].resultid);return e}function an(t,e){let s=`<tfoot class="table-group-divider"><tr class='allitemsrow'><td></td><td>${p("Routes")}</td><td></td>`;return t>0?(s+=`<td><input class='allcoursetracks' data-courseid=${e} type=checkbox name=track></input></td>`,s+=`<td><input class='allcoursetracksreplay' data-courseid=${e} type=checkbox name=replay></input></td>`):s+="<td></td><td></td>",s+=`</tr><tr class='allitemsrow'><td></td><td>${p("All")}</td><td></td><td></td>`,s+=`<td><input class='allcoursereplay' data-courseid=${e} type=checkbox name=replay></input></td></tr></tfoot>`,s}function fo(){let t=!1,e=["<table id='rg2-comments-table' class='table table-sm table-striped table-bordered'>",`<thead><tr><th>${p("Name")}</th><th>${p("Course")}</th>`,`<th>${p("Comments")}</th></tr></thead><tbody class="table-group-divider">`].join("");for(let s=0;s<d.length;s+=1)d[s].comments!==""&&(t=!0,e+=[`<tr><td>${d[s].name}</td><td>${d[s].coursename}</td>`,`<td>${d[s].comments}</td></tr>`].join(""));return t?e+="</tbody></table>":e="",e}function go(t){for(let e=0;e<d.length;e+=1)if(d[e].resultid===t)return d[e].courseid}function mo(t){let e=t.coursename;const s=me(t.courseid);s&&(e+=s.length===void 0?"":": "+s.length+" km");let n=`<div class="d-flex w-100"><div class="flex-grow-1 runners-table-course-header" data-runners="" data-courseid="${t.courseid}">${e}</div>`,i=`<div class="px-2"><input class='showcourse' data-courseid="${t.courseid}"`;return i+=` type=checkbox name ="course" title='Show course' ></input ></div >`,{title:n,check:i}}function po(t){return{id:d[t].resultid,token:d[t].token}}function yo(){let t=[];for(let e=0;e<d.length;e+=1)if(d[e].displayTrack){let s={};s.trackColour=d[e].trackColour,s.course=Td(d[e].courseid),s.name=d[e].name,s.resultid=d[e].resultid,s.rawid=d[e].rawid,t.push(s)}return t}function ei(t){for(let e=0;e<d.length;e+=1)if(d[e].resultid===t)return d[e]}function ti(t){for(let e=0;e<d.length;e+=1)if(d[e].resultid===t)return d[e]}function dn(t,e){let s;return t.rawid===t.resultid?s=t.name:s="<i>"+t.name+"</i>",t.isScoreEvent&&(s=`<input class='showscorecourse' data-courseid=${e} type=checkbox></input> ${s}`),`<div>${s}</div>`}function vo(t){let e=d.findIndex(s=>s.resultid===t);return e>-1?d[e].displayOrder:t}function Eo(){let t={results:0,drawnroutes:0,gpsroutes:0,secs:0};for(let e=0;e<d.length;e+=1){const s=d[e];s.resultid<h.GPS_RESULT_OFFSET&&(t.results+=1,s.time&&(t.secs+=s.splits[s.splits.length-1])),s.hasValidTrack&&(s.resultid<h.GPS_RESULT_OFFSET?t.drawnroutes+=1:t.gpsroutes+=1)}return t.totalroutes=t.drawnroutes+t.gpsroutes,t.results>0?t.percent=(100*t.totalroutes/t.results).toFixed(1):t.percent=0,t.time=ro(t.secs),t}function xo(t,e){const s=Eo(),n=Cd(),i=ke();let l="";if(e){const o=Li(),f=1e6;l=`. ${p("Map is georeferenced")}: ${parseInt(o.F*f)/f}`,l+=`, ${parseInt(o.C*f)/f}.`}return[`<tr><td>${p("Courses")}</td><td>${n.length}</td></tr>`,`<tr><td>${p("Controls")}</td><td>${t}</td></tr>`,`<tr><td>${p("Results")}</td><td>${s.results}</td></tr>`,`<tr><td>${p("Routes")}</td><td>${s.totalroutes} (${s.percent}%)</td></tr>`,`<tr><td>${p("Drawn routes")}</td><td>${s.drawnroutes}</td></tr>`,`<tr><td>${p("GPS routes")}</td><td>${s.gpsroutes}</td></tr>`,`<tr><td>${p("Total time")}</td><td>${s.time}</td></tr>`,`<tr><td>${p("Map")} ID ${nd()}</td><td>${i.width}  x ${i.height} pixels${l}</td></tr>`].join("")}function Io(){let t=[];for(let e=0;e<d.length;e+=1)if(d[e].hasValidTrack){let s={};s.id=e,s.resultid=d[e].resultid,s.name=d[e].name,s.time=d[e].time,s.coursename=d[e].coursename,t.push(s)}return t}function bo(t){for(let e=0;e<d.length;e+=1)if(t===d[e].resultid)return{time:d[e].time,splits:d[e].splits};return{time:h.TIME_NOT_FOUND,splits:[]}}function ss(){let t=[];for(let e=0;e<d.length;e+=1){const s=d[e];s.displayTrack&&t.push(s.resultid)}return t}function So(){let t,e,s=[];for(let n=0;n<d.length;n+=1)if(d[n].courseid!==t&&(t=d[n].courseid,e=me(t)),e.excludeType===h.EXCLUDED_REAL_SPLITS){s.indexOf(t)===-1&&s.push(t);let i=0;for(let l=1;l<e.exclude.length;l+=1)e.exclude[l]&&(i=i+Math.min(d[n].splits[l]-d[n].splits[l-1],e.allowed[l]));d[n].timeInSecs=Math.max(d[n].splits[d[n].splits.length-1]-i,0),d[n].time=_(d[n].timeInSecs)}for(let n=0;n<s.length;n+=1){let i=d.filter(o=>o.courseid===s[n]);for(let o=0;o<i.length;o+=1)if(i[o].rawid!==i[o].resultid){let f=i.findIndex(y=>y.resultid===i[o].rawid);f>-1&&(i[o].status=i[f].status)}i.sort(function(o,f){return o.status!=="ok"||o.timeInSecs===0?f.status!=="ok"||f.timeInSecs===0?0:1:f.status!=="ok"||f.timeInSecs===0?-1:o.timeInSecs-f.timeInSecs});let l=0,r=0;for(let o=0;o<i.length;o+=1){if(i[o].status!=="ok"||i[o].timeInSecs===0){i[o].position="";continue}r!==i[o].timeInSecs?(l=l+1,r=i[o].timeInSecs):o>0&&i[o].rawid!==i[o-1].rawid&&(l=l+1),i[o].position=l}for(let o=0;o<i.length;o+=1){let f=d.findIndex(y=>y.resultid===i[o].resultid);f>-1&&(d[f].position=i[o].position,d[f].displayOrder=o)}}}function To(){d.sort(Po);let t,e=!1;for(let s=0;s<d.length;s+=1)d[s].rawid===t?e&&d[s].hasValidTrack&&(d[s-1].showResult=!1,d[s].position=d[s-1].position,e=!1):(e=!d[s].hasValidTrack,t=d[s].rawid)}function Co(){for(let t=0;t<d.length;t+=1)d[t].speedColour.length=0}function ko(t){for(let e=0;e<d.length;e+=1)if(t===d[e].resultid)return!0;return!1}function Do(t){let e,s;for(let n=0;n<d.length;n+=1){d[n].courseid!==e&&(e=d[n].courseid,s=me(e)),d[n].legSplits=[],d[n].legSplits[0]=0;let i=0,l=!1;for(let r=1;r<d[n].splits.length;r+=1)d[n].splits[r]-i===0?s.exclude[r]?(d[n].legSplits[r]=d[n].splits[r]-i,i=d[n].splits[r]):(d[n].legSplits[r]=0,l=!0,d[n].lastValidSplit===void 0&&(d[n].lastValidSplit=r-1)):l?(d[n].legSplits[r]=0,i=d[n].splits[r],l=!1):(d[n].legSplits[r]=d[n].splits[r]-i,i=d[n].splits[r]);if(d[n].lastValidSplit===void 0&&(d[n].lastValidSplit=d[n].splits.length-1),!t){const r=Ld(d[n].courseid)+2;for(;d[n].splits.length<r;)d[n].splits.push(d[n].splits[d[n].splits.length-1]),d[n].legSplits.push(0)}}}function Lo(t){document.getElementById("rg2-load-progress-label").textContent=p("Saving results",""),Ai()>0&&Zr(t,dt()),Md(),dt()&&(oo(),z.generateControlList())}function wo(t){if(document.getElementById("rg2-load-progress-label").textContent=p("Saving routes",""),Ai()>0&&Jr(t),md(),so(),h.managing())Ql();else{if(document.getElementById(h.TAB_COURSES).removeAttribute("disabled"),document.getElementById(h.TAB_RESULTS).removeAttribute("disabled"),ki()?document.getElementById(h.TAB_DRAW).setAttribute("disabled",""):document.getElementById(h.TAB_DRAW).removeAttribute("disabled"),Ze()!==h.TAB_DRAW){const i=bl();document.getElementById(i).click()}const s=Il();for(let i=0;i<s.length;i+=1){let l=new Event("click",{bubbles:!0});const r=document.querySelector(`.showtrack[data-id='${s[i]}']`);r&&(r.checked=!0,r.dispatchEvent(l))}const n=El();for(let i=0;i<n.length;i+=1){let l=new Event("click",{bubbles:!0});const r=document.querySelector(`.showcourse[data-courseid='${n[i]}']`);r&&(r.checked=!0,r.dispatchEvent(l))}}document.getElementById("rg2-load-progress").classList.add("d-none"),b()}function Bo(){const t=Oe();let e=[];const s=D.drawnRoutes;for(let n=0;n<s.length;n+=1)s[n].eventid===t&&e.push(s[n]);for(let n=0;n<e.length;n+=1)for(let i=0;i<d.length;i+=1)d[i].resultid===e[n].id&&(d[i].canDelete=!0,d[i].token=e[n].token)}function si(){document.getElementById("rg2-result-table").querySelectorAll("#results-accordion .accordion-item").forEach(s=>{const n=s.querySelectorAll(".resulttable tbody tr:not(.d-none)");s.querySelector(".runners-table-course-header").setAttribute("data-runners",n.length)})}function Ao(){for(let t=0;t<d.length;t+=1)d[t].resultid<h.GPS_RESULT_OFFSET?d[t].displayOrder=t:d[t].displayOrder=vo(d[t].rawid)}function Ro(t,e){for(let s=0;s<d.length;s+=1)d[s].rawid===t&&(d[s].userColour=e,d[s].trackColour=e)}function Mo(){let t=document.getElementById("rg2-result-search");if(d.length===0){t.classList.add("d-none");return}t.innerHTML=`<form class="d-flex pb-2" role="search">
  <input class="form-control mx-2" type="search" aria-label="${p("Search")}">
  <i class="bi-search mx-2"></i>
  </form>`;let e=document.getElementById("rg2-result-table");t.addEventListener("keyup",s=>{const n=s.target.value.toUpperCase(),i=e.querySelectorAll("tbody tr");for(let l=0;l<i.length;l+=1)i[l].innerText.toUpperCase().indexOf(n)>-1?i[l].classList.remove("d-none"):i[l].classList.add("d-none");si()})}function at(t,e){for(let s=0;s<d.length;s+=1)d[s].resultid===t&&(d[s].displayScoreCourse=e)}function No(){for(let t=0;t<d.length;t+=1)if(d[t].resultid>=h.GPS_RESULT_OFFSET){const e=ti(d[t].rawid);e!==void 0&&e.scorex!==void 0&&(d[t].scorex=e.scorex,d[t].scorey=e.scorey,d[t].scorecodes=e.scorecodes)}}function cn(t,e){for(let s=0;s<d.length;s+=1)(d[s].courseid===t||h.DISPLAY_ALL_COURSES===t)&&d[s].setTrackDisplay(e);Ys()}function _o(t,e){for(let s=0;s<d.length;s+=1)d[s].resultid===parseInt(t,10)&&d[s].setTrackDisplay(e);Ys()}function Po(t,e){return t.courseid>e.courseid?1:e.courseid>t.courseid?-1:t.rawid===e.rawid?t.resultid-e.resultid:t.displayOrder-e.displayOrder}class ni{constructor(e){const s=ei(e);this.name=s.name,this.initials=s.initials,this.resultid=e,this.rawid=s.rawid,this.starttime=s.starttime,this.splits=s.splits,this.trackColour=s.trackColour,this.userColour=s.userColour;let n;s.isScoreEvent?(n={},n.name=s.coursename,n.x=s.scorex,n.y=s.scorey,n.codes=s.scorecodes):n=me(s.courseid),this.coursename=n.name,this.nextStopTime=h.VERY_HIGH_TIME_IN_SECS,this.x=[],this.y=[],this.cumulativeDistance=[],this.cumulativeDistance[0]=0,this.legTrackDistance=[],this.legTrackDistance[0]=0,this.cumulativeTrackDistance=[],this.cumulativeTrackDistance[0]=0,s.hasValidTrack?this.expandTrack(s.trackx,s.tracky,s.xysecs):this.expandTrack(n.x,n.y,s.splits),this.addTrackDistances(n,s)}addTrackDistances(e,s){const n=this.cumulativeDistance.length-1;if(e.codes!==void 0)if(s.splits.length>1)for(let i=1;i<e.codes.length;i+=1){let l;s.splits[i]<=n?l=s.splits[i]:l=n,this.cumulativeTrackDistance[i]=this.cumulativeDistance[l],this.legTrackDistance[i]=this.cumulativeTrackDistance[i]-this.cumulativeTrackDistance[i-1]}else this.legTrackDistance[1]=this.cumulativeDistance[n],this.cumulativeTrackDistance[1]=this.cumulativeDistance[n]}expandTrack(e,s,n){let i=0,l=0,r=e[0],o=s[0],f=0,y=0;this.x[0]=e[0],this.y[0]=s[0];let u=Kt();u===void 0&&(u=1);for(let g=1;g<n.length;g+=1){let v=e[g],k=s[g],O=v-r,N=k-o;y=y+J(v,k,r,o)*u;let A=y-f;l=n[g],l===0&&(l=i+1);let ee=l-i;for(let Ie=i+1;Ie<l;Ie+=1)this.x[Ie]=Math.round(r+(Ie-i)*O/ee),this.y[Ie]=Math.round(o+(Ie-i)*N/ee),this.cumulativeDistance[Ie]=Math.round(f+(Ie-i)*A/ee);this.x[l]=v,this.y[l]=k,this.cumulativeDistance[l]=Math.round(y),r=v,o=k,f=y,i=l}}}tl.registerModules([sl]);const Bt=[{id:"rg2-stats-summary",title:"Summary",active:"true"},{id:"rg2-legs",title:"Leg times"},{id:"rg2-cumulative",title:"Cumulative times"},{id:"rg2-split-times",title:"Split times"},{id:"rg2-time-loss",title:"Time loss"}],Fo=['<div id="rg2-stats-summary" class="container"></div><div style="height: 400px;"><canvas id="rg2-splits-chart"></canvas></div>','<div id="rg2-leg-table" style="width: 950px; height: 100%" class="ag-theme-balham"></div>','<div id="rg2-race-table" style="width: 950px; height: 100%;" class="ag-theme-balham"></div>',`<div id="rg2-results-table" class="rg2-results-table-container">
     <div id="rg2-results-grid-wrapper">
       <div id="rg2-results-grid" style="height: 100%" class="ag-theme-balham"></div>
     </div>
   </div>`,`<div id="rg2-time-loss" class="container">
      <div class="rg2-control-slider-grid d-flex flex-column">
        <div class="d-flex">
          <div id="rg2-control-number"></div>
          <div id="rg2-control-slider"></div>
        </div>
        <div id="rg2-loss-details" class="d-flex justify-content-center"></div>
      </div>
      <canvas id="rg2-loss-chart"></canvas>
    </div>`];let P=null,it=null,m=[],fs=!1,B=null,G=0,ce=[],ue=[],C=null,bt,St,U=1,ii=9,V=2;function Oo(){if(B.excludeType===h.EXCLUDED_REAL_SPLITS)for(let t=0;t<m.length;t+=1){let e=0;for(let s=1;s<B.exclude.length;s+=1){if(B.exclude[s]){const n=Math.min(m[t].splits[s]-m[t].splits[s-1]-e,B.allowed[s]);e=e+n}m[t].splits[s]=m[t].splits[s]-e,m[t].legSplits[s]=m[t].splits[s]-m[t].splits[s-1]}}}function $o(t){for(let e=0;e<m.length;e+=1){t===0&&(m[e].predictedSplits=[],m[e].loss=[],m[e].totalLoss=[]),m[e].predictedSplits[t]=[],m[e].predictedSplits[t][0]=0,m[e].loss[t]=[],m[e].loss[t][0]=0;let s=0;for(let n=0;n<G;n+=1)m[e].performanceIndex[t]>0?m[e].predictedSplits[t][n]=parseInt(B.refLegTime[t][n]/m[e].normalPerformanceIndex[t],10):m[e].predictedSplits[t][n]=m[e].legSplits[n],m[e].loss[t][n]=m[e].legSplits[n]-m[e].predictedSplits[t][n],m[e].loss[t][n]<0&&(m[e].loss[t][n]=0),s=s+m[e].loss[t][n];m[e].totalLoss[t]=s}}function Ho(t){t===0&&(B.refLegTime=[],B.refTime=[]);let e=[],s=[];for(let n=0;n<G;n+=1){if(e.length=0,!B.exclude[n])for(let l=0;l<m.length;l+=1)m[l].iterSplits[t][n]!==0&&e.push(m[l].iterSplits[t][n]);const i=gs(e,25);s.push(i.median)}B.refLegTime[t]=s.slice(0),B.refTime[t]=s.reduce((n,i)=>n+i);for(let n=0;n<m.length;n+=1){t===0&&(m[n].refRatio=[],m[n].performanceIndex=[],m[n].normalPerformanceIndex=[],m[n].totalSecs=[]),m[n].refRatio[t]=[];const i=[];for(let y=0;y<G;y+=1)m[n].iterSplits[t][y]===0?m[n].refRatio[t][y]=0:m[n].refRatio[t][y]=B.refLegTime[t][y]/m[n].iterSplits[t][y],i.push(m[n].refRatio[t][y]);const l=i.filter(y=>y>0),r=gs(l,100);m[n].performanceIndex[t]=r.median,m[n].totalSecs[t]=m[n].iterSplits[t].reduce((y,u)=>y+u);let o=0,f=0;for(let y=0;y<G;y+=1)m[n].iterSplits[t][y]!==0&&(o=o+m[n].refRatio[t][y]*B.refLegTime[t][y],f=f+B.refLegTime[t][y]);o===0?m[n].normalPerformanceIndex[t]=0:m[n].normalPerformanceIndex[t]=o/f}}function Xo(t){for(let e=0;e<m.length;e+=1){t===0&&(m[e].iterSplits=[]);let s=[];for(let n=0;n<G;n+=1)t===0?s.push(m[e].legSplits[n]):s.push(m[e].predictedSplits[t-1][n]);m[e].iterSplits[t]=s.slice(0)}}function Vo(){V=Math.max(V-1,0),gi()}function Uo(t){let e="",s="";P.splits.length-1===U?e=p("Finish"):(e=p("Control"),s=": "+U);let n=`<div>${e}${s}</div>`;if(document.getElementById("rg2-control-number").innerHTML=n,n="",B.exclude[U])n=p("Control excluded","");else{const i=t.filter(r=>r.loss>0).map(r=>r.loss),l=gs(i,100);n=`<div class="px-2 fw-bold">${p("Runners")}: ${l.count}</div >`,n+=`<div class="px-2 fw-bold">${p("Average")}: ${parseInt(l.mean,10)}s (${parseInt(l.mean*1e3/B.refLegTime[V][U],10)/10}%)</div>`,n+=`<div class="px-2 fw-bold">${p("Median")}: ${l.median}s (${parseInt(l.median*1e3/B.refLegTime[V][U],10)/10}%)</div>`}document.getElementById("rg2-loss-details").innerHTML=n}function Go(){document.getElementById("rg2-stats-panel-tab-headers").addEventListener("show.bs.tab",t=>{Ko(t)}),document.getElementById("rg2-stats-summary-tab-label").click()}function Bs(){St!==void 0&&(St.destroy(),St=void 0);const t=document.getElementById("rg2-loss-chart"),e=g=>n.length===0?h.DARK_GREEN_30:n[g.dataIndex].activeRunner?h.DARK_GREEN:h.DARK_GREEN_30,s=g=>n.length===0?h.RED_30:n[g.dataIndex].activeRunner?h.RED:h.RED_30,n=[];B.exclude[U]||m.map(g=>{if(parseInt(g.legSplits[U],10)>0){let v={};v.loss=parseInt(g.loss[V][U],10),v.total=parseInt(g.legSplits[U],10),v.predicted=v.total-v.loss,v.pos=g.legpos[U],v.name=g.name,g.rawid===it&&(v.activeRunner=!0),n.push(v)}}),n.sort((g,v)=>g.total-v.total);const i=n.map(g=>g.predicted),l=n.map(g=>g.loss),r=n.map(g=>g.pos),o=n.map(()=>B.refLegTime[V][U]),f=m.reduce((g,v)=>Math.max(g,v.legSplits[U]),0),y=parseInt((f+299)/300,10)*300;Uo(n),St=new Rn(t,{data:{labels:r,datasets:[{label:"Predicted",type:"bar",data:i,backgroundColor:e},{label:"Loss",type:"bar",data:l,yAxisID:"yLoss",backgroundColor:s},{label:"Reference time",type:"line",data:o,borderColor:h.RED,backgroundColor:h.WHITE,borderDash:[5,5],yAxisID:"yLoss",pointStyle:"circle",pointRadius:0,pointHoverRadius:0}]},options:{scales:{x:{stacked:!0,title:{display:!0,text:"Position"}},yLoss:{stacked:!0,min:0,max:y,title:{display:!0,text:"Time (s)"}}},plugins:{tooltip:{callbacks:{label(g){let v=g.dataset.label+": ";return g.dataset.label==="Loss"?v+=_(n[g.dataIndex].loss):v+=_(n[g.dataIndex].predicted),v},title(g){return n[g[0].dataIndex].name+": "+_(n[g[0].dataIndex].total)}}}}}});const u=document.querySelector("#rg2-loss-chart");u.onwheel=g=>{g.preventDefault(),g.deltaY<0?U=U===P.splits.length-1?1:U+1:U=U>1?U-1:P.splits.length-1,Bs()}}function Yo(){U=1,Bs()}function Wo(){let t=[];for(let e=1;e<B.codes.length;e+=1){t.length=0;for(let i=0;i<m.length;i+=1)m[i].resultid===m[i].rawid&&(m[i].isScoreEvent?m[i].variant===B.courseid&&t.push({time:m[i].legSplits[e],id:i}):m[i].courseid===B.courseid&&t.push({time:m[i].legSplits[e],id:i}));t.sort(gn);let s=0,n=0;for(let i=0;i<t.length;i+=1){if(B.exclude[e]){m[t[i].id].legpos[e]=0;continue}t[i].time!==n?t[i].time===0?(m[t[i].id].legpos[e]=0,n=0,s=0):(m[t[i].id].legpos[e]=i+1,n=t[i].time,s=i+1):m[t[i].id].legpos[e]=s}}t.length=0;for(let e=1;e<B.codes.length;e+=1){t.length=0;let s=0;for(let l=0;l<m.length;l+=1)m[l].resultid===m[l].rawid&&(m[l].isScoreEvent?m[l].variant===B.courseid&&(e>m[l].lastValidSplit?s=0:s=m[l].splits[e],t.push({time:s,id:l})):m[l].courseid===B.courseid&&(e>m[l].lastValidSplit?s=0:s=m[l].splits[e],t.push({time:s,id:l})));t.sort(gn);let n=0,i=0;for(let l=0;l<t.length;l+=1)t[l].time!==i?t[l].time===0?(m[t[l].id].racepos[e]=0,n=0,i=0):(m[t[l].id].racepos[e]=l+1,i=t[l].time,n=l+1):m[t[l].id].racepos[e]=n}}function li(){bt!==void 0&&(bt.destroy(),bt=void 0);const t=(u,g)=>u.p0.skip||u.p1.skip?g:void 0,e=document.getElementById("rg2-splits-chart"),s=m[C].legpos.map((u,g,v)=>g===v.length-1?"F":g),n=ci(),i=m[C].legpos.map(u=>u===0?NaN:u),l=m[C].loss[V].map((u,g)=>m[C].legpos[g]===0?NaN:u),r=m[C].legpos.map(()=>n.average),o=m[C].loss[V].reduce((u,g)=>Math.max(u,g),0),f=parseInt((o+299)/300,10)*300;bt=new Rn(e,{data:{labels:s,datasets:[{label:"Leg position",type:"line",data:i,borderColor:h.RED,backgroundColor:h.RED_30,yAxisID:"yPosition",segment:{borderColor:u=>t(u,"rgb(0,0,0,0.2)"),borderDash:u=>t(u,[6,6])},spanGaps:!0},{label:"Average leg position",type:"line",data:r,borderColor:h.RED,backgroundColor:h.WHITE,borderDash:[5,5],yAxisID:"yPosition",pointStyle:"circle",pointRadius:0,pointHoverRadius:0},{label:"Time loss",type:"bar",data:l,borderColor:h.DARK_GREEN,backgroundColor:h.DARK_GREEN_30,yAxisID:"yLoss",segment:{borderColor:u=>t(u,"rgb(0,0,0,0.2)"),borderDash:u=>t(u,[6,6])},spanGaps:!0}]},options:{maintainAspectRatio:!1,responsive:!0,scales:{x:{min:1,title:{display:!0,text:p("Control","")}},yPosition:{type:"linear",display:!0,position:"left",min:0,max:parseInt((m.length+9)/10,10)*10,title:{display:!0,text:"Leg position"}},yLoss:{type:"linear",display:!0,position:"right",min:0,max:f,grid:{drawOnChartArea:!1},title:{display:!0,text:"Time loss"}}},plugins:{tooltip:{callbacks:{label:function(u){return u.dataset.label==="Time loss"?"Loss: "+_(l[u.dataIndex]):u.dataset.label==="Leg position"?"Position: "+i[u.dataIndex]:""},title:function(u){return u[0].label==="F"?p("Finish",""):p("Control","")+" "+u[0].label}}}}}});const y=document.querySelector("#rg2-splits-chart");y.onwheel=u=>{u.preventDefault(),u.deltaY<0?C=C===m.length-1?0:C+1:C=C>0?C-1:m.length-1,hi(m[C].rawid)}}function ri(){const t=[{headerName:p("Pos",""),field:"position",cellDataType:"text",width:60,pinned:"left",sortable:!0},{headerName:p("Name",""),field:"name",cellDataType:"text",headerClass:"align-left",cellClass:"align-left",width:150,pinned:"left"},{headerName:p("Time",""),field:"time",cellDataType:"text",width:85}];for(let r=1;r<G-1;r+=1)t.push({headerName:r+" ("+B.codes[r]+")",field:"C"+r,cellDataType:"text",cellRenderer:fn,width:110});t.push({headerName:p("F",""),field:"finish",cellDataType:"text",cellRenderer:fn,width:110}),t.push({headerName:p("Loss",""),field:"loss",cellDataType:"text",width:100}),t.push({headerName:p("Performance",""),field:"performance",cellDataType:"text",width:100}),t.push({headerName:p("Consistency",""),field:"consistency",cellDataType:"text",width:100});let e=[];m.sort(function(r,o){return r.racepos[r.splits.length-1]<=0?1:o.racepos[o.splits.length-1]<=0?-1:r.racepos[r.splits.length-1]-o.racepos[o.splits.length-1]}),C=mi(it);for(let r=0;r<m.length;r+=1){let o={};const f=m[r];f.racepos[G-1]==0?o.position="":o.position=f.racepos[G-1],o.name=f.name,o.time=f.time;for(let u=1;u<G-1;u+=1)f.splits[u]===f.splits[u-1]?o["C"+u]={split:"0:00",pos:f.racepos[u],loss:!1}:o["C"+u]={split:_(f.splits[u]),pos:f.racepos[u],loss:!1};o.finish={split:_(f.splits[G-1]),pos:f.racepos[G-1]},o.loss=_(f.timeInSecs-f.totalLoss[V]),o.performance=(f.performanceIndex[0]*100).toFixed(1);const y=f.refRatio[0].filter(u=>u>0);o.consistency=(100*ui(y)).toFixed(1),e.push(o),o={};for(let u=1;u<G-1;u+=1)o["C"+u]={split:_(f.legSplits[u]),pos:f.legpos[u],loss:f.loss[V][u]>19};o.finish={split:_(f.legSplits[G-1]),pos:f.legpos[G-1],loss:f.loss[V][G-1]>19},o.loss=_(f.totalLoss[V]),e.push(o)}const s={columnDefs:t,rowData:e,defaultColDef:{headerClass:"align-center",cellClass:"align-center"}},n=document.getElementById("rg2-map-canvas").height*.98-120,i=document.getElementById("rg2-results-grid-wrapper");i.removeAttribute("style"),i.setAttribute("style","height: "+n+"px;");const l=document.getElementById("rg2-results-grid");l.innerHTML="",Is(l,s)}function oi(){const t=ci(),e=l=>`${l}`;let s=e(`<div>${p("Name")}</div><div>${P.name}</div>`);s+=e(`<div>${p("Course")}</div><div>${P.coursename}</div>`),s+=e(`<div>${p("Time")}</div><div>${P.time}</div>`),s+=e(`<div>${p("Position")}</div><div>${m[C].racepos[G-1]} / ${m.length}</div>`),s+=e(`<div>${p("Average leg position")}</div><div>${t.average} (${p("Best","")}: ${t.best}, ${p("Worst")}: ${t.worst})</div >`);let n="";ea(P.timeInSecs)&&(n=` (${(100*m[C].totalLoss[V]/P.timeInSecs).toFixed(1)}%)`),s+=e(`<div>${p("Estimated loss")}</div><div>${_(m[C].totalLoss[V])}${n}</div>`),s+=e(`<div>${p("Performance")}</div><div>${(P.performanceIndex[0]*100).toFixed(1)}%</div>`);const i=m[C].refRatio[0].filter(l=>l>0);s+=e(`<div>${p("Consistency")}</div><div>${(100*ui(i)).toFixed(1)}%</div>`),document.getElementById("rg2-stats-summary").innerHTML=s}function ai(){const t=[];for(let n=0;n<m[C].splits.length;n+=1){let i={};if(n===0?i.control="S":n==m[C].splits.length-1?i.control="F":i.control=n+" ("+B.codes[n]+")",n===0?i.time="0:00":i.time=_(m[C].legSplits[n]),n===0||m[C].legpos[n]===0||B.exclude[n]?i.position="-":i.position=m[C].legpos[n],n===0||B.exclude[n]?i.performance="-":i.performance=(100*m[C].refRatio[0][n]).toFixed(1),B.exclude[n]?i.best="-":i.best=_(ce[n][0].t),n===0||B.exclude[n])i.who="-";else{let r=ce[n][0].name;for(let o=1;o<ce[n].length&&ce[n][0].t===ce[n][o].t;o+=1)r+=", "+ce[n][o].name;i.who=r}const l=m[C].legSplits[n]-ce[n][0].t;n===0||m[C].legSplits[n]<=0?i.behind="-":i.behind=_(l),n===0||m[C].legSplits[n]<=0?i.percent=0:i.percent=parseInt(l*100/ce[n][0].t,10),B.exclude[n]?i.predicted="-":i.predicted=_(m[C].predictedSplits[V][n]),m[C].legSplits[n]<=0?i.loss="-":i.loss=_(m[C].loss[V][n]),t.push(i)}const e={columnDefs:[{headerName:p("Control",""),field:"control",width:80},{headerName:p("Time",""),field:"time",width:80,comparator:Tt.bind(this)},{headerName:p("Position",""),field:"position",width:75},{headerName:p("Performance",""),field:"performance",width:95,comparator:na.bind(this)},{headerName:p("Best",""),field:"best",width:80},{headerName:p("Who",""),field:"who",headerClass:"align-left",cellClass:"align-left",flex:1,tooltipField:"who"},{headerName:p("Behind",""),field:"behind",width:80,comparator:Tt.bind(this)},{headerName:"%",field:"percent",width:60},{headerName:p("Predicted",""),field:"predicted",width:100,comparator:Tt.bind(this)},{headerName:p("Loss",""),field:"loss",width:75,comparator:Tt.bind(this)}],rowData:t,domLayout:"autoHeight",defaultColDef:{headerClass:"align-center",cellClass:"align-center",sortable:!0}},s=document.getElementById("rg2-leg-table");s.innerHTML="",Is(s,e)}function di(){const t=[];let e=0;for(let i=0;i<m[C].splits.length;i+=1){let l={};if(i==0?l.control="S":i==m[C].splits.length-1?l.control="F":l.control=i+" ("+B.codes[i]+")",i==0?l.time="0:00":m[C].splits[i]===m[C].splits[i-1]?l.time="":l.time=_(m[C].splits[i]),i===0||m[C].racepos[i]===0?l.position="-":l.position=m[C].racepos[i],l.best=_(ue[i][0].t),i===0)l.who="-";else{let o=ue[i][0].name;for(let f=1;f<ue[i].length&&ue[i][0].t===ue[i][f].t;f+=1)o+=", "+ue[i][f].name;l.who=o}const r=m[C].splits[i]-ue[i][0].t;i===0||m[C].racepos[i]===0?l.behind="-":l.behind=_(r),i===0||m[C].racepos[i]===0?l.percent="-":l.percent=parseInt(r*100/ue[i][0].t,10),e=e+m[C].loss[V][i],l.loss=_(e),t.push(l)}const s={columnDefs:[{headerName:p("Control",""),field:"control",width:88},{headerName:p("Time",""),field:"time",width:85},{headerName:p("Position",""),field:"position",width:100},{headerName:p("Best",""),field:"best",width:85},{headerName:p("Who",""),field:"who",headerClass:"align-left",cellClass:"align-left",flex:1,tooltipField:"who"},{headerName:p("Behind",""),field:"behind",width:85},{headerName:"%",field:"percent",width:85},{headerName:"Loss",field:"loss",width:100}],rowData:t,domLayout:"autoHeight",defaultColDef:{headerClass:"align-center",cellClass:"align-center"}},n=document.getElementById("rg2-race-table");n.innerHTML="",Is(n,s)}function gs(t,e){let s=t.slice();if(s.length===0)return{mean:0,median:0,count:0};s.sort(function(o,f){return o-f});let n=0,i=s.length;if(e<100){const r=Math.max(parseInt(i*e/100,10),3);s.splice(r),i=s.length}for(let r=0;r<i;r+=1)n=n+s[r];let l;return i===1?l=s[0]:i%2===0?l=(s[i/2-1]+s[i/2])/2:l=s[Math.floor(i/2)],{mean:n/i,median:l,count:i}}function ci(){let t=0,e=0,s=0,n=9999;for(let l=1;l<P.legpos.length;l+=1)P.legpos[l]!==0&&(t+=P.legpos[l],e+=1,n>P.legpos[l]&&(n=P.legpos[l]),s<P.legpos[l]&&(s=P.legpos[l]));let i;return e>0?i=(t/e).toFixed(1):(i=0,n=0,s=0),{best:n,worst:s,average:i}}function jo(t){return t.reduce((e,s)=>e+s,0)/t.length}function un(t){return t==="-"?0:parseFloat(t)}function ui(t){if(t.length===0)return 0;const e=jo(t);return Math.sqrt(t.reduce((s,n)=>s+Math.pow(n-e,2),0)/t.length)}function qo(){let t='<ul class="nav nav-pills" id="rg2-stats-panel-tab-headers" role="tablist">';for(let e of Bt){const s=p(e.title),n=e.active?" active":"",i=e.active?"":"tabindex='-1'";t+=`<li class="nav-item${n}" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#${e.id}-tab"
      type="button" role="tab" ${i}>
      <div id="${e.id}-tab-label">${s}</div>
    </button>
    </li>`}return t+="</ul>",t}function zo(){let t='<div id="rg2-stats-table"><div class="tab-content" id="rg2-stats-panel-tab-body">';for(let e=0;e<Bt.length;e+=1){const s=Bt[e].active?" active":"";t+=`<div class="tab-pane fade ${s} pt-2" id="${Bt[e].id}-tab" role="tabpanel" tabindex="${e}">
      ${Fo[e]}</div>`}return t+="</div></div></div>",t}function hn(t){return t==="-"?0:parseFloat(t.replace(":","."))}function Ko(t){if(t.currentTarget)switch(t.currentTarget.id){case"rg2-iter-plus-text":Zo(),t.preventDefault();break;case"rg2-iter-minus-text":Vo(),t.preventDefault();break;case"rg2-iter-text":t.preventDefault();break}}function Zo(){V=Math.min(V+1,ii),gi()}function Jo(t){it=t,fs=dt(),P=ti(it),fs?m=co(P.variant):m=ao(P.courseid),Qo(P.courseid),Oo(),Wo(),C=mi(it)}function Qo(t){if(fs?B={courseid:P.variant,codes:P.scorecodes,exclude:!1}:B=me(t),G=B.codes.length,G<=2)throw new fi(p("No splits available."));ce.length=0,ue.length=0;let e=[],s=[];for(let n=0;n<G;n+=1){e.length=0,s.length=0;for(let i=0;i<m.length;i+=1)n===0?(e.push({t:0,name:"",pos:0}),s.push({t:0,name:"",pos:0})):(e.push({t:m[i].legSplits[n],name:m[i].name,pos:m[i].legpos[n]}),n<=m[i].lastValidSplit&&s.push({t:m[i].splits[n],name:m[i].name,pos:m[i].racepos[n]}));e.sort(function(i,l){return i.t===0?1:l.t===0?-1:i.t-l.t}),s.sort(function(i,l){return i.t-l.t}),ce.push(e.slice()),ue.push(s.slice())}}function ea(t){return!isNaN(parseFloat(t))&&isFinite(t)?t>0:!1}function ta(){for(let t=0;t<=ii;t+=1)Xo(t),Ho(t),$o(t)}function sa(t){return Fs()?(hi(t),!0):(I(p("Statistics",""),p("No statistics available for this event format.","")),!1)}function na(t,e){return un(t)-un(e)}function hi(t){try{Jo(t),ta(),oi(),li(),Yo(),ai(),di(),ri(),Go()}catch(e){e instanceof fi?I(p("Statistics"),e.message):I(p("Statistics",""),p("Data inconsistency.",""));return}}function fn(t){if(t.value.split==="0:00")return"";let e=t.value.split,s="";return t.value.pos!==0&&(e+=" ("+t.value.pos+")",t.value.pos===1&&(s="rg2-first"),t.value.pos===2&&(s="rg2-second"),t.value.pos===3&&(s="rg2-third")),t.value.loss&&(s+=" rg2-lost-time"),'<span class="'+s+'">'+e+"</span>"}function fi(t){this.message=t}function gi(){document.getElementById("rg2-iter-count-tab-label").innerText=V+1,Bs(),oi(),li(),ai(),di(),ri()}function mi(t){for(let e=0;e<m.length;e+=1)if(m[e].rawid===t)return P=m[e],e;return null}function gn(t,e){return t.time===0?1:e.time===0?-1:t.time-e.time}function Tt(t,e){return hn(t)-hn(e)}const ms=document.getElementById("rg2-show-info-panel-control"),Re=document.getElementById("rg2-right-info-panel"),As=document.getElementById("rg2-right-info-panel-title"),Rs=new Mn(Re,{backdrop:!1}),Ve=document.getElementById("rg2-left-info-panel"),mn=document.getElementById("rg2-left-info-panel-title");let pn=document.getElementById("rg2-left-info-panel-body");const pi=new Mn(Ve,{backdrop:!1});Ve.style.width="420px";Ve.addEventListener("hidden.bs.offcanvas",()=>{ms.classList.remove("d-none")});Ms();const ns=10,is=-10;function ia(){return!document.getElementById("rg2-animation-controls").classList.contains("d-none")}function la(){document.querySelector("label[for=rg2-select-course]").innerHTML=`${p("Select course")}`,document.querySelector("label[for=rg2-select-name]").innerHTML=`${p("Select name")}`,document.querySelector("label[for=rg2-name-entry]").innerHTML=p("Name"),document.querySelector("#rg2-name-entry").addEventListener("input",()=>{bn()}),document.querySelector("label[for=rg2-time-entry]").innerHTML=p("Time"),document.querySelector("#rg2-time-entry").addEventListener("input",()=>{bn()});const t=document.getElementById("rg2-new-comments");t.setAttribute("placeholder",p(h.DEFAULT_NEW_COMMENT,"")),t.addEventListener("focus",()=>{document.getElementById("rg2-new-comments").setAttribute("placeholder","")});const e=document.getElementById("btn-three-seconds");e.innerHTML=p("+3 secs"),e.addEventListener("click",u=>{u.preventDefault(),za()});const s=document.getElementById("btn-undo");s.innerHTML=p("Undo"),s.addEventListener("click",u=>{u.preventDefault(),qa()});const n=document.getElementById("btn-save-route");n.innerHTML=p("Save"),n.addEventListener("click",u=>{u.preventDefault(),Va()});const i=document.getElementById("btn-reset-drawing");i.innerHTML=p("Reset"),i.addEventListener("click",u=>{u.preventDefault(),Oa()}),document.getElementById("rg2-load-gps-title").innerHTML=p("Load GPS file (GPX or TCX)"),document.getElementById("btn-offset-plus").addEventListener("click",()=>{const u=document.getElementById("rg2-offset-value");let g=parseInt(u.value,10);g<ns&&(g=g+1,u.value=g,ls(g))}),document.getElementById("btn-offset-minus").addEventListener("click",()=>{const u=document.getElementById("rg2-offset-value");let g=parseInt(u.value,10);g>is&&(g=g-1,u.value=g,ls(g))}),document.getElementById("rg2-offset-value").addEventListener("input",()=>{const u=document.getElementById("rg2-offset-value");let g=parseInt(u.value,10);isNaN(g)&&(g=0),g<is&&(g=is),g>ns&&(g=ns),u.value=g,ls(g)});const l=document.getElementById("btn-undo-gps-adjust");l.innerHTML=p("Undo"),l.addEventListener("click",u=>{u.preventDefault(),ja()});const r=document.getElementById("btn-autofit-gps");r.innerHTML=p("Autofit"),r.addEventListener("click",u=>{u.preventDefault(),xa()}),document.querySelector("label[for=chk-move-all]").innerHTML=p("Move track and map together (or right click-drag)");const o=document.getElementById("btn-save-gps-route");o.innerHTML=p("Save GPS route"),o.addEventListener("click",u=>{u.preventDefault(),Xa()}),["Left click to add/lock/unlock a handle","Green - draggable","Red - locked","Right click to delete a handle","Drag a handle to adjust track around locked point(s)"].forEach((u,g)=>{const v=document.getElementById(`draw-text-${g+1}`);v.innerHTML=`${p(u)}.`}),document.getElementById("rg2-load-gps-file").addEventListener("input",u=>{Fa(u)})}function ra(){document.querySelector("label[for=rg2-select-language]").innerHTML=`${p("Language")}`,nl(h.languages),At("chk-show-GPS-speed","showGPSSpeed","Show GPS speed colours"),At("chk-snap-toggle","snap","Snap to control when drawing"),At("chk-show-three-seconds","showThreeSeconds","Show +3 time loss for GPS routes"),$e("map-intensity","perCentMapIntensity","Map intensity","%"),$e("route-intensity","perCentRouteIntensity","Route intensity","%"),$e("control-circle","circleSize","Control circle size"),$e("course-width","courseWidth","Course overprint width"),$e("route-width","routeWidth","Route width"),$e("name-font-size","replayFontSize","Replay label font size");const t=document.getElementById("rg2-gps-speed-slider");t.setAttribute("value1",D.maxSpeed),t.setAttribute("value2",D.minSpeed),t.addEventListener("change",ha),document.getElementById("rg2-min-gps-speed-label").innerHTML=vi(),document.getElementById("rg2-max-gps-speed-label").innerHTML=yi()}function At(t,e,s){document.querySelector(`label[for=${t}]`).innerHTML=`${p(s)}`;const n=document.getElementById(t);n.addEventListener("click",i=>{D[e]=i.target.checked,Ut(),b()}),n.checked=D[e]}function $e(t,e,s,n=""){let i=document.querySelector(`label[for=spn-${t}]`);i.innerHTML=`${p(s)} ${D[e]}${n}`;let l=document.getElementById(`spn-${t}`);l.setAttribute("value",D[e]),l.addEventListener("change",r=>{pl(e,parseInt(r.target.value,10)),i=document.querySelector(`label[for=spn-${t}`),i.innerHTML=`${p(s)} ${D[e]}${n}`,b()})}function oa(t){return sa(t)}function aa(){document.body.addEventListener("contextmenu",n=>{n.preventDefault()}),window.addEventListener("resize",()=>{Ms(),zi()}),document.getElementById("rg2-left-info-panel-body").addEventListener("scroll",n=>{document.getElementById("rg2-info-panel").setAttribute(Ei(),n.target.scrollTop)}),ga(),h.managing()||la(),yn(),document.getElementById("rg2-logo").addEventListener("click",()=>{pi.toggle()}),document.querySelector("#rg2-info-panel-tab-headers").querySelectorAll('button[data-bs-toggle="tab"]').forEach(n=>{n.addEventListener("shown.bs.tab",i=>{ya(i)})}),ms.addEventListener("click",()=>{yn(),ms.classList.add("d-none")}),fa()}function da(){if(h.managing())return;let t=document.getElementById("rg2-event-list");t.innerHTML=Qa();let e=document.getElementById("rg2-event-table"),s=document.getElementById("rg2-event-search");s.innerHTML=`<form class="d-flex pb-2" role="search">
  <input class="form-control mr-2" type="search" aria-label="${p("Search")}">
  <i class="bi-search ms-2 mt-2"></i>
  </form>`,s.addEventListener("keyup",n=>{let i=n.target.value.toUpperCase(),l=e.getElementsByTagName("tr");for(let r=0;r<l.length;r+=1)l[r].innerText.toUpperCase().indexOf(i)>-1?l[r].classList.remove("d-none"):l[r].classList.add("d-none")}),e.addEventListener("click",n=>{const i=n.target.closest("tr"),l=parseInt(i.dataset.kartatid,10);isNaN(l)||vt(l)})}function ca(){Re.style.width="800px",As.innerHTML="RG2 Version "+h.RG2VERSION,document.getElementById("rg2-about-dialog").classList.remove("d-none"),document.getElementById("rg2-option-controls").classList.add("d-none"),document.getElementById("rg2-stats-dialog").classList.add("d-none");let t=document.getElementById("rg2-event-stats");t.innerHTML=ld(),document.getElementById("rg2-manager-link").innerHTML=`<a href="${rg2Config.api_url.replace("rg2api.php","?manage")}">Manager Login</a>`,Rs.show()}function yn(){pi.show()}function ua(){Re.style.width="420px",As.innerHTML=p("Configuration options"),document.getElementById("rg2-about-dialog").classList.add("d-none"),document.getElementById("rg2-option-controls").classList.remove("d-none"),document.getElementById("rg2-stats-dialog").classList.add("d-none"),ra(),Rs.show()}function vn(t){Re.style.width="1000px",As.innerHTML=qo(),document.getElementById("rg2-stats-dialog").innerHTML=zo(),document.getElementById("rg2-about-dialog").classList.add("d-none"),document.getElementById("rg2-option-controls").classList.add("d-none"),document.getElementById("rg2-stats-dialog").classList.remove("d-none"),oa(t)&&Rs.show()}function Ze(){return document.querySelector("#rg2-info-panel-tab-headers button.active").id}function En(t){let e='<div id="rg2-info-panel">';e+='<div class="tab-content" id="rg2-info-panel-tab-body">';for(let s=0;s<t.length;s=s+1){const n=document.getElementById(t[s].body),i=t[s].active?" active show":"";e+=`<div class="tab-pane fade ${i}" id="rg2-${t[s].name}-body" role="tabpanel" 
    aria-labelledby="${t[s].name}" tabindex="${s}">${n.innerHTML}</div>`,n.remove()}return e+="</div></div>",e}function xn(t){let e='<ul class="nav nav-pills" id="rg2-info-panel-tab-headers" role="tablist">';for(let s=0;s<t.length;s=s+1){const n=t[s].hidden?" d-none":"",i=t[s].active?" active":"",l=t[s].disabled?" disabled ":"";e+=`
    <li class="nav-item" role="presentation">
      <button class="nav-link${i}${n}"${l}id="${t[s].name}" data-bs-toggle="tab"
      data-bs-target="#rg2-${t[s].name}-body"
        type="button" role="tab"><div id="${t[s].name}-label">${p(t[s].title)}</div>
      </button>
    </li>`}return e+="</ul>",e}function yi(){return`<i class="bi-emoji-smile rg2-run-green"></i> ${D.maxSpeed.toFixed(1)} min/km`}function vi(){return`<i class="bi-emoji-smile rg2-run-red"></i> ${D.minSpeed.toFixed(1)} min/km`}function Ei(){return`scroll-${Ze()}`}function ha(t){D.maxSpeed=t.detail.value1,D.minSpeed=t.detail.value2;const e=document.getElementById("rg2-min-gps-speed-label");e.innerHTML=vi();const s=document.getElementById("rg2-max-gps-speed-label");s.innerHTML=yi(),Co(),b()}function fa(){document.getElementById("btn-about").addEventListener("click",e=>{ca()}),document.getElementById("btn-settings").addEventListener("click",e=>{ua()}),document.getElementById("btn-splitsbrowser").addEventListener("click",()=>{window.open(rg2Config.api_url+"?type=splitsbrowser&id="+Oe()+"&_="+Date.now())}),document.getElementById("btn-measure").setAttribute("disabled",""),document.getElementById("btn-runners").setAttribute("disabled","");const t=document.getElementById("btn-toggle-controls");t.setAttribute("disabled",""),t.addEventListener("click",()=>{z.toggleControlDisplay(),b()})}function ga(){const t=[{name:h.TAB_EVENTS,title:"Events",body:"rg2-event-body",active:!0},{name:h.TAB_COURSES,title:"Courses",body:"rg2-course-body",disabled:!0},{name:h.TAB_RESULTS,title:"Results",body:"rg2-result-body",disabled:!0},{name:h.TAB_DRAW,title:"Draw",body:"rg2-draw-body",disabled:!0}],e=[{name:h.TAB_LOGIN,title:"Login",body:"rg2-login-body",active:!0},{name:h.TAB_CREATE,title:"Add event",body:"rg2-add-event-body",hidden:!0},{name:h.TAB_EDIT,title:"Edit event",body:"rg2-edit-event-body",hidden:!0},{name:h.TAB_MAP,title:"Add map",body:"rg2-add-map-body",hidden:!0},{name:h.TAB_DELETE_MAP,title:"Delete maps",body:"rg2-delete-maps-body",hidden:!0}];h.managing()?(mn.innerHTML=xn(e),pn.innerHTML=En(e)):(mn.innerHTML=xn(t),pn.innerHTML=En(t))}function ma(){gd(),Qn(void 0),document.getElementById("rg2-select-name").setAttribute("disabled",""),Fs()?(document.getElementById("rg2-name-select").classList.remove("d-none"),document.getElementById("rg2-enter-name-and-time").classList.add("d-none")):(document.getElementById("rg2-name-select").classList.add("d-none"),document.getElementById("rg2-enter-name-and-time").classList.remove("d-none")),At("chk-align-map","alignMap","Align map to next control"),document.getElementById("btn-three-seconds").setAttribute("disabled",""),document.getElementById("btn-undo").setAttribute("disabled",""),document.getElementById("btn-save-route").setAttribute("disabled",""),document.getElementById("btn-reset-drawing").setAttribute("disabled",""),document.getElementById("rg2-load-gps-file").setAttribute("disabled",""),document.getElementById("btn-autofit-gps").setAttribute("disabled",""),document.getElementById("btn-undo-gps-adjust").setAttribute("disabled",""),document.getElementById("btn-save-gps-route").setAttribute("disabled",""),document.getElementById("chk-move-all").checked=!1}function Ms(){const t=document.getElementById("rg2-header-container").offsetHeight,e=ia()?document.getElementById("rg2-animation-controls").offsetHeight:0;Ve.style.top=`${t}px`,Re.style.top=`${t}px`,Ve.style.bottom=`${e}px`,Re.style.bottom=`${e}px`,Ve.style.maxWidth=`${window.innerWidth}px`,Re.style.maxWidth=`${window.innerWidth}px`,document.getElementById("rg2-track-names").style.maxHeight=`${window.innerHeight-t-10}px`}function pa(){document.querySelectorAll(".showcourse").forEach(u=>{u.addEventListener("click",g=>{const v=parseInt(g.target.dataset.courseid,10);Et(v,g.target.checked);const k=document.querySelectorAll(".showcourse");for(let N of k)parseInt(N.dataset.courseid,10)===v&&(N.checked=g.target.checked);const O=document.querySelector(".showallcourses");O.checked=fd(),rt(v),Js(Tn()),b()})}),document.querySelector(".showallcourses").addEventListener("click",u=>{Ri(u.target.checked);const g=document.querySelectorAll(".showcourse");for(let v of g)v.checked=u.target.checked;Cn(),Js(Tn()),b()}),document.querySelectorAll(".showscorecourse").forEach(u=>{u.addEventListener("click",g=>{io(parseInt(g.target.dataset.courseid,10),g.target.checked),b()})}),document.querySelectorAll(".showtrack").forEach(u=>{u.addEventListener("click",g=>{const v=parseInt(g.target.dataset.id,10);_o(v,g.target.checked);const k=parseInt(g.target.dataset.courseid,10);document.querySelectorAll(".allcoursetracks").forEach(A=>{parseInt(A.dataset.courseid,10)===k&&(A.checked=Qr(k))}),document.querySelectorAll(".alltracks").forEach(A=>{A.checked=ln()}),rt(k),ts(ss()),b()})});const i=document.querySelectorAll(".deleteroute");for(let u of i)u.addEventListener("click",g=>{Sa(parseInt(g.target.dataset.resultidx,10))});const l=document.querySelectorAll(".allcoursetracks");for(let u of l)u.addEventListener("click",g=>{let v=parseInt(g.target.dataset.courseid,10);cn(v,g.target.checked);const k=document.querySelectorAll(".allcoursetracks");for(let A of k)parseInt(A.dataset.courseid,10)===v&&(A.checked=g.target.checked);const O=document.querySelectorAll(".showtrack");for(let A of O)parseInt(A.dataset.courseid,10)===v&&(A.checked=g.target.checked);const N=document.querySelectorAll(".alltracks");for(let A of N)A.checked=ln();rt(v),ts(ss()),b()});const r=document.querySelectorAll(".alltracks");for(let u of r)u.addEventListener("click",g=>{cn(h.DISPLAY_ALL_COURSES,g.target.checked);const v=document.querySelectorAll(".allcoursetracks");for(let O of v)O.checked=g.target.checked;const k=document.querySelectorAll(".showtrack");for(let O of k)O.checked=g.target.checked;Cn(g.target.checked),ts(ss()),b()});const o=document.querySelectorAll(".showreplay");for(let u of o)u.addEventListener("click",g=>{let v=parseInt(g.target.dataset.id,10);g.target.checked?_i(new ni(v)):$i(v);const k=go(v),O=document.querySelectorAll(".allcoursetracksreplay");for(let A of O)parseInt(A.dataset.courseid,10)===k&&(A.checked=rn(k));const N=document.querySelectorAll(".allcoursereplay");for(let A of N)A.checked=nn(k);b()});const f=document.querySelectorAll(".allcoursetracksreplay");for(let u of f)u.addEventListener("click",g=>{let v=parseInt(g.target.dataset.courseid,10);const k=ho(v);Dn(k,g.target.checked);const O=document.querySelectorAll(".showreplay.showtrackreplay");for(let ee of O)parseInt(ee.dataset.courseid,10)===v&&(ee.checked=g.target.checked);const N=document.querySelectorAll(".allcoursetracksreplay");for(let ee of N)parseInt(ee.dataset.courseid,10)===v&&(ee.checked=g.target.checked);let A=document.querySelectorAll(".allcoursereplay");for(let ee of A)parseInt(ee.dataset.courseid,10)===v&&(ee.checked=nn(v));b()});const y=document.querySelectorAll(".allcoursereplay");for(let u of y)u.addEventListener("click",g=>{const v=parseInt(g.target.dataset.courseid,10),k=uo(v);Dn(k,g.target.checked);const O=document.querySelectorAll(".showreplay");for(let A of O)parseInt(A.dataset.courseid,10)===v&&(A.checked=g.target.checked);const N=document.querySelectorAll(".allcoursetracksreplay");for(let A of N)parseInt(A.dataset.courseid,10)===v&&(A.checked=rn(v));b()})}function ya(t){switch(t.target.id){case h.TAB_DRAW:Ri(!1),Wa();break}const e=document.getElementById("rg2-info-panel").getAttribute(Ei());document.getElementById("rg2-left-info-panel-body").scrollTop=e,b()}let In="#ff0000",xi=null,c=new $n;c.routeData=new Gt;let zt=null,$=[],q=[],Ns=[],F=0,Se=0,qe=!1;function va(t,e){Ia(t,e)?(ps($[F],q[F]),_s(F),Se=F,F=Si(F),F===$.length&&document.getElementById("btn-save-route").removeAttribute("disabled")):ps(Math.round(t),Math.round(e)),document.getElementById("btn-undo").removeAttribute("disabled"),b()}function ps(t,e){c.routeData.x.push(t),c.routeData.y.push(e)}function Ea(t,e,s){const n=c.handles.getPreviousLockedHandle(s),i=c.handles.getNextLockedHandle(s);lt(t,e,n,n.time,s.time),lt(t,e,i,s.time,i.time)}function ls(t){c.adjustOffset(t)}function Ii(t,e,s=void 0){if(document.getElementById("chk-move-all").checked||s===h.RIGHT_CLICK)a.translate(e.x-t.x,e.y-t.y);else if(c.handles.handlesLocked()>0)if(c.handles.handlesLocked()===1)lt(t,e,c.handles.getSingleLockedHandle(),c.handles.getStartHandle().time,c.handles.getFinishHandle().time);else{let l=c.handles.getHandleClicked(t);if(l===void 0||l.locked)return;const r=c.handles.getEarliestLockedHandle(),o=c.handles.getLatestLockedHandle();r.time>=l.time?lt(t,e,r,c.handles.getStartHandle().time,r.time):o.time<l.time?lt(t,e,o,o.time,c.handles.getFinishHandle().time):Ea(t,e,l)}else La(e.x-t.x,e.y-t.y)}function _s(t){if(D.alignMap){let e;t<$.length-1&&(qe?e=Pe($[t],q[t],$[t+1],q[t+1]):e=Ns[t],Xt(e+Math.PI/2,$[t],q[t]))}else Xt(0,$[t],q[t],!1)}function xa(){c.autofitTrack()}function Ia(t,e){let s=D.snap?8:2;return Math.abs(t-$[F])<s&&Math.abs(e-q[F])<s}function ba(){let t={};t.body="The route you have started to draw will be discarded. Are you sure you want to change the course?",t.title="Confirm course change",t.doText="Change course",t.onDo=Ca,t.onCancel=Ta,ye(t)}function Sa(t){xi=t;let e={};e.body="This route will be permanently deleted. Are you sure?",e.title="Confirm route delete",e.doText="Delete route",e.onDo=ka,ye(e)}function Ta(){document.getElementById("rg2-select-course").value=c.routeData.courseid,document.getElementById("rg2-select-name").value=c.routeData.resultid,zt=null}function Ca(){Ps(),ys(zt)}function ka(){const t=po(xi),e={type:"deletemyroute",id:Oe(),routeid:t.id};pe(JSON.stringify({token:t.token}),e,Na,"Route save failed")}function Ps(){c.routeData.courseid!==null&&Et(c.routeData.courseid,!1),c.routeData.resultid!==null&&at(c.routeData.resultid,!1),Ti()}function bi(){Ua();const t={type:"addroute",id:c.routeData.eventid};pe(JSON.stringify(c.routeData),t,_a(c.routeData.name),"Route save failed"),Ps()}function Da(){c.fileLoaded&&(c.savedBaseX=c.baseX.slice(0),c.savedBaseY=c.baseY.slice(0),c.baseX=c.routeData.x.slice(0),c.baseY=c.routeData.y.slice(0),c.handles.saveForUndo(),c.handles.rebaselineXY(),document.getElementById("btn-undo-gps-adjust").removeAttribute("disabled"))}function La(t,e){for(let s=0;s<c.baseX.length;s+=1)c.routeData.x[s]=c.baseX[s]+t,c.routeData.y[s]=c.baseY[s]+e;c.handles.dragHandles(t,e)}function rs(t){a.arc($[F],q[F],t,0,2*Math.PI,!1),a.fill()}function wa(){const t=ft();a.lineWidth=t.overprintWidth,a.strokeStyle=h.RED,a.fillStyle=h.RED_30,F>0&&!c.fileLoaded&&(a.beginPath(),F<$.length-1?rs(t.controlRadius):(rs(t.finishInnerRadius),a.stroke(),a.beginPath(),rs(t.finishOuterRadius)),a.fillRect($[F]-1,q[F]-1,3,3),a.stroke()),a.strokeStyle=In,a.fillStyle=In,a.font="10pt Arial",a.textAlign="left",a.globalAlpha=.6,Ba(),c.handles.drawHandles()}function Ba(){if(c.routeData.x.length>1){a.beginPath(),a.moveTo(c.routeData.x[0],c.routeData.y[0]);for(let t=1;t<c.routeData.x.length;t+=1)a.lineTo(c.routeData.x[t],c.routeData.y[t]);a.stroke()}}function Aa(){return{x:$,y:q}}function Si(t){const e=c.routeData.splits;if(e.length===2)return t+1;for(let s=t+1;s<e.length;s+=1)if(e[s]!==e[s-1])return s;return e.length}function Ra(t){const e=c.routeData.splits;if(e.length===2)return t-1;for(let s=t-1;s>0;s-=1)if(e[s]!==e[s-1])return s;return 0}function Ma(){return c.fileLoaded}function Na(t){t.ok?(I(p("Route deleted"),p("Route has been deleted")),gl({eventid:parseInt(t.eventid,10),id:parseInt(t.routeid,10)}),Je()):I(p("Delete failed"),p("Delete failed"))}const _a=t=>e=>{e.ok?Ha(e,t):I(t,p("Your route was not saved. Please try again"))};function ys(t){zt=null,c.routeData=new Gt,c.routeData.eventid=Oe(),c.routeData.courseid=t;const e=me(t);qe=e.isScoreCourse,qe||(Et(t,!0),c.routeData.coursename=e.name,e.excludeType===h.EXCLUDED_ZERO_SPLITS?c.routeData.controlsToAdjust=e.exclude.indexOf(!0):c.routeData.controlsToAdjust=e.x.length-1,$=e.x.slice(),q=e.y.slice(),c.routeData.x.length=0,c.routeData.y.length=0,c.routeData.x[0]=$[0],c.routeData.y[0]=q[0],c.routeData.controlx=$.slice(),c.routeData.controly=q.slice(),Ns=e.angle.slice()),document.getElementById("rg2-select-course").value=c.routeData.courseid,Qn(t),b()}function Ti(){c=new $n,c.routeData=new Gt,$.length=0,q.length=0,Ns.length=0,F=0,Se=0,qe=!1,c.initialiseGPS(),ma(),b()}function Pa(t,e,s){if(Ze()===h.TAB_DRAW)if(c.fileLoaded){const i=c.handles.getHandleClicked({x:t,y:e});if(i!==void 0)s===h.RIGHT_CLICK&&i.index!==0&&i.index!==c.handles.length?i.locked?c.handles.unlockHandle(i.index):c.handles.deleteHandle(i.index):i.locked?c.handles.unlockHandle(i.index):c.handles.lockHandle(i.index);else for(let l=0;l<c.baseX.length;l+=1)if(c.baseX[l]+3>=t&&c.baseX[l]-3<=t&&c.baseY[l]+3>=e&&c.baseY[l]-3<=e){c.handles.addHandle(t,e,l);break}}else c.routeData.resultid!==null&&c.routeData.courseid!==null?va(t,e):I("No course/name","Please select course, name and time before you start drawing a route or upload a file.")}function Fa(t){c.readGPS(t)}function Oa(){let t={};t.body="All information you have entered will be removed. Are you sure you want to reset?",t.title="Confirm reset",t.doText="Reset",t.onDo=Ps,ye(t)}function $a(t,e,s){let n={};return n.x=Math.cos(s)*t-Math.sin(s)*e,n.y=Math.sin(s)*t+Math.cos(s)*e,n}function Ha(t,e){I(e,p("Your route has been saved")),ml({eventid:parseInt(t.eventid,10),id:t.newid,token:t.token}),vt(Oe())}function Xa(){const t=c.routeData.time[c.routeData.time.length-1]-c.routeData.time[0];c.routeData.totaltime=_(t);const s=new Date().getTimezoneOffset()*60;c.routeData.startsecs=c.routeData.time[0]-s;for(let n=0;n<c.routeData.x.length;n+=1)c.routeData.x[n]=Math.round(c.routeData.x[n]),c.routeData.y[n]=Math.round(c.routeData.y[n]),c.routeData.time[n]-=c.routeData.startsecs;for(c.routeData.resultid+=h.GPS_RESULT_OFFSET;ko(c.routeData.resultid);)c.routeData.resultid+=h.GPS_RESULT_OFFSET,c.routeData.name+="*";c.routeData.comments=document.getElementById("rg2-new-comments").value,document.getElementById("btn-undo-gps-adjust").setAttribute("disabled",""),bi()}function Va(){c.routeData.comments=document.getElementById("rg2-new-comments").value,c.routeData.controlx=$,c.routeData.controly=q,c.routeData.controlx.splice(0,1),c.routeData.controly.splice(0,1),bi()}function lt(t,e,s,n,i){const l=J(e.x,e.y,s.x,s.y)/J(t.x,t.y,s.x,s.y),r=Pe(e.x,e.y,s.x,s.y)-Pe(t.x,t.y,s.x,s.y);for(let o=n;o<=i;o+=1){const f=$a(c.baseX[o]-s.x,c.baseY[o]-s.y,r);c.routeData.x[o]=f.x*l+s.x,c.routeData.y[o]=f.y*l+s.y}c.handles.alignHandles(c.routeData)}function Ua(){for(let t=c.routeData.x.length-1;t>0;t-=1)c.routeData.x[t]=c.routeData.x[t]-c.routeData.x[t-1],c.routeData.y[t]=c.routeData.y[t]-c.routeData.y[t-1];for(let t=c.routeData.time.length-1;t>0;t-=1)c.routeData.time[t]=c.routeData.time[t]-c.routeData.time[t-1]}function Ga(t){isNaN(t)||(c.routeData.courseid!==null?c.routeData.x.length>1?(zt=t,ba()):(c.routeData.resultid!==null&&at(c.routeData.resultid,!1),Et(c.routeData.courseid,!1),ys(t)):ys(t))}function Ya(t){if(!isNaN(t)){const e=ei(t);if(e.hasValidTrack){const s=p("If you draw a new route it will overwrite the old route for this runner.")+" "+p("GPS routes are saved separately and will not be overwritten.");I(p("Route already drawn"),s)}c.routeData.resultid!==null&&at(c.routeData.resultid,!1),c.routeData.resultid=e.resultid,c.routeData.name=e.name,c.routeData.splits=e.splits,qe?(at(e.resultid,!0),$=e.scorex,q=e.scorey,c.routeData.x.length=0,c.routeData.y.length=0,c.routeData.x[0]=$[0],c.routeData.y[0]=q[0],c.routeData.controlx=$,c.routeData.controly=q,F=1,b()):(F=Si(0),Se=0),_s(0),Ci()}}function bn(){const t=document.getElementById("rg2-name-entry"),e=t.value.trim();e?t.classList.add("is-valid"):t.classList.remove("is-valid");const s=document.getElementById("rg2-time-entry");let n=s.value.trim();if(n.match(/\d+[:.][0-5]\d$/)?s.classList.add("is-valid"):(s.classList.remove("is-valid"),n=null),e&&n&&c.routeData.courseid!==null){n=n.replace(".",":"),c.routeData.name=e,c.routeData.resultid=0,c.routeData.totaltime=n,c.routeData.startsecs=0,c.routeData.time[0]=ve(n),c.routeData.totalsecs=ve(n),F=1;const i=Sd(c.routeData.courseid),l=i[i.length-1];let r=[];for(let o=0;o<i.length;o=o+1)r[o]=parseInt(i[o]/l*c.routeData.totalsecs,10);c.routeData.splits=r,Se=0,b(),Ci()}}function Wa(){c.routeData.courseid!==null&&(qe?at(c.routeData.resultid,!0):Et(c.routeData.courseid,!0))}function Ci(){document.getElementById("btn-three-seconds").removeAttribute("disabled"),document.getElementById("btn-reset-drawing").removeAttribute("disabled",""),document.getElementById("rg2-load-gps-file").removeAttribute("disabled"),b()}function ja(){c.baseX=c.savedBaseX.slice(0),c.baseY=c.savedBaseY.slice(0),c.routeData.x=c.savedBaseX.slice(0),c.routeData.y=c.savedBaseY.slice(0),c.handles.undo(),document.getElementById("btn-undo-gps-adjust").setAttribute("disabled",""),b()}function qa(){const t=c.routeData.x.length;t>1&&($[Se]===c.routeData.x[t-1]&&q[Se]===c.routeData.y[t-1]&&(F===$.length&&document.getElementById("btn-save-route").setAttribute("disabled",""),F=Se,Se=Ra(F),_s(F-1)),c.routeData.x.pop(),c.routeData.y.pop()),c.routeData.x.length>1?document.getElementById("btn-undo").removeAttribute("disabled"):document.getElementById("btn-undo").setAttribute("disabled",""),b()}function za(){ps(c.routeData.x[c.routeData.x.length-1],c.routeData.y[c.routeData.y.length-1]),b()}let Ka=class{constructor(e){switch(this.kartatid=e.id,this.mapid=e.mapid,this.format=e.format,this.name=e.name,this.date=e.date,this.club=e.club,this.rawtype=e.type,e.type){case"I":this.type="International event";break;case"N":this.type="National event";break;case"R":this.type="Regional event";break;case"L":this.type="Local event";break;case"T":this.type="Training event";break;default:this.type="Unknown";break}this.comment=e.comment,this.locked=e.locked,this.courses=0,e.suffix===void 0?this.mapfilename=this.mapid+".jpg":this.mapfilename=this.mapid+"."+e.suffix,this.worldfile=new fe(e)}},w=[],R=null,vs=!1;function Za(t){const e=document.querySelectorAll("#rg2-event-table tr");for(let n of e)parseInt(n.dataset.kartatid,10)===t?n.classList.add("table-success"):n.classList.remove("table-success");const s=document.getElementById("btn-splitsbrowser");rg2Config.enable_splitsbrowser&&Fs()?s.classList.remove("d-none"):s.classList.add("d-none"),document.getElementById("btn-toggle-controls").removeAttribute("disabled"),document.getElementById("btn-runners").removeAttribute("disabled"),document.getElementById("btn-measure").removeAttribute("disabled")}function Ja(t){Jt(null),Vt({type:"event",id:t},ad,"Event request failed")}function Je(){Vt({type:"events"},dd,"Events request failed")}function ki(){return R===null?!1:w[R].locked}function Qa(){let t="<table class='table table-striped table-hover table-sm'><tbody id='rg2-event-table'>";for(let e=w.length-1;e>=0;e-=1){let s=p(w[e].type,"")+": "+w[e].date;w[e].comment!==""&&(s+=": "+w[e].comment);let n="";w[e].comment!==""&&(n=`<i class='bi-info-circle' id='info-${e}'></i>`);let i="";w[e].worldfile.valid&&(i=`<i class='bi-globe' id='info-${e}'></i>`);let l="";w[e].locked&&(l=`<i class='bi-lock-fill' id='info-${e}'></i>`),t+=`<tr data-kartatid="${w[e].kartatid}"><td class="event-date">${w[e].date}</td><td title='${s}'>`,t+=`${w[e].name} ${l} ${i} ${n}</td ></tr >`}return t+="</tbody></table>",t}function ed(){return R!==null?w[R].date:""}function Di(){return R}function td(){if(R!==null)return w[R].kartatid}function sd(){return R!==null?w[R].name:"Routegadget 2"}function nd(){return R!==null?w[R].mapid:null}function id(t){for(let e=0;e<w.length;e+=1)if(w[e].kartatid===t)return e}function Fs(){return R!==null?w[R].format===h.FORMAT_NORMAL||w[R].format===h.FORMAT_SCORE_EVENT:!0}function Os(t){t=t||Oe();const e=id(t);let s=w[e];return s.id=e,s.controls=z.getControlCount(),s.exclude=kd(),s}function ld(){if(R===null)return"";const t=Oe(),e=Os(parseInt(t,10));let s=`<div class='fs-4 fw-bolder pb-3'>${p("Event statistics")}</div>`;return s+="<table class='table table-sm table-striped-columns table-bordered'><tbody>",s+=`<tr><td>${p("Event")}</td><td>${e.name}:${e.date}</td></tr>`,e.comment&&(s+=`<tr><td>${p("Comments")}</td><td>${e.comment}</td></tr>`),s+=xo(e.controls,e.worldfile.valid),s+="</tbody></table>",s+='<hr class="border border-primary opacity-75" />',s+=fo(),s=s.replace(/&amp;/g,"&"),s}function Oe(){return R===null?null:w[R].kartatid}function rd(){return R===null||!Zt()?"px":"m"}function od(t){for(let e=0;e<w.length;e+=1)if(w[e].kartatid===t)return w[e].mapfilename;return""}function Kt(){if(R===null||!Zt())return;const t=ke(),e=J(0,0,t.width,t.height),s=w[R].worldfile,n=s.C,i=s.F,l=s.A*t.width+s.B*t.height+s.C,r=s.D*t.width+s.E*t.height+s.F;return cs(i,n,r,l)/e}function Li(){return R===null?null:w[R].worldfile}function ad(t,e){vs=!1,Tl(e),Jt(e),$s(),Rd(t.courses),Lo(t.results),wo(t.routes),Ti(),Za(e)}function dd(t){w.length=0,R=null;for(const s of t.events)w.push(new Ka(s));da();const e=xl();e&&vt(e),h.managing()&&er(w)}function dt(){return R!==null?w[R].format===h.FORMAT_SCORE_EVENT||w[R].format===h.FORMAT_SCORE_EVENT_NO_RESULTS:!1}function wi(t){for(let e=0;e<w.length;e+=1)if(w[e].kartatid===t)return!0;return!1}function vt(t){vs||!wi(t)||(vs=!0,Jd(),no(),Bi(),Ws(rg2Config.maps_url+od(t)),document.getElementById("rg2-load-progress-label").textContent=p("Loading event",""),document.getElementById("rg2-load-progress").classList.remove("d-none"),Ja(t),b())}function cd(t){for(let e=0;e<w.length;e+=1)if(w[e].mapid===t)return!0;return!1}function Zt(){return R===null?!1:w[R].worldfile.valid}function Jt(t){R=null;for(let e=0;e<w.length;e+=1)if(w[e].kartatid===t){R=e;break}}function $s(){let t="";t=ed()+" "+ae(sd()),document.title=t,Zt()&&(t="<i class='bi-globe'>&nbsp;</i>"+t),ki()&&(t="<i class='bi-lock-fill'>&nbsp;</i>"+t),document.getElementById("rg2-event-title").innerHTML=t}class ud{constructor(e,s){this.name=e.name,this.trackcount=0,this.display=!1,this.courseid=e.courseid,this.codes=e.codes,this.setExcluded(e),this.filterTo=this.codes.length,this.filterFrom=0,this.x=e.xpos,this.y=e.ypos,this.isScoreCourse=s,this.resultcount=0,this.angle=[],this.textAngle=[],this.setAngles(),this.length=this.setLength()}drawCourse(e){if(this.display){const s=ft();if(a.globalAlpha=e,z.drawStart(this.x[0],this.y[0],"",this.angle[0],s),!this.isScoreCourse){const n={from:this.filterFrom,to:this.filterTo};this.drawLinesBetweenControls({x:this.x,y:this.y},this.angle,s,n)}if(this.isScoreCourse)for(let n=1;n<this.x.length;n+=1)this.codes[n].indexOf("F")===0||this.codes[n].indexOf("M")===0?z.drawFinish(this.x[n],this.y[n],"",s):z.drawSingleControl(this.x[n],this.y[n],this.codes[n],this.textAngle[n],s);else{const n=Math.max(this.filterFrom,1),i=Math.min(this.filterTo+1,this.x.length-1);for(let l=n;l<i;l+=1)z.drawSingleControl(this.x[l],this.y[l],l,this.textAngle[l],s);z.drawFinish(this.x[this.x.length-1],this.y[this.y.length-1],"",s)}}}drawLinesBetweenControls(e,s,n,i){let l;for(let r=i.from;r<i.to;r+=1){r===0?l=n.startTriangleLength:l=n.controlRadius;const o=e.x[r]+l*Math.cos(s[r]),f=e.y[r]+l*Math.sin(s[r]);r===this.x.length-2?l=n.finishOuterRadius:l=n.controlRadius;const y=e.x[r+1]-l*Math.cos(s[r]),u=e.y[r+1]-l*Math.sin(s[r]);a.beginPath(),a.moveTo(o,f),a.lineTo(y,u),a.stroke()}}getLegLengths(){let e=[];if(this.isScoreCourse)return e[1]=1,e;e[0]=0;for(let s=1;s<this.x.length;s+=1)e[s]=parseInt(e[s-1]+J(this.x[s],this.y[s],this.x[s-1],this.y[s-1]),0);return e}incrementTracksCount(){this.trackcount+=1}setAngles(){for(let e=0;e<this.x.length-1;e+=1)if(this.isScoreCourse)this.angle[e]=Math.PI*1.5,this.textAngle[e]=Math.PI*.25;else{this.angle[e]=Pe(this.x[e],this.y[e],this.x[e+1],this.y[e+1]);const s=Math.sin(this.angle[e-1]),n=Math.cos(this.angle[e-1]),i=Math.sin(this.angle[e])+s,l=Math.cos(this.angle[e])+n,r=i/2,o=l/2;this.textAngle[e]=Pe(r,o,s,n)}this.angle[this.x.length-1]=Math.PI*1.5,this.textAngle[this.x.length-1]=Math.PI*1.5}setDisplay(e){this.display=e}setExcluded(e){this.excludeType=e.excludeType,this.exclude=e.codes.map((s,n)=>e.exclude.findIndex(i=>i===n)>-1),this.allowed=e.codes.map((s,n)=>e.exclude.findIndex(i=>i===n)>-1?e.allowed[e.exclude.findIndex(i=>i===n)]:0)}setLength(){let e=0;const s=Kt();if(!(s===void 0||this.isScoreCourse)){for(let n=1;n<this.x.length;n+=1)e+=J(this.x[n],this.y[n],this.x[n-1],this.y[n-1]);if(e!==0)return(e*s/1e3).toFixed(1)}}}let E=[],z,Pt=0,Hs=0,Es=0;function hd(t){E[t.courseid]=new ud(t,dt()),Hs+=1,E[t.courseid].codes!==void 0&&E[t.courseid].codes.length>Es&&(Es=E[t.courseid].codes.length-1)}function fd(){for(let t=0;t<E.length;t+=1)if(E[t]!==void 0&&!E[t].display)return!1;return!0}function gd(){let t=document.getElementById("rg2-select-course");t.innerHTML="",t.options.add(je(null,p("Select course","")));for(let e=0;e<E.length;e=e+1)E[e]!==void 0&&t.options.add(je(e,ae(E[e].name)));t.addEventListener("change",e=>{Ga(parseInt(e.target.value,10))})}function md(){const t=document.getElementById("rg2-course-table");t.innerHTML=xd();const e=document.getElementById("rg2-course-filter-table");e.innerHTML=Ed(),document.querySelectorAll("[data-course-filter]").forEach(n=>{n.addEventListener("change",yd)})}function Bi(){E.length=0,Pt=0,Hs=0,Es=0}function Sn(t){for(let e=0;e<E.length;e+=1)E[e]!==void 0&&E[e].drawCourse(t)}function pd(t,e,s,n,i){E[s].drawLinesBetweenControls(t,e,n,i)}function yd(t){const e=parseInt(t.target.dataset.courseFilter,10);E[e].filterFrom=t.detail.value1,E[e].filterTo=t.detail.value2,b()}function vd(){let t={html:"",res:0,coursecount:0};for(let e=0;e<E.length;e+=1)E[e]!==void 0&&(t.coursecount=t.coursecount+1,t.html+=[`<tr><td>${E[e].name}</td >`,`<td><input class='showcourse' data-courseid=${e} type='checkbox' name='course'></input></td>`,`<td class='text-center'>${E[e].resultcount}</td><td class='text-center'>${E[e].trackcount}</td><td>`].join(""),t.res+=E[e].resultcount,E[e].trackcount>0?(t.html+=`<input data-courseid=${E[e].courseid} class='allcoursetracks' type=checkbox name=track></input></td>`,t.html+=`<td><input data-courseid=${E[e].courseid} class='allcoursetracksreplay' type=checkbox name=replay></input>`):t.html+="</td><td>",t.html+="</td></tr>");return t}function Ed(){let t="";for(let e=0;e<E.length;e+=1)E[e]!==void 0&&!E[e].isScoreCourse&&E[e].codes.length>2&&(t+=[`<div id='course-filter-${E[e].courseid}' data-display="false" data-course="${E[e].courseid}" class="row">`,`<div class="col-3">${E[e].name}</div>`,'<div class="col-9 pt-2">',`  <tc-range-slider step="1" min="0" max="${E[e].codes.length}" value1="0"`,`value2="${E[e].codes.length}" round="0" data-course-filter="${E[e].courseid}>"`,"</tc-range-slider></div></div>"].join(""));return t}function xd(){let t=["<table class='table table-striped table-hover table-sm'><thead>",`<tr><th>${p("Course")}</th><th><i class='bi-eye-fill'></i></th><th>${p("Runners")}</th>`,`<th>${p("Routes")}</th><th><i class='bi-pencil'></i></th><th><i class='bi-play-fill'></i></th></tr>`,'</thead><tbody class="table-group-divider">'].join("");const e=vd();return t+=e.html+`</tbody><tfoot class="table-group-divider"><tr class='allitemsrow'><td>${p("All")}</td>
    <td><input class='showallcourses' data-id="all" type=checkbox name=course></input></td>
    <td class='text-center'>${e.res}</td><td class='text-center'>${Pt}</td><td>`,Pt>0&&(t+=`<input data-id="all" class='alltracks' type=checkbox name=track></input>`),t+="</td><td></td></tr></tfoot></table>",t}function Id(){return E}function me(t){return E[t]}function bd(t){return E.find(e=>e?e.name===t:!1)}function Sd(t){return E[t].getLegLengths()}function Td(t){return E[t].name}function Cd(){let t=[];for(let e=0;e<E.length;e+=1)if(E[e]!==void 0){let s={};s.id=E[e].courseid,s.name=E[e].name,s.results=E[e].resultcount,t.push(s)}return t}function Tn(){let t=[];for(let e=0;e<E.length;e+=1)E[e]!==void 0&&E[e].display&&t.push(e);return t}function kd(){let t="";for(let e=0;e<E.length;e+=1)E[e]!==void 0&&E[e].excludeType!==h.EXCLUDED_NONE&&(t=t+E[e].courseid+"|"+E[e].excludeType,t=t+E[e].exclude.reduce((s,n,i)=>n?s+"|"+i+","+E[e].allowed[i]:s,""),t=t+`
`);return t}function Dd(t){let e={};return e.filterFrom=E[t].filterFrom,e.filterTo=E[t].filterTo,e}function Ld(t){return E[t].codes.length-2}function Ai(){return Hs}function wd(t){E[t].incrementTracksCount(),Pt+=1}function Bd(){z=new bs}function Ad(t){return t in E}function Rd(t){Bi(),z.deleteAllControls(),document.getElementById("rg2-load-progress-label").innerHTML=p("Saving courses");for(const e of t)hd(e);z.generateControlList()}function Ri(t){for(let e=0;e<E.length;e+=1)E[e]!==void 0&&E[e].setDisplay(t)}function Cn(){for(let t=0;t<E.length;t+=1)E[t]!==void 0&&rt(t)}function Et(t,e){E[t]!==void 0&&(E[t].setDisplay(e),rt(t))}function rt(t){t=parseInt(t,10);const e=E[t].display||eo(t);document.querySelectorAll("[data-display]").forEach(s=>{parseInt(s.dataset.course,10)===t&&(s.dataset.display=e)})}function Md(){for(let t=0;t<E.length;t+=1)E[t]!==void 0&&(E[t].resultcount=to(t))}function Nd(t,e,s,n){for(let i=0;i<E.length;i+=1)if(E[i]!==void 0&&E[i].courseid===t){E[i].codes=e,E[i].x=s,E[i].y=n,E[i].setAngles();break}}let T=[],Be={};const os=[100,200,500,1e3,2e3,3e3,5e3,7500,1e4,15e3,2e4,5e4,1e5],_d=100,Pd=50,Ct=20;let Me=!1,Mi="px",ct=3e3,Fe=null,ut=null,Ft=[],X=0,we=0,Le=!1,Ue=0,Ne=0,Xs=60,Ge=0,Ot=!1,H=0,Qe=!1,ot=!1,Ye=!0,We=0,_e=0,$t=null,Q;const Vs=`<i title=${p("Run","")} class="bi-play-circle-fill"></i>`,Ni=`<i title=${p("Start","")} class="bi-triangle"></i>`,Fd=`<i title=${p("Pause","")} class="bi-pause-btn"></i>`,Od=`<i title=${p("Wait","")} class="bi-hourglass-split"></i>`,ze=document.getElementById("rg2-track-names"),kn=document.querySelector("#rg2-track-names .card-body"),$d=document.getElementById("btn-runners"),et=document.getElementById("btn-start-stop");document.querySelector("#rg2-track-names .card-title").innerHTML=p("Runners");document.getElementById("btn-close-track-names").addEventListener("click",()=>{ze.classList.add("d-none")});$d.addEventListener("click",()=>{ze.classList.toggle("d-none")});const Rt=document.getElementById("rg2-replay-by-control");Rt.classList.add("d-none");let kt={x:0,y:0};Mt(ze).draggable({inertia:!0,listeners:{move(t){kt.x+=t.dx,kt.y+=t.dy,t.target.style.transform=`translate(${kt.x}px, ${kt.y}px)`}},modifiers:[Mt.modifiers.restrictRect({restriction:"#rg2-container"})]});function _i(t,e=!0){for(let s=0;s<T.length;s+=1)if(T[s].resultid===t.resultid)return;T.length===0&&(Be=bd(t.coursename)),t.userColour!==null?t.trackColour=t.userColour:t.trackColour=On(),T.push(t),e&&Qt()}function Hd(t){Me=!1,Ft=[];const e=Be.x[t],s=Be.y[t];if(Be.angle.length>=t){const n=Yi();let i=(a.displayAngle-Be.angle[t]-Math.PI/2)%(Math.PI*2);i<-1*Math.PI&&(i=i+2*Math.PI);for(let l=1;l<=Ct;l=l+1){let r={};r.x=n.x-(n.x-e)*l/Ct,r.y=n.y-(n.y-s)*l/Ct,r.angle=(a.displayAngle-i*l/Ct)%(Math.PI*2),Ft.push(r)}ut=setInterval(()=>{Xd()},Pd)}else Xt(0,e,s,!0),ut=null}function Xd(){if(Ft.length===0)clearInterval(ut),ut=null,Me=!0,et.innerHTML=Vs;else{const t=Ft.shift();Xt(t.angle,t.x,t.y)}b()}function Dn(t,e){for(let s=0;s<t.length;s+=1)e?_i(new ni(t[s]),!1):$i(t[s]);Qt()}function Pi(){Ue=86400,Ne=0,_e=0;for(let t=0;t<T.length;t+=1)T[t].starttime<Ue&&(Ue=T[t].starttime),T[t].starttime+T[t].x.length>Ne&&(Ne=T[t].starttime+T[t].x.length),T[t].x.length>_e&&(_e=T[t].x.length)}function Vd(t){if(T.length===0)return;let e=!0;for(let s=0;s<T.length;s+=1)if(T[s].splits[H+1]-T[s].splits[H]>t){e=!1;break}e&&(H+=1,Me=!1,Us(H),Gs())}function Ud(t){t!==X&&xt(t)}function Gd(){let t=document.getElementById("rg2-replay-speed-list"),e="";for(let s=0;s<os.length;s=s+1)e+=`<li class="dropdown-item" data-speed="${os[s]}">${"x"+os[s]/100}</li>`;t.innerHTML=e,document.getElementById("rg2-replay-speed-select").addEventListener("hidden.bs.dropdown",s=>{s.clickEvent&&Vi(parseInt(s.clickEvent.target.dataset.speed,10))})}function Yd(){let t=document.getElementById("rg2-replay-start-control-list"),e="";const n=T.reduce((i,l)=>Math.min(l.splits.length,i),9999);for(let i=0;i<n-1;i=i+1){const l=i===0?`<div>${Ni}</div>`:i;e+=`<li class="dropdown-item" data-control="${i}">${l}</li>`}t.innerHTML=e,document.getElementById("rg2-replay-start-control-select").addEventListener("hidden.bs.dropdown",i=>{i.clickEvent&&(H=parseInt(i.clickEvent.target.dataset.control),isNaN(H)&&(H=0),Us(H),Gs())})}function Wd(){let t=document.getElementById("rg2-tails-length-list"),e="";const s=["0:00","0:30","1:00","1:30","2:00","3:00",p("Full tails","")],n=[0,30,60,90,120,180,"Full"];for(let i=0;i<s.length;i=i+1)e+=`<li class="dropdown-item" data-length="${n[i]}">${s[i]}</li>`;t.innerHTML=e,document.getElementById("rg2-tails-length-select").addEventListener("hidden.bs.dropdown",i=>{i.clickEvent&&nc(i.clickEvent.target.dataset.length)})}function jd(){if(T.length===0)return;if(Q){Q.value!==X&&(Q.value=X);const e=document.getElementById("rg2-clock");e.innerText=al(X)}let t=0;for(let e=0;e<T.length;e+=1){const s=T[e];let n=0;Le?n=s.starttime:H===0||s.splits.length<H?n=0:n=-1*s.splits[H],a.strokeStyle=s.trackColour,a.globalAlpha=D.perCentRouteIntensity/100,a.lineWidth=D.routeWidth,a.beginPath(),a.moveTo(s.x[Ge-n],s.y[Ge-n]);for(let i=Ge;i<X;i+=1)i>n&&i-n<s.nextStopTime&&a.lineTo(s.x[i-n],s.y[i-n]);a.stroke(),a.beginPath(),t=X,t-n<s.nextStopTime?t=t-n:t=s.nextStopTime,a.arc(s.x[t],s.y[t],h.RUNNER_DOT_RADIUS,0,2*Math.PI,!1),a.globalAlpha=h.FULL_INTENSITY,a.strokeStyle=h.BLACK,a.fillStyle=s.trackColour,a.fill(),a.lineWidth=h.RUNNER_DOT_RADIUS/4,a.stroke(),qd(s,t)}ic(t),Qe&&Vd(X)}function qd(t,e){let s="";(ot||Ye)&&e<t.x.length&&e>=0&&(a.fillStyle="black",a.strokeStyle="white",a.font=D.replayFontSize+"pt Arial",a.globalAlpha=h.FULL_INTENSITY,a.textAlign="left",Ye?s=t.initials:s=t.name,a.save(),a.translate(t.x[e],t.y[e]),a.rotate(a.displayAngle),a.lineWidth=D.replayFontSize/8,a.strokeText(s,12,6),a.fillText(s,12,6),a.restore())}function Ln(t,e){const s=T[t].cumulativeDistance;let n=e>s.length-1?s[s.length-1]:s[e];return n===void 0&&(n=0),n}function Fi(t){let e=[];for(let n=0;n<T.length;n+=1){let i={};i.trackColour=T[n].trackColour,i.course=T[n].coursename,i.name=T[n].name,i.resultid=T[n].resultid,i.rawid=T[n].rawid,Le?i.distance=Ln(n,X-T[n].starttime):i.distance=Ln(n,t),i.distance+=Mi,e.push(i)}let s=yo();for(let n=0;n<s.length;n+=1)if(e.findIndex(i=>i.resultid===s[n].resultid)===-1){let i={};i.trackColour=s[n].trackColour,i.course=s[n].course,i.name=s[n].name,i.resultid=s[n].resultid,i.rawid=s[n].rawid,i.distance="",e.push(i)}return e}function zd(t){if(t.length===0)return"";let e="",s="";for(let n=0;n<t.length;n+=1)s!==t[n].course&&(e+=`<div></div><div><strong>${t[n].course}</strong></div><div></div>`,s=t[n].course),e+=`<input type="color" class="form-control form-control-color" data-rawid="${t[n].rawid}"`,e+=` value = "${t[n].trackColour}" ><div>${t[n].name}</div><div class="runner-distance text-end"`,e+=` data-resultid="${t[n].resultid}">${t[n].distance}</div>`;return e}function Kd(){Le?X<Ne&&(we=Math.min(we+ct,Ne*1e3)):X<_e&&(we=Math.min(we+ct,_e*1e3)),X=parseInt(we/1e3,10),Ot?Ge=We+1:Ge=Math.max(X-Xs,We+1),b()}function Zd(){if($t)return;$t=document.getElementById("rg2-animation-controls");const t=document.getElementById("rg2-clock");t.innerText="00:00:00",Oi(0,0,0),Gd(),Vi(ct),et.addEventListener("click",()=>{rc()}),document.getElementById("btn-mass-start").addEventListener("click",()=>{Rt.classList.add("d-none"),ec()});const s=document.getElementById("btn-real-time");s.setAttribute("title",p("Real time","")),s.addEventListener("click",()=>{Rt.classList.add("d-none"),tc()}),document.getElementById("btn-by-control").addEventListener("click",()=>{Qd(),Yd(),Rt.classList.remove("d-none")}),Wd();let i=document.querySelectorAll("[data-toggle-names]");for(let l of i)l.innerHTML=p(l.dataset.toggleNames),l.addEventListener("click",r=>{oc(r.currentTarget.dataset.toggleNames)});document.getElementById("rg2-toggle-names-value").setAttribute("title",p("Show names",""))}function Oi(t,e,s){if(Q&&Q.min===t&&Q.max===e&&Q.value===s)return;Q&&Q.remove();const n=document.getElementById("rg2-clock-slider-container"),i=document.createElement("tc-range-slider");i.setAttribute("id","rg2-clock-slider"),i.setAttribute("min",t),i.setAttribute("max",e),i.setAttribute("value",s),i.setAttribute("step",1),n.append(i),Q=document.getElementById("rg2-clock-slider"),Q.addEventListener("change",l=>{Ud(l.target.value)})}function $i(t){for(let e=0;e<T.length;e+=1)T[e].resultid===t&&T.splice(e,1),T.length===0&&(Be={});Qt()}function Jd(){T.length=0,Be={},ct=3e3,X=0,we=0,Le=!1,Ue=0,Ne=0,Xs=60,Ge=0,Ot=!1,H=0,Qe=!1,ot=!1,Ye=!0,We=0,_e=0,clearInterval(Fe),Fe=null,Qt(),et.innerHTML=Vs,ze.classList.add("d-none")}function Hi(){T.forEach(t=>t.nextStopTime=h.VERY_HIGH_TIME_IN_SECS)}function Xi(t){return T.findIndex(e=>e.resultid===t)>-1}function xt(t){Mi=rd();let e=0;Le?(t>0?X=t:X=Ue,e=Ne,We=Ue):(t>0?X=t:X=0,e=_e,We=0),we=X*1e3,t===0&&Oi(We,e,X),b()}function Us(t){document.getElementById("rg2-replay-start-control").innerHTML=t===0?Ni:t}function Gs(){let t=9999;t=T.reduce((e,s)=>Math.min(s.splits.length,e),t),H>t&&(H=0);for(let e=0;e<T.length;e+=1)H+1<T[e].splits.length?T[e].nextStopTime=T[e].splits[H+1]:T[e].nextStopTime=h.VERY_HIGH_TIME_IN_SECS;xt(0),Ui(),b()}function Qd(){document.getElementById("rg2-clock-slider").setAttribute("disabled",""),Le=!1,H=0,Qe=!0,Me=!1,Us(H),Gs()}function ec(){Le=!1,Qe=!1,H=0,Hi(),xt(0),Q.removeAttribute("disabled")}function tc(){Le=!0,Qe=!1,H=0,Hi(),xt(0),Q.removeAttribute("disabled")}function Vi(t){isNaN(t)&&(t=1e3),ct=t,document.getElementById("rg2-replay-speed").innerText="x"+t/100}function sc(t,e){for(let s=0;s<T.length;s+=1)T[s].rawid===t&&(T[s].userColour=e,T[s].trackColour=e);Ro(t,e)}function nc(t){t==="Full"?Ot=!0:(Xs=parseInt(t,10),Ot=!1),Pi(),b()}function ic(t){const e=Fi(t);if(e.length===0)return;const s=document.querySelectorAll(".track-names .runner-distance");s&&s.forEach(n=>{const i=parseInt(n.dataset.resultid),l=e.findIndex(r=>r.resultid===i);l>-1&&(n.innerText=e[l].distance)})}function lc(){Fe===null&&(Fe=setInterval(()=>{Kd()},_d)),et.innerHTML=Fd}function Ui(){clearInterval(Fe),Fe=null,et.innerHTML=Vs}function rc(){Fe===null?(Qe?!Me&&ut===null&&(Hd(H),et.innerHTML=Od):Me=!0,Me&&lc()):Ui()}function oc(t){switch(document.getElementById("rg2-toggle-names-value").setAttribute("title",p(t,"")),t){case"Show names":ot=!0,Ye=!1;break;case"Show initials":ot=!1,Ye=!0;break;default:ot=!1,Ye=!1;break}b()}function Qt(){Zd(),Ys(),T.length>0?$t.classList.remove("d-none"):$t.classList.add("d-none"),Ms(),Pi(),xt(0)}function Ys(){const t=Fi(X);return t.length>0?(kn.innerHTML=zd(t),document.querySelectorAll(".track-names input").forEach(s=>{s.addEventListener("input",n=>{sc(parseInt(n.target.dataset.rawid,10),n.target.value),b()})}),ze.classList.remove("d-none")):(kn.innerHTML="",ze.classList.add("d-none")),t.length}class ac{constructor(e){this.ctx=e,this.measuring=!1,this.dragging=!1,this.colours=["#ff00ff","#0000ff","#00ff00","#ff0000","#00ffff"],this.colourIndex=0,this.overlays=[],this.currentOverlay=this.initialiseOverlay(),this.units="px",this.metresPerPixel=1,this.dotSize=5,this.lineWidth=3,this.measureDialog=document.getElementById("rg2-measure-dialog"),document.getElementById("btn-measure").addEventListener("click",()=>{Di()!==null&&(document.getElementById("rg2-map-canvas").style.cursor="crosshair",this.measureDialog.classList.remove("d-none"),this.measuring=!0,this.createMeasureDialog(),b())}),document.getElementById("btn-close-measure-dialog").addEventListener("click",()=>{this.measuring=!1,this.measureDialog.classList.add("d-none"),document.getElementById("rg2-map-canvas").style.cursor="auto",b()}),document.getElementById("btn-measure").addEventListener("click",()=>{document.getElementById("rg2-map-canvas").style.cursor="crosshair",this.measureDialog.classList.remove("d-none"),this.measuring=!0,this.createMeasureDialog(),b()});let s={x:0,y:0};Mt(this.measureDialog).draggable({inertia:!0,listeners:{move(n){s.x+=n.dx,s.y+=n.dy,n.target.style.transform=`translate(${s.x}px, ${s.y}px)`}},modifiers:[Mt.modifiers.restrictRect({restriction:"#rg2-container"})]}),this.createMeasureDialog()}calculateLength(e,s){if(e.length<2)return 0;let n=0;for(let i=1;i<e.length;i+=1)n=n+J(e[i-1],s[i-1],e[i],s[i]);return n}closeEnough(e,s,n,i){return Math.abs(e-n)<10&&Math.abs(s-i)<10}createMeasureDialog(){this.metresPerPixel=Kt(),this.metresPerPixel===void 0?(this.metresPerPixel=1,this.units="px"):this.units="m";let e="";for(let l=0;l<this.overlays.length;l+=1)e=e+this.formatOverlay(this.overlays[l],!0);e=e+this.formatOverlay(this.currentOverlay,!1),this.overlays.length>1&&(e+=`<div>${p("All")}</div><div></div><div></div>`,e+="<div><i class='delete-all-overlays bi-trash'></i></div>"),document.querySelector(".rg2-overlay-table").innerHTML=e;let s=document.getElementsByClassName("delete-overlay");for(let l of s)l.addEventListener("click",r=>{this.deleteOverlay(parseInt(r.target.id,10))});let n=document.getElementsByClassName("delete-all-overlays");for(let l of n)l.addEventListener("click",r=>{this.deleteAllOverlays(parseInt(r.target.id,10))});let i=document.getElementsByClassName("end-overlay");for(let l of i)l.addEventListener("click",r=>{this.endOverlay(parseInt(r.target.id,10))})}deleteAllOverlays(){this.overlays.length=0,this.currentOverlay=this.initialiseOverlay(),this.updateOverlays(),this.createMeasureDialog(),b()}deleteOverlay(e){this.overlays.splice(e,1),this.updateOverlays(),this.createMeasureDialog(),b()}dragEnded(){this.dragging=!1}drawSingleOverlay(e,s){this.ctx.strokeStyle=e.colour,this.ctx.fillStyle=e.colour,this.ctx.beginPath(),this.ctx.moveTo(e.x[0],e.y[0]);for(let n=1;n<e.x.length;n+=1)this.ctx.lineTo(e.x[n],e.y[n]);this.ctx.stroke();for(let n=0;n<e.x.length;n+=1)this.ctx.beginPath(),this.ctx.arc(e.x[n],e.y[n],this.dotSize,0,2*Math.PI,!1),s?this.ctx.fill():this.ctx.stroke()}drawOverlays(){if(this.measuring){if(this.ctx.lineWidth=this.lineWidth,this.ctx.globalAlpha=.6,this.overlays.length>0)for(let e=0;e<this.overlays.length;e+=1)this.drawSingleOverlay(this.overlays[e],!0);this.currentOverlay.started&&(this.currentOverlay.x.length===1?(this.ctx.strokeStyle=this.currentOverlay.colour,this.ctx.fillStyle=this.currentOverlay.colour,this.ctx.beginPath(),this.ctx.arc(this.currentOverlay.x[0],this.currentOverlay.y[0],this.dotSize,0,2*Math.PI,!1),this.ctx.stroke()):this.drawSingleOverlay(this.currentOverlay,!1))}}endOverlay(){this.currentOverlay.idx=this.overlays.length,this.overlays.push(this.currentOverlay),this.currentOverlay=this.initialiseOverlay(),this.createMeasureDialog()}formatOverlay(e,s){let n="",i="",l="";return e.started?l=`<div>${parseInt(e.length,10)}${this.units}</div>`:l="<div></div>",s?i=`<div><i class='delete-overlay bi-trash' id="${e.idx}"></i></div>`:e.started?i=`<div><i class='end-overlay bi-save' id="${e.idx}"></i></div>`:i="<div></div>",n+=`<div>${e.id}</div><div class='overlay-bar' style='--overlay-colour:${e.colour};'></div>`,n+=`${l}${i}`,n}getNextColour(){return this.colourIndex=(this.colourIndex+1)%this.colours.length,this.colours[this.colourIndex]}initialiseOverlay(){const e={};return e.id=String.fromCharCode(this.overlays.length+65),e.colour=this.getNextColour(),e.x=[],e.y=[],e.length=0,e.started=!1,e.idx=void 0,e}mouseDrag(e,s){if(!this.measuring)return!1;if(!this.dragging)for(let n=0;n<this.overlays.length;n+=1)for(let i=0;i<this.overlays[n].x.length;i+=1)this.closeEnough(e.x,e.y,this.overlays[n].x[i],this.overlays[n].y[i])&&(this.dragging=!0,this.dragOverlay=n,this.dragPoint=i);return this.dragging?(this.overlays[this.dragOverlay].x[this.dragPoint]=parseInt(s.x,10),this.overlays[this.dragOverlay].y[this.dragPoint]=parseInt(s.y,10),this.overlays[this.dragOverlay].length=this.calculateLength(this.overlays[this.dragOverlay].x,this.overlays[this.dragOverlay].y)*this.metresPerPixel,this.createMeasureDialog(),!0):!1}mouseUp(e,s){this.measuring&&(this.dragging=!1,this.currentOverlay.started||this.startOverlay(),e===this.currentOverlay.x[this.currentOverlay.x.length-1]&&s===this.currentOverlay.y[this.currentOverlay.x.length-1]?this.endOverlay():(this.currentOverlay.x.push(e),this.currentOverlay.y.push(s),this.currentOverlay.length=this.calculateLength(this.currentOverlay.x,this.currentOverlay.y)*this.metresPerPixel,this.createMeasureDialog(),b()))}startOverlay(){this.currentOverlay.started=!0,this.createMeasureDialog()}updateOverlays(){this.colourIndex=0;for(let e=0;e<this.overlays.length;e+=1)this.overlays[e].id=String.fromCharCode(e+65),this.overlays[e].idx=e,this.overlays[e].colour=this.getNextColour();this.currentOverlay.id=String.fromCharCode(this.overlays.length+65),this.currentOverlay.idx=this.overlays.length,this.currentOverlay.colour=this.getNextColour()}}let W=document.getElementById("rg2-map-canvas"),a=W.getContext("2d");a.displayAngle=0;let oe=new Image,Ht=new ac(a),x={dragStart:null,dragged:!0,scaleFactor:1.1,pinched:!1},as;document.getElementById("rg2-load-progress").classList.add("d-none");document.getElementById("rg2-map-load-progress").classList.add("d-none");function dc(){W.addEventListener("touchstart",pc,!1),W.addEventListener("touchmove",mc,!1),W.addEventListener("touchend",gc,!1),W.addEventListener("DOMMouseScroll",wn,!1),W.addEventListener("wheel",wn,!1),W.addEventListener("mousedown",uc,!1),W.addEventListener("mousemove",hc,!1),W.addEventListener("mouseup",fc,!1),oe.addEventListener("load",()=>vc());let t=document.getElementById("btn-zoom-in");t.addEventListener("click",()=>ht(1)),t=document.getElementById("btn-zoom-out"),t.addEventListener("click",()=>ht(-1)),t=document.getElementById("btn-rotate-left"),t.addEventListener("click",()=>Bn(-1)),t=document.getElementById("btn-rotate-right"),t.addEventListener("click",()=>Bn(1)),t=document.getElementById("btn-reset"),t.addEventListener("click",()=>js())}function Xt(t,e,s,n=!0){Gi((a.displayAngle-t)%(Math.PI*2),e,s,n)}function Gi(t,e,s,n){if(a.displayAngle=(a.displayAngle-t)%(Math.PI*2),a.translate(e,s),a.rotate(t),n){const i=Yi();a.translate(i.x-e,i.y-s)}else a.translate(-1*e,-1*s);a.save(),b()}function Yi(){return a.transformedPoint(W.width/2,W.height*.9)}function cc(){!h.managing()&&window.innerWidth>=h.BIG_SCREEN_BREAK_POINT&&(a.font="30pt Arial",a.textAlign="left",a.fillStyle=h.BLACK,a.fillText(p("Select an event",""),20,W.height/2))}function ke(){return{height:oe.height,width:oe.width}}function Wi(t){x.dragStart=a.transformedPoint(x.lastX,x.lastY),x.dragged=!1,x.whichButton=t.which}function ji(){if(x.dragStart){const t=a.transformedPoint(x.lastX,x.lastY);t.x=Math.round(t.x),t.y=Math.round(t.y);const e={x:Math.round(x.dragStart.x),y:Math.round(x.dragStart.y)};Math.abs(t.x-e.x)+Math.abs(t.y-e.y)>5&&(Ma()?Ii(e,t,x.whichButton):Ze()===h.TAB_CREATE?Ml(e,t,x.whichButton):Ht.mouseDrag(e,t)||a.translate(t.x-x.dragStart.x,t.y-x.dragStart.y),x.dragged=!0,b())}}function qi(t){const e=Ze();x.dragged?e===h.TAB_CREATE?Cr():e===h.TAB_DRAW?Da():Ht.dragEnded():e===h.TAB_CREATE?Dr(Math.round(x.dragStart.x),Math.round(x.dragStart.y)):e===h.TAB_DRAW?Pa(Math.round(x.dragStart.x),Math.round(x.dragStart.y),t.which):Ht.mouseUp(Math.round(x.dragStart.x),Math.round(x.dragStart.y)),x.dragStart=null,b()}function uc(t){return Ki(t),Wi(t),t.stopPropagation(),t.preventDefault()}function hc(t){return Ki(t),ji(),t.stopPropagation(),t.preventDefault()}function fc(t){return qi(t),t.stopPropagation(),t.preventDefault()}function wn(t){const e=t.wheelDelta?t.wheelDelta/40:t.detail?-t.detail:0;return e&&ht(e),t.stopPropagation(),t.preventDefault()}function gc(t){qi(t),x.pinched=!1}function mc(t){if(t.touches.length>1?x.pinched||Zi(t):x.pinched=!1,x.pinched&&t.touches.length>1){x.pinchEnd0=a.transformedPoint(t.touches[0].pageX,t.touches[0].pageY),x.pinchEnd1=a.transformedPoint(t.touches[1].pageX,t.touches[1].pageY);const e=J(x.pinchStart0.x,x.pinchStart0.y,x.pinchStart1.x,x.pinchStart1.y),s=J(x.pinchEnd0.x,x.pinchEnd0.y,x.pinchEnd1.x,x.pinchEnd1.y);e/s>1.1?(ht(-1),x.pinchStart0=x.pinchEnd0,x.pinchStart1=x.pinchEnd1):e/s<.9&&(ht(1),x.pinchStart0=x.pinchEnd0,x.pinchStart1=x.pinchEnd1)}else x.lastX=t.touches[0].pageX,x.lastY=t.touches[0].pageY,ji()}function pc(t){t.preventDefault(),t.touches.length>1&&Zi(t),x.lastX=t.touches[0].pageX,x.lastY=t.touches[0].pageY,Wi(t)}function yc(){dc(),xc(a),zi()}function Ws(t,e=!1){document.getElementById("rg2-map-load-progress-label").textContent=p("Loading map",""),document.getElementById("rg2-map-load-progress").classList.remove("d-none"),oe.src=e?t:t+"?"+Date.now()}function vc(){document.getElementById("rg2-map-load-progress").classList.add("d-none"),js(),h.managing()&&kr()}function b(){as===void 0&&(as=setTimeout(()=>{as=void 0,Ec()},75))}function Ec(){if(a.save(),a.setTransform(1,0,0,1,0,0),a.globalAlpha=h.FULL_INTENSITY,a.fillStyle=h.GREY,a.fillRect(0,0,a.canvas.width,a.canvas.height),a.restore(),oe.height>0){a.fillStyle=h.WHITE,a.globalAlpha=h.FULL_INTENSITY,a.fillRect(0,0,oe.width,oe.height),a.globalAlpha=D.perCentMapIntensity/100,a.drawImage(oe,0,0);const t=Ze();t===h.TAB_DRAW?(Sn(h.DIM),z.drawControls(!1),on(),wa()):t===h.TAB_CREATE?Kl():(Sn(h.DIM),on(),Ht.drawOverlays(),z.drawControls(!1),jd())}else cc()}function js(){let t=1;const e=W.height/oe.height;x.lastX=W.width/2,x.lastY=W.height/2,x.zoomSize=1,x.dragStart=null,x.dragged=!0,e<1&&(t=e),window.innerWidth>=h.BIG_SCREEN_BREAK_POINT?a.setTransform(t,0,0,t,document.getElementById("rg2-left-info-panel").offsetWidth+80,0):a.setTransform(t,0,0,t,0,0),a.displayAngle=0,a.save(),b()}function zi(){x.scaleFactor=h.DEFAULT_SCALE_FACTOR;const t=document.getElementById("rg2-header-container").offsetHeight;document.getElementById("rg2-container").style.height=window.innerHeight-t+"px",W.width=window.innerWidth,W.height=window.innerHeight-t,js()}function Bn(t){const e=t*(Math.PI/36);Gi(e,oe.width/2,oe.height/2,!1)}function Ki(t){x.lastX=t.pageX-W.offsetParent.offsetLeft,x.lastY=t.pageY-W.offsetParent.offsetTop}function Zi(t){x.pinchStart0=a.transformedPoint(t.touches[0].pageX,t.touches[0].pageY),x.pinchStart1=a.transformedPoint(t.touches[1].pageX,t.touches[1].pageY),x.pinched=!0}function xc(t){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");let s=e.createSVGMatrix(),n=[],i=t.save;t.save=function(){return n.push(s.translate(0,0)),i.call(t)};let l=t.restore;t.restore=function(){return s=n.pop(),l.call(t)};let r=t.scale;t.scale=function(g,v){return s=s.scaleNonUniform(g,v),r.call(t,g,v)};let o=t.translate;t.translate=function(g,v){return s=s.translate(g,v),o.call(t,g,v)};let f=t.setTransform;t.setTransform=function(g,v,k,O,N,A){return s.a=g,s.b=v,s.c=k,s.d=O,s.e=N,s.f=A,f.call(t,g,v,k,O,N,A)};let y=e.createSVGPoint();t.transformedPoint=function(g,v){return y.x=g,y.y=v,y.matrixTransform(s.inverse())};let u=t.rotate;t.rotate=function(g){return s=s.rotate(g*180/Math.PI),u.call(t,g)}}function ht(t){if(!h.managing()&&Di()===null)return;const e=Math.pow(x.scaleFactor,t),s=x.zoomSize*e;if(s<50&&s>.05){x.zoomSize=s;const n=a.transformedPoint(x.lastX,x.lastY);a.translate(n.x,n.y),a.scale(e,e),a.translate(-n.x,-n.y),a.save(),b()}}document.readyState!=="loading"?An():document.addEventListener("DOMContentLoaded",An);function An(){const t=document.querySelector(".rg2-startup");t.addEventListener("transitionend",()=>{t.remove(),Bd(),fl(),aa(),rl(),h.managing()&&Sr(rg2Config.keksi),yc(),window.onpopstate=Ic,window.location.hash&&!h.managing()&&Hn(window.location.hash),document.getElementById("rg2-event-title").innerHTML="Routegadget 2",Je()}),t.style.opacity=0}function Ic(){if(window.location.hash!==""&&!h.managing()){const t=Hn(window.location.hash);wi(t)&&td()!==t&&vt(t)}}
//# sourceMappingURL=main-2tT5craX.js.map
