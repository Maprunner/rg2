const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=[window.assetUrl("assets/manager-1E3re5s3.js"),window.assetUrl("assets/node-modules-CPWXqQ3f.js"),window.assetUrl("assets/manager-utils-C8g2LUbf.js"),window.assetUrl("assets/manager-utils-HupOsEJb.css")])))=>i.map(i=>d[i]);
import{a as Qn,T as ei,M as ti,d as tt,O as Gt,i as st}from"./node-modules-CPWXqQ3f.js";import"./main-D9_pgpFN.js";const si="modulepreload",ni=function(t,e){return new URL(t,e).href},ls={},Ke=function(e,s,n){let i=Promise.resolve();if(s&&s.length>0){const r=document.getElementsByTagName("link"),o=document.querySelector("meta[property=csp-nonce]"),g=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));i=Promise.allSettled(s.map(p=>{if(p=ni(p,n),p in ls)return;ls[p]=!0;const m=p.endsWith(".css"),y=m?'[rel="stylesheet"]':"";if(!!n)for(let E=r.length-1;E>=0;E--){const T=r[E];if(T.href===p&&(!m||T.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${p}"]${y}`))return;const k=document.createElement("link");if(k.rel=m?"stylesheet":si,m||(k.as="script"),k.crossOrigin="",k.href=p,g&&k.setAttribute("nonce",g),document.head.appendChild(k),m)return new Promise((E,T)=>{k.addEventListener("load",E),k.addEventListener("error",()=>T(new Error(`Unable to preload CSS for ${p}`)))})}))}function l(r){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=r,window.dispatchEvent(o),!o.defaultPrevented)throw r}return i.then(r=>{for(const o of r||[])o.status==="rejected"&&l(o.reason);return e().catch(l)})},Us=Qn.create({baseURL:rg2Config.api_url});function Ut(t,e,s){t.t=new Date().getTime(),document.getElementById("rg2-container").style.cursor="wait",Us({method:"get",url:"",params:t}).then(n=>{e(n.data.data,t.id)}).catch(function(n){Xs(s+": "+n)}).finally(function(){document.getElementById("rg2-container").style.cursor="auto"})}function Ys(t,e,s,n,i=()=>{}){let l={method:"post"};l.data=t,e.headers&&(l.headers=e.headers,delete e.headers),e.t=new Date().getTime(),l.params=e,document.getElementById("rg2-container").style.cursor="wait",Us(l).then(r=>{r.data.keksi&&i(r.data.keksi),s(r.data)}).catch(function(r){Xs(n+": "+r)}).finally(function(){document.getElementById("rg2-container").style.cursor="auto"})}function Xs(t){document.getElementById("rg2-load-progress").classList.add("d-none"),document.getElementById("rg2-map-load-progress").classList.add("d-none"),Y("Configuration error",t)}let le={};le.code="en";let Ze=[];function ii(t){let e=document.getElementById("rg2-select-language");e.innerHTML="";let s=le.code==="en";e.options.add(be("en","en: English",s));for(let n=0;n<t.length;n=n+1)s=le.code===t[n].code,e.options.add(be(t[n].code,t[n].code+": "+t[n].language,s));e.addEventListener("change",n=>{const i=n.target.value;i!==le.code&&(i==="en"?qs("en"):Ws(i))})}function Ws(t){Ut({type:"lang",lang:t},ri,"Language request failed")}function li(t){const e=Ze.indexOf(t);return e>-1?e:(Ze.push(t),Ze.length-1)}function ri(t){qs(t.lang)}function ai(){rg2Config.start_language!=="en"&&Ws(rg2Config.start_language)}function qs(t){t==="en"?le={code:"en"}:le=t,oi()}function f(t,e="span"){const s=li(t);return le.hasOwnProperty(t)&&(t=le[t]),e===""?t:`<${e} data-rg2t='${s}'>${t}</${e}>`}function oi(){const t=document.querySelectorAll("[data-rg2t]");for(let e of t){const s=parseInt(e.dataset.rg2t,10);e.innerText=f(Ze[s],"")}}function Qa(t,e,s){return t.length>0?t[0].getAttribute(e).trim():s}function B(t){const e=Math.floor(t/60);let s=e;const n=t-e*60;return n<10?s+=":0"+n:s+=":"+n,s}function di(t){let e;const s=Math.floor(t/3600);s<10?e="0"+s+":":e=s+":",t=t-s*3600;const n=Math.floor(t/60);return n<10?e+="0"+n:e+=n,t=t-n*60,t<10?e+=":0"+t:e+=":"+t,e}function be(t,e,s=!1){let n=document.createElement("option");return n.value=t,n.text=e,s&&(n.selected=!0),n}function ci(t,e,s=!1){return`<option value="${t}"${s?" selected":""}>${e}</option>`}function ue(t,e,s,n){let i=Math.atan2(n-e,s-t);return i<0&&(i=i+2*Math.PI),i}function X(t,e,s,n){return Math.sqrt(Math.pow(t-s,2)+Math.pow(e-n,2))}function Mt(t,e,s,n){const i=(s-t).toRad(),l=(n-e).toRad(),r=Math.sin(i/2)*Math.sin(i/2)+Math.cos(t.toRad())*Math.cos(s.toRad())*Math.sin(l/2)*Math.sin(l/2);return 6371009*2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r))}function eo(t){if(!t)return 0;let e=0;const s=t.split(":");return e=parseInt(s[0],10)*3600+parseInt(s[1],10)*60,isNaN(e)?0:e}function rs(t){if(!t)return 0;let e=0,s=t.replace(/\./g,":").split(":");return s.length===2?e=parseInt(s[0],10)*60+parseInt(s[1],10):s.length===3&&(e=parseInt(s[0],10)*3600+parseInt(s[1],10)*60+parseInt(s[2],10)),isNaN(e)?0:e}const Y=(t,e)=>{hi(t,e)},ui=document.getElementById("rg2-toast-container"),hi=(t,e)=>{const s=document.createElement("div");s.classList.add("toast"),s.setAttribute("data-bs-autohide","false"),s.innerHTML=`<div class="toast-header">
      <strong class="me-auto">${t}</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">
      ${e}
    </div>`,ui.appendChild(s),[...document.querySelectorAll(".toast")].map(i=>{const l=new ei(i,{});i.addEventListener("hidden.bs.toast",()=>{i.parentNode&&i.parentNode.removeChild(i)}),l.show()})};function to(t,e){return t.length>0?t[0].textContent.trim():e}let Le;function Yt(t,e=!0){Le&&Le.dispose();const s=document.getElementById("rg2-modal-container");s.innerHTML="";const n=e?`<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${f("Cancel")}</button>`:"",i=`<div class="modal fade" id="rg2-modal-dialog" data-bs-backdrop="static" data-bs-keyboard="false"
    tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="staticBackdropLabel">${t.title}</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          ${t.body}
        </div>
        <div class="modal-footer">
          <button id="rg2-do-modal-action" type="button" class="btn btn-primary">${f(t.doText)}</button>
          ${n}
        </div>
      </div>
    </div>
    </div > `;s.innerHTML=i,typeof t.onCancel!="function"&&(t.onCancel=()=>{});let l=!1;const r=document.getElementById("rg2-modal-dialog");document.getElementById("rg2-do-modal-action").addEventListener("click",()=>{l=!0,Le.hide()});const o={keyboard:!0};Le=new ti(r,o),r.addEventListener("hidden.bs.modal",()=>{l?t.onDo():t.onCancel()}),Le.show()}function so(t,e){const s=document.getElementById(t),n=e(s.value);return n?(s.classList.add("is-valid"),s.classList.remove("is-invalid")):(s.classList.add("is-invalid"),s.classList.remove("is-valid")),n}Number.prototype.toRad=function(){return this*Math.PI/180};const as=["#ff0000","#00ff00","#0000ff","#800000","#008000","#000080","#ffff00","#ff00ff","#00ffff","#808000","#800080","#008080"];let St=0;function Vs(){return St=(St+1)%as.length,as[St]}const h={RG2VERSION:"2.1",DEFAULT_SCALE_FACTOR:1.1,TAB_EVENTS:"event-tab",TAB_COURSES:"course-tab",TAB_RESULTS:"result-tab",TAB_DRAW:"draw-tab",TAB_LOGIN:"manage-login-tab",TAB_CREATE:"manage-create-tab",TAB_EDIT:"manage-edit-tab",TAB_MAP:"manage-map-tab",TAB_DELETE_MAP:"manage-delete-map-tab",INVALID_MAP_ID:9999,DEFAULT_NEW_COMMENT:"Type your comment",GPS_RESULT_OFFSET:5e4,MASS_START_REPLAY:1,REAL_TIME_REPLAY:2,MASS_START_BY_CONTROL:99999,VERY_HIGH_TIME_IN_SECS:99999,BIG_SCREEN_BREAK_POINT:800,SMALL_SCREEN_BREAK_POINT:500,MAX_ZOOM:50,MIN_ZOOM:.05,PURPLE:"#b300ff",RED:"#ff0000",GREEN:"#00ff00",BLUE:"#0000ff",DARK_GREEN:"rgb(34, 139, 34)",DARK_GREEN_30:"rgba(34, 139, 34, 0.3)",GREY:"#e0e0e0",RED_30:"rgba(255,0,0,0.3)",GREEN_30:"rgba(0,255,0,0.3)",BLUE_30:"rgba(0,0,255,0.3)",PURPLE_30:"rgba(180,0,255,0.3)",WHITE:"#ffffff",BLACK:"#000000",RUNNER_DOT_RADIUS:6,HANDLE_DOT_RADIUS:7,HANDLE_COLOUR:"#ff0000",DIM:.75,FULL_INTENSITY:1,TIME_NOT_FOUND:9999,RIGHT_CLICK:3,DO_NOT_SAVE_COURSE:9999,FORMAT_NORMAL:1,FORMAT_NORMAL_NO_RESULTS:2,FORMAT_SCORE_EVENT:3,FORMAT_SCORE_EVENT_NO_RESULTS:4,DISPLAY_ALL_COURSES:99999,EXCLUDED_NONE:0,EXCLUDED_ZERO_SPLITS:1,EXCLUDED_REAL_SPLITS:2,MAX_DRAWN_ROUTES:10,languages:[{language:"Čeština",code:"cz"},{language:"Deutsch",code:"de"},{language:"Suomi",code:"fi"},{language:"Français",code:"fr"},{language:"Italiano",code:"it"},{language:"日本語",code:"ja"},{language:"Norsk",code:"no"},{language:"Português - Brasil",code:"pt"},{language:"Русский",code:"ru"}],FILE_SIZE_WARNING:2,PIXEL_SIZE_WARNING:4e3,CLASS_NOW_ON:1,CLASS_NOW_OFF:0,managing:()=>rg2Config.keksi!==void 0},L={perCentMapIntensity:100,perCentRouteIntensity:100,replayFontSize:12,courseWidth:3,routeWidth:4,circleSize:20,snap:!0,showThreeSeconds:!1,showGPSSpeed:!1,alignMap:!1,maxSpeed:5,minSpeed:15,drawnRoutes:[]};function ht(){let t={};const e=Ge();let s=Math.pow(Math.min(e.height,e.width)/1500,.5);s=Math.min(s,5),s=Math.max(s,.5);const n=Math.round(L.circleSize*s);return t.controlRadius=n,t.finishInnerRadius=n*(5/6),t.finishOuterRadius=n*(7/6),t.startTriangleLength=n*(7/6),t.overprintWidth=L.courseWidth,t.font=n+"pt Arial",t}function fi(){try{if(window.hasOwnProperty("localStorage")&&window.localStorage!==null&&localStorage.getItem("rg2-options")!==null){const t=JSON.parse(localStorage.getItem("rg2-options"));for(let e in t)t.hasOwnProperty(e)&&(L[e]=t[e]);L.circleSize=20,L.perCentMapIntensity===0&&Y("Warning","Your saved settings have 0% map intensity so the map is invisible. You can adjust this on the configuration menu")}}catch{}}function gi(t){let e=[];for(let s=0;s<L.drawnRoutes.length;s+=1)(L.drawnRoutes[s].id!==t.id||L.drawnRoutes[s].eventid!==t.eventid)&&e.push(L.drawnRoutes[s]);L.drawnRoutes=e,ft()}function ft(){try{window.hasOwnProperty("localStorage")&&window.localStorage!==null&&localStorage.setItem("rg2-options",JSON.stringify(L))}catch{return}}function mi(t){let e=L.drawnRoutes;e.length>=h.MAX_DRAWN_ROUTES&&e.shift(),e.push(t),L.drawnRoutes=e,ft()}function pi(t,e){L[t]=e,ft()}class yi{constructor(){this.controls=[],this.displayControls=!1}addControl(e,s,n){let i=!0;for(let l=0;l<this.controls.length;l+=1)if(this.controls[l].code===e){i=!1;break}i&&this.controls.push({code:e,x:s,y:n})}deleteAllControls(){this.controls.length=0}displayAllControls(){this.displayControls=!0}drawControls(e){if(this.displayControls){const s=ht();for(let n=0;n<this.controls.length;n+=1)this.controls[n].code.indexOf("F")===0||this.controls[n].code.indexOf("M")===0?this.drawFinish(this.controls[n].x,this.controls[n].y,this.controls[n].code,s):this.controls[n].code.indexOf("S")===0?this.drawStart(this.controls[n].x,this.controls[n].y,this.controls[n].code,1.5*Math.PI,s):(this.drawSingleControl(this.controls[n].x,this.controls[n].y,this.controls[n].code,Math.PI*.25,s),e&&a.fillRect(this.controls[n].x-1,this.controls[n].y-1,3,3))}}drawFinish(e,s,n,i){a.strokeStyle="white",a.lineWidth=i.overprintWidth+2,a.beginPath(),a.arc(e,s,i.finishInnerRadius,0,2*Math.PI,!1),a.stroke(),a.beginPath(),a.arc(e,s,i.finishOuterRadius,0,2*Math.PI,!1),a.stroke(),a.beginPath(),a.font=i.font,a.textAlign="left",a.strokeStyle="white",a.miterLimit=2,a.lineJoin="circle",a.lineWidth=1.5,a.strokeText(n,e+i.controlRadius*1.5,s+i.controlRadius),a.stroke(),a.beginPath(),a.fillStyle=h.PURPLE,a.strokeStyle=h.PURPLE,a.lineWidth=i.overprintWidth,a.arc(e,s,i.finishInnerRadius,0,2*Math.PI,!1),a.stroke(),a.beginPath(),a.arc(e,s,i.finishOuterRadius,0,2*Math.PI,!1),a.fillText(n,e+i.controlRadius*1.5,s+i.controlRadius),a.stroke()}drawSingleControl(e,s,n,i,l){a.beginPath(),a.strokeStyle="white",a.lineWidth=l.overprintWidth+2,a.arc(e,s,l.controlRadius,0,2*Math.PI,!1),a.stroke(),a.beginPath(),a.textAlign="center",a.font=l.font,a.strokeStyle="white",a.miterLimit=2,a.lineJoin="circle",a.lineWidth=1.5,a.textBaseline="middle";const r=a.measureText(n);let o;i<Math.PI?o=r.width/2:o=-1*r.width/2;let g;i>=Math.PI/2&&i<=Math.PI*1.5?g=-1*l.controlRadius/2:g=l.controlRadius/2;const p=1.3;a.strokeText(n,e+l.controlRadius*p*Math.sin(i)+o,s+l.controlRadius*p*Math.cos(i)+g),a.beginPath(),a.font=l.font,a.fillStyle=h.PURPLE,a.strokeStyle=h.PURPLE,a.lineWidth=l.overprintWidth,a.arc(e,s,l.controlRadius,0,2*Math.PI,!1),a.fillText(n,e+l.controlRadius*p*Math.sin(i)+o,s+l.controlRadius*p*Math.cos(i)+g),a.stroke()}drawStart(e,s,n,i,l){let r=[],o=[];const g=2*Math.PI/3;i=i+Math.PI/2,a.lineCap="round",a.strokeStyle="white",a.lineWidth=l.overprintWidth+2,a.beginPath(),r[0]=e+l.startTriangleLength*Math.sin(i),o[0]=s-l.startTriangleLength*Math.cos(i),a.moveTo(r[0],o[0]),r[1]=e+l.startTriangleLength*Math.sin(i+g),o[1]=s-l.startTriangleLength*Math.cos(i+g),a.lineTo(r[1],o[1]),a.stroke(),a.beginPath(),a.moveTo(r[1],o[1]),r[2]=e+l.startTriangleLength*Math.sin(i-g),o[2]=s-l.startTriangleLength*Math.cos(i-g),a.lineTo(r[2],o[2]),a.stroke(),a.beginPath(),a.moveTo(r[2],o[2]),a.lineTo(r[0],o[0]),a.stroke(),a.beginPath(),a.font=l.font,a.textAlign="left",a.strokeStyle="white",a.miterLimit=2,a.lineJoin="circle",a.lineWidth=1.5,a.strokeText(n,r[0]+l.controlRadius*1.25,o[0]+l.controlRadius*1.25),a.stroke(),a.strokeStyle=h.PURPLE,a.lineWidth=l.overprintWidth,a.font=l.font,a.fillStyle=h.PURPLE,a.beginPath(),a.moveTo(r[0],o[0]),a.lineTo(r[1],o[1]),a.stroke(),a.beginPath(),a.moveTo(r[1],o[1]),a.lineTo(r[2],o[2]),a.stroke(),a.beginPath(),a.moveTo(r[2],o[2]),a.lineTo(r[0],o[0]),a.fillText(n,r[0]+l.controlRadius*1.25,o[0]+l.controlRadius*1.25),a.stroke()}generateControlList(){this.controls.length=0;const e=Cn();for(let s=0;s<e.length;s+=1)if(e[s]!==void 0){const n=e[s].codes,i=e[s].x,l=e[s].y;if(n!==void 0)for(let r=0;r<n.length;r+=1)this.addControl(n[r],i[r],l[r])}}getControlCount(){return this.controls.length}toggleControlDisplay(){this.displayControls=!this.displayControls}}class vi{constructor(e,s,n,i){this.x=e,this.y=s,this.basex=e,this.basey=s,this.undox=e,this.undoy=s,this.locked=!1,this.time=n,this.index=i}}class bi{constructor(){this.handles=[]}addHandle(e,s,n){this.handles.push(new vi(e,s,n,this.handles.length)),this.handles.sort(function(i,l){return i.time-l.time}),this.renumberHandles()}deleteHandle(e){e===0||e===this.handles.length-1||(this.handles.splice(e,1),this.renumberHandles())}renumberHandles(){for(let e=0;e<this.handles.length;e+=1)this.handles[e].index=e}lockHandle(e){this.handles[e].locked=!0}lockHandleByTime(e){for(let s=0;s<this.handles.length;s+=1)this.handles[s].time===e&&(this.handles[s].locked=!0)}unlockHandle(e){this.handles[e].locked=!1}handlesLocked(){let e=0;for(let s=0;s<this.handles.length;s+=1)this.handles[s].locked&&(e+=1);return e}deleteAllHandles(){this.handles.length=0}rebaselineXY(){this.copyHandleFields("","base")}saveForUndo(){this.copyHandleFields("base","undo")}undo(){this.copyHandleFields("undo","base"),this.copyHandleFields("undo","")}copyHandleFields(e,s){for(let n=0;n<this.handles.length;n+=1)this.handles[n][s+"x"]=this.handles[n][e+"x"],this.handles[n][s+"y"]=this.handles[n][e+"y"]}getStartHandle(){return this.handles[0]}getFinishHandle(){return this.handles[this.handles.length-1]}getHandleClicked(e){for(let s=0;s<this.handles.length;s+=1)if(X(e.x,e.y,this.handles[s].basex,this.handles[s].basey)<=h.HANDLE_DOT_RADIUS)return this.handles[s]}getEarliestLockedHandle(){for(let e=0;e<this.handles.length;e+=1)if(this.handles[e].locked)return this.handles[e]}getLatestLockedHandle(){for(let e=this.handles.length-1;e>0;e-=1)if(this.handles[e].locked)return this.handles[e]}getPreviousLockedHandle(e){for(let s=e.index-1;s>=0;s-=1)if(this.handles[s].locked)return this.handles[s]}getNextLockedHandle(e){for(let s=e.index+1;s<this.handles.length;s+=1)if(this.handles[s].locked)return this.handles[s]}getSingleLockedHandle(){return this.getEarliestLockedHandle()}dragHandles(e,s){for(let n=0;n<this.handles.length;n+=1)this.handles[n].x=this.handles[n].basex+e,this.handles[n].y=this.handles[n].basey+s}drawHandles(){for(let e=0;e<this.handles.length;e+=1)a.lineWidth=1,this.handles[e].locked===!0?(a.fillStyle=h.RED_30,a.strokeStyle=h.RED):(a.fillStyle=h.GREEN_30,a.strokeStyle=h.GREEN),a.beginPath(),a.arc(this.handles[e].x,this.handles[e].y,h.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),a.fill(),a.stroke()}alignHandles(e){for(let s=0;s<this.handles.length;s+=1)this.handles[s].x=e.x[this.handles[s].time],this.handles[s].y=e.y[this.handles[s].time]}}class gt{constructor(){this.courseid=null,this.coursename=null,this.controlsToAdjust=0,this.resultid=null,this.isScoreCourse=!1,this.eventid=null,this.name=null,this.comments=null,this.x=[],this.y=[],this.controlx=[],this.controly=[],this.time=[],this.startsecs=0,this.totaltime=0,this.splits=[],this.xml=null}}class js{constructor(){this.lat=[],this.lon=[],this.startOffset=0,this.baseX=[],this.baseY=[],this.handles=new bi,this.savedBaseX=[],this.savedBaseY=[],this.fileLoaded=!1,this.fileName="",this.fileType="",this.routeData=new gt,this.autofitOffset=null}adjustOffset(e){this.autofitOffset=e,this.processGPSFile(),this.autofitTrack()}addStartAndFinishHandles(){this.handles.addHandle(this.baseX[0],this.baseY[0],0),this.handles.addHandle(this.baseX[this.baseX.length-1],this.baseY[this.baseY.length-1],this.baseY.length-1)}applyWorldFile(){const e=In();for(let s=0;s<this.lat.length;s+=1)this.routeData.x[s]=Math.round((e.E*this.lon[s]-e.B*this.lat[s]+e.xCorrection)/e.AEDB),this.routeData.y[s]=Math.round((-1*e.D*this.lon[s]+e.A*this.lat[s]+e.yCorrection)/e.AEDB)}autofitTrack(){document.getElementById("chk-move-all").checked=!1,this.handles.deleteAllHandles(),this.addStartAndFinishHandles(),this.autofitOffset===null&&(this.autofitOffset=this.getOffset());for(let e=1;e<this.routeData.controlsToAdjust;e+=1)if(this.routeData.splits[e]!==this.routeData.splits[e-1]){const s=this.routeData.splits[e]+this.autofitOffset;s<this.baseX.length&&s>=0&&(this.handles.addHandle(this.routeData.x[s],this.routeData.y[s],s),mn({x:this.routeData.x[s],y:this.routeData.y[s]},{x:this.routeData.controlx[e],y:this.routeData.controly[e]}),this.handles.lockHandleByTime(s),this.baseX=this.routeData.x.slice(0),this.baseY=this.routeData.y.slice(0),this.handles.rebaselineXY())}document.getElementById("btn-autofit-gps").setAttribute("disabled",""),document.getElementById("btn-undo-gps-adjust").setAttribute("disabled",""),w()}expandToOneSecondInterval(){let e=[],s=[],n=[];const i=this.routeData;let l=i.time[0],r=i.x[0],o=i.y[0];e[0]=r,s[0]=o,n[0]=i.time[0];let g=n[0]+1;for(let p=1;p<i.x.length;p+=1){const m=i.time[p]-l;if(m>0){const y=(i.x[p]-r)/m,v=(i.y[p]-o)/m;let k=1;for(;k<=m;)e.push(r+y*k),s.push(o+v*k),n.push(g),g+=1,k+=1;r=i.x[p],o=i.y[p],l=g-1}}this.routeData.x=e.slice(0),this.routeData.y=s.slice(0),this.routeData.time=n.slice(0)}fitTrackInsideCourse(){const e=this.getLatLonInfo(),s=this.getControlInfo();let n=(s.maxX-s.minX)/(e.maxLon-e.minLon),i=(s.maxY-s.minY)/(e.maxLat-e.minLat);n>i?i=n*e.latCorrection/e.lonCorrection:n=i*e.lonCorrection/e.latCorrection,this.routeData.x[0]=(this.lon[0]-e.minLon)*n+s.minX,this.routeData.y[0]=-1*(this.lat[0]-e.maxLat)*i+s.minY;const l=s.minX-(this.routeData.x[0]-s.x[0]),r=s.minY-(this.routeData.y[0]-s.y[0]);for(let o=0;o<this.lat.length;o+=1)this.routeData.x[o]=(this.lon[o]-e.minLon)*n+l,this.routeData.y[o]=-1*(this.lat[o]-e.maxLat)*i+r}getControlInfo(){let e=or();if(e.minX=Math.min.apply(Math,e.x),e.maxX=Math.max.apply(Math,e.x),e.minY=Math.min.apply(Math,e.y),e.maxY=Math.max.apply(Math,e.y),e.maxY-e.minY<100||e.maxX-e.minX<100){e.minX=0,e.minY=0;const s=Ge();e.maxX=s.width,e.maxY=s.height}return e}getLatLonInfo(){let e={};return e.maxLat=Math.max.apply(Math,this.lat),e.maxLon=Math.max.apply(Math,this.lon),e.minLat=Math.min.apply(Math,this.lat),e.minLon=Math.min.apply(Math,this.lon),e.lonCorrection=Mt(e.minLat,e.maxLon,e.minLat,e.minLon)/(e.maxLon-e.minLon),e.latCorrection=Mt(e.minLat,e.minLon,e.maxLat,e.minLon)/(e.maxLat-e.minLat),e}getOffset(){const e=this.getSpeedAverage();let s=[];const n=10;for(let o=0;o<=2*n;o+=1)s[o]=0;let i=0;for(let o=1;o<this.routeData.controlsToAdjust;o+=1){const g=this.routeData.splits[o];if(g!==this.routeData.splits[o-1]){g>=n&&g+n<e.length&&(i=e.slice(g-n,g+n+1));for(let p=0;p<=2*n;p+=1)s[p]+=i[p]}}let l=0;for(let o=1;o<s.length;o+=1)s[o]<s[l]&&(l=o);return l-n}getSecsFromTrackpoint(e){const s=parseInt(Date.parse(e)/1e3,10);return isNaN(s)?0:s-this.startOffset}getSpeedAverage(){let e=[],s=[];e[0]=0;for(let n=1;n<this.routeData.x.length;n+=1)e[n]=X(this.routeData.x[n],this.routeData.y[n],this.routeData.x[n-1],this.routeData.y[n-1]);for(let n=1;n<this.routeData.x.length-1;n+=1)s[n]=(e[n-1]+e[n]+e[n+1])/3;return s[0]=e[0],s[this.routeData.x.length-1]=e[this.routeData.x.length-1],s}getStartOffset(e){const s=parseInt(Date.parse(e.substr(0,11)+"00:00:00Z")/1e3,10);return isNaN(s)?0:s}initialiseGPS(){this.lat.length=0,this.lon.length=0,this.startOffset=0,this.baseX.length=0,this.baseY.length=0,this.handles.deleteAllHandles(),this.savedBaseX.length=0,this.savedBaseY.length=0,this.fileLoaded=!1,this.routeData.x.length=0,this.routeData.y.length=0,this.routeData.time.length=0}processGPSFile(){this.initialiseGPS(),this.fileType==="gpx"?this.processGPX():this.processTCX(),this.processGPSTrack()}processGPSTrack(){bt()?(this.applyWorldFile(),this.trackMatchesMapCoordinates()?document.getElementById("chk-move-all").checked=!0:(Y("GPS file problem","Your GPS file does not match the map co-ordinates. Please check you have selected the correct file."),this.fitTrackInsideCourse())):this.fitTrackInsideCourse(),this.lat.length=0,this.lon.length=0,this.expandToOneSecondInterval(),this.baseX=this.routeData.x.slice(0),this.baseY=this.routeData.y.slice(0),this.addStartAndFinishHandles(),this.fileLoaded=!0,this.routeData.splits.length>2&&document.getElementById("btn-autofit-gps").removeAttribute("disabled"),document.getElementById("btn-save-gps-route").removeAttribute("disabled"),w()}processGPX(){const e=this.xml.getElementsByTagName("trkseg");for(let s=0;s<e.length;s+=1){const n=e[s].getElementsByTagName("trkpt");this.startOffset=this.getStartOffset(n[0].getElementsByTagName("time")[0].textContent);for(let i=0;i<n.length;i+=1){const l=n[i].getAttribute("lat"),r=n[i].getAttribute("lon");l!=="0"&&r!=="0"&&(this.lat.push(l),this.lon.push(r),this.routeData.time.push(this.getSecsFromTrackpoint(n[i].getElementsByTagName("time")[0].textContent)))}}}processTCX(){const e=this.xml.getElementsByTagName("Track");for(let s=0;s<e.length;s+=1){const n=e[s].getElementsByTagName("Trackpoint");this.startOffset=this.getStartOffset(n[0].getElementsByTagName("Time")[0].textContent);for(let i=0;i<n.length;i+=1)if(n[i].getElementsByTagName("Position").length>0){const l=n[i].getElementsByTagName("Position"),r=l[0].getElementsByTagName("LatitudeDegrees")[0].textContent,o=l[0].getElementsByTagName("LongitudeDegrees")[0].textContent;r!=="0"&&o!=="0"&&(this.lat.push(r),this.lon.push(o),this.routeData.time.push(this.getSecsFromTrackpoint(n[i].getElementsByTagName("Time")[0].textContent)))}}}readGPS(e){let s=new FileReader;this.fileName=e.target.files[0].name,s.onerror=function(n){Y("GPS file problem","Unable to open GPS file. "+n)},s.onload=n=>{try{if(this.fileType=this.fileName.slice(-3).toLowerCase(),this.fileType!=="gpx"&&this.fileType!=="tcx"){Y("GPS file problem","File type not recognised. Please check you have selected the correct file.");return}document.getElementById("rg2-load-gps-file").setAttribute("disabled",""),this.xml=new DOMParser().parseFromString(n.target.result,"text/xml"),this.processGPSFile()}catch(i){Y("GPS file problem","File is not valid XML. Please check you have selected the correct file. "+i);return}},s.readAsText(e.target.files[0])}trackMatchesMapCoordinates(){const e=Math.min.apply(Math,this.routeData.x),s=Math.max.apply(Math,this.routeData.x),n=Math.min.apply(Math,this.routeData.y),i=Math.max.apply(Math,this.routeData.y),l=Ge();return s>0&&e<l.width&&n<l.height&&i>0}}let K=0,ee=[],Z=[];function os(t,e){return t.length>0?e+t.join(","):""}function ds(t,e,s){let n=0;return K!==0&&(n="#"+t+os(s,"&course=")+os(e,"&route=")),n}function xi(){return ee}function Ei(){return K}function Si(){return Z}function ki(){return Z.length>0?h.TAB_RESULTS:h.TAB_COURSES}function Ti(t){let e=t.replace(/#([0-9]+)($|&).*/,"$1");return e.length>0?parseInt(e,10):e}function zs(t){K=0,ee.length=0,Z.length=0;let e=t.split("&");for(let s=0;s<e.length;s+=1)e[s]=e[s].toLowerCase(),e[s].search("#")!==-1&&(K=parseInt(e[s].replace(/\D/g,""),10)),e[s].search("course=")!==-1&&(ee=e[s].replace("course=","").split(",")),e[s].search("route=")!==-1&&(Z=e[s].replace("route=","").split(","));return ee=ee.map(Number),Z=Z.map(Number),isNaN(K)&&(K=0,ee.length=0,Z.length=0),mt(),K}function Ii(t){K=t,mt()}function cs(t){ee=t,mt()}function kt(t){Z=t,mt()}function mt(){let t="";Ti(window.location.hash)===K?(t=ds(K,Z,ee),window.history.replaceState({hash:t},"",t)):(ee.length=0,Z.length=0,t=ds(K,Z,ee),window.history.pushState({hash:t},"",t))}var no=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function io(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}class us{constructor(e,s,n,i,l){this.resultid=e.resultid,this.rawid=this.resultid%h.GPS_RESULT_OFFSET,this.isScoreEvent=s,this.name=tt(e.name).trim(),this.initials=this.getInitials(this.name),this.starttime=e.starttime,this.time=e.time,(this.time==="00"||this.time==="0")&&(this.time=""),this.timeInSecs=e.secs,this.position=e.position,this.status=e.status,this.canDelete=!1,this.showResult=!0,this.token=0,e.comments?this.comments=tt(e.comments):this.comments="",this.coursename=e.coursename,this.coursename===""&&(this.coursename=e.courseid.toString()),this.courseid=e.courseid,this.variant=e.variant,this.splits=this.adjustRawSplits(e.splits),this.isScoreEvent&&(this.scorex=i,this.scorey=l,this.scorecodes=n),this.trackColour=null,this.userColour=null,this.initialiseTrack(e)}addInterpolatedTimes(e,s,n){const i=this.xysecs[e],l=this.xysecs[s]-i,r=n[e],o=n[s]-r;for(let g=e;g<=s;g+=1)this.xysecs[g]=i+Math.round((n[g]-r)*l/o)}addTrack(e){this.trackx=e.x.split(",").map(function(n){return parseInt(n,10)}),this.tracky=e.y.split(",").map(function(n){return parseInt(n,10)});for(let n=1;n<this.trackx.length;n+=1)this.trackx[n]=this.trackx[n-1]+this.trackx[n],this.tracky[n]=this.tracky[n-1]+this.tracky[n];let s;this.isGPSTrack?s=this.expandGPSTrack():this.splits.length===2?s=this.expandTrackWithNoSplits():s=this.expandNormalTrack(),s&&ra(this.courseid)}adjustRawSplits(e){e.splice(0,0,0);for(let s=1;s<e.length;s+=1)e[s]<=0&&(e[s]=e[s-1]);return e[e.length-1]=Math.max(this.timeInSecs,e[e.length-2]),e}calculateTotalTrackLength(){let e=[];e[0]=0;let s=this.trackx[0],n=this.tracky[0];for(let i=1;i<this.trackx.length;i+=1)e[i]=e[i-1]+Math.round(X(this.trackx[i],this.tracky[i],s,n)),s=this.trackx[i],n=this.tracky[i];return e}calculateTrackTimes(e){let s=[];s[0]=0;let n=this.getNextValidControl(0),i=e.x[n],l=e.y[n],r=0,o=this.trackx[0],g=this.tracky[0],p=0,m=0,y=0;for(let v=1;v<this.trackx.length;v+=1)if(p=this.trackx[v],m=this.tracky[v],r+=X(p,m,o,g),s[v]=Math.round(r),o=p,g=m,i===p&&l===m){if(this.xysecs[v]=this.splits[n],this.addInterpolatedTimes(y,v,s),y=v,n=this.getNextValidControl(n),n===e.x.length){this.hasValidTrack=!0;break}i=e.x[n],l=e.y[n]}}drawScoreCourse(){if(this.displayScoreCourse&&this.scorex.length>1){const e=ht();a.globalAlpha=h.FULL_INTENSITY;let s=ue(this.scorex[0],this.scorey[0],this.scorex[1],this.scorey[1]);W.drawStart(this.scorex[0],this.scorey[0],"",s,e),s=[];for(let i=0;i<this.scorex.length-1;i+=1)s[i]=ue(this.scorex[i],this.scorey[i],this.scorex[i+1],this.scorey[i+1]);const n={from:0,to:this.scorex.length};jr({x:this.scorex,y:this.scorey},s,this.courseid,e,n);for(let i=1;i<this.scorex.length-1;i+=1)W.drawSingleControl(this.scorex[i],this.scorey[i],i,Math.PI*.25,e);W.drawFinish(this.scorex[this.scorex.length-1],this.scorey[this.scorey.length-1],"",e)}}drawTrack(e){try{let s,n,i;if(this.displayTrack){this.isGPSTrack&&L.showGPSSpeed&&this.speedColour.length===0&&this.setSpeedColours();let l=0,r=this.xysecs.length;const o=this.splits[e.filterFrom],g=this.splits[e.filterTo];for(let p=0;p<this.xysecs.length;p+=1)if(this.xysecs[p]>=o){l=p;break}for(let p=this.xysecs.length-1;p>=0;p-=1)if(this.xysecs[p]<=g){r=p;break}a.lineWidth=L.routeWidth,a.strokeStyle=this.trackColour,a.globalAlpha=L.perCentRouteIntensity/100,a.fillStyle=this.trackColour,a.font="10pt Arial",a.textAlign="left",a.beginPath(),a.moveTo(this.trackx[l],this.tracky[l]),s=this.trackx[l],n=this.tracky[l],i=0;for(let p=l+1;p<=r;p+=1)a.lineTo(this.trackx[p],this.tracky[p]),this.trackx[p]===s&&this.tracky[p]===n?i+=1:i>0&&((!this.isGPSTrack||this.isGPSTrack&&L.showThreeSeconds)&&a.fillText("+"+3*i,s+5,n+5),i=0),s=this.trackx[p],n=this.tracky[p],this.isGPSTrack&&L.showGPSSpeed&&(a.strokeStyle=this.speedColour[p],a.stroke(),a.beginPath(),a.moveTo(s,n));a.stroke()}}catch{return}}expandGPSTrack(){for(let e=0;e<this.trackx.length;e+=1)this.xysecs[e]=3*e;return this.speedColour.length=0,this.hasValidTrack=!0,this.hasValidTrack}expandNormalTrack(){this.xysecs.length=0,this.xysecs[0]=0;let e={};return this.isScoreEvent?(e.x=this.scorex,e.y=this.scorey):e=te(this.courseid),this.calculateTrackTimes(e),this.isScoreEvent&&(this.hasValidTrack=!0),this.hasValidTrack}expandTrackWithNoSplits(){this.xysecs.length=0;const e=this.splits[1];let s=0;this.xysecs[0]=0;const n={};n.x=te(this.courseid).x,n.y=te(this.courseid).y;let i=1,l=n.x[i],r=n.y[i],o=n.x[n.x.length-1],g=n.y[n.y.length-1];this.trackx.push(o),this.tracky.push(g);let p=0;const m=this.calculateTotalTrackLength(),y=m[m.length-1];let v=0,k=0,E=!1;for(let T=1;T<this.trackx.length;T+=1)if(v=this.trackx[T],k=this.tracky[T],(v!==this.trackx[0]||k!==this.tracky[0])&&(E=!0),l===v&&r===k&&E){if(s=parseInt(m[T]/y*e,10),this.xysecs[T]=s,this.splits[i]=s,this.addInterpolatedTimes(p,T,m),p=T,i+=1,i===n.x.length){this.hasValidTrack=!0;break}l=n.x[i],r=n.y[i]}return this.hasValidTrack}getColour(e){let s="#";if(e===0)return"#0080ff";if(e<.5)s+="ff";else{const n=parseInt((1-e)*255*2,10);n<16&&(s+="0"),s+=n.toString(16)}if(e>=.5)s+="ff";else{const n=255-parseInt((.5-e)*255*2,10);n<16&&(s+="0"),s+=n.toString(16)}return s+="00",s}getInitials(e){if(e===null)return"??";e=e.replace(/GPS/g,"*");let s="",n=!0;for(let i=0;i<e.length;i+=1)n&&(s+=e.substr(i,1),n=!1),e.charAt(i)===" "&&(n=!0);return s}getNextValidControl(e){for(let s=e+1;s<this.splits.length;s+=1)if(this.splits[s]!==this.splits[s-1])return s;return this.splits.length}initialiseTrack(e){if(this.legpos=[],this.racepos=[],this.hasValidTrack=!1,this.displayTrack=!1,this.displayScoreCourse=!1,this.trackx=[],this.tracky=[],this.speedColour=[],this.xysecs=[],this.resultid>=h.GPS_RESULT_OFFSET){this.isGPSTrack=!0;const s=ji(this.rawid);this.time=s.time,this.splits=s.splits,this.time===h.TIME_NOT_FOUND&&(this.time=e.time)}else this.isGPSTrack=!1}mapSpeedColours(){const e=16.667/L.maxSpeed,s=16.667/L.minSpeed,n=3,i=this.speedColour.slice().sort(function(p,m){return p-m}),l=yt();let r=0,o=0;l!==void 0?(r=n*e/l,o=n*s/l):(r=i[i.length-1],o=i[Math.floor(i.length/95)]);const g=r-o;for(let p=0;p<this.speedColour.length;p+=1){let m=Math.max(this.speedColour[p],o);m=Math.min(m,r),this.speedColour[p]=this.getColour((m-o)/g)}}setSpeedColours(){this.speedColour[0]=0;let e=0;for(let s=1;s<this.trackx.length;s+=1){const n=X(this.trackx[s],this.tracky[s],this.trackx[s-1],this.tracky[s-1]);this.speedColour[s]=(n+e)/2,e=n}this.mapSpeedColours()}setTrackDisplay(e){this.hasValidTrack&&(e?this.userColour!==null?this.trackColour=this.userColour:this.trackColour=Vs():this.trackColour=null,this.displayTrack=e)}}let d=[];function wi(t,e){d.length=0;let s=[],n=[],i=[];if(e)for(let l=0;l<t.length;l+=1){let r=t[l].variant;s[r]===void 0&&(s[r]=t[l].scorecodes,n[r]=t[l].scorex,i[r]=t[l].scorey)}for(let l=0;l<t.length;l+=1)if(oa(t[l].courseid)){t[l].resultid>h.GPS_RESULT_OFFSET&&t[l].coursename===""&&(t[l].coursename=te(t[l].courseid).name);let r;if(e){let o=t[l].variant;r=new us(t[l],e,s[o],n[o],i[o])}else r=new us(t[l],e);d.push(r)}nl(),sl(),rl(),zi(),Qi(e)}function Li(t){for(let e=0;e<t.length;e+=1){let s=t[e].id,n=0;for(;n<d.length;){if(s===d[n].resultid){d[n].addTrack(t[e]);break}n+=1}}}function hs(t){for(let e=0;e<d.length;e+=1)if(d[e].courseid===t&&!Un(e))return!1;return!0}function fs(){for(let t=0;t<d.length;t+=1)if(d[t].hasValidTrack&&!d[t].displayTrack)return!1;return!0}function Di(t){for(let e=0;e<d.length;e+=1)if(d[e].courseid===t&&d[e].hasValidTrack&&!d[e].displayTrack)return!1;return!0}function gs(t){for(let e=0;e<d.length;e+=1)if(d[e].courseid===t&&d[e].hasValidTrack&&!Un(e))return!1;return!0}function Ci(t){for(let e=0;e<d.length;e+=1)if(d[e].courseid===t&&d[e].hasValidTrack&&d[e].displayTrack)return!0;return!1}function Ai(t){const e=Tn();let s=0;for(let n=0;n<d.length;n+=1)d[n].courseid===t&&(d[n].resultid<h.GPS_RESULT_OFFSET||e.format===h.FORMAT_NO_RESULTS||e.format===h.FORMAT_SCORE_EVENT_NO_RESULTS)&&(s+=1);return s}function Ks(t){let e=document.getElementById("rg2-select-name");if(e.innerHTML="",e.options.add(be(null,f("Select name",""))),t!==void 0){for(let s=0;s<d.length;s+=1)d[s].courseid===t&&d[s].resultid<h.GPS_RESULT_OFFSET&&e.options.add(be(d[s].resultid,d[s].time+" "+d[s].name));e.addEventListener("change",s=>{kr(parseInt(s.target.value,10))}),e.removeAttribute("disabled")}}function Mi(){let t=Pi();t=t.replace(/&amp;/g,"&");const e=document.getElementById("rg2-result-table");e.innerHTML=t,ll(),en(),ql();const s=document.querySelectorAll(".resultrow");for(let n of s)n.addEventListener("dblclick",i=>{const l=parseInt(i.currentTarget.dataset.id,10);l&&_t(l)}),n.addEventListener("contextmenu",i=>{const l=parseInt(i.currentTarget.dataset.id,10);l&&_t(l)})}function Ri(){d.length=0}function Bi(t,e){d[t].displayScoreCourse=e}function ms(){for(let t=0;t<d.length;t+=1){let e;d[t].isScoreEvent?e={from:0,to:d[t].scorex.length}:e=ia(d[t].courseid),d[t].drawTrack(e),d[t].drawScoreCourse()}}function Pi(){let t=[],e=[];if(d.length===0)return`<p>${f("No results available")}</p>`;let s="",n=0,i=0;Ki();for(let l=0;l<d.length;l+=1){const r=d[l];if(!r.showResult)continue;r.courseid!==n&&(t.length>0&&(s+=ps(i,n)+"</table>",e.push(s)),i=0,t.push(Ui(r)),s=`<table class='resulttable' id='table-${r.courseid}'><thead><tr><th>#</th>`,s+=`<th>${f("Name")}</th><th>${f("Time")}</th>`,s+=`<th><i class='bi-pencil'></i></th><th><i class='bi-play-fill'></i></th></tr></thead><tbody class="table-group-divider">`,n=r.courseid),s+=`<tr class="resultrow" data-id="${r.rawid}"><td>${r.position}</td>`,r.comments!==""&&r.comments!==f("Type your comment")?(r.comments=r.comments.replace(/"/g,"&quot;"),s+=`<td title="${r.comments}"><u>${ys(r,l)}</u>`):s+=`<td>${ys(r,l)}`,r.canDelete&&(s+=` <i class='deleteroute bi-trash-fill' data-resultidx=${l}></i>`),s+=`</td><td>${r.time}</td>`;let o="",g="showreplay";r.hasValidTrack&&(i+=1,o=`<input class='showtrack' data-courseid='${n}' data-id='${r.resultid}' type=checkbox name=result></input>`,g+=" showtrackreplay"),s+=`<td>${o}</td>`,s+=`<td><input class="${g}" data-courseid=${n} data-id=${r.resultid} type=checkbox name=replay></input></td></tr>`}s+=`</tbody>${ps(i,n)}</table>`,e.push(s),s='<div class="accordion" id="results-accordion">';for(let l=0;l<e.length;l+=1)s+='<div class="accordion-item">',s+=`<h2 class="accordion-header d-flex" id="header-${l}">`,s+=`<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${l}" aria-expanded="true" aria-controls="collapse-${l}">`,s+=`${t[l].title}</button>${t[l].check}</h2>`,s+=`<div id="collapse-${l}" class="accordion-collapse collapse" aria-labelledby="header-${l}" data-bs-parent="#rg2-result-tab-body">`,s+=`<div class="accordion-body px-0">${e[l]}</div></div></div>`;return s+="</div>",s}function _i(t){let e=Math.floor(t/86400)+" days ";return t=t-86400*Math.floor(t/86400),e+=Math.floor(t/3600)+" hours ",t=t-3600*Math.floor(t/3600),e+=Math.floor(t/60)+" minutes ",e+=t-60*Math.floor(t/60)+" seconds",e}function Oi(){let t=[],e=[],s=[],n=[];for(let i=0;i<d.length;i+=1){const l=d[i];if(l.resultid<h.GPS_RESULT_OFFSET){const r=l.courseid;t.indexOf(r)===-1&&(t.push(r),e[r]=[],s[r]=[],n[r]=[]);for(let o=0;o<l.scorecodes.length;o+=1)e[r].indexOf(l.scorecodes[o])===-1&&(e[r].push(l.scorecodes[o]),s[r].push(l.scorex[o]),n[r].push(l.scorey[o]))}}for(let i=0;i<t.length;i+=1){const l=t[i];ua(l,e[l],s[l],n[l])}}function Zs(t){let e=[];for(let s=0;s<d.length;s+=1)d[s].courseid===t&&d[s].resultid===d[s].rawid&&e.push(d[s]);return e}function Ni(t){let e=[];for(let s=0;s<d.length;s+=1)d[s].variant===t&&d[s].resultid===d[s].rawid&&e.push(d[s]);return e}function $i(t){let e=[];for(let s=0;s<d.length;s+=1)d[s].courseid===t&&e.push(d[s].resultid);return e}function Fi(t){let e=[];for(let s=0;s<d.length;s+=1)d[s].courseid===t&&d[s].hasValidTrack&&e.push(d[s].resultid);return e}function ps(t,e){let s=`<tfoot class="table-group-divider"><tr class='allitemsrow'><td></td><td>${f("Routes")}</td><td></td>`;return t>0?(s+=`<td><input class='allcoursetracks' data-courseid=${e} type=checkbox name=track></input></td>`,s+=`<td><input class='allcoursetracksreplay' data-courseid=${e} type=checkbox name=replay></input></td>`):s+="<td></td><td></td>",s+=`</tr><tr class='allitemsrow'><td></td><td>${f("All")}</td><td></td><td></td>`,s+=`<td><input class='allcoursereplay' data-courseid=${e} type=checkbox name=replay></input></td></tr></tfoot>`,s}function Hi(){let t=!1,e=["<table id='rg2-comments-table' class='table table-sm table-striped table-bordered'>",`<thead><tr><th>${f("Name")}</th><th>${f("Course")}</th>`,`<th>${f("Comments")}</th></tr></thead><tbody class="table-group-divider">`].join("");for(let s=0;s<d.length;s+=1)d[s].comments!==""&&(t=!0,e+=[`<tr><td>${d[s].name}</td><td>${d[s].coursename}</td>`,`<td>${d[s].comments}</td></tr>`].join(""));return t?e+="</tbody></table>":e="",e}function Gi(t){for(let e=0;e<d.length;e+=1)if(d[e].resultid===t)return d[e].courseid}function Ui(t){let e=t.coursename;const s=te(t.courseid);s&&(e+=s.length===void 0?"":": "+s.length+" km");let n=`<div class="d-flex w-100"><div class="flex-grow-1 runners-table-course-header" data-runners="" data-courseid="${t.courseid}">${e}</div>`,i=`<div class="px-2"><input class='showcourse' data-courseid="${t.courseid}"`;return i+=` type=checkbox name ="course" title='Show course' ></input ></div >`,{title:n,check:i}}function Yi(t){return{id:d[t].resultid,token:d[t].token}}function Xi(){let t=[];for(let e=0;e<d.length;e+=1)if(d[e].displayTrack){let s={};s.trackColour=d[e].trackColour,s.course=ta(d[e].courseid),s.name=d[e].name,s.resultid=d[e].resultid,s.rawid=d[e].rawid,t.push(s)}return t}function Js(t){for(let e=0;e<d.length;e+=1)if(d[e].resultid===t)return d[e]}function Qs(t){for(let e=0;e<d.length;e+=1)if(d[e].resultid===t)return d[e]}function ys(t,e){let s;return t.rawid===t.resultid?s=t.name:s="<i>"+t.name+"</i>",t.isScoreEvent&&(s=`<input class='showscorecourse' data-courseid=${e} type=checkbox></input> ${s}`),`<div>${s}</div>`}function Wi(t){let e=d.findIndex(s=>s.resultid===t);return e>-1?d[e].displayOrder:t}function qi(){let t={results:0,drawnroutes:0,gpsroutes:0,secs:0};for(let e=0;e<d.length;e+=1){const s=d[e];s.resultid<h.GPS_RESULT_OFFSET&&(t.results+=1,s.time&&(t.secs+=s.splits[s.splits.length-1])),s.hasValidTrack&&(s.resultid<h.GPS_RESULT_OFFSET?t.drawnroutes+=1:t.gpsroutes+=1)}return t.totalroutes=t.drawnroutes+t.gpsroutes,t.results>0?t.percent=(100*t.totalroutes/t.results).toFixed(1):t.percent=0,t.time=_i(t.secs),t}function Vi(t,e){const s=qi(),n=sa(),i=Ge();let l="";if(e){const o=In(),g=1e6;l=`. ${f("Map is georeferenced")}: ${parseInt(o.F*g)/g}`,l+=`, ${parseInt(o.C*g)/g}.`}return[`<tr><td>${f("Courses")}</td><td>${n.length}</td></tr>`,`<tr><td>${f("Controls")}</td><td>${t}</td></tr>`,`<tr><td>${f("Results")}</td><td>${s.results}</td></tr>`,`<tr><td>${f("Routes")}</td><td>${s.totalroutes} (${s.percent}%)</td></tr>`,`<tr><td>${f("Drawn routes")}</td><td>${s.drawnroutes}</td></tr>`,`<tr><td>${f("GPS routes")}</td><td>${s.gpsroutes}</td></tr>`,`<tr><td>${f("Total time")}</td><td>${s.time}</td></tr>`,`<tr><td>${f("Map")} ID ${_r()}</td><td>${i.width}  x ${i.height} pixels${l}</td></tr>`].join("")}function lo(){let t=[];for(let e=0;e<d.length;e+=1)if(d[e].hasValidTrack){let s={};s.id=e,s.resultid=d[e].resultid,s.name=d[e].name,s.time=d[e].time,s.coursename=d[e].coursename,t.push(s)}return t}function ji(t){for(let e=0;e<d.length;e+=1)if(t===d[e].resultid)return{time:d[e].time,splits:d[e].splits};return{time:h.TIME_NOT_FOUND,splits:[]}}function Tt(){let t=[];for(let e=0;e<d.length;e+=1){const s=d[e];s.displayTrack&&t.push(s.resultid)}return t}function zi(){let t,e,s=[];for(let n=0;n<d.length;n+=1)if(d[n].courseid!==t&&(t=d[n].courseid,e=te(t)),e.excludeType===h.EXCLUDED_REAL_SPLITS){s.indexOf(t)===-1&&s.push(t);let i=0;for(let l=1;l<e.exclude.length;l+=1)e.exclude[l]&&(i=i+Math.min(d[n].splits[l]-d[n].splits[l-1],e.allowed[l]));d[n].timeInSecs=Math.max(d[n].splits[d[n].splits.length-1]-i,0),d[n].time=B(d[n].timeInSecs)}for(let n=0;n<s.length;n+=1){let i=d.filter(o=>o.courseid===s[n]);for(let o=0;o<i.length;o+=1)if(i[o].rawid!==i[o].resultid){let g=i.findIndex(p=>p.resultid===i[o].rawid);g>-1&&(i[o].status=i[g].status)}i.sort(function(o,g){return o.status!=="ok"||o.timeInSecs===0?g.status!=="ok"||g.timeInSecs===0?0:1:g.status!=="ok"||g.timeInSecs===0?-1:o.timeInSecs-g.timeInSecs});let l=0,r=0;for(let o=0;o<i.length;o+=1){if(i[o].status!=="ok"||i[o].timeInSecs===0){i[o].position="";continue}r!==i[o].timeInSecs?(l=l+1,r=i[o].timeInSecs):o>0&&i[o].rawid!==i[o-1].rawid&&(l=l+1),i[o].position=l}for(let o=0;o<i.length;o+=1){let g=d.findIndex(p=>p.resultid===i[o].resultid);g>-1&&(d[g].position=i[o].position,d[g].displayOrder=o)}}}function Ki(){d.sort(ol);let t,e=!1;for(let s=0;s<d.length;s+=1)d[s].rawid===t?e&&d[s].hasValidTrack&&(d[s-1].showResult=!1,d[s].position=d[s-1].position,e=!1):(e=!d[s].hasValidTrack,t=d[s].rawid)}function Zi(){for(let t=0;t<d.length;t+=1)d[t].speedColour.length=0}function Ji(t){for(let e=0;e<d.length;e+=1)if(t===d[e].resultid)return!0;return!1}function Qi(t){let e,s;for(let n=0;n<d.length;n+=1){d[n].courseid!==e&&(e=d[n].courseid,s=te(e)),d[n].legSplits=[],d[n].legSplits[0]=0;let i=0,l=!1;for(let r=1;r<d[n].splits.length;r+=1)d[n].splits[r]-i===0?s.exclude[r]?(d[n].legSplits[r]=d[n].splits[r]-i,i=d[n].splits[r]):(d[n].legSplits[r]=0,l=!0,d[n].lastValidSplit===void 0&&(d[n].lastValidSplit=r-1)):l?(d[n].legSplits[r]=0,i=d[n].splits[r],l=!1):(d[n].legSplits[r]=d[n].splits[r]-i,i=d[n].splits[r]);if(d[n].lastValidSplit===void 0&&(d[n].lastValidSplit=d[n].splits.length-1),!t){const r=la(d[n].courseid)+2;for(;d[n].splits.length<r;)d[n].splits.push(d[n].splits[d[n].splits.length-1]),d[n].legSplits.push(0)}}}function el(t){document.getElementById("rg2-load-progress-label").textContent=f("Saving results",""),An()>0&&wi(t,at()),ca(),at()&&(Oi(),W.generateControlList())}function tl(t){if(document.getElementById("rg2-load-progress-label").textContent=f("Saving routes",""),An()>0&&Li(t),Vr(),Mi(),h.managing())rg2Config.manager.eventFinishedLoading();else{if(document.getElementById(h.TAB_COURSES).removeAttribute("disabled"),document.getElementById(h.TAB_RESULTS).removeAttribute("disabled"),Sn()?document.getElementById(h.TAB_DRAW).setAttribute("disabled",""):document.getElementById(h.TAB_DRAW).removeAttribute("disabled"),ke()!==h.TAB_DRAW){const i=ki();document.getElementById(i).click()}const s=Si();for(let i=0;i<s.length;i+=1){let l=new Event("click",{bubbles:!0});const r=document.querySelector(`.showtrack[data-id='${s[i]}']`);r&&(r.checked=!0,r.dispatchEvent(l))}const n=xi();for(let i=0;i<n.length;i+=1){let l=new Event("click",{bubbles:!0});const r=document.querySelector(`.showcourse[data-courseid='${n[i]}']`);r&&(r.checked=!0,r.dispatchEvent(l))}}document.getElementById("rg2-load-progress").classList.add("d-none"),w()}function sl(){const t=fe();let e=[];const s=L.drawnRoutes;for(let n=0;n<s.length;n+=1)s[n].eventid===t&&e.push(s[n]);for(let n=0;n<e.length;n+=1)for(let i=0;i<d.length;i+=1)d[i].resultid===e[n].id&&(d[i].canDelete=!0,d[i].token=e[n].token)}function en(){document.getElementById("rg2-result-table").querySelectorAll("#results-accordion .accordion-item").forEach(s=>{const n=s.querySelectorAll(".resulttable tbody tr:not(.d-none)");s.querySelector(".runners-table-course-header").setAttribute("data-runners",n.length)})}function nl(){for(let t=0;t<d.length;t+=1)d[t].resultid<h.GPS_RESULT_OFFSET?d[t].displayOrder=t:d[t].displayOrder=Wi(d[t].rawid)}function il(t,e){for(let s=0;s<d.length;s+=1)d[s].rawid===t&&(d[s].userColour=e,d[s].trackColour=e)}function ll(){let t=document.getElementById("rg2-result-search");if(d.length===0){t.classList.add("d-none");return}t.innerHTML=`<form class="d-flex pb-2" role="search">
  <input class="form-control mx-2" type="search" aria-label="${f("Search")}">
  <i class="bi-search mx-2"></i>
  </form>`;let e=document.getElementById("rg2-result-table");t.addEventListener("keyup",s=>{const n=s.target.value.toUpperCase(),i=e.querySelectorAll("tbody tr");for(let l=0;l<i.length;l+=1)i[l].innerText.toUpperCase().indexOf(n)>-1?i[l].classList.remove("d-none"):i[l].classList.add("d-none");en()})}function Ne(t,e){for(let s=0;s<d.length;s+=1)d[s].resultid===t&&(d[s].displayScoreCourse=e)}function rl(){for(let t=0;t<d.length;t+=1)if(d[t].resultid>=h.GPS_RESULT_OFFSET){const e=Qs(d[t].rawid);e!==void 0&&e.scorex!==void 0&&(d[t].scorex=e.scorex,d[t].scorey=e.scorey,d[t].scorecodes=e.scorecodes)}}function vs(t,e){for(let s=0;s<d.length;s+=1)(d[s].courseid===t||h.DISPLAY_ALL_COURSES===t)&&d[s].setTrackDisplay(e);ns()}function al(t,e){for(let s=0;s<d.length;s+=1)d[s].resultid===parseInt(t,10)&&d[s].setTrackDisplay(e);ns()}function ol(t,e){return t.courseid>e.courseid?1:e.courseid>t.courseid?-1:t.rawid===e.rawid?t.resultid-e.resultid:t.displayOrder-e.displayOrder}class tn{constructor(e){const s=Js(e);this.name=s.name,this.initials=s.initials,this.resultid=e,this.rawid=s.rawid,this.starttime=s.starttime,this.splits=s.splits,this.trackColour=s.trackColour,this.userColour=s.userColour;let n;s.isScoreEvent?(n={},n.name=s.coursename,n.x=s.scorex,n.y=s.scorey,n.codes=s.scorecodes):n=te(s.courseid),this.coursename=n.name,this.nextStopTime=h.VERY_HIGH_TIME_IN_SECS,this.x=[],this.y=[],this.cumulativeDistance=[],this.cumulativeDistance[0]=0,this.legTrackDistance=[],this.legTrackDistance[0]=0,this.cumulativeTrackDistance=[],this.cumulativeTrackDistance[0]=0,s.hasValidTrack?this.expandTrack(s.trackx,s.tracky,s.xysecs):this.expandTrack(n.x,n.y,s.splits),this.addTrackDistances(n,s)}addTrackDistances(e,s){const n=this.cumulativeDistance.length-1;if(e.codes!==void 0)if(s.splits.length>1)for(let i=1;i<e.codes.length;i+=1){let l;s.splits[i]<=n?l=s.splits[i]:l=n,this.cumulativeTrackDistance[i]=this.cumulativeDistance[l],this.legTrackDistance[i]=this.cumulativeTrackDistance[i]-this.cumulativeTrackDistance[i-1]}else this.legTrackDistance[1]=this.cumulativeDistance[n],this.cumulativeTrackDistance[1]=this.cumulativeDistance[n]}expandTrack(e,s,n){let i=0,l=0,r=e[0],o=s[0],g=0,p=0;this.x[0]=e[0],this.y[0]=s[0];let m=yt();m===void 0&&(m=1);for(let y=1;y<n.length;y+=1){let v=e[y],k=s[y],E=v-r,T=k-o;p=p+X(v,k,r,o)*m;let x=p-g;l=n[y],l===0&&(l=i+1);let M=l-i;for(let z=i+1;z<l;z+=1)this.x[z]=Math.round(r+(z-i)*E/M),this.y[z]=Math.round(o+(z-i)*T/M),this.cumulativeDistance[z]=Math.round(g+(z-i)*x/M);this.x[l]=v,this.y[l]=k,this.cumulativeDistance[l]=Math.round(p),r=v,o=k,g=p,i=l}}}const Je=[{id:"rg2-stats-summary",title:"Summary",active:"true"},{id:"rg2-legs",title:"Leg times"},{id:"rg2-cumulative",title:"Cumulative times"},{id:"rg2-split-times",title:"Split times"},{id:"rg2-time-loss",title:"Time loss"}],dl=['<div id="rg2-stats-summary" class="container"></div><div style="height: 400px;"><canvas id="rg2-splits-chart"></canvas></div>','<div id="rg2-leg-table" style="width: 950px; height: 100%" class="ag-theme-balham"></div>','<div id="rg2-race-table" style="width: 950px; height: 100%;" class="ag-theme-balham"></div>',`<div id="rg2-results-table" class="rg2-results-table-container">
     <div id="rg2-results-grid-wrapper">
       <div id="rg2-results-grid" style="height: 100%" class="ag-theme-balham"></div>
     </div>
   </div>`,`<div id="rg2-time-loss" class="container">
     <div class="d-flex align-items-center justify-content-between">
       <div class="d-flex align-items-center">
         <div id="rg2-control-change" class="pe-4">
           <button id="rg2-stats-control-back" class="btn btn-outline-primary btn-sm p-2">&lt;</button>
           <button id="rg2-stats-control-forward" class="btn btn-outline-primary btn-sm p-2">&gt;</button>
         </div>
         <div id="rg2-control-number" class="fw-bold pe-2"></div>
       </div>
       <div id="rg2-loss-details" class="d-flex justify-content-center"></div>
     </div>
     <canvas id="rg2-loss-chart"></canvas>
   </div>`];let P=null,Me=null,u=[],Rt=!1,A=null,U=0,J=[],Q=[],D=null,qe,Ve,F=1,cl=9,q=2;const sn="#rg2-stats-summary-tab-label";let Xt=sn,Wt=null;function ul(){if(A.excludeType===h.EXCLUDED_REAL_SPLITS)for(let t=0;t<u.length;t+=1){let e=0;for(let s=1;s<A.exclude.length;s+=1){if(A.exclude[s]){const n=Math.min(u[t].splits[s]-u[t].splits[s-1]-e,A.allowed[s]);e=e+n}u[t].splits[s]=u[t].splits[s]-e,u[t].legSplits[s]=u[t].splits[s]-u[t].splits[s-1]}}}function hl(t){for(let e=0;e<u.length;e+=1){t===0&&(u[e].predictedSplits=[],u[e].loss=[],u[e].totalLoss=[]),u[e].predictedSplits[t]=[],u[e].predictedSplits[t][0]=0,u[e].loss[t]=[],u[e].loss[t][0]=0;let s=0;for(let n=0;n<U;n+=1)u[e].performanceIndex[t]>0?u[e].predictedSplits[t][n]=parseInt(A.refLegTime[t][n]/u[e].normalPerformanceIndex[t],10):u[e].predictedSplits[t][n]=u[e].legSplits[n],u[e].loss[t][n]=u[e].legSplits[n]-u[e].predictedSplits[t][n],u[e].loss[t][n]<0&&(u[e].loss[t][n]=0),s=s+u[e].loss[t][n];u[e].totalLoss[t]=s}}function fl(t){t===0&&(A.refLegTime=[],A.refTime=[]);let e=[],s=[];for(let n=0;n<U;n+=1){if(e.length=0,!A.exclude[n])for(let l=0;l<u.length;l+=1)u[l].iterSplits[t][n]!==0&&e.push(u[l].iterSplits[t][n]);const i=Bt(e,25);s.push(i.median)}A.refLegTime[t]=s.slice(0),A.refTime[t]=s.reduce((n,i)=>n+i);for(let n=0;n<u.length;n+=1){t===0&&(u[n].refRatio=[],u[n].performanceIndex=[],u[n].normalPerformanceIndex=[],u[n].totalSecs=[]),u[n].refRatio[t]=[];const i=[];for(let p=0;p<U;p+=1)u[n].iterSplits[t][p]===0?u[n].refRatio[t][p]=0:u[n].refRatio[t][p]=A.refLegTime[t][p]/u[n].iterSplits[t][p],i.push(u[n].refRatio[t][p]);const l=i.filter(p=>p>0),r=Bt(l,100);u[n].performanceIndex[t]=r.median,u[n].totalSecs[t]=u[n].iterSplits[t].reduce((p,m)=>p+m);let o=0,g=0;for(let p=0;p<U;p+=1)u[n].iterSplits[t][p]!==0&&(o=o+u[n].refRatio[t][p]*A.refLegTime[t][p],g=g+A.refLegTime[t][p]);o===0?u[n].normalPerformanceIndex[t]=0:u[n].normalPerformanceIndex[t]=o/g}}function gl(t){for(let e=0;e<u.length;e+=1){t===0&&(u[e].iterSplits=[]);let s=[];for(let n=0;n<U;n+=1)t===0?s.push(u[e].legSplits[n]):s.push(u[e].predictedSplits[t-1][n]);u[e].iterSplits[t]=s.slice(0)}}function nn(){F=F===P.splits.length-1?1:F+1,qt()}function ln(){F=F>1?F-1:P.splits.length-1,qt()}function bs(t){let e=u[D].rawid;try{const s=Cn();let n=s.findIndex(r=>r?r.courseid===A.courseid:!1);t<0?n=n===s.length-1?1:n+1:n=n>1?n-1:s.length-1;const i=s[n].courseid,l=Zs(i);l.length>0&&(e=l[0].rawid)}catch(s){console.log("Error switching to new course: "+s)}it(e)}function nt(t){t<0?D=D===u.length-1?0:D+1:D=D>0?D-1:u.length-1,it(u[D].rawid)}function ml(t){let e="",s="";P.splits.length-1===F?e=f("Finish"):(e=f("Control"),s=": "+F);let n=`<div>${e}${s}</div>`;if(document.getElementById("rg2-control-number").innerHTML=n,n="",A.exclude[F])n=f("Control excluded","");else{const i=t.filter(r=>r.loss>0).map(r=>r.loss),l=Bt(i,100);n=`<div class="px-2 fw-bold">${f("Runners with loss")}: ${l.count}</div >`,n+=`<div class="px-2 fw-bold">${f("Average")}: ${parseInt(l.mean,10)}s (${parseInt(l.mean*1e3/A.refLegTime[q][F],10)/10}%)</div>`,n+=`<div class="px-2 fw-bold">${f("Median")}: ${l.median}s (${parseInt(l.median*1e3/A.refLegTime[q][F],10)/10}%)</div>`}document.getElementById("rg2-loss-details").innerHTML=n}function pl(){document.getElementById("rg2-stats-panel-tab-headers").addEventListener("show.bs.tab",i=>{Ll(i.target)});const t=document.getElementsByClassName("rg2-stats-name-back");for(let i of t)i.addEventListener("click",()=>{nt(1)});const e=document.getElementsByClassName("rg2-stats-name-forward");for(let i of e)i.addEventListener("click",()=>{nt(-1)});const s=document.getElementsByClassName("rg2-stats-course-back");for(let i of s)i.addEventListener("click",()=>{bs(1)});const n=document.getElementsByClassName("rg2-stats-course-forward");for(let i of n)i.addEventListener("click",()=>{bs(-1)});document.getElementById("rg2-stats-control-back").addEventListener("click",ln),document.getElementById("rg2-stats-control-forward").addEventListener("click",nn),document.getElementById(Xt.replace("#","")).click()}function qt(){Ve!==void 0&&(Ve.destroy(),Ve=void 0);const t=document.getElementById("rg2-loss-chart"),e=x=>l.length===0?h.DARK_GREEN_30:l[x.dataIndex].activeRunner?h.DARK_GREEN:h.DARK_GREEN_30,s=x=>l.length===0?h.RED_30:l[x.dataIndex].activeRunner?h.RED:h.RED_30,n=x=>l.length===0?h.BLUE_30:l[x.dataIndex].activeRunner?h.BLUE:h.BLUE_30,i=x=>l.length===0?h.PURPLE_30:l[x.dataIndex].activeRunner?h.PURPLE:h.PURPLE_30,l=[];A.exclude[F]||u.map(x=>{if(parseInt(x.legSplits[F],10)>0){let M={};const z=parseInt(x.loss[q][F],10),Ie=parseInt(x.predictedSplits[q][F],10),we=parseInt(x.legSplits[F],10);M.loss=z,M.predicted=z===0?0:Ie,M.rawPredicted=Ie,M.actual=we<=Ie?we:0,M.gain=we<=Ie?Ie-we:0,M.realSplit=we,M.pos=x.legpos[F],M.name=x.name,x.rawid===Me&&(M.activeRunner=!0),l.push(M)}}),l.sort((x,M)=>x.realSplit-M.realSplit);const r=l.map(x=>x.predicted),o=l.map(x=>x.actual),g=l.map(x=>x.loss),p=l.map(x=>x.gain),m=l.map(x=>x.pos),y=l.map(()=>A.refLegTime[q][F]),v=u.reduce((x,M)=>Math.max(x,M.legSplits[F]),0),k=120,E=parseInt((v+k-1)/k,10)*k;ml(l),Ve=new Wt(t,{data:{labels:m,datasets:[{label:"Actual",type:"bar",data:o,backgroundColor:e},{label:"Gain",type:"bar",data:p,yAxisID:"yLoss",backgroundColor:n},{label:"Predicted",type:"bar",data:r,yAxisID:"yLoss",backgroundColor:i},{label:"Loss",type:"bar",data:g,yAxisID:"yLoss",backgroundColor:s},{label:"Reference time",type:"line",data:y,borderColor:h.RED,backgroundColor:h.WHITE,borderDash:[5,5],yAxisID:"yLoss",pointStyle:"circle",pointRadius:0,pointHoverRadius:0}]},options:{scales:{x:{stacked:!0,title:{display:!0,text:"Position"}},yLoss:{stacked:!0,min:0,max:E,title:{display:!0,text:"Time (s)"}}},plugins:{tooltip:{callbacks:{label(x){let M=x.dataset.label+": ";return x.dataset.label==="Loss"?M+=B(l[x.dataIndex].loss):x.dataset.label==="Gain"?M+=B(l[x.dataIndex].gain):x.dataset.label==="Actual"?M+=B(l[x.dataIndex].actual):M+=B(l[x.dataIndex].predicted),M},title(x){return l[x[0].dataIndex].name+": "+B(l[x[0].dataIndex].realSplit)}}}}}});const T=document.querySelector("#rg2-loss-chart");T.onwheel=x=>{x.preventDefault(),x.deltaY<0?nn():ln()}}function yl(){F=1,qt()}function vl(){let t=[];for(let e=1;e<A.codes.length;e+=1){t.length=0;for(let i=0;i<u.length;i+=1)u[i].resultid===u[i].rawid&&(u[i].isScoreEvent?u[i].variant===A.courseid&&t.push({time:u[i].legSplits[e],id:i}):u[i].courseid===A.courseid&&t.push({time:u[i].legSplits[e],id:i}));t.sort(ks);let s=0,n=0;for(let i=0;i<t.length;i+=1){if(A.exclude[e]){u[t[i].id].legpos[e]=0;continue}t[i].time!==n?t[i].time===0?(u[t[i].id].legpos[e]=0,n=0,s=0):(u[t[i].id].legpos[e]=i+1,n=t[i].time,s=i+1):u[t[i].id].legpos[e]=s}}t.length=0;for(let e=1;e<A.codes.length;e+=1){t.length=0;let s=0;for(let l=0;l<u.length;l+=1)u[l].resultid===u[l].rawid&&(u[l].isScoreEvent?u[l].variant===A.courseid&&(e>u[l].lastValidSplit?s=0:s=u[l].splits[e],t.push({time:s,id:l})):u[l].courseid===A.courseid&&(e>u[l].lastValidSplit?s=0:s=u[l].splits[e],t.push({time:s,id:l})));t.sort(ks);let n=0,i=0;for(let l=0;l<t.length;l+=1)t[l].time!==i?t[l].time===0?(u[t[l].id].racepos[e]=0,n=0,i=0):(u[t[l].id].racepos[e]=l+1,i=t[l].time,n=l+1):u[t[l].id].racepos[e]=n}}function bl(){qe!==void 0&&(qe.destroy(),qe=void 0);const t=(E,T)=>E.p0.skip||E.p1.skip?T:void 0,e=document.getElementById("rg2-splits-chart"),s=u[D],n=s.legpos.map((E,T,x)=>T===x.length-1?"F":T),i=rn(),l=s.legpos.map(E=>E===0?NaN:E),r=s.loss[q].map((E,T)=>s.legpos[T]===0?NaN:E),o=s.predictedSplits[q].map((E,T)=>s.legpos[T]===0?NaN:E>s.legSplits[T]?E-s.legSplits[T]:0),g=s.legpos.map(()=>i.average),p=r.reduce((E,T)=>Math.max(E,isNaN(T)?0:T),0),m=o.reduce((E,T)=>Math.max(E,isNaN(T)?0:T),0),y=120,v=parseInt((Math.max(p,m)+y-1)/y,10)*y;qe=new Wt(e,{data:{labels:n,datasets:[{label:"Leg position",type:"line",data:l,borderColor:h.PURPLE,backgroundColor:h.PURPLE_30,yAxisID:"yPosition",segment:{borderColor:E=>t(E,"rgb(0,0,0,0.2)"),borderDash:E=>t(E,[6,6])},spanGaps:!0},{label:"Average leg position",type:"line",data:g,borderColor:h.RED,backgroundColor:h.WHITE,borderDash:[5,5],yAxisID:"yPosition",pointStyle:"circle",pointRadius:0,pointHoverRadius:0},{label:"Time loss",type:"bar",data:r,borderColor:h.RED,backgroundColor:h.RED_30,yAxisID:"yLoss",segment:{borderColor:E=>t(E,"rgb(0,0,0,0.2)"),borderDash:E=>t(E,[6,6])}},{label:"Time gain",type:"bar",data:o,borderColor:h.BLUE,backgroundColor:h.BLUE_30,yAxisID:"yLoss",segment:{borderColor:E=>t(E,"rgb(0,0,0,0.2)"),borderDash:E=>t(E,[6,6])}}]},options:{maintainAspectRatio:!1,responsive:!0,scales:{x:{min:1,title:{display:!0,text:f("Control","")},stacked:!0},yPosition:{type:"linear",display:!0,position:"left",min:0,max:parseInt((u.length+9)/10,10)*10,title:{display:!0,text:"Leg position"}},yLoss:{type:"linear",display:!0,position:"right",min:0,max:v,grid:{drawOnChartArea:!1},title:{display:!0,text:"Time gain/loss (s)"}}},plugins:{tooltip:{callbacks:{label:function(E){return E.dataset.label==="Time loss"?"Loss: "+B(r[E.dataIndex]):E.dataset.label==="Time gain"?"Gain: "+B(o[E.dataIndex]):E.dataset.label==="Leg position"?"Position: "+l[E.dataIndex]:""},title:function(E){return E[0].label==="F"?f("Finish",""):f("Control","")+" "+E[0].label}}}}}});const k=document.querySelector("#rg2-splits-chart");k.onwheel=E=>{E.preventDefault(),E.deltaY<0?nt(-1):nt(1)}}function xl(){const t=[{headerName:f("Pos",""),field:"position",cellDataType:"text",width:60,pinned:"left",sortable:!0},{headerName:f("Name",""),field:"name",cellDataType:"text",headerClass:"align-left",cellClass:"align-left",width:150,pinned:"left"},{headerName:f("Time",""),field:"time",cellDataType:"text",width:85}];for(let r=1;r<U-1;r+=1)t.push({headerName:r+" ("+A.codes[r]+")",field:"C"+r,cellDataType:"text",cellRenderer:Ss,width:110});t.push({headerName:f("F",""),field:"finish",cellDataType:"text",cellRenderer:Ss,width:110}),t.push({headerName:f("Loss",""),field:"loss",cellDataType:"text",width:100}),t.push({headerName:f("Performance",""),field:"performance",cellDataType:"text",width:100}),t.push({headerName:f("Consistency",""),field:"consistency",cellDataType:"text",width:100});let e=[];u.sort(function(r,o){return r.racepos[r.splits.length-1]<=0?1:o.racepos[o.splits.length-1]<=0?-1:r.racepos[r.splits.length-1]-o.racepos[o.splits.length-1]}),D=dn(Me);for(let r=0;r<u.length;r+=1){let o={};const g=u[r];g.racepos[U-1]==0?o.position="":o.position=g.racepos[U-1],o.name=g.name,o.time=g.time;for(let m=1;m<U-1;m+=1)g.splits[m]===g.splits[m-1]?o["C"+m]={split:"0:00",pos:g.racepos[m],loss:!1}:o["C"+m]={split:B(g.splits[m]),pos:g.racepos[m],loss:!1};o.finish={split:B(g.splits[U-1]),pos:g.racepos[U-1]},o.loss=B(g.timeInSecs-g.totalLoss[q]),o.performance=(g.performanceIndex[0]*100).toFixed(1);const p=g.refRatio[0].filter(m=>m>0);o.consistency=(100*an(p)).toFixed(1),e.push(o),o={};for(let m=1;m<U-1;m+=1)o["C"+m]={split:B(g.legSplits[m]),pos:g.legpos[m],loss:g.loss[q][m]>19};o.finish={split:B(g.legSplits[U-1]),pos:g.legpos[U-1],loss:g.loss[q][U-1]>19},o.loss=B(g.totalLoss[q]),e.push(o)}const s={columnDefs:t,rowData:e,defaultColDef:{headerClass:"align-center",cellClass:"align-center"}},n=document.getElementById("rg2-map-canvas").height*.98-120,i=document.getElementById("rg2-results-grid-wrapper");i.removeAttribute("style"),i.setAttribute("style","height: "+n+"px;");const l=document.getElementById("rg2-results-grid");l.innerHTML="",rg2Config.createGrid(l,s)}function El(){const t=rn(),e=g=>`${g}`,s=`<div class="rg2-stats-runner-change pe-4">
      <button class="rg2-stats-name-back btn btn-outline-primary btn-sm p-2">
        &lt;
      </button>
      <button class="rg2-stats-name-forward btn btn-outline-primary btn-sm p-2">
        &gt;
      </button>
    </div >`,n=`<div class="rg2-stats-course-change pe-4">
      <button class="rg2-stats-course-back btn btn-outline-primary btn-sm p-2">
        &lt;
      </button>
      <button class="rg2-stats-course-forward btn btn-outline-primary btn-sm p-2">
        &gt;
      </button>
    </div >`;let i=e('<div class="d-flex align-items-center justify-content-between pb-4">');i+=e('<div class="d-flex align-items-center">'),i+=e(`${s}`),i+=e(`<div class="fw-bold pe-4">${P.name}</div>`),i+=e(`<div class="fw-bold pe-4">${P.time}</div>`),i+=e(`<div class="fw-bold pe-4">(${u[D].racepos[U-1]}/${u.length})</div>`);let l="";Ml(P.timeInSecs)&&(l=` (${(100*u[D].totalLoss[q]/P.timeInSecs).toFixed(1)}%)`),i+=e(`<div class="fw-bold pe-4">${f("Estimated loss")}: ${B(u[D].totalLoss[q])}${l}</div>`),i+=e("</div>"),i+=e('<div class="d-flex align-items-center">'),i+=e(`<div class="fw-bold pe-4">${P.coursename}</div><div>${n}</div>`),i+=e("</div></div>");const r=document.getElementsByClassName("rg2-stats-title-row");for(let g of r)g.innerHTML=i;i='<div class="d-flex align-items-center">',i+=e(`<div class="fw-bold pe-4">${f("Average leg position")}: ${t.average} (${f("Best","")}: ${t.best}, ${f("Worst")}: ${t.worst})</div >`),i+=e(`<div  class="fw-bold pe-4">${f("Performance")} ${(P.performanceIndex[0]*100).toFixed(1)}%</div>`);const o=u[D].refRatio[0].filter(g=>g>0);i+=e(`<div  class="fw-bold">${f("Consistency")} ${(100*an(o)).toFixed(1)}%</div>`),i+=e("</div>"),document.getElementById("rg2-stats-summary").innerHTML=i}function Sl(){const t=[];for(let n=0;n<u[D].splits.length;n+=1){let i={};if(i.name=P.name,n===0?i.control="S":n==u[D].splits.length-1?i.control="F":i.control=n+" ("+A.codes[n]+")",n===0?i.time="0:00":i.time=B(u[D].legSplits[n]),n===0||u[D].legpos[n]===0||A.exclude[n]?i.position="-":i.position=u[D].legpos[n],n===0||A.exclude[n]?i.performance="-":i.performance=(100*u[D].refRatio[0][n]).toFixed(1),A.exclude[n]?i.best="-":i.best=B(J[n][0].t),n===0||A.exclude[n])i.who="-";else{let r=J[n][0].name;for(let o=1;o<J[n].length&&J[n][0].t===J[n][o].t;o+=1)r+=", "+J[n][o].name;i.who=r}const l=u[D].legSplits[n]-J[n][0].t;if(n===0||u[D].legSplits[n]<=0?i.behind="-":i.behind=B(l),n===0||u[D].legSplits[n]<=0?i.percent=0:i.percent=parseInt(l*100/J[n][0].t,10),A.exclude[n]?i.predicted="-":i.predicted=B(u[D].predictedSplits[q][n]),u[D].legSplits[n]<=0)i.loss="";else{const r=u[D].predictedSplits[q][n]-u[D].legSplits[n];i.loss=r>=0?B(r):"-"+B(r*-1)}t.push(i)}const e={columnDefs:[{headerName:f("Control",""),field:"control",width:80},{headerName:f("Time",""),field:"time",width:80,comparator:je.bind(this)},{headerName:f("Position",""),field:"position",width:75},{headerName:f("Performance",""),field:"performance",width:95,comparator:Bl.bind(this)},{headerName:f("Best",""),field:"best",width:80},{headerName:f("Who",""),field:"who",headerClass:"align-left",cellClass:n=>n.data.who.indexOf(n.data.name)>-1?"rg2-green-text align-left":"align-left",flex:1,tooltipField:"who"},{headerName:f("Behind",""),field:"behind",width:80,comparator:je.bind(this)},{headerName:"%",field:"percent",width:60},{headerName:f("Predicted",""),field:"predicted",width:100,comparator:je.bind(this)},{headerName:f("+/-",""),field:"loss",width:75,cellClass:n=>n.data.loss.substring(0,1)==="-"?"rg2-red-text align-center":"align-center",comparator:je.bind(this)}],rowData:t,domLayout:"autoHeight",defaultColDef:{headerClass:"align-center",cellClass:"align-center",sortable:!0}},s=document.getElementById("rg2-leg-table");s.innerHTML="",rg2Config.createGrid(s,e)}function kl(){const t=[];let e=0;for(let i=0;i<u[D].splits.length;i+=1){let l={};if(l.name=P.name,i==0?l.control="S":i==u[D].splits.length-1?l.control="F":l.control=i+" ("+A.codes[i]+")",i==0?l.time="0:00":u[D].splits[i]===u[D].splits[i-1]?l.time="":l.time=B(u[D].splits[i]),i===0||u[D].racepos[i]===0?l.position="-":l.position=u[D].racepos[i],l.best=B(Q[i][0].t),i===0)l.who="-";else{let o=Q[i][0].name;for(let g=1;g<Q[i].length&&Q[i][0].t===Q[i][g].t;g+=1)o+=", "+Q[i][g].name;l.who=o}const r=u[D].splits[i]-Q[i][0].t;i===0||u[D].racepos[i]===0?l.behind="-":l.behind=B(r),i===0||u[D].racepos[i]===0?l.percent="-":l.percent=parseInt(r*100/Q[i][0].t,10),e=e+u[D].loss[q][i],l.loss=B(e),t.push(l)}const s={columnDefs:[{headerName:f("Control",""),field:"control",width:88},{headerName:f("Time",""),field:"time",width:85},{headerName:f("Position",""),field:"position",width:100},{headerName:f("Best",""),field:"best",width:85},{headerName:f("Who",""),field:"who",headerClass:"align-left",cellClass:i=>i.data.who.indexOf(i.data.name)>-1?"rg2-green-text align-left":"align-left",flex:1,tooltipField:"who"},{headerName:f("Behind",""),field:"behind",width:85},{headerName:"%",field:"percent",width:85},{headerName:"Loss",field:"loss",width:100}],rowData:t,domLayout:"autoHeight",defaultColDef:{headerClass:"align-center",cellClass:"align-center"}},n=document.getElementById("rg2-race-table");n.innerHTML="",rg2Config.createGrid(n,s)}function Bt(t,e){let s=t.slice();if(s.length===0)return{mean:0,median:0,count:0};s.sort(function(o,g){return o-g});let n=0,i=s.length;if(e<100){const r=Math.max(parseInt(i*e/100,10),3);s.splice(r),i=s.length}for(let r=0;r<i;r+=1)n=n+s[r];let l;return i===1?l=s[0]:i%2===0?l=(s[i/2-1]+s[i/2])/2:l=s[Math.floor(i/2)],{mean:n/i,median:l,count:i}}function rn(){let t=0,e=0,s=0,n=9999;for(let l=1;l<P.legpos.length;l+=1)P.legpos[l]!==0&&(t+=P.legpos[l],e+=1,n>P.legpos[l]&&(n=P.legpos[l]),s<P.legpos[l]&&(s=P.legpos[l]));let i;return e>0?i=(t/e).toFixed(1):(i=0,n=0,s=0),{best:n,worst:s,average:i}}function Tl(t){return t.reduce((e,s)=>e+s,0)/t.length}function xs(t){return t==="-"?0:parseFloat(t)}function an(t){if(t.length===0)return 0;const e=Tl(t);return Math.sqrt(t.reduce((s,n)=>s+Math.pow(n-e,2),0)/t.length)}function Il(){let t='<ul class="nav nav-pills" id="rg2-stats-panel-tab-headers" role="tablist">';for(let e of Je){const s=f(e.title),n=e.active?" active":"",i=e.active?"":"tabindex='-1'";t+=`<li class="nav-item${n}" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#${e.id}-tab"
      type="button" role="tab" ${i}>
      <div id="${e.id}-tab-label">${s}</div>
    </button>
    </li>`}return t+="</ul>",t}function wl(){const t='<div class="rg2-stats-title-row container"></div>';let e='<div id="rg2-stats-table"><div class="tab-content" id="rg2-stats-panel-tab-body">';for(let s=0;s<Je.length;s+=1){const n=Je[s].active?" active":"";e+=`<div class="tab-pane fade ${n} pt-2" id="${Je[s].id}-tab" role="tabpanel" tabindex="${s}">
      ${t}${dl[s]}</div>`}return e+="</div></div></div>",e}function Es(t){return t==="-"?0:parseFloat(t.replace(":","."))}function Ll(t){var e;Xt=(e=t==null?void 0:t.dataset)==null?void 0:e.bsTarget}async function Dl(){const{createGrid:t,ModuleRegistry:e}=await Ke(async()=>{const{createGrid:i,ModuleRegistry:l}=await import("./grid-CgsJkZsf.js").then(r=>r.m);return{createGrid:i,ModuleRegistry:l}},[],import.meta.url);rg2Config.createGrid=t;const{ClientSideRowModelModule:s}=await Ke(async()=>{const{ClientSideRowModelModule:i}=await import("./grid-CgsJkZsf.js").then(l=>l.a);return{ClientSideRowModelModule:i}},[],import.meta.url);Wt=(await Ke(()=>import("./node-modules-CPWXqQ3f.js").then(i=>i.b),[],import.meta.url)).default,e.registerModules([s])}function Cl(t){Me=t,Rt=at(),P=Qs(Me),Rt?u=Ni(P.variant):u=Zs(P.courseid),Al(P.courseid),ul(),vl(),D=dn(Me)}function Al(t){if(Rt?A={courseid:P.variant,codes:P.scorecodes,exclude:!1}:A=te(t),U=A.codes.length,U<=2)throw new on(f("No splits available."));J.length=0,Q.length=0;let e=[],s=[];for(let n=0;n<U;n+=1){e.length=0,s.length=0;for(let i=0;i<u.length;i+=1)n===0?(e.push({t:0,name:"",pos:0}),s.push({t:0,name:"",pos:0})):(e.push({t:u[i].legSplits[n],name:u[i].name,pos:u[i].legpos[n]}),n<=u[i].lastValidSplit&&s.push({t:u[i].splits[n],name:u[i].name,pos:u[i].racepos[n]}));e.sort(function(i,l){return i.t===0?1:l.t===0?-1:i.t-l.t}),s.sort(function(i,l){return i.t-l.t}),J.push(e.slice()),Q.push(s.slice())}}function Ml(t){return!isNaN(parseFloat(t))&&isFinite(t)?t>0:!1}function Rl(){for(let t=0;t<=cl;t+=1)gl(t),fl(t),hl(t)}function Bl(t,e){return xs(t)-xs(e)}function it(t){try{return Cl(t),Rl(),El(),bl(),yl(),Sl(),kl(),xl(),pl(),!0}catch(e){e instanceof on?Y(f("Statistics"),e.message):Y(f("Statistics",""),f("Data inconsistency.","")),Gt.getInstance(document.getElementById("rg2-right-info-panel")).hide()}return!1}function Ss(t){if(t.value.split==="0:00")return"";let e=t.value.split,s="";return t.value.pos!==0&&(e+=" ("+t.value.pos+")",t.value.pos===1&&(s="rg2-first"),t.value.pos===2&&(s="rg2-second"),t.value.pos===3&&(s="rg2-third")),t.value.loss&&(s+=" rg2-lost-time"),'<span class="'+s+'">'+e+"</span>"}function on(t){this.message=t}function dn(t){for(let e=0;e<u.length;e+=1)if(u[e].rawid===t)return P=u[e],e;return null}function Pl(t,e){if(!Jt())return Y(f("Statistics",""),f("No statistics available for this event format.","")),!1;Xt=sn,rg2Config.createGrid?(it(t),e()):Dl().then(()=>{it(t),e()}).catch(()=>{console.log("Error loading Grid and Chart"),Y("Error loading Grid and Chart","Statistics functionality failed to load.")})}function ks(t,e){return t.time===0?1:e.time===0?-1:t.time-e.time}function je(t,e){return Es(t)-Es(e)}const Pt=document.getElementById("rg2-show-info-panel-control"),oe=document.getElementById("rg2-right-info-panel"),Vt=document.getElementById("rg2-right-info-panel-title"),jt=new Gt(oe,{backdrop:!1}),pe=document.getElementById("rg2-left-info-panel"),Ts=document.getElementById("rg2-left-info-panel-title");let Is=document.getElementById("rg2-left-info-panel-body");const cn=new Gt(pe,{backdrop:!1});pe.style.width="420px";pe.addEventListener("hidden.bs.offcanvas",()=>{Pt.classList.remove("d-none")});zt();const It=10,wt=-10;function _l(){return!document.getElementById("rg2-animation-controls").classList.contains("d-none")}function Ol(){document.querySelector("label[for=rg2-select-course]").innerHTML=`${f("Select course")}`,document.querySelector("label[for=rg2-select-name]").innerHTML=`${f("Select name")}`,document.querySelector("label[for=rg2-name-entry]").innerHTML=f("Name"),document.querySelector("#rg2-name-entry").addEventListener("input",()=>{As()}),document.querySelector("label[for=rg2-time-entry]").innerHTML=f("Time"),document.querySelector("#rg2-time-entry").addEventListener("input",()=>{As()});const t=document.getElementById("rg2-new-comments");t.setAttribute("placeholder",f(h.DEFAULT_NEW_COMMENT,"")),t.addEventListener("focus",()=>{document.getElementById("rg2-new-comments").setAttribute("placeholder","")});const e=document.getElementById("btn-three-seconds");e.innerHTML=f("+3 secs"),e.addEventListener("click",m=>{m.preventDefault(),Lr()});const s=document.getElementById("btn-undo");s.innerHTML=f("Undo"),s.addEventListener("click",m=>{m.preventDefault(),wr()});const n=document.getElementById("btn-save-route");n.innerHTML=f("Save"),n.addEventListener("click",m=>{m.preventDefault(),xr()});const i=document.getElementById("btn-reset-drawing");i.innerHTML=f("Reset"),i.addEventListener("click",m=>{m.preventDefault(),pr()}),document.getElementById("rg2-load-gps-title").innerHTML=f("Load GPS file (GPX or TCX)"),document.getElementById("btn-offset-plus").addEventListener("click",()=>{const m=document.getElementById("rg2-offset-value");let y=parseInt(m.value,10);y<It&&(y=y+1,m.value=y,Lt(y))}),document.getElementById("btn-offset-minus").addEventListener("click",()=>{const m=document.getElementById("rg2-offset-value");let y=parseInt(m.value,10);y>wt&&(y=y-1,m.value=y,Lt(y))}),document.getElementById("rg2-offset-value").addEventListener("input",()=>{const m=document.getElementById("rg2-offset-value");let y=parseInt(m.value,10);isNaN(y)&&(y=0),y<wt&&(y=wt),y>It&&(y=It),m.value=y,Lt(y)});const l=document.getElementById("btn-undo-gps-adjust");l.innerHTML=f("Undo"),l.addEventListener("click",m=>{m.preventDefault(),Ir()});const r=document.getElementById("btn-autofit-gps");r.innerHTML=f("Autofit"),r.addEventListener("click",m=>{m.preventDefault(),Zl()}),document.querySelector("label[for=chk-move-all]").innerHTML=f("Move track and map together (or right click-drag)");const o=document.getElementById("btn-save-gps-route");o.innerHTML=f("Save GPS route"),o.addEventListener("click",m=>{m.preventDefault(),br()}),["Left click to add/lock/unlock a handle","Green - draggable","Red - locked","Right click to delete a handle","Drag a handle to adjust track around locked point(s)"].forEach((m,y)=>{const v=document.getElementById(`draw-text-${y+1}`);v.innerHTML=`${f(m)}.`}),document.getElementById("rg2-load-gps-file").addEventListener("input",m=>{mr(m)})}function Nl(){document.querySelector("label[for=rg2-select-language]").innerHTML=`${f("Language")}`,ii(h.languages),Qe("chk-show-GPS-speed","showGPSSpeed","Show GPS speed colours"),Qe("chk-snap-toggle","snap","Snap to control when drawing"),Qe("chk-show-three-seconds","showThreeSeconds","Show +3 time loss for GPS routes"),me("map-intensity","perCentMapIntensity","Map intensity","%"),me("route-intensity","perCentRouteIntensity","Route intensity","%"),me("control-circle","circleSize","Control circle size"),me("course-width","courseWidth","Course overprint width"),me("route-width","routeWidth","Route width"),me("name-font-size","replayFontSize","Replay label font size");const t=document.getElementById("rg2-gps-speed-slider");t.setAttribute("value1",L.maxSpeed),t.setAttribute("value2",L.minSpeed),t.addEventListener("change",Ul),document.getElementById("rg2-min-gps-speed-label").innerHTML=hn(),document.getElementById("rg2-max-gps-speed-label").innerHTML=un()}function Qe(t,e,s){document.querySelector(`label[for=${t}]`).innerHTML=`${f(s)}`;const n=document.getElementById(t);n.addEventListener("click",i=>{L[e]=i.target.checked,ft(),w()}),n.checked=L[e]}function me(t,e,s,n=""){let i=document.querySelector(`label[for=spn-${t}]`);i.innerHTML=`${f(s)} ${L[e]}${n}`;let l=document.getElementById(`spn-${t}`);l.setAttribute("value",L[e]),l.addEventListener("change",r=>{pi(e,parseInt(r.target.value,10)),i=document.querySelector(`label[for=spn-${t}`),i.innerHTML=`${f(s)} ${L[e]}${n}`,w()})}function $l(){document.body.addEventListener("contextmenu",n=>{n.preventDefault()}),window.addEventListener("resize",()=>{zt(),Kn()}),document.getElementById("rg2-left-info-panel-body").addEventListener("scroll",n=>{document.getElementById("rg2-info-panel").setAttribute(fn(),n.target.scrollTop)}),Xl(),h.managing()||Ol(),ws(),document.getElementById("rg2-logo").addEventListener("click",()=>{cn.toggle()}),document.querySelector("#rg2-info-panel-tab-headers").querySelectorAll('button[data-bs-toggle="tab"]').forEach(n=>{n.addEventListener("shown.bs.tab",i=>{Vl(i)})}),Pt.addEventListener("click",()=>{ws(),Pt.classList.add("d-none")}),Yl()}function Fl(){if(h.managing())return;let t=document.getElementById("rg2-event-list");t.innerHTML=Mr();let e=document.getElementById("rg2-event-table"),s=document.getElementById("rg2-event-search");s.innerHTML=`<form class="d-flex pb-2" role="search">
  <input class="form-control mr-2" type="search" aria-label="${f("Search")}">
  <i class="bi-search ms-2 mt-2"></i>
  </form>`,s.addEventListener("keyup",n=>{let i=n.target.value.toUpperCase(),l=e.getElementsByTagName("tr");for(let r=0;r<l.length;r+=1)l[r].innerText.toUpperCase().indexOf(i)>-1?l[r].classList.remove("d-none"):l[r].classList.add("d-none")}),e.addEventListener("click",n=>{const i=n.target.closest("tr"),l=parseInt(i.dataset.kartatid,10);isNaN(l)||vt(l)})}function Hl(){oe.style.width="800px",Vt.innerHTML="RG2 Version "+h.RG2VERSION,document.getElementById("rg2-about-dialog").classList.remove("d-none"),document.getElementById("rg2-option-controls").classList.add("d-none"),document.getElementById("rg2-stats-dialog").classList.add("d-none");let t=document.getElementById("rg2-event-stats");t.innerHTML=Nr(),document.getElementById("rg2-manager-link").innerHTML=`<a href="${rg2Config.api_url.replace("rg2api.php","?manage")}">Manager Login</a>`,jt.show()}function ws(){cn.show()}function Gl(){oe.style.width="420px",Vt.innerHTML=f("Configuration options"),document.getElementById("rg2-about-dialog").classList.add("d-none"),document.getElementById("rg2-option-controls").classList.remove("d-none"),document.getElementById("rg2-stats-dialog").classList.add("d-none"),Nl(),jt.show()}function _t(t){oe.style.width="1000px",Vt.innerHTML=Il(),document.getElementById("rg2-stats-dialog").innerHTML=wl(),document.getElementById("rg2-about-dialog").classList.add("d-none"),document.getElementById("rg2-option-controls").classList.add("d-none"),document.getElementById("rg2-stats-dialog").classList.remove("d-none"),Pl(t,function(){jt.show()})}function ke(){return document.querySelector("#rg2-info-panel-tab-headers button.active").id}function Ls(t){let e='<div id="rg2-info-panel">';e+='<div class="tab-content" id="rg2-info-panel-tab-body">';for(let s=0;s<t.length;s=s+1){const n=document.getElementById(t[s].body),i=t[s].active?" active show":"";e+=`<div class="tab-pane fade ${i}" id="rg2-${t[s].name}-body" role="tabpanel" 
    aria-labelledby="${t[s].name}" tabindex="${s}">${n.innerHTML}</div>`,n.remove()}return e+="</div></div>",e}function Ds(t){let e='<ul class="nav nav-pills" id="rg2-info-panel-tab-headers" role="tablist">';for(let s=0;s<t.length;s=s+1){const n=t[s].hidden?" d-none":"",i=t[s].active?" active":"",l=t[s].disabled?" disabled ":"";e+=`
    <li class="nav-item" role="presentation">
      <button class="nav-link${i}${n}"${l}id="${t[s].name}" data-bs-toggle="tab"
      data-bs-target="#rg2-${t[s].name}-body"
        type="button" role="tab"><div id="${t[s].name}-label">${f(t[s].title)}</div>
      </button>
    </li>`}return e+="</ul>",e}function un(){return`<i class="bi-emoji-smile rg2-run-green"></i> ${L.maxSpeed.toFixed(1)} min/km`}function hn(){return`<i class="bi-emoji-smile rg2-run-red"></i> ${L.minSpeed.toFixed(1)} min/km`}function fn(){return`scroll-${ke()}`}function Ul(t){L.maxSpeed=t.detail.value1,L.minSpeed=t.detail.value2;const e=document.getElementById("rg2-min-gps-speed-label");e.innerHTML=hn();const s=document.getElementById("rg2-max-gps-speed-label");s.innerHTML=un(),Zi(),w()}function Yl(){document.getElementById("btn-about").addEventListener("click",t=>{Hl()}),document.getElementById("btn-settings").addEventListener("click",t=>{Gl()}),document.getElementById("btn-toggle-controls").addEventListener("click",()=>{W.toggleControlDisplay(),w()}),document.getElementById("btn-stats").addEventListener("click",()=>{_t(1)}),document.getElementById("btn-splitsbrowser").addEventListener("click",()=>{window.open(rg2Config.api_url+"?type=splitsbrowser&id="+fe()+"&_="+Date.now())}),document.getElementById("btn-measure").setAttribute("disabled",""),document.getElementById("btn-runners").setAttribute("disabled",""),document.getElementById("btn-toggle-controls").setAttribute("disabled",""),document.getElementById("btn-stats").setAttribute("disabled",""),document.getElementById("btn-splitsbrowser").setAttribute("disabled","")}function Xl(){const t=[{name:h.TAB_EVENTS,title:"Events",body:"rg2-event-body",active:!0},{name:h.TAB_COURSES,title:"Courses",body:"rg2-course-body",disabled:!0},{name:h.TAB_RESULTS,title:"Results",body:"rg2-result-body",disabled:!0},{name:h.TAB_DRAW,title:"Draw",body:"rg2-draw-body",disabled:!0}],e=[{name:h.TAB_LOGIN,title:"Login",body:"rg2-login-body",active:!0},{name:h.TAB_CREATE,title:"Add event",body:"rg2-add-event-body",hidden:!0},{name:h.TAB_EDIT,title:"Edit event",body:"rg2-edit-event-body",hidden:!0},{name:h.TAB_MAP,title:"Add map",body:"rg2-add-map-body",hidden:!0},{name:h.TAB_DELETE_MAP,title:"Delete maps",body:"rg2-delete-maps-body",hidden:!0}];h.managing()?(Ts.innerHTML=Ds(e),Is.innerHTML=Ls(e)):(Ts.innerHTML=Ds(t),Is.innerHTML=Ls(t))}function Wl(){qr(),Ks(void 0),document.getElementById("rg2-select-name").setAttribute("disabled",""),Jt()?(document.getElementById("rg2-name-select").classList.remove("d-none"),document.getElementById("rg2-enter-name-and-time").classList.add("d-none")):(document.getElementById("rg2-name-select").classList.add("d-none"),document.getElementById("rg2-enter-name-and-time").classList.remove("d-none")),Qe("chk-align-map","alignMap","Align map to next control"),document.getElementById("btn-three-seconds").setAttribute("disabled",""),document.getElementById("btn-undo").setAttribute("disabled",""),document.getElementById("btn-save-route").setAttribute("disabled",""),document.getElementById("btn-reset-drawing").setAttribute("disabled",""),document.getElementById("rg2-load-gps-file").setAttribute("disabled",""),document.getElementById("btn-autofit-gps").setAttribute("disabled",""),document.getElementById("btn-undo-gps-adjust").setAttribute("disabled",""),document.getElementById("btn-save-gps-route").setAttribute("disabled",""),document.getElementById("chk-move-all").checked=!1}function zt(){const t=document.getElementById("rg2-header-container").offsetHeight,e=_l()?document.getElementById("rg2-animation-controls").offsetHeight:0;pe.style.top=`${t}px`,oe.style.top=`${t}px`,pe.style.bottom=`${e}px`,oe.style.bottom=`${e}px`,pe.style.maxWidth=`${window.innerWidth}px`,oe.style.maxWidth=`${window.innerWidth}px`,document.getElementById("rg2-track-names").style.maxHeight=`${window.innerHeight-t-10}px`}function ql(){document.querySelectorAll(".showcourse").forEach(m=>{m.addEventListener("click",y=>{const v=parseInt(y.target.dataset.courseid,10);Ye(v,y.target.checked);const k=document.querySelectorAll(".showcourse");for(let T of k)parseInt(T.dataset.courseid,10)===v&&(T.checked=y.target.checked);const E=document.querySelector(".showallcourses");E.checked=Wr(),Be(v),cs(Rs()),w()})}),document.querySelector(".showallcourses").addEventListener("click",m=>{Mn(m.target.checked);const y=document.querySelectorAll(".showcourse");for(let v of y)v.checked=m.target.checked;Bs(),cs(Rs()),w()}),document.querySelectorAll(".showscorecourse").forEach(m=>{m.addEventListener("click",y=>{Bi(parseInt(y.target.dataset.courseid,10),y.target.checked),w()})}),document.querySelectorAll(".showtrack").forEach(m=>{m.addEventListener("click",y=>{const v=parseInt(y.target.dataset.id,10);al(v,y.target.checked);const k=parseInt(y.target.dataset.courseid,10);document.querySelectorAll(".allcoursetracks").forEach(x=>{parseInt(x.dataset.courseid,10)===k&&(x.checked=Di(k))}),document.querySelectorAll(".alltracks").forEach(x=>{x.checked=fs()}),Be(k),kt(Tt()),w()})});const i=document.querySelectorAll(".deleteroute");for(let m of i)m.addEventListener("click",y=>{er(parseInt(y.target.dataset.resultidx,10))});const l=document.querySelectorAll(".allcoursetracks");for(let m of l)m.addEventListener("click",y=>{let v=parseInt(y.target.dataset.courseid,10);vs(v,y.target.checked);const k=document.querySelectorAll(".allcoursetracks");for(let x of k)parseInt(x.dataset.courseid,10)===v&&(x.checked=y.target.checked);const E=document.querySelectorAll(".showtrack");for(let x of E)parseInt(x.dataset.courseid,10)===v&&(x.checked=y.target.checked);const T=document.querySelectorAll(".alltracks");for(let x of T)x.checked=fs();Be(v),kt(Tt()),w()});const r=document.querySelectorAll(".alltracks");for(let m of r)m.addEventListener("click",y=>{vs(h.DISPLAY_ALL_COURSES,y.target.checked);const v=document.querySelectorAll(".allcoursetracks");for(let E of v)E.checked=y.target.checked;const k=document.querySelectorAll(".showtrack");for(let E of k)E.checked=y.target.checked;Bs(y.target.checked),kt(Tt()),w()});const o=document.querySelectorAll(".showreplay");for(let m of o)m.addEventListener("click",y=>{let v=parseInt(y.target.dataset.id,10);y.target.checked?_n(new tn(v)):Hn(v);const k=Gi(v),E=document.querySelectorAll(".allcoursetracksreplay");for(let x of E)parseInt(x.dataset.courseid,10)===k&&(x.checked=gs(k));const T=document.querySelectorAll(".allcoursereplay");for(let x of T)x.checked=hs(k);w()});const g=document.querySelectorAll(".allcoursetracksreplay");for(let m of g)m.addEventListener("click",y=>{let v=parseInt(y.target.dataset.courseid,10);const k=Fi(v);_s(k,y.target.checked);const E=document.querySelectorAll(".showreplay.showtrackreplay");for(let M of E)parseInt(M.dataset.courseid,10)===v&&(M.checked=y.target.checked);const T=document.querySelectorAll(".allcoursetracksreplay");for(let M of T)parseInt(M.dataset.courseid,10)===v&&(M.checked=y.target.checked);let x=document.querySelectorAll(".allcoursereplay");for(let M of x)parseInt(M.dataset.courseid,10)===v&&(M.checked=hs(v));w()});const p=document.querySelectorAll(".allcoursereplay");for(let m of p)m.addEventListener("click",y=>{const v=parseInt(y.target.dataset.courseid,10),k=$i(v);_s(k,y.target.checked);const E=document.querySelectorAll(".showreplay");for(let x of E)parseInt(x.dataset.courseid,10)===v&&(x.checked=y.target.checked);const T=document.querySelectorAll(".allcoursetracksreplay");for(let x of T)parseInt(x.dataset.courseid,10)===v&&(x.checked=gs(v));w()})}function Vl(t){switch(t.target.id){case h.TAB_DRAW:Mn(!1),Tr();break}const e=document.getElementById("rg2-info-panel").getAttribute(fn());document.getElementById("rg2-left-info-panel-body").scrollTop=e,w()}const jl=50,De=20;let lt=null,rt=[],$e=!1,Cs="#ff0000",gn=null,c=new js;c.routeData=new gt;let pt=null,N=[],G=[],Kt=[],O=0,ie=0,xe=!1;function zl(t,e){$e&&(Jl(t,e)?(Ot(N[O],G[O]),pn(O),ie=O,O=vn(O),O===N.length&&(document.getElementById("btn-save-route").removeAttribute("disabled"),We())):Ot(Math.round(t),Math.round(e)),document.getElementById("btn-undo").removeAttribute("disabled"),w())}function Ot(t,e){c.routeData.x.push(t),c.routeData.y.push(e)}function Kl(t,e,s){const n=c.handles.getPreviousLockedHandle(s),i=c.handles.getNextLockedHandle(s);Re(t,e,n,n.time,s.time),Re(t,e,i,s.time,i.time)}function Lt(t){c.adjustOffset(t)}function mn(t,e,s=void 0){if(document.getElementById("chk-move-all").checked||s===h.RIGHT_CLICK)a.translate(e.x-t.x,e.y-t.y);else if(c.handles.handlesLocked()>0)if(c.handles.handlesLocked()===1)Re(t,e,c.handles.getSingleLockedHandle(),c.handles.getStartHandle().time,c.handles.getFinishHandle().time);else{let l=c.handles.getHandleClicked(t);if(l===void 0||l.locked)return;const r=c.handles.getEarliestLockedHandle(),o=c.handles.getLatestLockedHandle();r.time>=l.time?Re(t,e,r,c.handles.getStartHandle().time,r.time):o.time<l.time?Re(t,e,o,o.time,c.handles.getFinishHandle().time):Kl(t,e,l)}else lr(e.x-t.x,e.y-t.y)}function pn(t){if(L.alignMap&&t<N.length-1){$e=!1,rt=[];const e=N[t],s=G[t],n=N[t+1],i=G[t+1],l=is(),r=qn(),o=X(e,s,n,i),g=X(l.x,l.y,r.x,r.y);let p=Math.min(g/o,h.MAX_ZOOM);p=Math.max(p,h.MIN_ZOOM);let m;xe?m=ue(N[t],G[t],N[t+1],G[t+1]):m=Kt[t];let y=(a.displayAngle-m-Math.PI/2)%(Math.PI*2);y<-1*Math.PI&&(y=y+2*Math.PI);for(let v=1;v<=De;v=v+1){let k={};k.x=l.x-(l.x-e)*v/De,k.y=l.y-(l.y-s)*v/De,k.angle=(a.displayAngle-y*v/De)%(Math.PI*2),k.scale=Math.pow(p,1/De),rt.push(k)}lt=setInterval(()=>{fr()},jl)}else Et(0,N[t],G[t],!1,1),$e=!0,lt=null}function Zl(){c.autofitTrack()}function Jl(t,e){let s=L.snap?8:2;return console.log(t,e,N[O],G[O]),Math.abs(t-N[O])<s&&Math.abs(e-G[O])<s}function Ql(){let t={};t.body="The route you have started to draw will be discarded. Are you sure you want to change the course?",t.title="Confirm course change",t.doText="Change course",t.onDo=sr,t.onCancel=tr,Yt(t)}function er(t){gn=t;let e={};e.body="This route will be permanently deleted. Are you sure?",e.title="Confirm route delete",e.doText="Delete route",e.onDo=nr,Yt(e)}function tr(){document.getElementById("rg2-select-course").value=c.routeData.courseid,document.getElementById("rg2-select-name").value=c.routeData.resultid,pt=null}function sr(){Zt(),Nt(pt)}function nr(){const t=Yi(gn),e={type:"deletemyroute",id:fe(),routeid:t.id};Ys(JSON.stringify({token:t.token}),e,ur,"Route save failed")}function Zt(){c.routeData.courseid!==null&&Ye(c.routeData.courseid,!1),c.routeData.resultid!==null&&Ne(c.routeData.resultid,!1),bn()}function yn(){Er();const t={type:"addroute",id:c.routeData.eventid};Ys(JSON.stringify(c.routeData),t,hr(c.routeData.name),"Route save failed"),Zt()}function ir(){c.fileLoaded&&(c.savedBaseX=c.baseX.slice(0),c.savedBaseY=c.baseY.slice(0),c.baseX=c.routeData.x.slice(0),c.baseY=c.routeData.y.slice(0),c.handles.saveForUndo(),c.handles.rebaselineXY(),document.getElementById("btn-undo-gps-adjust").removeAttribute("disabled"))}function lr(t,e){for(let s=0;s<c.baseX.length;s+=1)c.routeData.x[s]=c.baseX[s]+t,c.routeData.y[s]=c.baseY[s]+e;c.handles.dragHandles(t,e)}function Dt(t){a.arc(N[O],G[O],t,0,2*Math.PI,!1),a.fill()}function rr(){const t=ht();a.lineWidth=t.overprintWidth,a.strokeStyle=h.RED,a.fillStyle=h.RED_30,O>0&&!c.fileLoaded&&(a.beginPath(),O<N.length-1?Dt(t.controlRadius):(Dt(t.finishInnerRadius),a.stroke(),a.beginPath(),Dt(t.finishOuterRadius)),a.fillRect(N[O]-1,G[O]-1,3,3),a.stroke()),a.strokeStyle=Cs,a.fillStyle=Cs,a.font="10pt Arial",a.textAlign="left",a.globalAlpha=.6,ar(),c.handles.drawHandles()}function ar(){if(c.routeData.x.length>1){a.beginPath(),a.moveTo(c.routeData.x[0],c.routeData.y[0]);for(let t=1;t<c.routeData.x.length;t+=1)a.lineTo(c.routeData.x[t],c.routeData.y[t]);a.stroke()}}function or(){return{x:N,y:G}}function vn(t){const e=c.routeData.splits;if(e.length===2)return t+1;for(let s=t+1;s<e.length;s+=1)if(e[s]!==e[s-1])return s;return e.length}function dr(t){const e=c.routeData.splits;if(e.length===2)return t-1;for(let s=t-1;s>0;s-=1)if(e[s]!==e[s-1])return s;return 0}function cr(){return c.fileLoaded}function ur(t){t.ok?(Y(f("Route deleted"),f("Route has been deleted")),gi({eventid:parseInt(t.eventid,10),id:parseInt(t.routeid,10)}),En()):Y(f("Delete failed"),f("Delete failed"))}const hr=t=>e=>{e.ok?vr(e,t):Y(t,f("Your route was not saved. Please try again"))};function fr(){if(rt.length===0)clearInterval(lt),lt=null,$e=!0;else{const t=rt.shift();Et(t.angle,t.x,t.y,!0,t.scale)}w()}function Nt(t){pt=null,c.routeData=new gt,c.routeData.eventid=fe(),c.routeData.courseid=t;const e=te(t);xe=e.isScoreCourse,xe||(Ye(t,!0),c.routeData.coursename=e.name,e.excludeType===h.EXCLUDED_ZERO_SPLITS?c.routeData.controlsToAdjust=e.exclude.indexOf(!0):c.routeData.controlsToAdjust=e.x.length-1,N=e.x.slice(),G=e.y.slice(),c.routeData.x.length=0,c.routeData.y.length=0,c.routeData.x[0]=N[0],c.routeData.y[0]=G[0],c.routeData.controlx=N.slice(),c.routeData.controly=G.slice(),Kt=e.angle.slice()),document.getElementById("rg2-select-course").value=c.routeData.courseid,Ks(t),w()}function bn(){c=new js,c.routeData=new gt,N.length=0,G.length=0,Kt.length=0,O=0,ie=0,xe=!1,c.initialiseGPS(),Wl(),w()}function gr(t,e,s){if(ke()===h.TAB_DRAW)if(c.fileLoaded){const i=c.handles.getHandleClicked({x:t,y:e});if(i!==void 0)s===h.RIGHT_CLICK&&i.index!==0&&i.index!==c.handles.length?i.locked?c.handles.unlockHandle(i.index):c.handles.deleteHandle(i.index):i.locked?c.handles.unlockHandle(i.index):c.handles.lockHandle(i.index);else for(let l=0;l<c.baseX.length;l+=1)if(c.baseX[l]+3>=t&&c.baseX[l]-3<=t&&c.baseY[l]+3>=e&&c.baseY[l]-3<=e){c.handles.addHandle(t,e,l);break}}else c.routeData.resultid!==null&&c.routeData.courseid!==null?zl(t,e):Y("No course/name","Please select course, name and time before you start drawing a route or upload a file.")}function mr(t){We(),c.readGPS(t)}function pr(){let t={};t.body="All information you have entered will be removed. Are you sure you want to reset?",t.title="Confirm reset",t.doText="Reset",t.onDo=Zt,Yt(t)}function yr(t,e,s){let n={};return n.x=Math.cos(s)*t-Math.sin(s)*e,n.y=Math.sin(s)*t+Math.cos(s)*e,n}function vr(t,e){Y(e,f("Your route has been saved")),mi({eventid:parseInt(t.eventid,10),id:t.newid,token:t.token}),vt(fe())}function br(){const t=c.routeData.time[c.routeData.time.length-1]-c.routeData.time[0];c.routeData.totaltime=B(t);const s=new Date().getTimezoneOffset()*60;c.routeData.startsecs=c.routeData.time[0]-s;for(let n=0;n<c.routeData.x.length;n+=1)c.routeData.x[n]=Math.round(c.routeData.x[n]),c.routeData.y[n]=Math.round(c.routeData.y[n]),c.routeData.time[n]-=c.routeData.startsecs;for(c.routeData.resultid+=h.GPS_RESULT_OFFSET;Ji(c.routeData.resultid);)c.routeData.resultid+=h.GPS_RESULT_OFFSET,c.routeData.name+="*";c.routeData.comments=document.getElementById("rg2-new-comments").value,document.getElementById("btn-undo-gps-adjust").setAttribute("disabled",""),yn()}function xr(){c.routeData.comments=document.getElementById("rg2-new-comments").value,c.routeData.controlx=N,c.routeData.controly=G,c.routeData.controlx.splice(0,1),c.routeData.controly.splice(0,1),yn()}function Re(t,e,s,n,i){const l=X(e.x,e.y,s.x,s.y)/X(t.x,t.y,s.x,s.y),r=ue(e.x,e.y,s.x,s.y)-ue(t.x,t.y,s.x,s.y);for(let o=n;o<=i;o+=1){const g=yr(c.baseX[o]-s.x,c.baseY[o]-s.y,r);c.routeData.x[o]=g.x*l+s.x,c.routeData.y[o]=g.y*l+s.y}c.handles.alignHandles(c.routeData)}function Er(){for(let t=c.routeData.x.length-1;t>0;t-=1)c.routeData.x[t]=c.routeData.x[t]-c.routeData.x[t-1],c.routeData.y[t]=c.routeData.y[t]-c.routeData.y[t-1];for(let t=c.routeData.time.length-1;t>0;t-=1)c.routeData.time[t]=c.routeData.time[t]-c.routeData.time[t-1]}function Sr(t){isNaN(t)||(c.routeData.courseid!==null?c.routeData.x.length>1?(pt=t,Ql()):(c.routeData.resultid!==null&&Ne(c.routeData.resultid,!1),Ye(c.routeData.courseid,!1),Nt(t)):Nt(t))}function kr(t){if(!isNaN(t)){const e=Js(t);if(e.hasValidTrack){const s=f("If you draw a new route it will overwrite the old route for this runner.")+" "+f("GPS routes are saved separately and will not be overwritten.");Y(f("Route already drawn"),s)}c.routeData.resultid!==null&&Ne(c.routeData.resultid,!1),c.routeData.resultid=e.resultid,c.routeData.name=e.name,c.routeData.splits=e.splits,xe?(Ne(e.resultid,!0),N=e.scorex,G=e.scorey,c.routeData.x.length=0,c.routeData.y.length=0,c.routeData.x[0]=N[0],c.routeData.y[0]=G[0],c.routeData.controlx=N,c.routeData.controly=G,O=1,w()):(O=vn(0),ie=0),xn()}}function As(){const t=document.getElementById("rg2-name-entry"),e=t.value.trim();e?t.classList.add("is-valid"):t.classList.remove("is-valid");const s=document.getElementById("rg2-time-entry");let n=s.value.trim();if(n.match(/\d+[:.][0-5]\d$/)?s.classList.add("is-valid"):(s.classList.remove("is-valid"),n=null),e&&n&&c.routeData.courseid!==null){n=n.replace(".",":"),c.routeData.name=e,c.routeData.resultid=0,c.routeData.totaltime=n,c.routeData.startsecs=0,c.routeData.time[0]=rs(n),c.routeData.totalsecs=rs(n),O=1;const i=ea(c.routeData.courseid),l=i[i.length-1];let r=[];for(let o=0;o<i.length;o=o+1)r[o]=parseInt(i[o]/l*c.routeData.totalsecs,10);c.routeData.splits=r,ie=0,xn()}}function Tr(){c.routeData.courseid!==null&&(xe?Ne(c.routeData.resultid,!0):Ye(c.routeData.courseid,!0))}function xn(){document.getElementById("btn-three-seconds").removeAttribute("disabled"),document.getElementById("btn-reset-drawing").removeAttribute("disabled",""),document.getElementById("rg2-load-gps-file").removeAttribute("disabled"),pn(0),w()}function Ir(){c.baseX=c.savedBaseX.slice(0),c.baseY=c.savedBaseY.slice(0),c.routeData.x=c.savedBaseX.slice(0),c.routeData.y=c.savedBaseY.slice(0),c.handles.undo(),document.getElementById("btn-undo-gps-adjust").setAttribute("disabled",""),w()}function wr(){if($e){const t=c.routeData.x.length;t>1&&(N[ie]===c.routeData.x[t-1]&&G[ie]===c.routeData.y[t-1]&&(O===N.length&&document.getElementById("btn-save-route").setAttribute("disabled",""),O=ie,ie=dr(O)),c.routeData.x.pop(),c.routeData.y.pop()),c.routeData.x.length>1?document.getElementById("btn-undo").removeAttribute("disabled"):document.getElementById("btn-undo").setAttribute("disabled",""),w()}}function Lr(){Ot(c.routeData.x[c.routeData.x.length-1],c.routeData.y[c.routeData.y.length-1]),w()}class Ae{constructor(e){e.A===void 0?(this.valid=!1,this.A=0,this.B=0,this.C=0,this.D=0,this.E=0,this.F=0):(this.A=parseFloat(e.A),this.B=parseFloat(e.B),this.C=parseFloat(e.C),this.D=parseFloat(e.D),this.E=parseFloat(e.E),this.F=parseFloat(e.F),this.valid=!0,this.AEDB=e.A*e.E-e.D*e.B,this.xCorrection=e.B*e.F-e.E*e.C,this.yCorrection=e.D*e.C-e.A*e.F)}getLat(e,s){return this.D*e+this.E*s+this.F}getLon(e,s){return this.A*e+this.B*s+this.C}getX(e,s){return Math.round((this.E*e-this.B*s+this.xCorrection)/this.AEDB)}getY(e,s){return Math.round((-1*this.D*e+this.A*s+this.yCorrection)/this.AEDB)}}let Dr=class{constructor(e){switch(this.kartatid=e.id,this.mapid=e.mapid,this.format=e.format,this.name=e.name,this.date=e.date,this.club=e.club,this.rawtype=e.type,e.type){case"I":this.type="International event";break;case"N":this.type="National event";break;case"R":this.type="Regional event";break;case"L":this.type="Local event";break;case"T":this.type="Training event";break;default:this.type="Unknown";break}this.comment=e.comment,this.locked=e.locked,this.courses=0,e.suffix===void 0?this.mapfilename=this.mapid+".jpg":this.mapfilename=this.mapid+"."+e.suffix,this.worldfile=new Ae(e)}},C=[],R=null,$t=!1;function Cr(t){const e=document.querySelectorAll("#rg2-event-table tr");for(let n of e)parseInt(n.dataset.kartatid,10)===t?n.classList.add("table-success"):n.classList.remove("table-success");const s=document.getElementById("btn-splitsbrowser");rg2Config.enable_splitsbrowser&&Jt()?s.removeAttribute("disabled"):s.setAttribute("disabled",""),document.getElementById("btn-toggle-controls").removeAttribute("disabled"),document.getElementById("btn-runners").removeAttribute("disabled"),document.getElementById("btn-measure").removeAttribute("disabled"),document.getElementById("btn-stats").removeAttribute("disabled")}function Ar(t){Ln(null),Ut({type:"event",id:t},Hr,"Event request failed")}function En(){Ut({type:"events"},Gr,"Events request failed")}function Sn(){return R===null?!1:C[R].locked}function Mr(){let t="<table class='table table-striped table-hover table-sm'><tbody id='rg2-event-table'>";for(let e=C.length-1;e>=0;e-=1){let s=f(C[e].type,"")+": "+C[e].date;C[e].comment!==""&&(s+=": "+C[e].comment);let n="";C[e].comment!==""&&(n=`<i class='bi-info-circle' id='info-${e}'></i>`);let i="";C[e].worldfile.valid&&(i=`<i class='bi-globe' id='info-${e}'></i>`);let l="";C[e].locked&&(l=`<i class='bi-lock-fill' id='info-${e}'></i>`),t+=`<tr data-kartatid="${C[e].kartatid}"><td class="event-date">${C[e].date}</td><td title='${s}'>`,t+=`${C[e].name} ${l} ${i} ${n}</td ></tr >`}return t+="</tbody></table>",t}function Rr(){return R!==null?C[R].date:""}function kn(){return R}function Br(){if(R!==null)return C[R].kartatid}function Pr(){return R!==null?C[R].name:"Routegadget 2"}function _r(){return R!==null?C[R].mapid:null}function Or(t){for(let e=0;e<C.length;e+=1)if(C[e].kartatid===t)return e}function Jt(){return R!==null?C[R].format===h.FORMAT_NORMAL||C[R].format===h.FORMAT_SCORE_EVENT:!0}function Tn(t){t=t||fe();const e=Or(t);let s=C[e];return s.id=e,s.controls=W.getControlCount(),s.exclude=na(),s}function Nr(){if(R===null)return"";const t=fe(),e=Tn(parseInt(t,10));let s=`<div class='fs-4 fw-bolder pb-3'>${f("Event statistics")}</div>`;return s+="<table class='table table-sm table-striped-columns table-bordered'><tbody>",s+=`<tr><td>${f("Event")}</td><td>${e.name}:&nbsp;${e.date}</td></tr>`,e.comment&&(s+=`<tr><td>${f("Comments")}</td><td>${e.comment}</td></tr>`),s+=Vi(e.controls,e.worldfile.valid),s+="</tbody></table>",s+='<hr class="border border-primary opacity-75" />',s+=Hi(),s=s.replace(/&amp;/g,"&"),s}function fe(){return R===null?null:C[R].kartatid}function $r(){return R===null||!bt()?"px":"m"}function Fr(t){for(let e=0;e<C.length;e+=1)if(C[e].kartatid===t)return C[e].mapfilename;return""}function yt(){if(R===null||!bt())return;const t=Ge(),e=X(0,0,t.width,t.height),s=C[R].worldfile,n=s.C,i=s.F,l=s.A*t.width+s.B*t.height+s.C,r=s.D*t.width+s.E*t.height+s.F;return Mt(i,n,r,l)/e}function In(){return R===null?null:C[R].worldfile}function Hr(t,e){$t=!1,Ii(e),Ln(e),Ur(),da(t.courses),el(t.results),tl(t.routes),bn(),Cr(e)}function Gr(t){C.length=0,R=null;for(const s of t.events)C.push(new Dr(s));Fl();const e=Ei();e&&vt(e),h.managing()&&rg2Config.manager.eventListLoaded(C)}function at(){return R!==null?C[R].format===h.FORMAT_SCORE_EVENT||C[R].format===h.FORMAT_SCORE_EVENT_NO_RESULTS:!1}function wn(t){for(let e=0;e<C.length;e+=1)if(C[e].kartatid===t)return!0;return!1}function vt(t){$t||!wn(t)||($t=!0,wa(),Ri(),Dn(),qa(rg2Config.maps_url+Fr(t)),document.getElementById("rg2-load-progress-label").textContent=f("Loading event",""),document.getElementById("rg2-load-progress").classList.remove("d-none"),Ar(t),w())}function ao(t){for(let e=0;e<C.length;e+=1)if(C[e].mapid===t)return!0;return!1}function bt(){return R===null?!1:C[R].worldfile.valid}function Ln(t){R=null;for(let e=0;e<C.length;e+=1)if(C[e].kartatid===t){R=e;break}}function Ur(){let t="";t=Rr()+" "+tt(Pr()),document.title=t,bt()&&(t="<i class='bi-globe'>&nbsp;</i>"+t),Sn()&&(t="<i class='bi-lock-fill'>&nbsp;</i>"+t),document.getElementById("rg2-event-title").innerHTML=t}class Yr{constructor(e,s){this.name=e.name,this.trackcount=0,this.display=!1,this.courseid=e.courseid,this.codes=e.codes,this.setExcluded(e),this.filterTo=this.codes.length,this.filterFrom=0,this.x=e.xpos,this.y=e.ypos,this.isScoreCourse=s,this.resultcount=0,this.angle=[],this.textAngle=[],this.setAngles(),this.length=this.setLength()}drawCourse(e){if(this.display){const s=ht();if(a.globalAlpha=e,W.drawStart(this.x[0],this.y[0],"",this.angle[0],s),!this.isScoreCourse){const n={from:this.filterFrom,to:this.filterTo};this.drawLinesBetweenControls({x:this.x,y:this.y},this.angle,s,n)}if(this.isScoreCourse)for(let n=1;n<this.x.length;n+=1)this.codes[n].indexOf("F")===0||this.codes[n].indexOf("M")===0?W.drawFinish(this.x[n],this.y[n],"",s):W.drawSingleControl(this.x[n],this.y[n],this.codes[n],this.textAngle[n],s);else{const n=Math.max(this.filterFrom,1),i=Math.min(this.filterTo+1,this.x.length-1);for(let l=n;l<i;l+=1)W.drawSingleControl(this.x[l],this.y[l],l,this.textAngle[l],s);W.drawFinish(this.x[this.x.length-1],this.y[this.y.length-1],"",s)}}}drawLinesBetweenControls(e,s,n,i){let l;for(let r=i.from;r<i.to;r+=1){r===0?l=n.startTriangleLength:l=n.controlRadius;const o=e.x[r]+l*Math.cos(s[r]),g=e.y[r]+l*Math.sin(s[r]);r===this.x.length-2?l=n.finishOuterRadius:l=n.controlRadius;const p=e.x[r+1]-l*Math.cos(s[r]),m=e.y[r+1]-l*Math.sin(s[r]);a.beginPath(),a.moveTo(o,g),a.lineTo(p,m),a.stroke()}}getLegLengths(){let e=[];if(this.isScoreCourse)return e[1]=1,e;e[0]=0;for(let s=1;s<this.x.length;s+=1)e[s]=parseInt(e[s-1]+X(this.x[s],this.y[s],this.x[s-1],this.y[s-1]),0);return e}incrementTracksCount(){this.trackcount+=1}setAngles(){for(let e=0;e<this.x.length-1;e+=1)if(this.isScoreCourse)this.angle[e]=Math.PI*1.5,this.textAngle[e]=Math.PI*.25;else{this.angle[e]=ue(this.x[e],this.y[e],this.x[e+1],this.y[e+1]);const s=Math.sin(this.angle[e-1]),n=Math.cos(this.angle[e-1]),i=Math.sin(this.angle[e])+s,l=Math.cos(this.angle[e])+n,r=i/2,o=l/2;this.textAngle[e]=ue(r,o,s,n)}this.angle[this.x.length-1]=Math.PI*1.5,this.textAngle[this.x.length-1]=Math.PI*1.5}setDisplay(e){this.display=e}setExcluded(e){this.excludeType=e.excludeType,this.exclude=e.codes.map((s,n)=>e.exclude.findIndex(i=>i===n)>-1),this.allowed=e.codes.map((s,n)=>e.exclude.findIndex(i=>i===n)>-1?e.allowed[e.exclude.findIndex(i=>i===n)]:0)}setLength(){let e=0;const s=yt();if(!(s===void 0||this.isScoreCourse)){for(let n=1;n<this.x.length;n+=1)e+=X(this.x[n],this.y[n],this.x[n-1],this.y[n-1]);if(e!==0)return(e*s/1e3).toFixed(1)}}}let b=[],W,ot=0,Qt=0,Ft=0;function Xr(t){b[t.courseid]=new Yr(t,at()),Qt+=1,b[t.courseid].codes!==void 0&&b[t.courseid].codes.length>Ft&&(Ft=b[t.courseid].codes.length-1)}function Wr(){for(let t=0;t<b.length;t+=1)if(b[t]!==void 0&&!b[t].display)return!1;return!0}function qr(){let t=document.getElementById("rg2-select-course");t.innerHTML="",t.options.add(be(null,f("Select course","")));for(let e=0;e<b.length;e=e+1)b[e]!==void 0&&t.options.add(be(e,tt(b[e].name)));t.addEventListener("change",e=>{Sr(parseInt(e.target.value,10))})}function Vr(){const t=document.getElementById("rg2-course-table");t.innerHTML=Jr();const e=document.getElementById("rg2-course-filter-table");e.innerHTML=Zr(),document.querySelectorAll("[data-course-filter]").forEach(n=>{n.addEventListener("change",zr)})}function Dn(){b.length=0,ot=0,Qt=0,Ft=0}function Ms(t){for(let e=0;e<b.length;e+=1)b[e]!==void 0&&b[e].drawCourse(t)}function jr(t,e,s,n,i){b[s].drawLinesBetweenControls(t,e,n,i)}function zr(t){const e=parseInt(t.target.dataset.courseFilter,10);b[e].filterFrom=t.detail.value1,b[e].filterTo=t.detail.value2,w()}function Kr(){let t={html:"",res:0,coursecount:0};for(let e=0;e<b.length;e+=1)b[e]!==void 0&&(t.coursecount=t.coursecount+1,t.html+=[`<tr><td>${b[e].name}</td >`,`<td><input class='showcourse' data-courseid=${e} type='checkbox' name='course'></input></td>`,`<td class='text-center'>${b[e].resultcount}</td><td class='text-center'>${b[e].trackcount}</td><td>`].join(""),t.res+=b[e].resultcount,b[e].trackcount>0?(t.html+=`<input data-courseid=${b[e].courseid} class='allcoursetracks' type=checkbox name=track></input></td>`,t.html+=`<td><input data-courseid=${b[e].courseid} class='allcoursetracksreplay' type=checkbox name=replay></input>`):t.html+="</td><td>",t.html+="</td></tr>");return t}function Zr(){let t="";for(let e=0;e<b.length;e+=1)b[e]!==void 0&&!b[e].isScoreCourse&&b[e].codes.length>2&&(t+=[`<div id='course-filter-${b[e].courseid}' data-display="false" data-course="${b[e].courseid}" class="row">`,`<div class="col-3">${b[e].name}</div>`,'<div class="col-9 pt-2">',`  <tc-range-slider step="1" min="0" max="${b[e].codes.length}" value1="0"`,`value2="${b[e].codes.length}" round="0" data-course-filter="${b[e].courseid}>"`,"</tc-range-slider></div></div>"].join(""));return t}function Jr(){let t=["<table class='table table-striped table-hover table-sm'><thead>",`<tr><th>${f("Course")}</th><th><i class='bi-eye-fill'></i></th><th>${f("Runners")}</th>`,`<th>${f("Routes")}</th><th><i class='bi-pencil'></i></th><th><i class='bi-play-fill'></i></th></tr>`,'</thead><tbody class="table-group-divider">'].join("");const e=Kr();return t+=e.html+`</tbody><tfoot class="table-group-divider"><tr class='allitemsrow'><td>${f("All")}</td>
    <td><input class='showallcourses' data-id="all" type=checkbox name=course></input></td>
    <td class='text-center'>${e.res}</td><td class='text-center'>${ot}</td><td>`,ot>0&&(t+=`<input data-id="all" class='alltracks' type=checkbox name=track></input>`),t+="</td><td></td></tr></tfoot></table>",t}function Cn(){return b}function te(t){return b[t]}function Qr(t){return b.find(e=>e?e.name===t:!1)}function ea(t){return b[t].getLegLengths()}function ta(t){return b[t].name}function sa(){let t=[];for(let e=0;e<b.length;e+=1)if(b[e]!==void 0){let s={};s.id=b[e].courseid,s.name=b[e].name,s.results=b[e].resultcount,t.push(s)}return t}function Rs(){let t=[];for(let e=0;e<b.length;e+=1)b[e]!==void 0&&b[e].display&&t.push(e);return t}function na(){let t="";for(let e=0;e<b.length;e+=1)b[e]!==void 0&&b[e].excludeType!==h.EXCLUDED_NONE&&(t=t+b[e].courseid+"|"+b[e].excludeType,t=t+b[e].exclude.reduce((s,n,i)=>n?s+"|"+i+","+b[e].allowed[i]:s,""),t=t+`
`);return t}function ia(t){let e={};return e.filterFrom=b[t].filterFrom,e.filterTo=b[t].filterTo,e}function la(t){return b[t].codes.length-2}function An(){return Qt}function ra(t){b[t].incrementTracksCount(),ot+=1}function aa(){W=new yi}function oa(t){return t in b}function da(t){Dn(),W.deleteAllControls(),document.getElementById("rg2-load-progress-label").innerHTML=f("Saving courses");for(const e of t)Xr(e);W.generateControlList()}function Mn(t){for(let e=0;e<b.length;e+=1)b[e]!==void 0&&b[e].setDisplay(t)}function Bs(){for(let t=0;t<b.length;t+=1)b[t]!==void 0&&Be(t)}function Ye(t,e){b[t]!==void 0&&(b[t].setDisplay(e),Be(t))}function Be(t){t=parseInt(t,10);const e=b[t].display||Ci(t);document.querySelectorAll("[data-display]").forEach(s=>{parseInt(s.dataset.course,10)===t&&(s.dataset.display=e)})}function ca(){for(let t=0;t<b.length;t+=1)b[t]!==void 0&&(b[t].resultcount=Ai(t))}function ua(t,e,s,n){for(let i=0;i<b.length;i+=1)if(b[i]!==void 0&&b[i].courseid===t){b[i].codes=e,b[i].x=s,b[i].y=n,b[i].setAngles();break}}let I=[],ne={};const Ct=[100,200,500,1e3,2e3,3e3,5e3,7500,1e4,15e3,2e4,5e4,1e5],ha=100,fa=50,Ce=20;let se=!1,Rn="px",Fe=3e3,he=null,Ee=null,dt=[],H=0,ae=0,re=!1,ye=0,de=0,He=60,Pe=0,_=0,Te=!1,_e=!1,ve=!0,Oe=0,ce=0,ct=null,j;const es=`<i title=${f("Run","")} class="bi-play-circle-fill"></i>`,Bn=`<i title=${f("Start","")} class="bi-triangle"></i>`,ga=`<i title=${f("Pause","")} class="bi-pause-btn"></i>`,Pn=`<i title=${f("Wait","")} class="bi-hourglass-split"></i>`,Se=document.getElementById("rg2-track-names"),Ps=document.querySelector("#rg2-track-names .card-body"),Ht=document.getElementById("btn-runners"),ge=document.getElementById("btn-start-stop");document.querySelector("#rg2-track-names .card-title").innerHTML=f("Runners");document.getElementById("btn-close-track-names").addEventListener("click",()=>{Se.classList.add("d-none")});Ht.addEventListener("click",()=>{Se.classList.toggle("d-none")});const et=document.getElementById("rg2-replay-by-control");et.classList.add("d-none");let ze={x:0,y:0};st(Se).draggable({inertia:!0,listeners:{move(t){ze.x+=t.dx,ze.y+=t.dy,t.target.style.transform=`translate(${ze.x}px, ${ze.y}px)`}},modifiers:[st.modifiers.restrictRect({restriction:"#rg2-container"})]});function _n(t,e=!0){for(let s=0;s<I.length;s+=1)if(I[s].resultid===t.resultid)return;I.length===0&&(ne=Qr(t.coursename)),t.userColour!==null?t.trackColour=t.userColour:t.trackColour=Vs(),I.push(t),e&&xt()}function On(t){se=!1,dt=[];const e=ne.x[t],s=ne.y[t],n=ne.x[t+1],i=ne.y[t+1];if(ne.angle.length>=t){const l=is(),r=qn(),o=X(e,s,n,i),g=X(l.x,l.y,r.x,r.y);let p=Math.min(g/o,h.MAX_ZOOM);p=Math.max(p,h.MIN_ZOOM);let m=(a.displayAngle-ne.angle[t]-Math.PI/2)%(Math.PI*2);m<-1*Math.PI&&(m=m+2*Math.PI);for(let y=1;y<=Ce;y=y+1){let v={};v.x=l.x-(l.x-e)*y/Ce,v.y=l.y-(l.y-s)*y/Ce,v.angle=(a.displayAngle-m*y/Ce)%(Math.PI*2),v.scale=Math.pow(p,1/Ce),dt.push(v)}Ee=setInterval(()=>{ka()},fa)}else Et(0,e,s,!0,1),Ee=null,se=!0}function _s(t,e){for(let s=0;s<t.length;s+=1)e?_n(new tn(t[s]),!1):Hn(t[s]);xt()}function Nn(){ye=86400,de=0,ce=0;for(let t=0;t<I.length;t+=1)I[t].starttime<ye&&(ye=I[t].starttime),I[t].starttime+I[t].x.length>de&&(de=I[t].starttime+I[t].x.length),I[t].x.length>ce&&(ce=I[t].x.length)}function ma(t){if(I.length===0)return;let e=!0;for(let s=0;s<I.length;s+=1)if(I[s].splits[_+1]-I[s].splits[_]>t){e=!1;break}e&&(_+=1,se=!1,ts(_),ss())}function pa(t){t!==H&&Xe(t)}function ya(){let t=document.getElementById("rg2-replay-speed-list"),e="";for(let s=0;s<Ct.length;s=s+1)e+=`<li class="dropdown-item" data-speed="${Ct[s]}">${"x"+Ct[s]/100}</li>`;t.innerHTML=e,document.getElementById("rg2-replay-speed-select").addEventListener("hidden.bs.dropdown",s=>{s.clickEvent&&Yn(parseInt(s.clickEvent.target.dataset.speed,10))})}function va(){let t=document.getElementById("rg2-replay-start-control-list");t.removeEventListener("hidden.bs.dropdown",Ns);let e="";const n=I.reduce((i,l)=>Math.min(l.splits.length,i),9999);for(let i=0;i<n-1;i=i+1){const l=i===0?`<div>${Bn}</div>`:i;e+=`<li class="dropdown-item" data-control="${i}">${l}</li>`}t.innerHTML=e,document.getElementById("rg2-replay-start-control-select").addEventListener("hidden.bs.dropdown",Ns)}function ba(){let t=document.getElementById("rg2-tails-length-list"),e="";const s=["0:00","0:30","1:00","1:30","2:00","3:00",f("Full tails","")],n=[0,30,60,90,120,180,"Full"];for(let i=0;i<s.length;i=i+1)e+=`<li class="dropdown-item" data-length="${n[i]}">${s[i]}</li>`;t.innerHTML=e,document.getElementById("rg2-tails-length-select").addEventListener("hidden.bs.dropdown",i=>{i.clickEvent&&Ma(i.clickEvent.target.dataset.length)})}function xa(){if(I.length===0)return;if(j){j.value!==H&&(j.value=H);const e=document.getElementById("rg2-clock");e.innerText=di(H)}let t=0;for(let e=0;e<I.length;e+=1){const s=I[e];let n=0;if(re?n=s.starttime:_===0||s.splits.length<_?n=0:n=-1*s.splits[_],a.strokeStyle=s.trackColour,a.globalAlpha=L.perCentRouteIntensity/100,a.lineWidth=L.routeWidth/Math.pow(a.displayScale,.5),a.lineJoin="round",a.beginPath(),!se&&!Ee&&_>0){const i=s.splits[_];let l=Math.max(i-He,s.splits[_-1]);a.moveTo(s.x[l],s.y[l]);for(let r=l+1;r<=i;r+=1)a.lineTo(s.x[r],s.y[r])}else{a.moveTo(s.x[Pe-n],s.y[Pe-n]);for(let i=Pe;i<H;i+=1)i>n&&i-n<s.nextStopTime&&a.lineTo(s.x[i-n],s.y[i-n])}a.stroke(),a.beginPath(),t=H,t-n<s.nextStopTime?t=t-n:t=s.nextStopTime,a.arc(s.x[t],s.y[t],h.RUNNER_DOT_RADIUS/Math.pow(a.displayScale,.5),0,2*Math.PI,!1),a.globalAlpha=h.FULL_INTENSITY,a.strokeStyle=h.BLACK,a.fillStyle=s.trackColour,a.fill(),a.lineWidth=h.RUNNER_DOT_RADIUS/Math.pow(a.displayScale,.5)/4,a.stroke(),Ea(s,t)}Ra(t),Te&&ma(H)}function Ea(t,e){let s="";if((_e||ve)&&e<t.x.length&&e>=0){a.fillStyle=t.trackColour,a.strokeStyle="darkslategray",a.font=L.replayFontSize/Math.pow(a.displayScale,.8)+"pt Arial",a.globalAlpha=h.FULL_INTENSITY,a.textAlign="left",ve?s=t.initials:s=t.name,a.save(),a.translate(t.x[e],t.y[e]),a.rotate(a.displayAngle),a.lineWidth=L.replayFontSize/Math.pow(a.displayScale,.8)/8;const n=2+8/Math.pow(a.displayScale,1),i=2+4/Math.pow(a.displayScale,1);a.strokeText(s,n,i),a.fillText(s,n,i),a.restore()}}function Os(t,e){const s=I[t].cumulativeDistance;let n=e>s.length-1?s[s.length-1]:s[e];return n===void 0&&(n=0),n}function $n(t){let e=[];for(let n=0;n<I.length;n+=1){let i={};i.trackColour=I[n].trackColour,i.course=I[n].coursename,i.name=I[n].name,i.resultid=I[n].resultid,i.rawid=I[n].rawid,re?i.distance=Os(n,H-I[n].starttime):i.distance=Os(n,t),i.distance+=Rn,e.push(i)}let s=Xi();for(let n=0;n<s.length;n+=1)if(e.findIndex(i=>i.resultid===s[n].resultid)===-1){let i={};i.trackColour=s[n].trackColour,i.course=s[n].course,i.name=s[n].name,i.resultid=s[n].resultid,i.rawid=s[n].rawid,i.distance="",e.push(i)}return e}function Sa(t){if(t.length===0)return"";let e="",s="";for(let n=0;n<t.length;n+=1)s!==t[n].course&&(e+=`<div></div><div><strong>${t[n].course}</strong></div><div></div>`,s=t[n].course),e+=`<input type="color" class="form-control form-control-color" data-rawid="${t[n].rawid}"`,e+=` value = "${t[n].trackColour}" ><div>${t[n].name}</div><div class="runner-distance text-end"`,e+=` data-resultid="${t[n].resultid}">${t[n].distance}</div>`;return e}function Ns(t){t.clickEvent&&(_=parseInt(t.clickEvent.target.dataset.control),isNaN(_)&&(_=0),se=!1,ts(_),ss(),On(_),ge.innerHTML=Pn)}function ka(){if(dt.length===0)clearInterval(Ee),Ee=null,se=!0,ge.innerHTML=es;else{const t=dt.shift();Et(t.angle,t.x,t.y,!0,t.scale)}w()}function Ta(){re?H<de&&(ae=Math.min(ae+Fe,de*1e3)):H<ce&&(ae=Math.min(ae+Fe,ce*1e3)),H=parseInt(ae/1e3,10),Pe=Math.max(H-He,Oe+1),w()}function Ia(){if(ct)return;ct=document.getElementById("rg2-animation-controls");const t=document.getElementById("rg2-clock");t.innerText="00:00:00",Fn(0,0,0),ya(),Yn(Fe),ge.addEventListener("click",()=>{Pa()}),document.getElementById("btn-mass-start").addEventListener("click",()=>{et.classList.add("d-none"),Da()});const s=document.getElementById("btn-real-time");s.setAttribute("title",f("Real time","")),s.addEventListener("click",()=>{et.classList.add("d-none"),Ca()}),document.getElementById("btn-by-control").addEventListener("click",()=>{La(),va(),et.classList.remove("d-none")}),ba();let i=document.querySelectorAll("[data-toggle-names]");for(let l of i)l.innerHTML=f(l.dataset.toggleNames),l.addEventListener("click",r=>{_a(r.currentTarget.dataset.toggleNames)});document.getElementById("rg2-toggle-names-value").setAttribute("title",f("Show names",""))}function Fn(t,e,s){if(j&&j.min===t&&j.max===e&&j.value===s)return;j&&j.remove();const n=document.getElementById("rg2-clock-slider-container"),i=document.createElement("tc-range-slider");i.setAttribute("id","rg2-clock-slider"),i.setAttribute("min",t),i.setAttribute("max",e),i.setAttribute("value",s),i.setAttribute("step",1),n.append(i),j=document.getElementById("rg2-clock-slider"),j.addEventListener("change",l=>{pa(l.target.value)})}function Hn(t){for(let e=0;e<I.length;e+=1)I[e].resultid===t&&I.splice(e,1),I.length===0&&(ne={});xt()}function wa(){I.length=0,ne={},Fe=3e3,H=0,ae=0,re=!1,ye=0,de=0,He=60,Pe=0,_=0,Te=!1,_e=!1,ve=!0,Oe=0,ce=0,clearInterval(he),he=null,xt(),ge.innerHTML=es,Se.classList.add("d-none")}function Gn(){I.forEach(t=>t.nextStopTime=h.VERY_HIGH_TIME_IN_SECS)}function Un(t){return I.findIndex(e=>e.resultid===t)>-1}function Xe(t){Rn=$r();let e=0;re?(t>0?H=t:H=ye,e=de,Oe=ye):(t>0?H=t:H=0,e=ce,Oe=0),ae=H*1e3,t===0&&Fn(Oe,e,H),w()}function ts(t){document.getElementById("rg2-replay-start-control").innerHTML=t===0?Bn:t}function ss(){let t=9999;t=I.reduce((e,s)=>Math.min(s.splits.length,e),t),_>t&&(_=0);for(let e=0;e<I.length;e+=1)_+1<I[e].splits.length?I[e].nextStopTime=I[e].splits[_+1]:I[e].nextStopTime=h.VERY_HIGH_TIME_IN_SECS;Xe(0),Xn(),w()}function La(){document.getElementById("rg2-clock-slider").setAttribute("disabled",""),re=!1,_=0,Te=!0,se=!1,ts(_),ss()}function Da(){re=!1,Te=!1,_=0,Gn(),Xe(0),j.removeAttribute("disabled")}function Ca(){re=!0,Te=!1,_=0,Gn(),Xe(0),j.removeAttribute("disabled")}function Yn(t){isNaN(t)&&(t=1e3),Fe=t,document.getElementById("rg2-replay-speed").innerText="x"+t/100}function Aa(t,e){for(let s=0;s<I.length;s+=1)I[s].rawid===t&&(I[s].userColour=e,I[s].trackColour=e);il(t,e)}function Ma(t){t==="Full"?He=h.VERY_HIGH_TIME_IN_SECS:He=parseInt(t,10),Nn(),w()}function Ra(t){const e=$n(t);if(e.length===0)return;const s=document.querySelectorAll(".track-names .runner-distance");s&&s.forEach(n=>{const i=parseInt(n.dataset.resultid),l=e.findIndex(r=>r.resultid===i);l>-1&&(n.innerText=e[l].distance)})}function Ba(){he===null&&(he=setInterval(()=>{Ta()},ha)),ge.innerHTML=ga}function Xn(){clearInterval(he),he=null,ge.innerHTML=es}function Pa(){he===null?(Te?!se&&Ee===null&&(On(_),ge.innerHTML=Pn):se=!0,se&&Ba()):Xn()}function _a(t){switch(document.getElementById("rg2-toggle-names-value").setAttribute("title",f(t,"")),t){case"Show names":_e=!0,ve=!1;break;case"Show initials":_e=!1,ve=!0;break;default:_e=!1,ve=!1;break}w()}function xt(){Ia(),ns(),I.length>0?(ct.classList.remove("d-none"),Ht.classList.remove("d-none")):(ct.classList.add("d-none"),Ht.classList.add("d-none")),zt(),Nn(),Xe(0)}function ns(){const t=$n(H);return t.length>0?(Ps.innerHTML=Sa(t),document.querySelectorAll(".track-names input").forEach(s=>{s.addEventListener("input",n=>{Aa(parseInt(n.target.dataset.rawid,10),n.target.value),w()})}),Se.classList.remove("d-none")):(Ps.innerHTML="",Se.classList.add("d-none")),t.length}class Oa{constructor(e){this.ctx=e,this.measuring=!1,this.dragging=!1,this.colours=["#ff00ff","#0000ff","#00ff00","#ff0000","#00ffff"],this.colourIndex=0,this.overlays=[],this.currentOverlay=this.initialiseOverlay(),this.units="px",this.metresPerPixel=1,this.dotSize=5,this.lineWidth=3,this.measureDialog=document.getElementById("rg2-measure-dialog"),document.getElementById("btn-measure").addEventListener("click",()=>{kn()!==null&&(document.getElementById("rg2-map-canvas").style.cursor="crosshair",this.measureDialog.classList.remove("d-none"),this.measuring=!0,this.createMeasureDialog(),w())}),document.getElementById("btn-close-measure-dialog").addEventListener("click",()=>{this.measuring=!1,this.measureDialog.classList.add("d-none"),document.getElementById("rg2-map-canvas").style.cursor="auto",w()}),document.getElementById("btn-measure").addEventListener("click",()=>{document.getElementById("rg2-map-canvas").style.cursor="crosshair",this.measureDialog.classList.remove("d-none"),this.measuring=!0,this.createMeasureDialog(),w()});let s={x:0,y:0};st(this.measureDialog).draggable({inertia:!0,listeners:{move(n){s.x+=n.dx,s.y+=n.dy,n.target.style.transform=`translate(${s.x}px, ${s.y}px)`}},modifiers:[st.modifiers.restrictRect({restriction:"#rg2-container"})]}),this.createMeasureDialog()}calculateLength(e,s){if(e.length<2)return 0;let n=0;for(let i=1;i<e.length;i+=1)n=n+X(e[i-1],s[i-1],e[i],s[i]);return n}closeEnough(e,s,n,i){return Math.abs(e-n)<10&&Math.abs(s-i)<10}createMeasureDialog(){this.metresPerPixel=yt(),this.metresPerPixel===void 0?(this.metresPerPixel=1,this.units="px"):this.units="m";let e="";for(let l=0;l<this.overlays.length;l+=1)e=e+this.formatOverlay(this.overlays[l],!0);e=e+this.formatOverlay(this.currentOverlay,!1),this.overlays.length>1&&(e+=`<div>${f("All")}</div><div></div><div></div>`,e+="<div><i class='delete-all-overlays bi-trash'></i></div>"),document.querySelector(".rg2-overlay-table").innerHTML=e;let s=document.getElementsByClassName("delete-overlay");for(let l of s)l.addEventListener("click",r=>{this.deleteOverlay(parseInt(r.target.id,10))});let n=document.getElementsByClassName("delete-all-overlays");for(let l of n)l.addEventListener("click",r=>{this.deleteAllOverlays(parseInt(r.target.id,10))});let i=document.getElementsByClassName("end-overlay");for(let l of i)l.addEventListener("click",r=>{this.endOverlay(parseInt(r.target.id,10))})}deleteAllOverlays(){this.overlays.length=0,this.currentOverlay=this.initialiseOverlay(),this.updateOverlays(),this.createMeasureDialog(),w()}deleteOverlay(e){this.overlays.splice(e,1),this.updateOverlays(),this.createMeasureDialog(),w()}dragEnded(){this.dragging=!1}drawSingleOverlay(e,s){this.ctx.strokeStyle=e.colour,this.ctx.fillStyle=e.colour,this.ctx.beginPath(),this.ctx.moveTo(e.x[0],e.y[0]);for(let n=1;n<e.x.length;n+=1)this.ctx.lineTo(e.x[n],e.y[n]);this.ctx.stroke();for(let n=0;n<e.x.length;n+=1)this.ctx.beginPath(),this.ctx.arc(e.x[n],e.y[n],this.dotSize,0,2*Math.PI,!1),s?this.ctx.fill():this.ctx.stroke()}drawOverlays(){if(this.measuring){if(this.ctx.lineWidth=this.lineWidth,this.ctx.globalAlpha=.6,this.overlays.length>0)for(let e=0;e<this.overlays.length;e+=1)this.drawSingleOverlay(this.overlays[e],!0);this.currentOverlay.started&&(this.currentOverlay.x.length===1?(this.ctx.strokeStyle=this.currentOverlay.colour,this.ctx.fillStyle=this.currentOverlay.colour,this.ctx.beginPath(),this.ctx.arc(this.currentOverlay.x[0],this.currentOverlay.y[0],this.dotSize,0,2*Math.PI,!1),this.ctx.stroke()):this.drawSingleOverlay(this.currentOverlay,!1))}}endOverlay(){this.currentOverlay.idx=this.overlays.length,this.overlays.push(this.currentOverlay),this.currentOverlay=this.initialiseOverlay(),this.createMeasureDialog()}formatOverlay(e,s){let n="",i="",l="";return e.started?l=`<div>${parseInt(e.length,10)}${this.units}</div>`:l="<div></div>",s?i=`<div><i class='delete-overlay bi-trash' id="${e.idx}"></i></div>`:e.started?i=`<div><i class='end-overlay bi-save' id="${e.idx}"></i></div>`:i="<div></div>",n+=`<div>${e.id}</div><div class='overlay-bar' style='--overlay-colour:${e.colour};'></div>`,n+=`${l}${i}`,n}getNextColour(){return this.colourIndex=(this.colourIndex+1)%this.colours.length,this.colours[this.colourIndex]}initialiseOverlay(){const e={};return e.id=String.fromCharCode(this.overlays.length+65),e.colour=this.getNextColour(),e.x=[],e.y=[],e.length=0,e.started=!1,e.idx=void 0,e}mouseDrag(e,s){if(!this.measuring)return!1;if(!this.dragging)for(let n=0;n<this.overlays.length;n+=1)for(let i=0;i<this.overlays[n].x.length;i+=1)this.closeEnough(e.x,e.y,this.overlays[n].x[i],this.overlays[n].y[i])&&(this.dragging=!0,this.dragOverlay=n,this.dragPoint=i);return this.dragging?(this.overlays[this.dragOverlay].x[this.dragPoint]=parseInt(s.x,10),this.overlays[this.dragOverlay].y[this.dragPoint]=parseInt(s.y,10),this.overlays[this.dragOverlay].length=this.calculateLength(this.overlays[this.dragOverlay].x,this.overlays[this.dragOverlay].y)*this.metresPerPixel,this.createMeasureDialog(),!0):!1}mouseUp(e,s){this.measuring&&(this.dragging=!1,this.currentOverlay.started||this.startOverlay(),e===this.currentOverlay.x[this.currentOverlay.x.length-1]&&s===this.currentOverlay.y[this.currentOverlay.x.length-1]?this.endOverlay():(this.currentOverlay.x.push(e),this.currentOverlay.y.push(s),this.currentOverlay.length=this.calculateLength(this.currentOverlay.x,this.currentOverlay.y)*this.metresPerPixel,this.createMeasureDialog(),w()))}startOverlay(){this.currentOverlay.started=!0,this.createMeasureDialog()}updateOverlays(){this.colourIndex=0;for(let e=0;e<this.overlays.length;e+=1)this.overlays[e].id=String.fromCharCode(e+65),this.overlays[e].idx=e,this.overlays[e].colour=this.getNextColour();this.currentOverlay.id=String.fromCharCode(this.overlays.length+65),this.currentOverlay.idx=this.overlays.length,this.currentOverlay.colour=this.getNextColour()}}let $=document.getElementById("rg2-map-canvas"),a=$.getContext("2d");a.displayAngle=0;a.displayScale=1;let V=new Image,ut=new Oa(a),S={dragStart:null,dragged:!0,scaleFactor:1.1,pinched:!1},At;document.getElementById("rg2-load-progress").classList.add("d-none");document.getElementById("rg2-map-load-progress").classList.add("d-none");function Na(){$.addEventListener("touchstart",Xa,!1),$.addEventListener("touchmove",Ya,!1),$.addEventListener("touchend",Ua,!1),$.addEventListener("DOMMouseScroll",$s,!1),$.addEventListener("wheel",$s,!1),$.addEventListener("mousedown",Fa,!1),$.addEventListener("mousemove",Ha,!1),$.addEventListener("mouseup",Ga,!1),V.addEventListener("load",()=>Va());let t=document.getElementById("btn-zoom-in");t.addEventListener("click",()=>Ue(1)),t=document.getElementById("btn-zoom-out"),t.addEventListener("click",()=>Ue(-1)),t=document.getElementById("btn-rotate-left"),t.addEventListener("click",()=>Fs(-1)),t=document.getElementById("btn-rotate-right"),t.addEventListener("click",()=>Fs(1)),t=document.getElementById("btn-reset"),t.addEventListener("click",()=>We())}function Et(t,e,s,n=!0,i=1){Wn((a.displayAngle-t)%(Math.PI*2),e,s,n,i)}function Wn(t,e,s,n,i){if(a.displayAngle=(a.displayAngle-t)%(Math.PI*2),a.translate(e,s),a.rotate(t),i!==1&&(a.scale(i,i),a.displayScale=a.displayScale*i),n){const l=is();a.translate(l.x-e,l.y-s)}else a.translate(-1*e,-1*s);w()}function $a(){if(!h.managing()&&window.innerWidth>=h.BIG_SCREEN_BREAK_POINT){a.font="16pt Arial",a.textAlign="center",a.fillStyle=h.BLACK;const t=a.transformedPoint($.width/2,$.height/2);a.fillText("Routegadget 2 Version "+h.RG2VERSION,t.x,t.y)}}function is(){const t=document.getElementById("rg2-animation-controls").offsetHeight;return a.transformedPoint($.width/2,($.height-t)*.85)}function qn(){const t=document.getElementById("rg2-animation-controls").offsetHeight;return a.transformedPoint($.width/2,($.height-t)*.15)}function Ge(){return{height:V.height,width:V.width}}function Vn(t){S.dragStart=a.transformedPoint(S.lastX,S.lastY),S.dragged=!1,S.whichButton=t.which}function jn(){if(S.dragStart){const t=a.transformedPoint(S.lastX,S.lastY);t.x=Math.round(t.x),t.y=Math.round(t.y);const e={x:Math.round(S.dragStart.x),y:Math.round(S.dragStart.y)},s=S.whichButton;Math.abs(t.x-e.x)+Math.abs(t.y-e.y)>5&&(cr()?mn(e,t,s):ke()===h.TAB_CREATE?rg2Config.manager.adjustManagerControls(e,t,s):ut.mouseDrag(e,t)||a.translate(t.x-S.dragStart.x,t.y-S.dragStart.y),S.dragged=!0,w())}}function zn(t){const e=ke();if(S.dragged)e===h.TAB_CREATE?rg2Config.manager.managerDragEnded():e===h.TAB_DRAW?ir():ut.dragEnded();else if(e===h.TAB_CREATE){const s=Math.round(S.dragStart.x),n=Math.round(S.dragStart.y);rg2Config.manager.managerMouseUp(s,n)}else e===h.TAB_DRAW?gr(Math.round(S.dragStart.x),Math.round(S.dragStart.y),t.which):ut.mouseUp(Math.round(S.dragStart.x),Math.round(S.dragStart.y));S.dragStart=null,w()}function Fa(t){return Zn(t),Vn(t),t.stopPropagation(),t.preventDefault()}function Ha(t){return Zn(t),jn(),t.stopPropagation(),t.preventDefault()}function Ga(t){return zn(t),t.stopPropagation(),t.preventDefault()}function $s(t){const e=t.wheelDelta?t.wheelDelta/40:t.detail?-t.detail:0;return e&&Ue(e),t.stopPropagation(),t.preventDefault()}function Ua(t){zn(t),S.pinched=!1}function Ya(t){if(t.touches.length>1?S.pinched||Jn(t):S.pinched=!1,S.pinched&&t.touches.length>1){S.pinchEnd0=a.transformedPoint(t.touches[0].pageX,t.touches[0].pageY),S.pinchEnd1=a.transformedPoint(t.touches[1].pageX,t.touches[1].pageY);const e=X(S.pinchStart0.x,S.pinchStart0.y,S.pinchStart1.x,S.pinchStart1.y),s=X(S.pinchEnd0.x,S.pinchEnd0.y,S.pinchEnd1.x,S.pinchEnd1.y);e/s>1.1?(Ue(-1),S.pinchStart0=S.pinchEnd0,S.pinchStart1=S.pinchEnd1):e/s<.9&&(Ue(1),S.pinchStart0=S.pinchEnd0,S.pinchStart1=S.pinchEnd1)}else S.lastX=t.touches[0].pageX,S.lastY=t.touches[0].pageY,jn()}function Xa(t){t.preventDefault(),t.touches.length>1&&Jn(t),S.lastX=t.touches[0].pageX,S.lastY=t.touches[0].pageY,Vn(t)}function Wa(){Na(),za(a),Kn()}function qa(t,e=!1){document.getElementById("rg2-map-load-progress-label").textContent=f("Loading map",""),document.getElementById("rg2-map-load-progress").classList.remove("d-none"),V.onerror=()=>{document.getElementById("rg2-map-load-progress").classList.add("d-none"),Y("Map load error","The map for this event could not be loaded.")},V.src=e?t:t+"?"+Date.now()}function Va(){document.getElementById("rg2-map-load-progress").classList.add("d-none"),We(),h.managing()&&rg2Config.manager.managerMapLoadCallback()}function w(){At===void 0&&(At=setTimeout(()=>{At=void 0,ja()},50))}function ja(){if(a.save(),a.setTransform(1,0,0,1,0,0),a.globalAlpha=h.FULL_INTENSITY,a.fillStyle=h.GREY,a.fillRect(0,0,a.canvas.width,a.canvas.height),a.restore(),V.height>0){a.fillStyle=h.WHITE,a.globalAlpha=h.FULL_INTENSITY,a.fillRect(0,0,V.width,V.height),a.globalAlpha=L.perCentMapIntensity/100,a.drawImage(V,0,0);const t=ke();t===h.TAB_DRAW?(Ms(h.DIM),W.drawControls(!1),ms(),rr()):t===h.TAB_CREATE?rg2Config.manager.drawManagerControls():(Ms(h.DIM),ms(),ut.drawOverlays(),W.drawControls(!1),xa())}else $a()}function We(){let t=1;const e=$.height/V.height;S.lastX=$.width/2,S.lastY=$.height/2,S.zoomSize=1,S.dragStart=null,S.dragged=!0,e<1&&(t=e),window.innerWidth>=h.BIG_SCREEN_BREAK_POINT?a.setTransform(t,0,0,t,document.getElementById("rg2-left-info-panel").offsetWidth+80,0):a.setTransform(t,0,0,t,0,0),a.displayAngle=0,a.displayScale=t,w()}function Kn(){S.scaleFactor=h.DEFAULT_SCALE_FACTOR;const t=document.getElementById("rg2-header-container").offsetHeight;document.getElementById("rg2-container").style.height=window.innerHeight-t+"px",$.width=window.innerWidth,$.height=window.innerHeight-t,We()}function Fs(t){const e=t*(Math.PI/36);a.translate(V.width/2,V.height/2),Wn(e,0,0,!1,1),a.translate(-V.width/2,-V.height/2)}function Zn(t){S.lastX=t.pageX-$.offsetParent.offsetLeft,S.lastY=t.pageY-$.offsetParent.offsetTop}function Jn(t){S.pinchStart0=a.transformedPoint(t.touches[0].pageX,t.touches[0].pageY),S.pinchStart1=a.transformedPoint(t.touches[1].pageX,t.touches[1].pageY),S.pinched=!0}function za(t){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");let s=e.createSVGMatrix(),n=[],i=t.save;t.save=function(){return n.push(s.translate(0,0)),i.call(t)};let l=t.restore;t.restore=function(){return s=n.pop(),l.call(t)};let r=t.scale;t.scale=function(y,v){return s=s.scale(y,v),r.call(t,y,v)};let o=t.translate;t.translate=function(y,v){return s=s.translate(y,v),o.call(t,y,v)};let g=t.setTransform;t.setTransform=function(y,v,k,E,T,x){return s.a=y,s.b=v,s.c=k,s.d=E,s.e=T,s.f=x,g.call(t,y,v,k,E,T,x)};let p=e.createSVGPoint();t.transformedPoint=function(y,v){return p.x=y,p.y=v,p.matrixTransform(s.inverse())};let m=t.rotate;t.rotate=function(y){return s=s.rotate(y*180/Math.PI),m.call(t,y)}}function Ue(t){if(!h.managing()&&kn()===null)return;const e=Math.pow(S.scaleFactor,t),s=S.zoomSize*e;if(s<h.MAX_ZOOM&&s>h.MIN_ZOOM){S.zoomSize=s;const n=a.transformedPoint(S.lastX,S.lastY);a.translate(n.x,n.y),a.scale(e,e),a.displayScale=a.displayScale*e,a.translate(-n.x,-n.y),w()}}window.assetUrl=function(t){return rg2Config.asset_url+t};document.readyState!=="loading"?Hs():document.addEventListener("DOMContentLoaded",Hs);function Hs(){const t=document.querySelector(".rg2-startup");t.style.opacity=0,t.addEventListener("transitionend",()=>{t.remove(),aa(),fi(),$l(),ai(),h.managing()?Ke(()=>import("./manager-1E3re5s3.js"),__vite__mapDeps([0,1,2,3]),import.meta.url).then(e=>{rg2Config.manager=e,rg2Config.manager.initialiseManager(rg2Config.keksi),Gs()}).catch(()=>{console.log("Error loading manager"),Y("Error loading manager","Manager functionality failed to  load.")}):Gs()})}function Gs(){Wa(),window.onpopstate=Ka,window.location.hash&&!h.managing()&&zs(window.location.hash),document.getElementById("rg2-event-title").innerHTML="Routegadget 2",En()}function Ka(){if(window.location.hash!==""&&!h.managing()){const t=zs(window.location.hash);wn(t)&&Br()!==t&&vt(t)}}class oo{constructor(){if(this.georefsystems=[],this.georefsystems.push({name:"Not georeferenced",description:"none",params:"",value:0}),this.georefsystems.push({name:"GB National Grid",description:"EPSG:27700",params:"+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs",value:1}),this.georefsystems.push({name:"Google EPSG:900913",description:"EPSG:900913",params:"+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs",value:2}),rg2Config.epsg_code!==void 0){const e=rg2Config.epsg_code.split("|"),s=rg2Config.epsg_params.split("|");for(let n=0;n<e.length;n=n+1)this.georefsystems.push({name:e[n].replace(" ",""),description:e[n].replace(" ",""),params:s[n],value:n+3});this.defaultGeorefVal=3}else this.defaultGeorefVal=1}getDefaultValue(){return this.georefsystems[this.defaultGeorefVal].value}getGeorefDropdown(){let e="";for(let s=0;s<this.georefsystems.length;s+=1)e+=ci(s,this.georefsystems[s].name,s===0);return e}getGeorefSystem(e){return this.georefsystems[e]}}class co{constructor(e){e!==void 0?(this.mapid=e.mapid,this.name=e.name,this.worldfile=new Ae(e),this.localworldfile=new Ae({A:e.localA,B:e.localB,C:e.localC,D:e.localD,E:e.localE,F:e.localF}),e.mapfilename===void 0?this.mapfilename=this.mapid+".jpg":this.mapfilename=e.mapfilename):(this.mapid=0,this.name="",this.worldfile=new Ae(0),this.localworldfile=new Ae(0)),this.xpx=[],this.ypx=[],this.lat=[],this.lon=[]}}class uo{constructor(e){this.x="",this.y=e,this.name=null,this.password=null}setDetails(e,s){const n=/...../;this.name=document.getElementById(e).value;const i=n.test(this.name);this.password=document.getElementById(s).value;const l=n.test(this.password);return i&&l}alterString(e,s){let n="";for(let i=0;i<e.length;i+=1)n+=e.charAt(i)+s.charAt(i);return n}encodeUser(){return{x:this.alterString(this.name+this.password,this.y),y:this.y}}}export{no as A,io as B,yi as C,oo as G,co as M,uo as U,Ae as W,rs as a,to as b,h as c,a as d,Qa as e,B as f,eo as g,Ut as h,Tn as i,at as j,ci as k,qa as l,ao as m,lo as n,Ge as o,vt as p,Yt as q,w as r,Y as s,Ys as t,ht as u,so as v,En as w,Ln as x,Ur as y,f as z};
//# sourceMappingURL=main-D9_pgpFN.js.map
